
&НаКлиенте
Процедура ВыполнитьОбработку(Команда)
	 ВыполнитьНажатиеСервер()	
КонецПроцедуры

&НаСервере
Процедура ВыполнитьНажатиеСервер()Экспорт
	// Вставить НажатиеСервер обработчика.
		//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ХранилищеДополнительнойИнформации.Ссылка,
		|	ХранилищеДополнительнойИнформации.ВерсияДанных,
		|	ХранилищеДополнительнойИнформации.ПометкаУдаления,
		|	ХранилищеДополнительнойИнформации.Предопределенный,
		|	ХранилищеДополнительнойИнформации.Наименование,
		|	ХранилищеДополнительнойИнформации.ВидДанных,
		|	ХранилищеДополнительнойИнформации.ИмяФайла,
		|	ХранилищеДополнительнойИнформации.Объект,
		|	ХранилищеДополнительнойИнформации.Хранилище,
		|	ХранилищеДополнительнойИнформации.ТекстФайла,
		|	ХранилищеДополнительнойИнформации.абс_ДатаПрикрепленияФайла,
		|	ХранилищеДополнительнойИнформации.абс_ИнициаторФайла,
		|	ХранилищеДополнительнойИнформации.абс_ИмяФайла,
		|	ХранилищеДополнительнойИнформации.Представление
		|ИЗ
		|	Справочник.ХранилищеДополнительнойИнформации КАК ХранилищеДополнительнойИнформации";

	Результат = Запрос.Выполнить();

	ВыборкаДетальныеЗаписи = Результат.Выбрать();
      счетчик=0;
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		путь=ВыборкаДетальныеЗаписи.Хранилище.получить();
		Расширение = Прав(СокрЛП(ВыборкаДетальныеЗаписи.Ссылка.абс_ИмяФайла), 4); 
		Если  Расширение = ".tif"  Тогда
			Спр = ВыборкаДетальныеЗаписи.Ссылка.получитьОбъект();
			ПрифексСтраницы = "p" ;
			ИндексСтраницы = 1;
			СтароеИмя = ВыборкаДетальныеЗаписи.Ссылка.абс_ИмяФайла;
			НовоеИмя =  Лев(ВыборкаДетальныеЗаписи.Ссылка.абс_ИмяФайла,(СтрДлина(ВыборкаДетальныеЗаписи.Ссылка.абс_ИмяФайла)-3))+ПрифексСтраницы + ИндексСтраницы + ".jpg";
			СтароеИмяБезПапки  = Спр.ИмяФайла;
			НовоеИмяБезПапки = Спр.ИмяФайла + "." + ПрифексСтраницы + ИндексСтраницы;
			Спр.абс_ИмяФайла= НовоеИмя;
			Спр.ИмяФайла	 =	НовоеИмяБезПапки;	
            Спр.Наименование =  НовоеИмяБезПапки;
			спрХран= ВыборкаДетальныеЗаписи.Хранилище.Получить();
			НовХранилище =  Лев(спрХран,(СтрДлина(спрХран)-3))+ПрифексСтраницы + ИндексСтраницы + ".jpg" ;
			Спр.Хранилище= Новый ХранилищеЗначения(НовХранилище);
			сообщить(Спр.абс_ИмяФайла);  	
			счетчик=счетчик+1;			
			Спр.записать();
			
			ПроверитьСуществованиеФайла = Истина;
			Пока ПроверитьСуществованиеФайла Цикл
				ИндексСтраницы = ИндексСтраницы + 1;
				НовоеИмя =  Лев(СтароеИмя,(СтрДлина(СтароеИмя)-3))+ПрифексСтраницы + ИндексСтраницы + ".jpg";
				НовоеИмяБезПапки =  СтароеИмяБезПапки +  "." +  ПрифексСтраницы + ИндексСтраницы;
			    НайденныеФайлы = НайтиФайлы(НовоеИмя,,);
				Если НайденныеФайлы.Количество()= 1 Тогда
					НовыйЭлемент =  Спр.Скопировать();
					//НовыйЭлемент = 	Справочники.ХранилищеДополнительнойИнформации.СоздатьЭлемент();	
					НовыйЭлемент.абс_ИмяФайла= НовоеИмя;
					НовыйЭлемент.ИмяФайла	 =	НовоеИмяБезПапки;	
          			НовыйЭлемент.Наименование =  НовоеИмяБезПапки;
					НовыйЭлемент.Хранилище= Новый ХранилищеЗначения(Лев(спрХран,(СтрДлина(спрХран)-3))+ПрифексСтраницы + ИндексСтраницы + ".jpg");
					НовыйЭлемент.Записать();
					сообщить(НовоеИмя);  	
					счетчик=счетчик+1;
					
				ИначеЕсли НайденныеФайлы.Количество()= 0 Тогда
					 ПроверитьСуществованиеФайла = Ложь;	
				КонецЕсли;
			   
			
			КонецЦикла;
			
			
		КонецЕсли;
						// Вставить обработку выборки ВыборкаДетальныеЗаписи
	КонецЦикла;
     
    сообщить(счетчик);  

	//}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
      КонецПроцедуры

