Функция ОбработатьСогласованиеДокументов() Экспорт
	
	//Получим этапы согласования текущего пользователя
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	МаршрутыСогласованияСогласующиеЛица.Ссылка КАК МаршрутСогласования
	               |ИЗ
	               |	Справочник.абс_МаршрутыСогласованияДокументов.СогласующиеЛица КАК МаршрутыСогласованияСогласующиеЛица
	               |ГДЕ
	               |	МаршрутыСогласованияСогласующиеЛица.Пользователь = &ТекПользователь";
				   
	Запрос.УстановитьПараметр("ТекПользователь", ТекущийПользователь);
	ЭтапыТекущегоПользователя = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("МаршрутСогласования");
	СоответствиеСледующиеЭтапы = Новый Соответствие();
	
	ЕстьОшибки = Ложь;
	
	УспешноОбработанныеДокументы = Новый Массив;
	
	Для Каждого СтрокаТабличнойЧасти ИЗ ДокументыДляСогласования Цикл
		Если НЕ СтрокаТабличнойЧасти.Пометка Тогда
			Продолжить;
		КонецЕсли;
		
		//Если НЕ ЗначениеЗаполнено(СтрокаТабличнойЧасти.Состояние)
		//	ИЛИ (СтрокаТабличнойЧасти.ПоследнийСогласующий = ТекущийПользователь
		//		И СтрокаТабличнойЧасти.ТекущееСостояние = СтрокаТабличнойЧасти.Состояние) Тогда
		//		
		//	УспешноОбработанныеДокументы.Добавить(СтрокаТабличнойЧасти);
		//	Продолжить;
		//КонецЕсли;

		Отказ = Ложь;
		
		
		//Если статус документа - отклонен, то обязательно должен быть заполнен комментарий
		Если СтрокаТабличнойЧасти.Состояние = Перечисления.СостоянияОбъектов.Отклонен
			И СокрЛП(СтрокаТабличнойЧасти.Комментарий)="" Тогда
				ТекстПоля = ОбщегоНазначенияКлиентСервер.ПолучитьТекстДляВыдачиСообщенийПоСтрокеТЧ("ДокументыДляСогласования", СтрокаТабличнойЧасти.НомерСтроки, "Комментарий");
				ТекстСообщения = НСтр("ru = 'Не указан комментарий для документа &Документ.
											|Состояние документа изменено не будет.'");
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "&Документ", СтрокаТабличнойЧасти.ДокументДляСогласования);
				
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , ТекстПоля, "Объект", Отказ);
				Продолжить;
		КонецЕсли;
			
				
		//Определим новый этап - это может быть следующий этап (непосредственный родитель) 
		//	или один из вышестоящих этапов
		НовыйЭтап = Неопределено;
		ОпределитьСледующийЭтапСогласования(НовыйЭтап, СтрокаТабличнойЧасти.Этап, ЭтапыТекущегоПользователя, СоответствиеСледующиеЭтапы,СтрокаТабличнойЧасти.ТекущееСостояние);
			
		//Если новый этап не удалось определить - сообщим об ошибке
		//	Такой ситуации возникать не должно.
		Если НовыйЭтап = Неопределено Тогда
			ТекстПоля = ОбщегоНазначенияКлиентСервер.ПолучитьТекстДляВыдачиСообщенийПоСтрокеТЧ("ДокументыДляСогласования", СтрокаТабличнойЧасти.НомерСтроки, "ДокументДляСогласования");
			ТекстСообщения = НСтр("ru = 'Не удалось определить следующий этап согласования документа &Документ.
										|Состояние документа изменено не будет.'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "&Документ", СтрокаТабличнойЧасти.ДокументДляСогласования);
				
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , ТекстПоля,"Объект", Отказ);
			Продолжить;
		КонецЕсли;
		
		Если НЕ НовыйЭтап = Справочники.абс_МаршрутыСогласованияДокументов.ПустаяСсылка()тогда
			НовыйУровень = НовыйЭтап.Уровень() + 1;
		КонецЕсли;	
			
		Если ТипЗнч(СтрокаТабличнойЧасти.ДокументДляСогласования) = Тип("ДокументСсылка.ЗаявкаНаРасходованиеСредств") Тогда
			
			//Обработаем состояние Отказано
			Если СтрокаТабличнойЧасти.Состояние = Перечисления.СостоянияОбъектов.Отклонен
				И СтрокаТабличнойЧасти.ДокументДляСогласования.Проведен Тогда
				
				Попытка
					ДокОбъект = СтрокаТабличнойЧасти.ДокументДляСогласования.ПолучитьОбъект();
					ДокОбъект.Заблокировать();
					ДокОбъект.Записать(РежимЗаписиДокумента.ОтменаПроведения);
				Исключение
					ТекстПоля = ОбщегоНазначенияКлиентСервер.ПолучитьТекстДляВыдачиСообщенийПоСтрокеТЧ("ДокументыДляСогласования", СтрокаТабличнойЧасти.НомерСтроки, "ДокументДляСогласования");
					ТекстСообщения = НСтр("ru = 'Не удалось отменить проведение документа &Документ.
												|Состояние документа изменено не будет.'");
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "&Документ", СтрокаТабличнойЧасти.ДокументДляСогласования);
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , ТекстПоля,"Объект", Отказ);
				КонецПопытки;
			КонецЕсли;
			
			// Обработаем изменение состояния с Отказано на другое
			Если СтрокаТабличнойЧасти.ТекущееСостояние = Перечисления.СостоянияОбъектов.Отклонен 
				И НЕ СтрокаТабличнойЧасти.ДокументДляСогласования.Проведен Тогда
				
				Попытка
					ДокОбъект = СтрокаТабличнойЧасти.ДокументДляСогласования.ПолучитьОбъект();
					ДокОбъект.Заблокировать();
					ДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
				Исключение
					ТекстПоля = ОбщегоНазначенияКлиентСервер.ПолучитьТекстДляВыдачиСообщенийПоСтрокеТЧ("ДокументыДляСогласования", СтрокаТабличнойЧасти.НомерСтроки, "ДокументДляСогласования");
					ТекстСообщения = НСтр("ru = 'Не удалось провести документ &Документ.
												|Состояние документа изменено не будет'");
												
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "&Документ", СтрокаТабличнойЧасти.ДокументДляСогласования);
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , ТекстПоля,"Объект", Отказ);
				КонецПопытки;
			КонецЕсли;
	   		ИначеЕсли ТипЗнч(СтрокаТабличнойЧасти.ДокументДляСогласования) = Тип("ДокументСсылка.Лео_ФиксацияСкидокПоТрейдМаркетингу") Тогда
	        //проставим новое состояние в документе
			
			     Если НовыйЭтап = Справочники.абс_МаршрутыСогласованияДокументов.ПустаяСсылка() И СтрокаТабличнойЧасти.Состояние = Перечисления.СостоянияОбъектов.Согласован Тогда
				
				       НовоеСостояние = Перечисления.СостоянияОбъектов.Утвержден;
					//{Лео Катанович 
				Попытка
					ДокОбъект = СтрокаТабличнойЧасти.ДокументДляСогласования.ПолучитьОбъект();
					ДокОбъект.Заблокировать();
					ДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
				Исключение
					Отказ = Истина;
					ТекстПоля = ОбщегоНазначенияКлиентСервер.ПолучитьТекстДляВыдачиСообщенийПоСтрокеТЧ("ДокументыДляСогласования", СтрокаТабличнойЧасти.НомерСтроки, "ДокументДляСогласования");
					ТекстСообщения = НСтр("ru = 'Не удалось провести документ &Документ.
												|Состояние документа изменено не будет'");
												
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "&Документ", СтрокаТабличнойЧасти.ДокументДляСогласования);
					ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , ТекстПоля,"Объект", Отказ);

				КонецПопытки;
				//Лео Катанович}

			     Иначе
				       НовоеСостояние = СтрокаТабличнойЧасти.Состояние;
			     КонецЕсли;

			
			
			
		Иначе
			//проставим новое состояние в документе
			Если СтрокаТабличнойЧасти.Состояние = Перечисления.СостоянияОбъектов.Согласован
				И НовыйУровень = 1 Тогда
				
				НовоеСостояние = Перечисления.СостоянияОбъектов.Утвержден;
			Иначе
				НовоеСостояние = СтрокаТабличнойЧасти.Состояние;
			КонецЕсли;
			
			Попытка
				ДокОбъект = СтрокаТабличнойЧасти.ДокументДляСогласования.ПолучитьОбъект();
				ДокОбъект.Заблокировать();
				ДокОбъект.Состояние=НовоеСостояние;
				Если НовоеСостояние=Перечисления.СостоянияОбъектов.Утвержден Тогда
					ДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
				Иначе
					ДокОбъект.Записать(РежимЗаписиДокумента.Запись);
				КонецЕсли;
			Исключение
				ТекстПоля = ОбщегоНазначенияКлиентСервер.ПолучитьТекстДляВыдачиСообщенийПоСтрокеТЧ("ДокументыДляСогласования", СтрокаТабличнойЧасти.НомерСтроки, "ДокументДляСогласования");
				ТекстСообщения = НСтр("ru = 'Не удалось провести документ &Документ.
				|Состояние документа изменено не будет'");
				
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "&Документ", СтрокаТабличнойЧасти.ДокументДляСогласования);
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , ТекстПоля,"Объект", Отказ);
			КонецПопытки;
	
		КонецЕсли;
		
		
	//
	//	//Изменим состояние документа в регистре
	//	НаборЗаписейСостояниеСогласования = РегистрыСведений.абс_СостоянияСогласованияДокументов.СоздатьНаборЗаписей();
	//	НаборЗаписейСостояниеСогласования.Отбор.ДокументДляСогласования.Установить(СтрокаТабличнойЧасти.ДокументДляСогласования);
	//	НаборЗаписейСостояниеСогласования.Прочитать();
	//	
	//	//Проверим последнюю запись - если она относится к тому же пользователю и этапу, удалим ее
	//	Если НаборЗаписейСостояниеСогласования.Количество() > 0 Тогда
	//		ПоследняяЗапись = НаборЗаписейСостояниеСогласования[НаборЗаписейСостояниеСогласования.Количество()-1];
	//		Если ПоследняяЗапись.Пользователь = ТекущийПользователь
	//			И ПоследняяЗапись.Этап = НовыйЭтап Тогда
	//			
	//			НаборЗаписейСостояниеСогласования.Удалить(ПоследняяЗапись);
	//		КонецЕсли;
	//	КонецЕсли;

	//	НоваяЗапись = НаборЗаписейСостояниеСогласования.Добавить();
	//	НоваяЗапись.Период = ТекущаяДата();
	//	НоваяЗапись.Активность = Истина;
	//	НоваяЗапись.ДокументДляСогласования= СтрокаТабличнойЧасти.ДокументДляСогласования;
	//	НоваяЗапись.Пользователь = ТекущийПользователь;
	//	НоваяЗапись.Состояние = НовоеСостояние;
	//	НоваяЗапись.Уровень= НовыйУровень;
	//	НоваяЗапись.Этап = НовыйЭтап;
	//	НоваяЗапись.Комментарий = СтрокаТабличнойЧасти.Комментарий;
	//	
	//	НаборЗаписейСостояниеСогласования.Записать();
	//	
	//	УспешноОбработанныеДокументы.Добавить(СтрокаТабличнойЧасти);
	//	
	//КонецЦикла;
	
	//// Удалим из списка документы по которым удалось изменить состояние
	//Для каждого ЭлКоллекции Из УспешноОбработанныеДокументы Цикл
	//	
	//	//Если ЭлКоллекции.ТекущееСостояние = Перечисления.СостоянияОбъектов.Утвержден Тогда
	//		 ДокОбъект = ЭлКоллекции.ДокументДляСогласования.ПолучитьОбъект();
	//		 ДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
	//	//КонецЕсли;
	//	ДокументыДляСогласования.Удалить(ЭлКоллекции);

	//КонецЦикла; 
	//
	//Возврат НЕ ЕстьОшибки;
	
	
	Если Отказ Тогда
			ЕстьОшибки = Истина;
			Продолжить;
		КонецЕсли;
	
		//Изменим состояние документа в регистре
		НаборЗаписейСостояниеСогласования = РегистрыСведений.абс_СостоянияСогласованияДокументов.СоздатьНаборЗаписей();
		НаборЗаписейСостояниеСогласования.Отбор.ДокументДляСогласования.Установить(СтрокаТабличнойЧасти.ДокументДляСогласования);
		НаборЗаписейСостояниеСогласования.Прочитать();
		
		//Проверим последнюю запись - если она относится к тому же пользователю и этапу, удалим ее
		Если НаборЗаписейСостояниеСогласования.Количество() > 0 Тогда
			ПоследняяЗапись = НаборЗаписейСостояниеСогласования[НаборЗаписейСостояниеСогласования.Количество()-1];
			Если ПоследняяЗапись.Пользователь = ТекущийПользователь
				И ПоследняяЗапись.Этап = НовыйЭтап Тогда
				
				НаборЗаписейСостояниеСогласования.Удалить(ПоследняяЗапись);
			КонецЕсли;
		КонецЕсли;

		НоваяЗапись = НаборЗаписейСостояниеСогласования.Добавить();
		НоваяЗапись.Период = ТекущаяДата();
		НоваяЗапись.Активность = Истина;
		НоваяЗапись.ДокументДляСогласования= СтрокаТабличнойЧасти.ДокументДляСогласования;
		НоваяЗапись.Пользователь = ТекущийПользователь;
		НоваяЗапись.Состояние = НовоеСостояние;
		НоваяЗапись.Уровень= НовыйУровень;
		НоваяЗапись.Этап = НовыйЭтап;
		НоваяЗапись.Комментарий = СтрокаТабличнойЧасти.Комментарий;
		НоваяЗапись.ТекущийЭтап = СтрокаТабличнойЧасти.Этап;
 		НаборЗаписейСостояниеСогласования.Записать();
		
		УспешноОбработанныеДокументы.Добавить(СтрокаТабличнойЧасти);
		
		// {Лео Катанович
		
					ОбработкаСогласования = Обработки.абс_СогласованиеДокументов.Создать();
					ОбработкаСогласования.СформироватьЗадачуСотруднику(НоваяЗапись.ДокументДляСогласования, НовыйЭтап,НовоеСостояние);
		// Лео Катанович}
		
	КонецЦикла;
	
	// Удалим из списка документы по которым удалось изменить состояние
	Для каждого ЭлКоллекции Из УспешноОбработанныеДокументы Цикл
		ДокументыДляСогласования.Удалить(ЭлКоллекции);
	КонецЦикла; 
	
	Возврат НЕ ЕстьОшибки;

КонецФункции

//Процедура определяет этап согласования, который соответствует маршруту согласования и текущему пользователю
Процедура ОпределитьСледующийЭтапСогласования(НовыйЭтап, ТекущийЭтап, ЭтапыТекущегоПользователя, СоответствиеСледующиеЭтапы,ТекущееСостояние)
	
	НовыйЭтап = ТекущийЭтап.Родитель;
	
	//НовыйЭтап = СоответствиеСледующиеЭтапы.Получить(ТекущийЭтап);
	//
	//Если НовыйЭтап = Неопределено Тогда
	//	Если ЭтапыТекущегоПользователя.Найти(ТекущийЭтап)<>Неопределено И НЕ ТекущееСостояние =  Перечисления.СостоянияОбъектов.Согласован Тогда
	//		НовыйЭтап = ТекущийЭтап;
	//		СоответствиеСледующиеЭтапы.Вставить(ТекущийЭтап, НовыйЭтап);
	//	ИначеЕсли ЗначениеЗаполнено(ТекущийЭтап.Родитель) Тогда
	//		ОпределитьСледующийЭтапСогласования(НовыйЭтап, ТекущийЭтап.Родитель, ЭтапыТекущегоПользователя, СоответствиеСледующиеЭтапы,Перечисления.СостоянияОбъектов.ПустаяСсылка())
	//	КонецЕсли;
	//КонецЕсли;
	
КонецПроцедуры

//Процедура СформироватьЗадачуСотруднику(ДокументСсылка, НовыйЭтап,НовоеСостояние) Экспорт
//	
//	   
//	   Если НовыйЭтап = Справочники.абс_МаршрутыСогласованияДокументов.ПустаяСсылка() Тогда
//		   Если НовоеСостояние =  Перечисления.СостоянияОбъектов.Утвержден Тогда
//			   Если ДокументСсылка.ВидКомпенсации = "Автоматическая скидка" Тогда // Только для автоматической скидки
//					НовыйЭтап = Справочники.абс_МаршрутыСогласованияДокументов.НайтиПоНаименованию("Установить компенсирующие скидки"); 
//					Для Каждого СтрокаИсполнителя из НовыйЭтап.СогласующиеЛица Цикл
//						 НоваяЗадача = Задачи.ЗадачаИсполнителя.СоздатьЗадачу();
//						 НоваяЗадача.Дата			= ТекущаяДата();
//						 НоваяЗадача.ВидЗадачи    = Справочники.ВидыЗадачПользователей.Исполнение;
//						 НоваяЗадача.ОбъектЗадачи	= ДокументСсылка;
//						 НоваяЗадача.Наименование	= "Отразить в учете скидки по документу:" + Строка(ТипЗнч(ДокументСсылка)) + " " + ДокументСсылка.Контрагент.Наименование;
//						 НоваяЗадача.Исполнитель  = СтрокаИсполнителя.Пользователь;
//						 НоваяЗадача.Уровень      = НовыйЭтап.Уровень();
//						 НоваяЗадача.Записать();
//					 КонецЦикла;	
//			   КонецЕсли;	 				     
//			ИначеЕсли НовоеСостояние =  Перечисления.СостоянияОбъектов.Отклонен Тогда
//				НоваяЗадача = Задачи.ЗадачаИсполнителя.СоздатьЗадачу();
//				НоваяЗадача.Дата			= ТекущаяДата();
//				НоваяЗадача.ВидЗадачи	    = Справочники.ВидыЗадачПользователей.Согласование;
//				НоваяЗадача.ОбъектЗадачи	= ДокументСсылка;
//				НоваяЗадача.Наименование	= "Ознакомиться с результатом согласования документа: " + Строка(ТипЗнч(ДокументСсылка)) + " " + ДокументСсылка.Контрагент.Наименование + " (" + НовыйЭтап.Наименование + ")";
//				НоваяЗадача.Исполнитель	    = ДокументСсылка.Ответственный;
//				//НоваяЗадача.Уровень         = НовыйЭтап.Уровень();
//				НоваяЗадача.Записать();
//		   КонецЕсли;    				  
//		   Возврат;	 
//	   КонецЕсли;	 
//	   
//	   
//		Для Каждого СтрокаИсполнителя из НовыйЭтап.СогласующиеЛица Цикл
//				НоваяЗадача = Задачи.ЗадачаИсполнителя.СоздатьЗадачу();
//				НоваяЗадача.Дата			= ТекущаяДата();
//				НоваяЗадача.ВидЗадачи	    = Справочники.ВидыЗадачПользователей.Согласование;
//				НоваяЗадача.ОбъектЗадачи	= ДокументСсылка;
//				НоваяЗадача.Наименование	= "Согласовать документ " + Строка(ТипЗнч(ДокументСсылка)) + " " + ДокументСсылка.Контрагент.Наименование + " (" + НовыйЭтап.Наименование + ")";
//				НоваяЗадача.Исполнитель	    = СтрокаИсполнителя.Пользователь;
//				НоваяЗадача.Уровень         = НовыйЭтап.Уровень();
//				НоваяЗадача.Записать();
//				
//	   КонецЦикла;	

//КонецПроцедуры
////Лео Катанович}
