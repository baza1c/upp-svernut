///////////////////////////////////////////////////////////////////////////////
//
//ПРОЦЕДУРЫ ДЛЯ СЧИТЫВАЕНИЯ XML ФАЙЛА ПРИ EDI ОБМЕНЕ, КОТОРЫЕ СОДЕРЖАТ ДАННЫЕ О ЗАКАЗАХ КЛИЕНТОВ
//

// Процедура ПрочитатьXMLФайлEDI
// Читает входящие сообщения EDI и папки, указанной в настройках по умолчанию
// После чтения файлы перемещаются в архивную папку
//
// Параметры:
//  Нет.
//
// Возвращаемое значение:
//  Нет.
Процедура ПрочитатьXMLФайлEDI(НастройкаEDI, Отказ = Ложь) Экспорт
	
	Если НастройкаEDI.ТипНастройки = Перечисления.абс_ТипыОбменаEDI.ОбменЧерезФайловыйРесурс Тогда
		ПрочитатьXMLФайлEDIФайловыйВаринт(НастройкаEDI, Отказ);
	ИначеЕсли НастройкаEDI.ТипНастройки = Перечисления.абс_ТипыОбменаEDI.ОбменЧерезFTPРесурс Тогда
		ПрочитатьXMLФайлEDIFTPВаринт(НастройкаEDI, Отказ);	
	КонецЕСли;	
	
КонецПроцедуры

Процедура ПрочитатьXMLФайлEDIFTPВаринт(НастройкаEDI, Отказ = Ложь) Экспорт
	ИмяFTPСервера = "";
	ИмяКаталогаСервера = "";
	ДанныеПротокола = "";
	ПолучитьИмяСервераИИмяКаталогаОбмена(НастройкаEDI.FTPАдресОбмена, ИмяFTPСервера, ИмяКаталогаСервера);
	Соединение = ВыполнитьFTPПодключениеКСерверу(ИмяFTPСервера, НастройкаEDI, ДанныеПротокола, Истина, Неопределено);
	Если Соединение = Неопределено Тогда
		СообщитьОбОшибкеОбмена("Ошибка при подключении к серверу: " + ИмяFTPСервера);
		Возврат;
	КонецЕсли;
	НаличиеКаталога = ПроверитьНаличиеКаталогаНаFTPСервере(Соединение, НастройкаEDI.Входящие, ДанныеПротокола, Истина, Неопределено);
	Если Не НаличиеКаталога Тогда
		СообщитьОбОшибкеОбмена("На сервере " + ИмяFTPСервера + " отсутствует каталог: " + НастройкаEDI.Входящие);
		Возврат;
	КонецЕсли;	
	// {Лео Катанович
	//МассивФайлов = Соединение.НайтиФайлы("/" + НастройкаEDI.Входящие + "/", "*.xml");
	МассивФайлов = Соединение.НайтиФайлы("/" + НастройкаEDI.Входящие + "/", "*.*");
	// Лео Катанович}
	Если МассивФайлов.Количество() > 0 Тогда   		
		Для Каждого ФайлЗаказа Из МассивФайлов Цикл 
			Если НастройкаEDI.ТипНастройки = Перечисления.абс_ТипыОбменаEDI.ОбменЧерезFTPРесурс Тогда 		
				Соединение.Получить(ФайлЗаказа.ПолноеИмя, "" + КаталогВременныхФайлов() + ФайлЗаказа.Имя);
				абс_Файл = "" + КаталогВременныхФайлов() + ФайлЗаказа.Имя;
				ФайлЗаказа = Новый Файл(абс_Файл);
			КонецЕсли;      			
			Попытка
					// {Лео Катанович
				Если ФайлЗаказа.Расширение = ".dbf" Тогда
					ПрочитатьORDERSЗаказ_dbf(ФайлЗаказа, НастройкаEDI);		
				Иначе
					// Лео Катанович}
					ПрочитатьORDERSЗаказ(ФайлЗаказа, НастройкаEDI);		
				КонецЕсли;	
			Исключение
				//АБС 27.05.2014 44000
				Отказ = Истина;
				//АБС 27.05.2014 44000
				СообщитьОбОшибкеОбмена("Ошибка чтения файла """ + ФайлЗаказа.ПолноеИмя + """ !");		
				Продолжить;
			КонецПопытки;
			Если НастройкаEDI.ПереноситьВАрхивПослеЗагрузки Тогда
				КопироватьФайл(ФайлЗаказа.ПолноеИмя, НастройкаEDI.Архив + "\" + ФайлЗаказа.Имя);
				//Соединение.Переместить("/" + НастройкаEDI.Входящие + "/" + ФайлЗаказа.Имя, "archive/" + ФайлЗаказа.Имя);
				Соединение.Удалить("/" + НастройкаEDI.Входящие + "/" + ФайлЗаказа.Имя,);
			КонецЕсли;
		КонецЦикла;  	
	КонецЕсли; 	
КонецПроцедуры

//{Лео Катанович
  
Функция ПрочитатьORDERSЗаказ_dbf(ФайлЗаказа, НастройкаEDI, Отказ = Ложь) 
	Если  НастройкаEDI.Наименование = "EApteka" Тогда
	Иначе Отказ = Истина;
		Возврат Неопределено;
	КонецЕсли;
	
	ТаблицаЗаказа = Новый ТаблицаЗначений();
	ТаблицаЗаказа.Колонки.Добавить("НомерЗаказа",      Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(32)));
	ТаблицаЗаказа.Колонки.Добавить("ДатаЗаказа",       Новый ОписаниеТипов("Дата"));
	ТаблицаЗаказа.Колонки.Добавить("Контрагент",       Новый ОписаниеТипов("СправочникСсылка.Контрагенты"));
	ТаблицаЗаказа.Колонки.Добавить("Грузополучатель",  Новый ОписаниеТипов("СправочникСсылка.Контрагенты"));
	ТаблицаЗаказа.Колонки.Добавить("Номенклатура",     Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТаблицаЗаказа.Колонки.Добавить("Цена",             Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(10,2)));
	ТаблицаЗаказа.Колонки.Добавить("Количество",       Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(10,2)));
	ТаблицаЗаказа.Колонки.Добавить("ДатаФормирования", Новый ОписаниеТипов("Дата"));


    Таблица = Новый XBase;
    Таблица.ОткрытьФайл(ФайлЗаказа, , Истина);
 
    Таблица.Первая(); // перешли к первой записи
    Пока Не Таблица.ВКонце() Цикл
		Если Не Таблица.ЗаписьУдалена() Тогда
			ТаблицаЗаказа.Добавить();
			ТаблицаЗаказа.НомерЗаказа = Таблица.NUMZ;
			ТаблицаЗаказа.ДатаЗаказа = Таблица.DATEZ;
			ТаблицаЗаказа.Контрагент = Справочники.Контрагенты.НайтиПоКоду("УТ0006921");
			ТаблицаЗаказа.Грузополучатель = Справочники.Контрагенты.НайтиПоКоду(Таблица.PODRCD);
			ТаблицаЗаказа.Номенклатура = Справочники.Номенклатура.НайтиПоРеквизиту("Артикул", СокрЛП(Таблица.CODEPST));
			ТаблицаЗаказа.Цена = Таблица.PRICE;
			ТаблицаЗаказа.Количество = Таблица.QNT;
			ТаблицаЗаказа.ДатаФормирования = Таблица.DATE;
			Если ЗначениеЗаполнено(ТаблицаЗаказа.Контрагент) = Ложь Тогда
				Сообщить("Контрагент не найден");
				Возврат Неопределено;
			КонецЕсли;	 
			Если ЗначениеЗаполнено(ТаблицаЗаказа.Грузополучатель) = ЛОЖЬ Тогда
				Сообщить("Грузополучатель не найден");
				Возврат Неопределено;
			КонецЕсли;
 	   КонецЕсли;
        Таблица.Следующая(); // переходим к следующей записи
    КонецЦикла;    
 
    Таблица.ЗакрытьФайл();
	Если ТаблицаЗаказа.Количество()=0 Тогда
		 Возврат Неопределено;
	Иначе	 
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Дата", ТаблицаЗаказа[0].ДатаФормирования);
	Запрос.УстановитьПараметр("НомерЗаказаEDI", ТаблицаЗаказа[0].НомерЗаказа);
	Запрос.УстановитьПараметр("Контрагент", ТаблицаЗаказа[0].Контрагент);

	Запрос.Текст = "ВЫБРАТЬ
	               |	ЗаказПокупателя.Ссылка
	               |ИЗ
	               |	Документ.ЗаказПокупателя КАК ЗаказПокупателя
	               |ГДЕ
	               |	ЗаказПокупателя.Дата = &Дата
	               |	И ЗаказПокупателя.Номер = &Номер
	               |	И ЗаказПокупателя.Контрагент = &Контрагент";
    Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		 ЗаказПокупателя = Выборка.Ссылка.ПолучитьОбъект();
	Иначе
		ЗаказПокупателя = Документы.ЗаказПокупателя.СоздатьДокумент();
		ЗаказПокупателя.абс_Статус = Перечисления.абс_СтатусыОтгрузки.Создан;
		//заполним номер заказа покупателя по сообщению EDI
	    ЗаказПокупателя.НомерПоДаннымПокупателя = ТаблицаЗаказа[0].НомерЗаказа;
	    ЗаказПокупателя.абс_НомерЗаказаEDI = ТаблицаЗаказа[0].НомерЗаказа;
		ЗаказПокупателя.ДатаПоДаннымПокупателя =  ТаблицаЗаказа[0].ДатаЗаказа;
	КонецЕсли;

	    Если НЕ ЗаказПокупателя.абс_Статус = Перечисления.абс_СтатусыОтгрузки.Создан Тогда
		    ОбщегоНазначения.СообщитьОбОшибке("Сформированный заказ " + ЗаказПокупателя.Ссылка + " уже находится в статусе " + ЗаказПокупателя.абс_Статус);
		    Возврат Неопределено;
	    КонецЕсли;
	//// -- Заполнение Заказ покупателя
	ЗаполнениеДокументов.ЗаполнитьШапкуДокумента(ЗаказПокупателя, "Продажа");
    //ЗаказПокупателя.ДокументОснование   = СообщениеEDI;
	ЗаказПокупателя.Контрагент          = ТаблицаЗаказа[0].Контрагент;
	ЗаказПокупателя.Грузополучатель     = ТаблицаЗаказа[0].Грузополучатель;
	ЗаказПокупателя.ВидОперации         = Перечисления.ВидыОперацийЗаказПокупателя.ПродажаКомиссия;
	ЗаказПокупателя.УчитыватьНДС        = Истина;
	ЗаказПокупателя.Дата                = ТекущаяДата();
	ЗаказПокупателя.абс_ДатаПоставкиВТЦ = ТаблицаЗаказа[0].ДатаФормирования;
	ЗаказПокупателя.ДатаОплаты          = ЗаказПокупателя.Дата;
	
		абс_СпособДоставкиКонтрагента = ЗаказПокупателя.Грузополучатель.абс_ОсновнойСпособДоставки;
	
	Если Не ЗначениеЗаполнено(абс_СпособДоставкиКонтрагента) Тогда
		абс_СпособДоставкиКонтрагента = ЗаказПокупателя.Контрагент.абс_ОсновнойСпособДоставки;
	КонецЕсли;
	
	ЗаказПокупателя.абс_СпособДоставкиКонтрагента = абс_СпособДоставкиКонтрагента;
	
	ЗаказПокупателя.АдресДоставки = абс_СпособДоставкиКонтрагента.АдресДоставки;
	
	
	Если Не ЗначениеЗаполнено(ЗаказПокупателя.Контрагент) Тогда
		ЗаказПокупателя.Контрагент = ЗаказПокупателя.Грузополучатель.ГоловнойКонтрагент;
	КонецЕсли;	
	Если ЗначениеЗаполнено(ЗаказПокупателя.Контрагент) Тогда
		
		ЗаказПокупателя.ДоговорКонтрагента 	= ЗаказПокупателя.Контрагент.ОсновнойДоговорКонтрагента;
	    абс_Дистрибуция.УстановитьДатуОплаты(ЗаказПокупателя,"ДоговорКонтрагента",ЗаказПокупателя.ДоговорКонтрагента);

		ЗаказПокупателя.Организация			= ЗаказПокупателя.ДоговорКонтрагента.Организация;
		ЗаказПокупателя.СтруктурнаяЕдиница	= ЗаказПокупателя.Организация.ОсновнойБанковскийСчет;
		ЗаказПокупателя.СкладГруппа			= ЗаказПокупателя.Организация.абс_ОсновнойСклад;
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
					"ВЫБРАТЬ ПЕРВЫЕ 1
					|	Лео_СоответствиеСкладОрганизацияГрузотправительСрезПоследних.Контрагент
					|ИЗ
					|	РегистрСведений.Лео_СоответствиеСкладОрганизацияГрузотправитель.СрезПоследних(
					|			&ДатаДокумента,
					|			Организация = &Организация
					|				И Склад = &Склад) КАК Лео_СоответствиеСкладОрганизацияГрузотправительСрезПоследних";

		Запрос.УстановитьПараметр("ДатаДокумента", ТекущаяДата());
		Запрос.УстановитьПараметр("Организация", ЗаказПокупателя.ДоговорКонтрагента.Организация);
		Запрос.УстановитьПараметр("Склад",ЗаказПокупателя.Организация.абс_ОсновнойСклад);

		Результат = Запрос.Выполнить();

		ВыборкаДетальныеЗаписи = Результат.Выбрать();
        Если ВыборкаДетальныеЗаписи.Количество()> 0  тогда
			ВыборкаДетальныеЗаписи.Следующий();
			ЗаказПокупателя.Грузоотправитель = ВыборкаДетальныеЗаписи.Контрагент;
		Иначе
			ЗаказПокупателя.Грузоотправитель	= ЗаказПокупателя.СкладГруппа.абс_Контрагент;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ЗаказПокупателя.ДоговорКонтрагента.абс_БанковскийСчетОплатыКонтрагента) Тогда
			ЗаказПокупателя.СтруктурнаяЕдиница = ЗаказПокупателя.ДоговорКонтрагента.абс_БанковскийСчетОплатыКонтрагента;
		Иначе
			ЗаказПокупателя.СтруктурнаяЕдиница = ЗаказПокупателя.Организация.ОсновнойБанковскийСчет;
		КонецЕсли;	
		
	КонецЕсли;	
	
	ЗаказПокупателя.ТипЦен  = ПолучитьТипЦенПоДоговоруСКонтрагентом(ЗаказПокупателя.ДоговорКонтрагента, ЗаказПокупателя.Дата);
	Если ЗаказПокупателя.ТипЦен.ЦенаВключаетНДС Тогда
		ЗаказПокупателя.СуммаВключаетНДС = Истина;
	Иначе
		ЗаказПокупателя.СуммаВключаетНДС = Ложь;
	КонецЕсли;
	
	ЗаказПокупателя.ВалютаДокумента  = ЗаказПокупателя.ДоговорКонтрагента.ВалютаВзаиморасчетов;
	
	ЗагружатьДатуПоставкиEDI = абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ЗаказПокупателя.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.абс_ЗагружатьДатуПоставкиEDI);
	
	абс_Дистрибуция.УстановитьДатуОтгрузкиПоДиспоСхеме(ЗаказПокупателя);
	
	Если Не ЗначениеЗаполнено(ЗаказПокупателя.ДатаОтгрузки) Тогда
		ЗаказПокупателя.ДатаОтгрузки = ТаблицаЗаказа[0].ДатаЗаказа;
	КонецЕсли;
	
	
	СтруктураКурсовВалют = РегистрыСведений.КурсыВалют.ПолучитьПоследнее(ЗаказПокупателя.Дата,Новый Структура("Валюта",ЗаказПокупателя.ВалютаДокумента));
	
	// Курс и кратность
	ЗаказПокупателя.КурсВзаиморасчетов      = СтруктураКурсовВалют.Курс;
	ЗаказПокупателя.КратностьВзаиморасчетов = СтруктураКурсовВалют.Кратность;
	
	// Номер и дата заказа EDI
	ЗаказПокупателя.НомерПоДаннымПокупателя = ТаблицаЗаказа[0].НомерЗаказа;
	ЗаказПокупателя.ДатаПоДаннымПокупателя 	= ТаблицаЗаказа[0].ДатаЗаказа;
	
	
	// Структурная единица
	Если ЗначениеЗаполнено(ЗаказПокупателя.ДоговорКонтрагента.абс_БанковскийСчетОплатыКонтрагента) 
		И ЗаказПокупателя.ДоговорКонтрагента.абс_БанковскийСчетОплатыКонтрагента.ВалютаДенежныхСредств = ЗаказПокупателя.ДоговорКонтрагента.ВалютаВзаиморасчетов Тогда
		
		ЗаказПокупателя.СтруктурнаяЕдиница = ЗаказПокупателя.ДоговорКонтрагента.абс_БанковскийСчетОплатыКонтрагента;
		
	ИначеЕсли ЗначениеЗаполнено(ЗаказПокупателя.Организация.ОсновнойБанковскийСчет)
		И ЗаказПокупателя.Организация.ОсновнойБанковскийСчет.ВалютаДенежныхСредств = ЗаказПокупателя.ДоговорКонтрагента.ВалютаВзаиморасчетов Тогда
		
		ЗаказПокупателя.СтруктурнаяЕдиница = ЗаказПокупателя.Организация.ОсновнойБанковскийСчет;
		
	Иначе
		Запрос = Новый Запрос(
		"ВЫБРАТЬ
		|	БанковскиеСчета.Ссылка КАК Счет
		|ИЗ
		|	Справочник.БанковскиеСчета КАК БанковскиеСчета
		|ГДЕ
		|	БанковскиеСчета.Владелец = &Организация
		|   И БанковскиеСчета.ВалютаДенежныхСредств=&Валюта");
		
		Запрос.УстановитьПараметр("Организация"				, ЗаказПокупателя.Организация);
		Запрос.УстановитьПараметр("Валюта"					, ЗаказПокупателя.ДоговорКонтрагента.ВалютаВзаиморасчетов);
		
		ВыборкаЗапроса = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Если ВыборкаЗапроса.Количество()=1 Тогда
			ВыборкаЗапроса.Следующий();
			ЗаказПокупателя.СтруктурнаяЕдиница=ВыборкаЗапроса.Счет;
		КонецЕсли;
	КонецЕсли;
	
	// Склад
	СкладСсылка = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ОсновнойСклад");
	ЗаказПокупателя.СкладГруппа = СкладСсылка;
	
	Если ЗначениеЗаполнено(ЗаказПокупателя.Организация.абс_ОсновнойСклад) Тогда
		ЗаказПокупателя.СкладГруппа = ЗаказПокупателя.Организация.абс_ОсновнойСклад;
	КонецЕсли;
	
	//Табличная часть
	
	Для Каждого Строка ИЗ ТаблицаЗаказа Цикл
		НоваяСтрока = ЗаказПокупателя.Товары.Добавить();
		НоваяСтрока.Номенклатура = Строка.Номенклатура;
		НоваяСтрока.Размещение = СкладСсылка;
		НоваяСтрока.Количество = Строка.Количество;

		Если ЗначениеЗаполнено(НоваяСтрока.Номенклатура) Тогда
			НоваяСтрока.СтавкаНДС = НоваяСтрока.Номенклатура.СтавкаНДС;
		КонецЕсли;
	КонецЦикла;
	
	
	СпособЗаполненияЦен = Перечисления.СпособыЗаполненияЦен.ПоЦенамНоменклатуры;
	мВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	СтруктураРеквизитовДокумента = Ценообразование.ПолучитьСтруктуруРеквизитовДокументаДляЦенообразования(ЗаказПокупателя);
	СтруктураЗначений = ПолучитьСтруктуруФормы(ЗаказПокупателя);
	ЗаполнениеДокументов.ИзменитьЦеныВалюту(ЗаказПокупателя, СпособЗаполненияЦен, СтруктураРеквизитовДокумента, , "Товары", мВалютаРегламентированногоУчета, , СтруктураЗначений);
	
	
	// Заполняем табличную часть ценами номенклатуры исходя из типа цен договора контрагента
	//ЗаполнитьТабличнуюЧастьЦенами(ЗаказПокупателя);
	
	Попытка
		ЗаказПокупателя.Записать(РежимЗаписиДокумента.Запись);
		Сообщить("Создан документ "+ЗаказПокупателя.Ссылка);
		ЗаписьЖурналаРегистрации("ЗагрузкаЗаказовEDI.УспешнаяЗагрузка",УровеньЖурналаРегистрации.Ошибка,,,"Создан документ "+ЗаказПокупателя.Ссылка + " на основании сообщения " + НастройкаEDI.Наименование);
	Исключение
		Сообщить("Ошибка при создании заказа покупателя на основании сообщения " +  НастройкаEDI.Наименование);
		ЗаписьЖурналаРегистрации("ЗагрузкаЗаказовEDI.ОшибкаЗагрузки",УровеньЖурналаРегистрации.Ошибка,,,"Ошибка при создании заказа покупателя на основании сообщения " +  НастройкаEDI.Наименование);

	КонецПопытки;
	

	
	///////////////////////////////////
	Возврат ЗаказПокупателя;
    КонецЕсли;	
КонецФункции

Функция ПолучитьСтруктуруФормы(ЗаказПокупателя)
	
	// Заполним структуру возвращаемых параметров
	СтруктураВозвращаемыхЗначений = Новый Структура();
	СтруктураВозвращаемыхЗначений.Вставить("ТекущийТипЦен"						, ЗаказПокупателя.ТипЦен);
	СтруктураВозвращаемыхЗначений.Вставить("ТекущийВалютаДокумента"				, ЗаказПокупателя.ВалютаДокумента);
	СтруктураВозвращаемыхЗначений.Вставить("ТекущийВалютаВзаиморасчетов"		, ЗаказПокупателя.ДоговорКонтрагента.ВалютаВзаиморасчетов);
	СтруктураВозвращаемыхЗначений.Вставить("ТекущийКурсДокумента"				, ЗаказПокупателя.КурсВзаиморасчетов);
	СтруктураВозвращаемыхЗначений.Вставить("ТекущийКурсВзаиморасчетов"			, ЗаказПокупателя.КурсВзаиморасчетов);
	СтруктураВозвращаемыхЗначений.Вставить("ТекущийУчитыватьНДС"				, ЗаказПокупателя.УчитыватьНДС);
	СтруктураВозвращаемыхЗначений.Вставить("ТекущийСуммаВключаетНДС"			, ЗаказПокупателя.СуммаВключаетНДС);
	
	СтруктураВозвращаемыхЗначений.Вставить("ПерезаполнитьЦеныПоТипу"			, Истина);
	СтруктураВозвращаемыхЗначений.Вставить("ПерезаполнитьПроцентСкидкиНаценки"  , Ложь);
	СтруктураВозвращаемыхЗначений.Вставить("НовыйТипЦен"						, ЗаказПокупателя.ТипЦен);
	СтруктураВозвращаемыхЗначений.Вставить("ПересчитатьЦеныПоВалюте"			, Ложь);
	СтруктураВозвращаемыхЗначений.Вставить("НовыйВалютаДокумента"				, ЗаказПокупателя.ВалютаДокумента);
	СтруктураВозвращаемыхЗначений.Вставить("НовыйКурсДокумента"					, ЗаказПокупателя.КурсВзаиморасчетов);
	СтруктураВозвращаемыхЗначений.Вставить("НовыйКурсВзаиморасчетов"			, ЗаказПокупателя.КурсВзаиморасчетов);
	СтруктураВозвращаемыхЗначений.Вставить("НовыйУчитыватьНДС"					, ЗаказПокупателя.УчитыватьНДС);
	СтруктураВозвращаемыхЗначений.Вставить("НовыйСуммаВключаетНДС"				, ЗаказПокупателя.СуммаВключаетНДС);
	
	СтруктураВозвращаемыхЗначений.Вставить("ТекущийКратностьДокумента"			, ЗаказПокупателя.КратностьВзаиморасчетов);
	СтруктураВозвращаемыхЗначений.Вставить("НовыйКратностьДокумента"			, ЗаказПокупателя.КратностьВзаиморасчетов);
	
	СтруктураВозвращаемыхЗначений.Вставить("ТекущийКратностьВзаиморасчетов"		, ЗаказПокупателя.КратностьВзаиморасчетов);
	СтруктураВозвращаемыхЗначений.Вставить("НовыйКратностьВзаиморасчетов"		, ЗаказПокупателя.КратностьВзаиморасчетов);
	
	СтруктураВозвращаемыхЗначений.Вставить("ТекущийАвторасчетНДС"				, Истина);
	СтруктураВозвращаемыхЗначений.Вставить("НовыйАвторасчетНДС"					, Истина);
	СтруктураВозвращаемыхЗначений.Вставить("РассчитатьНДССУчетомОшибокОкругления", Ложь);
	
	СтруктураВозвращаемыхЗначений.Вставить("ТекущийИспользоватьПлановуюСебестоимость", Ложь);
	СтруктураВозвращаемыхЗначений.Вставить("НовыйИспользоватьПлановуюСебестоимость"  , Ложь);
	
	СтруктураВозвращаемыхЗначений.Вставить("ТекущийРегистрироватьЦеныПоставщика"     , Ложь);
	СтруктураВозвращаемыхЗначений.Вставить("НовыйРегистрироватьЦеныПоставщика"       , Ложь);
	
	Возврат СтруктураВозвращаемыхЗначений;
	
КонецФункции


Функция ПолучитьТипЦенПоДоговоруСКонтрагентом(ДоговорКонтрагента, ДатаЦен)
	
	Если НЕ ЗначениеЗаполнено(ДоговорКонтрагента) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ЕСТЬNULL(ТипыЦенПоГруппамНоменклатурыДляПокупателейСрезПоследних.ТипЦен, НЕОПРЕДЕЛЕНО) КАК ТипЦен
	|ИЗ
	|	РегистрСведений.ТипыЦенПоГруппамНоменклатурыДляПокупателей.СрезПоследних(
	|			&ДатаЦен,
	|			абс_ДоговорКонтрагента = &ДоговорКонтрагента
	|				И НоменклатурнаяЦеноваяГруппа = НЕОПРЕДЕЛЕНО
	|				И Контрагент = &Контрагент) КАК ТипыЦенПоГруппамНоменклатурыДляПокупателейСрезПоследних");
	
	Запрос.УстановитьПараметр("ДоговорКонтрагента"	, ДоговорКонтрагента);
	Запрос.УстановитьПараметр("Контрагент"			, ДоговорКонтрагента.Владелец);
	Запрос.УстановитьПараметр("ДатаЦен"				, ДатаЦен);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.ТипЦен;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

//Лео атанович}

Процедура ПрочитатьXMLФайлEDIФайловыйВаринт(НастройкаEDI, Отказ = Ложь) Экспорт
	//НастройкаEDI 	= Справочники.абс_НастройкиEDIОбмена.СистемнаяНастройка;
	КаталогЧтения 		= НастройкаEDI.КаталогОбменаИнформацией + "\" + НастройкаEDI.Входящие;
	
	//АБС ВСТАВКА   08.05.2014 18:35:03  Балашенко
	Если НайтиФайлы(КаталогЧтения).Количество()=0 Тогда
		СообщитьОбОшибкеОбмена("Не найден каталог обмена " + КаталогЧтения);
		Возврат;
	КонецЕсли;
	//АБС ВСТАВКА  КОНЕЦ
	
	//МаскаФайла 		= "order*" + ".xml";
	//МаскаФайла 		= "*order*" + ".xml";
	МаскаФайла		= "*.xml";  	
	МассивФайлов  = НайтиФайлы(КаталогЧтения,МаскаФайла, Ложь); 	
	Если МассивФайлов.Количество() > 0 Тогда   		
		Для Каждого ФайлЗаказа Из МассивФайлов Цикл  
			Попытка
				ПрочитатьORDERSЗаказ(ФайлЗаказа, НастройкаEDI);		
			Исключение
				//АБС 27.05.2014 44000
				Отказ = Истина;
				//АБС 27.05.2014 44000
				СообщитьОбОшибкеОбмена("Ошибка чтения файла """ + ФайлЗаказа.ПолноеИмя + """ !");		
				Продолжить;
			КонецПопытки;
			Если НастройкаEDI.ПереноситьВАрхивПослеЗагрузки Тогда
				ПереместитьФайл(ФайлЗаказа.ПолноеИмя, СтрЗаменить(ФайлЗаказа.ПолноеИмя, НастройкаEDI.Входящие, НастройкаEDI.Архив)); 		
			КонецЕсли;
		КонецЦикла;  	
	КонецЕсли;
КонецПроцедуры

Функция ПрочитатьORDERSЗаказ(ФайлЗаказа, НастройкаEDI, Отказ = Ложь) 	
	
	ЧтениеOrder = Новый ЧтениеXML;
	ЧтениеOrder.ОткрытьФайл(ФайлЗаказа.ПолноеИмя);    	
	Файл = Новый ТекстовыйДокумент;
	Файл.Прочитать(ФайлЗаказа.ПолноеИмя, "UTF-8");
	ТекстСообщенияXML = Файл.ПолучитьТекст(); 	
	СтруктураПараметров = Новый Структура;
	//СтруктураПараметров.Вставить("ТипСообщения", Перечисления.абс_ТипыСообщенийEDI.Заказ);
	СтруктураПараметров.Вставить("ЗаголовокФайла", ФайлЗаказа.Имя);
	СтруктураПараметров.Вставить("ТекстСообщенияXML", ТекстСообщенияXML);
	СтруктураПараметров.Вставить("НастройкаОбмена", НастройкаEDI); 
	
	//определим тип сообщения по имени файла и виду настройки обмена
	ТипСообщения = Документы.абс_СообщениеEDI.ОпределитьТипСообщения(ФайлЗаказа.Имя, НастройкаEDI);
	СтруктураПараметров.Вставить("ТипСообщения", ТипСообщения);
	
	Пока ЧтениеOrder.Прочитать() Цикл
		Если ЧтениеOrder.ТипУзла = ТипУзлаXML.НачалоЭлемента И ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "DOCUMENTNAME" Тогда
			ЧтениеOrder.Прочитать();
			ТипДокумента = ЧтениеOrder.Значение;
			
			Если ТипДокумента <> "220" Тогда
				Возврат Неопределено;
			КонецЕсли;
		КонецЕсли;
		
		Если ЧтениеOrder.ТипУзла = ТипУзлаXML.НачалоЭлемента 
			И (ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "NUMBER"
			ИЛИ ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "ORDERNUMBER"
			ИЛИ ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "ORDERID") Тогда
			ЧтениеOrder.Прочитать();
			НомерЗаказа = ЧтениеOrder.Значение;
			СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа", НомерЗаказа);
		КонецЕсли; 					
		Если ЧтениеOrder.ТипУзла = ТипУзлаXML.НачалоЭлемента 
			И (ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "DATE" 
			ИЛИ ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "ORDERDATE") Тогда
			ЧтениеOrder.Прочитать();
			ДатаЗаказа = ПолучитьДатуИзСтроки(ЧтениеOrder.Значение, "yyyy-MM-dd");
			СтруктураПараметров.Вставить("ДатаДокументаEDI", ДатаЗаказа);
			СтруктураПараметров.Вставить("Дата", ТекущаяДата());
		КонецЕсли;
		
		//<< Горбунов, добавил "Седьмой континент", "Леовит".
		//поставщик
		Если НастройкаEDI = Справочники.абс_НастройкиEDIОбмена.edi_su Или НастройкаEDI = Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit Тогда
			Если ЧтениеOrder.ТипУзла = ТипУзлаXML.НачалоЭлемента И ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "SUPPLIER"Тогда
				ЧтениеOrder.Прочитать();
				GLNпоставщика = ЧтениеOrder.Значение;
				СтруктураПараметров.Вставить("GLNПоставщика", GLNпоставщика);
			КонецЕсли; 			
		ИначеЕсли НастройкаEDI = Справочники.абс_НастройкиEDIОбмена.ecode_ru Тогда
			Если ЧтениеOrder.ТипУзла = ТипУзлаXML.НачалоЭлемента И ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "SELLER" Тогда
				ЧтениеOrder.Прочитать();
				ЧтениеOrder.Прочитать();
				GLNпоставщика = ЧтениеOrder.Значение;
				СтруктураПараметров.Вставить("GLNПоставщика", GLNпоставщика);
			КонецЕсли;
		//{Лео Катанович	
		ИначеЕсли НастройкаEDI = Справочники.абс_НастройкиEDIОбмена.КОРУС Тогда
			Если ЧтениеOrder.ТипУзла = ТипУзлаXML.НачалоЭлемента И ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "SELLER" Тогда
				ЧтениеOrder.Прочитать();
				ЧтениеOrder.Прочитать();
				GLNпоставщика = ЧтениеOrder.Значение;
				СтруктураПараметров.Вставить("GLNПоставщика", GLNпоставщика);
			КонецЕсли; 	
		//Лео Катанович}	
		Иначе
			//у 7конт нет данных по ИЛН
		КонецЕсли;
		//покупатель
		Если НастройкаEDI = Справочники.абс_НастройкиEDIОбмена.edi_su Или НастройкаEDI = Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit Тогда
			Если ЧтениеOrder.ТипУзла = ТипУзлаXML.НачалоЭлемента И ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "BUYER" Тогда
				ЧтениеOrder.Прочитать();
				GLNпокупателя = ЧтениеOrder.Значение;
				СтруктураПараметров.Вставить("GLNПокупателя", GLNпокупателя);
			КонецЕсли; 		
		ИначеЕсли НастройкаEDI = Справочники.абс_НастройкиEDIОбмена.ecode_ru Тогда
			Если ЧтениеOrder.ТипУзла = ТипУзлаXML.НачалоЭлемента И ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "BUYER" Тогда
				ЧтениеOrder.Прочитать();
				ЧтениеOrder.Прочитать();
				GLNпокупателя = ЧтениеOrder.Значение;
				СтруктураПараметров.Вставить("GLNПокупателя", GLNпокупателя);
			КонецЕсли; 	
		//{Лео Катанович	
		ИначеЕсли НастройкаEDI = Справочники.абс_НастройкиEDIОбмена.КОРУС Тогда
			Если ЧтениеOrder.ТипУзла = ТипУзлаXML.НачалоЭлемента И ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "BUYER" Тогда
				ЧтениеOrder.Прочитать();
				ЧтениеOrder.Прочитать();
				GLNпокупателя = ЧтениеOrder.Значение;
				СтруктураПараметров.Вставить("GLNПокупателя", GLNпокупателя);
			КонецЕсли; 	
		//Лео Катанович}	
		Иначе
			//у 7конт нет данных по ИЛН
		КонецЕсли;
		//грузополучатель
		Если НастройкаEDI = Справочники.абс_НастройкиEDIОбмена.edi_su Или НастройкаEDI = Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit Тогда
			Если ЧтениеOrder.ТипУзла = ТипУзлаXML.НачалоЭлемента И ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "DELIVERYPLACE" Тогда
				ЧтениеOrder.Прочитать();
				GLNГрузополучателя = ЧтениеOrder.Значение;
				СтруктураПараметров.Вставить("GLNГрузополучателя", GLNГрузополучателя);
			КонецЕсли; 		
		ИначеЕсли НастройкаEDI = Справочники.абс_НастройкиEDIОбмена.ecode_ru Тогда
			Если ЧтениеOrder.ТипУзла = ТипУзлаXML.НачалоЭлемента И ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "DeliveryPoint" Тогда
				ЧтениеOrder.Прочитать();
				ЧтениеOrder.Прочитать();
				GLNГрузополучателя = ЧтениеOrder.Значение;
				СтруктураПараметров.Вставить("GLNГрузополучателя", GLNГрузополучателя);
			КонецЕсли; 
		//{Лео Катанович	
		ИначеЕсли НастройкаEDI = Справочники.абс_НастройкиEDIОбмена.КОРУС Тогда
			Если ЧтениеOrder.ТипУзла = ТипУзлаXML.НачалоЭлемента И ВРЕГ(ЧтениеOrder.ЛокальноеИмя) = "DeliveryPoint" Тогда
				ЧтениеOrder.Прочитать();
				ЧтениеOrder.Прочитать();
				GLNГрузополучателя = ЧтениеOrder.Значение;
				СтруктураПараметров.Вставить("GLNГрузополучателя", GLNГрузополучателя);
			КонецЕсли;
		//Лео Катанович}	
		Иначе
			//у 7конт нет данных по ИЛН
		КонецЕсли;		
		
		// >> Горбунов, добавил "Седьмой континент", "Леовит".
	КонецЦикла;
	
	Если НЕ СтруктураПараметров.Свойство("GLNПоставщика") Тогда
		СтруктураПараметров.Вставить("GLNПоставщика", НастройкаEDI.ОрганизацияПоУмолчанию.абс_GLN);
	КонецЕсли;
	Если НЕ СтруктураПараметров.Свойство("GLNПокупателя") Тогда
		СтруктураПараметров.Вставить("GLNПокупателя", НастройкаEDI.КонтрагентПоУмолчанию.абс_GLN);
	КонецЕсли;
	
	Попытка
		СсылкаНаСообщениеEDI = Документы.абс_СообщениеEDI.ПоискСообщенияEDI(СтруктураПараметров);
	Исключение
		СсылкаНаСообщениеEDI = Неопределено;
	КонецПопытки;
	
	Если Не ЗначениеЗаполнено(СсылкаНаСообщениеEDI) Тогда
		ДокументСообщениеEDI = Документы.абс_СообщениеEDI.СоздатьДокумент();
	Иначе
		ДокументСообщениеEDI = СсылкаНаСообщениеEDI.ПолучитьОбъект();
	КонецЕСли;
	
	ЗаполнитьЗначенияСвойств(ДокументСообщениеEDI, СтруктураПараметров);
	
	ДокументСообщениеEDI.Ответственный = ПараметрыСеанса.ТекущийПользователь;
	
	Попытка
		ДокументСообщениеEDI.Записать();
		
		ДокСообщениеСсылка = ДокументСообщениеEDI.Ссылка;
	Исключение
		ДокСообщениеСсылка = Документы.абс_СообщениеEDI.ПустаяСсылка();
	КонецПопытки;
	
	//если нормально загрузили сообщение, то выполним команду по формированию заказа (или по записи данных о полученных товарах)
	Если ЗначениеЗаполнено(ДокСообщениеСсылка) И НастройкаEDI.СоздаватьЗаказыПриЗагрузкеСообщения Тогда
		Если ТипСообщения = Перечисления.абс_ТипыСообщенийEDI.Заказ Тогда
			Документы.абс_СообщениеEDI.ЗаполнитьЗаказПокупателяПоСообщениюEDI(ДокСообщениеСсылка);
		ИначеЕсли ТипСообщения = Перечисления.абс_ТипыСообщенийEDI.УведомлениеОПриемке Тогда
			Документы.абс_СообщениеEDI.ЗагрузитьУведомлениеОПриемкеВРеализацию(ДокСообщениеСсылка);
		КонецЕсли;
	КонецЕсли;
	
	Возврат ДокументСообщениеEDI.Ссылка;
	
КонецФункции

///////////////////////////////////////////////////////////////////////////////
//
//УНИВЕРСАЛЬНЫЕ ПРОЦЕДУРЫ ДЛЯ FTP
//

Функция ВыполнитьFTPПодключениеКСерверу(Знач ИмяFTPСервера, НастройкиОбмена, 
	ДанныеПротокола = "", Знач ВывестиИнформациюВОкноСообщений = Истина, СтруктураОбменаДанными = Неопределено) Экспорт      
	
	#Если Клиент Тогда
		Состояние("Выполняется подключение к FTP: " + ИмяFTPСервера);
	#КонецЕсли
	
	Попытка
		
		Соединение = Новый FTPСоединение(ИмяFTPСервера, НастройкиОбмена.ПортFTPСоединения, 
		НастройкиОбмена.ПользовательFTPСоединения, НастройкиОбмена.ПарольFTPСоединения, ,НастройкиОбмена.ПассивноеFTPСоединение);						
		
	Исключение
		// ошибка при подключении к ftp
		ПроцедурыОбменаДанными.СообщитьПростуюИнформацию("Ошибка при подключении к FTP : " + ИмяFTPСервера + " ! " + ОписаниеОшибки(), 
		ДанныеПротокола, ВывестиИнформациюВОкноСообщений, СтруктураОбменаДанными);
		Возврат Неопределено;
		
	КонецПопытки;
	
	Возврат Соединение;
	
КонецФункции

Процедура ПолучитьИмяСервераИИмяКаталогаОбмена(Знач ПолныйFTPАдрес, ИмяСервера, ИмяКаталога)
	
	АдресОбмена = ПроцедурыОбменаДанными.НормализоватьFTPАдрес(ПолныйFTPАдрес);
	
	// принцип получения адреса такой, все что до первой черты / или \ - это имя сервера, потом каталог
	АдресОбмена = СтрЗаменить(АдресОбмена, "\", "/");
	
	ПозицияПрямогоСлеша = Найти(АдресОбмена, "/");
	
	Если ПозицияПрямогоСлеша = 0 Тогда
		
		ИмяСервера = АдресОбмена;
		ИмяКаталога = "";
		
		
	Иначе
		
		ИмяСервера = Сред(АдресОбмена, 1, ПозицияПрямогоСлеша - 1);
		ИмяКаталога = Сред(АдресОбмена, ПозицияПрямогоСлеша);
		
		// последний должен быть слеш у имени каталога
		Если Сред(ИмяКаталога, СтрДлина(ИмяКаталога)) <> "/" Тогда
			
			ИмяКаталога = ИмяКаталога + "/";
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Функция ПроверитьНаличиеКаталогаНаFTPСервере(Соединение, Знач ИмяКаталогаСервера, 
	ДанныеПротокола = "", Знач ВывестиИнформациюВОкноСообщений = Истина, СтруктураОбменаДанными = Неопределено)
	
	Если ПустаяСтрока(ИмяКаталогаСервера) Тогда
		Возврат Истина;
	КонецЕсли;
	
	//надо сначала проверить что сам каталог доступа есть
	Попытка
		
		МассивНайденныхКаталогов = Соединение.НайтиФайлы(ИмяКаталогаСервера, "");
		
	Исключение
		
		// ошибка при подключении к ftp
		ПроцедурыОбменаДанными.СообщитьПростуюИнформацию("Ошибка при соединении с FTP : " + ИмяКаталогаСервера + " ! " + ОписаниеОшибки(), 
		ДанныеПротокола, ВывестиИнформациюВОкноСообщений, СтруктураОбменаДанными);
		Возврат Ложь;
		
	КонецПопытки;
	
	Для Каждого НайденныйКаталог Из МассивНайденныхКаталогов Цикл
		
		// если не каталог - то дальше ищем
		Если НЕ НайденныйКаталог.ЭтоКаталог() Тогда
			Продолжить;
		КонецЕсли;
		
		// большие и маленькие буквы считаются различными
		Если НайденныйКаталог.ПолноеИмя <> "/" + ИмяКаталогаСервера Тогда
			Продолжить;
		КонецЕсли;
		
		Возврат Истина;
		
	КонецЦикла;
	
	// если не найден каталог для обмена
	ПроцедурыОбменаДанными.СообщитьПростуюИнформацию("Не найден FTP каталог обмена информацией: " + ИмяКаталогаСервера, 
	ДанныеПротокола, ВывестиИнформациюВОкноСообщений, СтруктураОбменаДанными);
	
	Возврат Ложь;
	
КонецФункции

///////////////////////////////////////////////////////////////////////////////
//
//УНИВЕРСАЛЬНЫЕ ПРОЦЕДУРЫ ДЛЯ ЧТЕНИЯ, РАЗБОРА ДАННЫХ
//

Функция ПолучитьСоставляющиеДаты(стрДата)
	
	ДлинаСтроки = СтрДлина(стрДата);
	СоставляющиеДаты = Новый Массив;
	СоставляющиеДаты.Добавить("");
	ПоследняяПозицияЦифры = 1;
	
	Сч = 0;
	Пока Истина Цикл
		
		Если Сч = ДлинаСтроки Или СоставляющиеДаты.Количество() >=6 Тогда
			Прервать;
		КонецЕсли;
		
		Если Не ПустаяСтрока(СоставляющиеДаты[СоставляющиеДаты.ВГраница()]) Тогда 
			СоставляющиеДаты.Добавить("");
		КонецЕсли;
		
		Пока Сч < ДлинаСтроки Цикл
			Сч = Сч + 1;
			ТекСимвол = Сред(стрДата, Сч, 1);
			Если ТолькоЦифры(ТекСимвол) Тогда
				СоставляющиеДаты[СоставляющиеДаты.ВГраница()] = СоставляющиеДаты[СоставляющиеДаты.ВГраница()] + ТекСимвол;
			Иначе
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
	КонецЦикла;
	
	Возврат СоставляющиеДаты;
	
КонецФункции

Функция ТолькоЦифры(Текст)
	Длина = СтрДлина(Текст);
	Для Сч = 1 По Длина Цикл
		ТекКодСимвола = КодСимвола(Сред(Текст, Сч, 1));
		Если  ТекКодСимвола < 48 Или 57 < ТекКодСимвола Тогда
			Возврат Ложь;
		КонецЕсли;  
	КонецЦикла;
	Возврат Истина;
КонецФункции

Функция ПолучитьДатуИзСтроки(стрДата, Знач ФорматнаяСтрока = "") Экспорт
	
	Значение = Дата(1,1,1);
	
	Если ПустаяСтрока(стрДата) Или  ВРег(стрДата) = "NULL" Тогда
		
		Значение = Дата(1,1,1);
		
	Иначе 
		
		Если ПустаяСтрока(ФорматнаяСтрока) Тогда
			
			Попытка
				Значение = Дата(стрДата);
			Исключение
				Попытка
					Значение = Дата(стрДата + " 00:00:00");
				Исключение
					Значение = Дата(1,1,1);
				КонецПопытки;
			КонецПопытки;
			
		Иначе
			
			СоставляющиеДаты = ПолучитьСоставляющиеДаты(стрДата);
			
			Если СоставляющиеДаты.количество() < 3 Тогда
				Возврат Дата(1,1,1);
			КонецЕсли;
			
			Если ФорматнаяСтрока = "yyyy-MM-dd" Тогда// HH:mm:ss
				
				СтрГод = СоставляющиеДаты[0];
				СтрМесяц = СоставляющиеДаты[1];
				СтрДень = СоставляющиеДаты[2];
				
			ИначеЕсли ФорматнаяСтрока = "MM.dd.yyyy" Тогда  // HH:mm:ss
				
				СтрГод = СоставляющиеДаты[2];
				СтрМесяц = СоставляющиеДаты[0];
				СтрДень = СоставляющиеДаты[1];
				
			ИначеЕсли ФорматнаяСтрока = "dd.MM.yyyy" Тогда
				
				СтрГод = СоставляющиеДаты[2];
				СтрМесяц = СоставляющиеДаты[1];
				СтрДень = СоставляющиеДаты[0];
				
			Иначе
				
				ВызватьИсключение "Не предусмотренный формат строки";
				
			КонецЕсли;
			
			Если СоставляющиеДаты.Количество() >=6 Тогда			
				СтрВремя = СоставляющиеДаты[3] + ":" + СоставляющиеДаты[4] + ":" +СоставляющиеДаты[5]; 
			Иначе
				СтрВремя = "00:00:00";
			КонецЕсли;
			
			Попытка
				Значение = Дата(СтрДень + "." + СтрМесяц + "." + СтрГод + " " + СтрВремя);
			Исключение
				Значение = Дата(1,1,1);
			КонецПопытки;
			
		КонецЕсли;		
		
	КонецЕсли;
	
	Возврат Значение;
	
КонецФункции

///////////////////////////////////////////////////////////////////////////////
//
//ПРОЧИЕ ПРОЦЕДУРЫ И ФУНКЦИИ
//

Процедура СообщитьОбОшибкеОбмена(ТекстСообщенияОбОшибке)
	
	Сообщить(ТекстСообщенияОбОшибке, СтатусСообщения.ОченьВажное);
	
	ЗаписьЖурналаРегистрации("ОбменДаннымиEDI", УровеньЖурналаРегистрации.Ошибка);
	
КонецПроцедуры



///////////////////////////////////////////////////////////////////////////////
//
//ПРОЦЕДУРЫ ДЛЯ ОБМЕНА С METRO-MGL
//

// Процедура предназначена для записи файла выгрузки
//
// Параметры:
//  мМассивРеализаций - (Массив), тип элементов массива (ДокументСсылка.РеализацияТоваровУслуг), массив выгружаемых реализаций
//  сКаталогВыгрузки - (Строка), строка, в которую выгружается файл обмена, по умолчанию - каталог временных файлов
//
// Возвращаемое значение:
//  сАдресВременногоХранилища - (Строка), адрес временного хранилища, содержащего сформированный файл выгрузки
Функция ВыгрузитьДанныеМетро(мМассивРеализаций, сКаталогВыгрузки = Неопределено) Экспорт
	
	//сформируем ТД с данными выгрузки
	ТДДляВыгрузки = СформироватьДанныеВыгрузкиМетро(мМассивРеализаций);
	
	//если данные не сформированы - не выгружаем
	Если ТДДляВыгрузки = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	//если каталог не задан - выгружаем в каталог временных файлов
	Если сКаталогВыгрузки = Неопределено Тогда
		сКаталогВыгрузки = КаталогВременныхФайлов();
	КонецЕсли;
	
	//отсекаем возможные пробелы в пути каталога выгрузки
	сКаталогВыгрузки = СокрЛП(сКаталогВыгрузки);
	
	//каталог могут скопировать в поле ввода с последним слэшем - отсечем его
	Если Прав(сКаталогВыгрузки, 1) = "\" Тогда
		сКаталогВыгрузки = Лев(сКаталогВыгрузки, СтрДлина(сКаталогВыгрузки)-1);	
	КонецЕсли;
	
	//проверим существование каталога
	фКаталог = Новый Файл(сКаталогВыгрузки);
	Если НЕ фКаталог.Существует() Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Неверно задан каталог выгрузки """ + сКаталогВыгрузки + """";
		Сообщение.Сообщить();			
		Возврат Неопределено;
	КонецЕсли;
	
	//сформируем имя файла
	сПолноеИмяФайлаВыгрузки = сКаталогВыгрузки + "\" + "MGL" + Формат(ТекущаяДата(), "ДФ=ddMMyy_HHmm") + ".swr";
	
	//запишем файл
	Попытка
		ТДДляВыгрузки.Записать(сПолноеИмяФайлаВыгрузки, КодировкаТекста.UTF8);	
	Исключение
		//вероятно, нет прав на запись
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Ошибка записи файла в каталог """ + сКаталогВыгрузки + """" + Символы.ПС +
		"Проверьте права доступа к данному каталогу!";
		Сообщение.Сообщить();
		Возврат Неопределено;
	КонецПопытки;
	
	//создадим двоичные данные и хранилище для передачи на клиент
	ддДанныеФайла = Новый ДвоичныеДанные(сПолноеИмяФайлаВыгрузки);	
	сАдресВременногоХранилища = ПоместитьВоВременноеХранилище(ддДанныеФайла);
	
	Возврат сАдресВременногоХранилища;
	
КонецФункции

// Процедура предназначена для создания текстового документа с данными выгрузки в формате metro-mgl
//
// Параметры:
//  мМассивРеализаций - (Массив), тип элементов массива (ДокументСсылка.РеализацияТоваровУслуг), массив выгружаемых реализаций
//
// Возвращаемое значение:
//  тдТекстовыйДокумент - (ТекстовыйДокумент), содержащий данные выгрузки
Функция СформироватьДанныеВыгрузкиМетро(мМассивРеализаций)
	
	//сбор данных по реализациям
	//для каждой реализации "подтягиваются" данные также 
	//по последней проведенной заявке на транспорт
	Запрос = Новый Запрос;
	Запрос.Текст = 
	//подготовим таблицу заявок но транспорт, введенных на основании выгружаемых реализаций
	//и удовлетворяющих условиям - заявка проведена, заявка не в статусе "Создан"
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	абс_ЗаявкаНаТранспорт.Ссылка,
	|	абс_ЗаявкаНаТранспорт.Дата,
	|	абс_ЗаявкаНаТранспорт.ДокументОтгрузки,
	|	абс_ЗаявкаНаТранспорт.НомерЗаказаКлиента,
	|	абс_ЗаявкаНаТранспорт.ПланируемаяДатаОтгрузки,
	|	абс_ЗаявкаНаТранспорт.ПланируемаяДатаДоставки,
	|	абс_ЗаявкаНаТранспорт.ВсегоОбъем,
	|	абс_ЗаявкаНаТранспорт.ВсегоВес,
	|	абс_ЗаявкаНаТранспорт.ВсегоКоличествоКоробов,
	|	абс_ЗаявкаНаТранспорт.ВсегоКоличествоПалет,
	|	абс_ЗаявкаНаТранспорт.СуммаДокумента,
	|	абс_ЗаявкаНаТранспорт.ВсегоКоличествоПалет КАК ВсегоКоличествоЕвроПалет
	|ПОМЕСТИТЬ ВТ_ЗаявкиНаТранспорт
	|ИЗ
	|	Документ.абс_ЗаявкаНаТранспорт КАК абс_ЗаявкаНаТранспорт
	|ГДЕ
	|	абс_ЗаявкаНаТранспорт.ДокументОтгрузки В(&мМассивРеализаций)
	|	И абс_ЗаявкаНаТранспорт.Проведен
	|	И абс_ЗаявкаНаТранспорт.Статус <> ЗНАЧЕНИЕ(Перечисление.абс_СтатусыЗаявокНаТранспорт.Создан)
	|;
	|
	//для организации, грузополучателя и склада получим свойства - коды для Метро
	//входящий номер заказа покупателя получим из заказа покупателя (поле Сделка)
	//данные о параметрах груза берем из заявки на транспорт
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	РеализацияТоваровУслуг.Дата КАК Дата,
	|	РеализацияТоваровУслуг.Номер КАК Номер,
	|	ЕСТЬNULL(ПоследниеЗаявкиНаТранспорт.ПланируемаяДатаОтгрузки, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаОтгрузки,
	|	ЕСТЬNULL(ПоследниеЗаявкиНаТранспорт.ПланируемаяДатаДоставки, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДоставки,
	|	РеализацияТоваровУслуг.ВалютаДокумента.абс_БуквенныйКодISO4217 КАК КодВалюты,
	|	ЕСТЬNULL(ЗначенияСвойствОбъектов_Организации.Значение, """") КАК НомерПоставщика,
	|	ЕСТЬNULL(ЗначенияСвойствОбъектов_Склады.Значение, """") КАК НомерСклада,
	|	ЕСТЬNULL(ЗначенияСвойствОбъектов_Контрагенты.Значение, """") КАК НомерПолучателя,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.Сделка ССЫЛКА Документ.ЗаказПокупателя
	|			ТОГДА РеализацияТоваровУслуг.Сделка.НомерПоДаннымПокупателя
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК НомерЗаказа,
	|	РеализацияТоваровУслуг.абс_КоличествоПаллет КАК КоличествоПалет,
	|	ЕСТЬNULL(ПоследниеЗаявкиНаТранспорт.ВсегоКоличествоЕвроПалет, 0) КАК КоличествоЕвроПалет,
	|	РеализацияТоваровУслуг.абс_КоличествоТранспортныхКоробов КАК КоличествоКоробов,
	|	РеализацияТоваровУслуг.абс_ФактическийВес КАК Вес,
	|	ЕСТЬNULL(ПоследниеЗаявкиНаТранспорт.СуммаДокумента, 0) КАК Стоимость,
	|	РеализацияТоваровУслуг.абс_ФактическийОбъем КАК Объем,
	|	РеализацияТоваровУслуг.Ссылка,
	|	РеализацияТоваровУслуг.Организация
	|ИЗ
	|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов_Организации
	|		ПО РеализацияТоваровУслуг.Организация = ЗначенияСвойствОбъектов_Организации.Объект
	|			И (ЗначенияСвойствОбъектов_Организации.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодОрганизацииДляМетро))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов_Контрагенты
	|		ПО РеализацияТоваровУслуг.Грузополучатель = ЗначенияСвойствОбъектов_Контрагенты.Объект
	|			И (ЗначенияСвойствОбъектов_Контрагенты.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодКонтрагентаДляМетро))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов_Склады
	|		ПО РеализацияТоваровУслуг.Склад = ЗначенияСвойствОбъектов_Склады.Объект
	|			И (ЗначенияСвойствОбъектов_Склады.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодСкладаДляМетро))
	//выбираем последнюю по дате заявку (если подходящих несколько)
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ВТ_ЗаявкиНаТранспорт.ДокументОтгрузки КАК ДокументОтгрузки,
	|			ВТ_ЗаявкиНаТранспорт.НомерЗаказаКлиента КАК НомерЗаказаКлиента,
	|			ВТ_ЗаявкиНаТранспорт.ПланируемаяДатаОтгрузки КАК ПланируемаяДатаОтгрузки,
	|			ВТ_ЗаявкиНаТранспорт.ПланируемаяДатаДоставки КАК ПланируемаяДатаДоставки,
	|			ВТ_ЗаявкиНаТранспорт.ВсегоОбъем КАК ВсегоОбъем,
	|			ВТ_ЗаявкиНаТранспорт.ВсегоВес КАК ВсегоВес,
	|			ВТ_ЗаявкиНаТранспорт.ВсегоКоличествоКоробов КАК ВсегоКоличествоКоробов,
	|			ВТ_ЗаявкиНаТранспорт.ВсегоКоличествоПалет КАК ВсегоКоличествоПалет,
	|			ВТ_ЗаявкиНаТранспорт.СуммаДокумента КАК СуммаДокумента,
	|			ВТ_ЗаявкиНаТранспорт.ВсегоКоличествоЕвроПалет КАК ВсегоКоличествоЕвроПалет
	|		ИЗ
	|			ВТ_ЗаявкиНаТранспорт КАК ВТ_ЗаявкиНаТранспорт
	|				ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|					ВТ_ЗаявкиНаТранспорт.ДокументОтгрузки КАК ДокументОтгрузки,
	|					МАКСИМУМ(ВТ_ЗаявкиНаТранспорт.Дата) КАК Дата
	|				ИЗ
	|					ВТ_ЗаявкиНаТранспорт КАК ВТ_ЗаявкиНаТранспорт
	|				
	|				СГРУППИРОВАТЬ ПО
	|					ВТ_ЗаявкиНаТранспорт.ДокументОтгрузки) КАК ВложенныйЗапрос
	|				ПО ВТ_ЗаявкиНаТранспорт.ДокументОтгрузки = ВложенныйЗапрос.ДокументОтгрузки
	|					И ВТ_ЗаявкиНаТранспорт.Дата = ВложенныйЗапрос.Дата) КАК ПоследниеЗаявкиНаТранспорт
	|		ПО РеализацияТоваровУслуг.Ссылка = ПоследниеЗаявкиНаТранспорт.ДокументОтгрузки
	|ГДЕ
	|	РеализацияТоваровУслуг.Ссылка В(&мМассивРеализаций)";
	
	Запрос.УстановитьПараметр("мМассивРеализаций", мМассивРеализаций);
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	//проверим корректность заполнения данных
	//инициализация
	Отказ = Ложь;
	мМассивОшибок = Новый Массив;
	
	//для каждого документа
	Пока Выборка.Следующий() Цикл
		//текущая реализация
		ссТекРеализация = Выборка.Ссылка;
		//ошибок по текущей реализации пока не нашли
		мМассивОшибок.Очистить();
		
		//проверки
		Если НЕ ЗначениеЗаполнено(Выборка.ДатаОтгрузки) Тогда
			мМассивОшибок.Добавить("Не заполнена дата отгрузки");
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(Выборка.ДатаДоставки) Тогда
			мМассивОшибок.Добавить("Не заполнена дата доставки");
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(Выборка.КодВалюты) Тогда
			мМассивОшибок.Добавить("Не заполнен код валюты");
		КонецЕсли;		
		Если НЕ ЗначениеЗаполнено(Выборка.НомерПоставщика) Тогда
			мМассивОшибок.Добавить("Не заполнен номер поставщика");
		КонецЕсли;		
		Если НЕ ЗначениеЗаполнено(Выборка.НомерСклада) Тогда
			мМассивОшибок.Добавить("Не заполнен номер склада поставщика");
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(Выборка.НомерПолучателя) Тогда
			мМассивОшибок.Добавить("Не заполнен номер получателя");
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(Выборка.КоличествоПалет) И НЕ ЗначениеЗаполнено(Выборка.КоличествоКоробов) Тогда
			мМассивОшибок.Добавить("Не заполнено количество паллет или коробов");
		КонецЕсли;
		Если (ЗначениеЗаполнено(Выборка.КоличествоПалет) И ЗначениеЗаполнено(Выборка.КоличествоКоробов)) Тогда
			мМассивОшибок.Добавить("Некорректно заполнено количество паллет и коробов");
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(Выборка.Вес) Тогда
			мМассивОшибок.Добавить("Не заполнен вес груза");
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(Выборка.Стоимость) Тогда
			мМассивОшибок.Добавить("Не заполнена стоимость груза");
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(Выборка.Объем) Тогда
			мМассивОшибок.Добавить("Не заполнен объем груза");
		КонецЕсли;
		//\\проверки
		
		//если есть ошибки по документу - формируем сообщение пользователю
		Если мМассивОшибок.Количество() > 0 Тогда
			
			Отказ = Истина;
			
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = "Для документа " + ссТекРеализация + " неверно заполнены данные:" + Символы.ПС;
			
			Для Каждого СообщениеОбОшибке Из мМассивОшибок Цикл
				Сообщение.Текст = Сообщение.Текст + " " + СообщениеОбОшибке + Символы.ПС;
			КонецЦикла;
			Сообщение.Сообщить();	
			
		КонецЕсли;
		
	КонецЦикла;
	//если есть ошибки - прерываем выгрузку
	Если Отказ Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	//если все данные заполнены - выгружаем
	тдДанныеВыгрузки = Новый ТекстовыйДокумент;
	дНачалоВыгрузки = ТекущаяДата();
	
	//сегмент ICMHDR - начало сообщения обмена
	СтрокаСегмента = "";
	СтрокаСегмента = СтрокаСегмента + "ICMHDR";//тэг сегмента
	СтрокаСегмента = СтрокаСегмента + "DELVRY";//тип сообщения
	СтрокаСегмента = СтрокаСегмента + "001";//версия формата обмена
	СтрокаСегмента = СтрокаСегмента + "000";//релиз формата обмена
	СтрокаСегмента = СтрокаСегмента + "MGL" + Формат(дНачалоВыгрузки, "ДФ=ddMMyy_HHmm");//имя файла
	СтрокаСегмента = СтрокаСегмента + Формат(дНачалоВыгрузки, "ДФ=ddMMyyyy");//дата выгрузки
	СтрокаСегмента = СтрокаСегмента + Формат(дНачалоВыгрузки, "ДФ=HHmmss");//время выгрузки
	
	тдДанныеВыгрузки.ДобавитьСтроку(СтрокаСегмента);
	
	Выборка.Сбросить();
	Пока Выборка.Следующий() Цикл
		//сегмент ICSSMD - начало блока данных отгрузки
		СтрокаСегмента = "";
		СтрокаСегмента = СтрокаСегмента + "ICSSMD";//тэг сегмента
		СтрокаСегмента = СтрокаСегмента + "s";//тип заказа
		СтрокаСегмента = СтрокаСегмента + "4";//код модуля
		СтрокаСегмента = СтрокаСегмента + "s";//код обработки
		СтрокаСегмента = СтрокаСегмента + "d";//тип файла
		СтрокаСегмента = СтрокаСегмента + "9";//код функции
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами(Выборка.НомерПоставщика, 20, " ");//номер поставщика
		СтрокаСегмента = СтрокаСегмента + "S";//тип ИД
		//сформируем ИД поставки - Номер поставщика + 2 символа года документа + 7 символов номера документа
		сИДПоставки = СокрЛП(Выборка.НомерПоставщика) + Формат(Выборка.Дата, "ДФ=yy") + Прав(Выборка.Номер, 7);
		СтрокаСегмента = СтрокаСегмента + сИДПоставки;//ИД поставки
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 8, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 8, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 8, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + Формат(Выборка.ДатаОтгрузки, "ДФ=ddMMyyyy");//дата отгрузки
		СтрокаСегмента = СтрокаСегмента + Формат(Выборка.ДатаДоставки, "ДФ=ddMMyyyy");//дата доставки
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 14, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 14, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 15, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 15, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 20, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 8, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 8, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 11, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 3, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 14, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 2, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + "100 ";//темп. режим
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 14, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 1, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 3, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 15, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 5, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 5, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + "0800";//время отгрузки по умолчанию
		СтрокаСегмента = СтрокаСегмента + "2359";//время доставки по умолчанию
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 4, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 1, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 3, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 14, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 1, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 2, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 20, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 1, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 1, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 1, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 1, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 1, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 1, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 1, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 1, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 1, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 1, " ");//пустое поле
		
		тдДанныеВыгрузки.ДобавитьСтроку(СтрокаСегмента);
		
		//сегмент ICSFIR - номер заказа
		СтрокаСегмента = "";
		СтрокаСегмента = СтрокаСегмента + "ICSFIR";//тэг сегмента
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("PO1", 10, " ");//номер строки заказа
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами(СокрЛП(Выборка.НомерЗаказа), 30, " ");//номер заказа
		
		тдДанныеВыгрузки.ДобавитьСтроку(СтрокаСегмента);
		
		//сегмент ICSNAW - адрес отправителя
		СтрокаСегмента = "";
		СтрокаСегмента = СтрокаСегмента + "ICSNAW";//тэг сегмента
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("1", 2, " ");//квалификатор - отправитель
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами(СокрЛП(Выборка.НомерСклада), 20, " ");//номер склада поставщика
		СтрокаСегмента = СтрокаСегмента + "S";//тип ИД
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("-", 35, " ");//наименование - не заполняется
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 35, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 35, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("-", 35, " ");//адрес - не заполняется
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 35, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 35, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 9, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("-", 35, " ");//город - не заполняется
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("-", 3, " ");//страна - не заполняется
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 17, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 20, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 20, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 50, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 15, " ");//пустое поле
		
		тдДанныеВыгрузки.ДобавитьСтроку(СтрокаСегмента);
		
		//сегмент ICSNAW - адрес получателя
		СтрокаСегмента = "";
		СтрокаСегмента = СтрокаСегмента + "ICSNAW";//тэг сегмента
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("3", 2, " ");//квалификатор - получатель
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами(СокрЛП(Выборка.НомерПолучателя), 20, " ");//номер магазина-получателя
		СтрокаСегмента = СтрокаСегмента + "S";//тип ИД
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("-", 35, " ");//наименование - не заполняется
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 35, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 35, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("-", 35, " ");//адрес - не заполняется
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 35, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 35, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 9, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("-", 35, " ");//город - не заполняется
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("-", 3, " ");//страна - не заполняется
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 17, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 20, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 20, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 50, " ");//пустое поле
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 15, " ");//пустое поле
		
		тдДанныеВыгрузки.ДобавитьСтроку(СтрокаСегмента);
		
		//сегмент ICSOMS - приложенные документы
		СтрокаСегмента = "";
		СтрокаСегмента = СтрокаСегмента + "ICSOMS";//тэг сегмента
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("MWD", 10, " ");//квалификатор - приложенные документы
		//сформируем текст по номеру реализации
		сСтрокаПриложенныхДокументов = "ТН № " + ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка);
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами(сСтрокаПриложенныхДокументов, 70, " ");//строка по приложенной ТН
		
		тдДанныеВыгрузки.ДобавитьСтроку(СтрокаСегмента);
		
		//сегмент ICSVVI - средства контроля
		СтрокаСегмента = "";
		СтрокаСегмента = СтрокаСегмента + "ICSVVI";//тэг сегмента
		СтрокаСегмента = СтрокаСегмента + "000";//номер строки сегмента
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("Фирменный скотч Леовит", 30, " ");//строка по скотчу
		
		тдДанныеВыгрузки.ДобавитьСтроку(СтрокаСегмента);
		
		//сегмент ICGINE - описание товаров		
		СтрокаСегмента = "";
		СтрокаСегмента = СтрокаСегмента + "ICGINE";//тэг сегмента
		СтрокаСегмента = СтрокаСегмента + "9";//код функции		
		//заполнено может быть только одно из количеств - палет или коробов
		чКоличествоУпаковок = ?(ЗначениеЗаполнено(Выборка.КоличествоПалет), Выборка.КоличествоПалет, Выборка.КоличествоКоробов);
		СтрокаСегмента = СтрокаСегмента + ФорматироватьЧисло(чКоличествоУпаковок, 14, 3, Истина);//количество упаковок
		//код зависит от типа упаковки
		//по умолчанию - стандартные палеты
		сТипУпаковки = "sp";
		Если ЗначениеЗаполнено(Выборка.КоличествоКоробов) Тогда
			сТипУпаковки = "pc";
		КонецЕсли;
		СтрокаСегмента = СтрокаСегмента + сТипУпаковки;//тип упаковки
		СтрокаСегмента = СтрокаСегмента + ФорматироватьЧисло(Выборка.Вес, 14, 3, Истина);//вес
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 14, " ");//пустая строка
		СтрокаСегмента = СтрокаСегмента + "100 ";//темп. режим
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 3, " ");//пустая строка
		СтрокаСегмента = СтрокаСегмента + ФорматироватьЧисло(Выборка.Объем, 14, 3, Истина);//объем
		СтрокаСегмента = СтрокаСегмента + "C";//код объема - кубометры
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 14, " ");//пустая строка
		СтрокаСегмента = СтрокаСегмента + ФорматироватьЧисло(Выборка.Стоимость, 14, 3, Ложь);//стоимость
		СтрокаСегмента = СтрокаСегмента + ФорматироватьЧисло(Выборка.КоличествоЕвроПалет, 14, 3, Истина);//количество европалет
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 3, " ");//пустая строка
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами(Выборка.КодВалюты, 3, " ");//код валюты
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами(?(ЗначениеЗаполнено(Выборка.КоличествоЕвроПалет), "ep", ""), 22, " ");//квалификатор европалет - заполняется если указано их количество		
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 3, " ");//пустая строка
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 9, " ");//пустая строка
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 4, " ");//пустая строка
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 3, " ");//пустая строка
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 4, " ");//пустая строка
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 4, " ");//пустая строка
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 4, " ");//пустая строка
		
		тдДанныеВыгрузки.ДобавитьСтроку(СтрокаСегмента);
		
		//сегмент ICGDES - описание товара
		СтрокаСегмента = "";
		СтрокаСегмента = СтрокаСегмента + "ICGDES";//тэг сегмента
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 23, " ");//пустая строка
		СтрокаСегмента = СтрокаСегмента + ДополнитьСтрокуСимволами("", 25, " ");//описание продуктов
		
		тдДанныеВыгрузки.ДобавитьСтроку(СтрокаСегмента);
		
	КонецЦикла;	
	
	//сегмент ICMTRL - контрольный сегмент
	СтрокаСегмента = "";
	СтрокаСегмента = СтрокаСегмента + "ICMTRL";//тэг сегмента
	СтрокаСегмента = СтрокаСегмента + Формат(тдДанныеВыгрузки.КоличествоСтрок() + 1, "ЧЦ=6; ЧВН=; ЧГ=0");//количество сегментов в сообщении, включая этот
	
	тдДанныеВыгрузки.ДобавитьСтроку(СтрокаСегмента);
	
	
	Возврат тдДанныеВыгрузки;
	
КонецФункции

///////////////////////////////////////////////////////////////////////////////
//
//ПРОЦЕДУРЫ ФОРМАТИРОВАНИЯ ДАННЫХ
//

// Процедура предназначена для форматирования строки
// Длина строки приводится к указанному количеству символов 
// Если длины переданной строки недостаточно - она дополняется справа определенными символами
//
// Параметры:
//  сСтрока - (Строка), форматируемая строка
//  чКоличествоСимволов - (Число), длина числа
//  сСимволДополнения - (Строка), символ, которым дополняется строка
//
// Возвращаемое значение:
//  сРезультат - (Строка), форматированное значение
Функция ДополнитьСтрокуСимволами(сСтрока, чКоличествоСимволов, сСимволДополнения = " ")
	
	//обрезаем строку по переданной длине
	//обрезаем пробелы слева и справа
	сРезультат = СокрЛП(Лев(сСтрока, чКоличествоСимволов));
	
	//дополняем строку
	Пока СтрДлина(сРезультат) < чКоличествоСимволов Цикл
		сРезультат = сРезультат + сСимволДополнения;	
	КонецЦикла;
	
	Возврат сРезультат;
	
КонецФункции

// Процедура предназначена для форматирования числа
// Число представляется без разделителей, с выводом лидирующих нулей, у знаковых чисел последний символ отводится под знак
//
// Параметры:
//  чЧисло - (Число), форматируемое число
//  чДлина - (Число), длина числа
//  чТочность - (Число), точность чила
//  бЗнаковое - (Булево), признак знаковости/беззнаковости
//
// Возвращаемое значение:
//  сРезультат - (Строка), форматированное значение числа
Функция ФорматироватьЧисло(чЧисло, чДлина, чТочность, бЗнаковое)
	
	//если число знаковое - длина уменьшается на 1, последний символ строки используется для знака
	Если бЗнаковое Тогда
		чДлина = чДлина - 1;		
	КонецЕсли;
	
	//форматируем в зависимости от переданных значений длины и точности
	//длину и точность тоже форматируем, на всякий случай
	сРезультат = Формат(чЧисло, "ЧЦ=" + Формат(чДлина, "ЧДЦ=0; ЧН=; ЧГ=") + "; ЧДЦ=" + Формат(чТочность, "ЧДЦ=0; ЧН=; ЧГ=") + "; ЧН=; ЧВН=; ЧГ=0");
	//удаляем разделитель дробной части
	сРезультат = СтрЗаменить(сРезультат, ",", "");
	
	//если число знаковое - добавляем знак в конце
	Если бЗнаковое Тогда
		Если чЧисло >= 0 Тогда
			сРезультат = сРезультат + " ";
		Иначе
			сРезультат = сРезультат + "-";
		КонецЕсли;
	КонецЕсли;
	
	Возврат сРезультат;
	
КонецФункции

///////////////////////////////////////////////////////////////////////////////
//ПРОЦЕДУРЫ ВЫГРУЗКИ ДАННЫХ ПУБ 7.7
//

Функция ПолучитьСписокЗапрещенныхСимволовВИменахФайловEDI()
	
	СписокСимволов = Новый СписокЗначений();
	
	СписокСимволов.Добавить("\");
	СписокСимволов.Добавить("/");
	СписокСимволов.Добавить(":");
	СписокСимволов.Добавить("*");
	СписокСимволов.Добавить("&");
	СписокСимволов.Добавить("""");
	СписокСимволов.Добавить("<");
	СписокСимволов.Добавить(">");
	СписокСимволов.Добавить("|");
	
	СписокСимволов.Добавить(".");
	СписокСимволов.Добавить(",");
	//СписокСимволов.Добавить("-");
	
	СписокСимволов.Добавить("а");
	СписокСимволов.Добавить("б");
	СписокСимволов.Добавить("в");
	СписокСимволов.Добавить("г");
	СписокСимволов.Добавить("д");
	СписокСимволов.Добавить("е");
	СписокСимволов.Добавить("ё");
	СписокСимволов.Добавить("ж");
	СписокСимволов.Добавить("з");
	СписокСимволов.Добавить("и");
	СписокСимволов.Добавить("й");
	СписокСимволов.Добавить("к");
	СписокСимволов.Добавить("л");
	СписокСимволов.Добавить("м");
	СписокСимволов.Добавить("н");
	СписокСимволов.Добавить("о");
	СписокСимволов.Добавить("п");
	СписокСимволов.Добавить("р");
	СписокСимволов.Добавить("с");
	СписокСимволов.Добавить("т");
	СписокСимволов.Добавить("у");
	СписокСимволов.Добавить("ф");
	СписокСимволов.Добавить("х");
	СписокСимволов.Добавить("ц");
	СписокСимволов.Добавить("ч");
	СписокСимволов.Добавить("ш");
	СписокСимволов.Добавить("щ");
	СписокСимволов.Добавить("ъ");
	СписокСимволов.Добавить("ы");
	СписокСимволов.Добавить("ь");
	СписокСимволов.Добавить("э");
	СписокСимволов.Добавить("ю");
	СписокСимволов.Добавить("я");
	
	СписокСимволов.Добавить("А");
	СписокСимволов.Добавить("Б");
	СписокСимволов.Добавить("В");
	СписокСимволов.Добавить("Г");
	СписокСимволов.Добавить("Д");
	СписокСимволов.Добавить("Е");
	СписокСимволов.Добавить("Ё");
	СписокСимволов.Добавить("Ж");
	СписокСимволов.Добавить("З");
	СписокСимволов.Добавить("И");
	СписокСимволов.Добавить("Й");
	СписокСимволов.Добавить("К");
	СписокСимволов.Добавить("Л");
	СписокСимволов.Добавить("М");
	СписокСимволов.Добавить("Н");
	СписокСимволов.Добавить("О");
	СписокСимволов.Добавить("П");
	СписокСимволов.Добавить("Р");
	СписокСимволов.Добавить("С");
	СписокСимволов.Добавить("Т");
	СписокСимволов.Добавить("У");
	СписокСимволов.Добавить("Ф");
	СписокСимволов.Добавить("Х");
	СписокСимволов.Добавить("Ц");
	СписокСимволов.Добавить("Ч");
	СписокСимволов.Добавить("Щ");
	СписокСимволов.Добавить("Щ");
	СписокСимволов.Добавить("Ъ");
	СписокСимволов.Добавить("Ы");
	СписокСимволов.Добавить("Ь");
	СписокСимволов.Добавить("Э");
	СписокСимволов.Добавить("Ю");
	СписокСимволов.Добавить("Я");
	
	Возврат СписокСимволов;
	
КонецФункции

Функция СформироватьИмяФайлаEDI(Знач СтрокаИмяФайла) 
	
	ИтоговоеИмяФайла = СокрЛП(СтрокаИмяФайла);
	
	Если ПустаяСтрока(ИтоговоеИмяФайла) Тогда
		
		Возврат ИтоговоеИмяФайла;
		
	КонецЕсли;
	
	СписокСимволов = ПолучитьСписокЗапрещенныхСимволовВИменахФайловEDI();
	
	Для Каждого СтрокаЗапретногоСимвола  Из СписокСимволов Цикл
		
		ИтоговоеИмяФайла = СтрЗаменить(ИтоговоеИмяФайла,  СтрокаЗапретногоСимвола.Значение, "");			
		
	КонецЦикла;
	
	Возврат ИтоговоеИмяФайла;
	
КонецФункции

Функция ВыгрузитьСообщениеEDI(СообщениеEDI) Экспорт
	
	// Получим файл выгрузки данных
	Запись = Новый ЗаписьXML;
	
	ИмяФайлаВыгрузки = КаталогВременныхФайлов() + СообщениеEDI.ЗаголовокФайла;
	
	Запись.ОткрытьФайл(ИмяФайлаВыгрузки);
	Запись.ЗаписатьБезОбработки(СообщениеEDI.ТекстСообщенияXML);
	Запись.Закрыть();
	
	// Для КОРУСа необходимо перекодировать
    //{Лео Катанович
    Если  СообщениеEDI.НастройкаОбмена = Справочники.абс_НастройкиEDIОбмена.НайтиПоНаименованию("КОРУС") Тогда 
		НовыйФайл = Новый ТекстовыйДокумент();	

		НовыйФайл.ВставитьСтроку(1,СообщениеEDI.ТекстСообщенияXML);
		НовыйФайл.Записать(ИмяФайлаВыгрузки,КодировкаТекста.ANSI);
	КонецЕсли;
	//Лео Катанович}
	
	//Изменить кодировку для EDI электронной счет фактуры
	//+Лео Сафонов ЕА
    Если (СообщениеEDI.НастройкаОбмена =  Справочники.абс_НастройкиEDIОбмена.edi_su ИЛИ СообщениеEDI.НастройкаОбмена = Справочники.абс_НастройкиEDIОбмена.НайтиПоНаименованию("Контур")) и 
		(СообщениеEDI.ТипСообщения = Перечисления.абс_ТипыСообщенийEDI.СчетФактура или
		СообщениеEDI.ТипСообщения = Перечисления.абс_ТипыСообщенийEDI.КорректировочныйСчетФактура ИЛИ
		СообщениеEDI.ТипСообщения = Перечисления.абс_ТипыСообщенийEDI.УПД ИЛИ
		СообщениеEDI.ТипСообщения = Перечисления.абс_ТипыСообщенийEDI.Торг12) Тогда 
		НовыйФайл = Новый ТекстовыйДокумент();	

		НовыйФайл.ВставитьСтроку(1,СообщениеEDI.ТекстСообщенияXML);
		НовыйФайл.Записать(ИмяФайлаВыгрузки,"windows-1251");
	КонецЕсли;
	//+Лео Сафонов ЕА
	

	// Выгрузим файл
	НастройкаВыгрузки = СообщениеEDI.НастройкаОбмена;
	
	Если НастройкаВыгрузки.ТипНастройки = Перечисления.абс_ТипыОбменаEDI.ОбменЧерезФайловыйРесурс Тогда
		
		КаталогВыгрузки = НастройкаВыгрузки.КаталогОбменаИнформацией + "\" + НастройкаВыгрузки.Исходящие + "\";
		
		Каталог = Новый Файл(КаталогВыгрузки);
		
		Если НЕ Каталог.Существует() Тогда
			ОбщегоНазначения.СообщитьОбОшибке("Ошибка при выгрузке " + СообщениеEDI + ". Каталог выгрузки данных: " + КаталогВыгрузки + " не существует!");
			Возврат Ложь;
		КонецЕсли;
		
		КопироватьФайл(ИмяФайлаВыгрузки, КаталогВыгрузки + СообщениеEDI.ЗаголовокФайла);
		
	ИначеЕсли НастройкаВыгрузки.ТипНастройки = Перечисления.абс_ТипыОбменаEDI.ОбменЧерезFTPРесурс Тогда
		
		ИмяFTPСервера = ""; ИмяКаталогаСервера = ""; ДанныеПротокола = "";
		
		ПолучитьИмяСервераИИмяКаталогаОбмена(СообщениеEDI.НастройкаОбмена.FTPАдресОбмена, ИмяFTPСервера, ИмяКаталогаСервера);
		
		Соединение = ВыполнитьFTPПодключениеКСерверу(ИмяFTPСервера, НастройкаВыгрузки, ДанныеПротокола, Истина, Неопределено);
		
		Если Соединение = Неопределено Тогда
			ОбщегоНазначения.СообщитьОбОшибке("Ошибка при выгрузке " + СообщениеEDI + ". Не удалось подключиться к ftp серверу: " + ИмяFTPСервера);
			Возврат Ложь;
		КонецЕсли;
		
		НаличиеКаталога = ПроверитьНаличиеКаталогаНаFTPСервере(Соединение, НастройкаВыгрузки.Исходящие, ДанныеПротокола, Истина, Неопределено);
		
		Если Не НаличиеКаталога Тогда
			ОбщегоНазначения.СообщитьОбОшибке("Ошибка при выгрузке " + СообщениеEDI + ". Каталог выгрузки данных: " + НастройкаВыгрузки.Исходящие + " на ftp сервере: " + ИмяFTPСервера + " не существует!");
			Возврат Ложь;
		КонецЕсли;	
		
		Соединение.Записать(ИмяФайлаВыгрузки, "/" + НастройкаВыгрузки.Исходящие + "/" + СообщениеEDI.ЗаголовокФайла);
		
	КонецЕсли;
	
	// Удалим временный файл
	УдалитьФайлы(ИмяФайлаВыгрузки);
	
	Возврат Истина;
	
КонецФункции

//Процедура формирует документ СообщениеEDI на основании переданных параметров
Процедура СформироватьСообщениеEDI(Параметры, ЕстьОшибки = Ложь)
	
	СобщениеEDI = Документы.абс_СообщениеEDI.СоздатьДокумент();
	
	СобщениеEDI.Дата 			= ТекущаяДата();
	
	ЗаполнитьЗначенияСвойств(СобщениеEDI, Параметры);
	
	СобщениеEDI.Записать();
	
	ЕстьОшибки = НЕ ВыгрузитьСообщениеEDI(СобщениеEDI);
	
КонецПроцедуры

//Процедура формирует Текст XML для последующего формирования документа СообщениеEDI
Процедура ВыгрузитьУведомлениеОбОтгрузке(ДокументОтгрузки, ЕстьОшибки = Ложь) Экспорт
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	РеализацияТоваровУслугТовары.Цена КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	МАКСИМУМ(ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13)) КАК ТипШтрихКода,
	|	МАКСИМУМ(ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)) КАК СерияНоменклатуры,
	|	МАКСИМУМ(ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) КАК ХарактеристикаНоменклатуры,
	|	МАКСИМУМ(ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя)) КАК Свойство,
	|	СУММА(РеализацияТоваровУслугТовары.КоличествоМест) КАК КоличествоМест,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК ЦенаБезНДС,
	|	РеализацияТоваровУслугТовары.Ссылка.ТипЦен.ЦенаВключаетНДС КАК ЦенаВключаетНДС,
	|	РеализацияТоваровУслугТовары.НомерСтроки,
	|	РеализацияТоваровУслугТовары.СтавкаНДС
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.Цена,
	|	РеализацияТоваровУслугТовары.Ссылка.ТипЦен.ЦенаВключаетНДС,
	|	РеализацияТоваровУслугТовары.НомерСтроки,
	|	РеализацияТоваровУслугТовары.СтавкаНДС
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомления,
	|	Накладная.Ссылка.абс_ДатаУведомленияОбОтгрузке КАК ДатаУведомления,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI КАК НомерЗаказа,
	|	ВЫБОР
	|		КОГДА Накладная.Ссылка.Сделка.ДокументОснование ССЫЛКА Документ.абс_СообщениеEDI
	|			ТОГДА Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI
	|		ИНАЧЕ Накладная.Ссылка.Сделка.Дата
	|	КОНЕЦ КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа, """") КАК НомерДокументаEDIЗаказа,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
	|	Накладная.Ссылка.ДоговорКонтрагента.Номер КАК НомерДоговора,
	|	Накладная.Ссылка.ДоговорКонтрагента.Дата КАК ДатаДоговора,
	|	ЕСТЬNULL(Накладная.Ссылка.абс_Водитель.Наименование, """") КАК Водитель,
	|	ЕСТЬNULL(Накладная.Ссылка.абс_ТранспортноеСредство.Марка, """") КАК МаркаТС,
	|	ЕСТЬNULL(Накладная.Ссылка.абс_ТранспортноеСредство.ГосНомер, """") КАК ГосНомерТС,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ВсегоКоличествоКоробов, Накладная.Ссылка.абс_КоличествоТранспортныхКоробов) КАК КоличествоКоробов,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ВсегоКоличествоПалет, Накладная.Ссылка.абс_КоличествоПаллет) КАК КоличествоПаллет,
	|	ВЫБОР
	|		КОГДА Накладная.Ссылка.Сделка.Лео_ПодтвержденнаяДатаДоставки = &ПустаяДата
	|			ТОГДА ВЫБОР
	|					КОГДА Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ = &ПустаяДата
	|						ТОГДА Накладная.Ссылка.Сделка.ДатаОтгрузки
	|					ИНАЧЕ Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ
	|				КОНЕЦ
	|		ИНАЧЕ Накладная.Ссылка.Сделка.Лео_ПодтвержденнаяДатаДоставки
	|	КОНЕЦ КАК ДатаДоставки,
	|	Накладная.Ссылка,
	|	СУММА(Накладная.КоличествоМест) КАК КоличествоМест,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	Накладная.ЦенаВключаетНДС
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Ссылка.Номер,
	|	Накладная.Ссылка.Дата,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.абс_ДатаУведомленияОбОтгрузке,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI,
	|	Накладная.Ссылка.Организация.абс_GLN,
	|	Накладная.Ссылка.Контрагент.абс_GLN,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
	|	Накладная.Ссылка.ДоговорКонтрагента.Номер,
	|	Накладная.Ссылка.ДоговорКонтрагента.Дата,
	|	Накладная.Ссылка,
	|	Накладная.Ссылка.Контрагент,
	|	Накладная.ЦенаВключаетНДС,
	|	ВЫБОР
	|		КОГДА Накладная.Ссылка.Сделка.ДокументОснование ССЫЛКА Документ.абс_СообщениеEDI
	|			ТОГДА Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI
	|		ИНАЧЕ Накладная.Ссылка.Сделка.Дата
	|	КОНЕЦ,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа, """"),
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)),
	|	ЕСТЬNULL(Накладная.Ссылка.абс_Водитель.Наименование, """"),
	|	ЕСТЬNULL(Накладная.Ссылка.абс_ТранспортноеСредство.Марка, """"),
	|	ЕСТЬNULL(Накладная.Ссылка.абс_ТранспортноеСредство.ГосНомер, """"),
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ВсегоКоличествоКоробов, Накладная.Ссылка.абс_КоличествоТранспортныхКоробов),
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ВсегоКоличествоПалет, Накладная.Ссылка.абс_КоличествоПаллет),
	|	ВЫБОР
	|		КОГДА Накладная.Ссылка.Сделка.Лео_ПодтвержденнаяДатаДоставки = &ПустаяДата
	|			ТОГДА ВЫБОР
	|					КОГДА Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ = &ПустаяДата
	|						ТОГДА Накладная.Ссылка.Сделка.ДатаОтгрузки
	|					ИНАЧЕ Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ
	|				КОНЕЦ
	|		ИНАЧЕ Накладная.Ссылка.Сделка.Лео_ПодтвержденнаяДатаДоставки
	|	КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЕСТЬNULL(Штрихкоды.Штрихкод, 0) КАК Штрихкод,
	|	ЕСТЬNULL(абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства, """") КАК АртикулПокупателя,
	|	ЕСТЬNULL(ЗаказыПокупателейОбороты.КоличествоПриход, 0) КАК КоличествоЗаказано,
	|	ЕСТЬNULL(Накладная.Количество, 0) КАК Количество,
	|	ЕСТЬNULL(Накладная.Цена, 0) КАК Цена,
	|	ЕСТЬNULL(Накладная.Номенклатура, ЗаказыПокупателейОбороты.Номенклатура) КАК Номенклатура,
	|	ВЫБОР
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|			ТОГДА 18
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|			ТОГДА 10
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|			ТОГДА 20  
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|			ТОГДА 5
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС,
	|	ЕСТЬNULL(Накладная.ЕдиницаИзмерения.Наименование, """") КАК ЕдиницаИзмерения,
	|	Накладная.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	Накладная.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|			И (Штрихкоды.СерияНоменклатуры = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗаказыПокупателей.Обороты(&НачалоПериода, &КонецПериода, , ЗаказПокупателя = &ЗаказПокупателя) КАК ЗаказыПокупателейОбороты
	|		ПО Накладная.Номенклатура = ЗаказыПокупателейОбороты.Номенклатура
	|			И Накладная.ЕдиницаИзмерения = ЗаказыПокупателейОбороты.ЕдиницаИзмерения
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки");
	
	Запрос.УстановитьПараметр("Ссылка"			, ДокументОтгрузки);
	Запрос.УстановитьПараметр("ЗаказПокупателя"	, ДокументОтгрузки.Сделка);
	Запрос.УстановитьПараметр("НачалоПериода"	, ДокументОтгрузки.Сделка.Дата);
	Запрос.УстановитьПараметр("КонецПериода"	, ДокументОтгрузки.Сделка.Дата);
	Запрос.УстановитьПараметр("ПустаяДата"		, '00010101000000');
	
	Отказ = Ложь;
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();
	
	НомерНакладной = ОбщегоНазначения.ПолучитьНомерНаПечать(ВыборкаДокумент.Ссылка);
	
	ИмяФайла = СформироватьИмяФайлаEDI("DESADV_" + Формат(ВыборкаДокумент.ДатаЗаказа,"ДФ=ггггММдд") + "_" + СокрЛП(ВыборкаДокумент.НомерЗаказа)) + ".xml";
	Запись=Новый ЗаписьXML;
	Запись.УстановитьСтроку("UTF-8");
	Запись.ЗаписатьОбъявлениеXML();
	
	Запись.ЗаписатьНачалоЭлемента("DESADV");
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.НомерУведомления)					, "NUMBER");				//номер уведомления об отгрузке
	ЗаписатьXML(Запись, Формат(ВыборкаДокумент.Дата,"ДФ=гггг-ММ-дд")				, "DATE"); 					//дата документа
	ЗаписатьXML(Запись, "351"														, "DOCACTION");
	ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ДатаДоставки,"ДФ=гггг-ММ-дд")	 	, "DELIVERYDATE"); 			//дата поставки
	//{Лео Катанович // 25.02.2019 закомментировано по запросу Глуховой С.Л.
	//ЗаписатьXML(Запись, "12:00"													    , "DELIVERYTIME"); 			//время поставки
	//Лео Катанович}
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.НомерЗаказа)							, "ORDERNUMBER"); 			//номер заказа
	ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ДатаЗаказа,"ДФ=гггг-ММ-дд")			, "ORDERDATE"); 			//дата заказа
	ЗаписатьXML(Запись, СокрЛП(НомерНакладной)										, "DELIVERYNOTENUMBER"); 	//номер накладной
	ЗаписатьXML(Запись, Формат(ВыборкаДокумент.Дата, "ДФ=гггг-ММ-дд")				, "DELIVERYNOTEDATE"); 		//дата накладной
	//{Лео Катанович
	ЗаписатьXML(Запись, Формат(ВыборкаДокумент.Номер, "ДФ=гггг-ММ-дд")		        , "SUPPLIERORDERNUMBER"); 	//номер заказа в системе поставщика
	ЗаписатьXML(Запись, Формат(ТекущаяДата(), "ДФ=гггг-ММ-дд")				        , "SUPPLIERORDERDATE"); 	//дата уведомления об отгрузке
	ЗаписатьXML(Запись, Строка(ВыборкаДокумент.КоличествоМест)				  	    , "TOTALPACKAGES"); 		//общее количество упаковок
	//Лео Катанович}
	
	//{Лео Катанович  25.01.2019 не прередаем информацио о водителях в Тандер
	Если ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") Тогда //Тандер
		ЗаписатьXML(Запись, ""						          , "TRANSPORTTYPE"); 		      //тип транспортировки
		ЗаписатьXML(Запись, ""						          , "TRANSPORTERTYPE"); 	      //тип транспортного средства
		ЗаписатьXML(Запись, ""						          , "TRANSPORTID"); 		      //SHIPMENTS
		ЗаписатьXML(Запись, ""						          , "TRANSPORTMARK"); 		      //TRANSPORTMARK
		ЗаписатьXML(Запись, ""						          , "TRANSPORTERNAME"); 	      //TRANSPORTERNAME
	Иначе 
		ЗаписатьXML(Запись, "30"							  , "TRANSPORTTYPE"); 		      //тип транспортировки
		ЗаписатьXML(Запись, "31"							  , "TRANSPORTERTYPE"); 	      //тип транспортного средства
		ЗаписатьXML(Запись, ВыборкаДокумент.ГосНомерТС		  , "TRANSPORTID"); 		      //SHIPMENTS
		ЗаписатьXML(Запись, ВыборкаДокумент.МаркаТС			  , "TRANSPORTMARK"); 		      //TRANSPORTMARK
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.Водитель)  , "TRANSPORTERNAME"); 	      //TRANSPORTERNAME
	КонецЕсли;
	//Лео Катанович}

	ЗаписатьXML(Запись, Формат(ВыборкаДокумент.КоличествоПаллет, "ЧЦ=5; ЧН=0; ЧГ=0"), "SHIPMENTS"); 			//SHIPMENTS
    ЗаписатьXML(Запись, ВыборкаДокумент.НомерДоговора								, "CAMPAIGNNUMBER"); 		//CAMPAIGNNUMBER
	//{Лео Катанович
	//Для частичной отгрузки
	//проверка наличия с/ф , к которому относится корректировочный СФ
	СписокВидовСчетовФактур = Новый СписокЗначений;
	СписокВидовСчетовФактур.Добавить(Перечисления.ВидСчетаФактурыВыставленного.НаРеализацию);
	
	ОтборСчетовФактур = Новый Структура();
	ОтборСчетовФактур.Вставить("ВидСчетаФактуры", СписокВидовСчетовФактур);
	ОтборСчетовФактур.Вставить("ПометкаУдаления", Ложь);
	
	ВыборкаДокументСФ = (УчетНДС.НайтиПодчиненныйСчетФактуру(ВыборкаДокумент.Ссылка, "СчетФактураВыданный", ОтборСчетовФактур));
	
	Если ЗначениеЗаполнено(ВыборкаДокументСФ) Тогда
		 ЗаписатьXML(Запись, СокрЛП(ВыборкаДокументСФ.Номер)							, "UPDNUMBER"); 			//Номер УПД
	     ЗаписатьXML(Запись, Формат(ВыборкаДокументСФ.Дата, "ДФ=гггг-ММ-дд")			, "UPDDATE"); 			    //Дата УПД
	КонецЕсли;
	//Лео Катанович}
	Запись.ЗаписатьНачалоЭлемента("HEAD");
	
	ГрузополучательЯвляетсяПлательщиком = абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ДокументОтгрузки.Сделка.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.абс_ГрузополучательЯвляетсяПлательщиком);
	
	GLNПокупателя = ВыборкаДокумент.GLNКонтрагента;
		
	//+Лео Сафонов ЕА Хардкод. Исключение из общих правил GLN для Билла и Гиперглобус
	Если ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") Тогда ////////////////////////////////////////////////Билла
		// {Лео Катанович
		//ЗаписатьXML(Запись, ВыборкаДокумент.GLNОрганизации				, "SENDER"); 			//GLN отправителя сообщения
		//ЗаписатьXML(Запись, ВыборкаДокумент.GLNОрганизации				, "SUPPLIER"); 			//GLN поставщика
		
		ЗаписатьXML(Запись, "4607932679999"					, "SENDER"); 			//GLN отправителя сообщения
		ЗаписатьXML(Запись, "4607932679999"	  			    , "SUPPLIER"); 			//GLN поставщика
		
		// Лео Катанович}
		ЗаписатьXML(Запись, GLNПокупателя								, "BUYER"); 			//GLN покупателя	
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "DELIVERYPLACE"); 	//GLN места доставки
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "RECIPIENT"); 		//GLN получателя сообщения	
	ИначеЕсли ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000288") Тогда ///////////////////////////////////////////Гиперглобус
		ЗаписатьXML(Запись, "4607932679999"								, "SENDER"); 			//GLN отправителя сообщения
		ЗаписатьXML(Запись, "4607932679999"								, "SUPPLIER"); 			//GLN поставщика
		ЗаписатьXML(Запись, GLNПокупателя								, "BUYER"); 			//GLN покупателя	
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "DELIVERYPLACE"); 	//GLN места доставки
		ЗаписатьXML(Запись, "4690202000005"								, "RECIPIENT"); 		//GLN получателя сообщения	
		// {Лео Катанович

	ИначеЕсли ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		      ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
			  ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
			  ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
			  ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
			  ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		      ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
			  ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
		
		ЗаписатьXML(Запись, "4607932679999"				                , "SENDER"); 			//GLN отправителя сообщения
		ЗаписатьXML(Запись, "4607932679999"				                , "SUPPLIER"); 			//GLN поставщика
		ЗаписатьXML(Запись, GLNПокупателя								, "BUYER"); 			//GLN покупателя	
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "DELIVERYPLACE"); 	//GLN места доставки
		ЗаписатьXML(Запись, GLNПокупателя							 	, "RECIPIENT"); 		//GLN получателя сообщения	
       	// Лео Катанович}
	Иначе 
		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////Общие правила
		ЗаписатьXML(Запись, ВыборкаДокумент.GLNОрганизации				, "SENDER"); 			//GLN отправителя сообщения
		ЗаписатьXML(Запись, ВыборкаДокумент.GLNОрганизации				, "SUPPLIER"); 			//GLN поставщика
		ЗаписатьXML(Запись, GLNПокупателя								, "BUYER"); 			//GLN покупателя	
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "DELIVERYPLACE"); 	//GLN места доставки
		ЗаписатьXML(Запись, GLNПокупателя							 	, "RECIPIENT"); 		//GLN получателя сообщения	
	КонецЕсли;
	//-Лео Сафонов ЕА Хардкод. Исключение из общих правил GLN для Билла и Гиперглобус

		
	ЗаписатьXML(Запись, ВыборкаДокумент.НомерУведомления		, "EDIINTERCHANGEID"); 	//номер транзакции
	
	Запись.ЗаписатьНачалоЭлемента("PACKINGSEQUENCE");
	ЗаписатьXML(Запись,1,"HIERARCHICALID"); //номер иерархии упаковки
	
	ВыборкаСтрока = Результат[2].Выбрать();
	сч=1;
	Пока ВыборкаСтрока.Следующий() Цикл
		
		Попытка
			ШтрихкодДляВыгрузки = Число(СокрЛП(ВыборкаСтрока.Штрихкод));
		Исключение
			ОбщегоНазначения.СообщитьОбОшибке("В номенклатуре: " + ВыборкаСтрока.Номенклатура + ", артикул: " + ВыборкаСтрока.Номенклатура.Артикул + " ошибка преобразования штрихкода в число: " + ВыборкаСтрока.Штрихкод, Отказ);
		КонецПопытки;		
		
		Запись.ЗаписатьНачалоЭлемента("POSITION");
		
		ЗаписатьXML(Запись, сч										        , "POSITIONNUMBER"); 	//номер товарной позици
		ЗаписатьXML(Запись, ШтрихкодДляВыгрузки						        , "PRODUCT"); 			//Штрихкод продукта
		//{Лео Катанович
		ЗаписатьXML(Запись, СокрЛП(ВыборкаСтрока.Номенклатура.Артикул)      , "PRODUCTSUPPLIER"); 	//внутренний номер в БД поставщика
        //Лео Катанович}
		Если ЗначениеЗаполнено(ВыборкаСтрока.АртикулПокупателя) Тогда
			ЗаписатьXML(Запись, ВыборкаСтрока.АртикулПокупателя		        , "PRODUCTIDBUYER"); 	//внутренний номер в БД покупателя
		КонецЕсли;
		ЗаписатьXML(Запись, ВыборкаСтрока.Количество				        , "DELIVEREDQUANTITY"); //поставляемое количество
		//{Лео Катанович
		
		Если  ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
			ЗаписатьXML(Запись, "PCE"			        , "DELIVEREDUNIT");     //единица измерения
		Иначе
			ЗаписатьXML(Запись, ВыборкаСтрока.ЕдиницаИзмерения			        , "DELIVEREDUNIT");     //единица измерения
		КонецЕсли;	     
		ЗаписатьXML(Запись, ВыборкаСтрока.КоличествоЗаказано		        , "ORDEREDQUANTITY"); 	//Заказанное количество
		Если  ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
			ЗаписатьXML(Запись, "PCE"			        , "ORDERUNIT");         //единицы
		Иначе
			ЗаписатьXML(Запись, ВыборкаСтрока.ЕдиницаИзмерения			        , "ORDERUNIT");         //единицы
		КонецЕсли;	     
		//Лео Катанович}
		
		// {Лео Катанович  // 15.09.2017 Для контрагента "Новый Импульс" ()
		Если СОКРЛП(ДокументОтгрузки.Контрагент.абс_GLN) = "4607038379991" Тогда // 
			ЦенаБезСНДС = 0;
			ЦенаСНДС = 0;
			
			Если НЕ ВыборкаДокумент.ЦенаВключаетНДС Тогда
				ЦенаБезСНДС = ВыборкаСтрока.Цена;
				ЦенаСНДС = (ВыборкаСтрока.Цена * (100 + ВыборкаСтрока.СтавкаНДС)) / 100;
			Иначе
				ЦенаБезСНДС = ОКР((ВыборкаСтрока.Цена * 100) / (100 + ВыборкаСтрока.СтавкаНДС));
				ЦенаСНДС =  ВыборкаСтрока.Цена;
			КонецЕсли;	  
			ЗаписатьXML(Запись, ЦенаБезСНДС		, "PRICE"); 	   		//Цена продукта
			ЗаписатьXML(Запись, ЦенаСНДС        , "PRICEWITHVAT"); 		//Цена продукта c НДС	
			
		Иначе
			Если ВыборкаСтрока.СуммаВключаетНДС Тогда 
				ЗаписатьXML(Запись, ВыборкаСтрока.Цена							, "PRICEWITHVAT"); 		//Цена продукта c НДС		
			Иначе
				ЗаписатьXML(Запись, ВыборкаСтрока.Цена							, "PRICE"); 	   		//Цена продукта
			КонецЕсли; 	
		КонецЕсли;
		// Лео Катанович}
		
		ЗаписатьXML(Запись, ВыборкаСтрока.СтавкаНДС					        , "TAXRATE"); 			//Ставка налога (НДС, %)
		//{Лео Катанович
		ЗаписатьXML(Запись, СОКРЛП(ВыборкаСтрока.Номенклатура.Наименование) , "DESCRIPTION");       //описание продукта
		//Лео Катанович}
		
		Запись.ЗаписатьКонецЭлемента();
		
		сч = сч + 1;
		
	КонецЦикла;
	
	Если Отказ Тогда
		ЕстьОшибки = Истина;
		Возврат;
		//ВызватьИсключение "Произошли ошибки при выгрузке уведомления об отгрузке! Уведомление об отгрузке не выгружено!";
	КонецЕсли;	
	
	Запись.ЗаписатьКонецЭлемента();
	Запись.ЗаписатьКонецЭлемента();
	Запись.ЗаписатьКонецЭлемента();
	
	ТекстXML=Запись.Закрыть();
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.УведомлениеОбОтгрузке);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, СокрЛП(GLNПокупателя));
	СтруктураПараметров.Вставить("GLNГрузополучателя"		, СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
	
	//{Лео Катанович
	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО

		 СтруктураПараметров.Вставить("GLNПоставщика"			, "4607932679999");
	  Иначе
	     СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	КонецЕсли;   
    //	Лео Катанович}
	
	// << Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
	Если ДокументОтгрузки.Организация.Код = "О00000001" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su);
	ИначеЕсли ДокументОтгрузки.Организация.Код = "О00000003" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit);
	КонецЕсли;
	// >> Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерДокументаEDIЗаказа);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаДокументаEDI);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры

//Процедура формирует Текст XML для последующего формирования документа СообщениеEDI
Процедура ВыгрузитьСчетФактуруINVOICE(ДокументОтгрузки, ЕстьОшибки) Экспорт
	//проверка наличия с/ф
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	Иначе
		Выборка 	= Результат.Выбрать();
		Выборка.Следующий();
		
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
	КонецЕсли;
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ОтветственныеЛицаОрганизацийСрезПоследних.ФизическоеЛицо
		|ИЗ
		|	РегистрСведений.ОтветственныеЛицаОрганизаций.СрезПоследних(&Дата, ) КАК ОтветственныеЛицаОрганизацийСрезПоследних
		|ГДЕ
		|	ОтветственныеЛицаОрганизацийСрезПоследних.СтруктурнаяЕдиница = &Организация
		|	И ОтветственныеЛицаОрганизацийСрезПоследних.ОтветственноеЛицо = &ОтветственноеЛицо";

	Запрос.УстановитьПараметр("Дата", ДокументОтгрузки.Дата);
	Запрос.УстановитьПараметр("Организация", ДокументОтгрузки.Организация);
	Запрос.УстановитьПараметр("ОтветственноеЛицо", Перечисления.ОтветственныеЛицаОрганизаций.ГлавныйБухгалтер);

	Результат = Запрос.Выполнить();

	ВыборкаДетальныеЗаписи = Результат.Выбрать();

	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		ГлавныйБухгалтер = ВыборкаДетальныеЗаписи.ФизическоеЛицо;
	КонецЦикла;

	
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	РеализацияТоваровУслугТовары.Сумма,
	|	РеализацияТоваровУслугТовары.СуммаНДС,
	|	РеализацияТоваровУслугТовары.СтавкаНДС
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	РеализацияТоваровУслугТовары.Сумма,
	|	РеализацияТоваровУслугТовары.СуммаНДС,
	|	РеализацияТоваровУслугТовары.СтавкаНДС
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомления,
	|	Накладная.Ссылка.абс_ДатаУведомленияОбОтгрузке КАК ДатаУведомления,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI КАК НомерЗаказа,
	|	ВЫБОР
	|		КОГДА Накладная.Ссылка.Сделка.ДокументОснование ССЫЛКА Документ.абс_СообщениеEDI
	|			ТОГДА Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI
	|		ИНАЧЕ Накладная.Ссылка.Сделка.Дата
	|	КОНЕЦ КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа, """") КАК НомерДокументаEDIЗаказа,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
	|	Накладная.Ссылка.ДоговорКонтрагента.Номер КАК НомерДоговора,
	|	Накладная.Ссылка.ДоговорКонтрагента.Дата КАК ДатаДоговора,
	|	ЕСТЬNULL(Накладная.Ссылка.абс_Водитель.Наименование, """") КАК Водитель,
	|	ЕСТЬNULL(Накладная.Ссылка.абс_ТранспортноеСредство.Марка, """") КАК МаркаТС,
	|	ЕСТЬNULL(Накладная.Ссылка.абс_ТранспортноеСредство.ГосНомер, """") КАК ГосНомерТС,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ВсегоКоличествоКоробов, Накладная.Ссылка.абс_КоличествоТранспортныхКоробов) КАК КоличествоКоробов,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ВсегоКоличествоПалет, Накладная.Ссылка.абс_КоличествоПаллет) КАК КоличествоПаллет,
	|	ВЫБОР
	|		КОГДА Накладная.Ссылка.Сделка.Лео_ПодтвержденнаяДатаДоставки = &ПустаяДата
	|			ТОГДА ВЫБОР
	|					КОГДА Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ = &ПустаяДата
	|						ТОГДА Накладная.Ссылка.Сделка.ДатаОтгрузки
	|					ИНАЧЕ Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ
	|				КОНЕЦ
	|		ИНАЧЕ Накладная.Ссылка.Сделка.Лео_ПодтвержденнаяДатаДоставки
	|	КОНЕЦ КАК ДатаДоставки,
	|	Накладная.Ссылка,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	Накладная.Ссылка.Организация КАК Организация,
	|	Накладная.Ссылка.Грузоотправитель.абс_GLN КАК GLNГрузоотправителя,
	|	Накладная.Ссылка.абс_НомерУведомленияОПриемке КАК НомерУведомленияОПриемке,
	|	Накладная.Ссылка.абс_СообщениеEDI.ДатаДокументаEDI КАК ДатаУведомленияОПриемке,
	|	Накладная.Ссылка.абс_СуммаБезНДС КАК СуммаБезНДС,
	|	Накладная.Ссылка.абс_СуммаСНДС КАК СуммаСНДС,
	|	Накладная.Ссылка.абс_СуммаСНДС - Накладная.Ссылка.абс_СуммаБезНДС КАК СуммаНДС,
	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	ЕСТЬNULL(абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства, """") КАК АртикулПокупателя,
	|	ЕСТЬNULL(ЗаказыПокупателейОбороты.КоличествоПриход, 0) КАК КоличествоЗаказано,
	|	ЕСТЬNULL(Накладная.Количество, 0) КАК Количество,
	|	ЕСТЬNULL(Накладная.Цена, 0) КАК Цена,
	|	ЕСТЬNULL(Накладная.Номенклатура, ЗаказыПокупателейОбороты.Номенклатура) КАК Номенклатура,
	|	ВЫБОР
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|			ТОГДА 18
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|			ТОГДА 10
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|			ТОГДА 20 
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|			ТОГДА 5
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС,
	|	Накладная.Сумма,
	|	Накладная.СуммаНДС,
	|	Накладная.Номенклатура.Артикул КАК Артикул,
	|	Накладная.ЕдиницаИзмерения,
	|	Накладная.Сумма + Накладная.СуммаНДС КАК СуммаСНДС
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|			И (Штрихкоды.СерияНоменклатуры = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗаказыПокупателей.Обороты(&НачалоПериода, &КонецПериода, , ЗаказПокупателя = &ЗаказПокупателя) КАК ЗаказыПокупателейОбороты
	|		ПО Накладная.Номенклатура = ЗаказыПокупателейОбороты.Номенклатура
	|			И Накладная.ЕдиницаИзмерения = ЗаказыПокупателейОбороты.ЕдиницаИзмерения
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	ЕСТЬNULL(Накладная.Номенклатура, ЗаказыПокупателейОбороты.Номенклатура),
	|	ЕСТЬNULL(Накладная.Цена, 0),
	|	ЕСТЬNULL(абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства, """"),
	|	ЕСТЬNULL(Накладная.Количество, 0),
	|	Накладная.Сумма,
	|	Накладная.СуммаНДС,
	|	ЕСТЬNULL(ЗаказыПокупателейОбороты.КоличествоПриход, 0),
	|	Накладная.Номенклатура.Артикул,
	|	Накладная.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|			ТОГДА 18
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|			ТОГДА 10
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|			ТОГДА 20
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|			ТОГДА 5
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ";
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	Запрос.УстановитьПараметр("ЗаказПокупателя"	, ДокументОтгрузки.Сделка);
	Запрос.УстановитьПараметр("НачалоПериода"	, ДокументОтгрузки.Сделка.Дата);
	Запрос.УстановитьПараметр("КонецПериода"	, ДокументОтгрузки.Сделка.Дата);
	Запрос.УстановитьПараметр("ПустаяДата"		, '00010101000000');
	

	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();
	
	ИмяФайла = СформироватьИмяФайлаEDI("invoce_" + Формат(ДатаСФ,"ДФ=ггггММддччмм")+"_"+СокрЛП(НомерСФ)) + ".xml";
	
	Запись = Новый ЗаписьXML;
	Запись.УстановитьСтроку("UTF-8");
	Запись.ЗаписатьОбъявлениеXML();
	
	Запись.ЗаписатьНачалоЭлемента("INVOICE");
	
	ЗаписатьXML(Запись, 380										, "DOCUMENTNAME"); 		// название документа 380 - счет
	ЗаписатьXML(Запись, СокрЛП(НомерСФ)							, "NUMBER");			//номер счета
	ЗаписатьXML(Запись, Формат(ДатаСФ,"ДФ=гггг-ММ-дд")			, "DATE"); 				//дата создания счета
	ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ДатаДоставки,"ДФ=гггг-ММ-дд"), "DELIVERYDATE"); //Дата поставки
	ЗаписатьXML(Запись, "RUB"									, "CURRENCY"); 			//код валюты
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.НомерЗаказа)		, "ORDERNUMBER"); 		//номер заказа
	ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ДатаЗаказа,"ДФ=гггг-ММ-дд"), "ORDERDATE");  		//Дата заказа
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.Номер)			, "DELIVERYNOTENUMBER");//номер накладной
	ЗаписатьXML(Запись, Формат(ВыборкаДокумент.Дата,"ДФ=гггг-ММ-дд"), "DELIVERYNOTEDATE"); 	//Дата накладной
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.НомерУведомленияОПриемке), "RECADVNUMBER"); //Номер ув. оприеме
	ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ДатаУведомленияОПриемке,"ДФ=гггг-ММ-дд"), "RECADVDATE");   //Дата ув. оприеме
	ЗаписатьXML(Запись, ВыборкаДокумент.СуммаБезНДС				, "GOODSTOTALAMOUNT"); 	// всего без НДС
	ЗаписатьXML(Запись, ВыборкаДокумент.СуммаБезНДС				, "POSITIONSAMOUNT"); 	// Всего попозициям
	ЗаписатьXML(Запись, ВыборкаДокумент.СуммаНДС				, "VATSUM"); 			// сумма НДС
	ЗаписатьXML(Запись, ВыборкаДокумент.СуммаСНДС				, "INVOICETOTALAMOUNT");//сумма по счету
	ЗаписатьXML(Запись, ВыборкаДокумент.СуммаБезНДС				, "TAXABLEAMOUNT"); 	//База налогообложения
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.ИННОрганизации)	, "FISCALNUMBER");		//инн
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.КППОрганизации)	, "REGISTRATIONNUMBER");//кпп
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.НомерДоговора)	, "CAMPAIGNNUMBER");	//Номер договорана поставку
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.Ссылка.Ответственный), "MANAGER"); 		//Имя менеджера
	ЗаписатьXML(Запись, СокрЛП(ГлавныйБухгалтер.Наименование)	, "ACCOUNTING"); 		//Имя главногобухгалтера
    ЗаписатьXML(Запись, "10", "VAT"); 													// Ставка НДС, %    - Странное поле в оглавление документа, ставка может быть 10-18%
	
	
	Запись.ЗаписатьНачалоЭлемента("HEAD");
	
	
	//{Лео Катанович
	Если ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
		 
	     ЗаписатьXML(Запись, "4607932679999"			, "SUPPLIER");                          //GLN поставщика
	Иначе
		 ЗаписатьXML(Запись, ВыборкаДокумент.GLNОрганизации			, "SUPPLIER");              //GLN поставщика
	КонецЕсли;
	//Лео Катанович}
	
	ЗаписатьXML(Запись, СтрЗаменить(ВыборкаДокумент.Организация.НаименованиеСокращенное,"""","&quot;" ), "SUPPLIERNAME"); //Имя поставщика
	
	СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);	

	Если ЗначениеЗаполнено(СтруктураАдреса.СокращеннаяСтрока) Тогда
		ЗаписатьXML(Запись, СтруктураАдреса.СокращеннаяСтрока, "SUPPLIERADRESS"); //Адрес поставщика
	КонецЕсли;
    Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
		ЗаписатьXML(Запись, СтруктураАдреса.Город, "SUPPLIERCITY"); //Город поставщика
	КонецЕсли;	
    Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
		ЗаписатьXML(Запись, Строка(СтруктураАдреса.Индекс), "SUPPLIERZIP"); //Индекс поставщика
	КонецЕсли;

	СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);						
	ЗаписатьXML(Запись, ВыборкаДокумент.GLNКонтрагента			, "BUYER"); //GLN Покупателя
	ЗаписатьXML(Запись, ВыборкаДокумент.Контрагент.НаименованиеПолное			, "BUYERNAME"); //Наименование Покупателя
	
	Если ЗначениеЗаполнено(СтруктураАдреса.СокращеннаяСтрока) Тогда
		ЗаписатьXML(Запись, СтруктураАдреса.СокращеннаяСтрока, "BUYERADRESS"); //адрес Покупателя
	КонецЕсли;
	Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
		ЗаписатьXML(Запись, СтруктураАдреса.Город, "BUYERCITY"); //Город Покупателя
	КонецЕсли;	
    Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
		ЗаписатьXML(Запись, Строка(СтруктураАдреса.Индекс), "BUYERZIP"); //Индекс Покупателя
	КонецЕсли;
	
	//{Лео Катанович 
	ЗаписатьXML(Запись, ВыборкаДокумент.Контрагент.КПП	  , "BUYERKPP"); //КПП Покупателя
	ЗаписатьXML(Запись, ВыборкаДокумент.Контрагент.ИНН	  , "BUYERINN"); //ИНН Покупателя
    //Лео Катанович}

	ЗаписатьXML(Запись, ВыборкаДокумент.GLNГрузополучателя		, "DELIVERYPLACE"); //GLN места доставки
	
    //{Лео Катанович
	Если ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО

	     ЗаписатьXML(Запись, "4607932679999"			            , "SENDER");                //GLN отправителя сообщения

	Иначе
	     ЗаписатьXML(Запись, ВыборкаДокумент.GLNОрганизации			, "SENDER"); //GLN отправителя сообщения
	КонецЕсли;
	//Лео Катанович}

	
	ЗаписатьXML(Запись, ВыборкаДокумент.GLNГрузополучателя		, "RECIPIENT"); // GLN получателя сообщения
	
	//{Лео Катанович 
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.Номер)	        , "EDIINTERCHANGEID"); //КПП Покупателя
    //Лео Катанович}
	
	ВыборкаСтрока=Результат[2].Выбрать();
	
	сч = 1;
	
	Пока ВыборкаСтрока.Следующий() Цикл
		Запись.ЗаписатьНачалоЭлемента("POSITION");
			ЗаписатьXML(Запись, сч									, "POSITIONNUMBER"); //номер товарной позици
			ЗаписатьXML(Запись, Число(СокрЛП(ВыборкаСтрока.Штрихкод)),"PRODUCT"); //Штрихкод продукта
			ЗаписатьXML(Запись, ВыборкаСтрока.Артикул				, "PRODUCTIDSUPPLIER");  //Внутренний номер в БД поставщика
			ЗаписатьXML(Запись, ВыборкаСтрока.АртикулПокупателя		, "PRODUCTIDBUYER"); //внутренний номер в БД покупателя
			ЗаписатьXML(Запись, ВыборкаСтрока.Количество			, "INVOICEDQUANTITY"); //количество по счету
			//{Лео Катанович
			//ЗаписатьXML(Запись, ВыборкаСтрока.ЕдиницаИзмерения, "INVOICEUNIT"); //единица измерения
			ЗаписатьXML(Запись, ВыборкаСтрока.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.МеждународноеСокращение, "INVOICEUNIT"); //единица измерения
			//Лео Катанович}
 			ЗаписатьXML(Запись, ВыборкаСтрока.Цена					, "UNITPRICE"); //цена без НДС
			ЗаписатьXML(Запись, Формат(ВыборкаСтрока.СуммаСНДС / ВыборкаСтрока.Количество,"ЧДЦ=2") , "GROSSPRICE"); //Цена с НДС заединицу 
			ЗаписатьXML(Запись, ВыборкаСтрока.Сумма					, "AMOUNT"); //сумма без НДС
			//{Лео Катанович
			ЗаписатьXML(Запись, "203"	 				            , "AMOUNTTYPE"); //служебное поле
            //Лео Катанович}
			ЗаписатьXML(Запись, ВыборкаСтрока.Номенклатура.НаименованиеПолное, "DESCRIPTION"); //Описание продукта
			//ЗаписатьXML(Запись, ""					, "AMOUNTTYPE"); //Служебное поле
			
			Запись.ЗаписатьНачалоЭлемента("TAX");
				//{Лео Катанович
				ЗаписатьXML(Запись,"7"							     , "FUNCTION"); // 7 -налог, 5 - там.пошлина, 6 - денежный сбор
				//Лео Катанович}
				ЗаписатьXML(Запись,"VAT"							, "TAXTYPECODE"); //Код налога (НДС)	
				ЗаписатьXML(Запись,ВыборкаСтрока.СтавкаНДС				, "TAXRATE"); //ставка НДС
				ЗаписатьXML(Запись,ВыборкаСтрока.СуммаНДС				, "TAXAMOUNT"); //суммаНДС
				ЗаписатьXML(Запись,"S"				, "CATEGORY");
				Запись.ЗаписатьКонецЭлемента();
				ЗаписатьXML(Запись, "000"					, "PRODUCTIONCODE");//Код товара

		Запись.ЗаписатьКонецЭлемента();
		
		сч = сч + 1;
		
	КонецЦикла;
	
	Запись.ЗаписатьКонецЭлемента();
	Запись.ЗаписатьКонецЭлемента();
	
	ТекстXML=Запись.Закрыть();
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.Счет);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
	
	//{Лео Катанович
	Если ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
		 
		 СтруктураПараметров.Вставить("GLNПоставщика"			,"4607932679999");
	Иначе
	     СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);

	КонецЕсли;
	//Лео Катанович}
	// << Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
	Если ДокументОтгрузки.Организация.Код = "О00000001" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su);
	ИначеЕсли ДокументОтгрузки.Организация.Код = "О00000003" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit);
	КонецЕсли;
	// >> Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерДокументаEDIЗаказа);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаДокументаEDI);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры

Процедура ВыгрузитьСчетФактуру(ДокументОтгрузки, ЕстьОшибки) Экспорт
	//проверка наличия с/ф
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	Иначе
		Выборка 	= Результат.Выбрать();
		Выборка.Следующий();
		
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
	КонецЕсли;
	
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	СУММА(ВЫБОР
	|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|				ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
	|			ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
	|		КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5	
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5	
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
	|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
	|	Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа КАК НомерДокументаEDIЗаказа,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI
	|ИЗ
	|	Накладная КАК Накладная
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Ссылка.Номер,
	|	Накладная.Ссылка.Дата,
	|	Накладная.Ссылка.Сделка.Номер,
	|	Накладная.Ссылка.Сделка.Дата,
	|	Накладная.Ссылка.Организация.абс_GLN,
	|	Накладная.Ссылка.Контрагент.абс_GLN,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
	|	Накладная.Ссылка.Организация.ИНН,
	|	Накладная.Ссылка.Организация.КПП,
	|	Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	ЗначенияСвойствОбъектов.Значение КАК АртикулПокупателя,
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СуммаНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.МеждународноеСокращение КАК ЕдиницаИзмерения,
	|	Накладная.Цена
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.СерияНоменклатуры = Штрихкоды.СерияНоменклатуры
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ПО Накладная.Номенклатура = ЗначенияСвойствОбъектов.Объект
	|			И Накладная.Свойство = ЗначенияСвойствОбъектов.Свойство
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗначенияСвойствОбъектов.Значение,
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.МеждународноеСокращение,
	|	Накладная.Цена,
	|	Накладная.СуммаНДС";
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();
	
	ИмяФайла = СформироватьИмяФайлаEDI(Формат(ДатаСФ,"ДФ=ггггММдд")+"_"+СокрЛП(НомерСФ)+"_INVOICE") + ".xml";
	
	Запись = Новый ЗаписьXML;
	Запись.УстановитьСтроку("UTF-8");
	Запись.ЗаписатьОбъявлениеXML();
	
	Запись.ЗаписатьНачалоЭлемента("INVOICE");
	
	ЗаписатьXML(Запись, 380										, "DOCUMENTNAME"); // название документа 380 - счет
	ЗаписатьXML(Запись, СокрЛП(НомерСФ)							, "NUMBER");//номер счета
	ЗаписатьXML(Запись, Формат(ДатаСФ,"ДФ=гггг-ММ-дд")			, "DATE"); //дата создания счета
	ЗаписатьXML(Запись, "RUB"									, "CURRENCY"); //код валюты
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.НомерЗаказа)		, "ORDERNUMBER"); //номер заказа
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.Номер)			, "DELIVERYNOTENUMBER"); //номер накладной
	ЗаписатьXML(Запись, СокрЛП(НомерСФ)							, "REFERENCEINVOICENUMBER"); //номер счета
	ЗаписатьXML(Запись, Формат(ДатаСФ,"ДФ=гггг-ММ-дд")			, "REFERENCEINVOICEDATE"); //дата счета
	ЗаписатьXML(Запись, ВыборкаДокумент.СуммаБезНДС				, "GOODSTOTALAMOUNT"); // всего без НДС
	ЗаписатьXML(Запись, ВыборкаДокумент.СуммаНДС				, "VATSUM"); // сумма НДС
	ЗаписатьXML(Запись, ВыборкаДокумент.СуммаБезНДС+ВыборкаДокумент.СуммаНДС, "INVOICETOTALAMOUNT"); //сумма по счету
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.ИННОрганизации)	, "FISCALNUMBER"); //инн
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.КППОрганизации)	, "REGISTRATIONNUMBER"); //кпп
	
	Запись.ЗаписатьНачалоЭлемента("HEAD");
	
	
		
	//{Лео Катанович
	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
		 
         ЗаписатьXML(Запись, "4607932679999"		, "SUPPLIER"); //GLN поставщика
	 Иначе
	     ЗаписатьXML(Запись, ВыборкаДокумент.GLNОрганизации			, "SUPPLIER"); //GLN поставщика
	КонецЕсли;
	//Лео Катанович}
	ЗаписатьXML(Запись, ВыборкаДокумент.GLNКонтрагента			, "BUYER"); //GLN покупателя
	ЗаписатьXML(Запись, ВыборкаДокумент.GLNГрузополучателя		, "DELIVERYPLACE"); //GLN места доставки
	//{Лео Катанович
	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО

	     ЗаписатьXML(Запись, "4607932679999"		, "SENDER");                               //GLN отправителя сообщения
	  Иначе
	     ЗаписатьXML(Запись, ВыборкаДокумент.GLNОрганизации			, "SENDER"); //GLN отправителя сообщения
	 КонецЕсли;	 
	 //Лео Катанович}
	
	ЗаписатьXML(Запись, ВыборкаДокумент.GLNГрузополучателя		, "RECIPIENT"); // GLN получателя сообщения
	
	ВыборкаСтрока=Результат[2].Выбрать();
	
	сч = 1;
	
	Пока ВыборкаСтрока.Следующий() Цикл
		Запись.ЗаписатьНачалоЭлемента("POSITION");
		ЗаписатьXML(Запись, сч									, "POSITIONNUMBER"); //номер товарной позици
		ЗаписатьXML(Запись, Число(СокрЛП(ВыборкаСтрока.Штрихкод)),"PRODUCT"); //Штрихкод продукта
		ЗаписатьXML(Запись, ВыборкаСтрока.АртикулПокупателя		, "PRODUCTIDBUYER"); //внутренний номер в БД покупателя
		ЗаписатьXML(Запись, ВыборкаСтрока.Количество			, "INVOICEDQUANTITY"); //количество по счету
		ЗаписатьXML(Запись, ВыборкаСтрока.ЕдиницаИзмерения		, "INVOICEUNIT"); //единица измерения
		ЗаписатьXML(Запись, ВыборкаСтрока.Цена					, "UNITPRICE"); //цена без НДС
		ЗаписатьXML(Запись, ВыборкаСтрока.СуммаБезНДС			, "AMOUNT"); //сумма без НДС
		
		Запись.ЗаписатьНачалоЭлемента("TAX");
		ЗаписатьXML(Запись,ВыборкаСтрока.СтавкаНДС				, "TAXRATE"); //ставка НДС
		ЗаписатьXML(Запись,ВыборкаСтрока.СуммаНДС				, "TAXAMOUNT"); //суммаНДС
		
		Запись.ЗаписатьКонецЭлемента();
		Запись.ЗаписатьКонецЭлемента();
		
		сч = сч + 1;
		
	КонецЦикла;
	
	Запись.ЗаписатьКонецЭлемента();
	Запись.ЗаписатьКонецЭлемента();
	
	ТекстXML=Запись.Закрыть();
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.СчетФактура);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
	
	//{Лео Катанович
	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
		 
		 СтруктураПараметров.Вставить("GLNПоставщика"			, "4607932679999");
	  Иначе
	     СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	КонецЕсли;   
    //	Лео Катанович}
	
	// << Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
	Если ДокументОтгрузки.Организация.Код = "О00000001" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su);
	ИначеЕсли ДокументОтгрузки.Организация.Код = "О00000003" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit);
	КонецЕсли;
	// >> Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерДокументаEDIЗаказа);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаДокументаEDI);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры

//+Лео Сафонов ЕА
//Процедура формирует Текст XML для последующего формирования документа СообщениеEDI
Процедура ВыгрузитьСчетФактуру_ON_SFAKT(ДокументОтгрузки, ЕстьОшибки) Экспорт
	//проверка наличия с/ф
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	Иначе
		Выборка 	= Результат.Выбрать();
		Выборка.Следующий();
		
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
		ДокументСФ = Выборка.Ссылка;
	КонецЕсли;
	
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	СУММА(ВЫБОР
	|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|				ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
	|			ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
	|		КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5	
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5	
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
	|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
	|	Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа КАК НомерДокументаEDIЗаказа,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
	|	Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
	|	Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
	|	Накладная.Ссылка.ВалютаДокумента КАК Валюта,
	|	Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
	|	Накладная.Ссылка.Организация КАК Организация,
	|	Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """") КАК НомерМагазина,
	|	Накладная.Ссылка.Грузополучатель КАК Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """") КАК КодПоставщика,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI КАК ОператорEDI
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НомерМагазина)) КАК СвойстваНомераМагазинов
	|		ПО Накладная.Ссылка.Грузополучатель = СвойстваНомераМагазинов.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодПоставщика)) КАК СвойствоКодПоставщика
	|		ПО Накладная.Ссылка.Контрагент = СвойствоКодПоставщика.Объект
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Ссылка.Номер,
	|	Накладная.Ссылка.Дата,
	|	Накладная.Ссылка.Сделка.Номер,
	|	Накладная.Ссылка.Сделка.Дата,
	|	Накладная.Ссылка.Организация.абс_GLN,
	|	Накладная.Ссылка.Контрагент.абс_GLN,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
	|	Накладная.Ссылка.Организация.ИНН,
	|	Накладная.Ссылка.Организация.КПП,
	|	Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа,
	|	Накладная.Ссылка.Организация.Лео_GUID,
	|	Накладная.Ссылка.Контрагент.Лео_GUID,
	|	Накладная.Ссылка.ВалютаДокумента,
	|	Накладная.Ссылка.ВалютаДокумента.Код,
	|	Накладная.Ссылка.Организация,
	|	Накладная.Ссылка.Грузоотправитель,
	|	Накладная.Ссылка.Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """"),
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)),
	|	Накладная.Ссылка.Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """"),
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СуммаНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.МеждународноеСокращение КАК ЕдиницаИзмерения,
	|	Накладная.Цена,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.СерияНоменклатуры = Штрихкоды.СерияНоменклатуры
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(, ) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.МеждународноеСокращение,
	|	Накладная.Цена,
	|	Накладная.СуммаНДС,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства";
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//{Лео Катанович
	Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
		 Идентификатор = ВыборкаДокумент.ОператорEDI.Идентификатор;
	 Иначе	 
		 Идентификатор = "2IH";
	КонецЕсли;	

	//{Лео Катанович
	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") ИЛИ     // ДИКСИ ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("УТ0005949") Тогда   // Сладкая жизнь
		 GUIDОрганизации = "C585D418-784D-449B-82B3-FF4CD2DE5051";
	 Иначе
		 GUIDОрганизации = ВыборкаДокумент.GUIDОрганизации;
	КонецЕсли;
	
	//ИдФайл = "ON_SFAKT_" +  ВыборкаДокумент.GUIDКонтрагента + "_2IH" + ВыборкаДокумент.GUIDОрганизации  + "_" + Формат(ДатаСФ,"ДФ=ггггММдд");	
	ИдФайл = "ON_SFAKT_" +  ВыборкаДокумент.GUIDКонтрагента + "_" + Идентификатор + GUIDОрганизации  + "_" + Формат(ДатаСФ,"ДФ=ггггММдд");	

	//ИдФайл = ИдФайл + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор()) ; // БЫЛО ДО 18.05.2017
	ИдФайл = ИдФайл + "_" + Строка(ДокументСФ.УникальныйИдентификатор()) ;
	//Лео Катанович}	
	
	ИдФайл = СформироватьИмяФайлаEDI(ИдФайл);
	ИмяФайла = ИдФайл + ".xml";
	 
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку( "WINDOWS-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		//  02.08.2016  Да, все верно.
		//Укажите в виде "Разработчик + версия обработки и 1С" или просто версия 1С.
		//ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Exite Evolution 3.0.0" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Леотон УПП 1.3" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.02" );
		 
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
		    //{Лео Катанович
		    //ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр","2IH" + ВыборкаДокумент.GUIDОрганизации);
			ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр",Идентификатор + GUIDОрганизации);
            //Лео Катанович}
			ЗаписьXML.ЗаписатьАтрибут( "ИдПок", ВыборкаДокумент.GUIDКонтрагента);
			//ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
			//	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "ООО &quot;Систем Групп Рус&quot");
			//ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", "7723749362");
			//ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", "2IH");	
			//ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		 ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
		   Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.ОператорEDI.Наименование,"""","&quot;"));
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.ОператорEDI.Контрагент.ИНН);
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		   Иначе	  
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "Систем Групп Рус");
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   "7723749362");
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		  КонецЕсли;
         ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр

		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
			ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115101");
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвСчФакт");//+СвСчФакт 
				ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", НомерСФ);
				ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") );              
				ЗаписьXML.ЗаписатьАтрибут( "КодОКВ", ВыборкаДокумент.КодВалюты);
				//Если ЗначениеЗаполнено(ВыборкаДокумент.НомерИсправления) Тогда
				// 	ЗаписьXML.ЗаписатьНачалоЭлемента("ИспрСчФ");//+ИспрСчФ
				// 	ЗаписьXML.ЗаписатьАтрибут( "НомИспрСчФ", ВыборкаДокумент.НомерИсправления);
				// 	ЗаписьXML.ЗаписатьАтрибут( "ДатаИспрСчФ", ВыборкаДокумент.ДатаИсправления);
				//	ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИспрСчФ
				//КонецЕсли;
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛ");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.Организация.НаименованиеСокращенное,"""","&quot;" ));  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОт");//+ГрузОт 
					ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОтпр");//+ГрузОтпр
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("НаимГОП");//+НаимГОП
				        	ЗаписатьXML(ЗаписьXML,ВыборкаДокумент.Грузоотправитель.НаименованиеПолное,"НаимОрг");
				        ЗаписьXML.ЗаписатьКонецЭлемента();//-НаимГОП
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузоотправитель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес			
				    ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОтпр
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОт
				
 
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузПолуч");//+ГрузПолуч
				    ЗаписьXML.ЗаписатьНачалоЭлемента("НаимГОП");//+НаимГОП
						Если ЗначениеЗаполнено(ВыборкаДокумент.НомерМагазина) Тогда
				        	ЗаписатьXML(ЗаписьXML,ВыборкаДокумент.НомерМагазина,"НаимОрг");
						Иначе
							ЗаписатьXML(ЗаписьXML,ВыборкаДокумент.Грузополучатель.НаименованиеПолное,"НаимОрг");
						КонецЕсли;
				    ЗаписьXML.ЗаписатьКонецЭлемента();//-НаимГОП
						
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента);
							// {Лео Катанович
							Если СтруктураАдреса.Количество() = 0 Тогда
								Сообщить("Не указан " + Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента + " " + ВыборкаДокумент.Грузополучатель);
							    Возврат;
							КонецЕсли;	
							// Лео Катанович}
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;

						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес			
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузПолуч

				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛ");//+СвЮЛ
							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.Контрагент,"""","&quot;" ));  
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Контрагент.ИНН);  
			 				ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Контрагент.КПП);
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв	
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПол");//+ИнфПол
					//ТекстИнф = "отправитель:"+СокрЛП(ВыборкаДокумент.GLNОрганизации)+";"+"получатель:"+СокрЛП(ВыборкаДокумент.GLNКонтрагента);
					//ЗаписьXML.ЗаписатьАтрибут( "ТекстИнф", ТекстИнф); 
					//{Лео Катанович
					//ХардКод Для Билла
					Если   ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") Тогда // Билла
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "glnEdiFileSupplier");
							//ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.GLNОрганизации));
							ЗаписьXML.ЗаписатьАтрибут( "Значен", "4607932679999");

						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "interchangeRefNo");
							Если  ЗначениеЗаполнено(ВыборкаДокумент.НомерУведомленияОбОтгрузке) Тогда
								НомерУведомления = СокрЛП(ВыборкаДокумент.НомерУведомленияОбОтгрузке)
							Иначе
								НомерУведомления = ОбщегоНазначения.ПолучитьНомерНаПечать(ДокументОтгрузки.Сделка);
							КонецЕсли;	
							ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(НомерУведомления));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					//Лео Катанович}
					//+Лео Сафонов Хардкод для Тандер
					ИначеЕсли  ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") Тогда //Тандер
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "НомерДокументаОснования");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.Номер));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
	
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "ДатаДокументаОснования");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Формат(ВыборкаДокумент.Дата,"ДФ=dd.MM.yyyy")));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "Заказ");
				 			ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

					//-Лео Сафонов Хардкод для Тандер	
					
					// {Лео Катанович	
					ИначеЕсли   ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
						ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
						ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
						ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
						ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
	                    ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
					    ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "отправитель");
						ЗаписьXML.ЗаписатьАтрибут( "Значен", "4607932679999");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "получатель");
						ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
						
						Если ЗначениеЗаполнено(ВыборкаДокумент.КодПоставщика)Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_поставщика");
							ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.КодПоставщика));
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
						КонецЕсли;
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
						ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
						
						// Лео Катанович}	
					Иначе
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "отправитель");
						ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.GLNОрганизации));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "получатель");
				 			ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
						
						Если ЗначениеЗаполнено(ВыборкаДокумент.КодПоставщика)Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
								ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_поставщика");
					 			ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.КодПоставщика));
					 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
	                    КонецЕсли;
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
				 			ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
                   КонецЕсли;	

		 		ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПол
				
			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвСчФакт
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблСчФакт");//+ТаблСчФакт
				ВыборкаСтрока=Результат[2].Выбрать();
				сч = 1;
				Пока ВыборкаСтрока.Следующий() Цикл
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.НаименованиеПолное);	
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов","796");
					    ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов",  Формат(ВыборкаСтрока.Цена, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат( ВыборкаСтрока.СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат( ВыборкаСтрока.СуммаБезНДС + ВыборкаСтрока.СуммаНДС , "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "НалСт", "" + Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0;" ) + "%" );
						
						//ИнфПолСтр = "номер_заказа:"+СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа) +";номер_накладной:"+СокрЛП(ДокументОтгрузки.Номер) +";код_материала:"+ВыборкаСтрока.АртикулПокупателя +";позиция_заказа:"+ Строка(сч) +";штрихкод:"+СокрЛП(ВыборкаСтрока.Штрихкод)+";номер_акта:"+ ДокументОтгрузки.абс_НомерУведомленияОПриемке;
						//ЗаписьXML.ЗаписатьАтрибут("ИнфПолСтр", ИнфПолСтр);
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Акциз");//+Акциз
							ЗаписатьXML(ЗаписьXML,"без акциза","БезАкциз");
							//ЗаписьXML.ЗаписатьАтрибут( "БезАкциз","без акциза" );
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Акциз

						//ЗаписьXML.ЗаписатьНачалоЭлемента("НалСт"); //+НалСт
						//	ЗаписьXML.ЗаписатьАтрибут( "НалСтВел", Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0; " ));
						//	ЗаписьXML.ЗаписатьАтрибут( "НалСтТип", "процент");
						//ЗаписьXML.ЗаписатьКонецЭлемента(); //-НалСт

						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал");//+СумНал;
							ЗаписатьXML(ЗаписьXML,Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНДС");
							//ЗаписьXML.ЗаписатьАтрибут( "СумНДС", Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНал
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_накладной");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ДокументОтгрузки.Номер));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", Строка(ВыборкаСтрока.АртикулПокупателя));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф",  "позиция_заказа");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", Строка(сч));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "штрихкод");
							ЗаписьXML.ЗаписатьАтрибут( "Значен",  СокрЛП(ВыборкаСтрока.Штрихкод));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_заказа");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", Формат(ВыборкаДокумент.ДатаЗаказа,"ДФ=гггг-ММ-дд"));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_акта");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", ?(ЗначениеЗаполнено(ДокументОтгрузки.абс_НомерУведомленияОПриемке),ДокументОтгрузки.абс_НомерУведомленияОПриемке,"б/н"));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						
					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
				КонецЦикла;
	
				ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоОпл");//+ВсегоОпл
					ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", Формат(ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
		 			ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",Формат( ДокументОтгрузки.абс_СуммаСНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
						ЗаписатьXML(ЗаписьXML,Формат(ДокументОтгрузки.абс_СуммаСНДС - ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНДС");
						//ЗаписьXML.ЗаписатьАтрибут( "СумНДС", Формат(ДокументОтгрузки.абс_СуммаСНДС - ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));  
					ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего

				ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоОпл
 			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблСчФакт
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
            	ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
					ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", "7714281617");
					
					СтруктураПодписант = ОтветственныйПоЭДО(ДокументОтгрузки.Организация, ДокументОтгрузки.Дата);
					
			 		ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
				
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
					
				
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.СчетФактура);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
	
	//{Лео Катанович
	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
		 
		 СтруктураПараметров.Вставить("GLNПоставщика"			, "4607932679999");
	  Иначе
	СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);

	КонецЕсли;   
    //	Лео Катанович}
	
	// << Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
	Если ДокументОтгрузки.Организация.Код = "О00000001" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su);
	ИначеЕсли ДокументОтгрузки.Организация.Код = "О00000003" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit);
	КонецЕсли;
	// >> Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерДокументаEDIЗаказа);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаДокументаEDI);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры

Процедура ВыгрузитьСчетФактуру_ON_SFAKT_КОРУС(ДокументОтгрузки, ЕстьОшибки) Экспорт
	//проверка наличия с/ф
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	Иначе
		Выборка 	= Результат.Выбрать();
		Выборка.Следующий();
		
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
	КонецЕсли;
	
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	СУММА(ВЫБОР
	|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|				ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
	|			ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
	|		КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5	
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5	
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
	|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	Накладная.Ссылка.Грузоотправитель.абс_GLN КАК GLNГрузоотправителя,
	|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
	|	Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа КАК НомерДокументаEDIЗаказа,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
	|	Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
	|	Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
	|	Накладная.Ссылка.ВалютаДокумента КАК Валюта,
	|	Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
	|	Накладная.Ссылка.Организация КАК Организация,
	|	Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА Накладная.Ссылка.Грузополучатель = &ПустойКонтрагент
	|			ТОГДА Накладная.Ссылка.Контрагент
	|		ИНАЧЕ Накладная.Ссылка.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель
	|ИЗ
	|	Накладная КАК Накладная
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Ссылка.Номер,
	|	Накладная.Ссылка.Дата,
	|	Накладная.Ссылка.Сделка.Номер,
	|	Накладная.Ссылка.Сделка.Дата,
	|	Накладная.Ссылка.Организация.абс_GLN,
	|	Накладная.Ссылка.Контрагент.абс_GLN,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
	|	Накладная.Ссылка.Организация.ИНН,
	|	Накладная.Ссылка.Организация.КПП,
	|	Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)),
	|	Накладная.Ссылка.Организация.Лео_GUID,
	|	Накладная.Ссылка.Контрагент.Лео_GUID,
	|	Накладная.Ссылка.ВалютаДокумента,
	|	Накладная.Ссылка.ВалютаДокумента.Код,
	|	Накладная.Ссылка.Организация,
	|	Накладная.Ссылка.Грузоотправитель,
	|	Накладная.Ссылка.Контрагент,
	|	Накладная.Ссылка.Грузоотправитель.абс_GLN,
	|	ВЫБОР
	|		КОГДА Накладная.Ссылка.Грузополучатель = &ПустойКонтрагент
	|			ТОГДА Накладная.Ссылка.Контрагент
	|		ИНАЧЕ Накладная.Ссылка.Грузополучатель
	|	КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СуммаНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.МеждународноеСокращение КАК ЕдиницаИзмерения,
	|	Накладная.Цена,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.СерияНоменклатуры = Штрихкоды.СерияНоменклатуры
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(, ) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.МеждународноеСокращение,
	|	Накладная.Цена,
	|	Накладная.СуммаНДС,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства";
	
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	Запрос.УстановитьПараметр("ПустойКонтрагент", Справочники.Контрагенты.ПустаяСсылка());
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////		
	ИдФайл = "ON_SFAKT_2BK-" + ВыборкаДокумент.Контрагент.ИНН + "-" + ВыборкаДокумент.Контрагент.ОГРН + "_2BK-" + ВыборкаДокумент.Организация.ИНН + "-" + ВыборкаДокумент.Организация.ОГРН  + "_" + Формат(ДатаСФ,"ДФ=ггггММдд");	
	ИдФайл = ИдФайл + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор()) ;
	ИдФайл = СформироватьИмяФайлаEDI(ИдФайл);
	ИмяФайла = ИдФайл + ".xml";
	 
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку( "WINDOWS-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "1.93" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.02" );
		 
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
		
		  ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр","2BK-" + ВыборкаДокумент.Организация.ИНН + "-" + ВыборкаДокумент.Организация.ОГРН);
		  ЗаписьXML.ЗаписатьАтрибут( "ИдПок", "2BK-" +  ВыборкаДокумент.Контрагент.ИНН + "-" + ВыборкаДокумент.Контрагент.ОГРН);

		 	//ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр","2BK-" + ВыборкаДокумент.GUIDОрганизации);
			//ЗаписьXML.ЗаписатьАтрибут( "ИдПок", "2BK-" + ВыборкаДокумент.GUIDКонтрагента);
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
				//ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "ООО &quot;КОРУС Консалтинг СНГ&quot;");
				ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "ООО " + Символ(34) + "КОРУС Консалтинг СНГ" + Символ(34));
		 		ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", "7801392271");
		 		ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", "2BK");	
			ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
			ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115101");
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвСчФакт");//+СвСчФакт 
				ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", НомерСФ);
				ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") );              
				ЗаписьXML.ЗаписатьАтрибут( "КодОКВ", ВыборкаДокумент.КодВалюты);
				//Если ЗначениеЗаполнено(ВыборкаДокумент.НомерИсправления) Тогда
				// 	ЗаписьXML.ЗаписатьНачалоЭлемента("ИспрСчФ");//+ИспрСчФ
				// 	ЗаписьXML.ЗаписатьАтрибут( "НомИспрСчФ", ВыборкаДокумент.НомерИсправления);
				// 	ЗаписьXML.ЗаписатьАтрибут( "ДатаИспрСчФ", ВыборкаДокумент.ДатаИсправления);
				//	ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИспрСчФ
				//КонецЕсли;
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛ");//+СвЮЛ
							//ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.Организация.НаименованиеСокращенное,"""","&quot;" )); 
							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Организация.НаименованиеСокращенное); 
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОт");//+ГрузОт 
					ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОтпр");//+ГрузОтпр
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("НаимГОП");//+НаимГОП
				        	ЗаписатьXML(ЗаписьXML,ВыборкаДокумент.Грузоотправитель.НаименованиеПолное,"НаимОрг");
				        ЗаписьXML.ЗаписатьКонецЭлемента();//-НаимГОП
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузоотправитель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес			
				    ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОтпр
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОт
				
 
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузПолуч");//+ГрузПолуч
				    ЗаписьXML.ЗаписатьНачалоЭлемента("НаимГОП");//+НаимГОП
				        ЗаписатьXML(ЗаписьXML,ВыборкаДокумент.Грузополучатель.Наименование,"НаимОрг");
				    ЗаписьXML.ЗаписатьКонецЭлемента();//-НаимГОП
						
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;

						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес			
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузПолуч

				//ЗаписьXML.ЗаписатьНачалоЭлемента("СвПРД");//+СвПРД
				//	ЗаписьXML.ЗаписатьАтрибут( "НомерПРД", );  
				//	ЗаписьXML.ЗаписатьАтрибут( "ДатаПРД",);  
				//ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПРД
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛ");//+СвЮЛ
							//ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.Контрагент,"""","&quot;" ));  
							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Контрагент.НаименованиеПолное);  
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Контрагент.ИНН);  
			 				ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Контрагент.КПП);
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв	
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
				
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПол");//+ИнфПол
					//ТекстИнф = "отправитель:"+СокрЛП(ВыборкаДокумент.GLNОрганизации)+";"+"получатель:"+СокрЛП(ВыборкаДокумент.GLNКонтрагента);
					//ЗаписьXML.ЗаписатьАтрибут( "ТекстИнф", ТекстИнф); 
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "отправитель");
						
						Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000049") Тогда //Ашан
                            ЗаписьXML.ЗаписатьАтрибут( "Значен", "4607932679999");
						Иначе
			 			    ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.GLNОрганизации));
						КонецЕсли;	
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					
					Если ЗначениеЗаполнено(ВыборкаДокумент.GLNКонтрагента) Тогда
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "получатель");
						ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNКонтрагента));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					КонецЕсли;	
				
					Если ЗначениеЗаполнено(ВыборкаДокумент.GLNГрузоотправителя) Тогда
						GLNГрузоотправителя = СокрЛП(ВыборкаДокумент.GLNГрузоотправителя);
					Иначе
						Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000049") Тогда //Ашан
                           GLNГрузоотправителя = "4607932679999";
                        Иначе 
						    GLNГрузоотправителя = СокрЛП(ВыборкаДокумент.GLNОрганизации);
						КонецЕсли;	
					КонецЕсли;

						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузоотправитель");
						ЗаписьXML.ЗаписатьАтрибут( "Значен",GLNГрузоотправителя);
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

					
					Если ЗначениеЗаполнено(ВыборкаДокумент.GLNГрузополучателя) Тогда
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузополучатель");
						ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					КонецЕсли;
					
                    ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_поставщика");
					    //ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNОрганизации));
						ЗаписьXML.ЗаписатьАтрибут( "Значен","05360005");
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

				
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_договора");
					    ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ДокументОтгрузки.ДоговорКонтрагента.Номер));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_договора");
						ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ДокументОтгрузки.ДоговорКонтрагента.Дата,"ДФ=yyyyMMdd"));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

		 		ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПол
			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвСчФакт
			
	
			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблСчФакт");//+ТаблСчФакт
				ВыборкаСтрока=Результат[2].Выбрать();
				сч = 1;
				Пока ВыборкаСтрока.Следующий() Цикл
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.НаименованиеПолное);	
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов","796");
					    ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов",  Формат(ВыборкаСтрока.Цена, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат( ВыборкаСтрока.СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат( ВыборкаСтрока.СуммаБезНДС + ВыборкаСтрока.СуммаНДС , "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "НалСт", "" + Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0;" ) + "%" );
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Акциз");//+Акциз
							ЗаписатьXML(ЗаписьXML,"без акциза","БезАкциз");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Акциз

						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал");//+СумНал;
							ЗаписатьXML(ЗаписьXML,Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНДС");
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНал
							
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_накладной");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ДокументОтгрузки.Номер));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", Строка(ВыборкаСтрока.АртикулПокупателя));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф",  "позиция_заказа");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", Строка(сч));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "штрихкод");
							ЗаписьXML.ЗаписатьАтрибут( "Значен",  СокрЛП(ВыборкаСтрока.Штрихкод));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_акта");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", ?(ЗначениеЗаполнено(ДокументОтгрузки.абс_НомерУведомленияОПриемке),ДокументОтгрузки.абс_НомерУведомленияОПриемке,"б/н"));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						
					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
				КонецЦикла;
	
				ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоОпл");//+ВсегоОпл
					ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", Формат(ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
		 			ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",Формат( ДокументОтгрузки.абс_СуммаСНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
						ЗаписатьXML(ЗаписьXML,Формат(ДокументОтгрузки.абс_СуммаСНДС - ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНДС");
						//ЗаписьXML.ЗаписатьАтрибут( "СумНДС", Формат(ДокументОтгрузки.абс_СуммаСНДС - ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));  
					ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего

				ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоОпл
 			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблСчФакт
			
			//ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
			//	ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
			//		ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", "7714281617");
			// 		ЗаписьXML.ЗаписатьАтрибут( "Должн", "Директор");

			//	 ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
			//		ЗаписьXML.ЗаписатьАтрибут( "Фамилия", "Люликова");  
			// 		ЗаписьXML.ЗаписатьАтрибут( "Имя", "Светлана"); 
			//	ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			//	ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ

			//ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
				ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
            	ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
					ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", "7714281617");
					
					СтруктураПодписант = ОтветственныйПоЭДО(ДокументОтгрузки.Организация, ДокументОтгрузки.Дата);
					
			 		ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.СчетФактура);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
	СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	СтруктураПараметров.Вставить("НастройкаОбмена"		    , Справочники.абс_НастройкиEDIОбмена.КОРУС);
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерДокументаEDIЗаказа);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаДокументаEDI);
    СтруктураПараметров.Вставить("Ответственный"		    , ПараметрыСеанса.ТекущийПользователь);	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры

Процедура ВыгрузитьСчетФактуру_ON_SFAKT_Контур(ДокументОтгрузки, ЕстьОшибки) Экспорт
	//проверка наличия с/ф
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
	
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	Иначе
		Выборка 	= Результат.Выбрать();
		Выборка.Следующий();
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
	КонецЕсли;
	
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	СУММА(ВЫБОР
	|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|				ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
	|			ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
	|		КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5	
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС,
	|	РеализацияТоваровУслугТовары.НомерСтроки,
	|	СУММА(РеализацияТоваровУслугТовары.Количество * РеализацияТоваровУслугТовары.ЕдиницаИзмерения.Коэффициент / РеализацияТоваровУслугТовары.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент * РеализацияТоваровУслугТовары.Номенклатура.ЕдиницаХраненияОстатков.ВесНетто) КАК СуммаНетто
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5	
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.НомерСтроки
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
	|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
	|	Накладная.Ссылка.Сделка.НомерПоДаннымПокупателя КАК НомерПоДаннымПокупателя,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
	|	Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
	|	Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
	|	Накладная.Ссылка.ВалютаДокумента КАК Валюта,
	|	Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
	|	Накладная.Ссылка.Организация КАК Организация,
	|	Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """") КАК НомерМагазина,
	|	Накладная.Ссылка.Грузополучатель КАК Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """") КАК КодПоставщика,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата КАК ДатаТТН,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор) КАК Водитель,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность),
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения КАК ДатаИсполнения,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI КАК ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ КАК ДатаПоставки
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НомерМагазина)) КАК СвойстваНомераМагазинов
	|		ПО Накладная.Ссылка.Грузополучатель = СвойстваНомераМагазинов.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодПоставщика)) КАК СвойствоКодПоставщика
	|		ПО Накладная.Ссылка.Контрагент = СвойствоКодПоставщика.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Ссылка.Номер,
	|	Накладная.Ссылка.Дата,
	|	Накладная.Ссылка.Сделка.Номер,
	|	Накладная.Ссылка.Сделка.Дата,
	|	Накладная.Ссылка.Организация.абс_GLN,
	|	Накладная.Ссылка.Контрагент.абс_GLN,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
	|	Накладная.Ссылка.Организация.ИНН,
	|	Накладная.Ссылка.Организация.КПП,
	|	Накладная.Ссылка.Организация.Лео_GUID,
	|	Накладная.Ссылка.Контрагент.Лео_GUID,
	|	Накладная.Ссылка.ВалютаДокумента,
	|	Накладная.Ссылка.ВалютаДокумента.Код,
	|	Накладная.Ссылка.Организация,
	|	Накладная.Ссылка.Грузоотправитель,
	|	Накладная.Ссылка.Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """"),
	|	Накладная.Ссылка.Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """"),
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ,
	|	Накладная.Ссылка.Сделка.НомерПоДаннымПокупателя,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)),
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СуммаНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование КАК ЕдиницаИзмерения,
	|	Накладная.Цена,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя,
	|	Накладная.Номенклатура.Артикул КАК Артикул,
	|	Накладная.НомерСтроки КАК НомерСтроки,
	|	Накладная.СуммаНетто
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.СерияНоменклатуры = Штрихкоды.СерияНоменклатуры
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(, ) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование,
	|	Накладная.Цена,
	|	Накладная.СуммаНДС,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства,
	|	Накладная.Номенклатура.Артикул,
	|	Накладная.НомерСтроки,
	|	Накладная.СуммаНетто
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////		

	Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
		 Идентификатор = ВыборкаДокумент.ОператорEDI.Идентификатор;
	 Иначе
		 Сообщить("Не заполнен оператор EDI");
		 Возврат;
	КонецЕсли;	
	
    НомерОрганизацииВсистеме = ВыборкаДокумент.Организация.ИНН + "-" + "2012052807212505941080000000000";
	
	Если ЗначениеЗаполнено(ВыборкаДокумент.Контрагент.Лео_GUID) Тогда
		НомерКонтрагентаВсистеме = ВыборкаДокумент.Контрагент.ИНН + "-" + СОКРЛП(ВыборкаДокумент.Контрагент.Лео_GUID);
	Иначе
		НомерКонтрагентаВсистеме = ВыборкаДокумент.Контрагент.ИНН + "-" + СОКРЛП(абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ВыборкаДокумент.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Идентификатор участника ЭДО")));
	КонецЕсли;	

	
	
	//ИдФайл = "ON_SCHFDOPPR_" + Идентификатор + "-" + НомерКонтрагентаВсистеме + "_" + Идентификатор + "-" + НомерОрганизацииВсистеме + "_" + Формат(ДатаСФ,"ДФ=ггггММдд") + "_" + Строка(Выборка.Ссылка.УникальныйИдентификатор()) ;
    ИдФайл = "ON_NSCHFDOPPR_" + Идентификатор + "-" + НомерКонтрагентаВсистеме + "_" + Идентификатор + "-" + НомерОрганизацииВсистеме + "_" + Формат(ДатаСФ,"ДФ=ггггММдд") + "_" + Строка(Выборка.Ссылка.УникальныйИдентификатор()) ;
	//ON_NSCHFDOPPR
	
    ИмяФайла = "SF_" + НомерСФ + "_" + Формат(ДатаСФ,"ДФ=ггггММдд");
	
	ИмяФайла = СформироватьИмяФайлаEDI(ИмяФайла);
	ИмяФайла = ИмяФайла + ".xml";
	 
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку( "windows-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
	

		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.01" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Diadoc 1.0" );
		 
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
			ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр",Идентификатор + "-" + НомерОрганизацииВсистеме);
			ЗаписьXML.ЗаписатьАтрибут( "ИдПол", Идентификатор + "-" + НомерКонтрагентаВсистеме);
		   ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.ОператорEDI.Контрагент.ИНН);
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО",   Идентификатор);	
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.ОператорEDI.Наименование,"""","&quot;"));

         ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
			//ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115125");
			ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115131");
			
			ЗаписьXML.ЗаписатьАтрибут( "Функция", "СЧФ");
			//ЗаписьXML.ЗаписатьАтрибут( "ПоФактХЖ","Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
			//ЗаписьXML.ЗаписатьАтрибут( "НаимДокОпр", "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (Документ об оказании услуг)");
			
			
			ЗаписьXML.ЗаписатьАтрибут( "ДатаИнфПр", Формат(ТекущаяДата(),"ДФ=дд.ММ.гггг")); // Дата формирования файла обмена СФ
			ЗаписьXML.ЗаписатьАтрибут( "ВремИнфПр", Формат(ТекущаяДата(), "ДФ=ЧЧ.мм.сс"));
			ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное);
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвСчФакт");//+СвСчФакт 
				ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", НомерСФ);
				ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") );              
				ЗаписьXML.ЗаписатьАтрибут( "КодОКВ", ВыборкаДокумент.КодВалюты);
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
						ЗаписьXML.ЗаписатьАтрибут( "КраткНазв", ВыборкаДокумент.Организация.Наименование);

					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг",ВыборкаДокумент.Организация.НаименованиеСокращенное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;

							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						СведенияОПродавце = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод
				
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОт");//+ГрузОт 
					ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОтпр");//+ГрузОтпр
                           	 ЗаписьXML.ЗаписатьАтрибут( "КраткНазв", ВыборкаДокумент.Грузоотправитель.Наименование);
							 
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Грузоотправитель.НаименованиеПолное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Грузоотправитель.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Грузоотправитель.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузоотправитель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						СведенияОГрузоотправитель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузоотправитель,  ВыборкаДокумент.Дата);

					ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОтпр
		
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОт
				
				СведенияОГрузополучатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузополучатель,  ВыборкаДокумент.Дата);

				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузПолуч");//+ГрузПолуч
				           ЗаписьXML.ЗаписатьАтрибут( "КраткНазв", ВыборкаДокумент.Грузополучатель.Наименование);
						   
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
					          ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
								  Если ЗначениеЗаполнено(ВыборкаДокумент.НомерМагазина) Тогда
									   ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.НомерМагазина);
								   Иначе
									    ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.Грузополучатель.НаименованиеПолное);
								  КонецЕсли;
						           ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОГрузополучатель.ИНН );
							       ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОГрузополучатель.КПП );
							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента);
							Если СтруктураАдреса.Количество() = 0 Тогда
								Сообщить("Не указан " + Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента + " " + ВыборкаДокумент.Грузополучатель);
							    Возврат;
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;

						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
					//////////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузПолуч
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
				     ЗаписьXML.ЗаписатьАтрибут( "КраткНазв", ВыборкаДокумент.Контрагент.Наименование);
					 
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Контрагент.НаименованиеПолное);  
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Контрагент.ИНН);  
			 				ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Контрагент.КПП);
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв	
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							СведенияОПокупатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Контрагент,  ВыборкаДокумент.Дата);
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
				
					/////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ1");//+ИнфПолФХЖ1

					     ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					          ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "Договор");
                              ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.ДоговорКонтрагента.Номер));
					     ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ1
                   ///////////////////////////////////////////
				
				//ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСвФХЖ1");//+ДопСвФХЖ1
				// ЗаписьXML.ЗаписатьАтрибут( "НаимОКВ", "Российский рубль");
				//ЗаписьXML.ЗаписатьКонецЭлемента(); //-ДопСвФХЖ1
				
			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвСчФакт
			
			// --------------------ТАБЛИЧНАЯ ЧАСТЬ---------------------

			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблСчФакт");//+ТаблСчФакт
				ВыборкаСтрока=Результат[2].Выбрать();
				сч = 1;
				КолНетто = 0;
				Пока ВыборкаСтрока.Следующий() Цикл
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.НаименованиеПолное);	
						ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов","796");

					    ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов",  Формат(ВыборкаСтрока.Цена, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат( ВыборкаСтрока.СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "НалСт", "" + Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0;" ) + "%" );
						ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат( ВыборкаСтрока.СуммаБезНДС + ВыборкаСтрока.СуммаНДС , "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));

						ЗаписьXML.ЗаписатьНачалоЭлемента("Акциз");//+Акциз
							ЗаписатьXML(ЗаписьXML,"без акциза","БезАкциз");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Акциз
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал");//+СумНал;
							ЗаписатьXML(ЗаписьXML,Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНал
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСведТов");//+ДопСведТов
						    ЗаписьXML.ЗаписатьАтрибут( "НаимЕдИзм", Строка(ВыборкаСтрока.ЕдиницаИзмерения));
				        ЗаписьXML.ЗаписатьКонецЭлемента();//-ДопСведТов

					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
					КолНетто = КолНетто + ВыборкаСтрока.СуммаНетто;

				КонецЦикла;
				
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоОпл");//+ВсегоОпл
					      ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", Формат(ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
				          ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",Формат( ДокументОтгрузки.абс_СуммаСНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
						ЗаписатьXML(ЗаписьXML,Формат(ДокументОтгрузки.абс_СуммаСНДС - ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
					ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего

                    ЗаписатьXML(ЗаписьXML,Формат(КолНетто, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"КолНеттоВс");

					
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоОпл
 			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблСчФакт
			
			//-----------------------------------------------------------------------------------------------------------
		   // ЗаписьXML.ЗаписатьНачалоЭлемента("СвПродПер");//+СвПродПер

		   // ЗаписьXML.ЗаписатьНачалоЭлемента("СвПер");//+СвПер
		   // 		ЗаписьXML.ЗаписатьАтрибут("СодОпер", "Товары переданы");
		   //		 ЗаписьXML.ЗаписатьАтрибут("ДатаПер", Формат(ВыборкаДокумент.ДатаИсполнения,"ДФ=дд.ММ.гггг"));

		   //	  ЗаписьXML.ЗаписатьНачалоЭлемента("ОснПер");//+ОснПер
		   // 			   ЗаписьXML.ЗаписатьАтрибут( "НаимОсн", ВыборкаДокумент.ДоговорКонтрагента.Наименование);
		   // 			   ЗаписьXML.ЗаписатьАтрибут( "НомОсн",  ВыборкаДокумент.ДоговорКонтрагента.Номер);
		   // 			   ЗаписьXML.ЗаписатьАтрибут( "ДатаОсн", Формат(ВыборкаДокумент.ДоговорКонтрагента.Дата,"ДФ=дд.ММ.гггг"));
		   //	 ЗаписьXML.ЗаписатьКонецЭлемента();//-ОснПер
		   // 	
		   //   ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПер
		   //ЗаписьXML.ЗаписатьКонецЭлемента();//+СвПродПер

		   // //-----------------------------------------------------------------------------------------------------------
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
				ЗаписьXML.ЗаписатьАтрибут( "ОблПолн",  "6");
				ЗаписьXML.ЗаписатьАтрибут( "Статус",   "1");
				ЗаписьXML.ЗаписатьАтрибут( "ОснПолн",  "Должностные обязанности");
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
				
					СтруктураПодписант = ОтветственныйПоЭДО(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата);
			 		         ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Организация.НаименованиеСокращенное);
			 		         ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
					
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
					    ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
			
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.СчетФактура);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
	СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	СтруктураПараметров.Вставить("НастройкаОбмена"		    , Справочники.абс_НастройкиEDIОбмена.НайтиПоНаименованию("Контур"));
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, НомерСФ);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ДатаСФ);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры




Процедура ВыгрузитьТН_Контур(ДокументОтгрузки, ЕстьОшибки) Экспорт
	//проверка наличия с/ф
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
	
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		//Сообщение=Новый СообщениеПользователю;
		//Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
		//Сообщение.Сообщить();
		//ЕстьОшибки = Истина;
		//Возврат;
		ДатаСФ 	= ДокументОтгрузки.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(ДокументОтгрузки.Ссылка);

	Иначе
		Выборка 	= Результат.Выбрать();
		Выборка.Следующий();
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
		
	КонецЕсли;
	
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	СУММА(ВЫБОР
	|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|				ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
	|			ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
	|		КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5	
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС,
	|	РеализацияТоваровУслугТовары.НомерСтроки
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5	
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.НомерСтроки
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
	|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
	|	Накладная.Ссылка.Сделка.НомерПоДаннымПокупателя КАК НомерПоДаннымПокупателя,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
	|	Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
	|	Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
	|	Накладная.Ссылка.ВалютаДокумента КАК Валюта,
	|	Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
	|	Накладная.Ссылка.Организация КАК Организация,
	|	Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """") КАК НомерМагазина,
	|	Накладная.Ссылка.Грузополучатель КАК Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """") КАК КодПоставщика,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата КАК ДатаТТН,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор) КАК Водитель,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность),
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки) КАК ДатаИсполнения,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI КАК ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ КАК ДатаПоставки
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НомерМагазина)) КАК СвойстваНомераМагазинов
	|		ПО Накладная.Ссылка.Грузополучатель = СвойстваНомераМагазинов.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодПоставщика)) КАК СвойствоКодПоставщика
	|		ПО Накладная.Ссылка.Контрагент = СвойствоКодПоставщика.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Ссылка.Номер,
	|	Накладная.Ссылка.Дата,
	|	Накладная.Ссылка.Сделка.Номер,
	|	Накладная.Ссылка.Сделка.Дата,
	|	Накладная.Ссылка.Организация.абс_GLN,
	|	Накладная.Ссылка.Контрагент.абс_GLN,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
	|	Накладная.Ссылка.Организация.ИНН,
	|	Накладная.Ссылка.Организация.КПП,
	|	Накладная.Ссылка.Организация.Лео_GUID,
	|	Накладная.Ссылка.Контрагент.Лео_GUID,
	|	Накладная.Ссылка.ВалютаДокумента,
	|	Накладная.Ссылка.ВалютаДокумента.Код,
	|	Накладная.Ссылка.Организация,
	|	Накладная.Ссылка.Грузоотправитель,
	|	Накладная.Ссылка.Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """"),
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)),
	|	Накладная.Ссылка.Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """"),
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ,
	|	Накладная.Ссылка.Сделка.НомерПоДаннымПокупателя,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки),
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СуммаНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование КАК ЕдиницаИзмерения,
	|	Накладная.Цена,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя,
	|	Накладная.Номенклатура.Артикул КАК Артикул,
	|	Накладная.НомерСтроки КАК НомерСтроки,
	|	Накладная.Количество * Накладная.ЕдиницаИзмерения.Коэффициент / Накладная.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент * Накладная.Номенклатура.ЕдиницаХраненияОстатков.Вес КАК МассаНетто
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.СерияНоменклатуры = Штрихкоды.СерияНоменклатуры
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(, ) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование,
	|	Накладная.Цена,
	|	Накладная.СуммаНДС,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства,
	|	Накладная.Номенклатура.Артикул,
	|	Накладная.НомерСтроки,
	|	Накладная.Количество * Накладная.ЕдиницаИзмерения.Коэффициент / Накладная.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент * Накладная.Номенклатура.ЕдиницаХраненияОстатков.Вес
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////		

	Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
		 Идентификатор = ВыборкаДокумент.ОператорEDI.Идентификатор;
	 Иначе
		 Сообщить("Не заполнен оператор EDI");
		 Возврат;
	КонецЕсли;	
	
    НомерОрганизацииВсистеме = ВыборкаДокумент.Организация.ИНН + "-" + "2012052807212505941080000000000";
	
	Если ЗначениеЗаполнено(ВыборкаДокумент.Контрагент.Лео_GUID) Тогда
		НомерКонтрагентаВсистеме = ВыборкаДокумент.Контрагент.ИНН + "-" + СОКРЛП(ВыборкаДокумент.Контрагент.Лео_GUID);
	Иначе
		НомерКонтрагентаВсистеме = ВыборкаДокумент.Контрагент.ИНН + "-" + СОКРЛП(абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ВыборкаДокумент.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Идентификатор участника ЭДО")));
	КонецЕсли;	
	

	
	
	
	////////////////
		
	ИдФайл = "ON_NSCHFDOPPR_" + Идентификатор + "-" + НомерКонтрагентаВсистеме + "_" + Идентификатор + "-" + НомерОрганизацииВсистеме + "_" + Формат(ДатаСФ,"ДФ=ггггММдд") + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор()) ;

    ИмяФайла = "TN_" + ВыборкаДокумент.Номер + "_" + Формат(ВыборкаДокумент.Дата,"ДФ=ггггММдд");
	
	ИмяФайла = СформироватьИмяФайлаEDI(ИмяФайла);
	ИмяФайла = ИмяФайла + ".xml";

	////////////////////
	
	
	
	
	//ИдФайл = "ON_SCHFDOPPR_" + Идентификатор + "-" + НомерКонтрагентаВсистеме + "_" + Идентификатор + "-" + НомерОрганизацииВсистеме + "_" + Формат(ВыборкаДокумент.Дата,"ДФ=ггггММдд");	
	//ИдФайл = ИдФайл + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор()) ;
	//
	//ИдФайл = СформироватьИмяФайлаEDI(ИдФайл);
	//ИмяФайла = ИдФайл + ".xml";
	 
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку( "windows-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
	

		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.01" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Diadoc 1.0" );
		 
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
			ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр",Идентификатор + "-" + НомерОрганизацииВсистеме);
			ЗаписьXML.ЗаписатьАтрибут( "ИдПол", Идентификатор + "-" + НомерКонтрагентаВсистеме);
		   ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.ОператорEDI.Контрагент.ИНН);
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО",   Идентификатор);	
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.ОператорEDI.Наименование,"""","&quot;"));

         ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
			ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115131");
			ЗаписьXML.ЗаписатьАтрибут( "ВремИнфПр", Формат(ТекущаяДата(), "ДФ=ЧЧ.мм.сс"));
			ЗаписьXML.ЗаписатьАтрибут( "ДатаИнфПр", Формат(ТекущаяДата(),"ДФ=дд.ММ.гггг")); // Дата формирования файла обмена СФ
			ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное + ", ИНН-КПП: " + ВыборкаДокумент.Организация.ИНН + "-" + ВыборкаДокумент.Организация.КПП);
		    ЗаписьXML.ЗаписатьАтрибут( "Функция", "ДОП");
			ЗаписьXML.ЗаписатьАтрибут( "ПоФактХЖ", "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
			ЗаписьXML.ЗаписатьАтрибут( "НаимДокОпр", "Счет-фактура и документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвСчФакт");//+СвСчФакт 
				//ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", НомерСФ);
				//ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") );    
				ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", ВыборкаДокумент.Номер);
				ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг") );   
				
				ЗаписьXML.ЗаписатьАтрибут( "КодОКВ", ВыборкаДокумент.КодВалюты);
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг",ВыборкаДокумент.Организация.НаименованиеСокращенное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;

							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						СведенияОПродавце = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод
				
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОт");//+ГрузОт 
				
				Если ВыборкаДокумент.Организация.ИНН = ВыборкаДокумент.Грузоотправитель.ИНН Тогда
					ЗаписатьXML(ЗаписьXML,"он же","ОнЖе");
				Иначе

					ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОтпр");//+ГрузОтпр

					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Грузоотправитель.НаименованиеПолное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Грузоотправитель.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Грузоотправитель.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузоотправитель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
								
								ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
								ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
								СведенияОГрузоотправитель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузоотправитель,  ВыборкаДокумент.Дата);
								
								ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОтпр
							КонецЕсли;
		
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОт
				СведенияОГрузополучатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузополучатель,  ВыборкаДокумент.Дата);

				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузПолуч");//+ГрузПолуч
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
					          ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
								  Если ЗначениеЗаполнено(ВыборкаДокумент.НомерМагазина) Тогда
									   ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.НомерМагазина);
								   Иначе
									    ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.Грузополучатель.НаименованиеПолное);
								  КонецЕсли;
						           ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОГрузополучатель.ИНН );
							       ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОГрузополучатель.КПП );
							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента);
							Если СтруктураАдреса.Количество() = 0 Тогда
								Сообщить("Не указан " + Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента + " " + ВыборкаДокумент.Грузополучатель);
							    Возврат;
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;

						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
					//////////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузПолуч
				///////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПРД");//+СвПРД
				         //ЗаписьXML.ЗаписатьАтрибут( "НомерПРД",  НомерСФ);
						 //  ЗаписьXML.ЗаписатьАтрибут( "ДатаПРД", Формат(ДатаСФ,"ДФ=дд.ММ.гггг"));

				         ЗаписьXML.ЗаписатьАтрибут( "НомерПРД",  ОбщегоНазначения.ПолучитьНомерНаПечать(ДокументОтгрузки.Ссылка));
                         ЗаписьXML.ЗаписатьАтрибут( "ДатаПРД", Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
						 
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПРД

				//////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Контрагент.НаименованиеПолное);  
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Контрагент.ИНН);  
			 				ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Контрагент.КПП);
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв	
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							СведенияОПокупатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Контрагент,  ВыборкаДокумент.Дата);
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСвФХЖ1");//+ИнфПолФХЖ1
		         ЗаписьXML.ЗаписатьАтрибут( "НаимОКВ", "Российский рубль");
				 ЗаписьXML.ЗаписатьАтрибут( "КурсВал", "1");
				ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
				
			//	ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ1");//+ИнфПолФХЖ1
			//		ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
			//		  ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
			//		  ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.НомерПоДаннымПокупателя));
			//		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

			//		ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
			//		  ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "отправитель");
			//		  ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.GLNОрганизации));
			//		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
			//		
			//		///////////////////////////////////////////////////////////////////////////////////////////////////////
			//			ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
			//			  ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "получатель");
			//			  ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNКонтрагента));
			// 			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
			//		
			//		////////////////////////////////////////////////////////////////////////////////////////////////////////
			//		ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
			//			ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "GLN_грузополучателя");
			//			ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
			// 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
			//		////////////////////////////////////////////////////////////////////////////////////////////////////////
			//			ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
			//			ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_поставщика");
			//		 	ЗаписьXML.ЗаписатьАтрибут( "Значен",УдалитьЛидирующиеНули(ВыборкаДокумент.КодПоставщика));
			//		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
			//ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
				
			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвСчФакт
			
			// --------------------ТАБЛИЧНАЯ ЧАСТЬ---------------------

			Клиент_Упращенка = лео_ДопФункции.Получить_ЗначенияКатегорииОбъектов(ВыборкаДокумент.Контрагент, Справочники.КатегорииОбъектов.НайтиПоКоду("000000122"));
			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблСчФакт");//+ТаблСчФакт
				ВыборкаСтрока=Результат[2].Выбрать();
				сч = 1;
				Нетто_Всего =  0;

				Пока ВыборкаСтрока.Следующий() Цикл
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.НаименованиеПолное);	
						ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат( ВыборкаСтрока.СуммаБезНДС + ВыборкаСтрока.СуммаНДС , "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов","796");
					    ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов",  Формат(ВыборкаСтрока.Цена, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат( ВыборкаСтрока.СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						Если Клиент_Упращенка Тогда        //для клиента на упрощенке передается 0 ставка НДС
							ЗаписьXML.ЗаписатьАтрибут( "НалСт", "" +  "0%" );
						Иначе
							ЗаписьXML.ЗаписатьАтрибут( "НалСт", "" + Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0;" ) + "%" );
						КонецЕсли;
						Нетто_Всего =  Нетто_Всего + ВыборкаСтрока.МассаНетто;
                        						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Акциз");//+Акциз
							ЗаписатьXML(ЗаписьXML,"без акциза","БезАкциз");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Акциз
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал");//+СумНал;
							ЗаписатьXML(ЗаписьXML,Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНал
						
					//	ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
					//		ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала");
					//		АртикулПокупателя = СтрЗаменить(ВыборкаСтрока.АртикулПокупателя,"*","");
					//		ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(АртикулПокупателя)));
					//ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
					//	
					//	ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
					//		ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "штрихкод");
					//		ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(ВыборкаСтрока.Штрихкод)));
					//ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2

					   // ЗаписьXML.ЗаписатьНачалоЭлемента("СвТД");//+СвТД
						    //ЗаписьXML.ЗаписатьАтрибут( "КодПроисх", "643");
							//ЗаписьXML.ЗаписатьАтрибут( "НомерТД", "-");
				        //ЗаписьXML.ЗаписатьКонецЭлемента();//-СвТД

					//СвТД КодПроисх="980" НомерТД="7894490646804" />
					
						ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСведТов");//+ДопСведТов
						    ЗаписьXML.ЗаписатьАтрибут( "НаимЕдИзм", Строка(ВыборкаСтрока.ЕдиницаИзмерения));
				        ЗаписьXML.ЗаписатьКонецЭлемента();//-ДопСведТов

					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
				КонецЦикла;
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоОпл");//+ВсегоОпл
						  ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",Формат( ДокументОтгрузки.абс_СуммаСНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
				          ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", Формат(ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
						ЗаписатьXML(ЗаписьXML,Формат(ДокументОтгрузки.абс_СуммаСНДС - ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
					ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего
					
					//ЗаписатьXML(ЗаписьXML,Формат(Нетто_Всего, "ЧДЦ=3; ЧРД=.; ЧГ=0; ЧН=" ),"НеттоВс");

				ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоОпл
 			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблСчФакт
			
			//-----------------------------------------------------------------------------------------------------------
		   // ЗаписьXML.ЗаписатьНачалоЭлемента("СвПродПер");//+СвПродПер

		   // ЗаписьXML.ЗаписатьНачалоЭлемента("СвПер");//+СвПер
		   // 		ЗаписьXML.ЗаписатьАтрибут("СодОпер", "Товары переданы");
		   //		 ЗаписьXML.ЗаписатьАтрибут("ДатаПер", Формат(ВыборкаДокумент.ДатаИсполнения,"ДФ=дд.ММ.гггг"));

		   //	  ЗаписьXML.ЗаписатьНачалоЭлемента("ОснПер");//+ОснПер
		   // 			   ЗаписьXML.ЗаписатьАтрибут( "НаимОсн", ВыборкаДокумент.ДоговорКонтрагента.Наименование);
		   // 			   ЗаписьXML.ЗаписатьАтрибут( "НомОсн",  ВыборкаДокумент.ДоговорКонтрагента.Номер);
		   // 			   ЗаписьXML.ЗаписатьАтрибут( "ДатаОсн", Формат(ВыборкаДокумент.ДоговорКонтрагента.Дата,"ДФ=дд.ММ.гггг"));
		   //	 ЗаписьXML.ЗаписатьКонецЭлемента();//-ОснПер
		   // 	
		   //   ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПер
		   //ЗаписьXML.ЗаписатьКонецЭлемента();//+СвПродПер

		   
		   			//-----------------------------------------------------------------------------------------------------------
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПродПер");//+СвПродПер

			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПер");//+СвПер
					ЗаписьXML.ЗаписатьАтрибут( "СодОпер", "Товары переданы");
		            ЗаписьXML.ЗаписатьАтрибут( "ДатаПер", Формат(ВыборкаДокумент.ДатаИсполнения,"ДФ=дд.ММ.гггг"));

			     ЗаписьXML.ЗаписатьНачалоЭлемента("ОснПер");//+ОснПер
				           ЗаписьXML.ЗаписатьАтрибут( "НаимОсн", ВыборкаДокумент.ДоговорКонтрагента.Наименование);
				           ЗаписьXML.ЗаписатьАтрибут( "НомОсн",  ВыборкаДокумент.ДоговорКонтрагента.Номер);
						   ЗаписьXML.ЗаписатьАтрибут( "ДатаОсн", Формат(ВыборкаДокумент.ДоговорКонтрагента.Дата,"ДФ=дд.ММ.гггг"));
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ОснПер
				//Если ЗначениеЗаполнено(ВыборкаДокумент.ДоверенностьПредставление) Тогда
				 ЗаписьXML.ЗаписатьНачалоЭлемента("СвЛицПер");//+СвЛицПер
				           ЗаписьXML.ЗаписатьНачалоЭлемента("ИнЛицо");//+ИнЛицо
                               ЗаписьXML.ЗаписатьНачалоЭлемента("ФЛПер");//+ФЛПер
										 ЗаписьXML.ЗаписатьАтрибут( "ОснДоверФЛ", "Доверенность");
                                         ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
										 Если ЗначениеЗаполнено(ВыборкаДокумент.Водитель) Тогда
										      Водитель = РазложитьФИО(ВыборкаДокумент.Водитель);
										      ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Водитель.Фамилия);  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", Водитель.Имя); 
										  Иначе 
											  Сообщить("Нет сведений о водителе!");
											  ЗаписьXML.ЗаписатьАтрибут( "Фамилия", "Отсутствует");  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", "Отсутствует"); 
										  КонецЕсли;	  
										  
                                         ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО						  
						       ЗаписьXML.ЗаписатьКонецЭлемента();//-ФЛПер
						  ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнЛицо
                ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЛицПер
				//Иначе
				//сообщить("Не заполнена доверенность по транспортному маршруту!");
				//КонецЕсли;
				ЗаписьXML.ЗаписатьНачалоЭлемента("ТранГруз");//+ТранГруз
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТранНакл");//+ТранНакл
					          ЗаписьXML.ЗаписатьАтрибут( "НомТранНакл",  ВыборкаДокумент.Номер);
							  ЗаписьXML.ЗаписатьАтрибут( "ДатаТранНакл", Формат(ВыборкаДокумент.ДатаТТН,"ДФ=дд.ММ.гггг"));
	                ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранНакл
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранГруз
				
              ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПер
           ЗаписьXML.ЗаписатьКонецЭлемента();//+СвПродПер

			//-----------------------------------------------------------------------------------------------------------
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
				ЗаписьXML.ЗаписатьАтрибут( "ОблПолн",  "6");
				ЗаписьXML.ЗаписатьАтрибут( "Статус",   "1");
				ЗаписьXML.ЗаписатьАтрибут( "ОснПолн",  "Должностные обязанности");
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
				
					СтруктураПодписант = ОтветственныйПоЭДО(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата);
					
			 		ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
			 		ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Организация.НаименованиеСокращенное);
					
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
					    ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
			
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.Торг12);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
	СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	СтруктураПараметров.Вставить("НастройкаОбмена"		    , Справочники.абс_НастройкиEDIОбмена.НайтиПоНаименованию("Контур"));
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ДокументОтгрузки.Номер);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ДокументОтгрузки.Дата);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры

 
Процедура ВыгрузитьПД_Контур(ДокументОтгрузки, ЕстьОшибки) Экспорт
	
	//проверка наличия с/ф
	
	Если ДокументОтгрузки.ДоговорКонтрагента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером Тогда
		ДатаСФ 	= ДокументОтгрузки.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(ДокументОтгрузки.Ссылка);

	Иначе	
		
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	СчетФактураВыданный.Номер,
		|	СчетФактураВыданный.Дата,
		|	СчетФактураВыданный.Ссылка
		|ИЗ
		|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
		|ГДЕ
		|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
		
		Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
		Результат=Запрос.Выполнить();
		Если Результат.Пустой() Тогда
			Сообщение=Новый СообщениеПользователю;
			Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
			Сообщение.Сообщить();
			ЕстьОшибки = Истина;
			Возврат;
		Иначе
			Выборка 	= Результат.Выбрать();
			Выборка.Следующий();
			ДатаСФ 	= Выборка.Дата;
			НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
		КонецЕсли;
	КонецЕсли;
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	СУММА(ВЫБОР
	|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|				ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
	|			ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
	|		КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20 
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС,
	|	РеализацияТоваровУслугТовары.НомерСтроки,
	|	ВложенныйЗапрос.ЗначениеСвойства КАК НаименованиеПокупателя
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент КАК Контрагент,
	|			абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура КАК Номенклатура,
	|			абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство КАК Свойство,
	|			абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК ЗначениеСвойства
	|		ИЗ
	|			РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ГДЕ
	|			абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НаименованиеНоменклатурыПокупателя)) КАК ВложенныйЗапрос
	|		ПО РеализацияТоваровУслугТовары.Ссылка.Контрагент = ВложенныйЗапрос.Контрагент
	|			И РеализацияТоваровУслугТовары.Номенклатура = ВложенныйЗапрос.Номенклатура
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20 
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.НомерСтроки,
	|	ВложенныйЗапрос.ЗначениеСвойства
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
	|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
	|	Накладная.Ссылка.Сделка.НомерПоДаннымПокупателя КАК НомерПоДаннымПокупателя,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
	|	Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
	|	Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
	|	Накладная.Ссылка.ВалютаДокумента КАК Валюта,
	|	Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
	|	Накладная.Ссылка.Организация КАК Организация,
	|	Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """") КАК НомерМагазина,
	|	Накладная.Ссылка.Грузополучатель КАК Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """") КАК КодПоставщика,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата КАК ДатаТТН,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор) КАК Водитель,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность),
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки) КАК ДатаИсполнения,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI КАК ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ КАК ДатаПоставки,
	|	Накладная.Ссылка.абс_НомерУведомленияОПриемке КАК НомерУведомленияОПриемке,
	|	Накладная.Ссылка.Лео_ДатаУведомленияОПриемке КАК ДатаУведомленияОПриемке,
	|	Накладная.Ссылка.Сделка.ДатаПоДаннымПокупателя КАК ДатаПоДаннымПокупателя,
	|	Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа КАК НомерДокументаEDI
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НомерМагазина)) КАК СвойстваНомераМагазинов
	|		ПО Накладная.Ссылка.Грузополучатель = СвойстваНомераМагазинов.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодПоставщика)) КАК СвойствоКодПоставщика
	|		ПО Накладная.Ссылка.Контрагент = СвойствоКодПоставщика.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Ссылка.Номер,
	|	Накладная.Ссылка.Дата,
	|	Накладная.Ссылка.Сделка.Номер,
	|	Накладная.Ссылка.Сделка.Дата,
	|	Накладная.Ссылка.Организация.абс_GLN,
	|	Накладная.Ссылка.Контрагент.абс_GLN,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
	|	Накладная.Ссылка.Организация.ИНН,
	|	Накладная.Ссылка.Организация.КПП,
	|	Накладная.Ссылка.Организация.Лео_GUID,
	|	Накладная.Ссылка.Контрагент.Лео_GUID,
	|	Накладная.Ссылка.ВалютаДокумента,
	|	Накладная.Ссылка.ВалютаДокумента.Код,
	|	Накладная.Ссылка.Организация,
	|	Накладная.Ссылка.Грузоотправитель,
	|	Накладная.Ссылка.Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """"),
	|	Накладная.Ссылка.Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """"),
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ,
	|	Накладная.Ссылка.Сделка.НомерПоДаннымПокупателя,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)),
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки),
	|	Накладная.Ссылка.абс_НомерУведомленияОПриемке,
	|	Накладная.Ссылка.Лео_ДатаУведомленияОПриемке,
	|	Накладная.Ссылка.Сделка.ДатаПоДаннымПокупателя,
	|	Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СуммаНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование КАК ЕдиницаИзмерения,
	|	Накладная.Цена,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя,
	|	Накладная.Номенклатура.Артикул КАК Артикул,
	|	Накладная.НомерСтроки КАК НомерСтроки,
	|	Накладная.Количество * Накладная.ЕдиницаИзмерения.Коэффициент / Накладная.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент * Накладная.Номенклатура.ЕдиницаХраненияОстатков.Вес КАК МассаНетто,
	|	Накладная.НаименованиеПокупателя
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.СерияНоменклатуры = Штрихкоды.СерияНоменклатуры
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(, ) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование,
	|	Накладная.Цена,
	|	Накладная.СуммаНДС,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства,
	|	Накладная.Номенклатура.Артикул,
	|	Накладная.НомерСтроки,
	|	Накладная.Количество * Накладная.ЕдиницаИзмерения.Коэффициент / Накладная.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент * Накладная.Номенклатура.ЕдиницаХраненияОстатков.Вес,
	|	Накладная.НаименованиеПокупателя
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////		

	Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
		 Идентификатор = ВыборкаДокумент.ОператорEDI.Идентификатор;
	 Иначе
		 Сообщить("Не заполнен оператор EDI");
		 Возврат;
	КонецЕсли;	
	
    НомерОрганизацииВсистеме = ВыборкаДокумент.Организация.ИНН + "-" + "2012052807212505941080000000000";
	
	Если ЗначениеЗаполнено(ВыборкаДокумент.Контрагент.Лео_GUID) Тогда
		НомерКонтрагентаВсистеме = ВыборкаДокумент.Контрагент.ИНН + "-" + СОКРЛП(ВыборкаДокумент.Контрагент.Лео_GUID);
	Иначе
		НомерКонтрагентаВсистеме = ВыборкаДокумент.Контрагент.ИНН + "-" + СОКРЛП(абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ВыборкаДокумент.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Идентификатор участника ЭДО")));
    КонецЕсли;	
	
	////////////////
		
	ИдФайл = "ON_NSCHFDOPPR_" + Идентификатор + "-" + НомерКонтрагентаВсистеме + "_" + Идентификатор + "-" + НомерОрганизацииВсистеме + "_" + Формат(ДатаСФ,"ДФ=ггггММдд") + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор()) ;

    ИмяФайла = "UPD_" + ВыборкаДокумент.Номер + "_" + Формат(ВыборкаДокумент.Дата,"ДФ=ггггММдд");
	
	ИмяФайла = СформироватьИмяФайлаEDI(ИмяФайла);
	ИмяФайла = ИмяФайла + ".xml";

	////////////////////
	
	 
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку( "windows-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
	

		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.01" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Diadoc 1.0" );
		 
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
			ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр",Идентификатор + "-" + НомерОрганизацииВсистеме);
			ЗаписьXML.ЗаписатьАтрибут( "ИдПол", Идентификатор + "-" + НомерКонтрагентаВсистеме);
		   ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.ОператорEDI.Контрагент.ИНН);
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО",   Идентификатор);	
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.ОператорEDI.Наименование,"""","&quot;"));

         ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
			ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115131");
			ЗаписьXML.ЗаписатьАтрибут( "ВремИнфПр", Формат(ТекущаяДата(), "ДФ=ЧЧ.мм.сс"));
			ЗаписьXML.ЗаписатьАтрибут( "ДатаИнфПр", Формат(ТекущаяДата(),"ДФ=дд.ММ.гггг")); // Дата формирования файла обмена СФ
			ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное + ", ИНН-КПП: " + ВыборкаДокумент.Организация.ИНН + "-" + ВыборкаДокумент.Организация.КПП);
		    ЗаписьXML.ЗаписатьАтрибут( "Функция", "ДОП");
			ЗаписьXML.ЗаписатьАтрибут( "ПоФактХЖ", "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
			ЗаписьXML.ЗаписатьАтрибут( "НаимДокОпр", "Универсальный передаточный документ");
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвСчФакт");//+СвСчФакт 
				//ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", НомерСФ);
				//ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") );    
				ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", ВыборкаДокумент.Номер);
				ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг") );   
				
				ЗаписьXML.ЗаписатьАтрибут( "КодОКВ", ВыборкаДокумент.КодВалюты);
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг",ВыборкаДокумент.Организация.НаименованиеСокращенное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;

							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						СведенияОПродавце = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод
				
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОт");//+ГрузОт 
				
				Если ВыборкаДокумент.Организация.ИНН = ВыборкаДокумент.Грузоотправитель.ИНН Тогда
					ЗаписатьXML(ЗаписьXML,"он же","ОнЖе");
				Иначе

					ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОтпр");//+ГрузОтпр

					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Грузоотправитель.НаименованиеПолное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Грузоотправитель.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Грузоотправитель.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузоотправитель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
								
								ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
								ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
								СведенияОГрузоотправитель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузоотправитель,  ВыборкаДокумент.Дата);
								
								ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОтпр
							КонецЕсли;
		
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОт
				СведенияОГрузополучатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузополучатель,  ВыборкаДокумент.Дата);

				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузПолуч");//+ГрузПолуч
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
					          ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
								  Если ЗначениеЗаполнено(ВыборкаДокумент.НомерМагазина) Тогда
									   ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.НомерМагазина);
								   Иначе
									    ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.Грузополучатель.НаименованиеПолное);
								  КонецЕсли;
						           ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОГрузополучатель.ИНН );
							       ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОГрузополучатель.КПП );
							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента);
							Если СтруктураАдреса.Количество() = 0 Тогда
								Сообщить("Не указан " + Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента + " " + ВыборкаДокумент.Грузополучатель);
							    Возврат;
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;

						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
					//////////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузПолуч
				///////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПРД");//+СвПРД

				         ЗаписьXML.ЗаписатьАтрибут( "НомерПРД",  ОбщегоНазначения.ПолучитьНомерНаПечать(ДокументОтгрузки.Ссылка));
                         ЗаписьXML.ЗаписатьАтрибут( "ДатаПРД", Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
						 
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПРД

				//////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Контрагент.НаименованиеПолное);  
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Контрагент.ИНН);  
			 				ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Контрагент.КПП);
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв	
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							СведенияОПокупатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Контрагент,  ВыборкаДокумент.Дата);
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСвФХЖ1");//+ИнфПолФХЖ1
		         ЗаписьXML.ЗаписатьАтрибут( "НаимОКВ", "Российский рубль");
				 ЗаписьXML.ЗаписатьАтрибут( "КурсВал", "1");
				ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ1");//+ИнфПолФХЖ1
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					  ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "Номер_заказа");
					  Номер_Заказа = ?(ЗначениеЗаполнено(ВыборкаДокумент.НомерДокументаEDI),ВыборкаДокумент.НомерДокументаEDI,?(ЗначениеЗаполнено(ВыборкаДокумент.НомерПоДаннымПокупателя),ВыборкаДокумент.НомерПоДаннымПокупателя,ВыборкаДокумент.НомерЗаказа));
					  ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(Номер_Заказа));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					  ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "Дата_заказа");
					  Дата_заказа = ?(ЗначениеЗаполнено(ВыборкаДокумент.ДатаДокументаEDI),ВыборкаДокумент.ДатаДокументаEDI,?(ЗначениеЗаполнено(ВыборкаДокумент.ДатаПоДаннымПокупателя),ВыборкаДокумент.ДатаПоДаннымПокупателя,ВыборкаДокумент.ДатаЗаказа));
					  ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(Дата_заказа,"ДФ=дд.ММ.гггг"));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					
					Если НЕ ВыборкаДокумент.Контрагент.ИНН = "7728551528"  Тогда	  // СпортМастер
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					    ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "Номер_АПП");
						ЗаписьXML.ЗаписатьАтрибут( "Значен",  СокрЛП(ВыборкаДокумент.НомерУведомленияОПриемке));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					
						Если ВыборкаДокумент.Контрагент.Код = "УТ0010060" Тогда 
							Если Не ЗначениеЗаполнено(ВыборкаДокумент.НомерУведомленияОПриемке) Тогда
								 Сообщить("Не указан Номер Акта приема-передачи!");
						    КонецЕсли;		
						КонецЕсли;
					
						ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					    ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "Дата_АПП");
						ЗаписьXML.ЗаписатьАтрибут( "Значен"  ,Формат(ВыборкаДокумент.ДатаУведомленияОПриемке,"ДФ=дд.ММ.гггг"));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					КонецЕсли;
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					     ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "Номер_накладной");
						 ЗаписьXML.ЗаписатьАтрибут( "Значен",   ?(ЗначениеЗаполнено(НомерСФ),НомерСФ,ВыборкаДокумент.Номер));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					     ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "Дата_накладной");
						 ЗаписьXML.ЗаписатьАтрибут( "Значен", Формат(?(ЗначениеЗаполнено(ДатаСФ),ДатаСФ,ВыборкаДокумент.Дата),"ДФ=дд.ММ.гггг"));  
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					  ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "ТолькоУслуги");
					  ЗаписьXML.ЗаписатьАтрибут( "Значен", "false");
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

			    ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвСчФакт
			
			// --------------------ТАБЛИЧНАЯ ЧАСТЬ---------------------
			ЕдиницаEDI = абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ВыборкаДокумент.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Единица EDI"));


			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблСчФакт");//+ТаблСчФакт
				ВыборкаСтрока=Результат[2].Выбрать();
				сч = 1;
				Нетто_Всего =  0;

				Пока ВыборкаСтрока.Следующий() Цикл
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
					ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
					Если НЕ ЗначениеЗаполнено(ВыборкаСтрока.НаименованиеПокупателя) Тогда
						ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.Наименование);	
					Иначе
						
						ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.НаименованиеПокупателя);	
					КонецЕсли;
						ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат(ВыборкаСтрока.СуммаБезНДС + ВыборкаСтрока.СуммаНДС , "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов","796");
						КоэффициентГУДС = 1;
						
						Если ЗначениеЗаполнено(ЕдиницаEDI) Тогда
							 ЕдиницаГУДС = Справочники.ЕдиницыИзмерения.НайтиПоРеквизиту("ЕдиницаПоКлассификатору", ЕдиницаEDI, , ВыборкаСтрока.Номенклатура);
							Попытка
								КоэффициентГУДС = ЕдиницаГУДС.Коэффициент;	
							Исключение
								Сообщить("Для товара не установлена единица EDI (Артикул: " + ВыборкаСтрока.Номенклатура.Артикул + ")" );
							КонецПопытки;	
						      ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество/КоэффициентГУДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
							  ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов", Формат(ВыборкаСтрока.СуммаБезНДС/ВыборкаСтрока.Количество*КоэффициентГУДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						Иначе
						      ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						      ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов", Формат(ВыборкаСтрока.Цена, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						КонецЕсли;
						
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат(ВыборкаСтрока.СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						// Для документов со статусом 2 для спотрмастера НДС не проставляется "-"
						//Если ВыборкаДокумент.Контрагент.ИНН = "7728551528"  Тогда	  // СпортМастер
						//	ЗаписьXML.ЗаписатьАтрибут( "НалСт", "без НДС" );
						//Иначе
							ЗаписьXML.ЗаписатьАтрибут( "НалСт", "" + Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0;" ) + "%" );
						//КонецЕсли;
						Нетто_Всего =  Нетто_Всего + ВыборкаСтрока.МассаНетто;
                        						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Акциз");//+Акциз
							ЗаписатьXML(ЗаписьXML,"без акциза","БезАкциз");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Акциз
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал");//+СумНал;
							ЗаписатьXML(ЗаписьXML,Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНал
						
					
						ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСведТов");//+ДопСведТов
						    ЗаписьXML.ЗаписатьАтрибут( "КодТов", Строка(ВыборкаСтрока.Артикул));
						    ЗаписьXML.ЗаписатьАтрибут( "НаимЕдИзм", Строка(ВыборкаСтрока.ЕдиницаИзмерения));
				        ЗаписьXML.ЗаписатьКонецЭлемента();//-ДопСведТов
						
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
					        Если ВыборкаДокумент.Контрагент.Код = "УТ0010060" Тогда 
					             ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "Штрихкод");
							     ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(ВыборкаСтрока.Штрихкод)));
							Иначе
						        ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "ID товара");
								АртикулПокупателя = СтрЗаменить(ВыборкаСтрока.АртикулПокупателя,"*","");
								Если НЕ ЗначениеЗаполнено(АртикулПокупателя) Тогда
									АртикулПокупателя = лео_ДопФункции.Получить_ЗначениеСвойствНоменклатурыКонтрагентов(ТекущаяДата(), ВыборкаСтрока.Номенклатура, ВыборкаДокумент.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("00000000126"));
								КонецЕсли;	
								Если НЕ ЗначениеЗаполнено(АртикулПокупателя) Тогда
									 сообщить("Не заполнен артикул покупателя в строке " + Строка(ВыборкаСтрока.НомерСтроки));
								КонецЕсли;	
								ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(АртикулПокупателя)));
						    КонецЕсли;		
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2


					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
				КонецЦикла;
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоОпл");//+ВсегоОпл
						  ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",Формат( ДокументОтгрузки.абс_СуммаСНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
				          ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", Формат(ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
						ЗаписатьXML(ЗаписьXML,Формат(ДокументОтгрузки.абс_СуммаСНДС - ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
					ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего
					
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоОпл
 			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблСчФакт
			
		   			//-----------------------------------------------------------------------------------------------------------
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПродПер");//+СвПродПер

			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПер");//+СвПер
					ЗаписьXML.ЗаписатьАтрибут( "СодОпер", "Товары переданы");
		            ЗаписьXML.ЗаписатьАтрибут( "ДатаПер", Формат(ВыборкаДокумент.ДатаИсполнения,"ДФ=дд.ММ.гггг"));

			     ЗаписьXML.ЗаписатьНачалоЭлемента("ОснПер");//+ОснПер
				           ЗаписьXML.ЗаписатьАтрибут( "НаимОсн", ВыборкаДокумент.ДоговорКонтрагента.Наименование);
				           ЗаписьXML.ЗаписатьАтрибут( "НомОсн",  ВыборкаДокумент.ДоговорКонтрагента.Номер);
						   ЗаписьXML.ЗаписатьАтрибут( "ДатаОсн", Формат(ВыборкаДокумент.ДоговорКонтрагента.Дата,"ДФ=дд.ММ.гггг"));
							Если  ТипЗнч(ДокументОтгрузки) = тип("ДокументСсылка.РеализацияТоваровУслуг") и ЗначениеЗаполнено(ДокументОтгрузки.Сделка) тогда 
								Если ЗначениеЗаполнено(ДокументОтгрузки.Сделка.НомерПоДаннымПокупателя) Тогда
						   			ЗаписьXML.ЗаписатьАтрибут( "ДопСвОсн", СокрЛП(ДокументОтгрузки.Сделка.НомерПоДаннымПокупателя));
								КонецЕсли;
							КонецЕсли;
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ОснПер
				 ЗаписьXML.ЗаписатьНачалоЭлемента("СвЛицПер");//+СвЛицПер
				           ЗаписьXML.ЗаписатьНачалоЭлемента("ИнЛицо");//+ИнЛицо
                               ЗаписьXML.ЗаписатьНачалоЭлемента("ФЛПер");//+ФЛПер
										 ЗаписьXML.ЗаписатьАтрибут( "ОснДоверФЛ", "Доверенность");
                                         ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
										 Если ЗначениеЗаполнено(ВыборкаДокумент.Водитель) Тогда
										      Водитель = РазложитьФИО(ВыборкаДокумент.Водитель);
										      ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Водитель.Фамилия);  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", Водитель.Имя); 
										  Иначе 
											  Сообщить("Нет сведений о водителе!");
											  ЗаписьXML.ЗаписатьАтрибут( "Фамилия", "Отсутствует");  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", "Отсутствует"); 
										  КонецЕсли;	  
										  
                                         ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО						  
						       ЗаписьXML.ЗаписатьКонецЭлемента();//-ФЛПер
						  ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнЛицо
                ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЛицПер
				//Иначе
				//сообщить("Не заполнена доверенность по транспортному маршруту!");
				//КонецЕсли;
				//ЗаписьXML.ЗаписатьНачалоЭлемента("ТранГруз");//+ТранГруз
				//	ЗаписьXML.ЗаписатьНачалоЭлемента("ТранНакл");//+ТранНакл
				//			  ЗаписьXML.ЗаписатьАтрибут( "НомТранНакл",  ВыборкаДокумент.Номер);
				//			  ЗаписьXML.ЗаписатьАтрибут( "ДатаТранНакл", Формат(ВыборкаДокумент.ДатаТТН,"ДФ=дд.ММ.гггг"));
				//	ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранНакл
				//ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранГруз
				
              ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПер
           ЗаписьXML.ЗаписатьКонецЭлемента();//+СвПродПер

			//-----------------------------------------------------------------------------------------------------------
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
				ЗаписьXML.ЗаписатьАтрибут( "ОблПолн",  "3");
				ЗаписьXML.ЗаписатьАтрибут( "Статус",   "1");
				ЗаписьXML.ЗаписатьАтрибут( "ОснПолн",  "Должностные обязанности");
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
				
					СтруктураПодписант = ОтветственныйПоЭДО(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата);
					
			 		ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
			 		ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Организация.НаименованиеСокращенное);
					
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
					    ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
			
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.Торг12);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
	СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	СтруктураПараметров.Вставить("НастройкаОбмена"		    , Справочники.абс_НастройкиEDIОбмена.НайтиПоНаименованию("Контур"));
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ДокументОтгрузки.Номер);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ДокументОтгрузки.Дата);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры


Процедура ВыгрузитьУПД_Контур(ДокументОтгрузки, ЕстьОшибки) Экспорт
	//проверка наличия с/ф
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	Иначе
		Выборка 	= Результат.Выбрать();
		Выборка.Следующий();
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
	КонецЕсли;
	
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	СУММА(ВЫБОР
	|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|				ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
	|			ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
	|		КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС,
	|	РеализацияТоваровУслугТовары.НомерСтроки,
	|	СУММА(РеализацияТоваровУслугТовары.Количество * РеализацияТоваровУслугТовары.ЕдиницаИзмерения.Коэффициент / РеализацияТоваровУслугТовары.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент * РеализацияТоваровУслугТовары.Номенклатура.ЕдиницаХраненияОстатков.ВесНетто) КАК СуммаНетто
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.НомерСтроки
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
	|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI КАК НомерДокументаEDIЗаказа,
	|	Накладная.Ссылка.Сделка.ДатаПоДаннымПокупателя КАК ДатаДокументаEDI,
	|	Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
	|	Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
	|	Накладная.Ссылка.ВалютаДокумента КАК Валюта,
	|	Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
	|	Накладная.Ссылка.Организация КАК Организация,
	|	Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """") КАК НомерМагазина,
	|	Накладная.Ссылка.Грузополучатель КАК Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """") КАК КодПоставщика,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.Дата, Накладная.Ссылка.Дата) КАК ДатаТТН,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор) КАК Водитель,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность),
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки) КАК ДатаИсполнения,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI КАК ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ КАК ДатаПоставки
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НомерМагазина)) КАК СвойстваНомераМагазинов
	|		ПО Накладная.Ссылка.Грузополучатель = СвойстваНомераМагазинов.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодПоставщика)) КАК СвойствоКодПоставщика
	|		ПО Накладная.Ссылка.Контрагент = СвойствоКодПоставщика.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Ссылка.Номер,
	|	Накладная.Ссылка.Дата,
	|	Накладная.Ссылка.Сделка.Номер,
	|	Накладная.Ссылка.Сделка.Дата,
	|	Накладная.Ссылка.Организация.абс_GLN,
	|	Накладная.Ссылка.Контрагент.абс_GLN,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
	|	Накладная.Ссылка.Организация.ИНН,
	|	Накладная.Ссылка.Организация.КПП,
	|	Накладная.Ссылка.Организация.Лео_GUID,
	|	Накладная.Ссылка.Контрагент.Лео_GUID,
	|	Накладная.Ссылка.ВалютаДокумента,
	|	Накладная.Ссылка.ВалютаДокумента.Код,
	|	Накладная.Ссылка.Организация,
	|	Накладная.Ссылка.Грузоотправитель,
	|	Накладная.Ссылка.Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """"),
	|	Накладная.Ссылка.Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """"),
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ,
	|	Накладная.Ссылка.Сделка.ДатаПоДаннымПокупателя,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки),
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.Дата, Накладная.Ссылка.Дата),
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СуммаНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование КАК ЕдиницаИзмерения,
	|	Накладная.Цена,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя,
	|	Накладная.Номенклатура.Артикул КАК Артикул,
	|	Накладная.НомерСтроки КАК НомерСтроки,
	|	Накладная.СуммаНетто
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.СерияНоменклатуры = Штрихкоды.СерияНоменклатуры
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(, ) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование,
	|	Накладная.Цена,
	|	Накладная.СуммаНДС,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства,
	|	Накладная.Номенклатура.Артикул,
	|	Накладная.НомерСтроки,
	|	Накладная.СуммаНетто
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	//////////////////////////////////////////////////////////////////////////////////////
	
	Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
		 Идентификатор = ВыборкаДокумент.ОператорEDI.Идентификатор;
	 Иначе	 
		 Идентификатор = "2IH";
	КонецЕсли;	
	
	    НомерОрганизацииВсистеме = ВыборкаДокумент.Организация.ИНН + "-" + "2012052807212505941080000000000";
	
	Если ЗначениеЗаполнено(ВыборкаДокумент.Контрагент.Лео_GUID) Тогда
		НомерКонтрагентаВсистеме = СОКРЛП(ВыборкаДокумент.Контрагент.Лео_GUID);
	Иначе
		НомерКонтрагентаВсистеме = СОКРЛП(абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ВыборкаДокумент.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Идентификатор участника ЭДО")));
    КонецЕсли;	
	
	Если НЕ ЗначениеЗаполнено(ВыборкаДокумент.Контрагент.Лео_GUID) Тогда 
		Сообщить("Не указан GUID контрагента а системе EDI");
	КонецЕсли;	

	//Если НЕ ЛЕВ(НомерКонтрагентаВсистеме,3) = Идентификатор Тогда
	//	 НомерКонтрагентаВсистеме = Идентификатор + "-" + ВыборкаДокумент.Контрагент.ИНН + "-" + НомерКонтрагентаВсистеме;
	//КонецЕсли;
	 
	ИдФайл = "ON_NSCHFDOPPR_" + Идентификатор + "-" + НомерОрганизацииВсистеме +"_" + НомерКонтрагентаВсистеме + "_" + Формат(ДатаСФ,"ДФ=ггггММдд") + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор()) ;

    ИмяФайла = "UPD_" + ВыборкаДокумент.Номер + "_" + Формат(ВыборкаДокумент.Дата,"ДФ=ггггММдд");
	
	ИмяФайла = СформироватьИмяФайлаEDI(ИмяФайла);
	ИмяФайла = ИмяФайла + ".xml";
	
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку( "WINDOWS-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
	
		ЗаписьXML.ЗаписатьАтрибут( "xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance");

		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.01" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Diadoc 1.0" );

		 
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
		ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр",Идентификатор + "-" + НомерОрганизацииВсистеме);
		ЗаписьXML.ЗаписатьАтрибут( "ИдПол", НомерКонтрагентаВсистеме);

		ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
		Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
			ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.ОператорEDI.Наименование);
			ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.ОператорEDI.Контрагент.ИНН);
			ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		Иначе	  
			ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "Систем Групп Рус");
			ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   "7723749362");
			ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		КонецЕсли;
        ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
		ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115131");
		ЗаписьXML.ЗаписатьАтрибут( "Функция", "СЧФДОП");

		ЗаписьXML.ЗаписатьАтрибут( "ПоФактХЖ", "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
		ЗаписьXML.ЗаписатьАтрибут( "НаимДокОпр", "Счет-фактура и документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
		ЗаписьXML.ЗаписатьАтрибут( "ДатаИнфПр", Формат(ТекущаяДата(),"ДФ=дд.ММ.гггг")); // Дата формирования файла обмена СФ
		ЗаписьXML.ЗаписатьАтрибут( "ВремИнфПр", Формат(ТекущаяДата(), "ДФ=ЧЧ.мм.сс"));
		//ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное);
		ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное + ", ИНН-КПП: " + ВыборкаДокумент.Организация.ИНН + "-" + ВыборкаДокумент.Организация.КПП);

			
			//ЗаписьXML.ЗаписатьАтрибут( "ОснДоверОргСост", "Основание доверенности");    // Добавлено 28/07/2017 для Билла ООО
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвСчФакт");//+СвСчФакт 
				ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", НомерСФ);
				ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") );              
				ЗаписьXML.ЗаписатьАтрибут( "КодОКВ", ВыборкаДокумент.КодВалюты);
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИспрСчФ");//+СвСчФакт 
						  ЗаписьXML.ЗаписатьАтрибут( "ДефДатаИспрСчФ", "-");
				          ЗаписьXML.ЗаписатьАтрибут( "ДефНомИспрСчФ", "-");
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ИспрСчФ
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг",ВыборкаДокумент.Организация.НаименованиеСокращенное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						
						СведенияОПродавец = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
						Если ЗначениеЗаполнено(СведенияОПродавец.Телефоны) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПродавец.Телефоны,20));
						КонецЕсли;	
						ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", "mail@leovit.ru");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
						////////////////////////////////////////////						
						СведенияОПродавце = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
						Если ЗначениеЗаполнено(СведенияОПродавце.НомерСчета) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПродавце.НомерСчета);
						КонецЕсли;	   
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
						Если ЗначениеЗаполнено(СведенияОПродавце.БИК) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПродавце.Банк.Наименование);
							ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПродавце.БИК);
						КонецЕсли;	 
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
                         /////////////////////////////
						
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод
				
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОт");//+ГрузОт 
					ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОтпр");//+ГрузОтпр
					ЗаписьXML.ЗаписатьАтрибут( "ОКПО", Строка(ВыборкаДокумент.Грузоотправитель.КодПоОКПО));     

					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
					ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
			    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Грузоотправитель.НаименованиеПолное);  
	 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Грузоотправитель.ИНН);  
					ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Грузоотправитель.КПП);  		
				    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузоотправитель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						СведенияОГрузоотправитель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузоотправитель,  ВыборкаДокумент.Дата);

							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.Телефоны) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузоотправитель.Телефоны,20));
									   КонецЕсли;	
									   ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Грузоотправитель);
									   Если ЗначениеЗаполнено(ЭлПочта) Тогда
											   ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
									   КонецЕсли;
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт

							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.НомерСчета) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузоотправитель.НомерСчета);
									  КонецЕсли;	   
									  ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
									            Если ЗначениеЗаполнено(СведенияОГрузоотправитель.БИК) Тогда
									                 ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузоотправитель.Банк.Наименование);
												     ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузоотправитель.БИК);
													 ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОГрузоотправитель.КоррСчет);
												КонецЕсли;	 
                                      ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв

					ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОтпр
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОт
				
				СведенияОГрузополучатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузополучатель,  ВыборкаДокумент.Дата);

				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузПолуч");//+ГрузПолуч
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						Если ВыборкаДокумент.Контрагент.ЮрФизЛицо  = Перечисления.ЮрФизЛицо.ЮрЛицо  Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
							Если ЗначениеЗаполнено(ВыборкаДокумент.НомерМагазина) Тогда
								ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.НомерМагазина);
							Иначе
								ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.Грузополучатель.НаименованиеПолное);
							КонецЕсли;
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОГрузополучатель.ИНН );
							ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОГрузополучатель.КПП );
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
						Иначе
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвИП");//+СвИП
							ЗаписьXML.ЗаписатьАтрибут( "ИННФЛ", ВыборкаДокумент.Грузополучатель.ИНН);  

							ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
							МассивФИО = СтрРазделить(СтрЗаменить(ВыборкаДокумент.Контрагент.НаименованиеПолное,"ИП ",""), " ");
							Попытка
								Фамилия = МассивФИО[0];
								Имя =  МассивФИО[1];
								Отчество = МассивФИО[2];
							Исключение
								Фамилия = ВыборкаДокумент.Контрагент.НаименованиеПолное;
								Имя =  "";
								Отчество = "";
							КонецПопытки;
							
							ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Фамилия);  
							ЗаписьXML.ЗаписатьАтрибут( "Имя",Имя); 
							ЗаписьXML.ЗаписатьАтрибут( "Отчество", Отчество);
							
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвИП
							
						КонецЕсли;  
							  
							  
							  
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
						Если ВыборкаДокумент.Грузополучатель.Код = "УТ0003623" Тогда   // Система К
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
						Иначе	
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента);
						КонецЕсли;	
						Если СтруктураАдреса.Количество() = 0 Тогда
							Сообщить("Не указан " + Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента + " " + ВыборкаДокумент.Грузополучатель);
							    Возврат;
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;

						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
					//////////////////////////////////////////////////////////////////////
					
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.Телефоны) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузополучатель.Телефоны,20));
							КонецЕсли;	
							ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Грузополучатель);
							Если ЗначениеЗаполнено(ЭлПочта) Тогда
								Если НЕ ВыборкаДокумент.Контрагент.Код = "УТ0003623" Тогда // Для Система-К не передаем
									ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
								КонецЕсли;
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.НомерСчета) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузополучатель.НомерСчета);
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.БИК) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузополучатель.Банк.Наименование);
								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузополучатель.БИК);
								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОГрузополучатель.КоррСчет);
							КонецЕсли;	 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
					
					//////////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузПолуч
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
					Если ВыборкаДокумент.Контрагент.ЮрФизЛицо  = Перечисления.ЮрФизЛицо.ЮрЛицо  Тогда
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
						ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Контрагент.НаименованиеПолное);  
						ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Контрагент.ИНН);
						Если ВыборкаДокумент.Контрагент.ИНН="7802687430" И ЗначениеЗаполнено(ВыборкаДокумент.Грузополучатель) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Грузополучатель.КПП); 
						Иначе
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Контрагент.КПП);
						КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					Иначе
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвИП");//+СвИП
							ЗаписьXML.ЗаписатьАтрибут( "ИННФЛ", ВыборкаДокумент.Контрагент.ИНН);  

							ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
							МассивФИО = СтрРазделить(СтрЗаменить(ВыборкаДокумент.Контрагент.НаименованиеПолное,"ИП ",""), " ");
	                               Попытка
	                               Фамилия = МассивФИО[0];
                                   Имя =  МассивФИО[1];
                                   Отчество = МассивФИО[2];
							   Исключение
								   Фамилия = ВыборкаДокумент.Контрагент.НаименованиеПолное;
                                   Имя =  "";
                                   Отчество = "";
								   КонецПопытки;
								
						          ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Фамилия);  
			 			          ЗаписьXML.ЗаписатьАтрибут( "Имя",Имя); 
					              ЗаписьXML.ЗаписатьАтрибут( "Отчество", Отчество);
								  
			                    ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО

 		                    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвИП
					КонецЕсли;	
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
                        ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							СведенияОПокупатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Контрагент,  ВыборкаДокумент.Дата);
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							Если ЗначениеЗаполнено(СведенияОПокупатель.Телефоны) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПокупатель.Телефоны,20));
							КонецЕсли;	
							ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Контрагент);
							Если ЗначениеЗаполнено(ЭлПочта) Тогда
								Если НЕ ВыборкаДокумент.Контрагент.Код = "УТ0003623" Тогда // Для Система-К не передаем
									ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
								КонецЕсли;
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							Если ЗначениеЗаполнено(СведенияОПокупатель.НомерСчета) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПокупатель.НомерСчета);
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							Если ЗначениеЗаполнено(СведенияОПокупатель.БИК) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПокупатель.Банк.Наименование);
								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПокупатель.БИК);
								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОПокупатель.КоррСчет);
							КонецЕсли;	 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
				
					ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСвФХЖ1");//+ИнфПолФХЖ1
		         ЗаписьXML.ЗаписатьАтрибут( "НаимОКВ", "Российский рубль");
				 ЗаписьXML.ЗаписатьАтрибут( "КурсВал", "1");
				ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
				
				//////////////////////////////////////////////////////////////
				//Постановление 534}
				ДокументыОбОтгрузке = "";
				ИтогоСтрок =0;
				Если Выборка.Ссылка.Дата >= Дата("20241001") Тогда  
				     ДокументыОбОтгрузке = "Универсальный передаточный документ, №" + НомерСФ + " от " + Формат(ДатаСФ, "ДЛФ='Д'") + " г.";  
				Иначе	
					Для Каждого СтрДокОснования Из Выборка.Ссылка.ДокументыОснования Цикл
						// Получить экземпляр документа на печать
						
						Если НЕ ЗначениеЗаполнено(СтрДокОснования.ДокументОснование) Тогда
							Продолжить;
						КонецЕсли;
						
						ДокументыОбОтгрузке = ?(ЗначениеЗаполнено(ДокументыОбОтгрузке),ДокументыОбОтгрузке + "; ","");
						ПерваяСтрокаПоДокументуОтгрузки = 1;
						ПоследняяСтрокаПоДокументуОтгрузки = СтрДокОснования.ДокументОснование.Товары.Количество();
						Если ПерваяСтрокаПоДокументуОтгрузки = ПоследняяСтрокаПоДокументуОтгрузки Тогда
							ДиапазонСтрок = "" + Строка(ПерваяСтрокаПоДокументуОтгрузки + ИтогоСтрок);
						Иначе
							ДиапазонСтрок = "" + Строка(ПерваяСтрокаПоДокументуОтгрузки + ИтогоСтрок) + "-" + Строка(ПоследняяСтрокаПоДокументуОтгрузки + ИтогоСтрок);
						КонецЕсли;
						ИтогоСтрок =  ИтогоСтрок + ПоследняяСтрокаПоДокументуОтгрузки;
						ДокументыОбОтгрузке = ДокументыОбОтгрузке + "п/п " + ДиапазонСтрок + " Универсальный передаточный документ, №" + НомерСФ + " от " + Формат(СтрДокОснования.ДокументОснование.Дата, "ДЛФ='Д'") + " г.";  
					КонецЦикла;	
				КонецЕсли;
				
				/////////////////////////////////////////////////////////////
				//Постановление 534}	

				 ЗаписьXML.ЗаписатьНачалоЭлемента("ДокПодтвОтгр");//+ДокПодтвОтгр
				 
				 ЗаписьXML.ЗаписатьАтрибут( "НаимДокОтгр", "Товарная накладная");
				 //ЗаписьXML.ЗаписатьАтрибут( "НомДокОтгр", ВыборкаДокумент.Номер);
				 ЗаписьXML.ЗаписатьАтрибут( "НомДокОтгр", ДокументыОбОтгрузке);

				 ЗаписьXML.ЗаписатьАтрибут( "ДатаДокОтгр",  Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
				 
                 ЗаписьXML.ЗаписатьКонецЭлемента(); // ДокПодтвОтгр
				 
				Если ВыборкаДокумент.Организация.ИНН="7713204095" Тогда 
			    	GLN_Отправителя	= "4607041069995";
				Иначе
			    	GLN_Отправителя	= "4607932679999"
                КонецЕсли;
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ1");//+ИнфПолФХЖ1
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "отправитель");
						ЗаписьXML.ЗаписатьАтрибут( "Значен",  GLN_Отправителя);
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					///////////////////////////////////////////////////////////////////////////////////////////////////////
				Если ЗначениеЗаполнено(ВыборкаДокумент.Грузоотправитель.абс_GLN) Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузоотправитель");
					ЗаписьXML.ЗаписатьАтрибут( "Значен",  ВыборкаДокумент.Грузоотправитель.абс_GLN);
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф  
				КонецЕсли;
				//	
				//	///////////////////////////////////////////////////////////////////////////////////////////////////////
				//	ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
				//		ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "получатель");
				//			ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNКонтрагента));
				//ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				//	
				//	////////////////////////////////////////////////////////////////////////////////////////////////////////
				//	ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
				//		ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузополучатель");
				//		ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
				//	ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				//	////////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_заказа");
			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ВыборкаДокумент.ДатаДокументаEDI,"ДФ=дд.ММ.гггг"));
						//ДатаПоДаннымПокупателя
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					Если ЗначениеЗаполнено(ВыборкаДокумент.НомерДокументаEDIЗаказа) Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
					ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					КонецЕсли;
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_накладной");
							//+++ Жигалев 26.04.2024
							Если ДокументОтгрузки.Контрагент.Код = "К00000648" тогда //СВИСС КРОНО  Письмо Глуховой Светланы 24.04.2024 17:00
								ЗаписьXML.ЗаписатьАтрибут( "Значен", НомерСФ); // Жигалев 
							иначе        
							//--- Жигалев	
								ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ДокументОтгрузки.Номер));
							КонецЕсли;
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_накладной");
			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ДатаСФ,"ДФ=дд.ММ.гггг")); 
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					//ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ИнфПолСтр
					//	ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_акта");
					//	ЗаписьXML.ЗаписатьАтрибут( "Значен", ?(ЗначениеЗаполнено(ДокументОтгрузки.абс_НомерУведомленияОПриемке),ДокументОтгрузки.абс_НомерУведомленияОПриемке,"б/н"));
					//ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр
					//////////////////////////////////////////////////////////////////////////////////////////////////////////
					//ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					//	ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_поставщика");
					// 	ЗаписьXML.ЗаписатьАтрибут( "Значен",УдалитьЛидирующиеНули(ВыборкаДокумент.КодПоставщика));
					//ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

		 		ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
				
			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвСчФакт
			
			// --------------------ТАБЛИЧНАЯ ЧАСТЬ---------------------

			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблСчФакт");//+ТаблСчФакт
			    КолНетто = 0;
			    ВыборкаСтрока=Результат[2].Выбрать();
				сч = 1;
				Пока ВыборкаСтрока.Следующий() Цикл
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.НаименованиеПолное);	
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов","796");
					    ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов",  Формат(ВыборкаСтрока.Цена, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат( ВыборкаСтрока.СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат( ВыборкаСтрока.СуммаБезНДС + ВыборкаСтрока.СуммаНДС , "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "НалСт", "" + Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0;" ) + "%" );
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Акциз");//+Акциз
							ЗаписатьXML(ЗаписьXML,"без акциза","БезАкциз");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Акциз
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал");//+СумНал;
							ЗаписатьXML(ЗаписьXML,Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНал
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСведТов");//+ДопСведТов
						ЗаписьXML.ЗаписатьАтрибут( "ПрТовРаб", "1");
						ЗаписьXML.ЗаписатьАтрибут( "КодТов", СокрЛП(Строка(ВыборкаСтрока.Штрихкод)));
						ЗаписьXML.ЗаписатьАтрибут( "НаимЕдИзм", Строка(ВыборкаСтрока.ЕдиницаИзмерения)); 
						
						ЗначениеОКПД2	= лео_ДопФункции.Получить_ЗначенияСвойствОбъектов(ВыборкаСтрока.Номенклатура, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("00000000066"));
						Если ЗначениеЗаполнено(ЗначениеОКПД2) И ТипЗнч(ЗначениеОКПД2)=Тип("СправочникСсылка.Лео_КлассификаторОКПД2") Тогда 
							Если ЗначениеОКПД2.ЧестныйЗнак Тогда
								ЗаписьXML.ЗаписатьНачалоЭлемента("НомСредИдентТов");//+НомСредИдентТов 
								//{Катанович
								//ЗаписатьXML(ЗаписьXML,лео_ДопФункции.ПолучитьGTINпоНоменклатуре(ВыборкаСтрока.Номенклатура)+"37"+Строка(ВыборкаСтрока.Количество),"НомУпак");  
							    НомУпаковки = НовыйКодОСУ(лео_ДопФункции.ПолучитьGTINпоНоменклатуре(ВыборкаСтрока.Номенклатура),ВыборкаСтрока.Количество);	
								ЗаписатьXML(ЗаписьXML,НомУпаковки,"НомУпак");  
								ЗаписьXML.ЗаписатьКонецЭлемента();//-НомСредИдентТов    
								//Катанович}
							КонецЕсли;
						КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ДопСведТов
						
						Если ЗначениеЗаполнено(ВыборкаДокумент.НомерДокументаEDIЗаказа) Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						КонецЕсли;
						Если ЗначениеЗаполнено(ВыборкаСтрока.АртикулПокупателя) Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала");
							АртикулПокупателя = СтрЗаменить(ВыборкаСтрока.АртикулПокупателя,"*","");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(АртикулПокупателя)));
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала_заказчика");
							АртикулПокупателя = СтрЗаменить(ВыборкаСтрока.АртикулПокупателя,"*","");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(АртикулПокупателя)));
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						КонецЕсли;
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_уведомления_об_отгрузке");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерУведомленияОбОтгрузке));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "штрихкод");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(ВыборкаСтрока.Штрихкод)));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2

                        ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_продавца");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(ВыборкаСтрока.Артикул)));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						
						СтрокаGTIN = лео_ДопФункции.ПолучитьGTINпоНоменклатуре(ВыборкаСтрока.Номенклатура);
						Если ЗначениеЗаполнено(СтрокаGTIN) И НЕ СтрокаGTIN="--------------" Тогда
                        ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "GTIN");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(СтрокаGTIN)));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2 
						КонецЕсли;

					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
					КолНетто = КолНетто + ВыборкаСтрока.СуммаНетто;
				КонецЦикла;
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоОпл");//+ВсегоОпл
					ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", Формат(ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
		 			ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",Формат( ДокументОтгрузки.абс_СуммаСНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
						ЗаписатьXML(ЗаписьXML,Формат(ДокументОтгрузки.абс_СуммаСНДС - ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
					ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего

				    ЗаписатьXML(ЗаписьXML,Формат(КолНетто, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"КолНеттоВс");

				ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоОпл
 			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблСчФакт
			
			//-----------------------------------------------------------------------------------------------------------
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПродПер");//+СвПродПер

			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПер");//+СвПер
					ЗаписьXML.ЗаписатьАтрибут( "СодОпер", "Товары переданы");
		            ЗаписьXML.ЗаписатьАтрибут( "ДатаПер", Формат(ВыборкаДокумент.ДатаИсполнения,"ДФ=дд.ММ.гггг"));

			     ЗаписьXML.ЗаписатьНачалоЭлемента("ОснПер");//+ОснПер
				           ДокОснование   = ВыборкаДокумент.ДоговорКонтрагента.Наименование;
						   НомерОснования =  ВыборкаДокумент.ДоговорКонтрагента.Номер;
						   ДатаОснования  = Формат(ВыборкаДокумент.ДоговорКонтрагента.Дата,"ДФ=дд.ММ.гггг");
						   Если ЗначениеЗаполнено(ДокОснование) и ЗначениеЗаполнено(НомерОснования) и ЗначениеЗаполнено(ДатаОснования) Тогда  
				                ЗаписьXML.ЗаписатьАтрибут( "НаимОсн", ДокОснование);
				                ЗаписьXML.ЗаписатьАтрибут( "НомОсн",  НомерОснования);
						        ЗаписьXML.ЗаписатьАтрибут( "ДатаОсн", ДатаОснования);
							Иначе
								ЗаписьXML.ЗаписатьАтрибут( "НаимОсн", "Без документа-основания");
						   КонецЕсли;	
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ОснПер
				 ЗаписьXML.ЗаписатьНачалоЭлемента("СвЛицПер");//+СвЛицПер
				           ЗаписьXML.ЗаписатьНачалоЭлемента("ИнЛицо");//+ИнЛицо
                               ЗаписьXML.ЗаписатьНачалоЭлемента("ФЛПер");//+ФЛПер
										 ЗаписьXML.ЗаписатьАтрибут( "ОснДоверФЛ", "Доверенность");
                                         ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
										 Если ЗначениеЗаполнено(ВыборкаДокумент.Водитель) Тогда
										      Водитель = РазложитьФИО(ВыборкаДокумент.Водитель);
										      ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Водитель.Фамилия);  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", Водитель.Имя); 
										  Иначе 
											  Сообщить("Нет сведений о водителе!");
											  ЗаписьXML.ЗаписатьАтрибут( "Фамилия", "Отсутствует");  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", "Отсутствует"); 
										  КонецЕсли;	  
										  
                                         ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО						  
						       ЗаписьXML.ЗаписатьКонецЭлемента();//-ФЛПер
						  ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнЛицо
                ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЛицПер
				ЗаписьXML.ЗаписатьНачалоЭлемента("ТранГруз");//+ТранГруз
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТранНакл");//+ТранНакл
					          ЗаписьXML.ЗаписатьАтрибут( "НомТранНакл",  ВыборкаДокумент.Номер);
							  ЗаписьXML.ЗаписатьАтрибут( "ДатаТранНакл", Формат(ВыборкаДокумент.ДатаТТН,"ДФ=дд.ММ.гггг"));
	                ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранНакл
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранГруз
				
              ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПер
           ЗаписьXML.ЗаписатьКонецЭлемента();//+СвПродПер

			//-----------------------------------------------------------------------------------------------------------
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
				ЗаписьXML.ЗаписатьАтрибут( "ОблПолн",  "6");
				ЗаписьXML.ЗаписатьАтрибут( "Статус",   "1");
				ЗаписьXML.ЗаписатьАтрибут( "ОснПолн",  "Должностные обязанности");
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
				
					СтруктураПодписант = ОтветственныйПоЭДО(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата);
					
			 		ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
					    ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
			
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.УПД);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
    СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	СтруктураПараметров.Вставить("НастройкаОбмена"		    , Справочники.абс_НастройкиEDIОбмена.НайтиПоНаименованию("Контур"));
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ДокументОтгрузки.Номер);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ДокументОтгрузки.Дата);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры

Процедура ВыгрузитьУПД_Контур_970(ДокументОтгрузки, ЕстьОшибки, ФункИспр) Экспорт       //формат с 01.04.2025
	//проверка наличия с/ф
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки
	|	И СчетФактураВыданный.Проведен";
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
	Результат=Запрос.Выполнить();
	Выборка 	= Результат.Выбрать();
	Выборка.Следующий();
	Если ДокументОтгрузки.Организация.ИНН="7715889630" Тогда       //"Эйкос"
		ДатаСФ 	= ДокументОтгрузки.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(ДокументОтгрузки.Ссылка);
	ИначеЕсли ДокументОтгрузки.Контрагент.ИНН="9714053621" И Выборка.Количество()=0 Тогда       //РВБ проверяем наличие СФ
		ДатаСФ 	= ДокументОтгрузки.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(ДокументОтгрузки.Ссылка);
	ИначеЕсли ДокументОтгрузки.Контрагент.ИНН="7728551528"       //ООО "Спортмастер"
		ИЛИ ДокументОтгрузки.Контрагент.ИНН="6312203688" Тогда       //АГРЕГАТОР ООО
		ДатаСФ 	= ДокументОтгрузки.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(ДокументОтгрузки.Ссылка);
	ИначеЕсли Результат.Пустой() Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	Иначе
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
	КонецЕсли;
	
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	СУММА(ВЫБОР
	|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|				ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
	|			ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
	|		КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС,
	|	РеализацияТоваровУслугТовары.НомерСтроки,
	|	СУММА(РеализацияТоваровУслугТовары.Количество * РеализацияТоваровУслугТовары.ЕдиницаИзмерения.Коэффициент / РеализацияТоваровУслугТовары.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент * РеализацияТоваровУслугТовары.Номенклатура.ЕдиницаХраненияОстатков.ВесНетто) КАК СуммаНетто
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.НомерСтроки
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
	|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI КАК НомерДокументаEDIЗаказа,
	|	Накладная.Ссылка.Сделка.ДатаПоДаннымПокупателя КАК ДатаДокументаEDI,
	|	Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
	|	Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
	|	Накладная.Ссылка.ВалютаДокумента КАК Валюта,
	|	Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
	|	Накладная.Ссылка.Организация КАК Организация,
	|	Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """") КАК НомерМагазина,
	|	Накладная.Ссылка.Грузополучатель КАК Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """") КАК КодПоставщика,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.Дата, Накладная.Ссылка.Дата) КАК ДатаТТН,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор) КАК Водитель,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность),
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки) КАК ДатаИсполнения,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI КАК ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ КАК ДатаПоставки
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НомерМагазина)) КАК СвойстваНомераМагазинов
	|		ПО Накладная.Ссылка.Грузополучатель = СвойстваНомераМагазинов.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодПоставщика)) КАК СвойствоКодПоставщика
	|		ПО Накладная.Ссылка.Контрагент = СвойствоКодПоставщика.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Ссылка.Номер,
	|	Накладная.Ссылка.Дата,
	|	Накладная.Ссылка.Сделка.Номер,
	|	Накладная.Ссылка.Сделка.Дата,
	|	Накладная.Ссылка.Организация.абс_GLN,
	|	Накладная.Ссылка.Контрагент.абс_GLN,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
	|	Накладная.Ссылка.Организация.ИНН,
	|	Накладная.Ссылка.Организация.КПП,
	|	Накладная.Ссылка.Организация.Лео_GUID,
	|	Накладная.Ссылка.Контрагент.Лео_GUID,
	|	Накладная.Ссылка.ВалютаДокумента,
	|	Накладная.Ссылка.ВалютаДокумента.Код,
	|	Накладная.Ссылка.Организация,
	|	Накладная.Ссылка.Грузоотправитель,
	|	Накладная.Ссылка.Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """"),
	|	Накладная.Ссылка.Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """"),
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ,
	|	Накладная.Ссылка.Сделка.ДатаПоДаннымПокупателя,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки),
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.Дата, Накладная.Ссылка.Дата),
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СуммаНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование КАК ЕдиницаИзмерения,
	|	Накладная.Цена,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя,
	|	Накладная.Номенклатура.Артикул КАК Артикул,
	|	Накладная.НомерСтроки КАК НомерСтроки,
	|	Накладная.СуммаНетто
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.СерияНоменклатуры = Штрихкоды.СерияНоменклатуры
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(, ) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование,
	|	Накладная.Цена,
	|	Накладная.СуммаНДС,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства,
	|	Накладная.Номенклатура.Артикул,
	|	Накладная.НомерСтроки,
	|	Накладная.СуммаНетто
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	//////////////////////////////////////////////////////////////////////////////////////
	
	Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
		 Идентификатор = ВыборкаДокумент.ОператорEDI.Идентификатор;
	 Иначе	 
		 Идентификатор = "2IH";
	КонецЕсли;	
	
	    НомерОрганизацииВсистеме = ВыборкаДокумент.Организация.ИНН + "-" + "2012052807212505941080000000000";
	
	Если ЗначениеЗаполнено(ВыборкаДокумент.Контрагент.Лео_GUID) Тогда
		НомерКонтрагентаВсистеме = СОКРЛП(ВыборкаДокумент.Контрагент.Лео_GUID);
	Иначе
		НомерКонтрагентаВсистеме = СОКРЛП(абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ВыборкаДокумент.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Идентификатор участника ЭДО")));
    КонецЕсли;	
	
	Если НЕ ЗначениеЗаполнено(ВыборкаДокумент.Контрагент.Лео_GUID) Тогда 
		Сообщить("Не указан GUID контрагента а системе EDI");
	КонецЕсли;	

	//Если НЕ ЛЕВ(НомерКонтрагентаВсистеме,3) = Идентификатор Тогда
	//	 НомерКонтрагентаВсистеме = Идентификатор + "-" + ВыборкаДокумент.Контрагент.ИНН + "-" + НомерКонтрагентаВсистеме;
	//КонецЕсли;
	
	//необходимо для версии 5.03   
	ПризнакМаркировки	=	НаличиеМаркированнойПродукции(ДокументОтгрузки);
	ДопСтрока	= ?(ПризнакМаркировки,"_0_1_0_0_0_00","_0_0_0_0_0_00");	
	
	ИдФайл = "ON_NSCHFDOPPR_" + Идентификатор + "-" + НомерОрганизацииВсистеме +"_" + НомерКонтрагентаВсистеме + "_" + Формат(ДатаСФ,"ДФ=ггггММдд") + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор())+ДопСтрока ;

    ИмяФайла = "UPD_" + ВыборкаДокумент.Номер + "_" + Формат(ВыборкаДокумент.Дата,"ДФ=ггггММдд");
	
	ИмяФайла = СформироватьИмяФайлаEDI(ИмяФайла);
	ИмяФайла = ИмяФайла + ".xml";
	
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку( "WINDOWS-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
	
		//ЗаписьXML.ЗаписатьАтрибут( "xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance");

		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.03" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Diadoc 1.0" );

		//не используется 
		//ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
		//ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр",Идентификатор + "-" + НомерОрганизацииВсистеме);
		//ЗаписьXML.ЗаписатьАтрибут( "ИдПол", НомерКонтрагентаВсистеме);

		//ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
		//Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
		//	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.ОператорEDI.Наименование);
		//	ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.ОператорEDI.Контрагент.ИНН);
		//	ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		//Иначе	  
		//	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "Систем Групп Рус");
		//	ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   "7723749362");
		//	ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		//КонецЕсли;
		//ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		//ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		

		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
		ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115131"); 
		
		Если ВыборкаДокумент.Контрагент.ИНН="7728551528" ИЛИ ВыборкаДокумент.Контрагент.ИНН="9729777779"  
			ИЛИ ВыборкаДокумент.Контрагент.ИНН="9701048328" ИЛИ ВыборкаДокумент.Контрагент.ИНН="6312203688" Тогда
		    ЗаписьXML.ЗаписатьАтрибут( "Функция", "ДОП");
		ИначеЕсли ВыборкаДокумент.Контрагент.ИНН="9714053621" И Выборка.Количество()=0 Тогда  //РВБ проверяем наличие СФ
		    ЗаписьXML.ЗаписатьАтрибут( "Функция", "ДОП");
		ИначеЕсли ВыборкаДокумент.Организация.ИНН="7715889630" Тогда
		    ЗаписьXML.ЗаписатьАтрибут( "Функция", "ДОП");
		Иначе
			ЗаписьXML.ЗаписатьАтрибут( "Функция", "СЧФДОП");
		КонецЕсли;

		ЗаписьXML.ЗаписатьАтрибут( "ПоФактХЖ", "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
		ЗаписьXML.ЗаписатьАтрибут( "НаимДокОпр", "Универсальный передаточный документ");
		ЗаписьXML.ЗаписатьАтрибут( "ДатаИнфПр", Формат(ТекущаяДата(),"ДФ=дд.ММ.гггг")); // Дата формирования файла обмена СФ
		ЗаписьXML.ЗаписатьАтрибут( "ВремИнфПр", Формат(ТекущаяДата(), "ДФ=ЧЧ.мм.сс"));
		//ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное);
		ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное + ", ИНН-КПП: " + ВыборкаДокумент.Организация.ИНН + "-" + ВыборкаДокумент.Организация.КПП);

			
			//ЗаписьXML.ЗаписатьАтрибут( "ОснДоверОргСост", "Основание доверенности");    // Добавлено 28/07/2017 для Билла ООО
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвСчФакт");//+СвСчФакт 
				ЗаписьXML.ЗаписатьАтрибут( "НомерДок", НомерСФ);
				ЗаписьXML.ЗаписатьАтрибут( "ДатаДок",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") ); 
				Если ФункИспр="Испр" Тогда
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИспрДок");//+СвСчФакт 
						  ЗаписьXML.ЗаписатьАтрибут( "НомИспр", "1");
				          ЗаписьXML.ЗаписатьАтрибут( "ДатаИспр", Формат(ДатаСФ,"ДФ=дд.ММ.гггг"));
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ИспрСчФ
				КонецЕсли;
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг",ВыборкаДокумент.Организация.НаименованиеСокращенное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								ЗаписьXML.ЗаписатьАтрибут( "НаимРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						
						СведенияОПродавец = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						
						//ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
						//Если ЗначениеЗаполнено(СведенияОПродавец.Телефоны) Тогда
						//	ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПродавец.Телефоны,20));
						//КонецЕсли;	
						//ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", "mail@leovit.ru");
						//ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
						////////////////////////////////////////////						
						СведенияОПродавце = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
						Если ЗначениеЗаполнено(СведенияОПродавце.НомерСчета) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПродавце.НомерСчета);
						КонецЕсли;	   
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
						Если ЗначениеЗаполнено(СведенияОПродавце.БИК) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПродавце.Банк.Наименование);
							ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПродавце.БИК);
						КонецЕсли;	 
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
                         /////////////////////////////
						
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод

				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОт");//+ГрузОт 
					ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОтпр");//+ГрузОтпр
					ЗаписьXML.ЗаписатьАтрибут( "ОКПО", Строка(ВыборкаДокумент.Грузоотправитель.КодПоОКПО));     

					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
					ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
			    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Грузоотправитель.НаименованиеПолное);  
	 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Грузоотправитель.ИНН);  
					ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Грузоотправитель.КПП);  		
				    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузоотправитель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
									ЗаписьXML.ЗаписатьАтрибут( "НаимРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						СведенияОГрузоотправитель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузоотправитель,  ВыборкаДокумент.Дата);

							//ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							//          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.Телефоны) Тогда
							//               ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузоотправитель.Телефоны,20));
							//		   КонецЕсли;	
							//		   ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Грузоотправитель);
							//		   Если ЗначениеЗаполнено(ЭлПочта) Тогда
							//				   ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
							//		   КонецЕсли;
							//ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт

							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.НомерСчета) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузоотправитель.НомерСчета);
									  КонецЕсли;	   
									  ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
									            Если ЗначениеЗаполнено(СведенияОГрузоотправитель.БИК) Тогда
									                 ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузоотправитель.Банк.Наименование);
												     ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузоотправитель.БИК);
													 ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОГрузоотправитель.КоррСчет);
												КонецЕсли;	 
                                      ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв

					ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОтпр
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОт
				
				СведенияОГрузополучатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузополучатель,  ВыборкаДокумент.Дата);
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузПолуч");//+ГрузПолуч
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						Если ВыборкаДокумент.Контрагент.ЮрФизЛицо  = Перечисления.ЮрФизЛицо.ЮрЛицо  Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
							Если ЗначениеЗаполнено(ВыборкаДокумент.НомерМагазина) Тогда
								ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.НомерМагазина);
							Иначе
								ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.Грузополучатель.НаименованиеПолное);
							КонецЕсли;
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОГрузополучатель.ИНН );
							ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОГрузополучатель.КПП );
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
						Иначе
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвИП");//+СвИП
							ЗаписьXML.ЗаписатьАтрибут( "ИННФЛ", ВыборкаДокумент.Грузополучатель.ИНН);  

							ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
							МассивФИО = СтрРазделить(СтрЗаменить(ВыборкаДокумент.Контрагент.НаименованиеПолное,"ИП ",""), " ");
							Попытка
								Фамилия = МассивФИО[0];
								Имя =  МассивФИО[1];
								Отчество = МассивФИО[2];
							Исключение
								Фамилия = ВыборкаДокумент.Контрагент.НаименованиеПолное;
								Имя =  "";
								Отчество = "";
							КонецПопытки;
							
							ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Фамилия);  
							ЗаписьXML.ЗаписатьАтрибут( "Имя",Имя); 
							ЗаписьXML.ЗаписатьАтрибут( "Отчество", Отчество);
							
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвИП
							
						КонецЕсли;  
							  
							  
							  
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
						Если ВыборкаДокумент.Грузополучатель.Код = "УТ0003623" Тогда   // Система К
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
						Иначе	
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента);
						КонецЕсли;	
						Если СтруктураАдреса.Количество() = 0 Тогда
							Сообщить("Не указан " + Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента + " " + ВыборкаДокумент.Грузополучатель +" документ не выгружен");
							Возврат;
						КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								ЗаписьXML.ЗаписатьАтрибут( "НаимРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;

						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
					//////////////////////////////////////////////////////////////////////
						//ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
						//Если ЗначениеЗаполнено(СведенияОГрузополучатель.Телефоны) Тогда
						//	ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузополучатель.Телефоны,20));
						//КонецЕсли;	
						//ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Грузополучатель);
						//Если ЗначениеЗаполнено(ЭлПочта) Тогда
						//	Если НЕ ВыборкаДокумент.Контрагент.Код = "УТ0003623" Тогда // Для Система-К не передаем
						//		ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
						//	КонецЕсли;
						//КонецЕсли;
						//ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.НомерСчета) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузополучатель.НомерСчета);
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.БИК) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузополучатель.Банк.Наименование);
								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузополучатель.БИК);
								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОГрузополучатель.КоррСчет);
							КонецЕсли;	 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
					
					//////////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузПолуч
				
////////////////////////////////////////////////////////////////////////////////////////				
				//В соответствии с Приказом ФНС РФ от 19.12.2023 N ЕД-7-26/970, в УПД строка 5а заполняется значением "тот же". Других значений в этой строке формат не предусматривает.
				ДокументыОбОтгрузке = "Универсальный передаточный документ";  
				ЗаписьXML.ЗаписатьНачалоЭлемента("ДокПодтвОтгрНом");//+ДокПодтвОтгр
				ЗаписьXML.ЗаписатьАтрибут( "РеквНаимДок", ДокументыОбОтгрузке);
				ЗаписьXML.ЗаписатьАтрибут( "РеквНомерДок", СокрЛП(НомерСФ));
				ЗаписьXML.ЗаписатьАтрибут( "РеквДатаДок",  Формат(ДатаСФ,"ДФ=дд.ММ.гггг"));
				ЗаписьXML.ЗаписатьКонецЭлемента(); // ДокПодтвОтгр
////////////////////////////////////////////////////////////////////////////////////////////////////	

				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
					Если ВыборкаДокумент.Контрагент.ЮрФизЛицо  = Перечисления.ЮрФизЛицо.ЮрЛицо  Тогда
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
						ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Контрагент.НаименованиеПолное);  
						ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Контрагент.ИНН);
						Если ВыборкаДокумент.Контрагент.ИНН="7802687430" И ЗначениеЗаполнено(ВыборкаДокумент.Грузополучатель) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Грузополучатель.КПП); 
						Иначе
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Контрагент.КПП);
						КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					Иначе
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвИП");//+СвИП
							ЗаписьXML.ЗаписатьАтрибут( "ИННФЛ", ВыборкаДокумент.Контрагент.ИНН);  

							ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
							МассивФИО = СтрРазделить(СтрЗаменить(ВыборкаДокумент.Контрагент.НаименованиеПолное,"ИП ",""), " ");
	                               Попытка
	                               Фамилия = МассивФИО[0];
                                   Имя =  МассивФИО[1];
                                   Отчество = МассивФИО[2];
							   Исключение
								   Фамилия = ВыборкаДокумент.Контрагент.НаименованиеПолное;
                                   Имя =  "";
                                   Отчество = "";
								   КонецПопытки;
								
						          ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Фамилия);  
			 			          ЗаписьXML.ЗаписатьАтрибут( "Имя",Имя); 
					              ЗаписьXML.ЗаписатьАтрибут( "Отчество", Отчество);
								  
			                    ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО

 		                    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвИП
					КонецЕсли;	
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
                        ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								ЗаписьXML.ЗаписатьАтрибут( "НаимРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							СведенияОПокупатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Контрагент,  ВыборкаДокумент.Дата);
							
							//ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							//Если ЗначениеЗаполнено(СведенияОПокупатель.Телефоны) Тогда
							//	ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПокупатель.Телефоны,20));
							//КонецЕсли;	
							//ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Контрагент);
							//Если ЗначениеЗаполнено(ЭлПочта) Тогда
							//	Если НЕ ВыборкаДокумент.Контрагент.Код = "УТ0003623" Тогда // Для Система-К не передаем
							//		ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
							//	КонецЕсли;
							//КонецЕсли;
							//ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							Если ЗначениеЗаполнено(СведенияОПокупатель.НомерСчета) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПокупатель.НомерСчета);
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							Если ЗначениеЗаполнено(СведенияОПокупатель.БИК) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПокупатель.Банк.Наименование);
								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПокупатель.БИК);
								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОПокупатель.КоррСчет);
							КонецЕсли;	 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ДенИзм");//+ДенИзм
		        ЗаписьXML.ЗаписатьАтрибут( "НаимОКВ", "Российский рубль");
				ЗаписьXML.ЗаписатьАтрибут( "КодОКВ", "643");
				ЗаписьXML.ЗаписатьКонецЭлемента(); //-ДенИзм
				
				Если ВыборкаДокумент.Контрагент.ИНН="7728551528" ИЛИ ВыборкаДокумент.Контрагент.ИНН="9729777779" ИЛИ ВыборкаДокумент.Контрагент.ИНН="6312203688"  
					ИЛИ ВыборкаДокумент.Контрагент.ИНН="9701048328"  ИЛИ (ВыборкаДокумент.Контрагент.ИНН="9714053621" И Выборка.Количество()=0) Тогда     
					ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСвФХЖ1");//+ДопСвФХЖ1
			        ЗаписьXML.ЗаписатьАтрибут( "СпОбстФДОП", "00005");
					ЗаписьXML.ЗаписатьКонецЭлемента(); //-ДопСвФХЖ1
				КонецЕсли;
				//////////////////////////////////////////////////////////////
				 
				Если ВыборкаДокумент.Организация.ИНН="7713204095" Тогда 
			    	GLN_Отправителя	= "4607041069995";
				ИначеЕсли ВыборкаДокумент.Организация.ИНН="7715889630" Тогда           //Эйкос
			    	GLN_Отправителя	= "";
				Иначе                                                                
			    	GLN_Отправителя	= "4607932679999"
                КонецЕсли;
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ1");//+ИнфПолФХЖ1
				Если НЕ GLN_Отправителя	= "" Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "отправитель");
						ЗаписьXML.ЗаписатьАтрибут( "Значен",  GLN_Отправителя);
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				КонецЕсли;
					///////////////////////////////////////////////////////////////////////////////////////////////////////
				Если ЗначениеЗаполнено(ВыборкаДокумент.Грузоотправитель.абс_GLN) Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузоотправитель");
					ЗаписьXML.ЗаписатьАтрибут( "Значен",  ВыборкаДокумент.Грузоотправитель.абс_GLN);
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф  
				КонецЕсли;

				ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
				ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_заказа");
				Если ЗначениеЗаполнено(ВыборкаДокумент.ДатаДокументаEDI) Тогда       
					ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ВыборкаДокумент.ДатаДокументаEDI,"ДФ=дд.ММ.гггг"));
				Иначе
			 		ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
				КонецЕсли;
				//ДатаПоДаннымПокупателя
		 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф 
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					Если ЗначениеЗаполнено(ВыборкаДокумент.НомерДокументаEDIЗаказа) Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
					ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					КонецЕсли;
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_накладной");
							//+++ Жигалев 26.04.2024
							Если ДокументОтгрузки.Контрагент.Код = "К00000648" тогда //СВИСС КРОНО  Письмо Глуховой Светланы 24.04.2024 17:00
								ЗаписьXML.ЗаписатьАтрибут( "Значен", НомерСФ); // Жигалев 
							иначе        
							//--- Жигалев	
								ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ДокументОтгрузки.Номер));
							КонецЕсли;
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_накладной");
			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ДатаСФ,"ДФ=дд.ММ.гггг")); 
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

		 		ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
				
			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвСчФакт
			
			// --------------------ТАБЛИЧНАЯ ЧАСТЬ---------------------

			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблСчФакт");//+ТаблСчФакт
			    КолНетто = 0;
			    ВыборкаСтрока=Результат[2].Выбрать();
				сч = 1;
				Пока ВыборкаСтрока.Следующий() Цикл   
					
					Если ВыборкаДокумент.Контрагент.ИНН="9714053621" ИЛИ ВыборкаДокумент.Контрагент.ИНН="7721546864" ИЛИ ВыборкаДокумент.Контрагент.ИНН="6312203688" 
						ИЛИ ВыборкаДокумент.Контрагент.ИНН="7704217370" ИЛИ ВыборкаДокумент.Контрагент.ИНН="7728551528" Тогда	
						ЕдиницаГУДС = Справочники.ЕдиницыИзмерения.НайтиПоНаименованию("ГУДС", Истина, , ВыборкаСтрока.Номенклатура);
						КоэффициентГУДС = 1; 
						Код_ОКЕЙ		= "778";      //упаковка
						Попытка
							КоэффициентГУДС = ЕдиницаГУДС.Коэффициент;	
						Исключение
							Сообщить("Для товара не установлена единица продажи ГУДС (Артикул: " + ВыборкаСтрока.Номенклатура + ")" );
						КонецПопытки;
					Иначе	
						Код_ОКЕЙ		= "796";      //штука
						КоэффициентГУДС = 1; 
					КонецЕсли;
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.НаименованиеПолное);
						ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов",Код_ОКЕЙ);
						ЗаписьXML.ЗаписатьАтрибут( "НаимЕдИзм", Строка(ВыборкаСтрока.ЕдиницаИзмерения)); 
					    ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество/КоэффициентГУДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						Если ВыборкаДокумент.Контрагент.ИНН="9714053621" И Выборка.Количество()=0 Тогда  //РВБ проверяем наличие СФ
							//ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСвФХЖ1");//+ДопСвФХЖ1
							ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов",  Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
							ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат( 0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
							ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат( 0 , "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
							ЗаписьXML.ЗаписатьАтрибут( "НалСт", "без НДС");
						ИначеЕсли ВыборкаДокумент.Организация.ИНН="7715889630" Тогда
							ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов",  Формат(ВыборкаСтрока.Цена*КоэффициентГУДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
							ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат( ВыборкаСтрока.СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
							ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат( ВыборкаСтрока.СуммаБезНДС + ВыборкаСтрока.СуммаНДС , "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
							ЗаписьXML.ЗаписатьАтрибут( "НалСт", "без НДС");
						Иначе
							ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов",  Формат(ВыборкаСтрока.Цена*КоэффициентГУДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
							ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат( ВыборкаСтрока.СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
							ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат( ВыборкаСтрока.СуммаБезНДС + ВыборкаСтрока.СуммаНДС , "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
							ЗаписьXML.ЗаписатьАтрибут( "НалСт", "" + Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0;" ) + "%" );
						КонецЕсли; 

						//Зароднюк Перенесено из ДопСведТов
						ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСведТов");//+ДопСведТов
							ЗаписьXML.ЗаписатьАтрибут( "АртикулТов", СокрЛП(ВыборкаСтрока.Номенклатура.Артикул));
							Если ВыборкаДокумент.Контрагент.ИНН="9714053621" И Выборка.Количество()=0 Тогда     //РВБ проверяем наличие СФ
								ЗаписьXML.ЗаписатьАтрибут( "ПрТовРаб", "1");  
							КонецЕсли;
							Если ВыборкаДокумент.Контрагент.ИНН="7728551528" Тогда  //спортмастер
								ЗаписьXML.ЗаписатьАтрибут( "КодТов", СокрЛП(ВыборкаСтрока.Номенклатура.Артикул));
							Иначе
								Если ЗначениеЗаполнено(ВыборкаСтрока.Штрихкод) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодТов", СокрЛП(Строка(ВыборкаСтрока.Штрихкод)));
								КонецЕсли;
							КонецЕсли;
							
							ЗначениеОКПД2	= лео_ДопФункции.Получить_ЗначенияСвойствОбъектов(ВыборкаСтрока.Номенклатура, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("00000000066"));
							Если ЗначениеЗаполнено(ЗначениеОКПД2) И ТипЗнч(ЗначениеОКПД2)=Тип("СправочникСсылка.Лео_КлассификаторОКПД2") Тогда 
								Если ЗначениеОКПД2.ЧестныйЗнак Тогда    
									//Зароднюк ВВ для покодного учета
									ЗаписьXML.ЗаписатьАтрибут( "ГТИН", СокрЛП(Строка(лео_ДопФункции.ПолучитьGTINпоНоменклатуре(ВыборкаСтрока.Номенклатура))));
									//ЗаписьXML.ЗаписатьНачалоЭлемента("НомСредИдентТов");//+НомСредИдентТов 
									Если лео_ДопФункции.Получить_ЗначенияКатегорииОбъектов(ВыборкаДокумент.Контрагент,Справочники.КатегорииОбъектов.НайтиПоКоду("000000128")) ИЛИ 
										ВыборкаДокумент.Дата >= Дата(2025,09,01,00,00,00) Тогда       //если дата документа больше 1 сентября 2025
										Сообщить("КИЗ"); 
										ТаблицаКодовДляПередачи=лео_ДопФункции.ВозвратТаблицыКодовКИЗ_Коробки(ДокументОтгрузки, ВыборкаСтрока.Номенклатура);
										Если ТаблицаКодовДляПередачи.Количество()>0 Тогда
											Для Каждого СтрокаТЧ Из ТаблицаКодовДляПередачи Цикл
												НомУпаковки = СокрЛП(СтрокаТЧ.ШтрихКодКоробки.Наименование);	
												//ЗаписатьXML(ЗаписьXML,НомУпаковки,"КИЗ");     
												ЗаписьXML.ЗаписатьНачалоЭлемента("НомСредИдентТов");//НомСредИдентТов
													ЗаписьXML.ЗаписатьАтрибут( "ИдентТрансУпак", НомУпаковки);
													//ЗаписатьXML(ЗаписьXML,НомУпаковки,"ИдентТрансУпак");
												ЗаписьXML.ЗаписатьКонецЭлемента();//-НомСредИдентТов
											КонецЦикла;
											ТаблицаКодовДляПередачи.Очистить();
										КонецЕсли;
										ТаблицаКодовДляПередачи_Штуки=лео_ДопФункции.ВозвратТаблицыКодовКИЗ_Штуки(ДокументОтгрузки, ВыборкаСтрока.Номенклатура);
										Если ТаблицаКодовДляПередачи_Штуки.Количество()>0 Тогда
											ЗаписьXML.ЗаписатьНачалоЭлемента("НомСредИдентТов");//НомСредИдентТов
											Для Каждого СтрокаТЧ Из ТаблицаКодовДляПередачи_Штуки Цикл
												НомУпаковки = Сред(СокрЛП(СтрокаТЧ.QR_Код_Входящий),1,32);
												НомУпаковки	=	лео_ДопФункции.ПодготовкаСтрокиДляПередачиXML(НомУпаковки);
												ЗаписатьXML(ЗаписьXML,НомУпаковки,"КИЗ");     
													//ЗаписьXML.ЗаписатьАтрибут( "ИдентТрансУпак", НомУпаковки);
													//ЗаписатьXML(ЗаписьXML,НомУпаковки,"ИдентТрансУпак");
											КонецЦикла;
											ЗаписьXML.ЗаписатьКонецЭлемента();//-НомСредИдентТов
											ТаблицаКодовДляПередачи_Штуки.Очистить();
										КонецЕсли;
								    Иначе
										//ЗаписьXML.ЗаписатьАтрибут( "КолВедМарк", ВыборкаСтрока.Количество);
										//{Катанович
										//ЗаписатьXML(ЗаписьXML,лео_ДопФункции.ПолучитьGTINпоНоменклатуре(ВыборкаСтрока.Номенклатура)+"37"+Строка(ВыборкаСтрока.Количество),"НомУпак");  
									    НомУпаковки = НовыйКодОСУ(лео_ДопФункции.ПолучитьGTINпоНоменклатуре(ВыборкаСтрока.Номенклатура),ВыборкаСтрока.Количество);	
										ЗаписатьXML(ЗаписьXML,НомУпаковки,"НомУпак");  
										//Катанович}  
									КонецЕсли;
									//ЗаписьXML.ЗаписатьКонецЭлемента();//-НомСредИдентТов    
								КонецЕсли;
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ДопСведТов         
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Акциз");//+Акциз
							ЗаписатьXML(ЗаписьXML,"без акциза","БезАкциз");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Акциз
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал");//+СумНал;
							Если ВыборкаДокумент.Контрагент.ИНН="9714053621" И Выборка.Количество()=0 Тогда    //РВБ проверяем наличие СФ
								ЗаписатьXML(ЗаписьXML,Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
							ИначеЕсли ВыборкаДокумент.Организация.ИНН="7715889630" Тогда
								ЗаписатьXML(ЗаписьXML,Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
							Иначе
								ЗаписатьXML(ЗаписьXML,Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
							КонецЕсли; 
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНал
						
						
						Если ЗначениеЗаполнено(ВыборкаДокумент.НомерДокументаEDIЗаказа) Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						КонецЕсли;
						Если ЗначениеЗаполнено(ВыборкаСтрока.АртикулПокупателя) Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала");
							АртикулПокупателя = СтрЗаменить(ВыборкаСтрока.АртикулПокупателя,"*","");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(АртикулПокупателя)));
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала_заказчика");
							АртикулПокупателя = СтрЗаменить(ВыборкаСтрока.АртикулПокупателя,"*","");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(АртикулПокупателя)));
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						КонецЕсли;
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_уведомления_об_отгрузке");
						ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерУведомленияОбОтгрузке));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "штрихкод");
						ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(ВыборкаСтрока.Штрихкод)));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2

					    ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_продавца");
						ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(ВыборкаСтрока.Артикул)));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						
						СтрокаGTIN = лео_ДопФункции.ПолучитьGTINпоНоменклатуре(ВыборкаСтрока.Номенклатура);
						Если ЗначениеЗаполнено(СтрокаGTIN) И НЕ СтрокаGTIN="--------------" Тогда
					    ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "GTIN");
						ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(СтрокаGTIN)));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2 
						КонецЕсли;

					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
					КолНетто = КолНетто + ВыборкаСтрока.СуммаНетто;
				КонецЦикла;
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоОпл");//+ВсегоОпл
					Если ВыборкаДокумент.Контрагент.ИНН="9714053621" И Выборка.Количество()=0 Тогда      //РВБ проверяем наличие СФ
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", 	Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
			 			ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",	Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
			 			ЗаписьXML.ЗаписатьАтрибут( "КолНеттоВс",		Формат(КолНетто, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
						ЗаписатьXML(ЗаписьXML,Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего
					ИначеЕсли ВыборкаДокумент.Организация.ИНН="7715889630" Тогда
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", 	Формат(ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
			 			ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",	Формат(ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
			 			ЗаписьXML.ЗаписатьАтрибут( "КолНеттоВс",		Формат(КолНетто, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
						ЗаписатьXML(ЗаписьXML,Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего
					Иначе
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", 	Формат(ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
			 			ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",	Формат(ДокументОтгрузки.абс_СуммаСНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
			 			ЗаписьXML.ЗаписатьАтрибут( "КолНеттоВс",		Формат(КолНетто, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
						ЗаписатьXML(ЗаписьXML,Формат(ДокументОтгрузки.абс_СуммаСНДС - ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего
					КонецЕсли; 

				ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоОпл
 			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблСчФакт
			
			//Подвал документа                                          
			//-----------------------------------------------------------------------------------------------------------
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПродПер");//+СвПродПер

			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПер");//+СвПер
				ЗаписьXML.ЗаписатьАтрибут( "СодОпер", "Товары переданы, работы сданы, услуги оказаны");
				Если ЗначениеЗаполнено(ВыборкаДокумент.ДатаИсполнения) Тогда
		            ЗаписьXML.ЗаписатьАтрибут( "ДатаПер", Формат(ВыборкаДокумент.ДатаИсполнения,"ДФ=дд.ММ.гггг"));
				Иначе
		            ЗаписьXML.ЗаписатьАтрибут( "ДатаПер", Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
				КонецЕсли; 

			    ЗаписьXML.ЗаписатьНачалоЭлемента("ОснПер");//+ОснПер
					Если ВыборкаДокумент.Контрагент.ИНН="9714053621" И Выборка.Количество()=0 Тогда      //РВБ проверяем наличие СФ
					    //для клиента необходимо указывать Акт Приема передачи
			           	ДокОснование   = "Акт приёмки товара";
					   	НомерОснования = ВыборкаДокумент.НомерДокументаEDIЗаказа;
					   	ДатаОснования  = Формат(ВыборкаДокумент.ДатаИсполнения,"ДФ=дд.ММ.гггг");
					ИначеЕсли ВыборкаДокумент.Контрагент.ИНН="6312203688" И Выборка.Количество()=0 Тогда      //агрегатор ооо
			           	ДокОснование   = "Договор для продавцов товаров на торговой площадке ";
					   	НомерОснования = "Аптеки+";
					   	ДатаОснования  = Формат('20231201000000',"ДФ=дд.ММ.гггг");
	                Иначе
			           	ДокОснование   = ВыборкаДокумент.ДоговорКонтрагента.Наименование;
					   	НомерОснования =  ВыборкаДокумент.ДоговорКонтрагента.Номер;
					   	ДатаОснования  = Формат(ВыборкаДокумент.ДоговорКонтрагента.Дата,"ДФ=дд.ММ.гггг");
					КонецЕсли;
				   	Если ЗначениеЗаполнено(ДокОснование) и ЗначениеЗаполнено(НомерОснования) и ЗначениеЗаполнено(ДатаОснования) Тогда  
		                ЗаписьXML.ЗаписатьАтрибут( "РеквНаимДок", 	ДокОснование);
		                ЗаписьXML.ЗаписатьАтрибут( "РеквНомерДок",  НомерОснования);
				        ЗаписьXML.ЗаписатьАтрибут( "РеквДатаДок", 	ДатаОснования);
					Иначе
						ЗаписьXML.ЗаписатьАтрибут( "РеквНаимДок", "Без документа-основания");
				   	КонецЕсли;	
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ОснПер
				 //ЗаписьXML.ЗаписатьНачалоЭлемента("СвЛицПер");//+СвЛицПер
				 //          ЗаписьXML.ЗаписатьНачалоЭлемента("ИнЛицо");//+ИнЛицо
				 //              ЗаписьXML.ЗаписатьНачалоЭлемента("ФЛПер");//+ФЛПер  
				 //   		   		ЗаписьXML.ЗаписатьНачалоЭлемента("ОснДоверФЛ");//+ОснДоверФЛ 
				 //   					 ЗаписьXML.ЗаписатьАтрибут("РеквНаимДок", "Доверенность");
				 //   					 ЗаписьXML.ЗаписатьАтрибут("РеквНомерДок", "без номера");
				 //                   ЗаписьXML.ЗаписатьКонецЭлемента();//-ОснДоверФЛ						  
				 //                   ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
				 //   				Если ЗначениеЗаполнено(ВыборкаДокумент.Водитель) Тогда
				 //   				      Водитель = РазложитьФИО(ВыборкаДокумент.Водитель);
				 //   				      ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Водитель.Фамилия);  
				 //   				      ЗаписьXML.ЗаписатьАтрибут( "Имя", Водитель.Имя); 
				 //   				Иначе 
				 //   					  Сообщить("Нет сведений о водителе!");
				 //   					  ЗаписьXML.ЗаписатьАтрибут( "Фамилия", "Отсутствует");  
				 //   				      ЗаписьXML.ЗаписатьАтрибут( "Имя", "Отсутствует"); 
				 //   				КонецЕсли;	  
				 //   				  
				 //                   ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО						  
				 //   	       ЗаписьXML.ЗаписатьКонецЭлемента();//-ФЛПер
				 //   	  ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнЛицо
				//ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЛицПер
				//ЗаписьXML.ЗаписатьНачалоЭлемента("Тран");//+ТранГруз
				//	ЗаписьXML.ЗаписатьАтрибут( "СвТран",  "Номер ТТН: "+Строка(ВыборкаДокумент.Номер));
				//ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранГруз
				
              ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПер
           ЗаписьXML.ЗаписатьКонецЭлемента();//+СвПродПер

			//-----------------------------------------------------------------------------------------------------------
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
				ЗаписьXML.ЗаписатьАтрибут( "Должн",  "Старший координатор");
				ЗаписьXML.ЗаписатьАтрибут( "ТипПодпис",   "1");
				ЗаписьXML.ЗаписатьАтрибут( "СпосПодтПолном",  "4");
			
			//ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
			//	ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
				//ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
				
					СтруктураПодписант = ОтветственныйПоЭДО(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата);
					
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
				 		ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
						ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			
			//ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
			
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.УПД);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
    СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	СтруктураПараметров.Вставить("НастройкаОбмена"		    , Справочники.абс_НастройкиEDIОбмена.НайтиПоНаименованию("Контур"));
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ДокументОтгрузки.Номер);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ДокументОтгрузки.Дата);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры

Процедура ВыгрузитьУПД_КонтурГУДС_970(ДокументОтгрузки, ЕстьОшибки) Экспорт   //формат с 01.04.2025
	//проверка наличия с/ф
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	Иначе
		Выборка 	= Результат.Выбрать();
		Выборка.Следующий();
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
	КонецЕсли;
	
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	СУММА(ВЫБОР
	|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|				ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
	|			ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
	|		КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС,
	|	РеализацияТоваровУслугТовары.НомерСтроки,
	|	СУММА(РеализацияТоваровУслугТовары.Количество * РеализацияТоваровУслугТовары.ЕдиницаИзмерения.Коэффициент / РеализацияТоваровУслугТовары.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент * РеализацияТоваровУслугТовары.Номенклатура.ЕдиницаХраненияОстатков.ВесНетто) КАК СуммаНетто
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20 
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.НомерСтроки
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	//|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
	
	|ЕстьNULL(Накладная.Ссылка.Сделка.Номер,Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке) КАК НомерЗаказа,
	
	//|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
	// ZAA - 1
	|ЕстьNULL(Накладная.Ссылка.Сделка.Дата,Накладная.Ссылка.Дата) КАК ДатаЗаказа,
	// ZAA - 2
	
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI КАК НомерДокументаEDIЗаказа,
	
	//|	Накладная.Ссылка.Сделка.ДатаПоДаннымПокупателя КАК ДатаДокументаEDI,
	// ZAA - 1
	|ЕстьNULL(Накладная.Ссылка.Сделка.ДатаПоДаннымПокупателя,Накладная.Ссылка.Дата) КАК ДатаДокументаEDI,
	// ZAA - 2

	|	Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
	|	Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
	|	Накладная.Ссылка.ВалютаДокумента КАК Валюта,
	|	Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
	|	Накладная.Ссылка.Организация КАК Организация,
	|	Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """") КАК НомерМагазина,
	|	Накладная.Ссылка.Грузополучатель КАК Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """") КАК КодПоставщика,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомленияОбОтгрузке,
		
	|	Накладная.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.Дата, Накладная.Ссылка.Дата) КАК ДатаТТН,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор) КАК Водитель,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность),
	//|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки) КАК ДатаИсполнения,
	
	|Выбор когда Накладная.Ссылка.Сделка = неопределено тогда
	|   ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Дата)
	|иначе
	|   ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки)
	|Конец как ДатаИсполнения,   
	
	
	
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI КАК ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ КАК ДатаПоставки
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НомерМагазина)) КАК СвойстваНомераМагазинов
	|		ПО Накладная.Ссылка.Грузополучатель = СвойстваНомераМагазинов.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодПоставщика)) КАК СвойствоКодПоставщика
	|		ПО Накладная.Ссылка.Контрагент = СвойствоКодПоставщика.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Ссылка.Номер,
	|	Накладная.Ссылка.Дата,
	//|	Накладная.Ссылка.Сделка.Номер,
	|ЕстьNULL(Накладная.Ссылка.Сделка.Номер,Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке),
	
	//|	Накладная.Ссылка.Сделка.Дата,
	|   ЕстьNULL(Накладная.Ссылка.Сделка.Дата,Накладная.Ссылка.Дата),
	
	|	Накладная.Ссылка.Организация.абс_GLN,
	|	Накладная.Ссылка.Контрагент.абс_GLN,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
	|	Накладная.Ссылка.Организация.ИНН,
	|	Накладная.Ссылка.Организация.КПП,
	|	Накладная.Ссылка.Организация.Лео_GUID,
	|	Накладная.Ссылка.Контрагент.Лео_GUID,
	|	Накладная.Ссылка.ВалютаДокумента,
	|	Накладная.Ссылка.ВалютаДокумента.Код,
	|	Накладная.Ссылка.Организация,
	|	Накладная.Ссылка.Грузоотправитель,
	|	Накладная.Ссылка.Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """"),
	|	Накладная.Ссылка.Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """"),
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ,
	//|	Накладная.Ссылка.Сделка.ДатаПоДаннымПокупателя,
	|ЕстьNULL(Накладная.Ссылка.Сделка.ДатаПоДаннымПокупателя,Накладная.Ссылка.Дата),

	//|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки),
	
	|Выбор когда Накладная.Ссылка.Сделка = неопределено тогда
	|   ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Дата)
	|иначе
	|   ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки)
	|Конец ,   
	
	
	
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.Дата, Накладная.Ссылка.Дата),
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СуммаНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование КАК ЕдиницаИзмерения,
	|	Накладная.Цена,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя,
	|	Накладная.Номенклатура.Артикул КАК Артикул,
	|	Накладная.НомерСтроки КАК НомерСтроки,
	|	Накладная.СуммаНетто
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.СерияНоменклатуры = Штрихкоды.СерияНоменклатуры
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(, ) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование,
	|	Накладная.Цена,
	|	Накладная.СуммаНДС,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства,
	|	Накладная.Номенклатура.Артикул,
	|	Накладная.НомерСтроки,
	|	Накладная.СуммаНетто
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	//////////////////////////////////////////////////////////////////////////////////////
	
	Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
		 Идентификатор = ВыборкаДокумент.ОператорEDI.Идентификатор;
	 Иначе	 
		 Идентификатор = "2IH";
	КонецЕсли;	
	
	    НомерОрганизацииВсистеме = ВыборкаДокумент.Организация.ИНН + "-" + "2012052807212505941080000000000";
	
	Если ЗначениеЗаполнено(ВыборкаДокумент.Контрагент.Лео_GUID) Тогда
		НомерКонтрагентаВсистеме = ВыборкаДокумент.Контрагент.ИНН + "-" + СОКРЛП(ВыборкаДокумент.Контрагент.Лео_GUID);
	Иначе
		НомерКонтрагентаВсистеме = ВыборкаДокумент.Контрагент.ИНН + "-" + СОКРЛП(абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ВыборкаДокумент.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Идентификатор участника ЭДО")));
    КонецЕсли;	
	
		
	ИдФайл = "ON_NSCHFDOPPR_" + Идентификатор + "-" + НомерКонтрагентаВсистеме + "_" + Идентификатор + "-" + НомерОрганизацииВсистеме + "_" + Формат(ДатаСФ,"ДФ=ггггММдд") + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор()) ;

    ИмяФайла = "UPD_" + ВыборкаДокумент.Номер + "_" + Формат(ВыборкаДокумент.Дата,"ДФ=ггггММдд");
	
	ИмяФайла = СформироватьИмяФайлаEDI(ИмяФайла);
	ИмяФайла = ИмяФайла + ".xml";

	
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку( "WINDOWS-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
	
		ЗаписьXML.ЗаписатьАтрибут( "xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance");

		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.01" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Diadoc 1.0" );

		 
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
			ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр",Идентификатор + "-" + НомерОрганизацииВсистеме);
			ЗаписьXML.ЗаписатьАтрибут( "ИдПол", Идентификатор + "-" + НомерКонтрагентаВсистеме);

		   ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
		   Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.ОператорEDI.Наименование);
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.ОператорEDI.Контрагент.ИНН);
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		   Иначе	  
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "Систем Групп Рус");
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   "7723749362");
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		  КонецЕсли;
         ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
			ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115131");
				   ЗаписьXML.ЗаписатьАтрибут( "Функция", "СЧФДОП");
			
			ЗаписьXML.ЗаписатьАтрибут( "ПоФактХЖ", "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
            ЗаписьXML.ЗаписатьАтрибут( "НаимДокОпр", "Счет-фактура и документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
			ЗаписьXML.ЗаписатьАтрибут( "ДатаИнфПр", Формат(ТекущаяДата(),"ДФ=дд.ММ.гггг")); // Дата формирования файла обмена СФ
			ЗаписьXML.ЗаписатьАтрибут( "ВремИнфПр", Формат(ТекущаяДата(), "ДФ=ЧЧ.мм.сс"));
			//ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное);
		ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное + ", ИНН-КПП: " + ВыборкаДокумент.Организация.ИНН + "-" + ВыборкаДокумент.Организация.КПП);

			
			//ЗаписьXML.ЗаписатьАтрибут( "ОснДоверОргСост", "Основание доверенности");    // Добавлено 28/07/2017 для Билла ООО
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвСчФакт");//+СвСчФакт 
				ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", НомерСФ);
				ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") );              
				ЗаписьXML.ЗаписатьАтрибут( "КодОКВ", ВыборкаДокумент.КодВалюты);
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИспрСчФ");//+СвСчФакт 
						  ЗаписьXML.ЗаписатьАтрибут( "ДефДатаИспрСчФ", "-");
				          ЗаписьXML.ЗаписатьАтрибут( "ДефНомИспрСчФ", "-");
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ИспрСчФ
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг",ВыборкаДокумент.Организация.НаименованиеСокращенное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						
						СведенияОПродавец = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
						Если ЗначениеЗаполнено(СведенияОПродавец.Телефоны) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПродавец.Телефоны,20));
						КонецЕсли;	
							ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", "mail@leovit.ru");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
						////////////////////////////////////////////						
						СведенияОПродавце = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
						Если ЗначениеЗаполнено(СведенияОПродавце.НомерСчета) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПродавце.НомерСчета);
						КонецЕсли;	   
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
						Если ЗначениеЗаполнено(СведенияОПродавце.БИК) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПродавце.Банк.Наименование);
							ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПродавце.БИК);
						КонецЕсли;	 
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
                         /////////////////////////////
						
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод
				
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОт");//+ГрузОт 
					ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОтпр");//+ГрузОтпр
					ЗаписьXML.ЗаписатьАтрибут( "ОКПО", Строка(ВыборкаДокумент.Грузоотправитель.КодПоОКПО));     

					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Грузоотправитель.НаименованиеПолное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Грузоотправитель.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Грузоотправитель.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузоотправитель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						СведенияОГрузоотправитель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузоотправитель,  ВыборкаДокумент.Дата);

							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.Телефоны) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузоотправитель.Телефоны,20));
									   КонецЕсли;	
									   ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Грузоотправитель);
									   Если ЗначениеЗаполнено(ЭлПочта) Тогда
											   ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
									   КонецЕсли;
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт

							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.НомерСчета) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузоотправитель.НомерСчета);
									  КонецЕсли;	   
									  ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
									            Если ЗначениеЗаполнено(СведенияОГрузоотправитель.БИК) Тогда
									                 ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузоотправитель.Банк.Наименование);
												     ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузоотправитель.БИК);
													 ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОГрузоотправитель.КоррСчет);
												КонецЕсли;	 
                                      ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв

					ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОтпр
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОт
				
				СведенияОГрузополучатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузополучатель,  ВыборкаДокумент.Дата);

				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузПолуч");//+ГрузПолуч
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						Если ВыборкаДокумент.Контрагент.ЮрФизЛицо  = Перечисления.ЮрФизЛицо.ЮрЛицо  Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
							Если ЗначениеЗаполнено(ВыборкаДокумент.НомерМагазина) Тогда
								ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.НомерМагазина);
							Иначе
								ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.Грузополучатель.НаименованиеПолное);
							КонецЕсли;
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОГрузополучатель.ИНН );
							ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОГрузополучатель.КПП );
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
						Иначе
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвИП");//+СвИП
							ЗаписьXML.ЗаписатьАтрибут( "ИННФЛ", ВыборкаДокумент.Грузополучатель.ИНН);  

							ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
							МассивФИО = СтрРазделить(СтрЗаменить(ВыборкаДокумент.Контрагент.НаименованиеПолное,"ИП ",""), " ");
							Попытка
								Фамилия = МассивФИО[0];
								Имя =  МассивФИО[1];
								Отчество = МассивФИО[2];
							Исключение
								Фамилия = ВыборкаДокумент.Контрагент.НаименованиеПолное;
								Имя =  "";
								Отчество = "";
							КонецПопытки;
							
							ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Фамилия);  
							ЗаписьXML.ЗаписатьАтрибут( "Имя",Имя); 
							ЗаписьXML.ЗаписатьАтрибут( "Отчество", Отчество);
							
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвИП
							
						КонецЕсли;  
							  
							  
							  
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
						Если ВыборкаДокумент.Грузополучатель.Код = "УТ0003623" Тогда   // Система К
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
						Иначе	
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента);
						КонецЕсли;	
						Если СтруктураАдреса.Количество() = 0 Тогда
							Сообщить("Не указан " + Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента + " " + ВыборкаДокумент.Грузополучатель);
							    Возврат;
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;

						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
					//////////////////////////////////////////////////////////////////////
					
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.Телефоны) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузополучатель.Телефоны,20));
							КонецЕсли;	
							ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Грузополучатель);
							Если ЗначениеЗаполнено(ЭлПочта) Тогда
								Если НЕ ВыборкаДокумент.Контрагент.Код = "УТ0003623" Тогда // Для Система-К не передаем
									ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
								КонецЕсли;
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.НомерСчета) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузополучатель.НомерСчета);
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.БИК) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузополучатель.Банк.Наименование);
								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузополучатель.БИК);
								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОГрузополучатель.КоррСчет);
							КонецЕсли;	 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
					
					//////////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузПолуч
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
					Если ВыборкаДокумент.Контрагент.ЮрФизЛицо  = Перечисления.ЮрФизЛицо.ЮрЛицо  Тогда
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Контрагент.НаименованиеПолное);  
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Контрагент.ИНН);  
						ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Контрагент.КПП);
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					Иначе
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвИП");//+СвИП
								ЗаписьXML.ЗаписатьАтрибут( "ИННФЛ", ВыборкаДокумент.Контрагент.ИНН);  

							    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
								МассивФИО = СтрРазделить(СтрЗаменить(ВыборкаДокумент.Контрагент.НаименованиеПолное,"ИП ",""), " ");
	                               Попытка
	                               Фамилия = МассивФИО[0];
                                   Имя =  МассивФИО[1];
                                   Отчество = МассивФИО[2];
							   Исключение
								   Фамилия = ВыборкаДокумент.Контрагент.НаименованиеПолное;
                                   Имя =  "";
                                   Отчество = "";
								   КонецПопытки;
								
						          ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Фамилия);  
			 			          ЗаписьXML.ЗаписатьАтрибут( "Имя",Имя); 
					              ЗаписьXML.ЗаписатьАтрибут( "Отчество", Отчество);
								  
			                    ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО

 		                    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвИП
					КонецЕсли;	
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
                        ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							СведенияОПокупатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Контрагент,  ВыборкаДокумент.Дата);
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							Если ЗначениеЗаполнено(СведенияОПокупатель.Телефоны) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПокупатель.Телефоны,20));
							КонецЕсли;	
							ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Контрагент);
							Если ЗначениеЗаполнено(ЭлПочта) Тогда
								Если НЕ ВыборкаДокумент.Контрагент.Код = "УТ0003623" Тогда // Для Система-К не передаем
									ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
								КонецЕсли;
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							Если ЗначениеЗаполнено(СведенияОПокупатель.НомерСчета) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПокупатель.НомерСчета);
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							Если ЗначениеЗаполнено(СведенияОПокупатель.БИК) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПокупатель.Банк.Наименование);
								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПокупатель.БИК);
								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОПокупатель.КоррСчет);
							КонецЕсли;	 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
				
					ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСвФХЖ1");//+ИнфПолФХЖ1
		         ЗаписьXML.ЗаписатьАтрибут( "НаимОКВ", "Российский рубль");
				 ЗаписьXML.ЗаписатьАтрибут( "КурсВал", "1");
				ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
				
				//////////////////////////////////////////////////////////////
				//Постановление 534}
				ДокументыОбОтгрузке = "";
				ИтогоСтрок =0;
				Если Выборка.Ссылка.Дата >= Дата("20241001") Тогда  
				     ДокументыОбОтгрузке = "Универсальный передаточный документ, №" + НомерСФ + " от " + Формат(ДатаСФ, "ДЛФ='Д'") + " г.";  
				Иначе	
				Для Каждого СтрДокОснования Из Выборка.Ссылка.ДокументыОснования Цикл
					// Получить экземпляр документа на печать
					
					Если НЕ ЗначениеЗаполнено(СтрДокОснования.ДокументОснование) Тогда
						Продолжить;
					КонецЕсли;
					
					ДокументыОбОтгрузке = ?(ЗначениеЗаполнено(ДокументыОбОтгрузке),ДокументыОбОтгрузке + "; ","");
					ПерваяСтрокаПоДокументуОтгрузки = 1;
					ПоследняяСтрокаПоДокументуОтгрузки = СтрДокОснования.ДокументОснование.Товары.Количество();
					Если ПерваяСтрокаПоДокументуОтгрузки = ПоследняяСтрокаПоДокументуОтгрузки Тогда
						ДиапазонСтрок = "" + Строка(ПерваяСтрокаПоДокументуОтгрузки + ИтогоСтрок);
					Иначе
						ДиапазонСтрок = "" + Строка(ПерваяСтрокаПоДокументуОтгрузки + ИтогоСтрок) + "-" + Строка(ПоследняяСтрокаПоДокументуОтгрузки + ИтогоСтрок);
					КонецЕсли;
					ИтогоСтрок =  ИтогоСтрок + ПоследняяСтрокаПоДокументуОтгрузки;
					ДокументыОбОтгрузке = ДокументыОбОтгрузке + "п/п " + ДиапазонСтрок + " Универсальный передаточный документ, №" + НомерСФ + " от " + Формат(СтрДокОснования.ДокументОснование.Дата, "ДЛФ='Д'") + " г.";  
				КонецЦикла;	
				КонецЕсли;
				/////////////////////////////////////////////////////////////
				//Постановление 534}	

				 ЗаписьXML.ЗаписатьНачалоЭлемента("ДокПодтвОтгр");//+ДокПодтвОтгр
				 
				 ЗаписьXML.ЗаписатьАтрибут( "НаимДокОтгр", "Товарная накладная");
				 //ЗаписьXML.ЗаписатьАтрибут( "НомДокОтгр", ВыборкаДокумент.Номер);
				 ЗаписьXML.ЗаписатьАтрибут( "НомДокОтгр", ДокументыОбОтгрузке);

				 ЗаписьXML.ЗаписатьАтрибут( "ДатаДокОтгр",  Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
				 
                 ЗаписьXML.ЗаписатьКонецЭлемента(); // ДокПодтвОтгр
				 
				 
			

				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ1");//+ИнфПолФХЖ1
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					     ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "отправитель");
						 ЗаписьXML.ЗаписатьАтрибут( "Значен",  "4607932679999");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					///////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузоотправитель");
					ЗаписьXML.ЗаписатьАтрибут( "Значен",  ВыборкаДокумент.Грузоотправитель.абс_GLN);
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				//	
				//	///////////////////////////////////////////////////////////////////////////////////////////////////////
				//	ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
				//		ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "получатель");
				//			ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNКонтрагента));
				//ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				//	
				//	////////////////////////////////////////////////////////////////////////////////////////////////////////
				//	ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
				//		ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузополучатель");
				//		ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
				//	ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				//	////////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_заказа");
			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ВыборкаДокумент.ДатаДокументаEDI,"ДФ=дд.ММ.гггг"));
						//ДатаПоДаннымПокупателя
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					Если ЗначениеЗаполнено(ВыборкаДокумент.НомерДокументаEDIЗаказа) Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
					ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					КонецЕсли;
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_накладной");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ДокументОтгрузки.Номер));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_накладной");
			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ДатаСФ,"ДФ=дд.ММ.гггг")); 
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					//ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ИнфПолСтр
					//	ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_акта");
					//	ЗаписьXML.ЗаписатьАтрибут( "Значен", ?(ЗначениеЗаполнено(ДокументОтгрузки.абс_НомерУведомленияОПриемке),ДокументОтгрузки.абс_НомерУведомленияОПриемке,"б/н"));
					//ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр
					//////////////////////////////////////////////////////////////////////////////////////////////////////////
					//ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					//	ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_поставщика");
					// 	ЗаписьXML.ЗаписатьАтрибут( "Значен",УдалитьЛидирующиеНули(ВыборкаДокумент.КодПоставщика));
					//ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

		 		ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
				
			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвСчФакт
			
			// --------------------ТАБЛИЧНАЯ ЧАСТЬ---------------------

			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблСчФакт");//+ТаблСчФакт
			    КолНетто = 0;
			    ВыборкаСтрока=Результат[2].Выбрать();
				сч = 1;
				
				Пока ВыборкаСтрока.Следующий() Цикл
	
					ЕдиницаГУДС = Справочники.ЕдиницыИзмерения.НайтиПоНаименованию("ГУДС", Истина, , ВыборкаСтрока.Номенклатура);
					КоэффициентГУДС = 1;
					Попытка
						КоэффициентГУДС = ЕдиницаГУДС.Коэффициент;	
					Исключение
						Сообщить("Для товара не установлена единица продажи ГУДС (Артикул: " + ВыборкаСтрока.Номенклатура + ")" );
					КонецПопытки;	
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомСтр", Строка(сч));
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.НаименованиеПолное);	
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов","778");
					    ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество/КоэффициентГУДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов",  Формат(ВыборкаСтрока.Цена*КоэффициентГУДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат( ВыборкаСтрока.СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат( ВыборкаСтрока.СуммаБезНДС + ВыборкаСтрока.СуммаНДС , "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "НалСт", "" + Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0;" ) + "%" );
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Акциз");//+Акциз
							ЗаписатьXML(ЗаписьXML,"без акциза","БезАкциз");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Акциз
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал");//+СумНал;
							ЗаписатьXML(ЗаписьXML,Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНал
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСведТов");//+ДопСведТов
						ЗаписьXML.ЗаписатьАтрибут( "ПрТовРаб", "1");
						ЗаписьXML.ЗаписатьАтрибут( "КодТов", СокрЛП(Строка(ВыборкаСтрока.Штрихкод)));
						ЗаписьXML.ЗаписатьАтрибут( "НаимЕдИзм", "упак");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ДопСведТов
						
						Если ЗначениеЗаполнено(ВыборкаДокумент.НомерДокументаEDIЗаказа) Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						КонецЕсли;
						Если ЗначениеЗаполнено(ВыборкаСтрока.АртикулПокупателя) Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала");
							АртикулПокупателя = СтрЗаменить(ВыборкаСтрока.АртикулПокупателя,"*","");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(АртикулПокупателя)));
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала_заказчика");
							АртикулПокупателя = СтрЗаменить(ВыборкаСтрока.АртикулПокупателя,"*","");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(АртикулПокупателя)));
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						КонецЕсли;
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_уведомления_об_отгрузке");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерУведомленияОбОтгрузке));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "штрихкод");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(ВыборкаСтрока.Штрихкод)));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2

                        ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_продавца");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(ВыборкаСтрока.Артикул)));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2

					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
					КолНетто = КолНетто + ВыборкаСтрока.СуммаНетто;
				КонецЦикла;
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоОпл");//+ВсегоОпл
					ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", Формат(ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
		 			ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",Формат( ДокументОтгрузки.абс_СуммаСНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
						ЗаписатьXML(ЗаписьXML,Формат(ДокументОтгрузки.абс_СуммаСНДС - ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
					ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего

				    ЗаписатьXML(ЗаписьXML,Формат(КолНетто, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"КолНеттоВс");

				ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоОпл
 			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблСчФакт
			
			//-----------------------------------------------------------------------------------------------------------
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПродПер");//+СвПродПер

			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПер");//+СвПер
					ЗаписьXML.ЗаписатьАтрибут( "СодОпер", "Товары переданы");
		            ЗаписьXML.ЗаписатьАтрибут( "ДатаПер", Формат(ВыборкаДокумент.ДатаИсполнения,"ДФ=дд.ММ.гггг"));

			     ЗаписьXML.ЗаписатьНачалоЭлемента("ОснПер");//+ОснПер
				           ДокОснование   = ВыборкаДокумент.ДоговорКонтрагента.Наименование;
						   НомерОснования =  ВыборкаДокумент.ДоговорКонтрагента.Номер;
						   ДатаОснования  = Формат(ВыборкаДокумент.ДоговорКонтрагента.Дата,"ДФ=дд.ММ.гггг");
						   Если ЗначениеЗаполнено(ДокОснование) и ЗначениеЗаполнено(НомерОснования) и ЗначениеЗаполнено(ДатаОснования) Тогда  
				                ЗаписьXML.ЗаписатьАтрибут( "НаимОсн", ДокОснование);
				                ЗаписьXML.ЗаписатьАтрибут( "НомОсн",  НомерОснования);
						        ЗаписьXML.ЗаписатьАтрибут( "ДатаОсн", ДатаОснования);
							Иначе
								ЗаписьXML.ЗаписатьАтрибут( "НаимОсн", "Без документа-основания");
						   КонецЕсли;	
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ОснПер
				 ЗаписьXML.ЗаписатьНачалоЭлемента("СвЛицПер");//+СвЛицПер
				           ЗаписьXML.ЗаписатьНачалоЭлемента("ИнЛицо");//+ИнЛицо
                               ЗаписьXML.ЗаписатьНачалоЭлемента("ФЛПер");//+ФЛПер
										 ЗаписьXML.ЗаписатьАтрибут( "ОснДоверФЛ", "Доверенность");
                                         ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
										 Если ЗначениеЗаполнено(ВыборкаДокумент.Водитель) Тогда
										      Водитель = РазложитьФИО(ВыборкаДокумент.Водитель);
										      ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Водитель.Фамилия);  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", Водитель.Имя); 
										  Иначе 
											  Сообщить("Нет сведений о водителе!");
											  ЗаписьXML.ЗаписатьАтрибут( "Фамилия", "Отсутствует");  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", "Отсутствует"); 
										  КонецЕсли;	  
										  
                                         ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО						  
						       ЗаписьXML.ЗаписатьКонецЭлемента();//-ФЛПер
						  ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнЛицо
                ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЛицПер
				ЗаписьXML.ЗаписатьНачалоЭлемента("ТранГруз");//+ТранГруз
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТранНакл");//+ТранНакл
					          ЗаписьXML.ЗаписатьАтрибут( "НомТранНакл",  ВыборкаДокумент.Номер);
							  ЗаписьXML.ЗаписатьАтрибут( "ДатаТранНакл", Формат(ВыборкаДокумент.ДатаТТН,"ДФ=дд.ММ.гггг"));
	                ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранНакл
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранГруз
				
              ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПер
           ЗаписьXML.ЗаписатьКонецЭлемента();//+СвПродПер

			//-----------------------------------------------------------------------------------------------------------
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
				ЗаписьXML.ЗаписатьАтрибут( "ОблПолн",  "6");
				ЗаписьXML.ЗаписатьАтрибут( "Статус",   "1");
				ЗаписьXML.ЗаписатьАтрибут( "ОснПолн",  "Должностные обязанности");
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
				
					СтруктураПодписант = ОтветственныйПоЭДО(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата);
					
			 		ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
					    ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
			
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.УПД);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
    СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	СтруктураПараметров.Вставить("НастройкаОбмена"		    , Справочники.абс_НастройкиEDIОбмена.НайтиПоНаименованию("Контур"));
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ДокументОтгрузки.Номер);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ДокументОтгрузки.Дата);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры


Функция НовыйКодОСУ(GTIN, Количество)
	
	КоличествоСтрокой = Формат(Количество, "ЧДЦ=0; ЧН=0; ЧГ=;");
	
	ЧастиКодаОСУ = Новый Массив;
	ЧастиКодаОСУ.Добавить("02");
	ЧастиКодаОСУ.Добавить(GTIN);
	ЧастиКодаОСУ.Добавить("37");
	ЧастиКодаОСУ.Добавить(КоличествоСтрокой);
	
	Результат = СоединитьСтроку(ЧастиКодаОСУ);
	
	Возврат Результат;
		
КонецФункции

Функция СоединитьСтроку(Строки, Разделитель = "")
	
	// Аналог: ЭДО_Служебные_МассивВСтроку
	// Отличия:
	// По умолчанию Разделитель = "", раньше Разделитель = Символы.ПС;
	// В параметр "Строки" не поддерживает тип "Строка".
	
	Результат		 = "";
	ТекРазделитель	 = "";
	
	Если ЗначениеЗаполнено(Строки) Тогда
		
		Для Каждого Строка Из Строки Цикл
			
			Если ЗначениеЗаполнено(Строка) Тогда
				Результат		 = Результат + ТекРазделитель + Строка;
				ТекРазделитель	 = Разделитель;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции


Процедура ВыгрузитьУПД_КонтурГУДС(ДокументОтгрузки, ЕстьОшибки) Экспорт
	//проверка наличия с/ф
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	Иначе
		Выборка 	= Результат.Выбрать();
		Выборка.Следующий();
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
	КонецЕсли;
	
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	СУММА(ВЫБОР
	|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|				ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
	|			ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
	|		КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС,
	|	РеализацияТоваровУслугТовары.НомерСтроки,
	|	СУММА(РеализацияТоваровУслугТовары.Количество * РеализацияТоваровУслугТовары.ЕдиницаИзмерения.Коэффициент / РеализацияТоваровУслугТовары.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент * РеализацияТоваровУслугТовары.Номенклатура.ЕдиницаХраненияОстатков.ВесНетто) КАК СуммаНетто
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20 
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.НомерСтроки
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	//|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
	
	|ЕстьNULL(Накладная.Ссылка.Сделка.Номер,Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке) КАК НомерЗаказа,
	
	//|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
	// ZAA - 1
	|ЕстьNULL(Накладная.Ссылка.Сделка.Дата,Накладная.Ссылка.Дата) КАК ДатаЗаказа,
	// ZAA - 2
	
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI КАК НомерДокументаEDIЗаказа,
	
	//|	Накладная.Ссылка.Сделка.ДатаПоДаннымПокупателя КАК ДатаДокументаEDI,
	// ZAA - 1
	|ЕстьNULL(Накладная.Ссылка.Сделка.ДатаПоДаннымПокупателя,Накладная.Ссылка.Дата) КАК ДатаДокументаEDI,
	// ZAA - 2

	|	Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
	|	Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
	|	Накладная.Ссылка.ВалютаДокумента КАК Валюта,
	|	Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
	|	Накладная.Ссылка.Организация КАК Организация,
	|	Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """") КАК НомерМагазина,
	|	Накладная.Ссылка.Грузополучатель КАК Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """") КАК КодПоставщика,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомленияОбОтгрузке,
		
	|	Накладная.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.Дата, Накладная.Ссылка.Дата) КАК ДатаТТН,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор) КАК Водитель,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность),
	//|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки) КАК ДатаИсполнения,
	
	|Выбор когда Накладная.Ссылка.Сделка = неопределено тогда
	|   ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Дата)
	|иначе
	|   ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки)
	|Конец как ДатаИсполнения,   
	
	
	
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI КАК ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ КАК ДатаПоставки
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НомерМагазина)) КАК СвойстваНомераМагазинов
	|		ПО Накладная.Ссылка.Грузополучатель = СвойстваНомераМагазинов.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодПоставщика)) КАК СвойствоКодПоставщика
	|		ПО Накладная.Ссылка.Контрагент = СвойствоКодПоставщика.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Ссылка.Номер,
	|	Накладная.Ссылка.Дата,
	//|	Накладная.Ссылка.Сделка.Номер,
	|ЕстьNULL(Накладная.Ссылка.Сделка.Номер,Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке),
	
	//|	Накладная.Ссылка.Сделка.Дата,
	|   ЕстьNULL(Накладная.Ссылка.Сделка.Дата,Накладная.Ссылка.Дата),
	
	|	Накладная.Ссылка.Организация.абс_GLN,
	|	Накладная.Ссылка.Контрагент.абс_GLN,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
	|	Накладная.Ссылка.Организация.ИНН,
	|	Накладная.Ссылка.Организация.КПП,
	|	Накладная.Ссылка.Организация.Лео_GUID,
	|	Накладная.Ссылка.Контрагент.Лео_GUID,
	|	Накладная.Ссылка.ВалютаДокумента,
	|	Накладная.Ссылка.ВалютаДокумента.Код,
	|	Накладная.Ссылка.Организация,
	|	Накладная.Ссылка.Грузоотправитель,
	|	Накладная.Ссылка.Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """"),
	|	Накладная.Ссылка.Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """"),
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ,
	//|	Накладная.Ссылка.Сделка.ДатаПоДаннымПокупателя,
	|ЕстьNULL(Накладная.Ссылка.Сделка.ДатаПоДаннымПокупателя,Накладная.Ссылка.Дата),

	//|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки),
	
	|Выбор когда Накладная.Ссылка.Сделка = неопределено тогда
	|   ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Дата)
	|иначе
	|   ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки)
	|Конец ,   
	
	
	
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.Дата, Накладная.Ссылка.Дата),
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СуммаНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование КАК ЕдиницаИзмерения,
	|	Накладная.Цена,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя,
	|	Накладная.Номенклатура.Артикул КАК Артикул,
	|	Накладная.НомерСтроки КАК НомерСтроки,
	|	Накладная.СуммаНетто
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.СерияНоменклатуры = Штрихкоды.СерияНоменклатуры
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(, ) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование,
	|	Накладная.Цена,
	|	Накладная.СуммаНДС,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства,
	|	Накладная.Номенклатура.Артикул,
	|	Накладная.НомерСтроки,
	|	Накладная.СуммаНетто
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	//////////////////////////////////////////////////////////////////////////////////////
	
	Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
		 Идентификатор = ВыборкаДокумент.ОператорEDI.Идентификатор;
	 Иначе	 
		 Идентификатор = "2IH";
	КонецЕсли;	
	
	    НомерОрганизацииВсистеме = ВыборкаДокумент.Организация.ИНН + "-" + "2012052807212505941080000000000";
	
	Если ЗначениеЗаполнено(ВыборкаДокумент.Контрагент.Лео_GUID) Тогда
		НомерКонтрагентаВсистеме = ВыборкаДокумент.Контрагент.ИНН + "-" + СОКРЛП(ВыборкаДокумент.Контрагент.Лео_GUID);
	Иначе
		НомерКонтрагентаВсистеме = ВыборкаДокумент.Контрагент.ИНН + "-" + СОКРЛП(абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ВыборкаДокумент.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Идентификатор участника ЭДО")));
    КонецЕсли;	
	
		
	ИдФайл = "ON_NSCHFDOPPR_" + Идентификатор + "-" + НомерКонтрагентаВсистеме + "_" + Идентификатор + "-" + НомерОрганизацииВсистеме + "_" + Формат(ДатаСФ,"ДФ=ггггММдд") + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор()) ;

    ИмяФайла = "UPD_" + ВыборкаДокумент.Номер + "_" + Формат(ВыборкаДокумент.Дата,"ДФ=ггггММдд");
	
	ИмяФайла = СформироватьИмяФайлаEDI(ИмяФайла);
	ИмяФайла = ИмяФайла + ".xml";

	
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку( "WINDOWS-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
	
		ЗаписьXML.ЗаписатьАтрибут( "xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance");

		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.01" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Diadoc 1.0" );

		 
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
			ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр",Идентификатор + "-" + НомерОрганизацииВсистеме);
			ЗаписьXML.ЗаписатьАтрибут( "ИдПол", Идентификатор + "-" + НомерКонтрагентаВсистеме);

		   ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
		   Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.ОператорEDI.Наименование);
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.ОператорEDI.Контрагент.ИНН);
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		   Иначе	  
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "Систем Групп Рус");
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   "7723749362");
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		  КонецЕсли;
         ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
			ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115131");
				   ЗаписьXML.ЗаписатьАтрибут( "Функция", "СЧФДОП");
			
			ЗаписьXML.ЗаписатьАтрибут( "ПоФактХЖ", "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
            ЗаписьXML.ЗаписатьАтрибут( "НаимДокОпр", "Счет-фактура и документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
			ЗаписьXML.ЗаписатьАтрибут( "ДатаИнфПр", Формат(ТекущаяДата(),"ДФ=дд.ММ.гггг")); // Дата формирования файла обмена СФ
			ЗаписьXML.ЗаписатьАтрибут( "ВремИнфПр", Формат(ТекущаяДата(), "ДФ=ЧЧ.мм.сс"));
			//ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное);
		ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное + ", ИНН-КПП: " + ВыборкаДокумент.Организация.ИНН + "-" + ВыборкаДокумент.Организация.КПП);

			
			//ЗаписьXML.ЗаписатьАтрибут( "ОснДоверОргСост", "Основание доверенности");    // Добавлено 28/07/2017 для Билла ООО
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвСчФакт");//+СвСчФакт 
				ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", НомерСФ);
				ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") );              
				ЗаписьXML.ЗаписатьАтрибут( "КодОКВ", ВыборкаДокумент.КодВалюты);
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИспрСчФ");//+СвСчФакт 
						  ЗаписьXML.ЗаписатьАтрибут( "ДефДатаИспрСчФ", "-");
				          ЗаписьXML.ЗаписатьАтрибут( "ДефНомИспрСчФ", "-");
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ИспрСчФ
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг",ВыборкаДокумент.Организация.НаименованиеСокращенное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						
						СведенияОПродавец = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
						Если ЗначениеЗаполнено(СведенияОПродавец.Телефоны) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПродавец.Телефоны,20));
						КонецЕсли;	
							ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", "mail@leovit.ru");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
						////////////////////////////////////////////						
						СведенияОПродавце = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
						Если ЗначениеЗаполнено(СведенияОПродавце.НомерСчета) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПродавце.НомерСчета);
						КонецЕсли;	   
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
						Если ЗначениеЗаполнено(СведенияОПродавце.БИК) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПродавце.Банк.Наименование);
							ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПродавце.БИК);
						КонецЕсли;	 
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
                         /////////////////////////////
						
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод
				
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОт");//+ГрузОт 
					ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОтпр");//+ГрузОтпр
					ЗаписьXML.ЗаписатьАтрибут( "ОКПО", Строка(ВыборкаДокумент.Грузоотправитель.КодПоОКПО));     

					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Грузоотправитель.НаименованиеПолное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Грузоотправитель.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Грузоотправитель.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузоотправитель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						СведенияОГрузоотправитель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузоотправитель,  ВыборкаДокумент.Дата);

							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.Телефоны) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузоотправитель.Телефоны,20));
									   КонецЕсли;	
									   ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Грузоотправитель);
									   Если ЗначениеЗаполнено(ЭлПочта) Тогда
											   ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
									   КонецЕсли;
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт

							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.НомерСчета) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузоотправитель.НомерСчета);
									  КонецЕсли;	   
									  ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
									            Если ЗначениеЗаполнено(СведенияОГрузоотправитель.БИК) Тогда
									                 ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузоотправитель.Банк.Наименование);
												     ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузоотправитель.БИК);
													 ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОГрузоотправитель.КоррСчет);
												КонецЕсли;	 
                                      ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв

					ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОтпр
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОт
				
				СведенияОГрузополучатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузополучатель,  ВыборкаДокумент.Дата);

				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузПолуч");//+ГрузПолуч
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						Если ВыборкаДокумент.Контрагент.ЮрФизЛицо  = Перечисления.ЮрФизЛицо.ЮрЛицо  Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
							Если ЗначениеЗаполнено(ВыборкаДокумент.НомерМагазина) Тогда
								ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.НомерМагазина);
							Иначе
								ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.Грузополучатель.НаименованиеПолное);
							КонецЕсли;
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОГрузополучатель.ИНН );
							ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОГрузополучатель.КПП );
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
						Иначе
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвИП");//+СвИП
							ЗаписьXML.ЗаписатьАтрибут( "ИННФЛ", ВыборкаДокумент.Грузополучатель.ИНН);  

							ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
							МассивФИО = СтрРазделить(СтрЗаменить(ВыборкаДокумент.Контрагент.НаименованиеПолное,"ИП ",""), " ");
							Попытка
								Фамилия = МассивФИО[0];
								Имя =  МассивФИО[1];
								Отчество = МассивФИО[2];
							Исключение
								Фамилия = ВыборкаДокумент.Контрагент.НаименованиеПолное;
								Имя =  "";
								Отчество = "";
							КонецПопытки;
							
							ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Фамилия);  
							ЗаписьXML.ЗаписатьАтрибут( "Имя",Имя); 
							ЗаписьXML.ЗаписатьАтрибут( "Отчество", Отчество);
							
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвИП
							
						КонецЕсли;  
							  
							  
							  
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
						Если ВыборкаДокумент.Грузополучатель.Код = "УТ0003623" Тогда   // Система К
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
						Иначе	
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента);
						КонецЕсли;	
						Если СтруктураАдреса.Количество() = 0 Тогда
							Сообщить("Не указан " + Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента + " " + ВыборкаДокумент.Грузополучатель);
							    Возврат;
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;

						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
					//////////////////////////////////////////////////////////////////////
					
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.Телефоны) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузополучатель.Телефоны,20));
							КонецЕсли;	
							ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Грузополучатель);
							Если ЗначениеЗаполнено(ЭлПочта) Тогда
								Если НЕ ВыборкаДокумент.Контрагент.Код = "УТ0003623" Тогда // Для Система-К не передаем
									ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
								КонецЕсли;
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.НомерСчета) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузополучатель.НомерСчета);
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.БИК) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузополучатель.Банк.Наименование);
								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузополучатель.БИК);
								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОГрузополучатель.КоррСчет);
							КонецЕсли;	 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
					
					//////////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузПолуч
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
					Если ВыборкаДокумент.Контрагент.ЮрФизЛицо  = Перечисления.ЮрФизЛицо.ЮрЛицо  Тогда
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Контрагент.НаименованиеПолное);  
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Контрагент.ИНН);  
						ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Контрагент.КПП);
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					Иначе
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвИП");//+СвИП
								ЗаписьXML.ЗаписатьАтрибут( "ИННФЛ", ВыборкаДокумент.Контрагент.ИНН);  

							    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
								МассивФИО = СтрРазделить(СтрЗаменить(ВыборкаДокумент.Контрагент.НаименованиеПолное,"ИП ",""), " ");
	                               Попытка
	                               Фамилия = МассивФИО[0];
                                   Имя =  МассивФИО[1];
                                   Отчество = МассивФИО[2];
							   Исключение
								   Фамилия = ВыборкаДокумент.Контрагент.НаименованиеПолное;
                                   Имя =  "";
                                   Отчество = "";
								   КонецПопытки;
								
						          ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Фамилия);  
			 			          ЗаписьXML.ЗаписатьАтрибут( "Имя",Имя); 
					              ЗаписьXML.ЗаписатьАтрибут( "Отчество", Отчество);
								  
			                    ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО

 		                    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвИП
					КонецЕсли;	
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
                        ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							СведенияОПокупатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Контрагент,  ВыборкаДокумент.Дата);
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							Если ЗначениеЗаполнено(СведенияОПокупатель.Телефоны) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПокупатель.Телефоны,20));
							КонецЕсли;	
							ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Контрагент);
							Если ЗначениеЗаполнено(ЭлПочта) Тогда
								Если НЕ ВыборкаДокумент.Контрагент.Код = "УТ0003623" Тогда // Для Система-К не передаем
									ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
								КонецЕсли;
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							Если ЗначениеЗаполнено(СведенияОПокупатель.НомерСчета) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПокупатель.НомерСчета);
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							Если ЗначениеЗаполнено(СведенияОПокупатель.БИК) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПокупатель.Банк.Наименование);
								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПокупатель.БИК);
								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОПокупатель.КоррСчет);
							КонецЕсли;	 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
				
					ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСвФХЖ1");//+ИнфПолФХЖ1
		         ЗаписьXML.ЗаписатьАтрибут( "НаимОКВ", "Российский рубль");
				 ЗаписьXML.ЗаписатьАтрибут( "КурсВал", "1");
				ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
				
				//////////////////////////////////////////////////////////////
				//Постановление 534}
				ДокументыОбОтгрузке = "";
				ИтогоСтрок =0;
				Если Выборка.Ссылка.Дата >= Дата("20241001") Тогда  
				     ДокументыОбОтгрузке = "Универсальный передаточный документ, №" + НомерСФ + " от " + Формат(ДатаСФ, "ДЛФ='Д'") + " г.";  
				Иначе	
				Для Каждого СтрДокОснования Из Выборка.Ссылка.ДокументыОснования Цикл
					// Получить экземпляр документа на печать
					
					Если НЕ ЗначениеЗаполнено(СтрДокОснования.ДокументОснование) Тогда
						Продолжить;
					КонецЕсли;
					
					ДокументыОбОтгрузке = ?(ЗначениеЗаполнено(ДокументыОбОтгрузке),ДокументыОбОтгрузке + "; ","");
					ПерваяСтрокаПоДокументуОтгрузки = 1;
					ПоследняяСтрокаПоДокументуОтгрузки = СтрДокОснования.ДокументОснование.Товары.Количество();
					Если ПерваяСтрокаПоДокументуОтгрузки = ПоследняяСтрокаПоДокументуОтгрузки Тогда
						ДиапазонСтрок = "" + Строка(ПерваяСтрокаПоДокументуОтгрузки + ИтогоСтрок);
					Иначе
						ДиапазонСтрок = "" + Строка(ПерваяСтрокаПоДокументуОтгрузки + ИтогоСтрок) + "-" + Строка(ПоследняяСтрокаПоДокументуОтгрузки + ИтогоСтрок);
					КонецЕсли;
					ИтогоСтрок =  ИтогоСтрок + ПоследняяСтрокаПоДокументуОтгрузки;
					ДокументыОбОтгрузке = ДокументыОбОтгрузке + "п/п " + ДиапазонСтрок + " Универсальный передаточный документ, №" + НомерСФ + " от " + Формат(СтрДокОснования.ДокументОснование.Дата, "ДЛФ='Д'") + " г.";  
				КонецЦикла;	
				КонецЕсли;
				/////////////////////////////////////////////////////////////
				//Постановление 534}	

				 ЗаписьXML.ЗаписатьНачалоЭлемента("ДокПодтвОтгр");//+ДокПодтвОтгр
				 
				 ЗаписьXML.ЗаписатьАтрибут( "НаимДокОтгр", "Товарная накладная");
				 //ЗаписьXML.ЗаписатьАтрибут( "НомДокОтгр", ВыборкаДокумент.Номер);
				 ЗаписьXML.ЗаписатьАтрибут( "НомДокОтгр", ДокументыОбОтгрузке);

				 ЗаписьXML.ЗаписатьАтрибут( "ДатаДокОтгр",  Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
				 
                 ЗаписьXML.ЗаписатьКонецЭлемента(); // ДокПодтвОтгр
				 
				 
			

				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ1");//+ИнфПолФХЖ1
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					     ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "отправитель");
						 ЗаписьXML.ЗаписатьАтрибут( "Значен",  "4607932679999");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					///////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузоотправитель");
					ЗаписьXML.ЗаписатьАтрибут( "Значен",  ВыборкаДокумент.Грузоотправитель.абс_GLN);
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				//	
				//	///////////////////////////////////////////////////////////////////////////////////////////////////////
				//	ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
				//		ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "получатель");
				//			ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNКонтрагента));
				//ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				//	
				//	////////////////////////////////////////////////////////////////////////////////////////////////////////
				//	ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
				//		ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузополучатель");
				//		ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
				//	ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				//	////////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_заказа");
			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ВыборкаДокумент.ДатаДокументаEDI,"ДФ=дд.ММ.гггг"));
						//ДатаПоДаннымПокупателя
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					Если ЗначениеЗаполнено(ВыборкаДокумент.НомерДокументаEDIЗаказа) Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
					ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					КонецЕсли;
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_накладной");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ДокументОтгрузки.Номер));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_накладной");
			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ДатаСФ,"ДФ=дд.ММ.гггг")); 
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					//ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ИнфПолСтр
					//	ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_акта");
					//	ЗаписьXML.ЗаписатьАтрибут( "Значен", ?(ЗначениеЗаполнено(ДокументОтгрузки.абс_НомерУведомленияОПриемке),ДокументОтгрузки.абс_НомерУведомленияОПриемке,"б/н"));
					//ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр
					//////////////////////////////////////////////////////////////////////////////////////////////////////////
					//ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					//	ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_поставщика");
					// 	ЗаписьXML.ЗаписатьАтрибут( "Значен",УдалитьЛидирующиеНули(ВыборкаДокумент.КодПоставщика));
					//ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

		 		ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
				
			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвСчФакт
			
			// --------------------ТАБЛИЧНАЯ ЧАСТЬ---------------------

			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблСчФакт");//+ТаблСчФакт
			    КолНетто = 0;
			    ВыборкаСтрока=Результат[2].Выбрать();
				сч = 1;
				
				Пока ВыборкаСтрока.Следующий() Цикл
	
					ЕдиницаГУДС = Справочники.ЕдиницыИзмерения.НайтиПоНаименованию("ГУДС", Истина, , ВыборкаСтрока.Номенклатура);
					КоэффициентГУДС = 1;
					Попытка
						КоэффициентГУДС = ЕдиницаГУДС.Коэффициент;	
					Исключение
						Сообщить("Для товара не установлена единица продажи ГУДС (Артикул: " + ВыборкаСтрока.Номенклатура + ")" );
					КонецПопытки;	
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомСтр", Строка(сч));
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.НаименованиеПолное);	
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов","778");
					    ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество/КоэффициентГУДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов",  Формат(ВыборкаСтрока.Цена*КоэффициентГУДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат( ВыборкаСтрока.СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат( ВыборкаСтрока.СуммаБезНДС + ВыборкаСтрока.СуммаНДС , "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "НалСт", "" + Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0;" ) + "%" );
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Акциз");//+Акциз
							ЗаписатьXML(ЗаписьXML,"без акциза","БезАкциз");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Акциз
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал");//+СумНал;
							ЗаписатьXML(ЗаписьXML,Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНал
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСведТов");//+ДопСведТов
						ЗаписьXML.ЗаписатьАтрибут( "ПрТовРаб", "1");
						ЗаписьXML.ЗаписатьАтрибут( "КодТов", СокрЛП(Строка(ВыборкаСтрока.Штрихкод)));
						ЗаписьXML.ЗаписатьАтрибут( "НаимЕдИзм", "упак");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ДопСведТов
						
						Если ЗначениеЗаполнено(ВыборкаДокумент.НомерДокументаEDIЗаказа) Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						КонецЕсли;
						Если ЗначениеЗаполнено(ВыборкаСтрока.АртикулПокупателя) Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала");
							АртикулПокупателя = СтрЗаменить(ВыборкаСтрока.АртикулПокупателя,"*","");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(АртикулПокупателя)));
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала_заказчика");
							АртикулПокупателя = СтрЗаменить(ВыборкаСтрока.АртикулПокупателя,"*","");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(АртикулПокупателя)));
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						КонецЕсли;
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_уведомления_об_отгрузке");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерУведомленияОбОтгрузке));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "штрихкод");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(ВыборкаСтрока.Штрихкод)));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2

                        ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_продавца");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(ВыборкаСтрока.Артикул)));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2

					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
					КолНетто = КолНетто + ВыборкаСтрока.СуммаНетто;
				КонецЦикла;
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоОпл");//+ВсегоОпл
					ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", Формат(ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
		 			ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",Формат( ДокументОтгрузки.абс_СуммаСНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
						ЗаписатьXML(ЗаписьXML,Формат(ДокументОтгрузки.абс_СуммаСНДС - ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
					ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего

				    ЗаписатьXML(ЗаписьXML,Формат(КолНетто, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"КолНеттоВс");

				ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоОпл
 			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблСчФакт
			
			//-----------------------------------------------------------------------------------------------------------
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПродПер");//+СвПродПер

			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПер");//+СвПер
					ЗаписьXML.ЗаписатьАтрибут( "СодОпер", "Товары переданы");
		            ЗаписьXML.ЗаписатьАтрибут( "ДатаПер", Формат(ВыборкаДокумент.ДатаИсполнения,"ДФ=дд.ММ.гггг"));

			     ЗаписьXML.ЗаписатьНачалоЭлемента("ОснПер");//+ОснПер
				           ДокОснование   = ВыборкаДокумент.ДоговорКонтрагента.Наименование;
						   НомерОснования =  ВыборкаДокумент.ДоговорКонтрагента.Номер;
						   ДатаОснования  = Формат(ВыборкаДокумент.ДоговорКонтрагента.Дата,"ДФ=дд.ММ.гггг");
						   Если ЗначениеЗаполнено(ДокОснование) и ЗначениеЗаполнено(НомерОснования) и ЗначениеЗаполнено(ДатаОснования) Тогда  
				                ЗаписьXML.ЗаписатьАтрибут( "НаимОсн", ДокОснование);
				                ЗаписьXML.ЗаписатьАтрибут( "НомОсн",  НомерОснования);
						        ЗаписьXML.ЗаписатьАтрибут( "ДатаОсн", ДатаОснования);
							Иначе
								ЗаписьXML.ЗаписатьАтрибут( "НаимОсн", "Без документа-основания");
						   КонецЕсли;	
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ОснПер
				 ЗаписьXML.ЗаписатьНачалоЭлемента("СвЛицПер");//+СвЛицПер
				           ЗаписьXML.ЗаписатьНачалоЭлемента("ИнЛицо");//+ИнЛицо
                               ЗаписьXML.ЗаписатьНачалоЭлемента("ФЛПер");//+ФЛПер
										 ЗаписьXML.ЗаписатьАтрибут( "ОснДоверФЛ", "Доверенность");
                                         ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
										 Если ЗначениеЗаполнено(ВыборкаДокумент.Водитель) Тогда
										      Водитель = РазложитьФИО(ВыборкаДокумент.Водитель);
										      ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Водитель.Фамилия);  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", Водитель.Имя); 
										  Иначе 
											  Сообщить("Нет сведений о водителе!");
											  ЗаписьXML.ЗаписатьАтрибут( "Фамилия", "Отсутствует");  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", "Отсутствует"); 
										  КонецЕсли;	  
										  
                                         ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО						  
						       ЗаписьXML.ЗаписатьКонецЭлемента();//-ФЛПер
						  ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнЛицо
                ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЛицПер
				ЗаписьXML.ЗаписатьНачалоЭлемента("ТранГруз");//+ТранГруз
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТранНакл");//+ТранНакл
					          ЗаписьXML.ЗаписатьАтрибут( "НомТранНакл",  ВыборкаДокумент.Номер);
							  ЗаписьXML.ЗаписатьАтрибут( "ДатаТранНакл", Формат(ВыборкаДокумент.ДатаТТН,"ДФ=дд.ММ.гггг"));
	                ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранНакл
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранГруз
				
              ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПер
           ЗаписьXML.ЗаписатьКонецЭлемента();//+СвПродПер

			//-----------------------------------------------------------------------------------------------------------
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
				ЗаписьXML.ЗаписатьАтрибут( "ОблПолн",  "6");
				ЗаписьXML.ЗаписатьАтрибут( "Статус",   "1");
				ЗаписьXML.ЗаписатьАтрибут( "ОснПолн",  "Должностные обязанности");
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
				
					СтруктураПодписант = ОтветственныйПоЭДО(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата);
					
			 		ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
					    ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
			
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.УПД);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
    СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	СтруктураПараметров.Вставить("НастройкаОбмена"		    , Справочники.абс_НастройкиEDIОбмена.НайтиПоНаименованию("Контур"));
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ДокументОтгрузки.Номер);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ДокументОтгрузки.Дата);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры


Процедура ВыгрузитьНакладнуюDeliverynoteКорус(ДокументОтгрузки, ЕстьОшибки = Ложь) Экспорт	
		//проверка наличия с/ф
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	Иначе
		Выборка 	= Результат.Выбрать();
		Выборка.Следующий();
		
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
	КонецЕсли;
	
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	РеализацияТоваровУслугТовары.Сумма,
	|	РеализацияТоваровУслугТовары.СуммаНДС,
	|	РеализацияТоваровУслугТовары.СтавкаНДС
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	РеализацияТоваровУслугТовары.Сумма,
	|	РеализацияТоваровУслугТовары.СуммаНДС,
	|	РеализацияТоваровУслугТовары.СтавкаНДС
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомления,
	|	Накладная.Ссылка.абс_ДатаУведомленияОбОтгрузке КАК ДатаУведомления,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI КАК НомерЗаказа,
	|	ВЫБОР
	|		КОГДА Накладная.Ссылка.Сделка.ДокументОснование ССЫЛКА Документ.абс_СообщениеEDI
	|			ТОГДА Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI
	|		ИНАЧЕ Накладная.Ссылка.Сделка.Дата
	|	КОНЕЦ КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа, """") КАК НомерДокументаEDIЗаказа,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
	|	Накладная.Ссылка.ДоговорКонтрагента.Номер КАК НомерДоговора,
	|	Накладная.Ссылка.ДоговорКонтрагента.Дата КАК ДатаДоговора,
	|	ЕСТЬNULL(Накладная.Ссылка.абс_Водитель.Наименование, """") КАК Водитель,
	|	ЕСТЬNULL(Накладная.Ссылка.абс_ТранспортноеСредство.Марка, """") КАК МаркаТС,
	|	ЕСТЬNULL(Накладная.Ссылка.абс_ТранспортноеСредство.ГосНомер, """") КАК ГосНомерТС,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ВсегоКоличествоКоробов, Накладная.Ссылка.абс_КоличествоТранспортныхКоробов) КАК КоличествоКоробов,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ВсегоКоличествоПалет, Накладная.Ссылка.абс_КоличествоПаллет) КАК КоличествоПаллет,
	|	ВЫБОР
	|		КОГДА Накладная.Ссылка.Сделка.Лео_ПодтвержденнаяДатаДоставки = &ПустаяДата
	|			ТОГДА ВЫБОР
	|					КОГДА Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ = &ПустаяДата
	|						ТОГДА Накладная.Ссылка.Сделка.ДатаОтгрузки
	|					ИНАЧЕ Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ
	|				КОНЕЦ
	|		ИНАЧЕ Накладная.Ссылка.Сделка.Лео_ПодтвержденнаяДатаДоставки
	|	КОНЕЦ КАК ДатаДоставки,
	|	Накладная.Ссылка,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	Накладная.Ссылка.Организация КАК Организация,
	|	Накладная.Ссылка.Грузоотправитель.абс_GLN КАК GLNГрузоотправителя
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	ЕСТЬNULL(абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства, """") КАК АртикулПокупателя,
	|	ЕСТЬNULL(ЗаказыПокупателейОбороты.КоличествоПриход, 0) КАК КоличествоЗаказано,
	|	ЕСТЬNULL(Накладная.Количество, 0) КАК Количество,
	|	ЕСТЬNULL(Накладная.Цена, 0) КАК Цена,
	|	ЕСТЬNULL(Накладная.Номенклатура, ЗаказыПокупателейОбороты.Номенклатура) КАК Номенклатура,
	|	ВЫБОР
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|			ТОГДА 18
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|			ТОГДА 10
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|			ТОГДА 20 
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|			ТОГДА 5
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|			ТОГДА 7
	|						ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС,
	|	Накладная.Сумма,
	|	Накладная.СуммаНДС
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|			И (Штрихкоды.СерияНоменклатуры = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗаказыПокупателей.Обороты(&НачалоПериода, &КонецПериода, , ЗаказПокупателя = &ЗаказПокупателя) КАК ЗаказыПокупателейОбороты
	|		ПО Накладная.Номенклатура = ЗаказыПокупателейОбороты.Номенклатура
	|			И Накладная.ЕдиницаИзмерения = ЗаказыПокупателейОбороты.ЕдиницаИзмерения
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	ЕСТЬNULL(Накладная.Номенклатура, ЗаказыПокупателейОбороты.Номенклатура),
	|	ЕСТЬNULL(Накладная.Цена, 0),
	|	ЕСТЬNULL(абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства, """"),
	|	ЕСТЬNULL(Накладная.Количество, 0),
	|	Накладная.Сумма,
	|	Накладная.СуммаНДС,
	|	ЕСТЬNULL(ЗаказыПокупателейОбороты.КоличествоПриход, 0),
	|	ВЫБОР
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|			ТОГДА 18
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|			ТОГДА 10
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|			ТОГДА 20 
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|			ТОГДА 5
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ");
	
	Запрос.УстановитьПараметр("Ссылка"			, ДокументОтгрузки);
	Запрос.УстановитьПараметр("ЗаказПокупателя"	, ДокументОтгрузки.Сделка);
	Запрос.УстановитьПараметр("НачалоПериода"	, ДокументОтгрузки.Сделка.Дата);
	Запрос.УстановитьПараметр("КонецПериода"	, ДокументОтгрузки.Сделка.Дата);
	Запрос.УстановитьПараметр("ПустаяДата"		, '00010101000000');
	
	Отказ = Ложь;
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();
	
	НомерНакладной = ОбщегоНазначения.ПолучитьНомерНаПечать(ВыборкаДокумент.Ссылка);
	
	ИмяФайла = СформироватьИмяФайлаEDI("DELIVERYNOTE_" + Формат(ВыборкаДокумент.ДатаЗаказа,"ДФ=ггггММдд") + "_" + СокрЛП(ВыборкаДокумент.НомерЗаказа)) + ".xml";
	Запись=Новый ЗаписьXML;
	Запись.УстановитьСтроку("UTF-8");
	Запись.ЗаписатьОбъявлениеXML();
	
	Запись.ЗаписатьНачалоЭлемента("Document-Invoice");
		Запись.ЗаписатьНачалоЭлемента("Invoice-Header");
		    ЗаписатьXML(Запись,СокрЛП(НомерНакладной)  										, "InvoiceNumber");			//номер Delnote
			ЗаписатьXML(Запись,Формат(ВыборкаДокумент.Дата, "ДФ=гггг-ММ-дд")				, "InvoiceDate"); 			//дата Delnote
			ЗаписатьXML(Запись,"RUB"														, "InvoiceCurrency");		//валюта
			ЗаписатьXML(Запись,"D"    														, "DocumentFunctionCode"); 	//тип документа DELIVERYNOTE			
			
			Запись.ЗаписатьНачалоЭлемента("Delivery");	
				ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ДатаДоставки,"ДФ=гггг-ММ-дд")	, "DeliveryDate"); 			//дата поставки
			Запись.ЗаписатьКонецЭлемента(); //Delivery		
		Запись.ЗаписатьКонецЭлемента(); //Invoice-Header
		
		Запись.ЗаписатьНачалоЭлемента("Invoice-Reference");
			Запись.ЗаписатьНачалоЭлемента("Order");
				ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.НомерЗаказа)						, "BuyerOrderNumber"); 		//номер заказа клиента
			Запись.ЗаписатьКонецЭлемента(); //Order
			
			Запись.ЗаписатьНачалоЭлемента("TaxInvoice");
				ЗаписатьXML(Запись, СокрЛП(НомерСФ)											, "TaxInvoiceNumber"); 		//номер Invoice
				ЗаписатьXML(Запись, Формат(ДатаСФ,"ДФ=гггг-ММ-дд")							, "TaxInvoiceDate"); 		//дата Invoice
			Запись.ЗаписатьКонецЭлемента(); //TaxInvoice
		Запись.ЗаписатьКонецЭлемента(); //Invoice-Reference
		
		Запись.ЗаписатьНачалоЭлемента("Invoice-Parties");
			Запись.ЗаписатьНачалоЭлемента("Buyer");
		    	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNКонтрагента)					, "ILN"); 					//GLN покупателя
				ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.Контрагент.ИНН)					, "TaxID"); 				//ИНН покупателя
			Запись.ЗаписатьКонецЭлемента(); //Buyer
			
			Запись.ЗаписатьНачалоЭлемента("Seller");
		    	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNОрганизации)					, "ILN"); 					//GLN продавца
				ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.Организация.ИНН)					, "TaxID"); 				//ИНН продавца
			Запись.ЗаписатьКонецЭлемента(); //Seller

			Запись.ЗаписатьНачалоЭлемента("Consignor");
		    	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузоотправителя)				, "ILN"); 					//GLN грузоотправителя
			Запись.ЗаписатьКонецЭлемента(); //Consignor
			
			Запись.ЗаписатьНачалоЭлемента("DeliveryPoint");
		    	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)				, "ILN"); 					//GLN точки доставки
			Запись.ЗаписатьКонецЭлемента(); //DeliveryPoint

			Запись.ЗаписатьНачалоЭлемента("Invoicee");
		    	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNКонтрагента)									, "ILN"); 					//GLN получателя накладной
			Запись.ЗаписатьКонецЭлемента(); //Invoicee
		Запись.ЗаписатьКонецЭлемента(); //Invoice-Parties
		
		Запись.ЗаписатьНачалоЭлемента("Invoice-Lines");
		
			ТаблицаНоменклатуры = Результат[2].Выгрузить();
			сч=1;
			Для каждого ВыборкаСтрока из ТаблицаНоменклатуры Цикл
				
				Попытка
					ШтрихкодДляВыгрузки = Число(СокрЛП(ВыборкаСтрока.Штрихкод));
				Исключение
					ОбщегоНазначения.СообщитьОбОшибке("В номенклатуре: " + ВыборкаСтрока.Номенклатура + ", артикул: " + ВыборкаСтрока.Номенклатура.Артикул + " ошибка преобразования штрихкода в число: " + ВыборкаСтрока.Штрихкод, Отказ);
				КонецПопытки;		
				
				Запись.ЗаписатьНачалоЭлемента("Line");
					Запись.ЗаписатьНачалоЭлемента("Line-Item");
						ЗаписатьXML(Запись, сч											, "LineNumber"); 				//номер товарной позици
						ЗаписатьXML(Запись, ШтрихкодДляВыгрузки							, "EAN"); 						//Штрихкод продукта
						Если ЗначениеЗаполнено(ВыборкаСтрока.АртикулПокупателя) Тогда
							ЗаписатьXML(Запись, ВыборкаСтрока.АртикулПокупателя			, "BuyerItemCode"); 			//код товара в системе покупателя
						КонецЕсли;
						ЗаписатьXML(Запись,СокрЛП(ВыборкаСтрока.Номенклатура.Артикул)	, "SupplierItemCode"); 			//код товара в системе покупателя
                        ЗаписатьXML(Запись,СокрЛП(ВыборкаСтрока.Номенклатура.Артикул)	, "ItemDescription"); 			//наименование товарной позиции
						ЗаписатьXML(Запись, "CU"										, "ItemType"); 		  			//поставляемое количество
						ЗаписатьXML(Запись, ВыборкаСтрока.Количество					, "InvoiceQuantity"); 			//поставляемое количество
						ЗаписатьXML(Запись, "PCE"										, "UnitOfMeasure");   			//поставляемое количество
						ЗаписатьXML(Запись, ВыборкаСтрока.Цена							, "InvoiceUnitNetPrice"); 		//цена без НДС
                        ЗаписатьXML(Запись, "1"											, "OrderedUnitPacksize"); 		//количество в упаковке
						ЗаписатьXML(Запись, ВыборкаСтрока.СтавкаНДС						, "TaxRate"); 					//Ставка налога (НДС, %)
						ЗаписатьXML(Запись, ВыборкаСтрока.СуммаНДС						, "TaxAmount"); 				//сумма НДС
						ЗаписатьXML(Запись, ВыборкаСтрока.Сумма							, "NetAmount"); 				//сумма без НДС
						ЗаписатьXML(Запись, ВыборкаСтрока.СуммаНДС + ВыборкаСтрока.Сумма, "GrossAmount"); 				//сумма с НДС
						ЗаписатьXML(Запись, "RU"										, "CountryOfOriginCode"); 		//код страны происхождения товара
				    Запись.ЗаписатьКонецЭлемента(); //Line-Item
					
				Запись.ЗаписатьКонецЭлемента(); //Line
				
				сч = сч + 1;
				
			КонецЦикла;
		Запись.ЗаписатьКонецЭлемента(); //Invoice-Lines
		
		Запись.ЗаписатьНачалоЭлемента("Invoice-Summary");
			ЗаписатьXML(Запись, ТаблицаНоменклатуры.Количество() 			, "TotalLines"); 					//количество строк
			ЗаписатьXML(Запись, ВыборкаДокумент.Ссылка.абс_СуммаБезНДС		, "TotalNetAmount"); 				//общая сумма без НДС
			ЗаписатьXML(Запись, ВыборкаДокумент.Ссылка.абс_СуммаСНДС -	ВыборкаДокумент.Ссылка.абс_СуммаБезНДС	, "TotalTaxAmount"); 				//общая сумма НДС
			ЗаписатьXML(Запись, ВыборкаДокумент.Ссылка.абс_СуммаСНДС  		, "TotalGrossAmount"); 				//общая сумма с НДС
			
			НДСПоСтрокам = ТаблицаНоменклатуры.Скопировать(, "СтавкаНДС,СуммаНДС,Сумма"); 
			НДСПоСтрокам.Свернуть( "СтавкаНДС","СуммаНДС,Сумма");
			Запись.ЗаписатьНачалоЭлемента("Tax-Summary");
				Для каждого СтрокаНДС из НДСПоСтрокам Цикл
					Запись.ЗаписатьНачалоЭлемента("Tax-Summary-Line");
						ЗаписатьXML(Запись, СтрокаНДС.СтавкаНДС		, "TaxRate"); 					//ставка НДС
						ЗаписатьXML(Запись, СтрокаНДС.СуммаНДС		, "TaxAmount"); 				//общая сумма НДС
						ЗаписатьXML(Запись, СтрокаНДС.Сумма		, "TaxableAmount"); 	        //общая сумма без НДС
					Запись.ЗаписатьКонецЭлемента(); //Tax-Summary-Line
			    КонецЦикла;
			Запись.ЗаписатьКонецЭлемента(); //Tax-Summary
		Запись.ЗаписатьКонецЭлемента(); //Invoice-Summary
	Запись.ЗаписатьКонецЭлемента(); //Document-Invoice


	
	ТекстXML=Запись.Закрыть();
	
	//СтруктураПараметров = Новый Структура;
	//СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.УведомлениеОбОтгрузке);
	//СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	//СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	//СтруктураПараметров.Вставить("GLNПокупателя"			, СокрЛП(ВыборкаДокумент.GLNКонтрагента));
	//СтруктураПараметров.Вставить("GLNГрузополучателя"		, СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
	//СтруктураПараметров.Вставить("GLNПоставщика"			, СокрЛП(ВыборкаДокумент.GLNОрганизации));
	//// << Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
	//Если ДокументОтгрузки.Организация.Код = "О00000001" Тогда
	//	СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su);
	//ИначеЕсли ДокументОтгрузки.Организация.Код = "О00000003" Тогда
	//	СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit);
	//КонецЕсли;
	//// >> Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
	//СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	//СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерДокументаEDIЗаказа);
	//СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаДокументаEDI);
	//
	//СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры

//Процедура формирует Текст XML для последующего формирования документа СообщениеEDI
Процедура ВыгрузитьУведомлениеОбОтгрузкеРЦ(ДокументОтгрузки, ЕстьОшибки = Ложь) Экспорт
	 //{ Лео Катанович
	//проверка наличия с/ф
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	Иначе
		Выборка 	= Результат.Выбрать();
		Выборка.Следующий();
		
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
	КонецЕсли;

	//Лео Катанович}
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	РеализацияТоваровУслугТовары.СтавкаНДС
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	РеализацияТоваровУслугТовары.СтавкаНДС
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомления,
	|	Накладная.Ссылка.абс_ДатаУведомленияОбОтгрузке КАК ДатаУведомления,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI КАК НомерЗаказа,
	|	ВЫБОР
	|		КОГДА Накладная.Ссылка.Сделка.ДокументОснование ССЫЛКА Документ.абс_СообщениеEDI
	|			ТОГДА Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI
	|		ИНАЧЕ Накладная.Ссылка.Сделка.Дата
	|	КОНЕЦ КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа, """") КАК НомерДокументаEDIЗаказа,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
	|	Накладная.Ссылка.ДоговорКонтрагента.Номер КАК НомерДоговора,
	|	Накладная.Ссылка.ДоговорКонтрагента.Дата КАК ДатаДоговора,
	|	ЕСТЬNULL(Накладная.Ссылка.абс_Водитель.Наименование, """") КАК Водитель,
	|	ЕСТЬNULL(Накладная.Ссылка.абс_ТранспортноеСредство.Марка, """") КАК МаркаТС,
	|	ЕСТЬNULL(Накладная.Ссылка.абс_ТранспортноеСредство.ГосНомер, """") КАК ГосНомерТС,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ВсегоКоличествоКоробов, Накладная.Ссылка.абс_КоличествоТранспортныхКоробов) КАК КоличествоКоробов,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ВсегоКоличествоПалет, Накладная.Ссылка.абс_КоличествоПаллет) КАК КоличествоПаллет,
	|	ВЫБОР
	|		КОГДА Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ = &ПустаяДата
	|			ТОГДА Накладная.Ссылка.Сделка.ДатаОтгрузки
	|		ИНАЧЕ Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ
	|	КОНЕЦ КАК ДатаДоставки,
	|	Накладная.Ссылка,
	|	Накладная.Ссылка.Контрагент КАК Контрагент
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РеализацияТоваровУслугЛео_Паллеты.Номенклатура,
	|	РеализацияТоваровУслугЛео_Паллеты.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугЛео_Паллеты.Количество,
	|	РеализацияТоваровУслугЛео_Паллеты.ШтрихкодПаллеты КАК ШтрихкодПаллеты,
	|	ЕСТЬNULL(абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства, """") КАК АртикулПокупателя,
	|	ЕСТЬNULL(Штрихкоды.Штрихкод, 0) КАК Штрихкод,
	|	ЦенаНоменклатурыИзНакладной.Цена,
	|	ВЫБОР
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
    |		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС,
	|	РеализацияТоваровУслугЛео_Паллеты.СерияНоменклатуры.СрокГодности КАК СрокГодности,
	|	РеализацияТоваровУслугЛео_Паллеты.СерияНоменклатуры.абс_ДатаПроизводства КАК ДатаПроизводства
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Лео_Паллеты КАК РеализацияТоваровУслугЛео_Паллеты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО РеализацияТоваровУслугЛео_Паллеты.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И РеализацияТоваровУслугЛео_Паллеты.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|			И (абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО РеализацияТоваровУслугЛео_Паллеты.Номенклатура = Штрихкоды.Владелец
	|			И РеализацияТоваровУслугЛео_Паллеты.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И (Штрихкоды.ТипШтрихкода = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13))
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			Накладная.Номенклатура КАК Номенклатура,
	|			МАКСИМУМ(Накладная.Цена) КАК Цена
	|		ИЗ
	|			Накладная КАК Накладная
	|		
	|		СГРУППИРОВАТЬ ПО
	|			Накладная.Номенклатура) КАК ЦенаНоменклатурыИзНакладной
	|		ПО РеализацияТоваровУслугЛео_Паллеты.Номенклатура = ЦенаНоменклатурыИзНакладной.Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Накладная КАК Накладная
	|		ПО РеализацияТоваровУслугЛео_Паллеты.Номенклатура = Накладная.Номенклатура
	|			И РеализацияТоваровУслугЛео_Паллеты.СерияНоменклатуры = Накладная.СерияНоменклатуры
	|ГДЕ
	|	РеализацияТоваровУслугЛео_Паллеты.Ссылка = &Ссылка
	|ИТОГИ ПО
	|	ШтрихкодПаллеты");
	
	Запрос.УстановитьПараметр("Ссылка"			, ДокументОтгрузки);
	Запрос.УстановитьПараметр("ЗаказПокупателя"	, ДокументОтгрузки.Сделка);
	Запрос.УстановитьПараметр("НачалоПериода"	, ДокументОтгрузки.Сделка.Дата);
	Запрос.УстановитьПараметр("КонецПериода"	, ДокументОтгрузки.Сделка.Дата);
	Запрос.УстановитьПараметр("ПустаяДата"		, '00010101000000');
	
	Отказ = Ложь;
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();
	
	НомерНакладной = ОбщегоНазначения.ПолучитьНомерНаПечать(ВыборкаДокумент.Ссылка);
	
	ИмяФайла = СформироватьИмяФайлаEDI("DESSCC_" + Формат(ВыборкаДокумент.ДатаЗаказа,"ДФ=ггггММдд") + "_" + СокрЛП(ВыборкаДокумент.НомерЗаказа)) + ".xml";
	Запись=Новый ЗаписьXML;
	Запись.УстановитьСтроку("UTF-8");
	Запись.ЗаписатьОбъявлениеXML();
	
	Запись.ЗаписатьНачалоЭлемента("DESSCC");
		//ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.НомерУведомления)					, "NUMBER");				//номер уведомления об отгрузке
		ЗаписатьXML(Запись, НомерСФ					                                    ,  "NUMBER");				//номер уведомления об отгрузке
		ЗаписатьXML(Запись, Формат(ВыборкаДокумент.Дата,"ДФ=гггг-ММ-дд")				, "DATE"); 					//дата документа
		ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ДатаДоставки,"ДФ=гггг-ММ-дд")		, "DELIVERYDATE"); 			//дата поставки
		//ЗаписатьXML(Запись, "12:00"													, "DELIVERYTIME"); 			//время поставки
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.НомерЗаказа)							, "ORDERNUMBER"); 			//номер заказа
		ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ДатаЗаказа,"ДФ=гггг-ММ-дд")			, "ORDERDATE"); 			//дата заказа
		// {Лео Катанович  - 24/05/20017
		//ЗаписатьXML(Запись, СокрЛП(НомерСФ)										        , "DELIVERYNOTENUMBER"); 	//номер УПД
		//ЗаписатьXML(Запись, Формат(ДатаСФ, "ДФ=гггг-ММ-дд")				                , "DELIVERYNOTEDATE"); 		//дата УПД
		//Лео Катанович}
		//ЗаписатьXML(Запись, "30"														, "TRANSPORTTYPE"); 		//тип транспортировки
		//ЗаписатьXML(Запись, "31"														, "TRANSPORTERTYPE"); 		//тип транспортного средства
		//ЗаписатьXML(Запись, Формат(ВыборкаДокумент.КоличествоПаллет, "ЧЦ=5; ЧН=0; ЧГ=0"), "SHIPMENTS"); 			//SHIPMENTS
		ЗаписатьXML(Запись, ВыборкаДокумент.ГосНомерТС									, "TRANSPORTID"); 			//SHIPMENTS
		ЗаписатьXML(Запись, ВыборкаДокумент.МаркаТС										, "TRANSPORTMARK"); 			//TRANSPORTMARK
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.Водитель)							, "TRANSPORTERNAME"); 			//TRANSPORTERNAME
		ЗаписатьXML(Запись, ВыборкаДокумент.НомерДоговора								, "CAMPAIGNNUMBER"); 			//CAMPAIGNNUMBER
		
		Запись.ЗаписатьНачалоЭлемента("HEAD");
		
	    //{Лео Катанович
	    Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		     ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
			 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
			 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
			 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
			 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
			 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		     ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
			 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО


		     ЗаписатьXML(Запись, "4607932679999"		, "SUPPLIER"); 			                   //GLN поставщика
	    Иначе
	        ЗаписатьXML(Запись, ВыборкаДокумент.GLNОрганизации			, "SUPPLIER"); 			//GLN поставщика
	    КонецЕсли;   
        //	Лео Катанович}
 	
			ГрузополучательЯвляетсяПлательщиком = абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ДокументОтгрузки.Сделка.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.абс_ГрузополучательЯвляетсяПлательщиком);
			
			GLNПокупателя = ВыборкаДокумент.GLNКонтрагента;
		
			//+Лео Сафонов ЕА Хардкод. Исключение из общих правил GLN для Билла и Гиперглобус
			Если ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("") Тогда ////////////////////////////////////////////////Билла
				ЗаписатьXML(Запись, GLNПокупателя								, "BUYER"); 			//GLN покупателя	
				ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "DELIVERYPLACE"); 	//GLN места доставки
				ЗаписатьXML(Запись, ВыборкаДокумент.GLNОрганизации				, "SENDER"); 			//GLN отправителя сообщения
				ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "RECIPIENT"); 		//GLN получателя сообщения	
			ИначеЕсли ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("") Тогда ///////////////////////////////////////////Гиперглобус
				ЗаписатьXML(Запись, GLNПокупателя								, "BUYER"); 			//GLN покупателя	
				ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "DELIVERYPLACE"); 	//GLN места доставки
				ЗаписатьXML(Запись, ВыборкаДокумент.GLNОрганизации				, "SENDER"); 			//GLN отправителя сообщения
				ЗаписатьXML(Запись, "4690202000005"								, "RECIPIENT"); 		//GLN получателя сообщения	
			Иначе
				/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////Общие правила
				ЗаписатьXML(Запись, GLNПокупателя								, "BUYER"); 			//GLN покупателя	
				ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "DELIVERYPLACE"); 	//GLN места доставки
				
			//{Лео Катанович
			Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
				 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
				 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
				 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
				 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
				 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
				 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		         ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
				 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО

				 ЗаписатьXML(Запись, "4607932679999"				, "SENDER"); 			           //GLN отправителя сообщения
			Иначе
                 ЗаписатьXML(Запись, ВыборкаДокумент.GLNОрганизации				, "SENDER"); 			//GLN отправителя сообщения
			КонецЕсли;   
			//	Лео Катанович}	
			
				ЗаписатьXML(Запись, GLNПокупателя							 	, "RECIPIENT"); 		//GLN получателя сообщения	
			КонецЕсли;
			//-Лео Сафонов ЕА Хардкод. Исключение из общих правил GLN для Билла и Гиперглобус

				
			ЗаписатьXML(Запись, ВыборкаДокумент.НомерУведомления		, "EDIINTERCHANGEID"); 	//номер транзакции
			
			ВыборкаПаллет = Результат[2].Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			// {Лео Катанович
			Если ВыборкаПаллет.Количество() = 0 Тогда
			     Сообщить("Не заполнена информация о паллетах!");
				 Отказ = Истина;
			КонецЕсли;
            // Лео Катанович}
			сч=1;
			Пока ВыборкаПаллет.Следующий() Цикл

				Запись.ЗаписатьНачалоЭлемента("PACKINGSEQUENCE");
					ЗаписатьXML(Запись, сч											,"HIERARCHICALID"); 	//номер иерархии упаковки
					ЗаписатьXML(Запись, ВыборкаПаллет.ШтрихкодПаллеты				,"SSCC"); 				//Штрихкод транспортной упаковки	
					ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	,"LOCATION"); 			//Место доставки упаковки
					
					ВыборкаСтрока = ВыборкаПаллет.Выбрать();
					Пока ВыборкаСтрока.Следующий() Цикл
                        Попытка
							ШтрихкодДляВыгрузки = Число(СокрЛП(ВыборкаСтрока.Штрихкод));
						Исключение
							ОбщегоНазначения.СообщитьОбОшибке("В номенклатуре: " + ВыборкаСтрока.Номенклатура + ", артикул: " + ВыборкаСтрока.Номенклатура.Артикул + " ошибка преобразования штрихкода в число: " + ВыборкаСтрока.Штрихкод, Отказ);
						КонецПопытки;
								
						
						Запись.ЗаписатьНачалоЭлемента("POSITION");
							ЗаписатьXML(Запись, 1										, "POSITIONNUMBER"); 	//номер товарной позици
							ЗаписатьXML(Запись, ШтрихкодДляВыгрузки						, "PRODUCT"); 			//Штрихкод продукта
							Если ЗначениеЗаполнено(ВыборкаСтрока.АртикулПокупателя) Тогда
								ЗаписатьXML(Запись, ВыборкаСтрока.АртикулПокупателя		, "PRODUCTIDBUYER"); 	//внутренний номер в БД покупателя
							КонецЕсли;
							ЗаписатьXML(Запись, ВыборкаСтрока.Количество				, "DELIVEREDQUANTITY"); //поставляемое количество
							ЗаписатьXML(Запись, ВыборкаСтрока.Количество				, "ORDEREDQUANTITY"); 	//Заказанное количество
							ЗаписатьXML(Запись, ВыборкаСтрока.Цена						, "PRICE"); 			//цена
							ЗаписатьXML(Запись, ВыборкаСтрока.СтавкаНДС					, "VAT"); 				//Ставка НДС, %
	                        ЗаписатьXML(Запись, "PCE"									, "UNIT"); 				//цена
							//{Лео Катанович
							//ЗаписатьXML(Запись, Формат(ВыборкаСтрока.СрокГодности, "ДФ=гггг-ММ-дд")		, "SHELFLIFEDATE"); 	//срок годности
						    //ЗаписатьXML(Запись, Формат(ВыборкаСтрока.ДатаПроизводства, "ДФ=гггг-ММ-дд")	, "MANUFACTUREDATE"); 	//дата изготовления

							ЗаписатьXML(Запись, Формат(ВыборкаСтрока.СрокГодности, "ДФ=гггг-ММ-дд")		, "EXPIREDATE"); 	//срок годности
						    ЗаписатьXML(Запись, Формат(ВыборкаСтрока.ДатаПроизводства, "ДФ=гггг-ММ-дд")	, "SHELFLIFEDATE"); 	//дата изготовления
                            //Лео Катанович}

							
							
						Запись.ЗаписатьКонецЭлемента();//POSITION
					КонецЦикла;
				Запись.ЗаписатьКонецЭлемента(); //PACKINGSEQUENCE

				сч = сч + 1;
				
			КонецЦикла;
			
			Если Отказ Тогда
				ЕстьОшибки = Истина;
				Возврат;
				//ВызватьИсключение "Произошли ошибки при выгрузке уведомления об отгрузке! Уведомление об отгрузке не выгружено!";
			КонецЕсли;	
			
		Запись.ЗаписатьКонецЭлемента(); //HEAD
	Запись.ЗаписатьКонецЭлемента();  //DESSCC
	
	ТекстXML=Запись.Закрыть();
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.УведомлениеОбОтгрузке);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, СокрЛП(GLNПокупателя));
	СтруктураПараметров.Вставить("GLNГрузополучателя"		, СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
	
	//{Лео Катанович
	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
		 
		 СтруктураПараметров.Вставить("GLNПоставщика"			, "4607932679999");
	  Иначе
	     СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	КонецЕсли;   
    //	Лео Катанович}
	
	// << Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
	Если ДокументОтгрузки.Организация.Код = "О00000001" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su);
	ИначеЕсли ДокументОтгрузки.Организация.Код = "О00000003" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit);
	КонецЕсли;
	// >> Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерДокументаEDIЗаказа);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаДокументаEDI);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры

Функция ПолучитьСтруктураАдреса(Объект,ТипАдреса,ВидаАдреса)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	КонтактнаяИнформация.Объект,
		|	КонтактнаяИнформация.Поле1 КАК Индекс,
		|	КонтактнаяИнформация.Поле2 КАК Регион,
		|	КонтактнаяИнформация.Поле3 КАК Район,
		|	КонтактнаяИнформация.Поле4 КАК Город,
		|	КонтактнаяИнформация.Поле5 КАК НаселПункт,
		|	КонтактнаяИнформация.Поле6 КАК Улица,
		|	КонтактнаяИнформация.Поле7 КАК Дом,
		|	КонтактнаяИнформация.Поле8 КАК Корпус,
		|	КонтактнаяИнформация.Поле9 КАК Кварт,
		|	ЕСТЬNULL(ВложенныйЗапрос.КодРегионаВКоде, """") КАК КодРегион,
		|	КонтактнаяИнформация.Поле10,
		|	КонтактнаяИнформация.ТипДома,
		|	КонтактнаяИнформация.ТипКорпуса,
		|	КонтактнаяИнформация.ТипКвартиры
		|ИЗ
		|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			АдресныйКлассификатор.КодРегионаВКоде КАК КодРегионаВКоде,
		|			АдресныйКлассификатор.Наименование КАК Наименование,
		|			АдресныйКлассификатор.АльтернативныеНазвания КАК АльтернативныеНазвания
		|		ИЗ
		|			РегистрСведений.АдресныйКлассификатор КАК АдресныйКлассификатор
		|		ГДЕ
		|			АдресныйКлассификатор.ТипАдресногоЭлемента = 1
		|		
		|		СГРУППИРОВАТЬ ПО
		|			АдресныйКлассификатор.КодРегионаВКоде,
		|			АдресныйКлассификатор.Наименование,
		|			АдресныйКлассификатор.АльтернативныеНазвания) КАК ВложенныйЗапрос
		|		ПО (КонтактнаяИнформация.Поле2 ПОДОБНО ВложенныйЗапрос.Наименование + ""%""
		|				ИЛИ КонтактнаяИнформация.Поле4 ПОДОБНО ВложенныйЗапрос.Наименование + ""%"")
		|ГДЕ
		|	КонтактнаяИнформация.Объект = &Объект
		|	И КонтактнаяИнформация.Тип = &Тип
		|	И КонтактнаяИнформация.Вид = &Вид
		|
		|СГРУППИРОВАТЬ ПО
		|	КонтактнаяИнформация.Поле9,
		|	КонтактнаяИнформация.Поле6,
		|	КонтактнаяИнформация.Объект,
		|	КонтактнаяИнформация.Поле1,
		|	КонтактнаяИнформация.Поле7,
		|	КонтактнаяИнформация.Поле4,
		|	КонтактнаяИнформация.Поле8,
		|	КонтактнаяИнформация.Поле2,
		|	КонтактнаяИнформация.Поле5,
		|	КонтактнаяИнформация.Поле3,
		|	ВложенныйЗапрос.КодРегионаВКоде,
		|	КонтактнаяИнформация.Поле10,
		|	КонтактнаяИнформация.ТипДома,
		|	КонтактнаяИнформация.ТипКорпуса,
		|	КонтактнаяИнформация.ТипКвартиры,
		|	ЕСТЬNULL(ВложенныйЗапрос.КодРегионаВКоде, """")";

	Запрос.УстановитьПараметр("Вид", ВидаАдреса);
	Запрос.УстановитьПараметр("Объект", Объект);
	Запрос.УстановитьПараметр("Тип", ТипАдреса);

	Результат = Запрос.Выполнить();

	ВыборкаДетальныеЗаписи = Результат.Выбрать();

	СтруктураАдреса = Новый Структура;
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		СтруктураАдреса.Вставить("Индекс",ВыборкаДетальныеЗаписи.Индекс);
		КодРегион = Строка(ВыборкаДетальныеЗаписи.КодРегион);
		Пока СтрДлина(КодРегион) < 2 Цикл
			КодРегион = "0" + КодРегион;
		КонецЦикла;
		СтруктураАдреса.Вставить("КодРегион",КодРегион);
	    СтруктураАдреса.Вставить("Район",ВыборкаДетальныеЗаписи.Район);
		Если ВыборкаДетальныеЗаписи.Город = "" и ВыборкаДетальныеЗаписи.НаселПункт = "" Тогда
			СтруктураАдреса.Вставить("Город",ВыборкаДетальныеЗаписи.Регион);
		Иначе
			СтруктураАдреса.Вставить("Город",ВыборкаДетальныеЗаписи.Город);
		КонецЕсли;
	    СтруктураАдреса.Вставить("НаселПункт",ВыборкаДетальныеЗаписи.НаселПункт);
	    СтруктураАдреса.Вставить("Улица",ВыборкаДетальныеЗаписи.Улица);
	    СтруктураАдреса.Вставить("Дом",ВыборкаДетальныеЗаписи.Дом);
	    СтруктураАдреса.Вставить("Корпус",ВыборкаДетальныеЗаписи.Корпус);
		СтруктураАдреса.Вставить("Кварт",ВыборкаДетальныеЗаписи.Кварт);
		
		СокращеннаяСтрока = ВыборкаДетальныеЗаписи.Улица; 
		СокращеннаяСтрока = ?(ВыборкаДетальныеЗаписи.Дом = "",СокращеннаяСтрока, СокращеннаяСтрока + ", " + ВыборкаДетальныеЗаписи.ТипДома + " №" + ВыборкаДетальныеЗаписи.Дом );
		СокращеннаяСтрока = ?(ВыборкаДетальныеЗаписи.Корпус = "",СокращеннаяСтрока, СокращеннаяСтрока + ", " + ВыборкаДетальныеЗаписи.ТипКорпуса + " " + ВыборкаДетальныеЗаписи.Корпус );
		
		СтруктураАдреса.Вставить("СокращеннаяСтрока",СокращеннаяСтрока);
	КонецЦикла;

	Возврат  СтруктураАдреса;
КонецФункции

//Опишу также требования сети  к генерации SSCC кода:
//Первая цифра - 1
//Следующие 9 цифр - это первые 9 цифр Вашего GLN номера, который обязательно должен быть официальным и начинаться с цифры 4
//Следующие 7 цифр - счетчик, позволяющий создать 10 млн уникальных комбинаций SSCC кодов (от 0000000 до 9999999). Данный код должен быть уникальным в течение года.
//Последняя, 18-я цифра - контрольная сумма.

//Функция ГенераторSSCC(GLN,)
//	ЧастьКода = Сред(GLN,1,9);	
//	Шаблон = "1" + ЧастьКода;
//	ТекКод = Шаблон + 
//КонецФункции
//-Лео Сафонов ЕА


//{Лео Катанович
Процедура ВыгрузитьТорг12_КОРУС(ДокументОтгрузки, ЕстьОшибки = Ложь) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст ="ВЫБРАТЬ
	              |	Накладная.Номенклатура КАК Номенклатура,
	              |	ВЫРАЗИТЬ(Накладная.Номенклатура.НаименованиеПолное КАК СТРОКА(1000)) КАК ТоварНаименование,
	              |	Накладная.ЕдиницаИзмерения.Представление КАК БазоваяЕдиницаНаименование,
	              |	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК БазоваяЕдиницаКодПоОКЕИ,
	              |	Накладная.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	              |	Накладная.ЕдиницаИзмеренияМест.Представление КАК ВидУпаковки,
	              |	Накладная.КоэффициентМест / Накладная.Коэффициент КАК КоличествоВОдномМесте,
	              |	ВЫБОР
	              |		КОГДА Накладная.КоличествоМест > 0
	              |			ТОГДА Накладная.КоличествоМест * Накладная.ЕдиницаИзмеренияМест.Вес
	              |		ИНАЧЕ Накладная.Количество * Накладная.ЕдиницаИзмерения.Вес
	              |	КОНЕЦ КАК МассаБрутто,
	              |	Накладная.Количество * Накладная.ЕдиницаИзмерения.Коэффициент / Накладная.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент * Накладная.Номенклатура.ЕдиницаХраненияОстатков.Вес КАК МассаНетто,
	              |	Накладная.Характеристика КАК Характеристика,
	              |	Накладная.Серия КАК Серия,
	              |	ВЫБОР
	              |		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	              |				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	              |			ТОГДА 18
	              |		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	              |				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	              |			ТОГДА 10
	              |		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	              |				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	              |			ТОГДА 20
                  |		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	              |				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	              |			ТОГДА 5
	              |		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	              |				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	              |			ТОГДА 7
	              |		ИНАЧЕ 0
	              |	КОНЕЦ КАК СтавкаНДС,
	              |	Накладная.Цена КАК Цена,
	              |	ВЫБОР
	              |		КОГДА Накладная.ПроцентСкидкиНаценки = 0
	              |				И Накладная.ПроцентАвтоматическихСкидок = 0
	              |			ТОГДА ЛОЖЬ
	              |		ИНАЧЕ ИСТИНА
	              |	КОНЕЦ КАК ЕстьСкидкиПоСтроке,
	              |	Накладная.Количество КАК Количество,
	              |	Накладная.КоличествоМест КАК КоличествоМест,
	              |	Накладная.Сумма КАК Сумма,
	              |	Накладная.СуммаНДС КАК СуммаНДС,
	              |	Накладная.НомерСтроки КАК НомерСтроки,
	              |	Накладная.Метка КАК Метка,
	              |	Штрихкоды.Штрихкод
	              |ИЗ
	              |	(ВЫБРАТЬ
	              |		РеализацияТоваровУслуг.Номенклатура КАК Номенклатура,
	              |		РеализацияТоваровУслуг.Коэффициент КАК Коэффициент,
	              |		РеализацияТоваровУслуг.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	              |		РеализацияТоваровУслуг.ЕдиницаИзмеренияМест КАК ЕдиницаИзмеренияМест,
	              |		РеализацияТоваровУслуг.ЕдиницаИзмеренияМест.Коэффициент КАК КоэффициентМест,
	              |		РеализацияТоваровУслуг.ХарактеристикаНоменклатуры КАК Характеристика,
	              |		РеализацияТоваровУслуг.СерияНоменклатуры КАК Серия,
	              |		РеализацияТоваровУслуг.СтавкаНДС КАК СтавкаНДС,
	              |		РеализацияТоваровУслуг.Цена * &Курс / &Кратность КАК Цена,
	              |		РеализацияТоваровУслуг.ПроцентСкидкиНаценки КАК ПроцентСкидкиНаценки,
	              |		РеализацияТоваровУслуг.ПроцентАвтоматическихСкидок КАК ПроцентАвтоматическихСкидок,
	              |		СУММА(РеализацияТоваровУслуг.Количество) КАК Количество,
	              |		СУММА(РеализацияТоваровУслуг.КоличествоМест) КАК КоличествоМест,
	              |		СУММА(РеализацияТоваровУслуг.Сумма * &Курс / &Кратность) КАК Сумма,
	              |		СУММА(РеализацияТоваровУслуг.СуммаНДС * &Курс / &Кратность) КАК СуммаНДС,
	              |		МИНИМУМ(РеализацияТоваровУслуг.НомерСтроки) КАК НомерСтроки,
	              |		0 КАК Метка
	              |	ИЗ
	              |		Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслуг
	              |	ГДЕ
	              |		РеализацияТоваровУслуг.Ссылка = &ДокументОтгрузки
	              |	
	              |	СГРУППИРОВАТЬ ПО
	              |		РеализацияТоваровУслуг.Номенклатура,
	              |		РеализацияТоваровУслуг.Коэффициент,
	              |		РеализацияТоваровУслуг.ЕдиницаИзмерения,
	              |		РеализацияТоваровУслуг.ЕдиницаИзмеренияМест,
	              |		РеализацияТоваровУслуг.ХарактеристикаНоменклатуры,
	              |		РеализацияТоваровУслуг.СерияНоменклатуры,
	              |		РеализацияТоваровУслуг.СтавкаНДС,
	              |		РеализацияТоваровУслуг.Цена,
	              |		РеализацияТоваровУслуг.ПроцентСкидкиНаценки,
	              |		РеализацияТоваровУслуг.ПроцентАвтоматическихСкидок,
	              |		РеализацияТоваровУслуг.ЕдиницаИзмеренияМест.Коэффициент,
	              |		РеализацияТоваровУслуг.Ссылка.ОтпускРазрешил,
	              |		РеализацияТоваровУслуг.Ссылка.ОтпускПроизвел) КАК Накладная
	              |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	              |		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	              |			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	              |			И Накладная.Характеристика = Штрихкоды.ХарактеристикаНоменклатуры
	              |			И (Штрихкоды.ТипШтрихкода = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13))
	              |
	              |УПОРЯДОЧИТЬ ПО
	              |	НомерСтроки
	              |АВТОУПОРЯДОЧИВАНИЕ
	              |;
	              |
	              |////////////////////////////////////////////////////////////////////////////////
	              |ВЫБРАТЬ
	              |	Накладная.Номер КАК Номер,
	              |	Накладная.Дата КАК Дата,
	              |	Накладная.Сделка КАК Сделка,
	              |	Накладная.Сделка.Номер КАК НомерЗаказа,
	              |	Накладная.Сделка.Дата КАК ДатаЗаказа,
	              |	Накладная.Организация.абс_GLN КАК GLNОрганизации,
	              |	Накладная.Контрагент.абс_GLN КАК GLNКонтрагента,
	              |	Накладная.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	              |	Накладная.Сделка.ДокументОснование.НомерДокументаEDIЗаказа КАК НомерДокументаEDIЗаказа,
	              |	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
	              |	Накладная.Организация.Лео_GUID КАК GUIDОрганизации,
	              |	Накладная.Контрагент.Лео_GUID КАК GUIDКонтрагента,
	              |	Накладная.ВалютаДокумента КАК Валюта,
	              |	Накладная.ВалютаДокумента.Код КАК КодВалюты,
	              |	Накладная.Организация КАК Организация,
	              |	ВЫБОР
	              |		КОГДА Накладная.Грузополучатель = &ПустойКонтрагент
	              |			ТОГДА Накладная.Ссылка.Контрагент
	              |		ИНАЧЕ Накладная.Грузополучатель
	              |	КОНЕЦ КАК Грузополучатель,
	              |	Накладная.Контрагент КАК Контрагент,
	              |	Накладная.Подразделение КАК Подразделение,
	              |	ВЫБОР
	              |		КОГДА Накладная.Грузоотправитель = &ПустойКонтрагент
	              |			ТОГДА Накладная.Организация
	              |		ИНАЧЕ Накладная.Грузоотправитель
	              |	КОНЕЦ КАК Грузоотправитель,
	              |	Накладная.Организация КАК Поставщик,
	              |	Накладная.Контрагент КАК Плательщик,
	              |	Накладная.Сделка КАК Основание,
	              |	абс_СводнаяЗаявкаНаТранспортМаршруты.Ссылка.Дата КАК ТТНДата,
	              |	Накладная.ОтпускРазрешил КАК ОтпускРазрешил,
	              |	Накладная.ОтпускПроизвел КАК ОтпускПроизвел,
	              |	Накладная.СуммаВключаетНДС
	              |ИЗ
	              |	Документ.РеализацияТоваровУслуг КАК Накладная
	              |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_СводнаяЗаявкаНаТранспорт.Маршруты КАК абс_СводнаяЗаявкаНаТранспортМаршруты
	              |		ПО Накладная.Ссылка = абс_СводнаяЗаявкаНаТранспортМаршруты.ЗаявкаНаТранспорт.ДокументОтгрузки
	              |ГДЕ
	              |	Накладная.Ссылка = &ДокументОтгрузки";
	              
	ВалютаУчета = глЗначениеПеременной("ВалютаРегламентированногоУчета");
			  
	Запрос.УстановитьПараметр("ДокументОтгрузки", ДокументОтгрузки);
	Запрос.УстановитьПараметр("ПустойКонтрагент", Справочники.Контрагенты.ПустаяСсылка());
	Запрос.УстановитьПараметр("Курс",             ЗаполнениеДокументов.КурсДокумента(ДокументОтгрузки, ВалютаУчета));
	Запрос.УстановитьПараметр("Кратность",        ЗаполнениеДокументов.КратностьДокумента(ДокументОтгрузки,ВалютаУчета));
	
	Результат = Запрос.ВыполнитьПакет();
	ВыборкаДокумент = Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////		
	
	ИдФайл = "DP_OTORG12_2BK-" +  ВыборкаДокумент.Контрагент.ИНН + "-" + ВыборкаДокумент.Контрагент.ОГРН + "_2BK-" + ВыборкаДокумент.Организация.ИНН + "-" + ВыборкаДокумент.Организация.ОГРН   + "_" + Формат(ВыборкаДокумент.Дата,"ДФ=ггггММдд") + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор());
	
	
	ИдФайл = СформироватьИмяФайлаEDI(ИдФайл);
	ИмяФайла = ИдФайл + ".xml";
	 
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку("windows-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Электронный Курьер 1.0" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.01" );
		 
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
		  //ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр","2BK-" + ВыборкаДокумент.GUIDОрганизации);
		  //  ЗаписьXML.ЗаписатьАтрибут( "ИдПок", "2BK-" + ВыборкаДокумент.GUIDКонтрагента);
		  
		  
		  ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр","2BK-" + ВыборкаДокумент.Организация.ИНН + "-" + ВыборкаДокумент.Организация.ОГРН);
		  ЗаписьXML.ЗаписатьАтрибут( "ИдПок", "2BK-" +  ВыборкаДокумент.Контрагент.ИНН + "-" + ВыборкаДокумент.Контрагент.ОГРН);

		  
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпрСФ"); //+СвОЭДОтпр
				ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "КОРУС Консалтинг СНГ");
		 		ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", "7801392271");
		 		ЗаписьXML.ЗаписатьАтрибут( "ИдЭДОСФ", "2BK");	

			ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
			ЗаписьXML.ЗаписатьАтрибут( "КНД", "1175004");
			ЗаписьXML.ЗаписатьАтрибут( "ДатаДок", Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
            ЗаписьXML.ЗаписатьАтрибут( "ВремДок", СтрЗаменить(Формат(ВыборкаДокумент.Дата,"ДЛФ=T"),":","."));
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвТНО");//+СвТоварнаяНакладная 
				ЗаписьXML.ЗаписатьАтрибут( "НаимПервДок", "Товарная накладная");
				ЗаписьXML.ЗаписатьАтрибут( "ОКУДПервДок","0330212" );              
				ЗаписьXML.ЗаписатьАтрибут( "НомФорм", "ТОРГ-12");
				
				//   ГРУЗООТПРАВИТЕЛЬ
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОт");//+ГрузОт 
				   Если ЗначениеЗаполнено(ВыборкаДокумент.Организация.КодОКВЭД) Тогда
				        ЗаписьXML.ЗаписатьАтрибут( "ОКДП",ВыборкаДокумент.Организация.КодОКВЭД);
                   КонецЕсли;
					ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОтпр");//+ГрузОтпр
					Если ЗначениеЗаполнено(ВыборкаДокумент.Грузоотправитель.КодПоОКПО) Тогда
					     ЗаписьXML.ЗаписатьАтрибут( "ОКПО",СокрЛП(ВыборкаДокумент.Грузоотправитель.КодПоОКПО));
                    КонецЕсли;
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
	                    СведенияОГрузоотправитель =  УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузоотправитель,  ВыборкаДокумент.Дата);
                              ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛ");//+СвЮл

							  //ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.Грузоотправитель.НаименованиеПолное,"""","&quot;" ));
							  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Грузоотправитель.НаименованиеПолное);
							  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.Грузоотправитель.ИНН );
							  ЗаписьXML.ЗаписатьАтрибут( "КПП",     ВыборкаДокумент.Грузоотправитель.КПП );
							  Если ВыборкаДокумент.Грузоотправитель.Метаданные().Реквизиты.Найти("ОКОПФ") <> Неопределено Тогда
								   ОКОПФ = Прав(ВыборкаДокумент.Грузоотправитель.ОКОПФ.Код,2);
							  Иначе 
								   ОКОПФ = "";
							  КонецЕсли;
                              Если ЗначениеЗаполнено(ОКОПФ) Тогда	
							       ЗаписьXML.ЗаписатьАтрибут( "ОКОПФ", СокрЛП(ОКОПФ));
							   КонецЕсли;
							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮл
       				        ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузоотправитель,Перечисления.ТипыКонтактнойИнформации.Адрес,?(ТипЗнч(ВыборкаДокумент.Грузоотправитель) = Тип("СправочникСсылка.Организации"),Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента));
								// Функция проверить на NULL

								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ

							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрТекст");//+АдрТекст
							ЗаписьXML.ЗаписатьТекст(СведенияОГрузоотправитель.ЮридическийАдрес);
							//		  ЗаписатьXML(ЗаписьXML,СведенияОГрузоотправитель.ЮридическийАдрес,"АдрТекст");
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрТекст
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.Телефоны) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузоотправитель.Телефоны,20));
									  КонецЕсли;	   
									  Факс = ПолучитьФаксКонтрагента(ВыборкаДокумент.Грузоотправитель);
									  Если ЗначениеЗаполнено(Факс) Тогда
                                           ЗаписьXML.ЗаписатьАтрибут( "Факс", Факс);
									  КонецЕсли;
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт

							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.НомерСчета) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузоотправитель.НомерСчета);
									  КонецЕсли;	   
									  ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
									            Если ЗначениеЗаполнено(СведенияОГрузоотправитель.БИК) Тогда
									                 ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузоотправитель.Банк.Наименование);
												     ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузоотправитель.БИК);
												КонецЕсли;	 
                                      ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
				    ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОтпр
					ЗаписьXML.ЗаписатьНачалоЭлемента("СтруктПодр");//+СтруктПодр
					ЗаписьXML.ЗаписатьТекст(ВыборкаДокумент.Подразделение.Наименование);
							 ///ЗаписатьXML(ЗаписьXML,ВыборкаДокумент.Подразделение.Наименование,"СтруктПодр");
					ЗаписьXML.ЗаписатьКонецЭлемента();//-СтруктПодр
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОт
				
           //   ГРУЗОПОЛУЧАТЕЛЬ
			ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузПолуч");//+ГрузПолуч	
			СтрокаСведений = "ТелОрганизации, АдрЮР, ФаксОрганизации";
		    СведенияОГрузополучатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузополучатель,  ВыборкаДокумент.Дата);
                      Если ЗначениеЗаполнено(ВыборкаДокумент.Грузополучатель.КодПоОКПО) Тогда
			               ЗаписьXML.ЗаписатьАтрибут( "ОКПО",ВыборкаДокумент.Грузополучатель.КодПоОКПО);
					  Конецесли;	   
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						      ЭтоЮрЛицо = ВыборкаДокумент.Грузополучатель.ЮрФизЛицо <> Перечисления.ЮрФизЛицо.ФизЛицо;
							  Если ЭтоЮрЛицо Тогда
							       ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛ");//+СвЮЛ
								   //ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.Грузополучатель.Наименование,"""","&quot;" ));
								   ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Грузополучатель.Наименование);
							       ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОГрузополучатель.ИНН );
							       ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОГрузополучатель.КПП );
                                   Если ВыборкаДокумент.Грузополучатель.Метаданные().Реквизиты.Найти("ОКОПФ") <> Неопределено Тогда
								        ОКОПФ = Прав(ВыборкаДокумент.Грузополучатель.ОКОПФ.Код,2);
							       Иначе 
								        ОКОПФ = "";
								   КонецЕсли;
								   Если ЗначениеЗаполнено(ОКОПФ) Тогда	
                                        ЗаписьXML.ЗаписатьАтрибут( "ОКОПФ", СокрЛП(ОКОПФ));
								   КонецЕсли;		
								   ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛ
							   Иначе
								   ЗаписьXML.ЗаписатьНачалоЭлемента("СвФЛ");//+СвФЛ
							       ЗаписьXML.ЗаписатьАтрибут( "ИННФЛ",   СведенияОГрузополучатель.ИНН );
								             ЗаписьXML.ЗаписатьНачалоЭлемента("ФИОИП");//+ФИОИП 
											        ФИО = РазложитьФИО(ВыборкаДокумент.Грузополучатель.НаименованиеПолное);
							                        ЗаписьXML.ЗаписатьАтрибут("Фамилия", ФИО.Фамилия );
							                        ЗаписьXML.ЗаписатьАтрибут("Имя",     ФИО.Имя );
													ЗаписьXML.ЗаписатьАтрибут("Отчество",ФИО.Отчество );
								             ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИОИП
                                   ЗаписьXML.ЗаписатьКонецЭлемента();//-СвФЛ													
							  КонецЕсли;
				        ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
							   ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							
								ЗаписьXML.ЗаписатьНачалоЭлемента("АдрТекст");//+АдрТекст
								ЗаписьXML.ЗаписатьТекст(СведенияОГрузополучатель.АдресДоставки);
								//	  ЗаписатьXML(ЗаписьXML,СведенияОГрузополучатель.АдресДоставки,"АдрТекст");
								ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрТекст
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							          Если ЗначениеЗаполнено(СведенияОГрузополучатель.Телефоны) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузополучатель.Телефоны,20));
									  КонецЕсли;
									  Факс = ПолучитьФаксКонтрагента(ВыборкаДокумент.Грузополучатель);
									  Если ЗначениеЗаполнено(Факс) Тогда
                                           ЗаписьXML.ЗаписатьАтрибут( "Факс", Факс);
									  КонецЕсли;
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт

							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							          Если ЗначениеЗаполнено(СведенияОГрузополучатель.НомерСчета) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузополучатель.НомерСчета);
									  КонецЕсли;	   
									  ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
									            Если ЗначениеЗаполнено(СведенияОГрузополучатель.БИК) Тогда
									                 ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузополучатель.Банк.Наименование);
												     ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузополучатель.БИК);
												КонецЕсли;	 
                                      ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв

				    ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузПолуч
					
			    //   ПОСТАВЩИК
				ЗаписьXML.ЗаписатьНачалоЭлемента("Поставщик");//+Поставщик	
		        СведенияОПоставщик = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Поставщик,  ВыборкаДокумент.Дата);
                      Если ЗначениеЗаполнено(ВыборкаДокумент.Поставщик.КодПоОКПО) Тогда
			               ЗаписьXML.ЗаписатьАтрибут( "ОКПО",ВыборкаДокумент.Поставщик.КодПоОКПО);
					  КонецЕсли;	   
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						      ЭтоЮрЛицо = ВыборкаДокумент.Поставщик.ЮрФизЛицо <> Перечисления.ЮрФизЛицо.ФизЛицо;
							       ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛ");//+СвЮЛ
								   //ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.Поставщик.Наименование,"""","&quot;" ));
								   ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Поставщик.НаименованиеПолное);
							       ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОПоставщик.ИНН );
							       ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОПоставщик.КПП );
							       Если ВыборкаДокумент.Поставщик.Метаданные().Реквизиты.Найти("ОКОПФ") <> Неопределено Тогда
								        ОКОПФ = Прав(ВыборкаДокумент.Поставщик.ОКОПФ.Код,2);
							       Иначе 
								        ОКОПФ = "";
								   КонецЕсли;
								   Если ЗначениеЗаполнено(ОКОПФ) Тогда	
                                        ЗаписьXML.ЗаписатьАтрибут( "ОКОПФ", СокрЛП(ОКОПФ));
								   КонецЕсли;	
                                   ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛ
				        ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Поставщик,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);

								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
							    ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							
								ЗаписьXML.ЗаписатьНачалоЭлемента("АдрТекст");//+АдрТекст
								ЗаписьXML.ЗаписатьТекст(СведенияОПоставщик.ЮридическийАдрес);
								//	  ЗаписатьXML(ЗаписьXML,СведенияОПоставщик.ЮридическийАдрес,"АдрТекст");
								ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрТекст

						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							          Если ЗначениеЗаполнено(СведенияОПоставщик.Телефоны) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПоставщик.Телефоны,20));
									  КонецЕсли;	   
									  Факс = ПолучитьФаксКонтрагента(ВыборкаДокумент.Поставщик);
									  Если ЗначениеЗаполнено(Факс) Тогда
                                           ЗаписьXML.ЗаписатьАтрибут( "Факс", Факс);
									  КонецЕсли;

						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт

							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							          Если ЗначениеЗаполнено(СведенияОПоставщик.НомерСчета) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПоставщик.НомерСчета);
									  КонецЕсли;	   
									  ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
									            Если ЗначениеЗаполнено(СведенияОПоставщик.БИК) Тогда
									                 ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПоставщик.Банк.Наименование);
												     ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПоставщик.БИК);
												КонецЕсли;
                                      ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв

				    ЗаписьXML.ЗаписатьКонецЭлемента();//-Поставщик
					
				//   ПЛАТЕЛЬЩИК
				ЗаписьXML.ЗаписатьНачалоЭлемента("Плательщик");//+Плательщик	
		        СведенияОПлательщик = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Плательщик,  ВыборкаДокумент.Дата);
                      Если ЗначениеЗаполнено(ВыборкаДокумент.Плательщик.КодПоОКПО) Тогда
			               ЗаписьXML.ЗаписатьАтрибут( "ОКПО",ВыборкаДокумент.Плательщик.КодПоОКПО);
					  КонецЕсли;	   
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						      ЭтоЮрЛицо = ВыборкаДокумент.Плательщик.ЮрФизЛицо <> Перечисления.ЮрФизЛицо.ФизЛицо;
							       ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛ");//+СвЮЛ
								   //ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.Плательщик.Наименование,"""","&quot;" ));
								   ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Плательщик.НаименованиеПолное);
								   ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОПлательщик.ИНН );
							       ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОПлательщик.КПП );
                                   Если ВыборкаДокумент.Плательщик.Метаданные().Реквизиты.Найти("ОКОПФ") <> Неопределено Тогда
								        ОКОПФ = Прав(ВыборкаДокумент.Плательщик.ОКОПФ.Код,2);
							       Иначе 
								        ОКОПФ = "";
								   КонецЕсли;
								   Если ЗначениеЗаполнено(ОКОПФ) Тогда	
							            ЗаписьXML.ЗаписатьАтрибут( "ОКОПФ", СокрЛП(ОКОПФ));
								   КонецЕсли;	
                                   ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛ
				        ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Плательщик,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрТекст");//+АдрТекст
							ЗаписьXML.ЗаписатьТекст(СведенияОПлательщик.ЮридическийАдрес);
							//ЗаписатьXML(ЗаписьXML,СведенияОПлательщик.ЮридическийАдрес,"АдрТекст");
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрТекст
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							          Если ЗначениеЗаполнено(СведенияОПлательщик.Телефоны) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "Тлф", Лев(СведенияОПлательщик.Телефоны,20));
									  КонецЕсли;	   
									  Факс = ПолучитьФаксКонтрагента(ВыборкаДокумент.Плательщик);
									  Если ЗначениеЗаполнено(Факс) Тогда
                                           ЗаписьXML.ЗаписатьАтрибут( "Факс", Факс);
									  КонецЕсли;

						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт

							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							          Если ЗначениеЗаполнено(СведенияОПлательщик.НомерСчета) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПлательщик.НомерСчета);
									  КонецЕсли;
									  ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
									            Если ЗначениеЗаполнено(СведенияОПлательщик.БИК) Тогда
									                 ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПлательщик.Банк.Наименование);
												     ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПлательщик.БИК);
												КонецЕсли;
                                      ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
				    ЗаписьXML.ЗаписатьКонецЭлемента();//-Плательщик
					
					//ОСНОВАНИЕ			
			        ЗаписьXML.ЗаписатьНачалоЭлемента("Основание");//+Основание
			              ЗаписьXML.ЗаписатьАтрибут( "НаимОсн",  "Заказ" );
                          ЗаписьXML.ЗаписатьАтрибут( "НомОсн",   ВыборкаДокумент.Основание.НомерПоДаннымПокупателя);
			              ЗаписьXML.ЗаписатьАтрибут( "ДатаОсн",  Формат(ВыборкаДокумент.Основание.ДатаПоДаннымПокупателя,"ДФ=дд.ММ.гггг"));
                          ЗаписьXML.ЗаписатьАтрибут( "ДопСвОсн", ВыборкаДокумент.Основание.Комментарий);
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Основание
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТранНакл");//+ТранНакл
					      ЗаписьXML.ЗаписатьАтрибут( "НомТранНакл",  "б/н");
					      ЗаписьXML.ЗаписатьАтрибут( "ДатаТранНакл", ?(ЗначениеЗаполнено(ВыборкаДокумент.ТТНДата),Формат(ВыборкаДокумент.ТТНДата,"ДФ=дд.ММ.гггг"), Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг")));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранНакл

					ЗаписьXML.ЗаписатьНачалоЭлемента("ВидОперации");//+ВидОперации
					//ЗаписатьXML(ЗаписьXML,"02","ВидОперации");
					ЗаписьXML.ЗаписатьТекст("02");
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ВидОперации
					
			    //ТН
			    ЗаписьXML.ЗаписатьНачалоЭлемента("ТН");//+ТН
			              ЗаписьXML.ЗаписатьАтрибут( "НомТН", ВыборкаДокумент.Номер);
					      ЗаписьXML.ЗаписатьАтрибут( "ДатаТН", Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
                //Таблица
			    ЗаписьXML.ЗаписатьНачалоЭлемента("Таблица");//+Таблица
				ЗапросТовары = Результат[0].Выгрузить();
				
				ВыводитьСерии = абс_Дистрибуция.ПроверитьВеденияОтгрузокПоСериям();
		        Если Не ВыводитьСерии Тогда
			        ЗапросТовары.Свернуть("Номенклатура,ТоварНаименование,БазоваяЕдиницаНаименование,БазоваяЕдиницаКодПоОКЕИ,ЕдиницаИзмерения,ВидУпаковки,КоличествоВОдномМесте,Характеристика,СтавкаНДС,Цена,ЕстьСкидкиПоСтроке,Метка,Штрихкод","МассаБрутто,Сумма,СуммаНДС,КоличествоМест,Количество,МассаНетто");
			        ЗапросТовары.Колонки.Добавить("Серия");
			        ЗапросТовары.ЗаполнитьЗначения("","Серия");
		        КонецЕсли;		
				
				КолМест_Всего = 0;
				Брутто_Всего = 0; 
				Нетто_Всего = 0; 
				СуммаБезНДС_Всего = 0; 
				СуммаНДС_Всего = 0; 
				СуммаУчНДС_Всего = 0; 
				сч = 0;
				Для каждого ВыборкаСтрока из  ЗапросТовары Цикл
					сч = сч + 1;
					ЗаписьXML.ЗаписатьНачалоЭлемента("СвТов");//+СвТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомТов",Строка(сч));
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.НаименованиеПолное);	
						//ЗаписьXML.ЗаписатьАтрибут( "ХарактерТов","");
						//ЗаписьXML.ЗаписатьАтрибут( "СортТов","");
						ЗаписьXML.ЗаписатьАтрибут( "АртикулТов",ВыборкаСтрока.Номенклатура.Артикул);

						//Артикул покупателя
						АртикулПокупателя = "";
						Отбор = Новый Структура;
						Отбор.Вставить("Номенклатура",ВыборкаСтрока.Номенклатура);
						Отбор.Вставить("Контрагент",ВыборкаДокумент.Контрагент);
						Отбор.Вставить("Свойство", ПланыВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя);
						Структура = РегистрыСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.ПолучитьПоследнее(ВыборкаДокумент.Дата, Отбор);
						АртикулПокупателя = ?(ЗначениеЗаполнено(Структура.ЗначениеСвойства),Структура.ЗначениеСвойства,"");			
						ЗаписьXML.ЗаписатьАтрибут( "КодТов", АртикулПокупателя);
						
						ЗаписьXML.ЗаписатьАтрибут( "НаимЕдИзм",ВыборкаСтрока.БазоваяЕдиницаНаименование);
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов", ВыборкаСтрока.БазоваяЕдиницаКодПоОКЕИ);
						ЗаписьXML.ЗаписатьАтрибут( "ВидУпак",  ВыборкаСтрока.ВидУпаковки);
						ЗаписьXML.ЗаписатьАтрибут( "Место",    Формат(ВыборкаСтрока.КоличествоВОдномМесте, "ЧДЦ=0; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "КолМест",  Формат(ВыборкаСтрока.КоличествоМест, "ЧДЦ=0; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "Брутто",   Формат(ВыборкаСтрока.МассаБрутто, "ЧДЦ=3; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "Нетто",    Формат(ВыборкаСтрока.МассаНетто, "ЧДЦ=3; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "Цена",     Формат(ВыборкаСтрока.Цена, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						
						СуммаСНДС   = Окр((ВыборкаСтрока.Сумма + ?(ВыборкаДокумент.СуммаВключаетНДС, 0, ВыборкаСтрока.СуммаНДС)), 2);
			            СуммаНДС    = Окр(ВыборкаСтрока.СуммаНДС, 2);
			            СуммаБезНДС = СуммаСНДС  - СуммаНДС;

						ЗаписьXML.ЗаписатьАтрибут( "СумБезНДС",Формат(СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "СтавкаНДС",Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=5; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "СумНДС",   Формат(СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "СумУчНДС", Формат(СуммаСНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						
						ИнфПолСтр = "номер_заказа:" + ВыборкаДокумент.Основание.НомерПоДаннымПокупателя + ";номер_накладной:" + ВыборкаДокумент.Номер + ";позиция_заказа:" + Строка(сч) + ";штрихкод:" + ВыборкаСтрока.Штрихкод;
						ЗаписьXML.ЗаписатьАтрибут( "ИнфПолСтр",ИнфПолСтр);

						КолМест_Всего = КолМест_Всего + ВыборкаСтрока.КоличествоМест;
						Брутто_Всего = Брутто_Всего + ВыборкаСтрока.МассаБрутто;
						Нетто_Всего =  Нетто_Всего + ВыборкаСтрока.МассаНетто;
						СуммаБезНДС_Всего = СуммаБезНДС_Всего + СуммаБезНДС;
						СуммаНДС_Всего = СуммаНДС_Всего + СуммаНДС; 
						СуммаУчНДС_Всего = СуммаУчНДС_Всего + СуммаСНДС;
						
					 ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
				 КонецЦикла;
				 
					 ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоНакл");//+ВсегоНакл
					 	   ЗаписьXML.ЗаписатьАтрибут( "КолМестВс",    Формат(КолМест_Всего, "ЧДЦ=0; ЧРД=.; ЧГ=0; ЧН=" ));
						   ЗаписьXML.ЗаписатьАтрибут( "БруттоВс",     Формат(Брутто_Всего, "ЧДЦ=3; ЧРД=.; ЧГ=0; ЧН=" ));
						   ЗаписьXML.ЗаписатьАтрибут( "НеттоВс",      Формат(Нетто_Всего, "ЧДЦ=3; ЧРД=.; ЧГ=0; ЧН=" ));
						   ЗаписьXML.ЗаписатьАтрибут( "СумБезНДСВс",  Формат(СуммаБезНДС_Всего, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						   ЗаписьXML.ЗаписатьАтрибут( "СумНДСВс",     Формат(СуммаНДС_Всего, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						   ЗаписьXML.ЗаписатьАтрибут( "СумУчНДСВс",   Формат(СуммаУчНДС_Всего, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					 ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоНакл
				ЗаписьXML.ЗаписатьКонецЭлемента();//-Таблица

				ЗаписьXML.ЗаписатьНачалоЭлемента("ТНОбщ");//+ТНОбщ
				      ЗаписьXML.ЗаписатьАтрибут( "КолНомЗап",    Формат(сч, "ЧДЦ=0; ЧРД=.; ЧГ=0; ЧН=" ));
					  ЗаписьXML.ЗаписатьАтрибут( "КолНомЗапПр",  СокрЛП(ЧислоПрописью(сч,, ",,,ж,,,,,0")));
                      ЗаписьXML.ЗаписатьАтрибут( "ВсМест",       Формат(КолМест_Всего, "ЧДЦ=0; ЧРД=.; ЧГ=0; ЧН=" ));
                      ЗаписьXML.ЗаписатьАтрибут( "ВсМестПр",     СокрЛП(ЧислоПрописью(КолМест_Всего,, ",,,с,,,,,0")));
                      ЗаписьXML.ЗаписатьАтрибут( "Нетто",        Формат(Нетто_Всего, "ЧДЦ=3; ЧРД=.; ЧГ=0; ЧН=" ));
                      ЗаписьXML.ЗаписатьАтрибут( "НеттоПр",      ЧислоПрописью(Нетто_Всего,, "кг,кг,кг,м,г,г,г,м,3"));
                      ЗаписьXML.ЗаписатьАтрибут( "Брутто",       Формат(Брутто_Всего, "ЧДЦ=3; ЧРД=.; ЧГ=0; ЧН=" ));
                      ЗаписьXML.ЗаписатьАтрибут( "БруттоПр",     ЧислоПрописью(Брутто_Всего,, "кг,кг,кг,м,г,г,г,м,3"));

 			    ЗаписьXML.ЗаписатьКонецЭлемента();//-ТНОбщ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТН

			ЗаписьXML.ЗаписатьНачалоЭлемента("ОтпускГруз");//+ОтпускГруз
			
					  //ЗаписьXML.ЗаписатьАтрибут( "КолПрил",  "");
					  //ЗаписьXML.ЗаписатьАтрибут( "КолПрилПр","");
					  ЗаписьXML.ЗаписатьАтрибут( "СумОтпуск",   Формат(СуммаУчНДС_Всего, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					  //ЗаписьXML.ЗаписатьАтрибут( "СумОтпускПр", ОбщегоНазначения.СформироватьСуммуПрописью(СуммаУчНДС_Всего, ВалютаУчета));
					  ЗаписьXML.ЗаписатьАтрибут( "СумОтпускПр",     ЧислоПрописью(СуммаУчНДС_Всего,, "руб.,руб.,руб.,м,коп.,коп.,коп.,м,2"));
					  ЗаписьXML.ЗаписатьАтрибут( "ДатаОтпуск",  Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
//////////////////////////////////////////////////////	
		Руководители = ОбщегоНазначения.ОтветственныеЛица(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата,);
		// Отпуск товара разрешил
		Если НЕ ЗначениеЗаполнено(ВыборкаДокумент.ОтпускРазрешил) Тогда
			ФИООтпускРазрешил       = Руководители.РуководительФИО;
			ДолжностьОтпускРазрешил = Руководители.РуководительДолжность.Наименование;
		Иначе
			ФИООтпускРазрешил                = ФормированиеПечатныхФормСервер.ФамилияИмяОтчество(ВыборкаДокумент.ОтпускРазрешил, ВыборкаДокумент.Дата);
			ПодразделениеДолжностьФизЛица    = ПолныеПрава.СведенияОСотруднике(ВыборкаДокумент.ОтпускРазрешил, ВыборкаДокумент.Дата, ВыборкаДокумент.Организация);
			ДолжностьОтпускРазрешил          = ?(ЗначениеЗаполнено(ПодразделениеДолжностьФизЛица.Должность),ПодразделениеДолжностьФизЛица.Должность,"");
		КонецЕсли;
		
		 //Отпуск товара произвел
		Если НЕ ЗначениеЗаполнено(ВыборкаДокумент.ОтпускПроизвел) Тогда
			ФИООтпускПроизвел        = Новый Структура("Фамилия,Имя,Отчество","Отсутствует","Отсутствует","Отсутствует");
			ДолжностьОтпускПроизвел  = "Кладовщик";
		Иначе
			ФИООтпускПроизвел             = ФормированиеПечатныхФормСервер.ФамилияИмяОтчество(ВыборкаДокумент.ОтпускПроизвел, ВыборкаДокумент.Дата);
			ПодразделениеДолжностьФизЛица = ПолныеПрава.СведенияОСотруднике(ВыборкаДокумент.ОтпускПроизвел, ВыборкаДокумент.Дата, ВыборкаДокумент.Организация);
			ДолжностьОтпускПроизвел       = ?(ЗначениеЗаполнено(ПодразделениеДолжностьФизЛица.Должность),ПодразделениеДолжностьФизЛица.Должность,"Кладовщик");
		КонецЕсли;
					  ЗаписьXML.ЗаписатьНачалоЭлемента("ОтпускРазреш");//+ОтпускРазреш
                             ЗаписьXML.ЗаписатьАтрибут( "Должность", ДолжностьОтпускРазрешил);
							 ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
							       ЗаписьXML.ЗаписатьАтрибут( "Фамилия", ФИООтпускРазрешил.Фамилия);
                                   ЗаписьXML.ЗаписатьАтрибут( "Имя",     ФИООтпускРазрешил.Имя);
                                   ЗаписьXML.ЗаписатьАтрибут( "Отчество",ФИООтпускРазрешил.Отчество);
							 ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
                      ЗаписьXML.ЗаписатьКонецЭлемента();//-ОтпускРазреш

					  ЗаписьXML.ЗаписатьНачалоЭлемента("Бухгалтер");//+Бухгалтер  
					        //ЗаписьXML.ЗаписатьАтрибут( "Должность", Руководители.ГлавныйБухгалтерДолжность.Наименование);
					  		ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
							ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Руководители.ГлавныйБухгалтерФИО.Фамилия);
                            ЗаписьXML.ЗаписатьАтрибут( "Имя",     Руководители.ГлавныйБухгалтерФИО.Имя);
                            ЗаписьXML.ЗаписатьАтрибут( "Отчество",Руководители.ГлавныйБухгалтерФИО.Отчество);
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
                      ЗаписьXML.ЗаписатьКонецЭлемента();//-Бухгалтер

					  ЗаписьXML.ЗаписатьНачалоЭлемента("ОтпускПроизв");//+ОтпускПроизв
					  Если ЗначениеЗаполнено(ДолжностьОтпускПроизвел) Тогда
					   ЗаписьXML.ЗаписатьАтрибут( "Должность", ДолжностьОтпускПроизвел);
					  КонецЕсли;
							 ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
							 ЗаписьXML.ЗаписатьАтрибут( "Фамилия", ФИООтпускПроизвел.Фамилия);
                             ЗаписьXML.ЗаписатьАтрибут( "Имя",     ФИООтпускПроизвел.Имя);
                             ЗаписьXML.ЗаписатьАтрибут( "Отчество",ФИООтпускПроизвел.Отчество);
							 ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
                      ЗаписьXML.ЗаписатьКонецЭлемента();//-ОтпускПроизв
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ОтпускГруз
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПол");//+ИнфПол
			      ЗаписьXML.ЗаписатьАтрибут( "ТекстИнф", "отправитель:" + ВыборкаДокумент.GLNОрганизации + ";получатель:" + ВыборкаДокумент.GLNКонтрагента);
			      ЗаписьXML.ЗаписатьАтрибут( "ИдФайлИнфПол", Строка(ДокументОтгрузки.УникальныйИдентификатор()));
            ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПол
	ЗаписьXML.ЗаписатьКонецЭлемента();//-СвТНО

			//ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
			//	ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
			//		ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
			// 		ЗаписьXML.ЗаписатьАтрибут( "Должн", Руководители.РуководительДолжность.Наименование);
			//	
			//		ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
			//			ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Руководители.РуководительФИО.Фамилия);  
			// 			ЗаписьXML.ЗаписатьАтрибут( "Имя", Руководители.РуководительФИО.Имя); 
			//			ЗаписьXML.ЗаписатьАтрибут( "Отчество", Руководители.РуководительФИО.Отчество); 
			//		ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			//	
			//	ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			//ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
				ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
            	ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
					ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", "7714281617");
					
					СтруктураПодписант = ОтветственныйПоЭДО(ДокументОтгрузки.Организация, ДокументОтгрузки.Дата);
					
			 		ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
					    ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 

					ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
				
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	//________________________________________________________________________________________________________
    СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.Торг12);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
	СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	СтруктураПараметров.Вставить("НастройкаОбмена"		    , Справочники.абс_НастройкиEDIОбмена.КОРУС);
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерДокументаEDIЗаказа);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаДокументаEDI);
    СтруктураПараметров.Вставить("Ответственный"		    , ПараметрыСеанса.ТекущийПользователь);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры

Процедура ВыгрузитьТорг12(ДокументОтгрузки, ЕстьОшибки = Ложь) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст ="ВЫБРАТЬ
	              |	Накладная.Номенклатура КАК Номенклатура,
	              |	ВЫРАЗИТЬ(Накладная.Номенклатура.НаименованиеПолное КАК СТРОКА(1000)) КАК ТоварНаименование,
	              |	Накладная.ЕдиницаИзмерения.Представление КАК БазоваяЕдиницаНаименование,
	              |	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК БазоваяЕдиницаКодПоОКЕИ,
	              |	Накладная.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	              |	Накладная.ЕдиницаИзмеренияМест.Представление КАК ВидУпаковки,
	              |	Накладная.КоэффициентМест / Накладная.Коэффициент КАК КоличествоВОдномМесте,
	              |	ВЫБОР
	              |		КОГДА Накладная.КоличествоМест > 0
	              |			ТОГДА Накладная.КоличествоМест * Накладная.ЕдиницаИзмеренияМест.Вес
	              |		ИНАЧЕ Накладная.Количество * Накладная.ЕдиницаИзмерения.Вес
	              |	КОНЕЦ КАК МассаБрутто,
	              |	Накладная.Количество * Накладная.ЕдиницаИзмерения.Коэффициент / Накладная.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент * Накладная.Номенклатура.ЕдиницаХраненияОстатков.Вес КАК МассаНетто,
	              |	Накладная.Характеристика КАК Характеристика,
	              |	Накладная.Серия КАК Серия,
	              |	ВЫБОР
	              |		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	              |				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	              |			ТОГДА 18
	              |		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	              |				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	              |			ТОГДА 10
	              |		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	              |				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	              |			ТОГДА 20                                                      
	              |		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	              |				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	              |			ТОГДА 5
	              |		КОГДА Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	              |				ИЛИ Накладная.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	              |			ТОГДА 7
	              |		ИНАЧЕ 0
	              |	КОНЕЦ КАК СтавкаНДС,
	              |	Накладная.Цена КАК Цена,
	              |	ВЫБОР
	              |		КОГДА Накладная.ПроцентСкидкиНаценки = 0
	              |				И Накладная.ПроцентАвтоматическихСкидок = 0
	              |			ТОГДА ЛОЖЬ
	              |		ИНАЧЕ ИСТИНА
	              |	КОНЕЦ КАК ЕстьСкидкиПоСтроке,
	              |	Накладная.Количество КАК Количество,
	              |	Накладная.КоличествоМест КАК КоличествоМест,
	              |	Накладная.Сумма КАК Сумма,
	              |	Накладная.СуммаНДС КАК СуммаНДС,
	              |	Накладная.НомерСтроки КАК НомерСтроки,
	              |	Накладная.Метка КАК Метка,
	              |	Штрихкоды.Штрихкод
	              |ИЗ
	              |	(ВЫБРАТЬ
	              |		РеализацияТоваровУслуг.Номенклатура КАК Номенклатура,
	              |		РеализацияТоваровУслуг.Коэффициент КАК Коэффициент,
	              |		РеализацияТоваровУслуг.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	              |		РеализацияТоваровУслуг.ЕдиницаИзмеренияМест КАК ЕдиницаИзмеренияМест,
	              |		РеализацияТоваровУслуг.ЕдиницаИзмеренияМест.Коэффициент КАК КоэффициентМест,
	              |		РеализацияТоваровУслуг.ХарактеристикаНоменклатуры КАК Характеристика,
	              |		РеализацияТоваровУслуг.СерияНоменклатуры КАК Серия,
	              |		РеализацияТоваровУслуг.СтавкаНДС КАК СтавкаНДС,
	              |		РеализацияТоваровУслуг.Цена * &Курс / &Кратность КАК Цена,
	              |		РеализацияТоваровУслуг.ПроцентСкидкиНаценки КАК ПроцентСкидкиНаценки,
	              |		РеализацияТоваровУслуг.ПроцентАвтоматическихСкидок КАК ПроцентАвтоматическихСкидок,
	              |		СУММА(РеализацияТоваровУслуг.Количество) КАК Количество,
	              |		СУММА(РеализацияТоваровУслуг.КоличествоМест) КАК КоличествоМест,
	              |		СУММА(РеализацияТоваровУслуг.Сумма * &Курс / &Кратность) КАК Сумма,
	              |		СУММА(РеализацияТоваровУслуг.СуммаНДС * &Курс / &Кратность) КАК СуммаНДС,
	              |		МИНИМУМ(РеализацияТоваровУслуг.НомерСтроки) КАК НомерСтроки,
	              |		0 КАК Метка
	              |	ИЗ
	              |		Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслуг
	              |	ГДЕ
	              |		РеализацияТоваровУслуг.Ссылка = &ДокументОтгрузки
	              |	
	              |	СГРУППИРОВАТЬ ПО
	              |		РеализацияТоваровУслуг.Номенклатура,
	              |		РеализацияТоваровУслуг.Коэффициент,
	              |		РеализацияТоваровУслуг.ЕдиницаИзмерения,
	              |		РеализацияТоваровУслуг.ЕдиницаИзмеренияМест,
	              |		РеализацияТоваровУслуг.ХарактеристикаНоменклатуры,
	              |		РеализацияТоваровУслуг.СерияНоменклатуры,
	              |		РеализацияТоваровУслуг.СтавкаНДС,
	              |		РеализацияТоваровУслуг.Цена,
	              |		РеализацияТоваровУслуг.ПроцентСкидкиНаценки,
	              |		РеализацияТоваровУслуг.ПроцентАвтоматическихСкидок,
	              |		РеализацияТоваровУслуг.ЕдиницаИзмеренияМест.Коэффициент,
	              |		РеализацияТоваровУслуг.Ссылка.ОтпускРазрешил,
	              |		РеализацияТоваровУслуг.Ссылка.ОтпускПроизвел) КАК Накладная
	              |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	              |		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	              |			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	              |			И Накладная.Характеристика = Штрихкоды.ХарактеристикаНоменклатуры
	              |			И (Штрихкоды.ТипШтрихкода = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13))
	              |
	              |УПОРЯДОЧИТЬ ПО
	              |	НомерСтроки
	              |АВТОУПОРЯДОЧИВАНИЕ
	              |;
	              |
	              |////////////////////////////////////////////////////////////////////////////////
	              |ВЫБРАТЬ
	              |	Накладная.Номер КАК Номер,
	              |	Накладная.Дата КАК Дата,
	              |	Накладная.Сделка КАК Сделка,
	              |	Накладная.Сделка.Номер КАК НомерЗаказа,
	              |	Накладная.Сделка.Дата КАК ДатаЗаказа,
	              |	Накладная.Организация.абс_GLN КАК GLNОрганизации,
	              |	Накладная.Контрагент.абс_GLN КАК GLNКонтрагента,
	              |	Накладная.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	              |	Накладная.Сделка.ДокументОснование.НомерДокументаEDIЗаказа КАК НомерДокументаEDIЗаказа,
	              |	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
	              |	Накладная.Организация.Лео_GUID КАК GUIDОрганизации,
	              |	Накладная.Контрагент.Лео_GUID КАК GUIDКонтрагента,
	              |	Накладная.ВалютаДокумента КАК Валюта,
	              |	Накладная.ВалютаДокумента.Код КАК КодВалюты,
	              |	Накладная.Организация КАК Организация,
	              |	ВЫБОР
	              |		КОГДА Накладная.Грузополучатель = &ПустойКонтрагент
	              |			ТОГДА Накладная.Ссылка.Контрагент
	              |		ИНАЧЕ Накладная.Грузополучатель
	              |	КОНЕЦ КАК Грузополучатель,
	              |	Накладная.Контрагент КАК Контрагент,
	              |	Накладная.Подразделение КАК Подразделение,
	              |	ВЫБОР
	              |		КОГДА Накладная.Грузоотправитель = &ПустойКонтрагент
	              |			ТОГДА Накладная.Организация
	              |		ИНАЧЕ Накладная.Грузоотправитель
	              |	КОНЕЦ КАК Грузоотправитель,
	              |	Накладная.Организация КАК Поставщик,
	              |	Накладная.Контрагент КАК Плательщик,
	              |	Накладная.Сделка КАК Основание,
	              |	абс_СводнаяЗаявкаНаТранспортМаршруты.Ссылка.Дата КАК ТТНДата,
	              |	Накладная.ОтпускРазрешил КАК ОтпускРазрешил,
	              |	Накладная.ОтпускПроизвел КАК ОтпускПроизвел,
	              |	Накладная.СуммаВключаетНДС,
	              |	Накладная.ДоговорКонтрагента,
	              |	Накладная.Контрагент.Лео_ОператорEDI КАК ОператорEDI
	              |ИЗ
	              |	Документ.РеализацияТоваровУслуг КАК Накладная
	              |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_СводнаяЗаявкаНаТранспорт.Маршруты КАК абс_СводнаяЗаявкаНаТранспортМаршруты
	              |		ПО Накладная.Ссылка = абс_СводнаяЗаявкаНаТранспортМаршруты.ЗаявкаНаТранспорт.ДокументОтгрузки
	              |			И (абс_СводнаяЗаявкаНаТранспортМаршруты.Ссылка.Проведен = ИСТИНА)
	              |ГДЕ
	              |	Накладная.Ссылка = &ДокументОтгрузки";
	              
	ВалютаУчета = глЗначениеПеременной("ВалютаРегламентированногоУчета");
			  
	Запрос.УстановитьПараметр("ДокументОтгрузки", ДокументОтгрузки);
	Запрос.УстановитьПараметр("ПустойКонтрагент", Справочники.Контрагенты.ПустаяСсылка());
	Запрос.УстановитьПараметр("Курс",             ЗаполнениеДокументов.КурсДокумента(ДокументОтгрузки, ВалютаУчета));
	Запрос.УстановитьПараметр("Кратность",        ЗаполнениеДокументов.КратностьДокумента(ДокументОтгрузки,ВалютаУчета));
	
	Результат = Запрос.ВыполнитьПакет();
	ВыборкаДокумент = Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////		
	//{Лео Катанович
	Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
		 Идентификатор = ВыборкаДокумент.ОператорEDI.Идентификатор;
	 Иначе	 
		 Идентификатор = "2IH";
	 КонецЕсли;	
	 
	 
	 	//{Лео Катанович
	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") ИЛИ     // ДИКСИ ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("УТ0005949") Тогда   // Сладкая жизнь
		 GUIDОрганизации = "C585D418-784D-449B-82B3-FF4CD2DE5051";
	 Иначе
		 GUIDОрганизации = ВыборкаДокумент.GUIDОрганизации;
	КонецЕсли;

	 
	//ИдФайл = "DP_OTORG12_" +  ВыборкаДокумент.GUIDКонтрагента + "_2IH" + ВыборкаДокумент.GUIDОрганизации  + "_" + Формат(ВыборкаДокумент.Дата,"ДФ=ггггММдд") + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор());
	ИдФайл = "DP_OTORG12_" +  ВыборкаДокумент.GUIDКонтрагента + "_" + Идентификатор +  GUIDОрганизации  + "_" + Формат(ВыборкаДокумент.Дата,"ДФ=ггггММдд") + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор());
	//Лео Катанович}
	
	ИдФайл = СформироватьИмяФайлаEDI(ИдФайл);
	ИмяФайла = ИдФайл + ".xml";

	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку("windows-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Exite Evolution 2.9.2" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.01" );
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
		 // {Лео Катанович
		 // ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр","2IH-" +  ВыборкаДокумент.GUIDОрганизации );
		 ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр",Идентификатор + "-" + GUIDОрганизации );
		 // Лео Катанович}
		  ЗаписьXML.ЗаписатьАтрибут( "ИдПок", ВыборкаДокумент.GUIDКонтрагента);
		  
		  ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпрСФ"); //+СвОЭДОтпр
		  Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.ОператорEDI.Наименование,"""","&quot;"));
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.ОператорEDI.Контрагент.ИНН);
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДОСФ", Идентификатор);	
		  Иначе	  
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "Систем Групп Рус");
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   "7723749362");
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДОСФ", Идентификатор);	
		  КонецЕсли;
		  ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		  
		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
			ЗаписьXML.ЗаписатьАтрибут( "КНД", "1175004");
			ЗаписьXML.ЗаписатьАтрибут( "ДатаДок", Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
            ЗаписьXML.ЗаписатьАтрибут( "ВремДок", СтрЗаменить(Формат(ВыборкаДокумент.Дата,"ДЛФ=T"),":","."));
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвТНО");//+СвТоварнаяНакладная 
				ЗаписьXML.ЗаписатьАтрибут( "НаимПервДок", "Товарная накладная");
				ЗаписьXML.ЗаписатьАтрибут( "ОКУДПервДок","0330212" );              
				ЗаписьXML.ЗаписатьАтрибут( "НомФорм", "ТОРГ-12");
				
				//   ГРУЗООТПРАВИТЕЛЬ
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОт");//+ГрузОт 
				   //Если ЗначениеЗаполнено(ВыборкаДокумент.Организация.КодОКВЭД) Тогда
				   //	 ЗаписьXML.ЗаписатьАтрибут( "ОКДП",ВыборкаДокумент.Организация.КодОКВЭД);
				   //КонецЕсли;
					ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОтпр");//+ГрузОтпр
					//Если ЗначениеЗаполнено(ВыборкаДокумент.Грузоотправитель.КодПоОКПО) Тогда
					//	 ЗаписьXML.ЗаписатьАтрибут( "ОКПО",СокрЛП(ВыборкаДокумент.Грузоотправитель.КодПоОКПО));
					//КонецЕсли;
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
	                    СведенияОГрузоотправитель =  УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузоотправитель,  ВыборкаДокумент.Дата);
                              ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛ");//+СвЮл

							  //ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.Грузоотправитель.НаименованиеПолное,"""","&quot;" ));
							  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Грузоотправитель.НаименованиеПолное);
							  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.Грузоотправитель.ИНН );
							  ЗаписьXML.ЗаписатьАтрибут( "КПП",     ВыборкаДокумент.Грузоотправитель.КПП );
							  //Если ВыборкаДокумент.Грузоотправитель.Метаданные().Реквизиты.Найти("ОКОПФ") <> Неопределено Тогда
							  //	 ОКОПФ = Прав(ВыборкаДокумент.Грузоотправитель.ОКОПФ.Код,2);
							  //Иначе 
							  //	 ОКОПФ = "";
							  //КонецЕсли;
							  //Если ЗначениеЗаполнено(ОКОПФ) Тогда	
							  //	 ЗаписьXML.ЗаписатьАтрибут( "ОКОПФ", СокрЛП(ОКОПФ));
							  // КонецЕсли;
							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮл
       				        ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузоотправитель,Перечисления.ТипыКонтактнойИнформации.Адрес,?(ТипЗнч(ВыборкаДокумент.Грузоотправитель) = Тип("СправочникСсылка.Организации"),Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента));
								// Функция проверить на NULL
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ

							//ЗаписьXML.ЗаписатьНачалоЭлемента("АдрТекст");//+АдрТекст
							//ЗаписьXML.ЗаписатьТекст(СведенияОГрузоотправитель.ЮридическийАдрес);
							////		  ЗаписатьXML(ЗаписьXML,СведенияОГрузоотправитель.ЮридическийАдрес,"АдрТекст");
							//ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрТекст
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.Телефоны) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузоотправитель.Телефоны,20));
									  КонецЕсли;	   
									  //Факс = ПолучитьФаксКонтрагента(ВыборкаДокумент.Грузоотправитель);
									  //Если ЗначениеЗаполнено(Факс) Тогда
									  //	 ЗаписьXML.ЗаписатьАтрибут( "Факс", Факс);
									  //КонецЕсли;
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт

//							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
//									  Если ЗначениеЗаполнено(СведенияОГрузоотправитель.НомерСчета) Тогда
//										   ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузоотправитель.НомерСчета);
//									  КонецЕсли;	   
//									  ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
//												Если ЗначениеЗаполнено(СведенияОГрузоотправитель.БИК) Тогда
//													 ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузоотправитель.Банк.Наименование);
//													 ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузоотправитель.БИК);
//												КонецЕсли;	 
//									  ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
//							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
				    ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОтпр
					//ЗаписьXML.ЗаписатьНачалоЭлемента("СтруктПодр");//+СтруктПодр
					//ЗаписьXML.ЗаписатьТекст(ВыборкаДокумент.Подразделение.Наименование);
					//		 ///ЗаписатьXML(ЗаписьXML,ВыборкаДокумент.Подразделение.Наименование,"СтруктПодр");
					//ЗаписьXML.ЗаписатьКонецЭлемента();//-СтруктПодр
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОт
				
           //   ГРУЗОПОЛУЧАТЕЛЬ
			ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузПолуч");//+ГрузПолуч	
			СтрокаСведений = "ТелОрганизации, АдрЮР, ФаксОрганизации";
		    СведенияОГрузополучатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузополучатель,  ВыборкаДокумент.Дата);
					  //Если ЗначениеЗаполнено(ВыборкаДокумент.Грузополучатель.КодПоОКПО) Тогда
					  //	 ЗаписьXML.ЗаписатьАтрибут( "ОКПО",ВыборкаДокумент.Грузополучатель.КодПоОКПО);
					  //Конецесли;	   
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
							  //ЭтоЮрЛицо = ВыборкаДокумент.Грузополучатель.ЮрФизЛицо <> Перечисления.ЮрФизЛицо.ФизЛицо;
							  //Если ЭтоЮрЛицо Тогда
							       ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛ");//+СвЮЛ
								   //ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.Грузополучатель.Наименование,"""","&quot;" ));
								   ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Грузополучатель.Наименование);
							       ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОГрузополучатель.ИНН );
							       ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОГрузополучатель.КПП );
								   //Если ВыборкаДокумент.Грузополучатель.Метаданные().Реквизиты.Найти("ОКОПФ") <> Неопределено Тогда
								   //	 ОКОПФ = Прав(ВыборкаДокумент.Грузополучатель.ОКОПФ.Код,2);
								   //Иначе 
								   //	 ОКОПФ = "";
								   //КонецЕсли;
								   //Если ЗначениеЗаполнено(ОКОПФ) Тогда	
								   //	 ЗаписьXML.ЗаписатьАтрибут( "ОКОПФ", СокрЛП(ОКОПФ));
								   //КонецЕсли;		
								   ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛ
							  // Иначе
							  //	 ЗаписьXML.ЗаписатьНачалоЭлемента("СвФЛ");//+СвФЛ
							  //	 ЗаписьXML.ЗаписатьАтрибут( "ИННФЛ",   СведенияОГрузополучатель.ИНН );
							  //			   ЗаписьXML.ЗаписатьНачалоЭлемента("ФИОИП");//+ФИОИП 
							  //  					ФИО = РазложитьФИО(ВыборкаДокумент.Грузополучатель.НаименованиеПолное);
							  //					  ЗаписьXML.ЗаписатьАтрибут("Фамилия", ФИО.Фамилия );
							  //					  ЗаписьXML.ЗаписатьАтрибут("Имя",     ФИО.Имя );
							  //  					ЗаписьXML.ЗаписатьАтрибут("Отчество",ФИО.Отчество );
							  //			   ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИОИП
							  //	 ЗаписьXML.ЗаписатьКонецЭлемента();//-СвФЛ													
							  //КонецЕсли;
				        ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента);
							    Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
							   ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							//
							//	ЗаписьXML.ЗаписатьНачалоЭлемента("АдрТекст");//+АдрТекст
							//	ЗаписьXML.ЗаписатьТекст(СведенияОГрузополучатель.АдресДоставки);
							//	//	  ЗаписатьXML(ЗаписьXML,СведенияОГрузополучатель.АдресДоставки,"АдрТекст");
							//	ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрТекст
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							//ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							//		  Если ЗначениеЗаполнено(СведенияОГрузополучатель.Телефоны) Тогда
							//			   ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузополучатель.Телефоны,20));
							//		  КонецЕсли;
							//		  Факс = ПолучитьФаксКонтрагента(ВыборкаДокумент.Грузополучатель);
							//		  Если ЗначениеЗаполнено(Факс) Тогда
							//			   ЗаписьXML.ЗаписатьАтрибут( "Факс", Факс);
							//		  КонецЕсли;
							//ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт

							//ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							//		  Если ЗначениеЗаполнено(СведенияОГрузополучатель.НомерСчета) Тогда
							//			   ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузополучатель.НомерСчета);
							//		  КонецЕсли;	   
							//		  ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							//					Если ЗначениеЗаполнено(СведенияОГрузополучатель.БИК) Тогда
							//						 ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузополучатель.Банк.Наименование);
							//						 ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузополучатель.БИК);
							//					КонецЕсли;	 
							//		  ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							//ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв

				    ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузПолуч
					
			    //   ПОСТАВЩИК
				ЗаписьXML.ЗаписатьНачалоЭлемента("Поставщик");//+Поставщик	
		        СведенияОПоставщик = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Поставщик,  ВыборкаДокумент.Дата);
					  //Если ЗначениеЗаполнено(ВыборкаДокумент.Поставщик.КодПоОКПО) Тогда
					  //	 ЗаписьXML.ЗаписатьАтрибут( "ОКПО",ВыборкаДокумент.Поставщик.КодПоОКПО);
					  //КонецЕсли;	   
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						      //ЭтоЮрЛицо = ВыборкаДокумент.Поставщик.ЮрФизЛицо <> Перечисления.ЮрФизЛицо.ФизЛицо;
							       ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛ");//+СвЮЛ
								   //ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.Поставщик.Наименование,"""","&quot;" ));
								   ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Поставщик.НаименованиеПолное);
							       ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОПоставщик.ИНН );
							       ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОПоставщик.КПП );
								   //Если ВыборкаДокумент.Поставщик.Метаданные().Реквизиты.Найти("ОКОПФ") <> Неопределено Тогда
								   //	 ОКОПФ = Прав(ВыборкаДокумент.Поставщик.ОКОПФ.Код,2);
								   //Иначе 
								   //	 ОКОПФ = "";
								   //КонецЕсли;
								   //Если ЗначениеЗаполнено(ОКОПФ) Тогда	
								   //	 ЗаписьXML.ЗаписатьАтрибут( "ОКОПФ", СокрЛП(ОКОПФ));
								   //КонецЕсли;	
                                   ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛ
				        ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Поставщик,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
							    ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							
								//ЗаписьXML.ЗаписатьНачалоЭлемента("АдрТекст");//+АдрТекст
								//ЗаписьXML.ЗаписатьТекст(СведенияОПоставщик.ЮридическийАдрес);
								////	  ЗаписатьXML(ЗаписьXML,СведенияОПоставщик.ЮридическийАдрес,"АдрТекст");
								//ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрТекст

						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							          Если ЗначениеЗаполнено(СведенияОПоставщик.Телефоны) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПоставщик.Телефоны,20));
									  КонецЕсли;	   
									  //Факс = ПолучитьФаксКонтрагента(ВыборкаДокумент.Поставщик);
									  //Если ЗначениеЗаполнено(Факс) Тогда
									  //	 ЗаписьXML.ЗаписатьАтрибут( "Факс", Факс);
									  //КонецЕсли;

						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт

							//ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							//		  Если ЗначениеЗаполнено(СведенияОПоставщик.НомерСчета) Тогда
							//			   ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПоставщик.НомерСчета);
							//		  КонецЕсли;	   
							//		  ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							//					Если ЗначениеЗаполнено(СведенияОПоставщик.БИК) Тогда
							//						 ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПоставщик.Банк.Наименование);
							//						 ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПоставщик.БИК);
							//					КонецЕсли;
							//		  ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							//ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв

				    ЗаписьXML.ЗаписатьКонецЭлемента();//-Поставщик
					
				//   ПЛАТЕЛЬЩИК
				ЗаписьXML.ЗаписатьНачалоЭлемента("Плательщик");//+Плательщик	
		        СведенияОПлательщик = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Плательщик,  ВыборкаДокумент.Дата);
					  //Если ЗначениеЗаполнено(ВыборкаДокумент.Плательщик.КодПоОКПО) Тогда
					  //	 ЗаписьXML.ЗаписатьАтрибут( "ОКПО",ВыборкаДокумент.Плательщик.КодПоОКПО);
					  //КонецЕсли;	   
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						     // ЭтоЮрЛицо = ВыборкаДокумент.Плательщик.ЮрФизЛицо <> Перечисления.ЮрФизЛицо.ФизЛицо;
							       ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛ");//+СвЮЛ
								   //ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.Плательщик.Наименование,"""","&quot;" ));
								   ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Плательщик.НаименованиеПолное);
								   ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОПлательщик.ИНН );
							       ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОПлательщик.КПП );
								   //Если ВыборкаДокумент.Плательщик.Метаданные().Реквизиты.Найти("ОКОПФ") <> Неопределено Тогда
								   //	 ОКОПФ = Прав(ВыборкаДокумент.Плательщик.ОКОПФ.Код,2);
								   //Иначе 
								   //	 ОКОПФ = "";
								   //КонецЕсли;
								   //Если ЗначениеЗаполнено(ОКОПФ) Тогда	
								   //	 ЗаписьXML.ЗаписатьАтрибут( "ОКОПФ", СокрЛП(ОКОПФ));
								   //КонецЕсли;	
                                   ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛ
				        ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
								ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Плательщик,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
								ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							//ЗаписьXML.ЗаписатьНачалоЭлемента("АдрТекст");//+АдрТекст
							//ЗаписьXML.ЗаписатьТекст(СведенияОПлательщик.ЮридическийАдрес);
							////ЗаписатьXML(ЗаписьXML,СведенияОПлательщик.ЮридическийАдрес,"АдрТекст");
							//ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрТекст
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							//ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							//		  Если ЗначениеЗаполнено(СведенияОПлательщик.Телефоны) Тогда
							//			   ЗаписьXML.ЗаписатьАтрибут( "Тлф", Лев(СведенияОПлательщик.Телефоны,20));
							//		  КонецЕсли;	   
							//		  Факс = ПолучитьФаксКонтрагента(ВыборкаДокумент.Плательщик);
							//		  Если ЗначениеЗаполнено(Факс) Тогда
							//			   ЗаписьXML.ЗаписатьАтрибут( "Факс", Факс);
							//		  КонецЕсли;

							//ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт

							//ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							//		  Если ЗначениеЗаполнено(СведенияОПлательщик.НомерСчета) Тогда
							//			   ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПлательщик.НомерСчета);
							//		  КонецЕсли;
							//		  ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							//					Если ЗначениеЗаполнено(СведенияОПлательщик.БИК) Тогда
							//						 ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПлательщик.Банк.Наименование);
							//						 ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПлательщик.БИК);
							//					КонецЕсли;
							//		  ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							//ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
				    ЗаписьXML.ЗаписатьКонецЭлемента();//-Плательщик
					
					//ОСНОВАНИЕ			
			        ЗаписьXML.ЗаписатьНачалоЭлемента("Основание");//+Основание
			              ЗаписьXML.ЗаписатьАтрибут( "НаимОсн",  "Договор поставки" );
                          ЗаписьXML.ЗаписатьАтрибут( "НомОсн",   ВыборкаДокумент.ДоговорКонтрагента.Номер);
			              ЗаписьXML.ЗаписатьАтрибут( "ДатаОсн",  Формат(ВыборкаДокумент.ДоговорКонтрагента.Дата,"ДФ=дд.ММ.гггг"));
                          //ЗаписьXML.ЗаписатьАтрибут( "ДопСвОсн", ВыборкаДокумент.Основание.Комментарий);
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Основание
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТранНакл");//+ТранНакл
					      ЗаписьXML.ЗаписатьАтрибут( "НомТранНакл",  "б/н");
					      ЗаписьXML.ЗаписатьАтрибут( "ДатаТранНакл", ?(ЗначениеЗаполнено(ВыборкаДокумент.ТТНДата),Формат(ВыборкаДокумент.ТТНДата,"ДФ=дд.ММ.гггг"), Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг")));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранНакл

					//ЗаписьXML.ЗаписатьНачалоЭлемента("ВидОперации");//+ВидОперации
					////ЗаписатьXML(ЗаписьXML,"02","ВидОперации");
					//ЗаписьXML.ЗаписатьТекст("02");
					//ЗаписьXML.ЗаписатьКонецЭлемента();//-ВидОперации
					
			    //ТН
			    ЗаписьXML.ЗаписатьНачалоЭлемента("ТН");//+ТН
			              ЗаписьXML.ЗаписатьАтрибут( "НомТН", ВыборкаДокумент.Номер);
					      ЗаписьXML.ЗаписатьАтрибут( "ДатаТН", Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
                //Таблица
			    ЗаписьXML.ЗаписатьНачалоЭлемента("Таблица");//+Таблица
				ЗапросТовары = Результат[0].Выгрузить();
				
				ВыводитьСерии = абс_Дистрибуция.ПроверитьВеденияОтгрузокПоСериям();
		        Если Не ВыводитьСерии Тогда
			        ЗапросТовары.Свернуть("Номенклатура,ТоварНаименование,БазоваяЕдиницаНаименование,БазоваяЕдиницаКодПоОКЕИ,ЕдиницаИзмерения,ВидУпаковки,КоличествоВОдномМесте,Характеристика,СтавкаНДС,Цена,ЕстьСкидкиПоСтроке,Метка,Штрихкод","МассаБрутто,Сумма,СуммаНДС,КоличествоМест,Количество,МассаНетто");
			        ЗапросТовары.Колонки.Добавить("Серия");
			        ЗапросТовары.ЗаполнитьЗначения("","Серия");
		        КонецЕсли;		
				
				КолМест_Всего = 0;
				Брутто_Всего = 0; 
				Нетто_Всего = 0; 
				СуммаБезНДС_Всего = 0; 
				СуммаНДС_Всего = 0; 
				СуммаУчНДС_Всего = 0; 
				сч = 0;
				Для каждого ВыборкаСтрока из  ЗапросТовары Цикл
					сч = сч + 1;
					ЗаписьXML.ЗаписатьНачалоЭлемента("СвТов");//+СвТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомТов",Строка(сч));
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.НаименованиеПолное);	
						ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов", ВыборкаСтрока.БазоваяЕдиницаКодПоОКЕИ);//ЗаписьXML.ЗаписатьАтрибут( "СортТов","");
                        ЗаписьXML.ЗаписатьАтрибут( "КолМест",  Формат(ВыборкаСтрока.КоличествоМест, "ЧДЦ=0; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "Нетто",    Формат(ВыборкаСтрока.МассаНетто, "ЧДЦ=3; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "Цена",     Формат(ВыборкаСтрока.Цена, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						
						СуммаСНДС   = Окр((ВыборкаСтрока.Сумма + ?(ВыборкаДокумент.СуммаВключаетНДС, 0, ВыборкаСтрока.СуммаНДС)), 2);
			            СуммаНДС    = Окр(ВыборкаСтрока.СуммаНДС, 2);
			            СуммаБезНДС = СуммаСНДС  - СуммаНДС;

						ЗаписьXML.ЗаписатьАтрибут( "СумБезНДС",Формат(СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "СтавкаНДС",Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=5; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "СумНДС",   Формат(СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "СумУчНДС", Формат(СуммаСНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "НаимЕдИзм",ВыборкаСтрока.БазоваяЕдиницаНаименование);
						
						//Артикул покупателя
						АртикулПокупателя = "";
						Отбор = Новый Структура;
						Отбор.Вставить("Номенклатура",ВыборкаСтрока.Номенклатура);
						Отбор.Вставить("Контрагент",ВыборкаДокумент.Контрагент);
						Отбор.Вставить("Свойство", ПланыВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя);
						Структура = РегистрыСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.ПолучитьПоследнее(ВыборкаДокумент.Дата, Отбор);
						АртикулПокупателя = ?(ЗначениеЗаполнено(Структура.ЗначениеСвойства),Структура.ЗначениеСвойства,"");			
						
						ИнфПолСтр = "номер_заказа:" + ВыборкаДокумент.Основание.НомерПоДаннымПокупателя + ";номер_накладной:" + ВыборкаДокумент.Номер + ";код_материала:"   + АртикулПокупателя + ";позиция_заказа:"  + Строка(сч) + ";штрихкод:" + ВыборкаСтрока.Штрихкод + ";датазаказа:" + Формат(ВыборкаДокумент.Основание.ДатаПоДаннымПокупателя,"ДФ=гггг-ММ-дд");
						
						ЗаписьXML.ЗаписатьАтрибут( "ИнфПолСтр",ИнфПолСтр);
						
						Нетто_Всего =  Нетто_Всего + ВыборкаСтрока.МассаНетто;
						СуммаБезНДС_Всего = СуммаБезНДС_Всего + СуммаБезНДС;
						СуммаНДС_Всего = СуммаНДС_Всего + СуммаНДС; 
						СуммаУчНДС_Всего = СуммаУчНДС_Всего + СуммаСНДС;
						
					 ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
				 КонецЦикла;
				 
					 ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоНакл");//+ВсегоНакл
					 	   ЗаписьXML.ЗаписатьАтрибут( "КолМестВс",    Формат(КолМест_Всего, "ЧДЦ=0; ЧРД=.; ЧГ=0; ЧН=" ));
						   ЗаписьXML.ЗаписатьАтрибут( "БруттоВс",     Формат(Брутто_Всего, "ЧДЦ=3; ЧРД=.; ЧГ=0; ЧН=" ));
						   ЗаписьXML.ЗаписатьАтрибут( "НеттоВс",      Формат(Нетто_Всего, "ЧДЦ=3; ЧРД=.; ЧГ=0; ЧН=" ));
						   ЗаписьXML.ЗаписатьАтрибут( "СумБезНДСВс",  Формат(СуммаБезНДС_Всего, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						   ЗаписьXML.ЗаписатьАтрибут( "СумНДСВс",     Формат(СуммаНДС_Всего, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						   ЗаписьXML.ЗаписатьАтрибут( "СумУчНДСВс",   Формат(СуммаУчНДС_Всего, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					 ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоНакл
				ЗаписьXML.ЗаписатьКонецЭлемента();//-Таблица

				ЗаписьXML.ЗаписатьНачалоЭлемента("ТНОбщ");//+ТНОбщ
				      ЗаписьXML.ЗаписатьАтрибут( "КолНомЗап",    Формат(сч, "ЧДЦ=0; ЧРД=.; ЧГ=0; ЧН=" ));
					  ЗаписьXML.ЗаписатьАтрибут( "КолНомЗапПр",  СокрЛП(ЧислоПрописью(сч,, ",,,ж,,,,,0")));
					  //ЗаписьXML.ЗаписатьАтрибут( "ВсМест",       Формат(КолМест_Всего, "ЧДЦ=0; ЧРД=.; ЧГ=0; ЧН=" ));
					  //ЗаписьXML.ЗаписатьАтрибут( "ВсМестПр",     СокрЛП(ЧислоПрописью(КолМест_Всего,, ",,,с,,,,,0")));
					  //ЗаписьXML.ЗаписатьАтрибут( "Нетто",        Формат(Нетто_Всего, "ЧДЦ=3; ЧРД=.; ЧГ=0; ЧН=" ));
					  //ЗаписьXML.ЗаписатьАтрибут( "НеттоПр",      ЧислоПрописью(Нетто_Всего,, "кг,кг,кг,м,г,г,г,м,3"));
					  //ЗаписьXML.ЗаписатьАтрибут( "Брутто",       Формат(Брутто_Всего, "ЧДЦ=3; ЧРД=.; ЧГ=0; ЧН=" ));
					  //ЗаписьXML.ЗаписатьАтрибут( "БруттоПр",     ЧислоПрописью(Брутто_Всего,, "кг,кг,кг,м,г,г,г,м,3"));

 			    ЗаписьXML.ЗаписатьКонецЭлемента();//-ТНОбщ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТН

			ЗаписьXML.ЗаписатьНачалоЭлемента("ОтпускГруз");//+ОтпускГруз
			
					  //ЗаписьXML.ЗаписатьАтрибут( "КолПрил",  "");
					  //ЗаписьXML.ЗаписатьАтрибут( "КолПрилПр","");
					  ЗаписьXML.ЗаписатьАтрибут( "СумОтпуск",   Формат(СуммаУчНДС_Всего, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					  //ЗаписьXML.ЗаписатьАтрибут( "СумОтпускПр", ОбщегоНазначения.СформироватьСуммуПрописью(СуммаУчНДС_Всего, ВалютаУчета));
					 //ЗаписьXML.ЗаписатьАтрибут( "СумОтпускПр",     ЧислоПрописью(СуммаУчНДС_Всего,, "руб.,руб.,руб.,м,коп.,коп.,коп.,м,2"));
					  ЗаписьXML.ЗаписатьАтрибут( "ДатаОтпуск",  Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
					  
					  Руководители = ОбщегоНазначения.ОтветственныеЛица(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата,);
					  
					       ЗаписьXML.ЗаписатьНачалоЭлемента("Бухгалтер");//+Бухгалтер  
					        ЗаписьXML.ЗаписатьАтрибут( "Должность", Руководители.ГлавныйБухгалтерДолжность.Наименование);
					  		ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
							ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Руководители.ГлавныйБухгалтерФИО.Фамилия);
                            ЗаписьXML.ЗаписатьАтрибут( "Имя",     Руководители.ГлавныйБухгалтерФИО.Имя);
                            ЗаписьXML.ЗаписатьАтрибут( "Отчество",Руководители.ГлавныйБухгалтерФИО.Отчество);
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
                      ЗаписьXML.ЗаписатьКонецЭлемента();//-Бухгалтер
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ОтпускГруз
					  
					  
					  
					  
////////////////////////////////////////////////////////	
//		// Отпуск товара разрешил
//		Если НЕ ЗначениеЗаполнено(ВыборкаДокумент.ОтпускРазрешил) Тогда
//			ФИООтпускРазрешил       = Руководители.РуководительФИО;
//			ДолжностьОтпускРазрешил = Руководители.РуководительДолжность.Наименование;
//		Иначе
//			ФИООтпускРазрешил                = ФормированиеПечатныхФормСервер.ФамилияИмяОтчество(ВыборкаДокумент.ОтпускРазрешил, ВыборкаДокумент.Дата);
//			ПодразделениеДолжностьФизЛица    = ПолныеПрава.СведенияОСотруднике(ВыборкаДокумент.ОтпускРазрешил, ВыборкаДокумент.Дата, ВыборкаДокумент.Организация);
//			ДолжностьОтпускРазрешил          = ?(ЗначениеЗаполнено(ПодразделениеДолжностьФизЛица.Должность),ПодразделениеДолжностьФизЛица.Должность,"");
//		КонецЕсли;
//		
//		 //Отпуск товара произвел
//		Если НЕ ЗначениеЗаполнено(ВыборкаДокумент.ОтпускПроизвел) Тогда
//			ФИООтпускПроизвел        = Новый Структура("Фамилия,Имя,Отчество","Отсутствует","Отсутствует","Отсутствует");
//			ДолжностьОтпускПроизвел  = "Кладовщик";
//		Иначе
//			ФИООтпускПроизвел             = ФормированиеПечатныхФормСервер.ФамилияИмяОтчество(ВыборкаДокумент.ОтпускПроизвел, ВыборкаДокумент.Дата);
//			ПодразделениеДолжностьФизЛица = ПолныеПрава.СведенияОСотруднике(ВыборкаДокумент.ОтпускПроизвел, ВыборкаДокумент.Дата, ВыборкаДокумент.Организация);
//			ДолжностьОтпускПроизвел       = ?(ЗначениеЗаполнено(ПодразделениеДолжностьФизЛица.Должность),ПодразделениеДолжностьФизЛица.Должность,"Кладовщик");
//		КонецЕсли;
//					  ЗаписьXML.ЗаписатьНачалоЭлемента("ОтпускРазреш");//+ОтпускРазреш
//							 ЗаписьXML.ЗаписатьАтрибут( "Должность", ДолжностьОтпускРазрешил);
//							 ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
//								   ЗаписьXML.ЗаписатьАтрибут( "Фамилия", ФИООтпускРазрешил.Фамилия);
//								   ЗаписьXML.ЗаписатьАтрибут( "Имя",     ФИООтпускРазрешил.Имя);
//								   ЗаписьXML.ЗаписатьАтрибут( "Отчество",ФИООтпускРазрешил.Отчество);
//							 ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
//					  ЗаписьXML.ЗаписатьКонецЭлемента();//-ОтпускРазреш


//					  ЗаписьXML.ЗаписатьНачалоЭлемента("ОтпускПроизв");//+ОтпускПроизв
//					  Если ЗначениеЗаполнено(ДолжностьОтпускПроизвел) Тогда
//					   ЗаписьXML.ЗаписатьАтрибут( "Должность", ДолжностьОтпускПроизвел);
//					  КонецЕсли;
//							 ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
//							 ЗаписьXML.ЗаписатьАтрибут( "Фамилия", ФИООтпускПроизвел.Фамилия);
//							 ЗаписьXML.ЗаписатьАтрибут( "Имя",     ФИООтпускПроизвел.Имя);
//							 ЗаписьXML.ЗаписатьАтрибут( "Отчество",ФИООтпускПроизвел.Отчество);
//							 ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
//					  ЗаписьXML.ЗаписатьКонецЭлемента();//-ОтпускПроизв
//				ЗаписьXML.ЗаписатьКонецЭлемента();//-ОтпускГруз
			
			//ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПол");//+ИнфПол // ссылка на ИД ЭСФ
			//ИДСФ = "ON_SFAKT_" +  ВыборкаДокумент.GUIDКонтрагента + "_2IH" + ВыборкаДокумент.GUIDОрганизации  + "_" + Формат(ВыборкаДокумент.Дата,"ДФ=ггггММдд") + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор()) ;
			//ИДСФ = СтрЗаменить(ИДСФ,"-","");
			//
			//ЗаписьXML.ЗаписатьАтрибут( "ТекстИнф", ИДСФ);
			//ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПол
			
			//проверка наличия с/ф
	//СписокВидовСчетовФактур = Новый СписокЗначений;
	//СписокВидовСчетовФактур.Добавить(Перечисления.ВидСчетаФактурыВыставленного.Корректировочный);
	//СписокВидовСчетовФактур.Добавить(Перечисления.ВидСчетаФактурыВыставленного.НаРеализацию);

	//ОтборСчетовФактур = Новый Структура();
	//ОтборСчетовФактур.Вставить("ВидСчетаФактуры", СписокВидовСчетовФактур);
	//ОтборСчетовФактур.Вставить("ПометкаУдаления", Ложь);

   //ВыборкаДокументСФ = (УчетНДС.НайтиПодчиненныйСчетФактуру(ДокументОтгрузки, "СчетФактураВыданный", ОтборСчетовФактур));
    //Если ЗначениеЗаполнено(ВыборкаДокументСФ) Тогда
	        //+Лео Сафонов Хардкод для Тандер
			Если  ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") Тогда //Тандер
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПол");//+ИнфПол // ссылка на ИД ЭСФ
				ЗаписьXML.ЗаписатьАтрибут( "ТекстИнф", "грузополучатель:" + ВыборкаДокумент.GLNГрузополучателя + ";дата_поставки:" + Формат(ВыборкаДокумент.Дата,"ДФ=dd.MM.yyyy"));
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПол

			Иначе
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПол");//+ИнфПол // ссылка на ИД ЭСФ
				ЗаписьXML.ЗаписатьАтрибут( "ТекстИнф", Строка(ДокументОтгрузки.УникальныйИдентификатор()));
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПол
			КонецЕсли;
	//КонецЕсли;		

	//////////////////		
	ЗаписьXML.ЗаписатьКонецЭлемента();//-СвТНО

			//ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
			//	ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
			//		ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
			// 		ЗаписьXML.ЗаписатьАтрибут( "Должн", Руководители.РуководительДолжность.Наименование);
			//	
			//		ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
			//			ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Руководители.РуководительФИО.Фамилия);  
			// 			ЗаписьXML.ЗаписатьАтрибут( "Имя", Руководители.РуководительФИО.Имя); 
			//			//ЗаписьXML.ЗаписатьАтрибут( "Отчество", Руководители.РуководительФИО.Отчество); 
			//		ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			//	
			//	ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			//ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
				ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
            	ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
					ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", "7714281617");
					
					СтруктураПодписант = ОтветственныйПоЭДО(ДокументОтгрузки.Организация, ДокументОтгрузки.Дата);
					
			 		ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
						ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 


					ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
				
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант

		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	//________________________________________________________________________________________________________
    СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.Торг12);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
	
	//{Лео Катанович
	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
 		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
		 
		 СтруктураПараметров.Вставить("GLNПоставщика"			, "4607932679999");
	  Иначе
         СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);

	КонецЕсли;   
    //	Лео Катанович}
	
	Если ТипЗнч(ВыборкаДокумент.Сделка.ДокументОснование) = Тип("ДокументСсылка.абс_СообщениеEDI") Тогда 
		 СтруктураПараметров.Вставить("НастройкаОбмена"		, ВыборкаДокумент.Сделка.ДокументОснование.НастройкаОбмена);
	КонецЕсли;		
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерДокументаEDIЗаказа);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаДокументаEDI);
    СтруктураПараметров.Вставить("Ответственный"		    , ПараметрыСеанса.ТекущийПользователь);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры

Процедура ВыгрузитьКорректировочныйСчетФактуру_ON_KORSFAKT(ДокументСсылка, ЕстьОшибки) Экспорт
	//проверка наличия с/ф
    СписокВидовСчетовФактур = Новый СписокЗначений;
	СписокВидовСчетовФактур.Добавить(Перечисления.ВидСчетаФактурыВыставленного.Корректировочный);
	СписокВидовСчетовФактур.Добавить(Перечисления.ВидСчетаФактурыВыставленного.НаРеализацию);

	ОтборСчетовФактур = Новый Структура();
	ОтборСчетовФактур.Вставить("ВидСчетаФактуры", СписокВидовСчетовФактур);
	ОтборСчетовФактур.Вставить("ПометкаУдаления", Ложь);

   ВыборкаДокумент = (УчетНДС.НайтиПодчиненныйСчетФактуру(ДокументСсылка, "СчетФактураВыданный", ОтборСчетовФактур));
	
	Если НЕ ЗначениеЗаполнено(ВыборкаДокумент) Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	КонецЕсли;
	
	
	//  Заказ покупателя
	Запрос = новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	               |	Продажи.ЗаказПокупателя,
	               |	Продажи.ДокументПродажи
	               |ИЗ
	               |	РегистрНакопления.Продажи КАК Продажи
	               |ГДЕ
	               |	Продажи.Регистратор = &ДокументСсылка";
	Запрос.УстановитьПараметр("ДокументСсылка", ДокументСсылка);
	Результат = Запрос.Выполнить().Выбрать();
    ЗаказПокупателя	= Неопределено;
	ДокументПродажи = Неопределено;
 
	Пока Результат.Следующий() Цикл 
		 ЗаказПокупателя =   Результат.ЗаказПокупателя;
		 ДокументПродажи =   Результат.ДокументПродажи;
	КонецЦикла;	
	//_________________________________________________
	ДанныеДляФормированияЭД = Неопределено;
	УчетнаяПолитика = Неопределено;

//	УчетНДС.СобратьДанныеДляПечатиСчетФактурыВыданного(ВыборкаДокумент.Ссылка, ДанныеДляФормированияЭД, УчетнаяПолитика);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	Корректировочный = ВыборкаДокумент.Ссылка.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыВыставленного.Корректировочный;
	Если НЕ Корректировочный Тогда
         ДокументПродажи = Документссылка.ДокументРеализации;
		 ЗаказПокупателя = Документссылка.ДокументРеализации.Сделка;
	КонецЕсли;	
	Для Каждого СтрДокОснования Из ВыборкаДокумент.Ссылка.ДокументыОснования Цикл
		// Получить экземпляр документа на печать
		
		Если НЕ ЗначениеЗаполнено(СтрДокОснования.ДокументОснование) Тогда
			Продолжить;
		КонецЕсли;
		
	    мВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	    ЭкземплярДанныхДляПечати = Неопределено;

		Если Корректировочный Тогда
			ЭкземплярДанныхДляПечати = СобратьДанныеДляПечатиКорректировочногоСчетаФактуры(СтрДокОснования.ДокументОснование, ВыборкаДокумент.Ссылка);
		Иначе
			ЭкземплярДанныхДляПечати = СобратьДанныеДляПечатиИсправленияСчетаФактуры(СтрДокОснования.ДокументОснование, ВыборкаДокумент.Ссылка);
		КонецЕсли;
		
		
		// Заполнение данных для печати
		Если ДанныеДляФормированияЭД = Неопределено Тогда
			ДанныеДляФормированияЭД = ЭкземплярДанныхДляПечати;
		Иначе
			
			Для каждого СтрДанных Из ЭкземплярДанныхДляПечати Цикл
				
				Если СтрДанных.Ключ = "ТабличнаяЧасть" Тогда
					СтараяТабЧасть = ДанныеДляФормированияЭД.ТабличнаяЧасть;
					НоваяТабЧасть  = СтрДанных.Значение;
					
					Для каждого НоваяСтрокаТабЧасти Из НоваяТабЧасть Цикл
						СтрокаТабЧасти = СтараяТабЧасть.Добавить();
						Для каждого ТекКол Из НоваяТабЧасть.Колонки Цикл
							Если СтараяТабЧасть.Колонки.Найти(ТекКол.Имя) <> Неопределено Тогда
								СтрокаТабЧасти[ТекКол.Имя] = НоваяСтрокаТабЧасти[ТекКол.Имя];
							КонецЕсли;
						КонецЦикла;
					КонецЦикла;
					
				ИначеЕсли НЕ ДанныеДляФормированияЭД.Свойство(СтрДанных.Ключ) Тогда
					// Если данный параметр для печати шапки документа еще не  определен - то определяем его
					ДанныеДляФормированияЭД.Вставить(СтрДанных.Ключ, СтрДанных.Значение);
					
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЦикла;	
	
	
	Если Корректировочный И ДанныеДляФормированияЭД <> Неопределено Тогда
		
		КолонкиГруппировок = ""
		+"Номенклатура,"
		+"НаименованиеТовара,"
		+"Серия,"
		+"Характеристика,"
		+"НаименованиеЕдиницыИзмерения,"
		+"ЕдиницаИзмеренияКод,"
		+"ЦенаДоИзменения,"	
		+"ЦенаПослеИзменения,"
		+"СтавкаНДС,"
		+"СтавкаНДСДоИзменения,"
		+"СтавкаНДСПослеИзменения,"
		+"НомерСтроки,"
		+"Штрихкод";
		
		КолонкиСуммирования = ""
		+"СуммаНДСДоИзменения,"
		+"СуммаНДСПослеИзменения,"
		+"СтоимостьСНДСДоИзменения,"
		+"СтоимостьСНДСПослеИзменения,"
		+"РазницаБезНДСУвеличение,"
		+"РазницаБезНДСУменьшение,"
		+"РазницаНДСУвеличение,"
		+"РазницаНДСУменьшение,"
		+"РазницаСНДСУвеличение,"
		+"РазницаСНДСУменьшение,"
		+"СтоимостьБезНДСДоИзменения,"
		+"СтоимостьБезНДСПослеИзменения,"
		+"КоличествоДоИзменения,"
		+"КоличествоПослеИзменения";
		
		ДанныеДляФормированияЭД.ТабличнаяЧасть.Свернуть(КолонкиГруппировок, КолонкиСуммирования);
		
	КонецЕсли; 
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//ТаблицаТоваров = ДанныеДляФормированияЭД.ТабличнаяЧасть.ВыгрузитьКолонку("Номенклатура");
	ТЗ_ТаблицаТоваров =  ДанныеДляФормированияЭД.ТабличнаяЧасть.Скопировать();
    ТЗ_ТаблицаТоваров.Свернуть("Номенклатура");
	ТаблицаТоваров = ТЗ_ТаблицаТоваров.ВыгрузитьКолонку("Номенклатура");
	
	МассивИсключений = Новый Массив;
	МассивИсключений.Добавить("*");
	Запрос = новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя,
	               |	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	               |ИЗ
	               |	РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(
	               |			&Дата,
	               |			Номенклатура В ИЕРАРХИИ (&Номенклатура)
	               |				И Контрагент = &Контрагент
	               |				И Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя)) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	               |ГДЕ
	               |	НЕ абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства В (&МассивИсключений)";
	
 
    Запрос.УстановитьПараметр("Дата", ВыборкаДокумент.Дата);
  	Запрос.УстановитьПараметр("Номенклатура", ТаблицаТоваров);
	Запрос.УстановитьПараметр("МассивИсключений", МассивИсключений);
	Запрос.УстановитьПараметр("Контрагент", ДанныеДляФормированияЭД.Покупатель);

	ТаблицаДопСведений = Запрос.Выполнить().Выгрузить();

 
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////		
    ДатаСФ 	= ВыборкаДокумент.Дата;
    НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(ВыборкаДокумент.Ссылка);
	
	Если ДанныеДляФормированияЭД.Покупатель = Справочники.Контрагенты.НайтиПоКоду("К00000049") Тогда //Ашан
		ОрганизацияGLN = "4607932679999";
	Иначе
		ОрганизацияGLN = СокрЛП(ДанныеДляФормированияЭД.Организация.абс_GLN);
	КонецЕсли;	
	Префиксфайла = "ON_KORSFAKT_2BK-";
	Если Корректировочный Тогда
		Префиксфайла = "ON_KORSFAKT_2BK-";
	Иначе
		Префиксфайла = "ON_SFAKT_2BK-";
	КонецЕсли;	
	ИдФайл = Префиксфайла + ДанныеДляФормированияЭД.Покупатель.ИНН + "-" + ДанныеДляФормированияЭД.Покупатель.ОГРН + "_2BK-" + ДанныеДляФормированияЭД.Организация.ИНН + "-" + ДанныеДляФормированияЭД.Организация.ОГРН  + "_" + Формат(ДатаСФ,"ДФ=ггггММдд");	

	ИдФайл = ИдФайл + "_" + Строка(ВыборкаДокумент.УникальныйИдентификатор()) ;
	ИдФайл = СформироватьИмяФайлаEDI(ИдФайл);
	ИмяФайла = ИдФайл + ".xml";
	 
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку( "WINDOWS-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Электронный Курьер 1.0" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.02" );
		 
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
		
		  ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр","2BK-" + ДанныеДляФормированияЭД.Организация.ИНН + "-" + ДанныеДляФормированияЭД.Организация.ОГРН);
		  ЗаписьXML.ЗаписатьАтрибут( "ИдПок", "2BK-" +  ДанныеДляФормированияЭД.Покупатель.ИНН + "-" + ДанныеДляФормированияЭД.Покупатель.ОГРН);

			ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
				ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "ООО " + Символ(34) + "КОРУС Консалтинг СНГ" + Символ(34));
		 		ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", "7801392271");
		 		ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", "2BK");	
			ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
		    Если Корректировочный Тогда
		         КНД = "1115108";
			Иначе	 
			     КНД = "1115101";
			КонецЕсли;
			ЗаписьXML.ЗаписатьАтрибут( "КНД", КНД);
			Если Корректировочный Тогда
			     ЗаписьXML.ЗаписатьНачалоЭлемента("СвКСчФ");//+СвСчФакт 
			         ЗаписьXML.ЗаписатьАтрибут("НомерКСчФ", НомерСФ);
					 ЗаписьXML.ЗаписатьАтрибут("ДатаКСчФ",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") );  
			Иначе
				 ЗаписьXML.ЗаписатьНачалоЭлемента("СвСчФакт");//+СвСчФакт 
			         ЗаписьXML.ЗаписатьАтрибут("НомерСчФ", ВыборкаДокумент.НомерИсходногоДокумента);
					 ЗаписьXML.ЗаписатьАтрибут("ДатаСчФ",Формат(ВыборкаДокумент.ДатаИсходногоДокумента,"ДФ=дд.ММ.гггг") );  
			 КонецЕсли;	 
					 
					 ЗаписьXML.ЗаписатьАтрибут("КодОКВ", ДанныеДляФормированияЭД.Валюта.Код);
					 
					 Если Корректировочный Тогда
						 
						 ЗаписьXML.ЗаписатьНачалоЭлемента("СчФ");//+СчФ 
						 ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ",ОбщегоНазначения.ПолучитьНомерНаПечать(ВыборкаДокумент.ИсправляемыйСчетФактура));
						 ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ВыборкаДокумент.ИсправляемыйСчетФактура.Дата,"ДФ=дд.ММ.гггг") );  
						 ЗаписьXML.ЗаписатьКонецЭлемента(); //-СчФ
					 Иначе
					 Если ЗначениеЗаполнено(ВыборкаДокумент.НомерИсправления) Тогда
						 ЗаписьXML.ЗаписатьНачалоЭлемента("ИспрСчФ");//+ИспрСчФ
						 ЗаписьXML.ЗаписатьАтрибут( "НомИспрСчФ",  Строка(ВыборкаДокумент.НомерИсправления));
						 ЗаписьXML.ЗаписатьАтрибут( "ДатаИспрСчФ" ,Формат(ДатаСФ,"ДФ=дд.ММ.гггг")); 
						 ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИспрСчФ
					 КонецЕсли;
					 КонецЕсли;
					 Если Корректировочный Тогда
						 Если ЗначениеЗаполнено(ВыборкаДокумент.НомерИсправляемогоКорректировочногоДокумента) Тогда
							 ЗаписьXML.ЗаписатьНачалоЭлемента("ИспрКСчФ");//+ИспрКСчФ
							 ЗаписьXML.ЗаписатьАтрибут( "НомИспрКСчФ",  Строка(ВыборкаДокумент.НомерИсправляемогоКорректировочногоДокумента));
							 ЗаписьXML.ЗаписатьАтрибут( "ДатаИспрКСчФ" ,Формат(ВыборкаДокумент.ДатаИсправляемогоКорректировочногоДокумента,"ДФ=дд.ММ.гггг")); 
							 ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИспрКСчФ
						 КонецЕсли;	
					 КонецЕсли;	 
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛ");//+СвЮЛ
							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ДанныеДляФормированияЭД.Организация.НаименованиеСокращенное); 
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ДанныеДляФормированияЭД.Организация.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ДанныеДляФормированияЭД.Организация.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ДанныеДляФормированияЭД.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод
				
 				
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛ");//+СвЮЛ
							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ДанныеДляФормированияЭД.Покупатель.НаименованиеПолное);  
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ДанныеДляФормированияЭД.Покупатель.ИНН);  
			 				ЗаписьXML.ЗаписатьАтрибут( "КПП", ДанныеДляФормированияЭД.Покупатель.КПП);
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв	
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ДанныеДляФормированияЭД.Покупатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
				
				/////////////////////////////////
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПол");//+ИнфПол
						//Если Корректировочный Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "отправитель");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", ОрганизацияGLN);
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "получатель");
							ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ДанныеДляФормированияЭД.Покупатель.абс_GLN));
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
							
							Если ЗначениеЗаполнено(ДокументСсылка.Грузоотправитель.абс_GLN) Тогда
								ГрузоотправительGLN = ДокументСсылка.Грузоотправитель.абс_GLN;
							Иначе 
								ГрузоотправительGLN = ОрганизацияGLN;
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузоотправитель");
							ЗаписьXML.ЗаписатьАтрибут( "Значен",ГрузоотправительGLN);
							ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
							
							
							Если ЗначениеЗаполнено(ДокументСсылка.Грузополучатель.абс_GLN) Тогда
								ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
								ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузополучатель");
								ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ДокументСсылка.Грузополучатель.абс_GLN));
								ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
							КонецЕсли;
						//КонецЕсли;		
			             ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
									ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_поставщика");
									ЗаписьXML.ЗаписатьАтрибут( "Значен","05360005");
					     ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				
						 ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
									ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_договора");
								    ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ДокументСсылка.ДоговорКонтрагента.Номер));
						 ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
                         Если Корректировочный Тогда
								 ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
											ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_договора");
											ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ДокументСсылка.ДоговорКонтрагента.Дата,"ДФ=дд.ММ.гггг")); 
								 ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
						Иначе
								 ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
											ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_договора");
											ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ДокументСсылка.ДоговорКонтрагента.Дата,"ДФ=ггггММдд")); 
								 ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

                        КонецЕсли;								 
		 		ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПол

			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвКСчФ
			//--------------------------------------------------------------------------------------------------------
			Если Корректировочный Тогда
				
			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблКСчФ");//+ТаблКСчФ
			
				сч = 1;
				Для каждого ВыборкаСтрока из ДанныеДляФормированияЭД.ТабличнаяЧасть Цикл
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.НаименованиеТовара);
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_ТовДо","796");
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_ТовПосле","796");
						 
						ЗаписьXML.ЗаписатьАтрибут( "КолТовДо",    Формат(ВыборкаСтрока.КоличествоДоИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "КолТовПосле", Формат(ВыборкаСтрока.КоличествопослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
 						
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТовДо",    Формат(ВыборкаСтрока.ЦенаДоИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТовПосле", Формат(ВыборкаСтрока.ЦенаПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));

						ЗаписьXML.ЗаписатьАтрибут( "НалСтДо",    Строка(УчетНДС.ПолучитьСтавкуНДС(ВыборкаСтрока.СтавкаНДСДоИзменения)) + "%") ;
                        ЗаписьXML.ЗаписатьАтрибут( "НалСтПосле", строка(УчетНДС.ПолучитьСтавкуНДС(ВыборкаСтрока.СтавкаНДСПослеИзменения)) + "%") ;
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СтТовБезНДС");
						          Если ВыборкаСтрока.РазницаБезНДСУменьшение > 0 Тогда
						               ЗаписьXML.ЗаписатьАтрибут("СтоимУм", Формат(ВыборкаСтрока.РазницаБезНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
								  Иначе
								       ЗаписьXML.ЗаписатьАтрибут("СтоимУвел", Формат(ВыборкаСтрока.РазницаБезНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
								  КонецЕсли;	   
								  ЗаписьXML.ЗаписатьАтрибут("СтоимДоИзм", Формат(ВыборкаСтрока.СтоимостьБезНДСДоИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
								  ЗаписьXML.ЗаписатьАтрибут("СтоимПослеИзм", Формат(ВыборкаСтрока.СтоимостьБезНДСПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));

					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СтТовБезНДС
						
						 ЗаписьXML.ЗаписатьНачалоЭлемента("АкцизДо"); //+АкцизДо
						           ЗаписьXML.ЗаписатьНачалоЭлемента("БезАкциз"); //+БезАкциз
						           ЗаписьXML.ЗаписатьТекст("без акциза");
								   ЗаписьXML.ЗаписатьКонецЭлемента();// -БезАкциз
						 ЗаписьXML.ЗаписатьКонецЭлемента();//АкцизДо
						 
						 ЗаписьXML.ЗаписатьНачалоЭлемента("АкцизПосле"); //+АкцизПосле
						           ЗаписьXML.ЗаписатьНачалоЭлемента("БезАкциз"); //+БезАкциз
						           ЗаписьXML.ЗаписатьТекст("без акциза");
								   ЗаписьXML.ЗаписатьКонецЭлемента();// -БезАкциз
						 ЗаписьXML.ЗаписатьКонецЭлемента();//АкцизПосле
						 
						 ЗаписьXML.ЗаписатьНачалоЭлемента("АкцизРазн");//+АкцизРазн
  						           ЗаписьXML.ЗаписатьНачалоЭлемента("СумУвел"); //+ СумУвел
								   ЗаписьXML.ЗаписатьТекст("0");
								   ЗаписьXML.ЗаписатьКонецЭлемента(); //- СумУвел
						 ЗаписьXML.ЗаписатьКонецЭлемента();//-АкцизРазн

						  ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалДо");//+СумНалДо
								   ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); //+СумНДС
								   ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаСтрока.СуммаНДСДоИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						           ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС		
						 ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНалДо

						 ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалПосле");//+СумНалПосле
								   ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); //+СумНДС
								   ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаСтрока.СуммаНДСПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						           ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС		   
						 ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНалПосле
						 
						 ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалРазн");//+СумНалРазн
						 Если ВыборкаСтрока.РазницаНДСУменьшение > 0 Тогда
							  ЗаписьXML.ЗаписатьНачалоЭлемента("СумУм"); //+СумУм
									 ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаСтрока.РазницаНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СумУм		 		 
						 Иначе
							  ЗаписьXML.ЗаписатьНачалоЭлемента("СумУвел"); //+СумУвел
							        ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаСтрока.РазницаНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СумУвел			 
							КонецЕсли;	   
						 ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНалРазн
						 
						 ЗаписьXML.ЗаписатьНачалоЭлемента("СтТовУчНал");//+СтТовУчНал
								   ЗаписьXML.ЗаписатьАтрибут("СтоимДоИзм", Формат(ВыборкаСтрока.СтоимостьСНДСДоИзменения,"ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=")); 
								   ЗаписьXML.ЗаписатьАтрибут("СтоимПослеИзм", Формат(ВыборкаСтрока.СтоимостьСНДСПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
								 Если ВыборкаСтрока.РазницаСНДСУменьшение > 0 Тогда
									 ЗаписьXML.ЗаписатьАтрибут("СтоимУм", Формат(ВыборкаСтрока.РазницаСНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
								 Иначе
									 ЗаписьXML.ЗаписатьАтрибут("СтоимУвел", Формат(ВыборкаСтрока.РазницаСНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
								 КонецЕсли;	  
						 ЗаписьXML.ЗаписатьКонецЭлемента();//-СтТовУчНал
						 
						 
						 //////////////
		                 ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
						            ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
			 			            ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ЗаказПокупателя.НомерПоДаннымПокупателя));
			 		     ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_накладной");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ДокументПродажи.Номер));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						
						СтрокаДопСведений = ТаблицаДопСведений.Найти(ВыборкаСтрока.Номенклатура,"Номенклатура");
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", ?(СтрокаДопСведений = Неопределено,"",СтрокаДопСведений.АртикулПокупателя));
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр
					

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф",  "позиция_заказа");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", Строка(ВыборкаСтрока.НомерСтроки));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "штрихкод");
							ЗаписьXML.ЗаписатьАтрибут( "Значен",  ВыборкаСтрока.Штрихкод);
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_акта");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", ?(ЗначениеЗаполнено(ДокументПродажи.абс_НомерУведомленияОПриемке),ДокументПродажи.абс_НомерУведомленияОПриемке,"б/н"));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
				КонецЦикла;
				
				// Итоги документа
					ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоУвел"); //+ ВсегоУвел
						ЗаписьXML.ЗаписатьАтрибут("СтТовУчНалВсего", Формат(ВыборкаДокумент.СуммаУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));

						ЗаписьXML.ЗаписатьАтрибут("СтТовБезНДСВсего", Формат(ВыборкаДокумент.СуммаУвеличение - ВыборкаДокумент.СуммаНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));


						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал"); // + СумНал
						   ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); // + СумНДС
						         ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаДокумент.СуммаНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
	                        ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНал
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоУвел
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоУм"); //+ ВсегоУм
						ЗаписьXML.ЗаписатьАтрибут("СтТовУчНалВсего", Формат(ВыборкаДокумент.СуммаУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут("СтТовБезНДСВсего", Формат(ВыборкаДокумент.СуммаУменьшение - ВыборкаДокумент.СуммаНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал"); // + СумНал
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); // + СумНДС
						          ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаДокумент.СуммаНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
                        ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНал

						ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоУм	
					
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблКСчФ
			Иначе
				ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблСчФакт");//+ТаблСчФакт
                сч = 1;
				Для Каждого ВыборкаСтрока из ДанныеДляФормированияЭД.ТабличнаяЧасть Цикл

					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.НаименованиеПолное);	
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов","796");
					    ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов",  Формат(ВыборкаСтрока.Цена, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						Если ВыборкаСтрока.СуммаВключаетНДС Тогда
						     ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат(ВыборкаСтрока.Сумма - ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						 Иначе
							 ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат(ВыборкаСтрока.Сумма, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						КонецЕсли;	 
						ЗаписьXML.ЗаписатьАтрибут( "НалСт", "" + Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0;" ) );
						Если ВыборкаСтрока.СуммаВключаетНДС Тогда
						    ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат(ВыборкаСтрока.Сумма, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						Иначе	
							ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат(ВыборкаСтрока.Сумма + ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						КонецЕсли;
						//ИнфПолСтр = "номер_заказа:"+СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа) +";номер_накладной:"+СокрЛП(ДокументОтгрузки.Номер) +";код_материала:"+ВыборкаСтрока.АртикулПокупателя +";позиция_заказа:"+ Строка(сч) +";штрихкод:"+СокрЛП(ВыборкаСтрока.Штрихкод)+";номер_акта:"+ ДокументОтгрузки.абс_НомерУведомленияОПриемке;
						//ЗаписьXML.ЗаписатьАтрибут("ИнфПолСтр", ИнфПолСтр);
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Акциз");//+Акциз
							ЗаписатьXML(ЗаписьXML,"без акциза","БезАкциз");
							//ЗаписьXML.ЗаписатьАтрибут( "БезАкциз","без акциза" );
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Акциз

						//ЗаписьXML.ЗаписатьНачалоЭлемента("НалСт"); //+НалСт
						//	ЗаписьXML.ЗаписатьАтрибут( "НалСтВел", Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0; " ));
						//	ЗаписьXML.ЗаписатьАтрибут( "НалСтТип", "процент");
						//ЗаписьXML.ЗаписатьКонецЭлемента(); //-НалСт

						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал");//+СумНал;
							ЗаписатьXML(ЗаписьXML,Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНДС");
							//ЗаписьXML.ЗаписатьАтрибут( "СумНДС", Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНал
					//	
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ДокументПродажи.Сделка.абс_НомерЗаказаEDI));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_накладной");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ДокументПродажи.Номер));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр
						 //////////////
						 СтрокаДопСведений = ТаблицаДопСведений.Найти(ВыборкаСтрока.Номенклатура,"Номенклатура");
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала");
							ЗаписьXML.ЗаписатьАтрибут( "Значен",?(СтрокаДопСведений = Неопределено,"",СтрокаДопСведений.АртикулПокупателя));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф",  "позиция_заказа");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", Строка(сч));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "штрихкод");
							ЗаписьXML.ЗаписатьАтрибут( "Значен",  СокрЛП(ВыборкаСтрока.Штрихкод));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

					//Если ЗначениеЗаполнено(ДокументПродажи.Сделка.ДокументОснование) Тогда
					//	 ДатаЗаказа = ДокументПродажи.Сделка.ДокументОснование.ДатаДокументаEDI;
					// Иначе
					//	  ДатаЗаказа = ДокументПродажи.Сделка.Дата;
					//КонецЕсли;	 

					//	ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
					//		ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_заказа");
					//		ЗаписьXML.ЗаписатьАтрибут( "Значен", Формат(ДатаЗаказа,"ДФ=гггг-ММ-дд"));
					//ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_акта");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", "б/н");
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						
					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
				КонецЦикла;
					СуммаНДС = ДанныеДляФормированияЭД.ТабличнаяЧасть.Итог("СуммаНДС");
					СуммаБезНДС = ДанныеДляФормированияЭД.ТабличнаяЧасть.Итог("Сумма");
	             	ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоОпл");//+ВсегоОпл
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", Формат(СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
				 		ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",Формат(ДанныеДляФормированияЭД.Сумма, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
							
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
							ЗаписатьXML(ЗаписьXML,Формат(СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНДС"); 
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего

					ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоОпл
 				ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблСчФакт

			КонецЕсли;	
		   Руководители = ОбщегоНазначения.ОтветственныеЛица(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата,);

			//ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
			//	ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
			//		ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
			// 		ЗаписьXML.ЗаписатьАтрибут( "Должн", Руководители.РуководительДолжность.Наименование);
			//	
			//		ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
			//			ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Руководители.РуководительФИО.Фамилия);  
			// 			ЗаписьXML.ЗаписатьАтрибут( "Имя", Руководители.РуководительФИО.Имя); 
			//			ЗаписьXML.ЗаписатьАтрибут( "Отчество", Руководители.РуководительФИО.Отчество); 
			//		ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			//	
			//	ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			//ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
				ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
            	ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
					ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", "7714281617");
					
					СтруктураПодписант = ОтветственныйПоЭДО(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата);
					
			 		ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
					    ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 

					ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
				
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант

			
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.КорректировочныйСчетФактура);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ДанныеДляФормированияЭД.Покупатель.абс_GLN);
	СтруктураПараметров.Вставить("GLNПоставщика"			, ОрганизацияGLN);
	СтруктураПараметров.Вставить("НастройкаОбмена"		    , Справочники.абс_НастройкиEDIОбмена.КОРУС);  //
	СтруктураПараметров.Вставить("ДокументОснование"		, ВыборкаДокумент.ДокументОснование);
    
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ?(ЗначениеЗаполнено(ЗаказПокупателя.ДокументОснование),ЗаказПокупателя.ДокументОснование.НомерДокументаEDIЗаказа,""));
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ?(ЗначениеЗаполнено(ЗаказПокупателя.ДокументОснование),ЗаказПокупателя.ДокументОснование.ДатаДокументаEDI,""));
    СтруктураПараметров.Вставить("Ответственный"		    , ПараметрыСеанса.ТекущийПользователь);
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры

 
Процедура _ВыгрузитьПД_Контур(ДокументОтгрузки, ЕстьОшибки) Экспорт
	
	//проверка наличия с/ф
	
	Если ДокументОтгрузки.ДоговорКонтрагента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером Тогда
		ДатаСФ 	= ДокументОтгрузки.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(ДокументОтгрузки.Ссылка);

	Иначе	
		
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	СчетФактураВыданный.Номер,
		|	СчетФактураВыданный.Дата,
		|	СчетФактураВыданный.Ссылка
		|ИЗ
		|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
		|ГДЕ
		|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
		
		Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
		Результат=Запрос.Выполнить();
		Если Результат.Пустой() Тогда
			Сообщение=Новый СообщениеПользователю;
			Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
			Сообщение.Сообщить();
			ЕстьОшибки = Истина;
			Возврат;
		Иначе
			Выборка 	= Результат.Выбрать();
			Выборка.Следующий();
			ДатаСФ 	= Выборка.Дата;
			НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
		КонецЕсли;
	КонецЕсли;
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугУслуги.Номенклатура КАК Номенклатура,
	//|	РеализацияТоваровУслугУслуги.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	//|	ВЫБОР
	//|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	//|			ТОГДА ВЫБОР
	//|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	//|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	//|					ИНАЧЕ 0
	//|				КОНЕЦ
	//|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	РеализацияТоваровУслугУслуги.Цена,
	|	СУММА(РеализацияТоваровУслугУслуги.Количество) КАК Количество,
	|	РеализацияТоваровУслугУслуги.Ссылка КАК Ссылка,
	//|	РеализацияТоваровУслугУслуги.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	СУММА(ВЫБОР
	|			КОГДА РеализацияТоваровУслугУслуги.Ссылка.СуммаВключаетНДС = ИСТИНА
	|				ТОГДА РеализацияТоваровУслугУслуги.Сумма - РеализацияТоваровУслугУслуги.СуммаНДС
	|			ИНАЧЕ РеализацияТоваровУслугУслуги.Сумма
	|		КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(РеализацияТоваровУслугУслуги.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугУслуги.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугУслуги.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугУслуги.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугУслуги.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугУслуги.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугУслуги.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС,
	|	РеализацияТоваровУслугУслуги.НомерСтроки,
	|	ВложенныйЗапрос.ЗначениеСвойства КАК НаименованиеПокупателя
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Услуги КАК РеализацияТоваровУслугУслуги
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент КАК Контрагент,
	|			абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура КАК Номенклатура,
	|			абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство КАК Свойство,
	|			абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК ЗначениеСвойства
	|		ИЗ
	|			РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ГДЕ
	|			абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НаименованиеНоменклатурыПокупателя)) КАК ВложенныйЗапрос
	|		ПО РеализацияТоваровУслугУслуги.Ссылка.Контрагент = ВложенныйЗапрос.Контрагент
	|			И РеализацияТоваровУслугУслуги.Номенклатура = ВложенныйЗапрос.Номенклатура
	|ГДЕ
	|	РеализацияТоваровУслугУслуги.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугУслуги.Номенклатура,
	//|	РеализацияТоваровУслугУслуги.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугУслуги.Ссылка,
	//|	РеализацияТоваровУслугУслуги.Качество,
	//|	ВЫБОР
	//|		КОГДА РеализацияТоваровУслугУслуги.Ссылка.СуммаВключаетНДС = ИСТИНА
	//|			ТОГДА ВЫБОР
	//|					КОГДА РеализацияТоваровУслугУслуги.Количество > 0
	//|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	//|					ИНАЧЕ 0
	//|				КОНЕЦ
	//|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	//|	КОНЕЦ,
	|		РеализацияТоваровУслугУслуги.Цена,

	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугУслуги.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугУслуги.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугУслуги.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугУслуги.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугУслуги.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугУслуги.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	РеализацияТоваровУслугУслуги.НомерСтроки,
	|	ВложенныйЗапрос.ЗначениеСвойства
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	//|	ЕдиницаИзмерения,
	|	Ссылка
	//|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
	|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
	|	Накладная.Ссылка.Сделка.НомерПоДаннымПокупателя КАК НомерПоДаннымПокупателя,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
	|	Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
	|	Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
	|	Накладная.Ссылка.ВалютаДокумента КАК Валюта,
	|	Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
	|	Накладная.Ссылка.Организация КАК Организация,
	|	Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """") КАК НомерМагазина,
	|	Накладная.Ссылка.Грузополучатель КАК Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """") КАК КодПоставщика,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата КАК ДатаТТН,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор) КАК Водитель,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность),
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки) КАК ДатаИсполнения,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI КАК ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ КАК ДатаПоставки
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НомерМагазина)) КАК СвойстваНомераМагазинов
	|		ПО Накладная.Ссылка.Грузополучатель = СвойстваНомераМагазинов.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодПоставщика)) КАК СвойствоКодПоставщика
	|		ПО Накладная.Ссылка.Контрагент = СвойствоКодПоставщика.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Ссылка.Номер,
	|	Накладная.Ссылка.Дата,
	|	Накладная.Ссылка.Сделка.Номер,
	|	Накладная.Ссылка.Сделка.Дата,
	|	Накладная.Ссылка.Организация.абс_GLN,
	|	Накладная.Ссылка.Контрагент.абс_GLN,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
	|	Накладная.Ссылка.Организация.ИНН,
	|	Накладная.Ссылка.Организация.КПП,
	|	Накладная.Ссылка.Организация.Лео_GUID,
	|	Накладная.Ссылка.Контрагент.Лео_GUID,
	|	Накладная.Ссылка.ВалютаДокумента,
	|	Накладная.Ссылка.ВалютаДокумента.Код,
	|	Накладная.Ссылка.Организация,
	|	Накладная.Ссылка.Грузоотправитель,
	|	Накладная.Ссылка.Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """"),
	|	Накладная.Ссылка.Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """"),
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ,
	|	Накладная.Ссылка.Сделка.НомерПоДаннымПокупателя,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)),
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки),
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	//|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СуммаНДС,
	|	Накладная.СтавкаНДС,
	//|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование КАК ЕдиницаИзмерения,
	|	Накладная.Цена,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя,
	|	Накладная.Номенклатура.Артикул КАК Артикул,
	|	Накладная.НомерСтроки КАК НомерСтроки,
	//|	Накладная.Количество * Накладная.ЕдиницаИзмерения.Коэффициент / Накладная.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент * Накладная.Номенклатура.ЕдиницаХраненияОстатков.Вес КАК МассаНетто,
	|	Накладная.НаименованиеПокупателя
	|ИЗ
	|	Накладная КАК Накладная
	//|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	//|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	//|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	//|			И Накладная.Качество = Штрихкоды.Качество
	//|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	//|			И Накладная.СерияНоменклатуры = Штрихкоды.СерияНоменклатуры
	//|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(, ) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СтавкаНДС,
	//|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование,
	|	Накладная.Цена,
	|	Накладная.СуммаНДС,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства,
	|	Накладная.Номенклатура.Артикул,
	|	Накладная.НомерСтроки,
	//|	Накладная.Количество * Накладная.ЕдиницаИзмерения.Коэффициент / Накладная.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент * Накладная.Номенклатура.ЕдиницаХраненияОстатков.Вес,
	|	Накладная.НаименованиеПокупателя
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////		

	Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
		 Идентификатор = ВыборкаДокумент.ОператорEDI.Идентификатор;
	 Иначе
		 Сообщить("Не заполнен оператор EDI");
		 Возврат;
	КонецЕсли;	
	
    НомерОрганизацииВсистеме = ВыборкаДокумент.Организация.ИНН + "-" + "2012052807212505941080000000000";
	
	Если ЗначениеЗаполнено(ВыборкаДокумент.Контрагент.Лео_GUID) Тогда
		НомерКонтрагентаВсистеме = ВыборкаДокумент.Контрагент.ИНН + "-" + СОКРЛП(ВыборкаДокумент.Контрагент.Лео_GUID);
	Иначе
		НомерКонтрагентаВсистеме = ВыборкаДокумент.Контрагент.ИНН + "-" + СОКРЛП(абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ВыборкаДокумент.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Идентификатор участника ЭДО")));
    КонецЕсли;	
	
	////////////////
		
	ИдФайл = "ON_NSCHFDOPPR_" + Идентификатор + "-" + НомерКонтрагентаВсистеме + "_" + Идентификатор + "-" + НомерОрганизацииВсистеме + "_" + Формат(ДатаСФ,"ДФ=ггггММдд") + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор()) ;

    ИмяФайла = "UPD_" + ВыборкаДокумент.Номер + "_" + Формат(ВыборкаДокумент.Дата,"ДФ=ггггММдд");
	
	ИмяФайла = СформироватьИмяФайлаEDI(ИмяФайла);
	ИмяФайла = ИмяФайла + ".xml";

	////////////////////
	
	 
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку( "windows-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
	

		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.01" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Diadoc 1.0" );
		 
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
			ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр",Идентификатор + "-" + НомерОрганизацииВсистеме);
			ЗаписьXML.ЗаписатьАтрибут( "ИдПол", Идентификатор + "-" + НомерКонтрагентаВсистеме);
		   ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.ОператорEDI.Контрагент.ИНН);
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО",   Идентификатор);	
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", СтрЗаменить(ВыборкаДокумент.ОператорEDI.Наименование,"""","&quot;"));

         ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
			ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115131");
			ЗаписьXML.ЗаписатьАтрибут( "ВремИнфПр", Формат(ТекущаяДата(), "ДФ=ЧЧ.мм.сс"));
			ЗаписьXML.ЗаписатьАтрибут( "ДатаИнфПр", Формат(ТекущаяДата(),"ДФ=дд.ММ.гггг")); // Дата формирования файла обмена СФ
			ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное + ", ИНН-КПП: " + ВыборкаДокумент.Организация.ИНН + "-" + ВыборкаДокумент.Организация.КПП);
		    ЗаписьXML.ЗаписатьАтрибут( "Функция", "ДОП");
			ЗаписьXML.ЗаписатьАтрибут( "ПоФактХЖ", "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
			ЗаписьXML.ЗаписатьАтрибут( "НаимДокОпр", "Счет-фактура и документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвСчФакт");//+СвСчФакт 
				//ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", НомерСФ);
				//ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") );    
				ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", ВыборкаДокумент.Номер);
				ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг") );   
				
				ЗаписьXML.ЗаписатьАтрибут( "КодОКВ", ВыборкаДокумент.КодВалюты);
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг",ВыборкаДокумент.Организация.НаименованиеСокращенное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;

							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						СведенияОПродавце = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод
				
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОт");//+ГрузОт 
				
				Если ВыборкаДокумент.Организация.ИНН = ВыборкаДокумент.Грузоотправитель.ИНН Тогда
					ЗаписатьXML(ЗаписьXML,"он же","ОнЖе");
				Иначе

					ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОтпр");//+ГрузОтпр

					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Грузоотправитель.НаименованиеПолное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Грузоотправитель.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Грузоотправитель.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузоотправитель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
								
								ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
								ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
								СведенияОГрузоотправитель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузоотправитель,  ВыборкаДокумент.Дата);
								
								ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОтпр
							КонецЕсли;
		
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОт
				СведенияОГрузополучатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузополучатель,  ВыборкаДокумент.Дата);

				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузПолуч");//+ГрузПолуч
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
					          ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
								  Если ЗначениеЗаполнено(ВыборкаДокумент.НомерМагазина) Тогда
									   ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.НомерМагазина);
								   Иначе
									    ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.Грузополучатель.НаименованиеПолное);
								  КонецЕсли;
						           ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОГрузополучатель.ИНН );
							       ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОГрузополучатель.КПП );
							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента);
							Если СтруктураАдреса.Количество() = 0 Тогда
								Сообщить("Не указан " + Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента + " " + ВыборкаДокумент.Грузополучатель);
							    Возврат;
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;

						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
					//////////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузПолуч
				///////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПРД");//+СвПРД

				         ЗаписьXML.ЗаписатьАтрибут( "НомерПРД",  ОбщегоНазначения.ПолучитьНомерНаПечать(ДокументОтгрузки.Ссылка));
                         ЗаписьXML.ЗаписатьАтрибут( "ДатаПРД", Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
						 
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПРД

				//////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Контрагент.НаименованиеПолное);  
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Контрагент.ИНН);  
			 				ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Контрагент.КПП);
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв	
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							СведенияОПокупатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Контрагент,  ВыборкаДокумент.Дата);
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСвФХЖ1");//+ИнфПолФХЖ1
		         ЗаписьXML.ЗаписатьАтрибут( "НаимОКВ", "Российский рубль");
				 ЗаписьXML.ЗаписатьАтрибут( "КурсВал", "1");
				ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ1");//+ИнфПолФХЖ1
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					  ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "Номер заказа");
					  ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.НомерПоДаннымПокупателя));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
			    ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвСчФакт
			
			// --------------------ТАБЛИЧНАЯ ЧАСТЬ---------------------
			ЕдиницаEDI = абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ВыборкаДокумент.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Единица EDI"));


			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблСчФакт");//+ТаблСчФакт
				ВыборкаСтрока=Результат[2].Выбрать();
				сч = 1;
				Нетто_Всего =  0;

				Пока ВыборкаСтрока.Следующий() Цикл
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
					ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
					Если НЕ ЗначениеЗаполнено(ВыборкаСтрока.НаименованиеПокупателя) Тогда
						ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.Наименование);	
					Иначе
						
						ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.НаименованиеПокупателя);	
					КонецЕсли;
						ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат(ВыборкаСтрока.СуммаБезНДС + ВыборкаСтрока.СуммаНДС , "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов","796");
						КоэффициентГУДС = 1;
						
						Если ЗначениеЗаполнено(ЕдиницаEDI) Тогда
							 ЕдиницаГУДС = Справочники.ЕдиницыИзмерения.НайтиПоРеквизиту("ЕдиницаПоКлассификатору", ЕдиницаEDI, , ВыборкаСтрока.Номенклатура);
							Попытка
								КоэффициентГУДС = ЕдиницаГУДС.Коэффициент;	
							Исключение
								Сообщить("Для товара не установлена единица EDI (Артикул: " + ВыборкаСтрока.Номенклатура.Артикул + ")" );
							КонецПопытки;	
						      ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество/КоэффициентГУДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
							  ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов", Формат(ВыборкаСтрока.СуммаБезНДС/ВыборкаСтрока.Количество*КоэффициентГУДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						Иначе
						      ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						      ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов", Формат(ВыборкаСтрока.Цена, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						КонецЕсли;
						
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат(ВыборкаСтрока.СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "НалСт", "" + Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0;" ) + "%" );
						
						//Нетто_Всего =  Нетто_Всего + ВыборкаСтрока.МассаНетто;
						Нетто_Всего = 0;
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Акциз");//+Акциз
							ЗаписатьXML(ЗаписьXML,"без акциза","БезАкциз");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Акциз
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал");//+СумНал;
							ЗаписатьXML(ЗаписьXML,Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНал
						
					
						ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСведТов");//+ДопСведТов
						    //ЗаписьXML.ЗаписатьАтрибут( "НаимЕдИзм", Строка(ВыборкаСтрока.ЕдиницаИзмерения));
							ЗаписьXML.ЗаписатьАтрибут( "НаимЕдИзм", "");
							
				        ЗаписьXML.ЗаписатьКонецЭлемента();//-ДопСведТов
						
						
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "ID товара");
							АртикулПокупателя = СтрЗаменить(ВыборкаСтрока.АртикулПокупателя,"*","");
							Если НЕ ЗначениеЗаполнено(АртикулПокупателя) Тогда
								 сообщить("Не заполнен артикул покупателя в строке " + Строка(ВыборкаСтрока.НомерСтроки));
							КонецЕсли;	
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(АртикулПокупателя)));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2


					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
				КонецЦикла;
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоОпл");//+ВсегоОпл
						  ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",Формат( ДокументОтгрузки.абс_СуммаСНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
				          ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", Формат(ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
						ЗаписатьXML(ЗаписьXML,Формат(ДокументОтгрузки.абс_СуммаСНДС - ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
					ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего
					
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоОпл
 			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблСчФакт
			
		   			//-----------------------------------------------------------------------------------------------------------
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПродПер");//+СвПродПер

			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПер");//+СвПер
					ЗаписьXML.ЗаписатьАтрибут( "СодОпер", "Товары переданы");
		            ЗаписьXML.ЗаписатьАтрибут( "ДатаПер", Формат(ВыборкаДокумент.ДатаИсполнения,"ДФ=дд.ММ.гггг"));

			     ЗаписьXML.ЗаписатьНачалоЭлемента("ОснПер");//+ОснПер
				           ЗаписьXML.ЗаписатьАтрибут( "НаимОсн", ВыборкаДокумент.ДоговорКонтрагента.Наименование);
				           ЗаписьXML.ЗаписатьАтрибут( "НомОсн",  ВыборкаДокумент.ДоговорКонтрагента.Номер);
						   ЗаписьXML.ЗаписатьАтрибут( "ДатаОсн", Формат(ВыборкаДокумент.ДоговорКонтрагента.Дата,"ДФ=дд.ММ.гггг"));
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ОснПер
				 ЗаписьXML.ЗаписатьНачалоЭлемента("СвЛицПер");//+СвЛицПер
				           ЗаписьXML.ЗаписатьНачалоЭлемента("ИнЛицо");//+ИнЛицо
                               ЗаписьXML.ЗаписатьНачалоЭлемента("ФЛПер");//+ФЛПер
										 ЗаписьXML.ЗаписатьАтрибут( "ОснДоверФЛ", "Доверенность");
                                         ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
										 Если ЗначениеЗаполнено(ВыборкаДокумент.Водитель) Тогда
										      Водитель = РазложитьФИО(ВыборкаДокумент.Водитель);
										      ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Водитель.Фамилия);  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", Водитель.Имя); 
										  Иначе 
											  Сообщить("Нет сведений о водителе!");
											  ЗаписьXML.ЗаписатьАтрибут( "Фамилия", "Отсутствует");  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", "Отсутствует"); 
										  КонецЕсли;	  
										  
                                         ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО						  
						       ЗаписьXML.ЗаписатьКонецЭлемента();//-ФЛПер
						  ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнЛицо
                ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЛицПер
				//Иначе
				//сообщить("Не заполнена доверенность по транспортному маршруту!");
				//КонецЕсли;
				//ЗаписьXML.ЗаписатьНачалоЭлемента("ТранГруз");//+ТранГруз
				//	ЗаписьXML.ЗаписатьНачалоЭлемента("ТранНакл");//+ТранНакл
				//			  ЗаписьXML.ЗаписатьАтрибут( "НомТранНакл",  ВыборкаДокумент.Номер);
				//			  ЗаписьXML.ЗаписатьАтрибут( "ДатаТранНакл", Формат(ВыборкаДокумент.ДатаТТН,"ДФ=дд.ММ.гггг"));
				//	ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранНакл
				//ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранГруз
				
              ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПер
           ЗаписьXML.ЗаписатьКонецЭлемента();//+СвПродПер

			//-----------------------------------------------------------------------------------------------------------
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
				ЗаписьXML.ЗаписатьАтрибут( "ОблПолн",  "3");
				ЗаписьXML.ЗаписатьАтрибут( "Статус",   "1");
				ЗаписьXML.ЗаписатьАтрибут( "ОснПолн",  "Должностные обязанности");
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
				
					СтруктураПодписант = ОтветственныйПоЭДО(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата);
					
			 		ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
			 		ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Организация.НаименованиеСокращенное);
					
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
					    ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
			
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.Торг12);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
	СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	СтруктураПараметров.Вставить("НастройкаОбмена"		    , Справочники.абс_НастройкиEDIОбмена.НайтиПоНаименованию("Контур"));
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ДокументОтгрузки.Номер);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ДокументОтгрузки.Дата);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры


Процедура ВыгрузитьУПД(ДокументОтгрузки, ЕстьОшибки) Экспорт
	
		// c 24/09/2019 УПЛ для Х5 выгружается по новому формату
	Если ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("УТ0005949") ИЛИ     // Сладкая жизнь
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // ТАНДЕР АО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") ИЛИ     // ДИКСИ ООО
		 ДокументОтгрузки.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") Тогда   // БИЛЛА ООО
		 
		 ВыгрузитьУПД_Х5(ДокументОтгрузки, ЕстьОшибки);
		 Возврат;
	КонецЕсли;	
	
	//проверка наличия с/ф
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	Иначе
		Выборка 	= Результат.Выбрать();
		Выборка.Следующий();
		
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
	КонецЕсли;
	
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	СУММА(ВЫБОР
	|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|				ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
	|			ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
	|		КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС,
	|	РеализацияТоваровУслугТовары.НомерСтроки
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.НомерСтроки
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
	|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI КАК НомерДокументаEDIЗаказа,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
	|	Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
	|	Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
	|	Накладная.Ссылка.ВалютаДокумента КАК Валюта,
	|	Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
	|	Накладная.Ссылка.Организация КАК Организация,
	|	Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """") КАК НомерМагазина,
	|	Накладная.Ссылка.Грузополучатель КАК Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """") КАК КодПоставщика,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата КАК ДатаТТН,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор) КАК Водитель,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность),
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения КАК ДатаИсполнения,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI КАК ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ КАК ДатаПоставки
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НомерМагазина)) КАК СвойстваНомераМагазинов
	|		ПО Накладная.Ссылка.Грузополучатель = СвойстваНомераМагазинов.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодПоставщика)) КАК СвойствоКодПоставщика
	|		ПО Накладная.Ссылка.Контрагент = СвойствоКодПоставщика.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Ссылка.Номер,
	|	Накладная.Ссылка.Дата,
	|	Накладная.Ссылка.Сделка.Номер,
	|	Накладная.Ссылка.Сделка.Дата,
	|	Накладная.Ссылка.Организация.абс_GLN,
	|	Накладная.Ссылка.Контрагент.абс_GLN,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
	|	Накладная.Ссылка.Организация.ИНН,
	|	Накладная.Ссылка.Организация.КПП,
	|	Накладная.Ссылка.Организация.Лео_GUID,
	|	Накладная.Ссылка.Контрагент.Лео_GUID,
	|	Накладная.Ссылка.ВалютаДокумента,
	|	Накладная.Ссылка.ВалютаДокумента.Код,
	|	Накладная.Ссылка.Организация,
	|	Накладная.Ссылка.Грузоотправитель,
	|	Накладная.Ссылка.Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """"),
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)),
	|	Накладная.Ссылка.Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """"),
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СуммаНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование КАК ЕдиницаИзмерения,
	|	Накладная.Цена,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя,
	|	Накладная.Номенклатура.Артикул КАК Артикул,
	|	Накладная.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.СерияНоменклатуры = Штрихкоды.СерияНоменклатуры
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(, ) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование,
	|	Накладная.Цена,
	|	Накладная.СуммаНДС,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства,
	|	Накладная.Номенклатура.Артикул,
	|	Накладная.НомерСтроки
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////		
    //{Лео Катанович
	Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
		 Идентификатор = ВыборкаДокумент.ОператорEDI.Идентификатор;
	 Иначе	 
		 Идентификатор = "2IH";
	КонецЕсли;	
	
	//{Лео Катанович
	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") ИЛИ     // ДИКСИ ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("УТ0005949") Тогда   // Сладкая жизнь
		 
		 GUIDОрганизации = "C585D418-784D-449B-82B3-FF4CD2DE5051";
	 Иначе
		 GUIDОрганизации = ВыборкаДокумент.GUIDОрганизации;
	КонецЕсли;

	
	//Файл = "ON_SCHFDOPPR_" +  ВыборкаДокумент.GUIDКонтрагента + "_2IH" + ВыборкаДокумент.GUIDОрганизации  + "_" + Формат(ДатаСФ,"ДФ=ггггММдд");	
	ИдФайл = "ON_SCHFDOPPR_" +  ВыборкаДокумент.GUIDКонтрагента + "_" + Идентификатор + GUIDОрганизации  + "_" + Формат(ДатаСФ,"ДФ=ггггММдд");	
	 //Лео Катанович}

	 
	
	//Если ВыборкаДокумент.GUIDКонтрагента = "2LD61E633FD-EA80-4B7D-B8B7-9F1C4F5BAB11" Тогда 
	//УИ = Новый УникальныйИдентификатор();
	//
	//	ИдФайл = ИдФайл + "_" + Строка(УИ) ;
	//Иначе
		ИдФайл = ИдФайл + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор()) ;
	//КонецЕсли;	
	ИдФайл = СформироватьИмяФайлаEDI(ИдФайл);
	ИмяФайла = ИдФайл + ".xml";
	 
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку( "WINDOWS-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
	
		ЗаписьXML.ЗаписатьАтрибут( "xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance");

		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.01" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Exite Evolution 3.0.0" );
		 
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
		    //{Лео Катанович
		 	//ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр","2IH" + ВыборкаДокумент.GUIDОрганизации);
			ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр",Идентификатор + GUIDОрганизации);
			//Лео Катанович}
			 ИдПол  = СОКРЛП(ВыборкаДокумент.Контрагент.Лео_GUID);

			//Если ЛЕВ(ВыборкаДокумент.Контрагент.Лео_GUID,3)= Идентификатор Тогда
			//	 ИдПол  = СОКРЛП(ВыборкаДокумент.Контрагент.Лео_GUID);
			//Иначе
			//	 ИдПол  = Идентификатор + "-" + СОКРЛП(ВыборкаДокумент.Контрагент.ИНН) + "-" + СОКРЛП(ВыборкаДокумент.Контрагент.Лео_GUID);
			//КонецЕсли; 

			Если НЕ ЗначениеЗаполнено(ВыборкаДокумент.Контрагент.Лео_GUID) Тогда 
				Сообщить("Не указан GUID контрагента а системе EDI");
			КонецЕсли;	
			ЗаписьXML.ЗаписатьАтрибут( "ИдПол", ИдПол);
			//ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
			//	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "ООО &quot;Систем Групп Рус&quot");
			//ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", "7723749362");
			//ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", "2IH");	
			//ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		   ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
		   Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.ОператорEDI.Наименование);
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.ОператорEDI.Контрагент.ИНН);
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		   Иначе	  
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "Систем Групп Рус");
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   "7723749362");
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		  КонецЕсли;
         ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
			ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115125");
			Если  ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
				   ЗаписьXML.ЗаписатьАтрибут( "Функция", "СЧФ");
				Иначе
				   ЗаписьXML.ЗаписатьАтрибут( "Функция", "СЧФДОП");
			КонецЕсли;
			
		   //ЗаписьXML.ЗаписатьАтрибут( "ПоФактХЖ", "Документ об отгрузке товаров(выполнении работ), передаче имущественных прав(документ об оказании услуг)");
			ЗаписьXML.ЗаписатьАтрибут( "ПоФактХЖ", "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
            ЗаписьXML.ЗаписатьАтрибут( "НаимДокОпр", "Счет-фактура и документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
			ЗаписьXML.ЗаписатьАтрибут( "ДатаИнфПр", Формат(ТекущаяДата(),"ДФ=дд.ММ.гггг")); // Дата формирования файла обмена СФ
			ЗаписьXML.ЗаписатьАтрибут( "ВремИнфПр", Формат(ТекущаяДата(), "ДФ=ЧЧ.мм.сс"));
			ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное);
			ЗаписьXML.ЗаписатьАтрибут( "ОснДоверОргСост", "Основание доверенности");    // Добавлено 28/07/2017 для Билла ООО
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвСчФакт");//+СвСчФакт 
				ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", НомерСФ);
				ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") );              
				ЗаписьXML.ЗаписатьАтрибут( "КодОКВ", ВыборкаДокумент.КодВалюты);
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг",ВыборкаДокумент.Организация.НаименованиеСокращенное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						
						СведенияОПродавец = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
						Если ЗначениеЗаполнено(СведенияОПродавец.Телефоны) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПродавец.Телефоны,20));
						КонецЕсли;	
						//ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(СведенияОПродавец);
						//Если ЗначениеЗаполнено(ЭлПочта) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", "mail@leovit.ru");
						//КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
						////////////////////////////////////////////						
						СведенияОПродавце = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
						Если ЗначениеЗаполнено(СведенияОПродавце.НомерСчета) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПродавце.НомерСчета);
						КонецЕсли;	   
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
						Если ЗначениеЗаполнено(СведенияОПродавце.БИК) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПродавце.Банк.Наименование);
							ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПродавце.БИК);
						КонецЕсли;	 
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
                         /////////////////////////////
						
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод
				
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОт");//+ГрузОт 
				// Изменено 29.08.2018 адрес грузоотправителя должен браться не из организации, а из контрагента
				//Если ВыборкаДокумент.Организация.ИНН = ВыборкаДокумент.Грузоотправитель.ИНН Тогда
				//	ЗаписатьXML(ЗаписьXML,"он же","ОнЖе");
				//Иначе
					ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОтпр");//+ГрузОтпр
					ЗаписьXML.ЗаписатьАтрибут( "ОКПО", Строка(ВыборкаДокумент.Грузоотправитель.КодПоОКПО));     
					//ЗаписьXML.ЗаписатьАтрибут( "СтруктПодр", "");     
	                //ЗаписьXML.ЗаписатьАтрибут( "ИнфДляУчаст", "");     

					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Грузоотправитель.НаименованиеПолное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Грузоотправитель.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Грузоотправитель.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузоотправитель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						СведенияОГрузоотправитель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузоотправитель,  ВыборкаДокумент.Дата);

							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.Телефоны) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузоотправитель.Телефоны,20));
									   КонецЕсли;	
									   ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Грузоотправитель);
									  Если ЗначениеЗаполнено(ЭлПочта) Тогда
                                           ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
									 КонецЕсли;
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт

							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.НомерСчета) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузоотправитель.НомерСчета);
									  КонецЕсли;	   
									  ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
									            Если ЗначениеЗаполнено(СведенияОГрузоотправитель.БИК) Тогда
									                 ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузоотправитель.Банк.Наименование);
												     ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузоотправитель.БИК);
													 ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОГрузоотправитель.КоррСчет);
												КонецЕсли;	 
                                      ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв

					ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОтпр
		
				//КонецЕсли;	
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОт
				
				СведенияОГрузополучатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузополучатель,  ВыборкаДокумент.Дата);

				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузПолуч");//+ГрузПолуч
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
					          ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
								  Если ЗначениеЗаполнено(ВыборкаДокумент.НомерМагазина) Тогда
									   ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.НомерМагазина);
								   Иначе
									    ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.Грузополучатель.Наименование);
								  КонецЕсли;
								  //ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
								  //ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  
						           ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОГрузополучатель.ИНН );
							       ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОГрузополучатель.КПП );
							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента);
							Если СтруктураАдреса.Количество() = 0 Тогда
								Сообщить("Не указан " + Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента + " " + ВыборкаДокумент.Грузополучатель);
							    Возврат;
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;

						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
					//////////////////////////////////////////////////////////////////////
					
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.Телефоны) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузополучатель.Телефоны,20));
							КонецЕсли;	
							ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Грузополучатель);
							Если ЗначениеЗаполнено(ЭлПочта) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.НомерСчета) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузополучатель.НомерСчета);
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.БИК) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузополучатель.Банк.Наименование);
								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузополучатель.БИК);
								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОГрузополучатель.КоррСчет);
							КонецЕсли;	 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
					
					//////////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузПолуч
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Контрагент.НаименованиеПолное);  
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Контрагент.ИНН);  
			 				ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Контрагент.КПП);
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв	
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							СведенияОПокупатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Контрагент,  ВыборкаДокумент.Дата);
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							Если ЗначениеЗаполнено(СведенияОПокупатель.Телефоны) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПокупатель.Телефоны,20));
							КонецЕсли;	
							ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Контрагент);
							Если ЗначениеЗаполнено(ЭлПочта) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							Если ЗначениеЗаполнено(СведенияОПокупатель.НомерСчета) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПокупатель.НомерСчета);
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							Если ЗначениеЗаполнено(СведенияОПокупатель.БИК) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПокупатель.Банк.Наименование);
								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПокупатель.БИК);
								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОПокупатель.КоррСчет);
							КонецЕсли;	 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ1");//+ИнфПолФХЖ1
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "отправитель");
					
					//{Лео Катанович
					Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ  //Билла
						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ   // Тандер
						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
				 		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		                 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		                 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
						 
						 ЗаписьXML.ЗаписатьАтрибут( "Значен",  "4607932679999");
					Иначе
						ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.GLNОрганизации));
					КонецЕсли;   
					//	Лео Катанович}
						
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					///////////////////////////////////////////////////////////////////////////////////////////////////////
					
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузоотправитель");
					
					//{Лео Катанович
					Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ  //Билла
						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ   // Тандер
						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
				 		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		                 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		                 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
						 
						 //ЗаписьXML.ЗаписатьАтрибут( "Значен",  "4607932679999");
						 ЗаписьXML.ЗаписатьАтрибут( "Значен",  ВыборкаДокумент.Грузоотправитель.абс_GLN);
					Иначе
						 //ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.GLNОрганизации));
						 ЗаписьXML.ЗаписатьАтрибут( "Значен", ВыборкаДокумент.Грузоотправитель.абс_GLN);
					КонецЕсли;   
					//	Лео Катанович}
						
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					
					///////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "получатель");
						// {Лео Катанович
						//ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNКонтрагента));
						Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") Тогда  // АТАК ООО // Передаем GLN точки доставки
 							ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
						Иначе
							ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNКонтрагента));
						КонецЕсли;			
						// Лео Катанович}	
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузополучатель");
						ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					
					//+Лео Зельгрос
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_накладной");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ДокументОтгрузки.Номер));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_накладной");
			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ДатаСФ,"ДФ=дд.ММ.гггг")); 
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_заказа");
			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ВыборкаДокумент.ДатаДокументаEDI,"ДФ=дд.ММ.гггг"));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					
					Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") Тогда     // Тандер
						 ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						        ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_поставки");
			 			        ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ВыборкаДокумент.ДатаПоставки,"ДФ=дд.ММ.гггг"));
			 		     ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					КонецЕсли;	


					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ИнфПолСтр
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_акта");
						ЗаписьXML.ЗаписатьАтрибут( "Значен", ?(ЗначениеЗаполнено(ДокументОтгрузки.абс_НомерУведомленияОПриемке),ДокументОтгрузки.абс_НомерУведомленияОПриемке,"б/н"));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_поставщика");
					 	ЗаписьXML.ЗаписатьАтрибут( "Значен",УдалитьЛидирующиеНули(ВыборкаДокумент.КодПоставщика));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

					
                    //-Лео Зельгрос
		 		ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
				
			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвСчФакт
			
			// --------------------ТАБЛИЧНАЯ ЧАСТЬ---------------------

			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблСчФакт");//+ТаблСчФакт
				ВыборкаСтрока=Результат[2].Выбрать();
				сч = 1;
				Пока ВыборкаСтрока.Следующий() Цикл
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.НаименованиеПолное);	
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов","796");
					    ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов",  Формат(ВыборкаСтрока.Цена, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат( ВыборкаСтрока.СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат( ВыборкаСтрока.СуммаБезНДС + ВыборкаСтрока.СуммаНДС , "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "НалСт", "" + Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0;" ) + "%" );
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Акциз");//+Акциз
							ЗаписатьXML(ЗаписьXML,"без акциза","БезАкциз");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Акциз
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал");//+СумНал;
							ЗаписатьXML(ЗаписьXML,Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНал
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
	
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала");
							АртикулПокупателя = СтрЗаменить(ВыборкаСтрока.АртикулПокупателя,"*","");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(АртикулПокупателя)));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_уведомления_об_отгрузке");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерУведомленияОбОтгрузке));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "штрихкод");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(ВыборкаСтрока.Штрихкод)));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2

                        ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_продавца");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(ВыборкаСтрока.Артикул)));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСведТов");//+ДопСведТов
						    ЗаписьXML.ЗаписатьАтрибут( "ПрТовРаб", "1");
							//КодТов = Строка(ВыборкаСтрока.Номенклатура.Артикул);
							//Если ЗначениеЗаполнено(КодТов) Тогда
							//	ПозицияВхождения = Найти(КодТов,"_");
							//	Если ПозицияВхождения > 0 Тогда
							//		КодТов  = Лев(КодТов,ПозицияВхождения - 1)
							//	КонецЕсли;
							ЗаписьXML.ЗаписатьАтрибут( "КодТов", СокрЛП(Строка(ВыборкаСтрока.Штрихкод)));
							//КонецЕсли;
						   
						    ЗаписьXML.ЗаписатьАтрибут( "НаимЕдИзм", Строка(ВыборкаСтрока.ЕдиницаИзмерения));
				        ЗаписьXML.ЗаписатьКонецЭлемента();//-ДопСведТов

					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
				КонецЦикла;
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоОпл");//+ВсегоОпл
					ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", Формат(ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
		 			ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",Формат( ДокументОтгрузки.абс_СуммаСНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
						ЗаписатьXML(ЗаписьXML,Формат(ДокументОтгрузки.абс_СуммаСНДС - ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
					ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего

				ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоОпл
 			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблСчФакт
			
			//-----------------------------------------------------------------------------------------------------------
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПродПер");//+СвПродПер

			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПер");//+СвПер
					ЗаписьXML.ЗаписатьАтрибут( "СодОпер", "Товары переданы");
		            ЗаписьXML.ЗаписатьАтрибут( "ДатаПер", Формат(ВыборкаДокумент.ДатаИсполнения,"ДФ=дд.ММ.гггг"));

			     ЗаписьXML.ЗаписатьНачалоЭлемента("ОснПер");//+ОснПер
				           ЗаписьXML.ЗаписатьАтрибут( "НаимОсн", ВыборкаДокумент.ДоговорКонтрагента.Наименование);
				           ЗаписьXML.ЗаписатьАтрибут( "НомОсн",  ВыборкаДокумент.ДоговорКонтрагента.Номер);
						   ЗаписьXML.ЗаписатьАтрибут( "ДатаОсн", Формат(ВыборкаДокумент.ДоговорКонтрагента.Дата,"ДФ=дд.ММ.гггг"));
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ОснПер
				//Если ЗначениеЗаполнено(ВыборкаДокумент.ДоверенностьПредставление) Тогда
				 ЗаписьXML.ЗаписатьНачалоЭлемента("СвЛицПер");//+СвЛицПер
				           ЗаписьXML.ЗаписатьНачалоЭлемента("ИнЛицо");//+ИнЛицо
                               ЗаписьXML.ЗаписатьНачалоЭлемента("ФЛПер");//+ФЛПер
										 ЗаписьXML.ЗаписатьАтрибут( "ОснДоверФЛ", "Доверенность");
                                         ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
										 Если ЗначениеЗаполнено(ВыборкаДокумент.Водитель) Тогда
										      Водитель = РазложитьФИО(ВыборкаДокумент.Водитель);
										      ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Водитель.Фамилия);  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", Водитель.Имя); 
										  Иначе 
											  Сообщить("Нет сведений о водителе!");
											  ЗаписьXML.ЗаписатьАтрибут( "Фамилия", "Отсутствует");  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", "Отсутствует"); 
										  КонецЕсли;	  
										  
                                         ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО						  
						       ЗаписьXML.ЗаписатьКонецЭлемента();//-ФЛПер
						  ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнЛицо
                ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЛицПер
				//Иначе
				//сообщить("Не заполнена доверенность по транспортному маршруту!");
				//КонецЕсли;
				ЗаписьXML.ЗаписатьНачалоЭлемента("ТранГруз");//+ТранГруз
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТранНакл");//+ТранНакл
					          ЗаписьXML.ЗаписатьАтрибут( "НомТранНакл",  ВыборкаДокумент.Номер);
							  ЗаписьXML.ЗаписатьАтрибут( "ДатаТранНакл", Формат(ВыборкаДокумент.ДатаТТН,"ДФ=дд.ММ.гггг"));
	                ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранНакл
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранГруз
				
              ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПер
           ЗаписьXML.ЗаписатьКонецЭлемента();//+СвПродПер

			//-----------------------------------------------------------------------------------------------------------
			//Руководители = ОбщегоНазначения.ОтветственныеЛица(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата,);
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
				ЗаписьXML.ЗаписатьАтрибут( "ОблПолн",  "6");
				ЗаписьXML.ЗаписатьАтрибут( "Статус",   "1");
				ЗаписьXML.ЗаписатьАтрибут( "ОснПолн",  "Должностные обязанности");
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
				
					СтруктураПодписант = ОтветственныйПоЭДО(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата);
					
			 		ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
					    ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
			
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.УПД);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
	
	//{Лео Катанович
	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
		 
		 СтруктураПараметров.Вставить("GLNПоставщика"			, "4607932679999");
	  Иначе
	     СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	КонецЕсли;   
    //	Лео Катанович}
	
	Если ДокументОтгрузки.Организация.Код = "О00000001" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su);
	ИначеЕсли ДокументОтгрузки.Организация.Код = "О00000003" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit);
	КонецЕсли;
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерДокументаEDIЗаказа);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаДокументаEDI);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры


Процедура ВыгрузитьУПД_Х5(ДокументОтгрузки, ЕстьОшибки) Экспорт
	//проверка наличия с/ф
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументОтгрузки);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф по данной отгрузке не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	Иначе
		Выборка 	= Результат.Выбрать();
		Выборка.Следующий();
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
	КонецЕсли;
	
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ КАК Цена,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
	|	СУММА(ВЫБОР
	|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|				ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
	|			ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
	|		КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтавкаНДС,
	|	РеализацияТоваровУслугТовары.НомерСтроки,
	|	СУММА(РеализацияТоваровУслугТовары.Количество * РеализацияТоваровУслугТовары.ЕдиницаИзмерения.Коэффициент / РеализацияТоваровУслугТовары.Номенклатура.ЕдиницаХраненияОстатков.Коэффициент * РеализацияТоваровУслугТовары.Номенклатура.ЕдиницаХраненияОстатков.ВесНетто) КАК СуммаНетто
	|ПОМЕСТИТЬ Накладная
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровУслугТовары.Номенклатура,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Качество,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
	|			ТОГДА ВЫБОР
	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.НомерСтроки
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ЕдиницаИзмерения,
	|	Ссылка,
	|	Качество
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Накладная.Ссылка.Номер КАК Номер,
	|	Накладная.Ссылка.Дата КАК Дата,
	|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
	|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI КАК НомерДокументаEDIЗаказа,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
	|	Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
	|	Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
	|	Накладная.Ссылка.ВалютаДокумента КАК Валюта,
	|	Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
	|	Накладная.Ссылка.Организация КАК Организация,
	|	Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
	|	Накладная.Ссылка.Контрагент КАК Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """") КАК НомерМагазина,
	|	Накладная.Ссылка.Грузополучатель КАК Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """") КАК КодПоставщика,
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.Дата, Накладная.Ссылка.Дата) КАК ДатаТТН,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор) КАК Водитель,
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность),
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки) КАК ДатаИсполнения,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI КАК ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ КАК ДатаПоставки
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НомерМагазина)) КАК СвойстваНомераМагазинов
	|		ПО Накладная.Ссылка.Грузополучатель = СвойстваНомераМагазинов.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	|			ЗначенияСвойствОбъектов.Значение КАК Значение
	|		ИЗ
	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	|		ГДЕ
	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодПоставщика)) КАК СвойствоКодПоставщика
	|		ПО Накладная.Ссылка.Контрагент = СвойствоКодПоставщика.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Ссылка.Номер,
	|	Накладная.Ссылка.Дата,
	|	Накладная.Ссылка.Сделка.Номер,
	|	Накладная.Ссылка.Сделка.Дата,
	|	Накладная.Ссылка.Организация.абс_GLN,
	|	Накладная.Ссылка.Контрагент.абс_GLN,
	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
	|	Накладная.Ссылка.Организация.ИНН,
	|	Накладная.Ссылка.Организация.КПП,
	|	Накладная.Ссылка.Организация.Лео_GUID,
	|	Накладная.Ссылка.Контрагент.Лео_GUID,
	|	Накладная.Ссылка.ВалютаДокумента,
	|	Накладная.Ссылка.ВалютаДокумента.Код,
	|	Накладная.Ссылка.Организация,
	|	Накладная.Ссылка.Грузоотправитель,
	|	Накладная.Ссылка.Контрагент,
	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """"),
	|	Накладная.Ссылка.Грузополучатель,
	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """"),
	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке,
	|	Накладная.Ссылка.ДоговорКонтрагента,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата,
	|	абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор,
	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI,
	|	Накладная.Ссылка.Сделка.абс_НомерЗаказаEDI,
	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ,
	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)),
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения, Накладная.Ссылка.Сделка.ДатаОтгрузки),
	|	ЕСТЬNULL(абс_ТранспортныйМаршрутЗадания.Ссылка.Дата, Накладная.Ссылка.Дата),
	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СуммаНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование КАК ЕдиницаИзмерения,
	|	Накладная.Цена,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя,
	|	Накладная.Номенклатура.Артикул КАК Артикул,
	|	Накладная.НомерСтроки КАК НомерСтроки,
	|	Накладная.СуммаНетто
	|ИЗ
	|	Накладная КАК Накладная
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Накладная.Номенклатура = Штрихкоды.Владелец
	|			И Накладная.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И Накладная.Качество = Штрихкоды.Качество
	|			И Накладная.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Накладная.СерияНоменклатуры = Штрихкоды.СерияНоменклатуры
	|			И Накладная.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(, ) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО Накладная.Свойство = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Свойство
	|			И Накладная.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И Накладная.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	Накладная.Количество,
	|	Накладная.Номенклатура,
	|	Накладная.СуммаБезНДС,
	|	Накладная.СтавкаНДС,
	|	Накладная.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование,
	|	Накладная.Цена,
	|	Накладная.СуммаНДС,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства,
	|	Накладная.Номенклатура.Артикул,
	|	Накладная.НомерСтроки,
	|	Накладная.СуммаНетто
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент=Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////		
	Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
		 Идентификатор = ВыборкаДокумент.ОператорEDI.Идентификатор;
	 Иначе	 
		 Идентификатор = "2IH";
	КонецЕсли;	
	
	GUIDОрганизации = "C585D418-784D-449B-82B3-FF4CD2DE5051";
	
	ИдФайл = "ON_NSCHFDOPPR_" +  ВыборкаДокумент.GUIDКонтрагента + "_" + Идентификатор + GUIDОрганизации  + "_" + Формат(ДатаСФ,"ДФ=ггггММдд");	
	ИдФайл = ИдФайл + "_" + Строка(ДокументОтгрузки.УникальныйИдентификатор()) ;
	ИдФайл = СформироватьИмяФайлаEDI(ИдФайл);
	ИмяФайла = ИдФайл + ".xml";
	 
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку( "WINDOWS-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
	
		ЗаписьXML.ЗаписатьАтрибут( "xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance");

		ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.01" );
		ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Exite Evolution 3.0.0" );
		 
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
			ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр",Идентификатор + GUIDОрганизации);
			ЗаписьXML.ЗаписатьАтрибут( "ИдПол", ВыборкаДокумент.GUIDКонтрагента);
		   ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
		   Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.ОператорEDI.Наименование);
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.ОператорEDI.Контрагент.ИНН);
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		   Иначе	  
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "Систем Групп Рус");
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   "7723749362");
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		  КонецЕсли;
         ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
			ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115131");
			Если  ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") ИЛИ    // ДИКСИ ООО
				  ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") Тогда    // Зельгрос ООО
				  ЗаписьXML.ЗаписатьАтрибут( "Функция", "СЧФ");
				Иначе
				   ЗаписьXML.ЗаписатьАтрибут( "Функция", "СЧФДОП");
			КонецЕсли;
			
			ЗаписьXML.ЗаписатьАтрибут( "ПоФактХЖ", "Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
            ЗаписьXML.ЗаписатьАтрибут( "НаимДокОпр", "Счет-фактура и документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)");
			ЗаписьXML.ЗаписатьАтрибут( "ДатаИнфПр", Формат(ТекущаяДата(),"ДФ=дд.ММ.гггг")); // Дата формирования файла обмена СФ
			ЗаписьXML.ЗаписатьАтрибут( "ВремИнфПр", Формат(ТекущаяДата(), "ДФ=ЧЧ.мм.сс"));
			ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное);
			ЗаписьXML.ЗаписатьАтрибут( "ОснДоверОргСост", "Основание доверенности");    // Добавлено 28/07/2017 для Билла ООО
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвСчФакт");//+СвСчФакт 
				ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", НомерСФ);
				ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") );              
				ЗаписьXML.ЗаписатьАтрибут( "КодОКВ", ВыборкаДокумент.КодВалюты);
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИспрСчФ");//+СвСчФакт 
						  ЗаписьXML.ЗаписатьАтрибут( "ДефДатаИспрСчФ", "-");
				          ЗаписьXML.ЗаписатьАтрибут( "ДефНомИспрСчФ", "-");
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ИспрСчФ
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг",ВыборкаДокумент.Организация.НаименованиеСокращенное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						
						СведенияОПродавец = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
						Если ЗначениеЗаполнено(СведенияОПродавец.Телефоны) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПродавец.Телефоны,20));
						КонецЕсли;	
							ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", "mail@leovit.ru");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
						////////////////////////////////////////////						
						СведенияОПродавце = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
						Если ЗначениеЗаполнено(СведенияОПродавце.НомерСчета) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПродавце.НомерСчета);
						КонецЕсли;	   
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
						Если ЗначениеЗаполнено(СведенияОПродавце.БИК) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПродавце.Банк.Наименование);
							ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПродавце.БИК);
						КонецЕсли;	 
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
                         /////////////////////////////
						
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод
				
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОт");//+ГрузОт 
					ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузОтпр");//+ГрузОтпр
					ЗаписьXML.ЗаписатьАтрибут( "ОКПО", Строка(ВыборкаДокумент.Грузоотправитель.КодПоОКПО));     

					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Грузоотправитель.НаименованиеПолное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Грузоотправитель.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Грузоотправитель.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
						ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
							ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
								СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузоотправитель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента);
								Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
								КонецЕсли;	
								Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
								КонецЕсли;
								Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
								КонецЕсли;
 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						СведенияОГрузоотправитель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузоотправитель,  ВыборкаДокумент.Дата);

							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.Телефоны) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузоотправитель.Телефоны,20));
									   КонецЕсли;	
									   ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Грузоотправитель);
									  Если ЗначениеЗаполнено(ЭлПочта) Тогда
                                           ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
									 КонецЕсли;
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт

							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							          Если ЗначениеЗаполнено(СведенияОГрузоотправитель.НомерСчета) Тогда
							               ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузоотправитель.НомерСчета);
									  КонецЕсли;	   
									  ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
									            Если ЗначениеЗаполнено(СведенияОГрузоотправитель.БИК) Тогда
									                 ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузоотправитель.Банк.Наименование);
												     ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузоотправитель.БИК);
													 ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОГрузоотправитель.КоррСчет);
												КонецЕсли;	 
                                      ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						    ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв

					ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОтпр
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузОт
				
				СведенияОГрузополучатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Грузополучатель,  ВыборкаДокумент.Дата);

				ЗаписьXML.ЗаписатьНачалоЭлемента("ГрузПолуч");//+ГрузПолуч
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
					          ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
								  Если ЗначениеЗаполнено(ВыборкаДокумент.НомерМагазина) Тогда
									   ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.НомерМагазина);
								   Иначе
									    ЗаписьXML.ЗаписатьАтрибут("НаимОрг", ВыборкаДокумент.Грузополучатель.Наименование);
								  КонецЕсли;
						           ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   СведенияОГрузополучатель.ИНН );
							       ЗаписьXML.ЗаписатьАтрибут( "КПП",     СведенияОГрузополучатель.КПП );
							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
						
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Грузополучатель,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента);
							Если СтруктураАдреса.Количество() = 0 Тогда
								Сообщить("Не указан " + Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента + " " + ВыборкаДокумент.Грузополучатель);
							    Возврат;
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
									ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;

						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
					ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
					//////////////////////////////////////////////////////////////////////
					
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.Телефоны) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОГрузополучатель.Телефоны,20));
							КонецЕсли;	
							ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Грузополучатель);
							Если ЗначениеЗаполнено(ЭлПочта) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.НомерСчета) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОГрузополучатель.НомерСчета);
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							Если ЗначениеЗаполнено(СведенияОГрузополучатель.БИК) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОГрузополучатель.Банк.Наименование);
								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОГрузополучатель.БИК);
								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОГрузополучатель.КоррСчет);
							КонецЕсли;	 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
					
					//////////////////////////////////////////////////////////////////////
				ЗаписьXML.ЗаписатьКонецЭлемента();//-ГрузПолуч
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
				    	ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Контрагент.НаименованиеПолное);  
							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Контрагент.ИНН);  
			 				ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Контрагент.КПП);
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв	
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							СведенияОПокупатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Контрагент,  ВыборкаДокумент.Дата);
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							Если ЗначениеЗаполнено(СведенияОПокупатель.Телефоны) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПокупатель.Телефоны,20));
							КонецЕсли;	
							ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Контрагент);
							Если ЗначениеЗаполнено(ЭлПочта) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							Если ЗначениеЗаполнено(СведенияОПокупатель.НомерСчета) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПокупатель.НомерСчета);
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							Если ЗначениеЗаполнено(СведенияОПокупатель.БИК) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПокупатель.Банк.Наименование);
								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПокупатель.БИК);
								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОПокупатель.КоррСчет);
							КонецЕсли;	 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ1");//+ИнфПолФХЖ1
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "отправитель");
						 ЗаписьXML.ЗаписатьАтрибут( "Значен",  "4607932679999");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					///////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузоотправитель");
					ЗаписьXML.ЗаписатьАтрибут( "Значен",  ВыборкаДокумент.Грузоотправитель.абс_GLN);
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					
					///////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "получатель");
						Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") Тогда  // АТАК ООО // Передаем GLN точки доставки
 							ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
						Иначе
							ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNКонтрагента));
						КонецЕсли;			
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") Тогда  // АТАК ООО // Передаем GLN точки доставки
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					    ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "GLN_грузополучателя");
					    ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					КонецЕсли;
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					    ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузополучатель");
					    ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					////////////////////////////////////////////////////////////////////////////////////////////////////////
					
					//+Лео Зельгрос
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
					ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_накладной");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ДокументОтгрузки.Номер));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_накладной");
			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ДатаСФ,"ДФ=дд.ММ.гггг")); 
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_заказа");
			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ВыборкаДокумент.ДатаДокументаEDI,"ДФ=дд.ММ.гггг"));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					
					Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") Тогда     // Тандер
						 ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						        ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_поставки");
			 			        ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ВыборкаДокумент.ДатаПоставки,"ДФ=дд.ММ.гггг"));
			 		     ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					КонецЕсли;	


					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ИнфПолСтр
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_акта");
						ЗаписьXML.ЗаписатьАтрибут( "Значен", ?(ЗначениеЗаполнено(ДокументОтгрузки.абс_НомерУведомленияОПриемке),ДокументОтгрузки.абс_НомерУведомленияОПриемке,"б/н"));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_поставщика");
					 	ЗаписьXML.ЗаписатьАтрибут( "Значен",УдалитьЛидирующиеНули(ВыборкаДокумент.КодПоставщика));
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

		 		ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
				
			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвСчФакт
			
			// --------------------ТАБЛИЧНАЯ ЧАСТЬ---------------------

			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблСчФакт");//+ТаблСчФакт
			    КолНетто = 0;
			    ВыборкаСтрока=Результат[2].Выбрать();
				сч = 1;
				Пока ВыборкаСтрока.Следующий() Цикл
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.Номенклатура.НаименованиеПолное);	
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_Тов","796");
					    ЗаписьXML.ЗаписатьАтрибут( "КолТов",  Формат(ВыборкаСтрока.Количество, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТов",  Формат(ВыборкаСтрока.Цена, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДС",  Формат( ВыборкаСтрока.СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНал", Формат( ВыборкаСтрока.СуммаБезНДС + ВыборкаСтрока.СуммаНДС , "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
						ЗаписьXML.ЗаписатьАтрибут( "НалСт", "" + Формат(ВыборкаСтрока.СтавкаНДС, "ЧДЦ=0;" ) + "%" );
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Акциз");//+Акциз
							ЗаписатьXML(ЗаписьXML,"без акциза","БезАкциз");
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Акциз
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал");//+СумНал;
							ЗаписатьXML(ЗаписьXML,Формат(ВыборкаСтрока.СуммаНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
						ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНал
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСведТов");//+ДопСведТов
						ЗаписьXML.ЗаписатьАтрибут( "ПрТовРаб", "1");
						ЗаписьXML.ЗаписатьАтрибут( "КодТов", СокрЛП(Строка(ВыборкаСтрока.Штрихкод)));
						ЗаписьXML.ЗаписатьАтрибут( "НаимЕдИзм", Строка(ВыборкаСтрока.ЕдиницаИзмерения));
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ДопСведТов
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
	
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала");
							АртикулПокупателя = СтрЗаменить(ВыборкаСтрока.АртикулПокупателя,"*","");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(АртикулПокупателя)));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала_заказчика");
							АртикулПокупателя = СтрЗаменить(ВыборкаСтрока.АртикулПокупателя,"*","");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(АртикулПокупателя)));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_уведомления_об_отгрузке");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерУведомленияОбОтгрузке));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "штрихкод");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(ВыборкаСтрока.Штрихкод)));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2

                        ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_продавца");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(Строка(ВыборкаСтрока.Артикул)));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2

					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
					КолНетто = КолНетто + ВыборкаСтрока.СуммаНетто;
				КонецЦикла;
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоОпл");//+ВсегоОпл
					ЗаписьXML.ЗаписатьАтрибут( "СтТовБезНДСВсего", Формат(ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
		 			ЗаписьXML.ЗаписатьАтрибут( "СтТовУчНалВсего",Формат( ДокументОтгрузки.абс_СуммаСНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ));
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалВсего"); //-СумНалВсего
						ЗаписатьXML(ЗаписьXML,Формат(ДокументОтгрузки.абс_СуммаСНДС - ДокументОтгрузки.абс_СуммаБезНДС, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"СумНал");
					ЗаписьXML.ЗаписатьКонецЭлемента(); //-СумНалВсего

				    ЗаписатьXML(ЗаписьXML,Формат(КолНетто, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=" ),"КолНеттоВс");

				ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоОпл
 			ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблСчФакт
			
			//-----------------------------------------------------------------------------------------------------------
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПродПер");//+СвПродПер

			ЗаписьXML.ЗаписатьНачалоЭлемента("СвПер");//+СвПер
					ЗаписьXML.ЗаписатьАтрибут( "СодОпер", "Товары переданы");
		            ЗаписьXML.ЗаписатьАтрибут( "ДатаПер", Формат(ВыборкаДокумент.ДатаИсполнения,"ДФ=дд.ММ.гггг"));

			     ЗаписьXML.ЗаписатьНачалоЭлемента("ОснПер");//+ОснПер
				           ДокОснование   = ВыборкаДокумент.ДоговорКонтрагента.Наименование;
						   НомерОснования =  ВыборкаДокумент.ДоговорКонтрагента.Номер;
						   ДатаОснования  = Формат(ВыборкаДокумент.ДоговорКонтрагента.Дата,"ДФ=дд.ММ.гггг");
						   Если ЗначениеЗаполнено(ДокОснование) и ЗначениеЗаполнено(НомерОснования) и ЗначениеЗаполнено(ДатаОснования) Тогда  
				                ЗаписьXML.ЗаписатьАтрибут( "НаимОсн", ДокОснование);
				                ЗаписьXML.ЗаписатьАтрибут( "НомОсн",  НомерОснования);
						        ЗаписьXML.ЗаписатьАтрибут( "ДатаОсн", ДатаОснования);
							Иначе
								ЗаписьXML.ЗаписатьАтрибут( "НаимОсн", "Без документа-основания");
						   КонецЕсли;	
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ОснПер
				 ЗаписьXML.ЗаписатьНачалоЭлемента("СвЛицПер");//+СвЛицПер
				           ЗаписьXML.ЗаписатьНачалоЭлемента("ИнЛицо");//+ИнЛицо
                               ЗаписьXML.ЗаписатьНачалоЭлемента("ФЛПер");//+ФЛПер
										 ЗаписьXML.ЗаписатьАтрибут( "ОснДоверФЛ", "Доверенность");
                                         ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО");//+ФИО
										 Если ЗначениеЗаполнено(ВыборкаДокумент.Водитель) Тогда
										      Водитель = РазложитьФИО(ВыборкаДокумент.Водитель);
										      ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Водитель.Фамилия);  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", Водитель.Имя); 
										  Иначе 
											  Сообщить("Нет сведений о водителе!");
											  ЗаписьXML.ЗаписатьАтрибут( "Фамилия", "Отсутствует");  
										      ЗаписьXML.ЗаписатьАтрибут( "Имя", "Отсутствует"); 
										  КонецЕсли;	  
										  
                                         ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО						  
						       ЗаписьXML.ЗаписатьКонецЭлемента();//-ФЛПер
						  ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнЛицо
                ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЛицПер
				ЗаписьXML.ЗаписатьНачалоЭлемента("ТранГруз");//+ТранГруз
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТранНакл");//+ТранНакл
					          ЗаписьXML.ЗаписатьАтрибут( "НомТранНакл",  ВыборкаДокумент.Номер);
							  ЗаписьXML.ЗаписатьАтрибут( "ДатаТранНакл", Формат(ВыборкаДокумент.ДатаТТН,"ДФ=дд.ММ.гггг"));
	                ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранНакл
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ТранГруз
				
              ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПер
           ЗаписьXML.ЗаписатьКонецЭлемента();//+СвПродПер

			//-----------------------------------------------------------------------------------------------------------
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
				ЗаписьXML.ЗаписатьАтрибут( "ОблПолн",  "6");
				ЗаписьXML.ЗаписатьАтрибут( "Статус",   "1");
				ЗаписьXML.ЗаписатьАтрибут( "ОснПолн",  "Должностные обязанности");
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
				
					СтруктураПодписант = ОтветственныйПоЭДО(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата);
					
			 		ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
					    ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
			
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
	ТекстXML=ЗаписьXML.Закрыть();
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.УПД);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
	СтруктураПараметров.Вставить("GLNПоставщика"			, "4607932679999");
	
	Если ДокументОтгрузки.Организация.Код = "О00000001" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su);
	ИначеЕсли ДокументОтгрузки.Организация.Код = "О00000003" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit);
	КонецЕсли;
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерДокументаEDIЗаказа);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаДокументаEDI);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры



Процедура ВыгрузитьУКД(ДокументКорректировки, ЕстьОшибки) Экспорт
	//проверка наличия с/ф
	Запрос=Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СчетФактураВыданный.Номер,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Ссылка
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки
	|	И СчетФактураВыданный.Проведен";
	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументКорректировки);
	Результат=Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Сообщение=Новый СообщениеПользователю;
		Сообщение.Текст="С/ф по документу не зарегистрирован";
		Сообщение.Сообщить();
		ЕстьОшибки = Истина;
		Возврат;
	Иначе
		Выборка 	= Результат.Выбрать();
		Выборка.Следующий();
		
		ДатаСФ 	= Выборка.Дата;
		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
	КонецЕсли;
	
	ДокументОтгрузки = ДокументКорректировки.ДокументРеализации;
	
	Запрос = Новый Запрос;
	//БЫЛО только на РТУ
	Если ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
			
		Запрос.Текст =
		
		"ВЫБРАТЬ
		|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
		|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|	ВЫБОР
		|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
		|			ТОГДА ВЫБОР
		|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
		|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
		|					ИНАЧЕ 0
		|				КОНЕЦ
		|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
		|	КОНЕЦ КАК Цена,
		|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
		|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
		|	РеализацияТоваровУслугТовары.Качество КАК Качество,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
		|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
		|	СУММА(ВЫБОР
		|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
		|				ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
		|			ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
		|		КОНЕЦ) КАК СуммаБезНДС,
		|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
		|	ВЫБОР
		|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
		|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
		|			ТОГДА 18
		|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
		|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
		|			ТОГДА 10
		|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
		|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
		|			ТОГДА 20
	    |		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
		|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
		|			ТОГДА 5
		|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
		|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
		|			ТОГДА 7
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК СтавкаНДС,
		|	РеализацияТоваровУслугТовары.НомерСтроки КАК НомерСтроки
		|ПОМЕСТИТЬ Накладная
		|ИЗ
		|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
		|ГДЕ
		|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
		|
		|СГРУППИРОВАТЬ ПО
		|	РеализацияТоваровУслугТовары.Номенклатура,
		|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
		|	РеализацияТоваровУслугТовары.Ссылка,
		|	РеализацияТоваровУслугТовары.Качество,
		|	ВЫБОР
		|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
		|			ТОГДА ВЫБОР
		|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
		|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
		|					ИНАЧЕ 0
		|				КОНЕЦ
		|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
		|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
		|			ТОГДА 18
		|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
		|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
		|			ТОГДА 10
		|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
		|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
		|			ТОГДА 20
	    |		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
		|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
		|			ТОГДА 5
		|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
		|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
		|			ТОГДА 7
		|		ИНАЧЕ 0        
		|	КОНЕЦ,
		|	РеализацияТоваровУслугТовары.НомерСтроки
		|{УПОРЯДОЧИТЬ ПО
		|	НомерСтроки}
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	НомерСтроки,
		|	Номенклатура,
		|	ЕдиницаИзмерения,
		|	Ссылка,
		|	Качество
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Накладная.Ссылка.Номер КАК Номер,
		|	Накладная.Ссылка.Дата КАК Дата,
		|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
		|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
		|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
		|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
		|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
		|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
		|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
		|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
		|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
		|	Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа КАК НомерДокументаEDIЗаказа,
		|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
		|	Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
		|	Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
		|	Накладная.Ссылка.ВалютаДокумента КАК Валюта,
		|	Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
		|	Накладная.Ссылка.Организация КАК Организация,
		|	Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
		|	Накладная.Ссылка.Контрагент КАК Контрагент,
		|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """") КАК НомерМагазина,
		|	Накладная.Ссылка.Грузополучатель КАК Грузополучатель,
		|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """") КАК КодПоставщика,
		|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомленияОбОтгрузке,
		|	Накладная.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
		|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата КАК ДатаТТН,
		|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор) КАК Водитель,
		|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность),
		|	абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения КАК ДатаИсполнения,
		|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI КАК ОператорEDI,
		|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ КАК ДатаПоставки
		|ИЗ
		|	Накладная КАК Накладная
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			ЗначенияСвойствОбъектов.Объект КАК Объект,
		|			ЗначенияСвойствОбъектов.Значение КАК Значение
		|		ИЗ
		|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
		|		ГДЕ
		|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НомерМагазина)) КАК СвойстваНомераМагазинов
		|		ПО Накладная.Ссылка.Грузополучатель = СвойстваНомераМагазинов.Объект
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			ЗначенияСвойствОбъектов.Объект КАК Объект,
		|			ЗначенияСвойствОбъектов.Значение КАК Значение
		|		ИЗ
		|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
		|		ГДЕ
		|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодПоставщика)) КАК СвойствоКодПоставщика
		|		ПО Накладная.Ссылка.Контрагент = СвойствоКодПоставщика.Объект
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
		|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
		|
		|СГРУППИРОВАТЬ ПО
		|	Накладная.Ссылка.Номер,
		|	Накладная.Ссылка.Дата,
		|	Накладная.Ссылка.Сделка.Номер,
		|	Накладная.Ссылка.Сделка.Дата,
		|	Накладная.Ссылка.Организация.абс_GLN,
		|	Накладная.Ссылка.Контрагент.абс_GLN,
		|	Накладная.Ссылка.Грузополучатель.абс_GLN,
		|	Накладная.Ссылка.Организация.ИНН,
		|	Накладная.Ссылка.Организация.КПП,
		|	Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа,
		|	Накладная.Ссылка.Организация.Лео_GUID,
		|	Накладная.Ссылка.Контрагент.Лео_GUID,
		|	Накладная.Ссылка.ВалютаДокумента,
		|	Накладная.Ссылка.ВалютаДокумента.Код,
		|	Накладная.Ссылка.Организация,
		|	Накладная.Ссылка.Грузоотправитель,
		|	Накладная.Ссылка.Контрагент,
		|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """"),
		|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)),
		|	Накладная.Ссылка.Грузополучатель,
		|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """"),
		|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке,
		|	Накладная.Ссылка.ДоговорКонтрагента,
		|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата,
		|	абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор,
		|	абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения,
		|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI,
		|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ,
		|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность)"; 
	//Добавил на Корректировку РТУ	
	ИначеЕсли ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
		
		Запрос.Текст =
		
		"ВЫБРАТЬ
		|		РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
		|		РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|		ВЫБОР
		|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
		|				ТОГДА ВЫБОР
		|						КОГДА РеализацияТоваровУслугТовары.Количество > 0
		|							ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
		|						ИНАЧЕ 0
		|					КОНЕЦ
		|			ИНАЧЕ РеализацияТоваровУслугТовары.Цена
		|		КОНЕЦ КАК Цена,
		|		СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
		|		РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
		|		РеализацияТоваровУслугТовары.Качество КАК Качество,
		|		ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
		|		ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
		|		ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
		|		ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
		|		СУММА(ВЫБОР
		|				КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
		|					ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
		|				ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
		|			КОНЕЦ) КАК СуммаБезНДС,
		|		СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
		|		ВЫБОР
		|			КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
		|					ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
		|				ТОГДА 18
		|			КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
		|					ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
		|				ТОГДА 10
		|			КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
		|					ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
		|				ТОГДА 20
		|			КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
		|					ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
		|				ТОГДА 5
		|			КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
		|					ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
		|				ТОГДА 7
		|			ИНАЧЕ 0
		|		КОНЕЦ КАК СтавкаНДС,
		|		РеализацияТоваровУслугТовары.НомерСтроки КАК НомерСтроки
		|	ПОМЕСТИТЬ Накладная
		|	ИЗ
		|		Документ.КорректировкаРеализации.Товары КАК РеализацияТоваровУслугТовары
		|	ГДЕ
		|		РеализацияТоваровУслугТовары.Ссылка = &Ссылка
		|	
		|	СГРУППИРОВАТЬ ПО
		|		РеализацияТоваровУслугТовары.Номенклатура,
		|		РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
		|		РеализацияТоваровУслугТовары.Ссылка,
		|		РеализацияТоваровУслугТовары.Качество,
		|		ВЫБОР
		|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
		|				ТОГДА ВЫБОР
		|						КОГДА РеализацияТоваровУслугТовары.Количество > 0
		|							ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
		|						ИНАЧЕ 0
		|					КОНЕЦ
		|			ИНАЧЕ РеализацияТоваровУслугТовары.Цена
		|		КОНЕЦ,
		|		ВЫБОР
		|			КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
		|					ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
		|				ТОГДА 18
		|			КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
		|					ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
		|				ТОГДА 10
		|			КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
		|					ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
		|				ТОГДА 20  
		|			КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
		|					ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
		|				ТОГДА 5
		|			КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
		|					ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
		|				ТОГДА 7
		|			ИНАЧЕ 0
		|		КОНЕЦ,
		|		РеализацияТоваровУслугТовары.НомерСтроки
		|	{УПОРЯДОЧИТЬ ПО
		|		НомерСтроки}
		|	
		|	ИНДЕКСИРОВАТЬ ПО
		|		НомерСтроки,
		|		Номенклатура,
		|		ЕдиницаИзмерения,
		|		Ссылка,
		|		Качество
		|	;
		|	
		|	////////////////////////////////////////////////////////////////////////////////
		|	ВЫБРАТЬ
		|		Накладная.Ссылка.Номер КАК Номер,
		|		Накладная.Ссылка.Дата КАК Дата,
		|		Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
		|		Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
		|		Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
		|		Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
		|		Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
		|		СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
		|		СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
		|		Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
		|		Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
		|		Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа КАК НомерДокументаEDIЗаказа,
		|		ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
		|		Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
		|		Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
		|		Накладная.Ссылка.ВалютаДокумента КАК Валюта,
		|		Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
		|		Накладная.Ссылка.Организация КАК Организация,
		|		Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
		|		Накладная.Ссылка.Контрагент КАК Контрагент,
		|		ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """") КАК НомерМагазина,
		|		Накладная.Ссылка.Грузополучатель КАК Грузополучатель,
		|		ЕСТЬNULL(СвойствоКодПоставщика.Значение, """") КАК КодПоставщика,
//		|		Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомленияОбОтгрузке,
		|		Накладная.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
		|		абс_ТранспортныйМаршрутЗадания.Ссылка.Дата КАК ДатаТТН,
		|		ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор) КАК Водитель,
		|		ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность),
		|		абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения КАК ДатаИсполнения,
		|		Накладная.Ссылка.Контрагент.Лео_ОператорEDI КАК ОператорEDI,
		|		Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ КАК ДатаПоставки
		|	ИЗ
		|		Накладная КАК Накладная
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				ЗначенияСвойствОбъектов.Объект КАК Объект,
		|				ЗначенияСвойствОбъектов.Значение КАК Значение
		|			ИЗ
		|				РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
		|			ГДЕ
		|				ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НомерМагазина)) КАК СвойстваНомераМагазинов
		|			ПО Накладная.Ссылка.Грузополучатель = СвойстваНомераМагазинов.Объект
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				ЗначенияСвойствОбъектов.Объект КАК Объект,
		|				ЗначенияСвойствОбъектов.Значение КАК Значение
		|			ИЗ
		|				РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
		|			ГДЕ
		|				ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодПоставщика)) КАК СвойствоКодПоставщика
		|			ПО Накладная.Ссылка.Контрагент = СвойствоКодПоставщика.Объект
		|			ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
		|			ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
		|	
		|	СГРУППИРОВАТЬ ПО
		|		Накладная.Ссылка.Номер,
		|		Накладная.Ссылка.Дата,
		|		Накладная.Ссылка.Сделка.Номер,
		|		Накладная.Ссылка.Сделка.Дата,
		|		Накладная.Ссылка.Организация.абс_GLN,
		|		Накладная.Ссылка.Контрагент.абс_GLN,
		|		Накладная.Ссылка.Грузополучатель.абс_GLN,
		|		Накладная.Ссылка.Организация.ИНН,
		|		Накладная.Ссылка.Организация.КПП,
		|		Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа,
		|		Накладная.Ссылка.Организация.Лео_GUID,
		|		Накладная.Ссылка.Контрагент.Лео_GUID,
		|		Накладная.Ссылка.ВалютаДокумента,
		|		Накладная.Ссылка.ВалютаДокумента.Код,
		|		Накладная.Ссылка.Организация,
		|		Накладная.Ссылка.Грузоотправитель,
		|		Накладная.Ссылка.Контрагент,
		|		ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """"),
		|		ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)),
		|		Накладная.Ссылка.Грузополучатель,
		|		ЕСТЬNULL(СвойствоКодПоставщика.Значение, """"),
//		|		Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке,
		|		Накладная.Ссылка.ДоговорКонтрагента,
		|		абс_ТранспортныйМаршрутЗадания.Ссылка.Дата,
		|		абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор,
		|		абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения,
		|		Накладная.Ссылка.Контрагент.Лео_ОператорEDI,
		|		Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ,
		|		ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность)";
		
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
	
	Результат=Запрос.ВыполнитьПакет();
	ВыборкаДокумент = Результат[1].Выбрать();
	ВыборкаДокумент.Следующий();	
		
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //{Лео Катанович
	Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
		Идентификатор = ВыборкаДокумент.ОператорEDI.Идентификатор;
	Иначе	 
		Идентификатор = "2IH";
	КонецЕсли;	
	
	ИдОтпр = Идентификатор + "-" + СОКРЛП(ВыборкаДокумент.Организация.ИНН)+ "-" + СОКРЛП(ВыборкаДокумент.Организация.Лео_GUID);
	
	//////////////////////////////////////////////////////
	
	Если НЕ ЗначениеЗаполнено(ВыборкаДокумент.Контрагент.Лео_GUID) Тогда 
		Сообщить("Не указан GUID контрагента а системе EDI");
	Иначе
		Если СтрДлина(ВыборкаДокумент.Контрагент.Лео_GUID) < 35 Тогда
		     Сообщить("Неверно указан GUID Контрагента");
	    КонецЕсли;	
	КонецЕсли;	

	ИдПол = СОКРЛП(ВыборкаДокумент.Контрагент.Лео_GUID);
	
	ИдФайл = "ON_NKORSCHFDOPPR_" + ИдПол + "_" + ИдОтпр + "_" + Формат(ДатаСФ,"ДФ=ггггММдд");	
	ИдФайл = ИдФайл + "_" + Строка(ДокументКорректировки.УникальныйИдентификатор()) ;
	
	ИмяФайла = "UKD_" + ДокументКорректировки.Номер + "_" + Формат(ВыборкаДокумент.Дата,"ДФ=ггггММдд");
	
	ИмяФайла = СформироватьИмяФайлаEDI(ИмяФайла);
	ИмяФайла = ИмяФайла + ".xml";
	 
	ЗаписьXML = Новый ЗаписьXML;
	ЗаписьXML.УстановитьСтроку( "WINDOWS-1251");
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	
	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
	
	ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
	ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.01" );
    ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Diadoc 1.0" );
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
			ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр",ИдОтпр);
			ЗаписьXML.ЗаписатьАтрибут( "ИдПол", ИдПол);
			
		 ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
		   Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.ОператорEDI.Наименование);
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.ОператорEDI.Контрагент.ИНН);
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		   Иначе	  
			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "Систем Групп Рус");
			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   "7723749362");
			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
		  КонецЕсли;
         ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
			ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115133");
			ЗаписьXML.ЗаписатьАтрибут( "Функция", "КСЧФДИС");
				 
			ЗаписьXML.ЗаписатьАтрибут( "ПоФактХЖ",   "Документ, подтверждающий согласие (факт уведомления) покупателя на изменение стоимости отгруженных товаров (выполненных работ, оказанных услуг), переданных имущественных прав");
            ЗаписьXML.ЗаписатьАтрибут( "НаимДокОпр", "Документ, подтверждающий согласие (факт уведомления) покупателя на изменение стоимости отгруженных товаров (выполненных работ, оказанных услуг), переданных имущественных прав");
			ЗаписьXML.ЗаписатьАтрибут( "ДатаИнфПр", Формат(ТекущаяДата(),"ДФ=дд.ММ.гггг")); // Дата формирования файла обмена СФ
			ЗаписьXML.ЗаписатьАтрибут( "ВремИнфПр", Формат(ТекущаяДата(), "ДФ=ЧЧ.мм.сс"));
			ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное);
			ЗаписьXML.ЗаписатьАтрибут( "ОснДоверОргСост", "Доверенность");
			
			///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////			
			ЗаписьXML.ЗаписатьНачалоЭлемента("СвКСчФ");//+СвКСчФ 
				ЗаписьXML.ЗаписатьАтрибут( "НомерКСчФ", НомерСФ);
				ЗаписьXML.ЗаписатьАтрибут( "ДатаКСчФ",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") );              
				ЗаписьXML.ЗаписатьАтрибут( "КодОКВ", ВыборкаДокумент.КодВалюты);
				//ЗаписьXML.ЗаписатьАтрибут( "НаимОКВ", "Российский рубль");
				ЗаписьXML.ЗаписатьНачалоЭлемента("СчФ");//+СчФ 
				
					//проверка наличия с/ф , к которому относится корректировочный СФ
				    СписокВидовСчетовФактур = Новый СписокЗначений;
					//БЫЛО только на РТУ
					Если ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
						СписокВидовСчетовФактур.Добавить(Перечисления.ВидСчетаФактурыВыставленного.НаРеализацию);
					//Добавил на Корректировку РТУ	
					ИначеЕсли ТипЗнч(ДокументОтгрузки) = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
						СписокВидовСчетовФактур.Добавить(Перечисления.ВидСчетаФактурыВыставленного.Корректировочный);
				    КонецЕсли;
					ОтборСчетовФактур = Новый Структура();
					ОтборСчетовФактур.Вставить("ВидСчетаФактуры", СписокВидовСчетовФактур);
					ОтборСчетовФактур.Вставить("ПометкаУдаления", Ложь);

				   ВыборкаДокументСФ = (УчетНДС.НайтиПодчиненныйСчетФактуру(ДокументОтгрузки, "СчетФактураВыданный", ОтборСчетовФактур));
					
					Если ЗначениеЗаполнено(ВыборкаДокументСФ) Тогда
				         ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", СОКРЛП(ВыборкаДокументСФ.Номер));
				         ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",   Формат(ВыборкаДокументСФ.Дата,"ДФ=дд.ММ.гггг"));
						 
					 Иначе
						Сообщить("Не найден первоначальный документ СФ!"); 
						ЕстьОшибки = Истина;
						Возврат;
					КонецЕсли;
                ЗаписьXML.ЗаписатьКонецЭлемента();//-СчФ 
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
					    	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Организация.НаименованиеСокращенное);  
			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  		
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
						
						СведенияОПродавец = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
						Если ЗначениеЗаполнено(СведенияОПродавец.Телефоны) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПродавец.Телефоны,20));
						КонецЕсли;	
						//ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(СведенияОПродавец);
						//Если ЗначениеЗаполнено(ЭлПочта) Тогда
							ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", "mail@leovit.ru");
						//КонецЕсли;
						ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
						ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							Если ЗначениеЗаполнено(СведенияОПродавец.НомерСчета) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПродавец.НомерСчета);
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							Если ЗначениеЗаполнено(СведенияОПродавец.БИК) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПродавец.Банк.Наименование);
								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПродавец.БИК);
								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОПродавец.КоррСчет);
							КонецЕсли;	 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
						ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод
				 				
					ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
					Если ВыборкаДокумент.Контрагент.ЮрФизЛицо  = Перечисления.ЮрФизЛицо.ЮрЛицо  Тогда
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
						ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Контрагент.НаименованиеПолное);  
						ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Контрагент.ИНН);  
						ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Контрагент.КПП);
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
					Иначе
						ЗаписьXML.ЗаписатьНачалоЭлемента("СвИП");//+СвИП
						ЗаписьXML.ЗаписатьАтрибут( "ИННФЛ", ВыборкаДокумент.Контрагент.ИНН);  
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						МассивФИО = СтрРазделить(СтрЗаменить(ВыборкаДокумент.Контрагент.НаименованиеПолное,"ИП ",""), " ");
						Попытка
							Фамилия = МассивФИО[0];
							Имя =  МассивФИО[1];
							Отчество = МассивФИО[2];
						Исключение
							Фамилия = ВыборкаДокумент.Контрагент.НаименованиеПолное;
							Имя =  "";
							Отчество = "";
						КонецПопытки;
						
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", Фамилия);  
						ЗаписьXML.ЗаписатьАтрибут( "Имя",Имя); 
						ЗаписьXML.ЗаписатьАтрибут( "Отчество", Отчество);
						
						ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
						
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвИП
					КонецЕсли;	
					
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв	
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
							КонецЕсли;	
							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
							КонецЕсли;
							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
							
							СведенияОПокупатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Контрагент,  ВыборкаДокумент.Дата);
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
							Если ЗначениеЗаполнено(СведенияОПокупатель.Телефоны) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПокупатель.Телефоны,20));
							КонецЕсли;	
							ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Контрагент);
							Если ЗначениеЗаполнено(ЭлПочта) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
							КонецЕсли;
							ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
							
							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
							Если ЗначениеЗаполнено(СведенияОПокупатель.НомерСчета) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПокупатель.НомерСчета);
							КонецЕсли;	   
							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
							Если ЗначениеЗаполнено(СведенияОПокупатель.БИК) Тогда
								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПокупатель.Банк.Наименование);
								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПокупатель.БИК);
								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОПокупатель.КоррСчет);
							КонецЕсли;	 
							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСвФХЖ1");//+ДопСвФХЖ1
                ЗаписьXML.ЗаписатьАтрибут("НаимОКВ", "Российский рубль");
				 ЗаписьXML.ЗаписатьАтрибут("КурсВал", "1");
                ЗаписьXML.ЗаписатьКонецЭлемента();//-ДопСвФХЖ1
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ1");//+ИнфПолФХЖ1
				    Если ЗначениеЗаполнено(ВыборкаДокумент.GLNОрганизации) Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					      ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "отправитель");
					      ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.GLNОрганизации));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				    КонецЕсли;
					
					Если ЗначениеЗаполнено(ВыборкаДокумент.Грузоотправитель.абс_GLN) Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
					      ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузоотправитель");
					      ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.Грузоотправитель.абс_GLN));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				    КонецЕсли;

					
					Если ЗначениеЗаполнено(ВыборкаДокумент.GLNКонтрагента) Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						  ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "получатель");
						  ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNКонтрагента));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				    КонецЕсли;
				
					Если ЗначениеЗаполнено(ВыборкаДокумент.НомерДокументаEDIЗаказа) Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				    КонецЕсли;
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_накладной");
					 	ЗаписьXML.ЗаписатьАтрибут( "Значен",ВыборкаДокумент.Номер);
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_накладной");
					 	ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));   
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
					
					Если ЗначениеЗаполнено(ВыборкаДокумент.ДатаЗаказа) Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_заказа");
					 	ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ВыборкаДокумент.ДатаЗаказа,"ДФ=дд.ММ.гггг"));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф 
					КонецЕсли;
	
            // --------------------------------------------------------------------------------------------------
					Если ЗначениеЗаполнено(ВыборкаДокумент.GLNГрузополучателя) Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "GLN_грузополучателя");
					 	ЗаписьXML.ЗаписатьАтрибут( "Значен",СОКРЛП(ВыборкаДокумент.GLNГрузополучателя));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				    КонецЕсли;
				
					Если ЗначениеЗаполнено(ВыборкаДокумент.КодПоставщика) Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_поставщика");
					 	ЗаписьXML.ЗаписатьАтрибут( "Значен",УдалитьЛидирующиеНули(ВыборкаДокумент.КодПоставщика));
			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
				КонецЕсли;
				

			ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
				
			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвКСчФ
			
			// --------------------ТАБЛИЧНАЯ ЧАСТЬ---------------------
			
			Корректировочный = Выборка.Ссылка.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыВыставленного.Корректировочный;

			
			ДанныеДляФормированияЭД = Неопределено;
			Для Каждого СтрДокОснования Из Выборка.Ссылка.ДокументыОснования Цикл
				
				Если НЕ ЗначениеЗаполнено(СтрДокОснования.ДокументОснование) Тогда
					Продолжить;
				КонецЕсли;
				
				мВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
				ЭкземплярДанныхДляПечати = Неопределено;
				
				//Если  Корректировочный Тогда
					ЭкземплярДанныхДляПечати = СобратьДанныеДляПечатиКорректировочногоСчетаФактуры(СтрДокОснования.ДокументОснование, Выборка.Ссылка);
				//Иначе
				//	ЭкземплярДанныхДляПечати = СобратьДанныеДляПечатиИсправленияСчетаФактуры(СтрДокОснования.ДокументОснование, Выборка.Ссылка);
				//КонецЕсли;
				//
				
				// Заполнение данных для печати
				Если ДанныеДляФормированияЭД = Неопределено Тогда
					ДанныеДляФормированияЭД = ЭкземплярДанныхДляПечати;
				Иначе
					
					Для каждого СтрДанных Из ЭкземплярДанныхДляПечати Цикл
						
						Если СтрДанных.Ключ = "ТабличнаяЧасть" Тогда
							СтараяТабЧасть = ДанныеДляФормированияЭД.ТабличнаяЧасть;
							НоваяТабЧасть  = СтрДанных.Значение;
							
							Для каждого НоваяСтрокаТабЧасти Из НоваяТабЧасть Цикл
								СтрокаТабЧасти = СтараяТабЧасть.Добавить();
								Для каждого ТекКол Из НоваяТабЧасть.Колонки Цикл
									Если СтараяТабЧасть.Колонки.Найти(ТекКол.Имя) <> Неопределено Тогда
										СтрокаТабЧасти[ТекКол.Имя] = НоваяСтрокаТабЧасти[ТекКол.Имя];
									КонецЕсли;
								КонецЦикла;
							КонецЦикла;
							
						ИначеЕсли НЕ ДанныеДляФормированияЭД.Свойство(СтрДанных.Ключ) Тогда
							// Если данный параметр для печати шапки документа еще не  определен - то определяем его
							ДанныеДляФормированияЭД.Вставить(СтрДанных.Ключ, СтрДанных.Значение);
							
						КонецЕсли;
						
					КонецЦикла;
					
				КонецЕсли;
				
			КонецЦикла;	
			
	
	Если  ДанныеДляФормированияЭД <> Неопределено Тогда
		
		КолонкиГруппировок = ""
		+"Номенклатура,"
		+"НаименованиеТовара,"
		+"Серия,"
		+"Характеристика,"
		+"НаименованиеЕдиницыИзмерения,"
		+"ЕдиницаИзмеренияКод,"
		+"ЦенаДоИзменения,"	
		+"ЦенаПослеИзменения,"
		+"СтавкаНДС,"
		+"СтавкаНДСДоИзменения,"
		+"СтавкаНДСПослеИзменения,"
		+"НомерСтроки,"
		+"Штрихкод";
		
		КолонкиСуммирования = ""
		+"СуммаНДСДоИзменения,"
		+"СуммаНДСПослеИзменения,"
		+"СтоимостьСНДСДоИзменения,"
		+"СтоимостьСНДСПослеИзменения,"
		+"РазницаБезНДСУвеличение,"
		+"РазницаБезНДСУменьшение,"
		+"РазницаНДСУвеличение,"
		+"РазницаНДСУменьшение,"
		+"РазницаСНДСУвеличение,"
		+"РазницаСНДСУменьшение,"
		+"СтоимостьБезНДСДоИзменения,"
		+"СтоимостьБезНДСПослеИзменения,"
		+"КоличествоДоИзменения,"
		+"КоличествоПослеИзменения";
		
		ДанныеДляФормированияЭД.ТабличнаяЧасть.Свернуть(КолонкиГруппировок, КолонкиСуммирования);
		
	КонецЕсли; 
	
	
	
	
	ТЗ_ТаблицаТоваров =  ДанныеДляФормированияЭД.ТабличнаяЧасть.Скопировать();
    ТЗ_ТаблицаТоваров.Свернуть("Номенклатура");
	ТаблицаТоваров = ТЗ_ТаблицаТоваров.ВыгрузитьКолонку("Номенклатура");
	
	МассивИсключений = Новый Массив;
	МассивИсключений.Добавить("*");
	Запрос = новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя,
	               |	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	               |ИЗ
	               |	РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(
	               |			&Дата,
	               |			Номенклатура В ИЕРАРХИИ (&Номенклатура)
	               |				И Контрагент = &Контрагент
	               |				И Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя)) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	               |ГДЕ
	               |	НЕ абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства В (&МассивИсключений)";
	
 
    Запрос.УстановитьПараметр("Дата", ВыборкаДокумент.Дата);
  	Запрос.УстановитьПараметр("Номенклатура", ТаблицаТоваров);
	Запрос.УстановитьПараметр("МассивИсключений", МассивИсключений);
	Запрос.УстановитьПараметр("Контрагент", ДанныеДляФормированияЭД.Покупатель);

	ТаблицаДопСведений = Запрос.Выполнить().Выгрузить();
			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблКСчФ");//+ТаблКСчФ
			сч = 1;
			Для каждого ВыборкаСтрока из ДанныеДляФормированияЭД.ТабличнаяЧасть Цикл  
				Если СтрДокОснования.ДокументОснование.ВидОперации=Перечисления.ВидыОперацийИсправленияПоступленияРеализации.ИсправлениеОшибки Тогда
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
						//ЛЕО Владимир
						ЗаписьXML.ЗаписатьАтрибут( "ПорНомТовВСЧФ",Строка(ВыборкаСтрока.НомерСтроки));
						//ЛЕО Владимир
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.НаименованиеТовара);
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_ТовДо","796");
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_ТовПосле","796");
						 
						ЗаписьXML.ЗаписатьАтрибут( "КолТовДо",    Формат(ВыборкаСтрока.КоличествопослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "КолТовПосле", Формат(ВыборкаСтрока.КоличествопослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
 						
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТовДо",    Формат(ВыборкаСтрока.ЦенаПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТовПосле", Формат(ВыборкаСтрока.ЦенаПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));

						ЗаписьXML.ЗаписатьАтрибут( "НалСтДо",    Строка(УчетНДС.ПолучитьСтавкуНДС(ВыборкаСтрока.СтавкаНДСПослеИзменения)) + "%");
                        ЗаписьXML.ЗаписатьАтрибут( "НалСтПосле", Строка(УчетНДС.ПолучитьСтавкуНДС(ВыборкаСтрока.СтавкаНДСПослеИзменения)) + "%" );
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СтТовБезНДС");
							ЗаписьXML.ЗаписатьАтрибут("СтоимДоИзм", Формат(ВыборкаСтрока.СтоимостьБезНДСПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
							ЗаписьXML.ЗаписатьАтрибут("СтоимПослеИзм", Формат(ВыборкаСтрока.СтоимостьБезНДСПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
							
							
							Если ВыборкаСтрока.РазницаБезНДСУменьшение > 0 Тогда
								ЗаписьXML.ЗаписатьАтрибут("СтоимУм", Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
							Иначе
								ЗаписьXML.ЗаписатьАтрибут("СтоимУвел", Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
							КонецЕсли;	   
					     ЗаписьXML.ЗаписатьКонецЭлемента();//-СтТовБезНДС
						
						 ЗаписьXML.ЗаписатьНачалоЭлемента("АкцизДо"); //+АкцизДо
						           ЗаписьXML.ЗаписатьНачалоЭлемента("БезАкциз"); //+БезАкциз
						           ЗаписьXML.ЗаписатьТекст("без акциза");
								   ЗаписьXML.ЗаписатьКонецЭлемента();// -БезАкциз
						 ЗаписьXML.ЗаписатьКонецЭлемента();//АкцизДо
						 
						 ЗаписьXML.ЗаписатьНачалоЭлемента("АкцизПосле"); //+АкцизПосле
						           ЗаписьXML.ЗаписатьНачалоЭлемента("БезАкциз"); //+БезАкциз
						           ЗаписьXML.ЗаписатьТекст("без акциза");
								   ЗаписьXML.ЗаписатьКонецЭлемента();// -БезАкциз
						 ЗаписьXML.ЗаписатьКонецЭлемента();//АкцизПосле
						 
						 //ЗаписьXML.ЗаписатьНачалоЭлемента("АкцизРазн");//+АкцизРазн
						 //		  ЗаписьXML.ЗаписатьНачалоЭлемента("СумУвел"); //+ СумУвел
						 //   	   ЗаписьXML.ЗаписатьТекст("0");
						 //   	   ЗаписьXML.ЗаписатьКонецЭлемента(); //- СумУвел
						 //ЗаписьXML.ЗаписатьКонецЭлемента();//-АкцизРазн

						  ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалДо");//+СумНалДо
								   ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); //+СумНДС
								   ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаСтрока.СуммаНДСПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						           ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС		
						 ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНалДо

						 ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалПосле");//+СумНалПосле
								   ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); //+СумНДС
								   ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаСтрока.СуммаНДСПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						           ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС		   
						 ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНалПосле
						 
						 ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалРазн");//+СумНалРазн
						 Если ВыборкаСтрока.РазницаНДСУменьшение > 0 Тогда
							  ЗаписьXML.ЗаписатьНачалоЭлемента("СумУм"); //+СумУм
									 ЗаписьXML.ЗаписатьТекст(Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СумУм		 		 
						 Иначе
							  ЗаписьXML.ЗаписатьНачалоЭлемента("СумУвел"); //+СумУвел
							        ЗаписьXML.ЗаписатьТекст(Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СумУвел			 
						КонецЕсли;	   
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНалРазн
						 
						ЗаписьXML.ЗаписатьНачалоЭлемента("СтТовУчНал");//+СтТовУчНал
								   ЗаписьXML.ЗаписатьАтрибут("СтоимДоИзм", Формат(ВыборкаСтрока.СтоимостьСНДСПослеИзменения,"ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=")); 
								   ЗаписьXML.ЗаписатьАтрибут("СтоимПослеИзм", Формат(ВыборкаСтрока.СтоимостьСНДСПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						Если ВыборкаСтрока.РазницаСНДСУменьшение > 0 Тогда
						 ЗаписьXML.ЗаписатьАтрибут("СтоимУм", Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						Иначе
						 ЗаписьXML.ЗаписатьАтрибут("СтоимУвел", Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						КонецЕсли;	  
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СтТовУчНал
						 
						 
						 //////////////
						 
	                    СтрокаДопСведений = ТаблицаДопСведений.Найти(ВыборкаСтрока.Номенклатура,"Номенклатура");
						
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_продавца");
							ЗаписьXML.ЗаписатьАтрибут( "Значен",?(СтрокаДопСведений = Неопределено,ВыборкаСтрока.Номенклатура.Артикул,СтрокаДопСведений.АртикулПокупателя));
					   ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "штрихкод");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаСтрока.Штрихкод));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_уведомления_об_отгрузке");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.Номер));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2


										
					//ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолСтр
					//				ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
					//			ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
					// ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр


					ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСведТов");//+ДопСведТов
					    ЗаписьXML.ЗаписатьАтрибут("НаимЕдИзмДо", ВыборкаСтрока.НаименованиеЕдиницыИзмерения.Наименование); 
					    ЗаписьXML.ЗаписатьАтрибут("НаимЕдИзмПосле", ВыборкаСтрока.НаименованиеЕдиницыИзмерения.Наименование);  
						  
					//ЗначениеОКПД2	= лео_ДопФункции.Получить_ЗначенияСвойствОбъектов(ВыборкаСтрока.Номенклатура, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("00000000066"));
					//	Если ЗначениеЗаполнено(ЗначениеОКПД2) И ТипЗнч(ЗначениеОКПД2)=Тип("СправочникСсылка.Лео_КлассификаторОКПД2") Тогда 
					//		Если ЗначениеОКПД2.ЧестныйЗнак Тогда
					//			ЗаписьXML.ЗаписатьНачалоЭлемента("НомСредИдентТов");//+НомСредИдентТов 
					//			//{Катанович
					//			//ЗаписатьXML(ЗаписьXML,лео_ДопФункции.ПолучитьGTINпоНоменклатуре(ВыборкаСтрока.Номенклатура)+"37"+Строка(ВыборкаСтрока.Количество),"НомУпак");  
					//			//НомУпаковки = НовыйКодОСУ(лео_ДопФункции.ПолучитьGTINпоНоменклатуре(ВыборкаСтрока.Номенклатура),ВыборкаСтрока.Количество);	
					//			//ЗаписатьXML(ЗаписьXML,НомУпаковки,"НомУпак");  
					//			//Катанович}

					//			ЗаписьXML.ЗаписатьКонецЭлемента();//-НомСредИдентТов    
					//		КонецЕсли;
					//	КонецЕсли;
                	ЗаписьXML.ЗаписатьКонецЭлемента();//-ДопСведТов 
					
					ПроверитьНаВхождениеВМаркируемыйТовар(ЗаписьXML, ВыборкаСтрока, СтрДокОснования.ДокументОснование);

					ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
				Иначе
					Если ВыборкаСтрока.КоличествоДоИзменения = ВыборкаСтрока.КоличествоПослеИзменения И
						 ВыборкаСтрока.ЦенаДоИзменения = ВыборкаСтрока.ЦенаПослеИзменения И
						 ВыборкаСтрока.СтавкаНДСДоИзменения = ВыборкаСтрока.СтавкаНДСПослеИзменения И
						 ВыборкаСтрока.СуммаНДСДоИзменения = ВыборкаСтрока.СуммаНДСПослеИзменения И
						 ВыборкаСтрока.СтоимостьСНДСДоИзменения = ВыборкаСтрока.СтоимостьСНДСПослеИзменения И
						 ВыборкаСтрока.СтоимостьБезНДСДоИзменения = ВыборкаСтрока.СтоимостьБезНДСПослеИзменения Тогда
						Продолжить;
					КонецЕсли;	
					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
						ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
						//ЛЕО Владимир
						ЗаписьXML.ЗаписатьАтрибут( "ПорНомТовВСЧФ",Строка(ВыборкаСтрока.НомерСтроки));
						//ЛЕО Владимир
			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.НаименованиеТовара);
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_ТовДо","796");
					    ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_ТовПосле","796");
						 
						ЗаписьXML.ЗаписатьАтрибут( "КолТовДо",    Формат(ВыборкаСтрока.КоличествоДоИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "КолТовПосле", Формат(ВыборкаСтрока.КоличествопослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
 						
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТовДо",    Формат(ВыборкаСтрока.ЦенаДоИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТовПосле", Формат(ВыборкаСтрока.ЦенаПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));

						ЗаписьXML.ЗаписатьАтрибут( "НалСтДо",    Строка(УчетНДС.ПолучитьСтавкуНДС(ВыборкаСтрока.СтавкаНДСДоИзменения)) + "%");
                        ЗаписьXML.ЗаписатьАтрибут( "НалСтПосле", Строка(УчетНДС.ПолучитьСтавкуНДС(ВыборкаСтрока.СтавкаНДСПослеИзменения)) + "%" );
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СтТовБезНДС");
							ЗаписьXML.ЗаписатьАтрибут("СтоимДоИзм", Формат(ВыборкаСтрока.СтоимостьБезНДСДоИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
							ЗаписьXML.ЗаписатьАтрибут("СтоимПослеИзм", Формат(ВыборкаСтрока.СтоимостьБезНДСПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
							
						
						Если ВыборкаСтрока.РазницаБезНДСУменьшение > 0 Тогда
							ЗаписьXML.ЗаписатьАтрибут("СтоимУм", Формат(ВыборкаСтрока.РазницаБезНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						Иначе
							ЗаписьXML.ЗаписатьАтрибут("СтоимУвел", Формат(ВыборкаСтрока.РазницаБезНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						КонецЕсли;	   
					    ЗаписьXML.ЗаписатьКонецЭлемента();//-СтТовБезНДС     
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("АкцизДо"); //+АкцизДо
						           ЗаписьXML.ЗаписатьНачалоЭлемента("БезАкциз"); //+БезАкциз
						           ЗаписьXML.ЗаписатьТекст("без акциза");
								   ЗаписьXML.ЗаписатьКонецЭлемента();// -БезАкциз
						ЗаписьXML.ЗаписатьКонецЭлемента();//АкцизДо
						 
						ЗаписьXML.ЗаписатьНачалоЭлемента("АкцизПосле"); //+АкцизПосле
						           ЗаписьXML.ЗаписатьНачалоЭлемента("БезАкциз"); //+БезАкциз
						           ЗаписьXML.ЗаписатьТекст("без акциза");
								   ЗаписьXML.ЗаписатьКонецЭлемента();// -БезАкциз
						ЗаписьXML.ЗаписатьКонецЭлемента();//АкцизПосле
						 
						 //ЗаписьXML.ЗаписатьНачалоЭлемента("АкцизРазн");//+АкцизРазн
						 //		  ЗаписьXML.ЗаписатьНачалоЭлемента("СумУвел"); //+ СумУвел
						 //   	   ЗаписьXML.ЗаписатьТекст("0");
						 //   	   ЗаписьXML.ЗаписатьКонецЭлемента(); //- СумУвел
						 //ЗаписьXML.ЗаписатьКонецЭлемента();//-АкцизРазн

						  ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалДо");//+СумНалДо
								   ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); //+СумНДС
								   ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаСтрока.СуммаНДСДоИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						           ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС		
						 ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНалДо

						 ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалПосле");//+СумНалПосле
								   ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); //+СумНДС
								   ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаСтрока.СуммаНДСПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						           ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС		   
						 ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНалПосле
						 
						 ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалРазн");//+СумНалРазн
						 Если ВыборкаСтрока.РазницаНДСУменьшение > 0 Тогда
							  ЗаписьXML.ЗаписатьНачалоЭлемента("СумУм"); //+СумУм
									 ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаСтрока.РазницаНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СумУм		 		 
						 Иначе
							  ЗаписьXML.ЗаписатьНачалоЭлемента("СумУвел"); //+СумУвел
							        ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаСтрока.РазницаНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СумУвел			 
						КонецЕсли;	   
						 ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНалРазн
						 
						 ЗаписьXML.ЗаписатьНачалоЭлемента("СтТовУчНал");//+СтТовУчНал
								   ЗаписьXML.ЗаписатьАтрибут("СтоимДоИзм", Формат(ВыборкаСтрока.СтоимостьСНДСДоИзменения,"ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=")); 
								   ЗаписьXML.ЗаписатьАтрибут("СтоимПослеИзм", Формат(ВыборкаСтрока.СтоимостьСНДСПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
								 Если ВыборкаСтрока.РазницаСНДСУменьшение > 0 Тогда
									 ЗаписьXML.ЗаписатьАтрибут("СтоимУм", Формат(ВыборкаСтрока.РазницаСНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
								 Иначе
									 ЗаписьXML.ЗаписатьАтрибут("СтоимУвел", Формат(ВыборкаСтрока.РазницаСНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
								 КонецЕсли;	  
						 ЗаписьXML.ЗаписатьКонецЭлемента();//-СтТовУчНал
						 
						 
						 //////////////
						 
	                    СтрокаДопСведений = ТаблицаДопСведений.Найти(ВыборкаСтрока.Номенклатура,"Номенклатура");
						
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолСтр
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_продавца");
							ЗаписьXML.ЗаписатьАтрибут( "Значен",?(СтрокаДопСведений = Неопределено,ВыборкаСтрока.Номенклатура.Артикул,СтрокаДопСведений.АртикулПокупателя));
					   ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "штрихкод");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаСтрока.Штрихкод));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2

						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_уведомления_об_отгрузке");
							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.Номер));
				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2


										
					//ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолСтр
					//				ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
					//			ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
					// ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр


					ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСведТов");//+ДопСведТов
					      ЗаписьXML.ЗаписатьАтрибут("НаимЕдИзмДо", ВыборкаСтрока.НаименованиеЕдиницыИзмерения.Наименование); 
					      ЗаписьXML.ЗаписатьАтрибут("НаимЕдИзмПосле", ВыборкаСтрока.НаименованиеЕдиницыИзмерения.Наименование); 
                    ЗаписьXML.ЗаписатьКонецЭлемента();//-ДопСведТов

					//Добавлено для проверки на ЧЗ 
					ПроверитьНаВхождениеВМаркируемыйТовар(ЗаписьXML, ВыборкаСтрока, СтрДокОснования.ДокументОснование);
					//Добавлено для проверки на ЧЗ   
						
				ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
					сч = сч + 1;
				КонецЕсли;	
			КонецЦикла;
				
				// Итоги документа
				Если СтрДокОснования.ДокументОснование.ВидОперации=Перечисления.ВидыОперацийИсправленияПоступленияРеализации.ИсправлениеОшибки Тогда 
					ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоУвел"); //+ ВсегоУвел

						ЗаписьXML.ЗаписатьАтрибут("СтТовБезНДСВсего", Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут("СтТовУчНалВсего", Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал"); // + СумНал
						   ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); // + СумНДС
						         ЗаписьXML.ЗаписатьТекст(Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
	                        ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНал
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоУвел
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоУм"); //+ ВсегоУм
						ЗаписьXML.ЗаписатьАтрибут("СтТовУчНалВсего", Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут("СтТовБезНДСВсего", Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал"); // + СумНал
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); // + СумНДС
						          ЗаписьXML.ЗаписатьТекст(Формат(0, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
                        ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНал

						ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоУм	
					
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблКСчФ
				Иначе	
					ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоУвел"); //+ ВсегоУвел

						ЗаписьXML.ЗаписатьАтрибут("СтТовБезНДСВсего", Формат(Выборка.ССылка.СуммаУвеличение - Выборка.ССылка.СуммаНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут("СтТовУчНалВсего", Формат(Выборка.ССылка.СуммаУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал"); // + СумНал
						   ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); // + СумНДС
						         ЗаписьXML.ЗаписатьТекст(Формат(Выборка.ССылка.СуммаНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
	                        ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС
						ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНал
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоУвел
					
					ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоУм"); //+ ВсегоУм
						ЗаписьXML.ЗаписатьАтрибут("СтТовУчНалВсего", Формат(Выборка.ССылка.СуммаУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						ЗаписьXML.ЗаписатьАтрибут("СтТовБезНДСВсего", Формат(Выборка.ССылка.СуммаУменьшение - Выборка.ССылка.СуммаНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
						
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал"); // + СумНал
						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); // + СумНДС
						          ЗаписьXML.ЗаписатьТекст(Формат(Выборка.ССылка.СуммаНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
                        ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНал

						ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоУм	
					
					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблКСчФ
				КонецЕсли;
				////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
			    ЗаписьXML.ЗаписатьНачалоЭлемента("СодФХЖ3");//+СодФХЖ3	
				Если СтрДокОснования.ДокументОснование.ВидОперации=Перечисления.ВидыОперацийИсправленияПоступленияРеализации.ИсправлениеОшибки Тогда
                     ЗаписьXML.ЗаписатьАтрибут("СодОпер", "Исправительный документ");
				Иначе
                     ЗаписьXML.ЗаписатьАтрибут("СодОпер", "Изменение стоимости товаров и услуг");
				КонецЕсли;	 
						
					  ЗаписьXML.ЗаписатьНачалоЭлемента("ПередатДокум");//+ПередатДокум	
					            ЗаписьXML.ЗаписатьАтрибут("НаимОсн", "УПД");
								ЗаписьXML.ЗаписатьАтрибут("НомОсн", НомерСФ);
								ЗаписьXML.ЗаписатьАтрибут("ДатаОсн", Формат(ДатаСФ,"ДФ=дд.ММ.гггг"));

                       ЗаписьXML.ЗаписатьКонецЭлемента();//-ПередатДокум	
					  ЗаписьXML.ЗаписатьНачалоЭлемента("ДокумОснКор");//+ДокумОснКор	
					            ЗаписьXML.ЗаписатьАтрибут("НаимОсн", "Договор поставки");
					            ЗаписьXML.ЗаписатьАтрибут("НомОсн", ВыборкаДокумент.ДоговорКонтрагента.Номер);
					            ЗаписьXML.ЗаписатьАтрибут("ДатаОсн", Формат(ВыборкаДокумент.ДоговорКонтрагента.Дата,"ДФ=дд.ММ.гггг"));
                       ЗаписьXML.ЗаписатьКонецЭлемента();//-ДокумОснКор				
					   
                ЗаписьXML.ЗаписатьКонецЭлемента();//-СодФХЖ3	
                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
			ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
				ЗаписьXML.ЗаписатьАтрибут( "ОблПолн",  "6");
				ЗаписьXML.ЗаписатьАтрибут( "Статус",   "1");
				ЗаписьXML.ЗаписатьАтрибут( "ОснПолн",  "Должностные обязанности");
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
				    ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
					СтруктураПодписант = ОтветственныйПоЭДО(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата);
					
			 		ЗаписьXML.ЗаписатьАтрибут( "Должн",   СтруктураПодписант.Должность);
					ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Организация.НаименованиеСокращенное);
				    ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
					    ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 
			        ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
			
			ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
			
		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл 
	
	
	
	ТекстXML=ЗаписьXML.Закрыть();
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.СчетФактура);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
	
	//{Лео Катанович
	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
		 
		 СтруктураПараметров.Вставить("GLNПоставщика"			, "4607932679999");
	  Иначе
	     СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	КонецЕсли;   
    //	Лео Катанович}
	
	//Если ДокументОтгрузки.Организация.Код = "О00000001" Тогда
	//	СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su);
	//ИначеЕсли ДокументОтгрузки.Организация.Код = "О00000003" Тогда
	//	СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit);
	//КонецЕсли;
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.НайтиПоНаименованию("Контур"));
	// Справочники.абс_НастройкиEDIОбмена.НайтиПоНаименованию("Контур")
	 
	 
	 
	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерДокументаEDIЗаказа);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаДокументаEDI);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры




//Процедура ВыгрузитьУКД(ДокументКорректировки, ЕстьОшибки) Экспорт
//	//проверка наличия с/ф
//	Запрос=Новый Запрос;
//	Запрос.Текст=
//	"ВЫБРАТЬ ПЕРВЫЕ 1
//	|	СчетФактураВыданный.Номер,
//	|	СчетФактураВыданный.Дата,
//	|	СчетФактураВыданный.Ссылка
//	|ИЗ
//	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
//	|ГДЕ
//	|	СчетФактураВыданный.ДокументОснование = &ДокументОтгрузки";
//	Запрос.УстановитьПараметр("ДокументОтгрузки",ДокументКорректировки);
//	Результат=Запрос.Выполнить();
//	Если Результат.Пустой() Тогда
//		Сообщение=Новый СообщениеПользователю;
//		Сообщение.Текст="С/ф по документу не зарегистрирован";
//		Сообщение.Сообщить();
//		ЕстьОшибки = Истина;
//		Возврат;
//	Иначе
//		Выборка 	= Результат.Выбрать();
//		Выборка.Следующий();
//		
//		ДатаСФ 	= Выборка.Дата;
//		НомерСФ = ОбщегоНазначения.ПолучитьНомерНаПечать(Выборка.Ссылка);
//	КонецЕсли;
//	
//	ДокументОтгрузки = ДокументКорректировки.ДокументРеализации;
//	
//	Запрос = Новый Запрос;
//	Запрос.Текст =
//	"ВЫБРАТЬ
//	|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
//	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
//	|	ВЫБОР
//	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
//	|			ТОГДА ВЫБОР
//	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
//	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
//	|					ИНАЧЕ 0
//	|				КОНЕЦ
//	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
//	|	КОНЕЦ КАК Цена,
//	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
//	|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
//	|	РеализацияТоваровУслугТовары.Качество КАК Качество,
//	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
//	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
//	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
//	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя) КАК Свойство,
//	|	СУММА(ВЫБОР
//	|			КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
//	|				ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
//	|			ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
//	|		КОНЕЦ) КАК СуммаБезНДС,
//	|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДС,
//	|	ВЫБОР
//	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
//	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
//	|			ТОГДА 18
//	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
//	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
//	|			ТОГДА 10
//	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
//	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
//	|			ТОГДА 20
//	|		ИНАЧЕ 0
//	|	КОНЕЦ КАК СтавкаНДС,
//	|	РеализацияТоваровУслугТовары.НомерСтроки КАК НомерСтроки
//	|ПОМЕСТИТЬ Накладная
//	|ИЗ
//	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
//	|ГДЕ
//	|	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
//	|
//	|СГРУППИРОВАТЬ ПО
//	|	РеализацияТоваровУслугТовары.Номенклатура,
//	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
//	|	РеализацияТоваровУслугТовары.Ссылка,
//	|	РеализацияТоваровУслугТовары.Качество,
//	|	ВЫБОР
//	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС = ИСТИНА
//	|			ТОГДА ВЫБОР
//	|					КОГДА РеализацияТоваровУслугТовары.Количество > 0
//	|						ТОГДА (РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС) / РеализацияТоваровУслугТовары.Количество
//	|					ИНАЧЕ 0
//	|				КОНЕЦ
//	|		ИНАЧЕ РеализацияТоваровУслугТовары.Цена
//	|	КОНЕЦ,
//	|	ВЫБОР
//	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
//	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
//	|			ТОГДА 18
//	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
//	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
//	|			ТОГДА 10
//	|		КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
//	|				ИЛИ РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
//	|			ТОГДА 20
//	|		ИНАЧЕ 0
//	|	КОНЕЦ,
//	|	РеализацияТоваровУслугТовары.НомерСтроки
//	|{УПОРЯДОЧИТЬ ПО
//	|	НомерСтроки}
//	|
//	|ИНДЕКСИРОВАТЬ ПО
//	|	НомерСтроки,
//	|	Номенклатура,
//	|	ЕдиницаИзмерения,
//	|	Ссылка,
//	|	Качество
//	|;
//	|
//	|////////////////////////////////////////////////////////////////////////////////
//	|ВЫБРАТЬ
//	|	Накладная.Ссылка.Номер КАК Номер,
//	|	Накладная.Ссылка.Дата КАК Дата,
//	|	Накладная.Ссылка.Сделка.Номер КАК НомерЗаказа,
//	|	Накладная.Ссылка.Сделка.Дата КАК ДатаЗаказа,
//	|	Накладная.Ссылка.Организация.абс_GLN КАК GLNОрганизации,
//	|	Накладная.Ссылка.Контрагент.абс_GLN КАК GLNКонтрагента,
//	|	Накладная.Ссылка.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
//	|	СУММА(Накладная.СуммаБезНДС) КАК СуммаБезНДС,
//	|	СУММА(Накладная.СуммаНДС) КАК СуммаНДС,
//	|	Накладная.Ссылка.Организация.ИНН КАК ИННОрганизации,
//	|	Накладная.Ссылка.Организация.КПП КАК КППОрганизации,
//	|	Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа КАК НомерДокументаEDIЗаказа,
//	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокументаEDI,
//	|	Накладная.Ссылка.Организация.Лео_GUID КАК GUIDОрганизации,
//	|	Накладная.Ссылка.Контрагент.Лео_GUID КАК GUIDКонтрагента,
//	|	Накладная.Ссылка.ВалютаДокумента КАК Валюта,
//	|	Накладная.Ссылка.ВалютаДокумента.Код КАК КодВалюты,
//	|	Накладная.Ссылка.Организация КАК Организация,
//	|	Накладная.Ссылка.Грузоотправитель КАК Грузоотправитель,
//	|	Накладная.Ссылка.Контрагент КАК Контрагент,
//	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """") КАК НомерМагазина,
//	|	Накладная.Ссылка.Грузополучатель КАК Грузополучатель,
//	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """") КАК КодПоставщика,
//	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке КАК НомерУведомленияОбОтгрузке,
//	|	Накладная.Ссылка.ДоговорКонтрагента КАК ДоговорКонтрагента,
//	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата КАК ДатаТТН,
//	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор) КАК Водитель,
//	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность),
//	|	абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения КАК ДатаИсполнения,
//	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI КАК ОператорEDI,
//	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ КАК ДатаПоставки
//	|ИЗ
//	|	Накладная КАК Накладная
//	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
//	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
//	|			ЗначенияСвойствОбъектов.Значение КАК Значение
//	|		ИЗ
//	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
//	|		ГДЕ
//	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_НомерМагазина)) КАК СвойстваНомераМагазинов
//	|		ПО Накладная.Ссылка.Грузополучатель = СвойстваНомераМагазинов.Объект
//	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
//	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
//	|			ЗначенияСвойствОбъектов.Значение КАК Значение
//	|		ИЗ
//	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
//	|		ГДЕ
//	|			ЗначенияСвойствОбъектов.Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_КодПоставщика)) КАК СвойствоКодПоставщика
//	|		ПО Накладная.Ссылка.Контрагент = СвойствоКодПоставщика.Объект
//	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.абс_ТранспортныйМаршрут.Задания КАК абс_ТранспортныйМаршрутЗадания
//	|		ПО Накладная.Ссылка.Сделка = абс_ТранспортныйМаршрутЗадания.ЗаявкаНаТранспорт.ЗаказПокупателя
//	|
//	|СГРУППИРОВАТЬ ПО
//	|	Накладная.Ссылка.Номер,
//	|	Накладная.Ссылка.Дата,
//	|	Накладная.Ссылка.Сделка.Номер,
//	|	Накладная.Ссылка.Сделка.Дата,
//	|	Накладная.Ссылка.Организация.абс_GLN,
//	|	Накладная.Ссылка.Контрагент.абс_GLN,
//	|	Накладная.Ссылка.Грузополучатель.абс_GLN,
//	|	Накладная.Ссылка.Организация.ИНН,
//	|	Накладная.Ссылка.Организация.КПП,
//	|	Накладная.Ссылка.Сделка.ДокументОснование.НомерДокументаEDIЗаказа,
//	|	Накладная.Ссылка.Организация.Лео_GUID,
//	|	Накладная.Ссылка.Контрагент.Лео_GUID,
//	|	Накладная.Ссылка.ВалютаДокумента,
//	|	Накладная.Ссылка.ВалютаДокумента.Код,
//	|	Накладная.Ссылка.Организация,
//	|	Накладная.Ссылка.Грузоотправитель,
//	|	Накладная.Ссылка.Контрагент,
//	|	ЕСТЬNULL(СвойстваНомераМагазинов.Значение, """"),
//	|	ЕСТЬNULL(Накладная.Ссылка.Сделка.ДокументОснование.ДатаДокументаEDI, ДАТАВРЕМЯ(1, 1, 1)),
//	|	Накладная.Ссылка.Грузополучатель,
//	|	ЕСТЬNULL(СвойствоКодПоставщика.Значение, """"),
//	|	Накладная.Ссылка.абс_НомерУведомленияОбОтгрузке,
//	|	Накладная.Ссылка.ДоговорКонтрагента,
//	|	абс_ТранспортныйМаршрутЗадания.Ссылка.Дата,
//	|	абс_ТранспортныйМаршрутЗадания.Ссылка.ВодительЭкспедитор,
//	|	абс_ТранспортныйМаршрутЗадания.Ссылка.СводнаяЗаявкаНаТранспорт.ДатаИсполнения,
//	|	Накладная.Ссылка.Контрагент.Лео_ОператорEDI,
//	|	Накладная.Ссылка.Сделка.абс_ДатаПоставкиВТЦ,
//	|	ПРЕДСТАВЛЕНИЕ(абс_ТранспортныйМаршрутЗадания.Доверенность)";
//	Запрос.УстановитьПараметр("Ссылка",ДокументОтгрузки);
//	
//	Результат=Запрос.ВыполнитьПакет();
//	ВыборкаДокумент = Результат[1].Выбрать();
//	ВыборкаДокумент.Следующий();	
//		
//	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//	//{Лео Катанович
//	Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
//		 Идентификатор = ВыборкаДокумент.ОператорEDI.Идентификатор;
//	 Иначе	 
//		 Идентификатор = "2IH";
//	 КонецЕсли;	

//	ИдОтпр = Идентификатор + "-" + СОКРЛП(ВыборкаДокумент.Организация.ИНН)+ "-" + СОКРЛП(ВыборкаДокумент.Организация.Лео_GUID);
//	ИдПол  = Идентификатор + "-" + СОКРЛП(ВыборкаДокумент.Контрагент.ИНН) + "-" + СОКРЛП(ВыборкаДокумент.Контрагент.Лео_GUID);
//	 
//	ИдФайл = "ON_NKORSCHFDOPPR_" + ИдОтпр + "_" + ИдПол + "_" + Формат(ДатаСФ,"ДФ=ггггММдд");	
//	ИдФайл = ИдФайл + "_" + Строка(ДокументКорректировки.УникальныйИдентификатор()) ;
//	
//	ИдФайл = СформироватьИмяФайлаEDI(ИдФайл);
//	ИмяФайла = ИдФайл + ".xml";
//	 
//	ЗаписьXML = Новый ЗаписьXML;
//	ЗаписьXML.УстановитьСтроку( "WINDOWS-1251");
//	ЗаписьXML.ЗаписатьОбъявлениеXML();
//	
//	ЗаписьXML.ЗаписатьНачалоЭлемента( "Файл" );//+файл
//	
//	ЗаписьXML.ЗаписатьАтрибут( "ИдФайл", ИдФайл );
//	ЗаписьXML.ЗаписатьАтрибут( "ВерсФорм", "5.01" );
//	ЗаписьXML.ЗаписатьАтрибут( "ВерсПрог", "Diadoc 1.0" );
//		
//	
//	
//		ЗаписьXML.ЗаписатьНачалоЭлемента("СвУчДокОбор");//+СвУчДокОбор 
//			
//			
//			ЗаписьXML.ЗаписатьАтрибут( "ИдОтпр",ИдОтпр);
//			ЗаписьXML.ЗаписатьАтрибут( "ИдПол", ИдПол);
//			
//			
//			//ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
//			//	ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "ООО &quot;Систем Групп Рус&quot");
//			//ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", "7723749362");
//			//ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", "2IH");	
//			//ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр
//		 ЗаписьXML.ЗаписатьНачалоЭлемента("СвОЭДОтпр"); //+СвОЭДОтпр
//		   Если ЗначениеЗаполнено(ВыборкаДокумент.ОператорEDI) Тогда
//			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.ОператорEDI.Наименование);
//			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   ВыборкаДокумент.ОператорEDI.Контрагент.ИНН);
//			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
//		   Иначе	  
//			  ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", "Систем Групп Рус");
//			  ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ",   "7723749362");
//			  ЗаписьXML.ЗаписатьАтрибут( "ИдЭДО", Идентификатор);	
//		  КонецЕсли;
//		 ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвОЭДОтпр

//		ЗаписьXML.ЗаписатьКонецЭлемента(); //-СвУчДокОбор
//		
//		ЗаписьXML.ЗаписатьНачалоЭлемента("Документ");//+Документ
//			ЗаписьXML.ЗаписатьАтрибут( "КНД", "1115127");
//			
//			Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") Тогда     // Зельгрос ООО
//				ЗаписьXML.ЗаписатьАтрибут( "Функция", "КСЧФ");
//			Иначе 
//				ЗаписьXML.ЗаписатьАтрибут( "Функция", "КСЧФДИС");
//			КонецЕсли;	
//				 
//			ЗаписьXML.ЗаписатьАтрибут( "ПоФактХЖ", "Документ об изменении стоимости отгруженных товаров (выполненных работ, оказанных услуг), переданных имущественных прав");
//			ЗаписьXML.ЗаписатьАтрибут( "НаимДокОпр", "Корректировочный счет-фактура и документ об изменении стоимости отгруженных товаров (выполненных работ, оказанных услуг), переданных имущественных прав» (или самостоятельно сформированное)");
//			ЗаписьXML.ЗаписатьАтрибут( "ДатаИнфПр", Формат(ТекущаяДата(),"ДФ=дд.ММ.гггг")); // Дата формирования файла обмена СФ
//			ЗаписьXML.ЗаписатьАтрибут( "ВремИнфПр", Формат(ТекущаяДата(), "ДФ=ЧЧ.мм.сс"));
//			ЗаписьXML.ЗаписатьАтрибут( "НаимЭконСубСост", ВыборкаДокумент.Организация.НаименованиеСокращенное);
//			ЗаписьXML.ЗаписатьАтрибут( "ОснДоверОргСост", "Доверенность");

//			ЗаписьXML.ЗаписатьНачалоЭлемента("СвКСчФ");//+СвКСчФ 
//				ЗаписьXML.ЗаписатьАтрибут( "НомерКСчФ", НомерСФ);
//				ЗаписьXML.ЗаписатьАтрибут( "ДатаКСчФ",Формат(ДатаСФ,"ДФ=дд.ММ.гггг") );              
//				ЗаписьXML.ЗаписатьАтрибут( "КодОКВ", ВыборкаДокумент.КодВалюты);
//				//ЗаписьXML.ЗаписатьАтрибут( "НаимОКВ", "Российский рубль");
//				ЗаписьXML.ЗаписатьНачалоЭлемента("СчФ");//+СчФ 
//				
//					//проверка наличия с/ф , к которому относится корректировочный СФ
//					СписокВидовСчетовФактур = Новый СписокЗначений;
//					СписокВидовСчетовФактур.Добавить(Перечисления.ВидСчетаФактурыВыставленного.НаРеализацию);

//					ОтборСчетовФактур = Новый Структура();
//					ОтборСчетовФактур.Вставить("ВидСчетаФактуры", СписокВидовСчетовФактур);
//					ОтборСчетовФактур.Вставить("ПометкаУдаления", Ложь);

//				   ВыборкаДокументСФ = (УчетНДС.НайтиПодчиненныйСчетФактуру(ДокументОтгрузки, "СчетФактураВыданный", ОтборСчетовФактур));
//					
//					Если ЗначениеЗаполнено(ВыборкаДокументСФ) Тогда
//						 ЗаписьXML.ЗаписатьАтрибут( "НомерСчФ", ВыборкаДокументСФ.Номер);
//						 ЗаписьXML.ЗаписатьАтрибут( "ДатаСчФ",   Формат(ВыборкаДокументСФ.Дата,"ДФ=дд.ММ.гггг"));
//						 
//					 Иначе
//						Сообщить("Не найден первоначальный документ СФ!"); 
//						ЕстьОшибки = Истина;
//						Возврат;
//					КонецЕсли;
//				ЗаписьXML.ЗаписатьКонецЭлемента();//-СчФ 
//				
//				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПрод");//+СвПрод
//					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
//						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
//							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Организация.НаименованиеСокращенное);  
//			 				ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);  
//							ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Организация.КПП);  		
//						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
//					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв
//					
//					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
//						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
//							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Организация,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
//							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
//							КонецЕсли;
//							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
//							КонецЕсли;
//							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
//							КонецЕсли;
//							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
//							КонецЕсли;	
//							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
//							КонецЕсли;
//							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
//							КонецЕсли;
//							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
//							КонецЕсли;
//							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
//							КонецЕсли;
//							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
//							КонецЕсли;
//						ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
//						ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
//						
//						СведенияОПродавец = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Организация,  ВыборкаДокумент.Дата);
//						
//						ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
//						Если ЗначениеЗаполнено(СведенияОПродавец.Телефоны) Тогда
//							ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПродавец.Телефоны,20));
//						КонецЕсли;	
//						//ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(СведенияОПродавец);
//						//Если ЗначениеЗаполнено(ЭлПочта) Тогда
//							ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", "mail@leovit.ru");
//						//КонецЕсли;
//						ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
//						ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
//							Если ЗначениеЗаполнено(СведенияОПродавец.НомерСчета) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПродавец.НомерСчета);
//							КонецЕсли;	   
//							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
//							Если ЗначениеЗаполнено(СведенияОПродавец.БИК) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПродавец.Банк.Наименование);
//								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПродавец.БИК);
//								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОПродавец.КоррСчет);
//							КонецЕсли;	 
//							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
//						ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
//				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПрод
//				 				
//				ЗаписьXML.ЗаписатьНачалоЭлемента("СвПокуп");//+СвПокуп
//					ЗаписьXML.ЗаписатьНачалоЭлемента("ИдСв");//+ИдСв
//						ЗаписьXML.ЗаписатьНачалоЭлемента("СвЮЛУч");//+СвЮЛ
//							ЗаписьXML.ЗаписатьАтрибут( "НаимОрг", ВыборкаДокумент.Контрагент.НаименованиеПолное);  
//							ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Контрагент.ИНН);  
//			 				ЗаписьXML.ЗаписатьАтрибут( "КПП", ВыборкаДокумент.Контрагент.КПП);
//						ЗаписьXML.ЗаписатьКонецЭлемента();//-СвЮЛУч
//					ЗаписьXML.ЗаписатьКонецЭлемента();//-ИдСв	
//					
//					ЗаписьXML.ЗаписатьНачалоЭлемента("Адрес");//+Адрес
//						ЗаписьXML.ЗаписатьНачалоЭлемента("АдрРФ");//+АдрРФ
//							СтруктураАдреса = ПолучитьСтруктураАдреса(ВыборкаДокумент.Контрагент,Перечисления.ТипыКонтактнойИнформации.Адрес,Справочники.ВидыКонтактнойИнформации.ЮрАдресКонтрагента);
//							Если ЗначениеЗаполнено(СтруктураАдреса.КодРегион) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "КодРегион", Строка(СтруктураАдреса.КодРегион));
//							КонецЕсли;
//							Если ЗначениеЗаполнено(СтруктураАдреса.Индекс) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Индекс",  Строка(СтруктураАдреса.Индекс));
//							КонецЕсли;
//							Если ЗначениеЗаполнено(СтруктураАдреса.Район) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Район", СтруктураАдреса.Район);
//							КонецЕсли;
//							Если ЗначениеЗаполнено(СтруктураАдреса.Город) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Город", СтруктураАдреса.Город);
//							КонецЕсли;	
//							Если ЗначениеЗаполнено(СтруктураАдреса.НаселПункт) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "НаселПункт", СтруктураАдреса.НаселПункт);
//							КонецЕсли;
//							Если ЗначениеЗаполнено(СтруктураАдреса.Улица) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Улица",  Строка(СтруктураАдреса.Улица));
//							КонецЕсли;
//							Если ЗначениеЗаполнено(СтруктураАдреса.Дом) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Дом",  Строка(СтруктураАдреса.Дом));
//							КонецЕсли;
//							Если ЗначениеЗаполнено(СтруктураАдреса.Корпус) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Корпус",  Строка(СтруктураАдреса.Корпус));
//							КонецЕсли;
//							Если ЗначениеЗаполнено(СтруктураАдреса.Кварт) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Кварт",  Строка(СтруктураАдреса.Кварт));
//							КонецЕсли;
//							ЗаписьXML.ЗаписатьКонецЭлемента();//-АдрРФ
//							ЗаписьXML.ЗаписатьКонецЭлемента();//-Адрес
//							
//							СведенияОПокупатель = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыборкаДокумент.Контрагент,  ВыборкаДокумент.Дата);
//							
//							ЗаписьXML.ЗаписатьНачалоЭлемента("Контакт");//+Контакт
//							Если ЗначениеЗаполнено(СведенияОПокупатель.Телефоны) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "Тлф",  Лев(СведенияОПокупатель.Телефоны,20));
//							КонецЕсли;	
//							ЭлПочта = УправлениеЭлектроннойПочтой.ОпределитьАдресПолучателя(ВыборкаДокумент.Контрагент);
//							Если ЗначениеЗаполнено(ЭлПочта) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "ЭлПочта", ЭлПочта);
//							КонецЕсли;
//							ЗаписьXML.ЗаписатьКонецЭлемента();//-Контакт
//							
//							ЗаписьXML.ЗаписатьНачалоЭлемента("БанкРекв");//+БанкРекв
//							Если ЗначениеЗаполнено(СведенияОПокупатель.НомерСчета) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "НомерСчета", СведенияОПокупатель.НомерСчета);
//							КонецЕсли;	   
//							ЗаписьXML.ЗаписатьНачалоЭлемента("СвБанк");//+СвБанк
//							Если ЗначениеЗаполнено(СведенияОПокупатель.БИК) Тогда
//								ЗаписьXML.ЗаписатьАтрибут( "НаимБанк", СведенияОПокупатель.Банк.Наименование);
//								ЗаписьXML.ЗаписатьАтрибут( "БИК", СведенияОПокупатель.БИК);
//								ЗаписьXML.ЗаписатьАтрибут( "КорСчет", СведенияОПокупатель.КоррСчет);
//							КонецЕсли;	 
//							ЗаписьXML.ЗаписатьКонецЭлемента();//-СвБанк
//							ЗаписьXML.ЗаписатьКонецЭлемента();//-БанкРекв
//				ЗаписьXML.ЗаписатьКонецЭлемента();//-СвПокуп
//				
//				ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ1");//+ИнфПолФХЖ1
//					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
//					ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "отправитель");
//					
//					
//					//{Лео Катанович
//					Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
//						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
//						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
//						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
//						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
//						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
//				 		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
//						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
//						 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
//						 
//						 ЗаписьXML.ЗаписатьАтрибут( "Значен", "4607932679999");
//					Иначе
//						ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.GLNОрганизации));
//					КонецЕсли;   
//					//	Лео Катанович}
//			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
//					
//					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
//						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "получатель");
//						Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") Тогда // АТАК ООО
//							ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
//						Иначе
//							ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNКонтрагента));
//						КонецЕсли;
//			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
//					
//			// --------------------------------------------------------------------------------------------------
//					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
//						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузоотправитель");
//			 			//ЗаписьXML.ЗаписатьАтрибут( "Значен",  "4607932679999");
//						ЗаписьXML.ЗаписатьАтрибут( "Значен",  СокрЛП(ВыборкаДокумент.Грузоотправитель.абс_GLN));
//			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
//					
//					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
//						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "грузополучатель");
//			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
//			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

//					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
//						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
//			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
//			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
//					
//					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
//						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_поставщика");
//					 	ЗаписьXML.ЗаписатьАтрибут( "Значен",УдалитьЛидирующиеНули(ВыборкаДокумент.КодПоставщика));
//			 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
//					
//					ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
//						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_заказа");
//						ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ВыборкаДокумент.ДатаДокументаEDI,"ДФ=дд.ММ.гггг"));
//					ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
//	
//					Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") Тогда     // Тандер
//						 ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
//								ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_поставки");
//			 					ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ВыборкаДокумент.ДатаПоставки,"ДФ=дд.ММ.гггг"));
//			 			 ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
//					 КонецЕсли;	
//					 
//					 ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
//								ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_накладной");
//							ЗаписьXML.ЗаписатьАтрибут( "Значен",СОКРЛП(ВыборкаДокумент.Номер));
//					 ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
//					 ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
//								ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "дата_накладной");
//							ЗаписьXML.ЗаписатьАтрибут( "Значен",Формат(ВыборкаДокумент.Дата,"ДФ=дд.ММ.гггг"));
//					 ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф

//					 
//					 ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
//						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "документ_основание");
//			 			ЗаписьXML.ЗаписатьАтрибут( "Значен",Строка(ДокументОтгрузки.УникальныйИдентификатор()));
//			 		 ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф
//					 
//					 ЗаписьXML.ЗаписатьНачалоЭлемента("ТекстИнф");//+ТекстИнф
//						ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_акта");
//						ЗаписьXML.ЗаписатьАтрибут( "Значен", ?(ЗначениеЗаполнено(ДокументОтгрузки.абс_НомерУведомленияОПриемке),ДокументОтгрузки.абс_НомерУведомленияОПриемке,"б/н"));
//			 		 ЗаписьXML.ЗаписатьКонецЭлемента();//-ТекстИнф


//			ЗаписьXML.ЗаписатьКонецЭлемента(); //-ИнфПолФХЖ1
//				
//			ЗаписьXML.ЗаписатьКонецЭлемента();//-СвКСчФ
//			
//			// --------------------ТАБЛИЧНАЯ ЧАСТЬ---------------------
//			
//			Корректировочный = Выборка.Ссылка.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыВыставленного.Корректировочный;

//			
//			ДанныеДляФормированияЭД = Неопределено;
//			Для Каждого СтрДокОснования Из Выборка.Ссылка.ДокументыОснования Цикл
//				
//				Если НЕ ЗначениеЗаполнено(СтрДокОснования.ДокументОснование) Тогда
//					Продолжить;
//				КонецЕсли;
//				
//				мВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
//				ЭкземплярДанныхДляПечати = Неопределено;
//				
//				//Если  Корректировочный Тогда
//					ЭкземплярДанныхДляПечати = СобратьДанныеДляПечатиКорректировочногоСчетаФактуры(СтрДокОснования.ДокументОснование, Выборка.Ссылка);
//				//Иначе
//				//	ЭкземплярДанныхДляПечати = СобратьДанныеДляПечатиИсправленияСчетаФактуры(СтрДокОснования.ДокументОснование, Выборка.Ссылка);
//				//КонецЕсли;
//				//
//				
//				// Заполнение данных для печати
//				Если ДанныеДляФормированияЭД = Неопределено Тогда
//					ДанныеДляФормированияЭД = ЭкземплярДанныхДляПечати;
//				Иначе
//					
//					Для каждого СтрДанных Из ЭкземплярДанныхДляПечати Цикл
//						
//						Если СтрДанных.Ключ = "ТабличнаяЧасть" Тогда
//							СтараяТабЧасть = ДанныеДляФормированияЭД.ТабличнаяЧасть;
//							НоваяТабЧасть  = СтрДанных.Значение;
//							
//							Для каждого НоваяСтрокаТабЧасти Из НоваяТабЧасть Цикл
//								СтрокаТабЧасти = СтараяТабЧасть.Добавить();
//								Для каждого ТекКол Из НоваяТабЧасть.Колонки Цикл
//									Если СтараяТабЧасть.Колонки.Найти(ТекКол.Имя) <> Неопределено Тогда
//										СтрокаТабЧасти[ТекКол.Имя] = НоваяСтрокаТабЧасти[ТекКол.Имя];
//									КонецЕсли;
//								КонецЦикла;
//							КонецЦикла;
//							
//						ИначеЕсли НЕ ДанныеДляФормированияЭД.Свойство(СтрДанных.Ключ) Тогда
//							// Если данный параметр для печати шапки документа еще не  определен - то определяем его
//							ДанныеДляФормированияЭД.Вставить(СтрДанных.Ключ, СтрДанных.Значение);
//							
//						КонецЕсли;
//						
//					КонецЦикла;
//					
//				КонецЕсли;
//				
//			КонецЦикла;	
//			
//	
//	Если  ДанныеДляФормированияЭД <> Неопределено Тогда
//		
//		КолонкиГруппировок = ""
//		+"Номенклатура,"
//		+"НаименованиеТовара,"
//		+"Серия,"
//		+"Характеристика,"
//		+"НаименованиеЕдиницыИзмерения,"
//		+"ЕдиницаИзмеренияКод,"
//		+"ЦенаДоИзменения,"	
//		+"ЦенаПослеИзменения,"
//		+"СтавкаНДС,"
//		+"СтавкаНДСДоИзменения,"
//		+"СтавкаНДСПослеИзменения,"
//		+"НомерСтроки,"
//		+"Штрихкод";
//		
//		КолонкиСуммирования = ""
//		+"СуммаНДСДоИзменения,"
//		+"СуммаНДСПослеИзменения,"
//		+"СтоимостьСНДСДоИзменения,"
//		+"СтоимостьСНДСПослеИзменения,"
//		+"РазницаБезНДСУвеличение,"
//		+"РазницаБезНДСУменьшение,"
//		+"РазницаНДСУвеличение,"
//		+"РазницаНДСУменьшение,"
//		+"РазницаСНДСУвеличение,"
//		+"РазницаСНДСУменьшение,"
//		+"СтоимостьБезНДСДоИзменения,"
//		+"СтоимостьБезНДСПослеИзменения,"
//		+"КоличествоДоИзменения,"
//		+"КоличествоПослеИзменения";
//		
//		ДанныеДляФормированияЭД.ТабличнаяЧасть.Свернуть(КолонкиГруппировок, КолонкиСуммирования);
//		
//	КонецЕсли; 
//	
//	
//	
//	
//	ТЗ_ТаблицаТоваров =  ДанныеДляФормированияЭД.ТабличнаяЧасть.Скопировать();
//	ТЗ_ТаблицаТоваров.Свернуть("Номенклатура");
//	ТаблицаТоваров = ТЗ_ТаблицаТоваров.ВыгрузитьКолонку("Номенклатура");
//	
//	МассивИсключений = Новый Массив;
//	МассивИсключений.Добавить("*");
//	Запрос = новый Запрос;
//	Запрос.Текст = "ВЫБРАТЬ
//				   |	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК АртикулПокупателя,
//				   |	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
//				   |ИЗ
//				   |	РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(
//				   |			&Дата,
//				   |			Номенклатура В ИЕРАРХИИ (&Номенклатура)
//				   |				И Контрагент = &Контрагент
//				   |				И Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя)) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
//				   |ГДЕ
//				   |	НЕ абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства В (&МассивИсключений)";
//	
// 
//	Запрос.УстановитьПараметр("Дата", ВыборкаДокумент.Дата);
//  	Запрос.УстановитьПараметр("Номенклатура", ТаблицаТоваров);
//	Запрос.УстановитьПараметр("МассивИсключений", МассивИсключений);
//	Запрос.УстановитьПараметр("Контрагент", ДанныеДляФормированияЭД.Покупатель);

//	ТаблицаДопСведений = Запрос.Выполнить().Выгрузить();
//			ЗаписьXML.ЗаписатьНачалоЭлемента("ТаблКСчФ");//+ТаблКСчФ
//			сч = 1;
//				Для каждого ВыборкаСтрока из ДанныеДляФормированияЭД.ТабличнаяЧасть Цикл
//					ЗаписьXML.ЗаписатьНачалоЭлемента("СведТов");//+СведТов	
//						ЗаписьXML.ЗаписатьАтрибут( "НомСтр",Строка(сч));
//			 			ЗаписьXML.ЗаписатьАтрибут( "НаимТов", ВыборкаСтрока.НаименованиеТовара);
//						ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_ТовДо","796");
//						ЗаписьXML.ЗаписатьАтрибут( "ОКЕИ_ТовПосле","796");
//						 
//						ЗаписьXML.ЗаписатьАтрибут( "КолТовДо",    Формат(ВыборкаСтрока.КоличествоДоИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//						ЗаписьXML.ЗаписатьАтрибут( "КолТовПосле", Формат(ВыборкаСтрока.КоличествопослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
// 						
//						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТовДо",    Формат(ВыборкаСтрока.ЦенаДоИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//						ЗаписьXML.ЗаписатьАтрибут( "ЦенаТовПосле", Формат(ВыборкаСтрока.ЦенаПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));

//						ЗаписьXML.ЗаписатьАтрибут( "НалСтДо",    Строка(УчетНДС.ПолучитьСтавкуНДС(ВыборкаСтрока.СтавкаНДСДоИзменения)) + "%");
//						ЗаписьXML.ЗаписатьАтрибут( "НалСтПосле", Строка(УчетНДС.ПолучитьСтавкуНДС(ВыборкаСтрока.СтавкаНДСПослеИзменения)) + "%" );
//						
//						ЗаписьXML.ЗаписатьНачалоЭлемента("СтТовБезНДС");
//							ЗаписьXML.ЗаписатьАтрибут("СтоимДоИзм", Формат(ВыборкаСтрока.СтоимостьБезНДСДоИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//							ЗаписьXML.ЗаписатьАтрибут("СтоимПослеИзм", Формат(ВыборкаСтрока.СтоимостьБезНДСПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//							
//							
//							Если ВыборкаСтрока.РазницаБезНДСУменьшение > 0 Тогда
//								ЗаписьXML.ЗаписатьАтрибут("СтоимУм", Формат(ВыборкаСтрока.РазницаБезНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//							Иначе
//								ЗаписьXML.ЗаписатьАтрибут("СтоимУвел", Формат(ВыборкаСтрока.РазницаБезНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//							КонецЕсли;	   
//						ЗаписьXML.ЗаписатьКонецЭлемента();//-СтТовБезНДС
//						
//						 ЗаписьXML.ЗаписатьНачалоЭлемента("АкцизДо"); //+АкцизДо
//								   ЗаписьXML.ЗаписатьНачалоЭлемента("БезАкциз"); //+БезАкциз
//								   ЗаписьXML.ЗаписатьТекст("без акциза");
//								   ЗаписьXML.ЗаписатьКонецЭлемента();// -БезАкциз
//						 ЗаписьXML.ЗаписатьКонецЭлемента();//АкцизДо
//						 
//						 ЗаписьXML.ЗаписатьНачалоЭлемента("АкцизПосле"); //+АкцизПосле
//								   ЗаписьXML.ЗаписатьНачалоЭлемента("БезАкциз"); //+БезАкциз
//								   ЗаписьXML.ЗаписатьТекст("без акциза");
//								   ЗаписьXML.ЗаписатьКонецЭлемента();// -БезАкциз
//						 ЗаписьXML.ЗаписатьКонецЭлемента();//АкцизПосле
//						 
//						 ЗаписьXML.ЗаписатьНачалоЭлемента("АкцизРазн");//+АкцизРазн
//  								   ЗаписьXML.ЗаписатьНачалоЭлемента("СумУвел"); //+ СумУвел
//								   ЗаписьXML.ЗаписатьТекст("0");
//								   ЗаписьXML.ЗаписатьКонецЭлемента(); //- СумУвел
//						 ЗаписьXML.ЗаписатьКонецЭлемента();//-АкцизРазн

//						  ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалДо");//+СумНалДо
//								   ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); //+СумНДС
//								   ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаСтрока.СуммаНДСДоИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//								   ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС		
//						 ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНалДо

//						 ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалПосле");//+СумНалПосле
//								   ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); //+СумНДС
//								   ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаСтрока.СуммаНДСПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//								   ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС		   
//						 ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНалПосле
//						 
//						 ЗаписьXML.ЗаписатьНачалоЭлемента("СумНалРазн");//+СумНалРазн
//						 Если ВыборкаСтрока.РазницаНДСУменьшение > 0 Тогда
//							  ЗаписьXML.ЗаписатьНачалоЭлемента("СумУм"); //+СумУм
//									 ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаСтрока.РазницаНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СумУм		 		 
//						 Иначе
//							  ЗаписьXML.ЗаписатьНачалоЭлемента("СумУвел"); //+СумУвел
//									ЗаписьXML.ЗаписатьТекст(Формат(ВыборкаСтрока.РазницаНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//							  ЗаписьXML.ЗаписатьКонецЭлемента();//-СумУвел			 
//						КонецЕсли;	   
//						 ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНалРазн
//						 
//						 ЗаписьXML.ЗаписатьНачалоЭлемента("СтТовУчНал");//+СтТовУчНал
//								   ЗаписьXML.ЗаписатьАтрибут("СтоимДоИзм", Формат(ВыборкаСтрока.СтоимостьСНДСДоИзменения,"ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН=")); 
//								   ЗаписьXML.ЗаписатьАтрибут("СтоимПослеИзм", Формат(ВыборкаСтрока.СтоимостьСНДСПослеИзменения, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//								 Если ВыборкаСтрока.РазницаСНДСУменьшение > 0 Тогда
//									 ЗаписьXML.ЗаписатьАтрибут("СтоимУм", Формат(ВыборкаСтрока.РазницаСНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//								 Иначе
//									 ЗаписьXML.ЗаписатьАтрибут("СтоимУвел", Формат(ВыборкаСтрока.РазницаСНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//								 КонецЕсли;	  
//						 ЗаписьXML.ЗаписатьКонецЭлемента();//-СтТовУчНал
//						 
//						 
//						 //////////////
//						 
//	 СтрокаДопСведений = ТаблицаДопСведений.Найти(ВыборкаСтрока.Номенклатура,"Номенклатура");
//						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолСтр
//							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "код_материала");
//							ЗаписьXML.ЗаписатьАтрибут( "Значен",?(СтрокаДопСведений = Неопределено,"",СтрокаДопСведений.АртикулПокупателя));
//					   ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

//						ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолФХЖ2
//							ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "штрихкод");
//							ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаСтрока.Штрихкод));
//				 		ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолФХЖ2

//						 
//										
//					ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолФХЖ2");//+ИнфПолСтр
//									ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_заказа");
//								ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ВыборкаДокумент.НомерДокументаEDIЗаказа));
//					 ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

//					//	
//					//	ЗаписьXML.ЗаписатьНачалоЭлемента("ИнфПолСтр");//+ИнфПолСтр
//					//		ЗаписьXML.ЗаписатьАтрибут( "Идентиф", "номер_накладной");
//					//		ЗаписьXML.ЗаписатьАтрибут( "Значен", СокрЛП(ДокументПродажи.Номер));
//					//ЗаписьXML.ЗаписатьКонецЭлемента();//-ИнфПолСтр

//					ЗаписьXML.ЗаписатьНачалоЭлемента("ДопСведТов");//+ДопСведТов
//					ЗаписьXML.ЗаписатьКонецЭлемента();//-ДопСведТов

//							ЗаписьXML.ЗаписатьКонецЭлемента();//-СведТов
//					сч = сч + 1;
//				КонецЦикла;
//				
//				// Итоги документа
//					ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоУвел"); //+ ВсегоУвел

//						ЗаписьXML.ЗаписатьАтрибут("СтТовБезНДСВсего", Формат(Выборка.ССылка.СуммаУвеличение - Выборка.ССылка.СуммаНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//						ЗаписьXML.ЗаписатьАтрибут("СтТовУчНалВсего", Формат(Выборка.ССылка.СуммаУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//						
//						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал"); // + СумНал
//						   ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); // + СумНДС
//								 ЗаписьXML.ЗаписатьТекст(Формат(Выборка.ССылка.СуммаНДСУвеличение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//							ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС
//						ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНал
//					ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоУвел
//					
//					ЗаписьXML.ЗаписатьНачалоЭлемента("ВсегоУм"); //+ ВсегоУм
//						ЗаписьXML.ЗаписатьАтрибут("СтТовУчНалВсего", Формат(Выборка.ССылка.СуммаУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//						ЗаписьXML.ЗаписатьАтрибут("СтТовБезНДСВсего", Формат(Выборка.ССылка.СуммаУменьшение - Выборка.ССылка.СуммаНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//						
//						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНал"); // + СумНал
//						ЗаписьXML.ЗаписатьНачалоЭлемента("СумНДС"); // + СумНДС
//								  ЗаписьXML.ЗаписатьТекст(Формат(Выборка.ССылка.СуммаНДСУменьшение, "ЧДЦ=2; ЧРД=.; ЧГ=0; ЧН="));
//						ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНал

//						ЗаписьXML.ЗаписатьКонецЭлемента();//-СумНДС
//					ЗаписьXML.ЗаписатьКонецЭлемента();//-ВсегоУм	
//					
//				ЗаписьXML.ЗаписатьКонецЭлемента();//-ТаблКСчФ

//				ЗаписьXML.ЗаписатьНачалоЭлемента("СодФХЖ3");//+СодФХЖ3	
//						  ЗаписьXML.ЗаписатьАтрибут("ПередатДокум","КСФ " + НомерСФ + " от " + ДатаСФ);       
//						  ЗаписьXML.ЗаписатьАтрибут("СодОпер", "Уведомляю об изменении стоимости");
//						  ЗаписьXML.ЗаписатьАтрибут("ДатаНапр", Формат(ДатаСФ,"ДФ=дд.ММ.гггг"));
//						
//					  ЗаписьXML.ЗаписатьНачалоЭлемента("ОснКор");//+ОснКор	
//						  ЗаписьXML.ЗаписатьАтрибут("НаимОсн", ДокументОтгрузки.ДоговорКонтрагента.Наименование);
//						  ЗаписьXML.ЗаписатьАтрибут( "НомОсн", ВыборкаДокумент.ДоговорКонтрагента.Номер);
//						   ЗаписьXML.ЗаписатьАтрибут("ДатаОсн",Формат(ДокументОтгрузки.Дата,"ДФ=дд.ММ.гггг"));
//					   ЗаписьXML.ЗаписатьКонецЭлемента();//-ОснКор	
//					   
//				ЗаписьXML.ЗаписатьКонецЭлемента();//-СодФХЖ3	

//			//Руководители = ОбщегоНазначения.ОтветственныеЛица(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата,);
//			
//			ЗаписьXML.ЗаписатьНачалоЭлемента("Подписант");//+Подписант
//				ЗаписьXML.ЗаписатьАтрибут( "ОблПолн",  "6");
//				ЗаписьXML.ЗаписатьАтрибут( "Статус",   "1");
//				ЗаписьXML.ЗаписатьАтрибут( "ОснПолн",  "Должностные обязанности");
//			
//			ЗаписьXML.ЗаписатьНачалоЭлемента("ЮЛ");//+ЮЛ
//					ЗаписьXML.ЗаписатьАтрибут( "ИННЮЛ", ВыборкаДокумент.Организация.ИНН);
//					СтруктураПодписант = ОтветственныйПоЭДО(ВыборкаДокумент.Организация, ВыборкаДокумент.Дата);
//					
//			 		ЗаписьXML.ЗаписатьАтрибут( "Должн", СтруктураПодписант.Должность);
//					ЗаписьXML.ЗаписатьНачалоЭлемента("ФИО"); //+ФИО
//						ЗаписьXML.ЗаписатьАтрибут( "Фамилия", СтруктураПодписант.Фамилия);  
//			 			ЗаписьXML.ЗаписатьАтрибут( "Имя", СтруктураПодписант.Имя); 
//						ЗаписьXML.ЗаписатьАтрибут( "Отчество", СтруктураПодписант.Отчество); 
//					ЗаписьXML.ЗаписатьКонецЭлемента();//-ФИО
//			
//			ЗаписьXML.ЗаписатьКонецЭлемента();//-ЮЛ
//			ЗаписьXML.ЗаписатьКонецЭлемента();//-Подписант
//			
//		ЗаписьXML.ЗаписатьКонецЭлемента();//-Документ
//	ЗаписьXML.ЗаписатьКонецЭлемента();//-файл
//	ТекстXML=ЗаписьXML.Закрыть();
//	
//	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//	
//	СтруктураПараметров = Новый Структура;
//	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.СчетФактура);
//	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
//	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
//	СтруктураПараметров.Вставить("GLNПокупателя"			, ВыборкаДокумент.GLNКонтрагента);
//	
//	//{Лео Катанович
//	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
//		 
//		 СтруктураПараметров.Вставить("GLNПоставщика"			, "4607932679999");
//	  Иначе
//		 СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
//	КонецЕсли;   
//	//	Лео Катанович}
//	
//	//Если ДокументОтгрузки.Организация.Код = "О00000001" Тогда
//	//	СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su);
//	//ИначеЕсли ДокументОтгрузки.Организация.Код = "О00000003" Тогда
//	//	СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit);
//	//КонецЕсли;
//		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.НайтиПоНаименованию("Контур"));
//	// Справочники.абс_НастройкиEDIОбмена.НайтиПоНаименованию("Контур")
//	 
//	 
//	 
//	СтруктураПараметров.Вставить("ДокументОснование"		, ДокументОтгрузки);
//	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерДокументаEDIЗаказа);
//	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаДокументаEDI);
//	
//	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
//	
//КонецПроцедуры


//Лео Катанович}

//Процедура ВыгрузитьПодтверждениеЗаказа(ЗаказПокупателя, ЕстьОшибки = Ложь) Экспорт
//	
//	ЗапросДокумент = Новый Запрос;
//	ЗапросДокумент.Текст = 
//	"ВЫБРАТЬ
//	|	ЗаказПокупателя.ДокументОснование.НомерДокументаEDIЗаказа КАК НомерЗаказаEDI,
//	|	ЗаказПокупателя.ДокументОснование.ДатаДокументаEDI КАК ДатаЗаказаEDI,
//	|	ЗаказПокупателя.абс_ДатаПоставкиВТЦ КАК ДатаПоставкиВТЦ,
//	|	ЗаказПокупателя.Контрагент.абс_GLN КАК GLNКонтрагента,
//	|	ЗаказПокупателя.Организация.абс_GLN КАК GLNОрганизации,
//	|	ЗаказПокупателя.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
//	|	ЗаказПокупателя.Дата КАК ДатаЗаказаПокупателя,
//	|	ЗаказПокупателя.Лео_ДатаВремяПрибытияТранспортаПолучателю,
//	|	ПРЕДСТАВЛЕНИЕ(ЗаказПокупателя.ДоговорКонтрагента) КАК ДоговорКонтрагента,
//	|	ЗаказПокупателя.Лео_ПодтвержденнаяДатаДоставки КАК ПодтвержденнаяДатаДоставки,
//	|	ЗаказПокупателя.Лео_НазваниеРампыРазгрузки,
//	|	ЗаказПокупателя.Контрагент
//	|ИЗ
//	|	Документ.ЗаказПокупателя КАК ЗаказПокупателя
//	|ГДЕ
//	|	ЗаказПокупателя.Ссылка = &Ссылка";
//	
//	ЗапросДокумент.УстановитьПараметр("Ссылка", ЗаказПокупателя);
//	
//	ЗапросТовары = Новый Запрос;
//	ЗапросТовары.Текст = 
//	"ВЫБРАТЬ
//	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
//	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
//	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
//	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК Свойство,
//	|	ВложенныйЗапрос.Номенклатура КАК Номенклатура,
//	|	СУММА(ВложенныйЗапрос.Количество) КАК Количество,
//	|	ВложенныйЗапрос.Цена КАК Цена,
//	|	ВложенныйЗапрос.СтавкаНДС КАК СтавкаНДС,
//	|	ВложенныйЗапрос.СуммаВключаетНДС КАК СуммаВключаетНДС,
//	|	ВложенныйЗапрос.ТипЦенЦенаВключаетНДС КАК ТипЦенЦенаВключаетНДС,
//	|	ВложенныйЗапрос.Лео_ЦенаСУчетомСкидки КАК Лео_ЦенаСУчетомСкидки,
//	|	ВложенныйЗапрос.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
//	|	ВложенныйЗапрос.Сумма КАК Сумма,
//	|	ВложенныйЗапрос.СуммаНДС КАК СуммаНДС,
//	|	ВложенныйЗапрос.Ссылка,
//	|	ВложенныйЗапрос.Лео_ПричиныНеотгрузкиEDI КАК ПричиныНеотгрузкиEDI
//	|ПОМЕСТИТЬ ЗаказПокупателя
//	|ИЗ
//	|	(ВЫБРАТЬ
//	|		ЗаказПокупателяТовары.Номенклатура КАК Номенклатура,
//	|		ЗаказПокупателяТовары.Количество КАК Количество,
//	|		ЗаказПокупателяТовары.Цена КАК Цена,
//	|		ЗаказПокупателяТовары.СтавкаНДС КАК СтавкаНДС,
//	|		ЗаказПокупателяТовары.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
//	|		ЗаказПокупателяТовары.Ссылка.ТипЦен.ЦенаВключаетНДС КАК ТипЦенЦенаВключаетНДС,
//	|		ЗаказПокупателяТовары.Лео_ЦенаСУчетомСкидки КАК Лео_ЦенаСУчетомСкидки,
//	|		ЗаказПокупателяТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
//	|		ЗаказПокупателяТовары.Сумма КАК Сумма,
//	|		ЗаказПокупателяТовары.СуммаНДС КАК СуммаНДС,
//	|		ЗаказПокупателяТовары.Ссылка КАК Ссылка,
//	|		"""" КАК Поле1,
//	|		NULL КАК Лео_ПричиныНеотгрузкиEDI
//	|	ИЗ
//	|		Документ.ЗаказПокупателя.Товары КАК ЗаказПокупателяТовары
//	|	ГДЕ
//	|		ЗаказПокупателяТовары.Ссылка = &Ссылка
//	|	
//	|	ОБЪЕДИНИТЬ ВСЕ
//	|	
//	|	ВЫБРАТЬ
//	|		ЗаказПокупателяабс_Неотгружено.Номенклатура,
//	|		ЗаказПокупателяабс_Неотгружено.Количество,
//	|		ЗаказПокупателяабс_Неотгружено.Цена,
//	|		ЗаказПокупателяабс_Неотгружено.СтавкаНДС,
//	|		ЗаказПокупателяабс_Неотгружено.Ссылка.СуммаВключаетНДС,
//	|		ЗаказПокупателяабс_Неотгружено.Ссылка.ТипЦен.ЦенаВключаетНДС,
//	|		ЗаказПокупателяабс_Неотгружено.Цена,
//	|		ЗаказПокупателяабс_Неотгружено.ЕдиницаИзмерения,
//	|		ЗаказПокупателяабс_Неотгружено.Сумма,
//	|		ЗаказПокупателяабс_Неотгружено.СуммаНДС,
//	|		ЗаказПокупателяабс_Неотгружено.Ссылка,
//	|		NULL,
//	|		ЗаказПокупателяабс_Неотгружено.Лео_ПричиныНеотгрузкиEDI.Код
//	|	ИЗ
//	|		Документ.ЗаказПокупателя.абс_Неотгружено КАК ЗаказПокупателяабс_Неотгружено
//	|	ГДЕ
//	|		ЗаказПокупателяабс_Неотгружено.Ссылка = &Ссылка) КАК ВложенныйЗапрос
//	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(, Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя)) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
//	|		ПО ВложенныйЗапрос.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
//	|			И ВложенныйЗапрос.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
//	|
//	|СГРУППИРОВАТЬ ПО
//	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства,
//	|	ВложенныйЗапрос.Номенклатура,
//	|	ВложенныйЗапрос.Цена,
//	|	ВложенныйЗапрос.СтавкаНДС,
//	|	ВложенныйЗапрос.СуммаВключаетНДС,
//	|	ВложенныйЗапрос.ТипЦенЦенаВключаетНДС,
//	|	ВложенныйЗапрос.Лео_ЦенаСУчетомСкидки,
//	|	ВложенныйЗапрос.ЕдиницаИзмерения,
//	|	ВложенныйЗапрос.Сумма,
//	|	ВложенныйЗапрос.СуммаНДС,
//	|	ВложенныйЗапрос.Ссылка,
//	|	ВложенныйЗапрос.Лео_ПричиныНеотгрузкиEDI
//	|;
//	|
//	|////////////////////////////////////////////////////////////////////////////////
//	|ВЫБРАТЬ
//	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
//	|	Заказ.Свойство КАК АртикулПокупателя
//	|ИЗ
//	|	ЗаказПокупателя КАК Заказ
//	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
//	|		ПО Заказ.ТипШтрихКода = Штрихкоды.ТипШтрихкода
//	|			И Заказ.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
//	|			И (Штрихкоды.СерияНоменклатуры = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка))
//	|
//	|СГРУППИРОВАТЬ ПО
//	|	Заказ.Свойство";
//	
//	ЗапросТовары.УстановитьПараметр("Ссылка", ЗаказПокупателя);
//	
//	ВыборкаДокумент = ЗапросДокумент.Выполнить().Выбрать();
//	ВыборкаДокумент.Следующий();
//	
//	НомерЗаказаПокупателя = ОбщегоНазначения.ПолучитьНомерНаПечать(ЗаказПокупателя);
//	
//	Отказ = Ложь;
//	
//	ИмяФайла = СформироватьИмяФайлаEDI("Ordrsp_"+Формат(ВыборкаДокумент.ДатаЗаказаEDI,"ДФ=ггггММдд")+"_"+СокрЛП(ВыборкаДокумент.НомерЗаказаEDI)) + ".xml";
//	Запись = Новый ЗаписьXML;
//	Запись.УстановитьСтроку("UTF-8");
//	Запись.ЗаписатьОбъявлениеXML();
//	
//	Запись.ЗаписатьНачалоЭлемента("ORDRSP");
//	
//	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.НомерЗаказаEDI)							, "NUMBER");		//Номер подтверждения заказа 
//	ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ДатаЗаказаПокупателя, "ДФ=гггг-ММ-дд")	, "DATE"); 			//дата документа
//	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.НомерЗаказаEDI)							, "ORDERNUMBER"); 	//номер заказа
//	ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ДатаЗаказаEDI, 		 "ДФ=гггг-ММ-дд")	, "ORDERDATE"); 	//дата заказа
//	Если НЕ ВыборкаДокумент.ПодтвержденнаяДатаДоставки  = Дата('00010101000000') Тогда
//		ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ПодтвержденнаяДатаДоставки,		"ДФ=гггг-ММ-дд")	, "DELIVERYDATE"); 	//дата поставки
//	Иначе
//		ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ДатаПоставкиВТЦ,		"ДФ=гггг-ММ-дд")	, "DELIVERYDATE"); 	//дата поставки

//	КонецЕсли;
//	// {Лео Катанович
//	
//	ВыборкаТовары = ЗапросТовары.Выполнить().Выбрать();

//	Пока ВыборкаТовары.Следующий() Цикл
//		Если ВыборкаТовары.ПричиныНеотгрузкиEDI Тогда
//			 ЗаписатьXML(Запись, ""	, "REASONDECREACEQUANTITYALL"); 	//дата заказа			 
//			 Прервать;
//		КонецЕсли;	
//	КонецЦикла;	



//	
//	//+Лео Сафонов ЕА 17.03.2016
//	Запись.ЗаписатьНачалоЭлемента("LIMES");
//		ЗаписатьXML(Запись, ВыборкаДокумент.Лео_НазваниеРампыРазгрузки		, "LIMESNAME"); //Название рампы
//		ЗаписатьXML(Запись, Формат(ВыборкаДокумент.Лео_ДатаВремяПрибытияТранспортаПолучателю,"ДФ=гггг-ММ-дд")		, "DATEFROM"); //Дата прибытия транспорта
//		ЗаписатьXML(Запись, Формат(ВыборкаДокумент.Лео_ДатаВремяПрибытияТранспортаПолучателю,"ДФ=ЧЧ:мм")			, "TIMEFROM"); //Время прибытия транспорта
//	Запись.ЗаписатьКонецЭлемента();
//	//-Лео Сафонов ЕА 17.03.2016
//	ЗаписатьXML(Запись, "29"															, "ACTION"); 		//4 — поставка изменена, 5 — замена документа, 29 — поставка принята, 27 — поставка не принята 
//	//{Лео Катанович  05.04.2016
//	ЗаписатьXML(Запись, ""															    , "INFO"); 		
//	ЗаписатьXML(Запись, ВыборкаДокумент.ДоговорКонтрагента						        , "CAMPAIGNNUMBER"); //Договор контрагента 		
//	//Лео Катанович  05.04.2016}
//	
//	Запись.ЗаписатьНачалоЭлемента("HEAD");
//	
//	ГрузополучательЯвляетсяПлательщиком = абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ЗаказПокупателя.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.абс_ГрузополучательЯвляетсяПлательщиком);
//	
//	GLNПокупателя = СокрЛП(ВыборкаДокумент.GLNКонтрагента);
//	
//	//Если ГрузополучательЯвляетсяПлательщиком = Истина Тогда
//	//	GLNПокупателя = СокрЛП(ВыборкаДокумент.GLNГрузополучателя);
//	//КонецЕсли;
//	
//	
//	//+Лео Сафонов ЕА Хардкод. Исключение из общих правил GLN для Билла и Гиперглобус
//	Если ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("") Тогда ////////////////////////////////////////////////Билла
//		ЗаписатьXML(Запись, GLNПокупателя								, "BUYER"); 			//GLN покупателя	
//		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNОрганизации)		, "SUPPLIER"); 			//GLN поставщика	
//		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "DELIVERYPLACE"); 	//GLN места доставки
//		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNОрганизации)		, "SENDER"); 			//GLN отправителя сообщения	
//		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "RECIPIENT"); 		//GLN получателя сообщения	
//		ЗаписатьXML(Запись, СокрЛП(НомерЗаказаПокупателя)				, "EDIINTERCHANGEID"); 	//номер транзакции
//	ИначеЕсли ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("") Тогда ///////////////////////////////////////////Гиперглобус
//		ЗаписатьXML(Запись, GLNПокупателя								, "BUYER"); 			//GLN покупателя	
//		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNОрганизации)		, "SUPPLIER"); 			//GLN поставщика	
//		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "DELIVERYPLACE"); 	//GLN места доставки
//		ЗаписатьXML(Запись, "4690202000005"								, "INVOICEPARTNER"); 	//GLN плательщика
//		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNОрганизации)		, "SENDER"); 			//GLN отправителя сообщения	
//		ЗаписатьXML(Запись, "4690202000005"								, "RECIPIENT"); 		//GLN получателя сообщения	
//		ЗаписатьXML(Запись, СокрЛП(НомерЗаказаПокупателя)				, "EDIINTERCHANGEID"); 	//номер транзакции
//	Иначе /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////Общие правила
//		ЗаписатьXML(Запись, GLNПокупателя								, "BUYER"); 			//GLN покупателя	
//		
//	//{Лео Катанович
//	Если ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
//		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
//		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
//		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
//		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
//		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
//		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
//		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
//		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
//		 
//		 ЗаписатьXML(Запись,"4607932679999"			, "SUPPLIER"); 			                   //GLN поставщика	
//	Иначе
//		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNОрганизации)		, "SUPPLIER"); 		   //GLN поставщика	
//	КонецЕсли;
//	// Лео Катанович}
//		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "DELIVERYPLACE"); 	//GLN места доставки
//		ЗаписатьXML(Запись, GLNПокупателя								, "INVOICEPARTNER"); 	//GLN плательщика
//		
//			//{Лео Катанович
//		Если ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ    //Билла
//			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098")  ИЛИ    // Тандер
//			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415")  ИЛИ    // Новый импульс
//			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293")  ИЛИ    // ТД ПЕРЕКРЕСТОК АО
//			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846")  ИЛИ    // Копейка-Москва ООО
//			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035")  ИЛИ    // Агроторг ООО
//			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475")  ИЛИ    // Зельгрос ООО
//			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166")  ИЛИ    // АТАК ООО
//			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040")  Тогда  // ДИКСИ ООО
//			
//			ЗаписатьXML(Запись, "4607932679999"		, "SENDER"); 			                       //GLN отправителя сообщения	
//		Иначе
//		   ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNОрганизации)		, "SENDER"); 			//GLN отправителя сообщения	

//		КонецЕсли;
//		// Лео Катанович}
//		ЗаписатьXML(Запись, GLNПокупателя							 	, "RECIPIENT"); 		//GLN получателя сообщения	
//		ЗаписатьXML(Запись, СокрЛП(НомерЗаказаПокупателя)				, "EDIINTERCHANGEID"); 	//номер транзакции
//	КонецЕсли;
//	//-Лео Сафонов ЕА Хардкод. Исключение из общих правил GLN для Билла и Гиперглобус

//	
//	сч = 1;
//	
//	Пока ВыборкаТовары.Следующий() Цикл
//		
//		Попытка
//			ШтрихкодДляВыгрузки = Число(СокрЛП(ВыборкаТовары.Штрихкод));
//		Исключение
//			ОбщегоНазначения.СообщитьОбОшибке("В номенклатуре: " + ВыборкаТовары.Номенклатура + ", артикул: " + ВыборкаТовары.Номенклатура.Артикул + " ошибка преобразования штрихкода в число: " + ВыборкаТовары.Штрихкод, Отказ);
//		КонецПопытки;
//		
//		Запись.ЗаписатьНачалоЭлемента("POSITION");
//		
//		ЗаписатьXML(Запись, сч										, "POSITIONNUMBER"); 	//номер позици
//		ЗаписатьXML(Запись, ШтрихкодДляВыгрузки						, "PRODUCT"); 			//Штрихкод продукта
//		Если ЗначениеЗаполнено(ВыборкаТовары.АртикулПокупателя) Тогда
//			ЗаписатьXML(Запись, ВыборкаТовары.АртикулПокупателя	    , "PRODUCTIDBUYER"); 	//внутренний номер в БД покупателя
//		КонецЕсли;
//		// {Лео Катанович  // 23.06.2017 Для контрагента "Новый Импульс" ()
//		Если СОКРЛП(ЗаказПокупателя.Контрагент.абс_GLN) = "4607038379991" Тогда // 
//	 		 ЗаписатьXML(Запись, "PCE"			                    , "ORDRSPUNIT"); 	    //Единицы
//		КонецЕсли;
//		// Лео Катанович}
//		ЗаписатьXML(Запись, СокрЛП(ВыборкаТовары.НаименованиеПолное), "DESCRIPTION"); 		//Описание продукта 
//		
//		 // {Лео Катанович  // 23.06.2017 Для контрагента "Новый Импульс" ()
//		 Если СОКРЛП(ЗаказПокупателя.Контрагент.абс_GLN) = "4607038379991" Тогда // 
//			 ЦенаБезСНДС = 0;
//			 ЦенаСНДС = 0;
//			 Сумма = 0;
//			 СуммаСНДС = 0;

//			 Если НЕ ВыборкаТовары.ЦенаВключаетНДС Тогда
//				  ЦенаБезСНДС = ВыборкаТовары.ЦенаСУчетомСкидки;
//				  ЦенаСНДС = (ВыборкаТовары.ЦенаСУчетомСкидки * (100 + ВыборкаТовары.СтавкаНДС)) / 100;
//				  Сумма =  ВыборкаТовары.Сумма;
//				  СуммаСНДС = ВыборкаТовары.Сумма + ВыборкаТовары.СуммаНДС;

//		  Иначе
//				  ЦенаБезСНДС = ОКР((ВыборкаТовары.ЦенаСУчетомСкидки * 100) / (100 + ВыборкаТовары.СтавкаНДС));
//				  ЦенаСНДС =  ВыборкаТовары.ЦенаСУчетомСкидки;
//				  Сумма =  ВыборкаТовары.Сумма - ВыборкаТовары.СуммаНДС ;
//				  СуммаСНДС = ВыборкаТовары.Сумма;

//			  КонецЕсли;	  
//			  ЗаписатьXML(Запись, ЦенаБезСНДС		, "PRICE"); 	   		//Цена продукта
//			  ЗаписатьXML(Запись, ЦенаБезСНДС		, "ORDERPRICE"); 	   	//Цена продукта
//			  ЗаписатьXML(Запись, ЦенаСНДС          , "PRICEWITHVAT"); 		//Цена продукта c НДС	
//			  ЗаписатьXML(Запись, Сумма		        , "AMOUNT"); 	   		//Сумма
//			  ЗаписатьXML(Запись, СуммаСНДС         , "AMOUNTWITHVAT"); 	//Суммаа c НДС	
//			  
//		Иначе
//			Если ВыборкаТовары.СуммаВключаетНДС Тогда 
//				 ЗаписатьXML(Запись, ВыборкаТовары.ЦенаСУчетомСкидки		, "PRICEWITHVAT"); 		//Цена продукта c НДС		
//			Иначе
//				 ЗаписатьXML(Запись, ВыборкаТовары.ЦенаСУчетомСкидки		, "PRICE"); 	   		//Цена продукта
//			КонецЕсли;  
//		КонецЕсли;
//		// Лео Катанович}
//		
//		
//			//{Лео Катанович
//		Если ЗначениеЗаполнено(ВыборкаТовары.ПричиныНеотгрузкиEDI)  Тогда
//			
//		ЗаписатьXML(Запись, "3"										, "PRODUCTTYPE"); 		//1 — товар будет поставлен без изменений, 2 — изменение заказанного количества, 3 — отказано в поставке 
//		
//		
//		ЗаписатьXML(Запись, ВыборкаТовары.СтавкаНДС					, "VAT"); 	   			//Ставка НДС, %
//		ЗаписатьXML(Запись, 0                                       , "ACCEPTEDQUANTITY"); 	//подтвержденное количество
//		ЗаписатьXML(Запись, 0                       				, "DELIVEREDQUANTITY"); //поставляемое количество
//		ЗаписатьXML(Запись, ВыборкаТовары.Количество				, "ORDEREDQUANTITY"); 	//Заказанное количество
//		ЗаписатьXML(Запись, ВыборкаТовары.Количество				, "DELTAQUANTITY"); 	//Заказанное количество
//		
//		Иначе
//		ЗаписатьXML(Запись, "1"										, "PRODUCTTYPE"); 		//1 — товар будет поставлен без изменений, 2 — изменение заказанного количества, 3 — отказано в поставке 
//		ЗаписатьXML(Запись, ВыборкаТовары.СтавкаНДС					, "VAT"); 	   			//Ставка НДС, %
//		ЗаписатьXML(Запись, ВыборкаТовары.Количество				, "ACCEPTEDQUANTITY"); 	//подтвержденное количество
//		ЗаписатьXML(Запись, ВыборкаТовары.Количество				, "DELIVEREDQUANTITY"); //поставляемое количество
//		ЗаписатьXML(Запись, ВыборкаТовары.Количество				, "ORDEREDQUANTITY"); 	//Заказанное количество
//		ЗаписатьXML(Запись, 0										, "DELTAQUANTITY"); 	//Заказанное количество
//		
//		КонецЕсли;
//		
//		ЗаписатьXML(Запись, ВыборкаТовары.ПричиныНеотгрузкиEDI		, "REASONDECREACEQUANTITY"); 	//Причина недогруза
//		//Лео Катанович}
//		Запись.ЗаписатьКонецЭлемента();
//		
//		сч = сч + 1;
//		
//	КонецЦикла;
//	
//	Если Отказ Тогда
//		ВызватьИсключение "Произошли ошибки при выгрузке подтверждения заказа! Подтверждение заказа не выгружено!";
//	КонецЕсли;
//	
//	Запись.ЗаписатьКонецЭлемента();
//	Запись.ЗаписатьКонецЭлемента();	
//	
//	ТекстXML=Запись.Закрыть();
//	
//	СтруктураПараметров = Новый Структура;
//	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.ПодтверждениеЗаказа);
//	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
//	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
//	СтруктураПараметров.Вставить("GLNПокупателя"			, GLNПокупателя);
//	СтруктураПараметров.Вставить("GLNГрузополучателя"		, СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
//	//{Лео Катанович
//	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ    //Билла
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ    // Тандер
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ    // Новый импульс
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ    // ТД ПЕРЕКРЕСТОК АО
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ    // Копейка-Москва ООО
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ    // Агроторг ООО
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ    // Зельгрос ООО
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ    // АТАК ООО
//		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда  // ДИКСИ ООО
//		 
//		 СтруктураПараметров.Вставить("GLNПоставщика"			, "4607932679999");
//	  Иначе
//		 СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
//	КонецЕсли;   
//	//	Лео Катанович}
//	
//	// << Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
//	Если ЗаказПокупателя.Организация.Код = "О00000001" Тогда
//		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su);
//	ИначеЕсли ЗаказПокупателя.Организация.Код = "О00000003" Тогда
//		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit);
//	КонецЕсли;
//	// >> Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
//	СтруктураПараметров.Вставить("ДокументОснование"		, ЗаказПокупателя);
//	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерЗаказаEDI);
//	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаЗаказаEDI);
//	
//	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
//	
//КонецПроцедуры
    Процедура ВыгрузитьПодтверждениеЗаказа(ЗаказПокупателя, ЕстьОшибки = Ложь) Экспорт
	
	ЗапросДокумент = Новый Запрос;
	ЗапросДокумент.Текст = 
	"ВЫБРАТЬ
	|	ЗаказПокупателя.ДокументОснование.НомерДокументаEDIЗаказа КАК НомерЗаказаEDI,
	|	ЗаказПокупателя.ДокументОснование.ДатаДокументаEDI КАК ДатаЗаказаEDI,
	|	ЗаказПокупателя.абс_ДатаПоставкиВТЦ КАК ДатаПоставкиВТЦ,
	|	ЗаказПокупателя.Контрагент.абс_GLN КАК GLNКонтрагента,
	|	ЗаказПокупателя.Организация.абс_GLN КАК GLNОрганизации,
	|	ЗаказПокупателя.Грузополучатель.абс_GLN КАК GLNГрузополучателя,
	|	ЗаказПокупателя.Дата КАК ДатаЗаказаПокупателя,
	|	ЗаказПокупателя.Лео_ДатаВремяПрибытияТранспортаПолучателю,
	|	ПРЕДСТАВЛЕНИЕ(ЗаказПокупателя.ДоговорКонтрагента) КАК ДоговорКонтрагента,
	|	ЗаказПокупателя.Лео_ПодтвержденнаяДатаДоставки КАК ПодтвержденнаяДатаДоставки,
	|	ЗаказПокупателя.Лео_НазваниеРампыРазгрузки,
	|	ЗаказПокупателя.Контрагент
	|ИЗ
	|	Документ.ЗаказПокупателя КАК ЗаказПокупателя
	|ГДЕ
	|	ЗаказПокупателя.Ссылка = &Ссылка";
	
	ЗапросДокумент.УстановитьПараметр("Ссылка", ЗаказПокупателя);
	
	ЗапросТовары = Новый Запрос;
	ЗапросТовары.Текст = 
	"ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13) КАК ТипШтрихКода,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК СерияНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаНоменклатуры,
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства КАК Свойство,
	|	ВложенныйЗапрос.Номенклатура КАК Номенклатура,
	|	СУММА(ВложенныйЗапрос.Количество) КАК Количество,
	|	ВложенныйЗапрос.Цена КАК Цена,
	|	ВложенныйЗапрос.СтавкаНДС КАК СтавкаНДС,
	|	ВложенныйЗапрос.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВложенныйЗапрос.ТипЦенЦенаВключаетНДС КАК ТипЦенЦенаВключаетНДС,
	|	ВложенныйЗапрос.Лео_ЦенаСУчетомСкидки КАК Лео_ЦенаСУчетомСкидки,
	|	ВложенныйЗапрос.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВложенныйЗапрос.Сумма КАК Сумма,
	|	ВложенныйЗапрос.СуммаНДС КАК СуммаНДС,
	|	ВложенныйЗапрос.Ссылка,
	|	ВложенныйЗапрос.Лео_ПричиныНеотгрузкиEDI КАК ПричиныНеотгрузкиEDI,
	|	ВЫРАЗИТЬ(ВложенныйЗапрос.Номенклатура.НаименованиеПолное КАК СТРОКА(100)) КАК НаименованиеПолное,
	|	ВложенныйЗапрос.ФлагНеотгружено,
	|	ВЫБОР
	|		КОГДА ВложенныйЗапрос.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ ВложенныйЗапрос.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА ВложенныйЗапрос.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ ВложенныйЗапрос.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА ВложенныйЗапрос.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ ВложенныйЗапрос.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 20    
	|		КОГДА ВложенныйЗапрос.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5)
	|				ИЛИ ВложенныйЗапрос.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС5_105)
	|			ТОГДА 5
	|		КОГДА ВложенныйЗапрос.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7)
	|				ИЛИ ВложенныйЗапрос.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС7_107)
	|			ТОГДА 7
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК НДС,
	|	ВложенныйЗапрос.НомерСтроки
	|ПОМЕСТИТЬ ЗаказПокупателя
	|ИЗ
	|	(ВЫБРАТЬ
	|		ЗаказПокупателяТовары.Номенклатура КАК Номенклатура,
	|		ЗаказПокупателяТовары.Количество КАК Количество,
	|		ЗаказПокупателяТовары.Цена КАК Цена,
	|		ЗаказПокупателяТовары.СтавкаНДС КАК СтавкаНДС,
	|		ЗаказПокупателяТовары.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|		ЗаказПокупателяТовары.Ссылка.ТипЦен.ЦенаВключаетНДС КАК ТипЦенЦенаВключаетНДС,
	|		ЗаказПокупателяТовары.Лео_ЦенаСУчетомСкидки КАК Лео_ЦенаСУчетомСкидки,
	|		ЗаказПокупателяТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|		ЗаказПокупателяТовары.Сумма КАК Сумма,
	|		ЗаказПокупателяТовары.СуммаНДС КАК СуммаНДС,
	|		ЗаказПокупателяТовары.Ссылка КАК Ссылка,
	|		"""" КАК Лео_ПричиныНеотгрузкиEDI,
	|		ЛОЖЬ КАК ФлагНеотгружено,
	|		ЗаказПокупателяТовары.НомерСтроки КАК НомерСтроки
	|	ИЗ
	|		Документ.ЗаказПокупателя.Товары КАК ЗаказПокупателяТовары
	|	ГДЕ
	|		ЗаказПокупателяТовары.Ссылка = &Ссылка
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ЗаказПокупателяабс_Неотгружено.Номенклатура,
	|		ЗаказПокупателяабс_Неотгружено.Количество,
	|		ЗаказПокупателяабс_Неотгружено.Цена,
	|		ЗаказПокупателяабс_Неотгружено.СтавкаНДС,
	|		ЗаказПокупателяабс_Неотгружено.Ссылка.СуммаВключаетНДС,
	|		ЗаказПокупателяабс_Неотгружено.Ссылка.ТипЦен.ЦенаВключаетНДС,
	|		ЗаказПокупателяабс_Неотгружено.Цена,
	|		ЗаказПокупателяабс_Неотгружено.ЕдиницаИзмерения,
	|		ЗаказПокупателяабс_Неотгружено.Сумма,
	|		ЗаказПокупателяабс_Неотгружено.СуммаНДС,
	|		ЗаказПокупателяабс_Неотгружено.Ссылка,
	|		ЗаказПокупателяабс_Неотгружено.Лео_ПричиныНеотгрузкиEDI.Код,
	|		ИСТИНА,
	|		ЗаказПокупателяабс_Неотгружено.НомерСтроки
	|	ИЗ
	|		Документ.ЗаказПокупателя.абс_Неотгружено КАК ЗаказПокупателяабс_Неотгружено
	|	ГДЕ
	|		ЗаказПокупателяабс_Неотгружено.Ссылка = &Ссылка) КАК ВложенныйЗапрос
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.абс_ЗначенияСвойствНоменклатурыКонтрагентов.СрезПоследних(, Свойство = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СвойстваОбъектов.абс_АртикулПокупателя)) КАК абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних
	|		ПО ВложенныйЗапрос.Номенклатура = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Номенклатура
	|			И ВложенныйЗапрос.Ссылка.Контрагент = абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.Контрагент
	|
	|СГРУППИРОВАТЬ ПО
	|	абс_ЗначенияСвойствНоменклатурыКонтрагентовСрезПоследних.ЗначениеСвойства,
	|	ВложенныйЗапрос.Номенклатура,
	|	ВложенныйЗапрос.Цена,
	|	ВложенныйЗапрос.СтавкаНДС,
	|	ВложенныйЗапрос.СуммаВключаетНДС,
	|	ВложенныйЗапрос.ТипЦенЦенаВключаетНДС,
	|	ВложенныйЗапрос.Лео_ЦенаСУчетомСкидки,
	|	ВложенныйЗапрос.ЕдиницаИзмерения,
	|	ВложенныйЗапрос.Сумма,
	|	ВложенныйЗапрос.СуммаНДС,
	|	ВложенныйЗапрос.Ссылка,
	|	ВложенныйЗапрос.Лео_ПричиныНеотгрузкиEDI,
	|	ВложенныйЗапрос.ФлагНеотгружено,
	|	ВложенныйЗапрос.НомерСтроки,
	|	ВЫРАЗИТЬ(ВложенныйЗапрос.Номенклатура.НаименованиеПолное КАК СТРОКА(100))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Штрихкоды.Штрихкод, 0)) КАК Штрихкод,
	|	Заказ.Свойство КАК АртикулПокупателя,
	|	Заказ.ТипШтрихКода,
	|	Заказ.СерияНоменклатуры,
	|	Заказ.ХарактеристикаНоменклатуры,
	|	Заказ.Свойство,
	|	Заказ.Номенклатура,
	|	Заказ.Количество,
	|	Заказ.Цена,
	|	Заказ.СтавкаНДС,
	|	Заказ.СуммаВключаетНДС,
	|	Заказ.ТипЦенЦенаВключаетНДС КАК ЦенаВключаетНДС,
	|	Заказ.Лео_ЦенаСУчетомСкидки КАК ЦенаСУчетомСкидки,
	|	Заказ.ЕдиницаИзмерения,
	|	Заказ.Сумма,
	|	Заказ.СуммаНДС,
	|	Заказ.Ссылка,
	|	Заказ.ПричиныНеотгрузкиEDI,
	|	Заказ.НаименованиеПолное,
	|	Заказ.ФлагНеотгружено,
	|	Заказ.НДС,
	|	Заказ.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	ЗаказПокупателя КАК Заказ
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО Заказ.ТипШтрихКода = Штрихкоды.ТипШтрихкода
	|			И Заказ.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|			И (Штрихкоды.СерияНоменклатуры = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка))
	|			И Заказ.Номенклатура = Штрихкоды.Владелец
	|
	|СГРУППИРОВАТЬ ПО
	|	Заказ.Свойство,
	|	Заказ.ТипШтрихКода,
	|	Заказ.СерияНоменклатуры,
	|	Заказ.ХарактеристикаНоменклатуры,
	|	Заказ.Номенклатура,
	|	Заказ.Количество,
	|	Заказ.Цена,
	|	Заказ.СтавкаНДС,
	|	Заказ.СуммаВключаетНДС,
	|	Заказ.ТипЦенЦенаВключаетНДС,
	|	Заказ.Лео_ЦенаСУчетомСкидки,
	|	Заказ.ЕдиницаИзмерения,
	|	Заказ.Сумма,
	|	Заказ.СуммаНДС,
	|	Заказ.Ссылка,
	|	Заказ.ПричиныНеотгрузкиEDI,
	|	Заказ.НаименованиеПолное,
	|	Заказ.ФлагНеотгружено,
	|	Заказ.НДС,
	|	Заказ.Свойство,
	|	Заказ.НомерСтроки
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	
	ЗапросТовары.УстановитьПараметр("Ссылка", ЗаказПокупателя);
	
	ВыборкаДокумент = ЗапросДокумент.Выполнить().Выбрать();
	ВыборкаДокумент.Следующий();
	
	НомерЗаказаПокупателя = ОбщегоНазначения.ПолучитьНомерНаПечать(ЗаказПокупателя);
	
	Отказ = Ложь;
	
	ИмяФайла = СформироватьИмяФайлаEDI("Ordrsp_"+Формат(ВыборкаДокумент.ДатаЗаказаEDI,"ДФ=ггггММдд")+"_"+СокрЛП(ВыборкаДокумент.НомерЗаказаEDI)) + ".xml";
	Запись = Новый ЗаписьXML;
	Запись.УстановитьСтроку("UTF-8");
	Запись.ЗаписатьОбъявлениеXML();
	
	Запись.ЗаписатьНачалоЭлемента("ORDRSP");
	
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.НомерЗаказаEDI)							, "NUMBER");		//Номер подтверждения заказа 
	ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ДатаЗаказаПокупателя, "ДФ=гггг-ММ-дд")	, "DATE"); 			//дата документа
	ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.НомерЗаказаEDI)							, "ORDERNUMBER"); 	//номер заказа
	ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ДатаЗаказаEDI, 		 "ДФ=гггг-ММ-дд")	, "ORDERDATE"); 	//дата заказа
	Если НЕ ВыборкаДокумент.ПодтвержденнаяДатаДоставки  = Дата('00010101000000') Тогда
		ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ПодтвержденнаяДатаДоставки,		"ДФ=гггг-ММ-дд")	, "DELIVERYDATE"); 	//дата поставки
	Иначе
		ЗаписатьXML(Запись, Формат(ВыборкаДокумент.ДатаПоставкиВТЦ,		"ДФ=гггг-ММ-дд")	, "DELIVERYDATE"); 	//дата поставки

	КонецЕсли;
	// {Лео Катанович
	
	ТЗ_ВыборкаТовары = ЗапросТовары.Выполнить().Выгрузить();

	//Для Х5 выгружаем причину недопоставки
	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ    // ТД ПЕРЕКРЕСТОК АО
		ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ    // Копейка-Москва ООО
		ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") Тогда  // Агроторг ООО 
		
		Для Каждого  ВыборкаТовары из ТЗ_ВыборкаТовары Цикл
			Если ЗначениеЗаполнено(ВыборкаТовары.ПричиныНеотгрузкиEDI) Тогда
				ЗаписатьXML(Запись,ВыборкаТовары.ПричиныНеотгрузкиEDI	, "REASONDECREACEQUANTITYALL"); 	//причина неотгрузки			 
				Прервать;
			КонецЕсли;	
		КонецЦикла;	
	КонецЕсли;
	
	//+Лео Сафонов ЕА 17.03.2016
	Запись.ЗаписатьНачалоЭлемента("LIMES");
		ЗаписатьXML(Запись, ВыборкаДокумент.Лео_НазваниеРампыРазгрузки		, "LIMESNAME"); //Название рампы
		ЗаписатьXML(Запись, Формат(ВыборкаДокумент.Лео_ДатаВремяПрибытияТранспортаПолучателю,"ДФ=гггг-ММ-дд")		, "DATEFROM"); //Дата прибытия транспорта
		ЗаписатьXML(Запись, Формат(ВыборкаДокумент.Лео_ДатаВремяПрибытияТранспортаПолучателю,"ДФ=ЧЧ:мм")			, "TIMEFROM"); //Время прибытия транспорта
    Запись.ЗаписатьКонецЭлемента();
	//-Лео Сафонов ЕА 17.03.2016
	ЗаписатьXML(Запись, "29"															, "ACTION"); 		//4 — поставка изменена, 5 — замена документа, 29 — поставка принята, 27 — поставка не принята 
	//{Лео Катанович  05.04.2016
	ЗаписатьXML(Запись, ""															    , "INFO"); 		
	ЗаписатьXML(Запись, ВыборкаДокумент.ДоговорКонтрагента						        , "CAMPAIGNNUMBER"); //Договор контрагента 		
	//Лео Катанович  05.04.2016}
	
	Запись.ЗаписатьНачалоЭлемента("HEAD");
	
	ГрузополучательЯвляетсяПлательщиком = абс_Дистрибуция.ПолучитьЗначениеСвойстваОбъекта(ЗаказПокупателя.Контрагент, ПланыВидовХарактеристик.СвойстваОбъектов.абс_ГрузополучательЯвляетсяПлательщиком);
	
	GLNПокупателя = СокрЛП(ВыборкаДокумент.GLNКонтрагента);
	
	//Если ГрузополучательЯвляетсяПлательщиком = Истина Тогда
	//	GLNПокупателя = СокрЛП(ВыборкаДокумент.GLNГрузополучателя);
	//КонецЕсли;
	
	
	//+Лео Сафонов ЕА Хардкод. Исключение из общих правил GLN для Билла и Гиперглобус
	Если ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("") Тогда ////////////////////////////////////////////////Билла
		ЗаписатьXML(Запись, GLNПокупателя								, "BUYER"); 			//GLN покупателя	
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNОрганизации)		, "SUPPLIER"); 			//GLN поставщика	
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "DELIVERYPLACE"); 	//GLN места доставки
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNОрганизации)		, "SENDER"); 			//GLN отправителя сообщения	
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "RECIPIENT"); 		//GLN получателя сообщения	
		ЗаписатьXML(Запись, СокрЛП(НомерЗаказаПокупателя)				, "EDIINTERCHANGEID"); 	//номер транзакции
	ИначеЕсли ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("") Тогда ///////////////////////////////////////////Гиперглобус
		ЗаписатьXML(Запись, GLNПокупателя								, "BUYER"); 			//GLN покупателя	
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNОрганизации)		, "SUPPLIER"); 			//GLN поставщика	
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "DELIVERYPLACE"); 	//GLN места доставки
		ЗаписатьXML(Запись, "4690202000005"								, "INVOICEPARTNER"); 	//GLN плательщика
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNОрганизации)		, "SENDER"); 			//GLN отправителя сообщения	
		ЗаписатьXML(Запись, "4690202000005"								, "RECIPIENT"); 		//GLN получателя сообщения	
		ЗаписатьXML(Запись, СокрЛП(НомерЗаказаПокупателя)				, "EDIINTERCHANGEID"); 	//номер транзакции
	Иначе /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////Общие правила
		ЗаписатьXML(Запись, GLNПокупателя								, "BUYER"); 			//GLN покупателя	
		
	//{Лео Катанович
	Если ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ     //Билла
		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ     // Тандер
		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ     // Новый импульс
		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ     // ТД ПЕРЕКРЕСТОК АО
		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ     // Копейка-Москва ООО
		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ     // Агроторг ООО
		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ     // Зельгрос ООО
		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ     // АТАК ООО
		 ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда   // ДИКСИ ООО
		 
		 ЗаписатьXML(Запись,"4607932679999"			, "SUPPLIER"); 			                   //GLN поставщика	
	Иначе
	    ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNОрганизации)		, "SUPPLIER"); 		   //GLN поставщика	
	КонецЕсли;
	// Лео Катанович}
		ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNГрузополучателя)	, "DELIVERYPLACE"); 	//GLN места доставки
		ЗаписатьXML(Запись, GLNПокупателя								, "INVOICEPARTNER"); 	//GLN плательщика
		
			//{Лео Катанович
		Если ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ    //Билла
			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098")  ИЛИ    // Тандер
			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415")  ИЛИ    // Новый импульс
			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293")  ИЛИ    // ТД ПЕРЕКРЕСТОК АО
			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846")  ИЛИ    // Копейка-Москва ООО
			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035")  ИЛИ    // Агроторг ООО
			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475")  ИЛИ    // Зельгрос ООО
			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166")  ИЛИ    // АТАК ООО
			ЗаказПокупателя.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040")  Тогда  // ДИКСИ ООО
			
			ЗаписатьXML(Запись, "4607932679999"		, "SENDER"); 			                       //GLN отправителя сообщения	
		Иначе
		   ЗаписатьXML(Запись, СокрЛП(ВыборкаДокумент.GLNОрганизации)		, "SENDER"); 			//GLN отправителя сообщения	

		КонецЕсли;
		// Лео Катанович}
		ЗаписатьXML(Запись, GLNПокупателя							 	, "RECIPIENT"); 		//GLN получателя сообщения	
		ЗаписатьXML(Запись, СокрЛП(НомерЗаказаПокупателя)				, "EDIINTERCHANGEID"); 	//номер транзакции
	КонецЕсли;
	//-Лео Сафонов ЕА Хардкод. Исключение из общих правил GLN для Билла и Гиперглобус

	
	сч = 1;
	
	Для Каждого  ВыборкаТовары из ТЗ_ВыборкаТовары Цикл
		Если ВыборкаТовары.ФлагНеотгружено Тогда
			 Если ВыборкаДокумент.Контрагент <> Справочники.Контрагенты.НайтиПоКоду("К00000293") И    // ТД ПЕРЕКРЕСТОК АО
				  ВыборкаДокумент.Контрагент <> Справочники.Контрагенты.НайтиПоКоду("К00000846") И    // Копейка-Москва ООО
				  ВыборкаДокумент.Контрагент <> Справочники.Контрагенты.НайтиПоКоду("ККК004035") Тогда  // Агроторг ООО 
				  Продолжить;
			  КонецЕсли;
		КонецЕсли;	  

		Попытка
			ШтрихкодДляВыгрузки = Число(СокрЛП(ВыборкаТовары.Штрихкод));
		Исключение
			ОбщегоНазначения.СообщитьОбОшибке("В номенклатуре: " + ВыборкаТовары.Номенклатура + ", артикул: " + ВыборкаТовары.Номенклатура.Артикул + " ошибка преобразования штрихкода в число: " + ВыборкаТовары.Штрихкод, Отказ);
		КонецПопытки;
		
		Запись.ЗаписатьНачалоЭлемента("POSITION");
		
		ЗаписатьXML(Запись, сч										, "POSITIONNUMBER"); 	//номер позици
		ЗаписатьXML(Запись, ШтрихкодДляВыгрузки						, "PRODUCT"); 			//Штрихкод продукта
		Если ЗначениеЗаполнено(ВыборкаТовары.АртикулПокупателя) Тогда
			ЗаписатьXML(Запись, ВыборкаТовары.АртикулПокупателя	    , "PRODUCTIDBUYER"); 	//внутренний номер в БД покупателя
		КонецЕсли;
	    // {Лео Катанович  // 23.06.2017 Для контрагента "Новый Импульс"  ИЛИ 05.03.2019 Тандер
		Если СОКРЛП(ЗаказПокупателя.Контрагент.абс_GLN) = "4607038379991" ИЛИ СОКРЛП(ЗаказПокупателя.Контрагент.абс_GLN) = "4607164999995" Тогда // 
	 	     ЗаписатьXML(Запись, "PCE"			                    , "ORDRSPUNIT"); 	    //Единицы
        КонецЕсли;
		// Лео Катанович}
		ЗаписатьXML(Запись, СокрЛП(ВыборкаТовары.НаименованиеПолное), "DESCRIPTION"); 		//Описание продукта 
		
		 // {Лео Катанович  // 23.06.2017 Для контрагента "Новый Импульс" ()
		 Если СОКРЛП(ЗаказПокупателя.Контрагент.абс_GLN) = "4607038379991" Тогда // 
			 ЦенаБезСНДС = 0;
			 ЦенаСНДС = 0;
			 Сумма = 0;
			 СуммаСНДС = 0;

			 Если НЕ ВыборкаТовары.ЦенаВключаетНДС Тогда
			      ЦенаБезСНДС = ВыборкаТовары.ЦенаСУчетомСкидки;
				  ЦенаСНДС = (ВыборкаТовары.ЦенаСУчетомСкидки * (100 + ВыборкаТовары.НДС)) / 100;
                  Сумма =  ВыборкаТовары.Сумма;
				  СуммаСНДС = ВыборкаТовары.Сумма + ВыборкаТовары.СуммаНДС;

		  Иначе
			      ЦенаБезСНДС = ОКР((ВыборкаТовары.ЦенаСУчетомСкидки * 100) / (100 + ВыборкаТовары.НДС));
                  ЦенаСНДС =  ВыборкаТовары.ЦенаСУчетомСкидки;
                  Сумма =  ВыборкаТовары.Сумма - ВыборкаТовары.СуммаНДС ;
				  СуммаСНДС = ВыборкаТовары.Сумма;

			  КонецЕсли;	  
			  ЗаписатьXML(Запись, ЦенаБезСНДС		, "PRICE"); 	   		//Цена продукта
			  ЗаписатьXML(Запись, ЦенаБезСНДС		, "ORDERPRICE"); 	   	//Цена продукта
			  ЗаписатьXML(Запись, ЦенаСНДС          , "PRICEWITHVAT"); 		//Цена продукта c НДС	
			  ЗаписатьXML(Запись, Сумма		        , "AMOUNT"); 	   		//Сумма
			  ЗаписатьXML(Запись, СуммаСНДС         , "AMOUNTWITHVAT"); 	//Суммаа c НДС	
			  
		Иначе
		    Если ВыборкаТовары.СуммаВключаетНДС Тогда 
			     ЗаписатьXML(Запись, ВыборкаТовары.ЦенаСУчетомСкидки		, "PRICEWITHVAT"); 		//Цена продукта c НДС		
		    Иначе
			     ЗаписатьXML(Запись, ВыборкаТовары.ЦенаСУчетомСкидки		, "PRICE"); 	   		//Цена продукта
		    КонецЕсли;  
		КонецЕсли;
		//Для Х5 выгружаем причину недопоставки
		Если ВыборкаТовары.ФлагНеотгружено Тогда
				
				ЗаписатьXML(Запись, "3"										, "PRODUCTTYPE"); 		//1 — товар будет поставлен без изменений, 2 — изменение заказанного количества, 3 — отказано в поставке 
				ЗаписатьXML(Запись, Строка(ВыборкаТовары.НДС)			, "VAT"); 	   			//Ставка НДС, %
				ЗаписатьXML(Запись, 0                                       , "ACCEPTEDQUANTITY"); 	//подтвержденное количество
				ЗаписатьXML(Запись, 0                       				, "DELIVEREDQUANTITY"); //поставляемое количество
				ЗаписатьXML(Запись, ВыборкаТовары.Количество				, "ORDEREDQUANTITY"); 	//Заказанное количество
				ЗаписатьXML(Запись, ВыборкаТовары.Количество				, "DELTAQUANTITY"); 	//Заказанное количество
			    ЗаписатьXML(Запись, ВыборкаТовары.ПричиныНеотгрузкиEDI		, "REASONDECREACEQUANTITY"); 	//Причина недогруза
			
		Иначе
			ЗаписатьXML(Запись, "1"										, "PRODUCTTYPE"); 		//1 — товар будет поставлен без изменений, 2 — изменение заказанного количества, 3 — отказано в поставке 
			ЗаписатьXML(Запись, Строка(ВыборкаТовары.НДС)			, "VAT"); 	   			//Ставка НДС, %
			ЗаписатьXML(Запись, ВыборкаТовары.Количество				, "ACCEPTEDQUANTITY"); 	//подтвержденное количество
			ЗаписатьXML(Запись, ВыборкаТовары.Количество				, "DELIVEREDQUANTITY"); //поставляемое количество
			ЗаписатьXML(Запись, ВыборкаТовары.Количество				, "ORDEREDQUANTITY"); 	//Заказанное количество
			ЗаписатьXML(Запись, 0										, "DELTAQUANTITY"); 	//Заказанное количество

		КонецЕсли;	

        сч = сч + 1;
	    Запись.ЗаписатьКонецЭлемента();

	КонецЦикла;
	
	Если Отказ Тогда
		ВызватьИсключение "Произошли ошибки при выгрузке подтверждения заказа! Подтверждение заказа не выгружено!";
	КонецЕсли;
	
	Запись.ЗаписатьКонецЭлемента();
	Запись.ЗаписатьКонецЭлемента();	
	
	ТекстXML=Запись.Закрыть();
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("ТипСообщения"				, Перечисления.абс_ТипыСообщенийEDI.ПодтверждениеЗаказа);
	СтруктураПараметров.Вставить("ТекстСообщенияXML"		, ТекстXML);
	СтруктураПараметров.Вставить("ЗаголовокФайла"			, ИмяФайла);
	СтруктураПараметров.Вставить("GLNПокупателя"			, GLNПокупателя);
	СтруктураПараметров.Вставить("GLNГрузополучателя"		, СокрЛП(ВыборкаДокумент.GLNГрузополучателя));
	//{Лео Катанович
	Если ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000401") ИЛИ    //Билла
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000098") ИЛИ    // Тандер
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000415") ИЛИ    // Новый импульс
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000293") ИЛИ    // ТД ПЕРЕКРЕСТОК АО
	     ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000846") ИЛИ    // Копейка-Москва ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("ККК004035") ИЛИ    // Агроторг ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000475") ИЛИ    // Зельгрос ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000166") ИЛИ    // АТАК ООО
		 ВыборкаДокумент.Контрагент = Справочники.Контрагенты.НайтиПоКоду("К00000040") Тогда  // ДИКСИ ООО
		 
		 СтруктураПараметров.Вставить("GLNПоставщика"			, "4607932679999");
	  Иначе
	     СтруктураПараметров.Вставить("GLNПоставщика"			, ВыборкаДокумент.GLNОрганизации);
	КонецЕсли;   
    //	Лео Катанович}
	
	// << Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
	Если ЗаказПокупателя.Организация.Код = "О00000001" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su);
	ИначеЕсли ЗаказПокупателя.Организация.Код = "О00000003" Тогда
		СтруктураПараметров.Вставить("НастройкаОбмена"		, Справочники.абс_НастройкиEDIОбмена.edi_su_Leovit);
	КонецЕсли;
	// >> Горбунов, добавил выгрузку из организации ООО "ЛЕОВИТ нутрио"
	СтруктураПараметров.Вставить("ДокументОснование"		, ЗаказПокупателя);
	СтруктураПараметров.Вставить("НомерДокументаEDIЗаказа"	, ВыборкаДокумент.НомерЗаказаEDI);
	СтруктураПараметров.Вставить("ДатаДокументаEDI"			, ВыборкаДокумент.ДатаЗаказаEDI);
	
	СформироватьСообщениеEDI(СтруктураПараметров, ЕстьОшибки);
	
КонецПроцедуры

Функция ПолучитьПодтверждениеЗаказа(ЗаказПокупателя) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	абс_СообщениеEDI.Ссылка
	|ИЗ
	|	Документ.абс_СообщениеEDI КАК абс_СообщениеEDI
	|ГДЕ
	|	абс_СообщениеEDI.ДокументОснование = &ДокументОснование
	|	И абс_СообщениеEDI.ТипСообщения = ЗНАЧЕНИЕ(Перечисление.абс_ТипыСообщенийEDI.ПодтверждениеЗаказа)";
	Запрос.УстановитьПараметр("ДокументОснование", ЗаказПокупателя);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	Иначе
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
КонецФункции

Процедура абс_ВыгрузкаДанныхПУБ77(НастройкаВыгрузкиДанныхПУБ77) Экспорт
	
	ЗаписьЖурналаРегистрации("ОбменДанными.ОбменПУБ77", УровеньЖурналаРегистрации.Информация, , , "Начат обмен ПУБ 7.7 по настройке " + НастройкаВыгрузкиДанныхПУБ77);
	
	ВыполнитьОбменПУБ77ПоНастройке(НастройкаВыгрузкиДанныхПУБ77);
	
	ЗаписьЖурналаРегистрации("ОбменДанными.ОбменПУБ77", УровеньЖурналаРегистрации.Информация, , , "Завершен обмен ПУБ 7.7 по настройке " + НастройкаВыгрузкиДанныхПУБ77);
	
КонецПроцедуры

Процедура ВыполнитьОбменПУБ77ПоНастройке(НастройкаВыгрузкиДанныхПУБ77) Экспорт
	
	Если НЕ НастройкаВыгрузкиДанныхПУБ77.Использование Тогда
		Возврат;
	КонецЕсли;
	
	ИмяТипаФайлаВыгрузки = Метаданные.Перечисления.абс_ТипФайлаВыгрузки.ЗначенияПеречисления[Перечисления.абс_ТипФайлаВыгрузки.Индекс(НастройкаВыгрузкиДанныхПУБ77.ТипФайлаВыгрузки)].Имя;
	
	ЕстьОшибки = Ложь;
	
	Выполнить("ВыполнитьОбменПУБ77_" + ИмяТипаФайлаВыгрузки + "(НастройкаВыгрузкиДанныхПУБ77, ЕстьОшибки);");
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ ВЫГРУЗКИ ДАННЫХ В ПУБ 7.7 ПО ТИПАМ ОБМЕНА

Процедура ВыполнитьОбменПУБ77_Контрагенты(Настройка, ЕстьОшибки)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ДатыАктуальностиКИ.Объект,
	|	КонтактнаяИнформация.Представление
	|ПОМЕСТИТЬ ВТ_ЮрАдресКонтрагента
	|ИЗ
	|	(ВЫБРАТЬ
	|		МАКСИМУМ(КонтактнаяИнформация.абс_ДатаАктуальностиКИ) КАК абс_ДатаАктуальностиКИ,
	|		КонтактнаяИнформация.Объект КАК Объект,
	|		КонтактнаяИнформация.Тип КАК Тип,
	|		КонтактнаяИнформация.Вид КАК Вид
	|	ИЗ
	|		РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|	ГДЕ
	|		КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)
	|		И КонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.ЮрАдресКонтрагента)
	|	
	|	СГРУППИРОВАТЬ ПО
	|		КонтактнаяИнформация.Объект,
	|		КонтактнаяИнформация.Тип,
	|		КонтактнаяИнформация.Вид) КАК ДатыАктуальностиКИ
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|		ПО ДатыАктуальностиКИ.Объект = КонтактнаяИнформация.Объект
	|			И ДатыАктуальностиКИ.Тип = КонтактнаяИнформация.Тип
	|			И ДатыАктуальностиКИ.Вид = КонтактнаяИнформация.Вид
	|			И ДатыАктуальностиКИ.абс_ДатаАктуальностиКИ = КонтактнаяИнформация.абс_ДатаАктуальностиКИ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДатыАктуальностиКИ.Объект,
	|	КонтактнаяИнформация.Представление
	|ПОМЕСТИТЬ ВТ_ФактАдресКонтрагента
	|ИЗ
	|	(ВЫБРАТЬ
	|		МАКСИМУМ(КонтактнаяИнформация.абс_ДатаАктуальностиКИ) КАК абс_ДатаАктуальностиКИ,
	|		КонтактнаяИнформация.Объект КАК Объект,
	|		КонтактнаяИнформация.Тип КАК Тип,
	|		КонтактнаяИнформация.Вид КАК Вид
	|	ИЗ
	|		РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|	ГДЕ
	|		КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)
	|		И КонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.ФактАдресКонтрагента)
	|	
	|	СГРУППИРОВАТЬ ПО
	|		КонтактнаяИнформация.Объект,
	|		КонтактнаяИнформация.Тип,
	|		КонтактнаяИнформация.Вид) КАК ДатыАктуальностиКИ
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|		ПО ДатыАктуальностиКИ.Объект = КонтактнаяИнформация.Объект
	|			И ДатыАктуальностиКИ.Тип = КонтактнаяИнформация.Тип
	|			И ДатыАктуальностиКИ.Вид = КонтактнаяИнформация.Вид
	|			И ДатыАктуальностиКИ.абс_ДатаАктуальностиКИ = КонтактнаяИнформация.абс_ДатаАктуальностиКИ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Контрагенты.Код КАК kodupp,
	|	ВЫБОР
	|		КОГДА Контрагенты.ГоловнойКонтрагент = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА 0
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК hold,
	|	Контрагенты.ГоловнойКонтрагент.Наименование КАК rodit,
	|	Контрагенты.Наименование КАК name,
	|	Контрагенты.НаименованиеПолное КАК namefull,
	|	Контрагенты.ИНН КАК INN,
	|	Контрагенты.КПП КАК KPP,
	|	ЕСТЬNULL(ВТ_ЮрАдресКонтрагента.Представление, """") КАК adr,
	|	ЕСТЬNULL(ВТ_ФактАдресКонтрагента.Представление, """") КАК adrfack,
	|	Контрагенты.КодПоОКПО КАК okpo,
	|	ЕСТЬNULL(Контрагенты.ОсновнойБанковскийСчет.НомерСчета, """") КАК acount,
	|	Контрагенты.Комментарий КАК comment
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ЮрАдресКонтрагента КАК ВТ_ЮрАдресКонтрагента
	|		ПО ВТ_ЮрАдресКонтрагента.Объект = Контрагенты.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ФактАдресКонтрагента КАК ВТ_ФактАдресКонтрагента
	|		ПО ВТ_ФактАдресКонтрагента.Объект = Контрагенты.Ссылка");
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("kodupp"		, "S"	, 9);
	ФайлВыгрузки.Поля.Добавить("hold"		, "N"	, 1);
	ФайлВыгрузки.Поля.Добавить("rodit"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("name"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("namefull"	, "S"	, 500);
	ФайлВыгрузки.Поля.Добавить("INN"		, "S"	, 12);
	ФайлВыгрузки.Поля.Добавить("KPP"		, "S"	, 9);
	ФайлВыгрузки.Поля.Добавить("adr"		, "S"	, 500);
	ФайлВыгрузки.Поля.Добавить("adrfack"	, "S"	, 500);
	ФайлВыгрузки.Поля.Добавить("okpo"		, "S"	, 10);
	ФайлВыгрузки.Поля.Добавить("acount"		, "S"	, 20);
	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 500);
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();
	
КонецПроцедуры

Процедура ВыполнитьОбменПУБ77_ДоговорыКонтрагентов(Настройка, ЕстьОшибки)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ДоговорыКонтрагентов.Код КАК kodupp,
	|	ДоговорыКонтрагентов.Наименование КАК name,
	|	ДоговорыКонтрагентов.Владелец.Наименование КАК kontr,
	|	ДоговорыКонтрагентов.Владелец.ИНН КАК INN,
	|	ДоговорыКонтрагентов.Владелец.КПП КАК KPP,
	|	ДоговорыКонтрагентов.Комментарий КАК comment
	|ИЗ
	|	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	|ГДЕ
	|	ДоговорыКонтрагентов.Организация = &Организация");
	
	Запрос.УстановитьПараметр("Организация", Настройка.Организация);
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("kodupp"		, "S"	, 9);
	ФайлВыгрузки.Поля.Добавить("name"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("kontr"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("INN"		, "S"	, 12);
	ФайлВыгрузки.Поля.Добавить("KPP"		, "S"	, 9);
	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 500);
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();
	
КонецПроцедуры

Процедура ВыполнитьОбменПУБ77_БанковскиеСчета(Настройка, ЕстьОшибки)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	БанковскиеСчета.Код КАК kodupp,
	|	БанковскиеСчета.Наименование КАК name,
	|	ВЫРАЗИТЬ(БанковскиеСчета.Владелец КАК Справочник.Контрагенты).Наименование КАК kontr,
	|	ВЫРАЗИТЬ(БанковскиеСчета.Владелец КАК Справочник.Контрагенты).ИНН КАК INN,
	|	ВЫРАЗИТЬ(БанковскиеСчета.Владелец КАК Справочник.Контрагенты).КПП КАК KPP,
	|	БанковскиеСчета.Банк.Наименование КАК BankN,
	|	БанковскиеСчета.Банк.Код КАК BIK,
	|	БанковскиеСчета.НомерСчета КАК acount,
	|	"""" КАК comment
	|ИЗ
	|	Справочник.БанковскиеСчета КАК БанковскиеСчета
	|ГДЕ
	|	БанковскиеСчета.Владелец ССЫЛКА Справочник.Контрагенты");
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("kodupp"		, "S"	, 9);
	ФайлВыгрузки.Поля.Добавить("name"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("kontr"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("INN"		, "S"	, 12);
	ФайлВыгрузки.Поля.Добавить("KPP"		, "S"	, 9);
	ФайлВыгрузки.Поля.Добавить("BankN"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("BIK"		, "S"	, 9);
	ФайлВыгрузки.Поля.Добавить("acount"		, "S"	, 20);
	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 500);
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();	
	
КонецПроцедуры

Процедура ВыполнитьОбменПУБ77_Номенклатура(Настройка, ЕстьОшибки)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	СпрНоменклатура.Код КАК kodupp,
	|	СпрНоменклатура.Наименование КАК name,
	|	СпрНоменклатура.НаименованиеПолное КАК namefull,
	|	СпрНоменклатура.Артикул КАК art,
	|	ВЫРАЗИТЬ(ЕСТЬNULL(Штрихкоды.Штрихкод, """") КАК СТРОКА(200)) КАК bar,
	|	ВЫБОР
	|		КОГДА СпрНоменклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ СпрНоменклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА СпрНоменклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ СпрНоменклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА СпрНоменклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС0)
	|				ИЛИ СпрНоменклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|			ТОГДА 0
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК NDS,
	|	ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) КАК price,
	|	СпрНоменклатура.СтранаПроисхождения.Наименование КАК country,
	|	СпрНоменклатура.Комментарий КАК comment
	|ИЗ
	|	Справочник.Номенклатура КАК СпрНоменклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
	|				,
	|				ТипЦен В
	|					(ВЫБРАТЬ
	|						Константы.абс_ТипЦенПродажиЛеовитЛеотон
	|					ИЗ
	|						Константы КАК Константы)) КАК ЦеныНоменклатурыСрезПоследних
	|		ПО (ЦеныНоменклатурыСрезПоследних.Номенклатура = СпрНоменклатура.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО (Штрихкоды.Владелец = СпрНоменклатура.Ссылка)
	|			И (Штрихкоды.ЕдиницаИзмерения = СпрНоменклатура.ЕдиницаХраненияОстатков)
	|			И (Штрихкоды.ТипШтрихкода = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13))
	|			И (Штрихкоды.СерияНоменклатуры = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка))
	|ГДЕ
	|	НЕ СпрНоменклатура.ЭтоГруппа");
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("kodupp"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("name"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("namefull"	, "S"	, 500);
	ФайлВыгрузки.Поля.Добавить("art"		, "S"	, 25);
	ФайлВыгрузки.Поля.Добавить("bar"		, "S"	, 200);
	ФайлВыгрузки.Поля.Добавить("NDS"		, "N"	, 2);
	ФайлВыгрузки.Поля.Добавить("price"		, "N"	, 15,2);
	ФайлВыгрузки.Поля.Добавить("country"	, "S"	, 60);
	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 500);
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();	
	
КонецПроцедуры

Процедура ВыполнитьОбменПУБ77_Склады(Настройка, ЕстьОшибки)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	Склады.Код КАК kodupp,
	|	Склады.Наименование КАК name,
	|	Склады.Комментарий КАК comment
	|ИЗ
	|	Справочник.Склады КАК Склады");
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("kodupp"		, "S"	, 9);
	ФайлВыгрузки.Поля.Добавить("name"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 500);
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();		
	
КонецПроцедуры

Процедура ВыполнитьОбменПУБ77_ПоступленияТМЦ(Настройка, ЕстьОшибки)	
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ВыпускПродукцииПродукция.Ссылка,
	|	ВыпускПродукцииПродукция.Ссылка.абс_ХозяйственнаяОперация.Наименование КАК type,
	|	ВыпускПродукцииПродукция.Ссылка.Номер КАК Num,
	|	ВыпускПродукцииПродукция.Ссылка.Дата КАК Date,
	|	"""" КАК NumOs,
	|	ДАТАВРЕМЯ(1, 1, 1) КАК DateOs,
	|	"""" КАК NumEx,
	|	ДАТАВРЕМЯ(1, 1, 1) КАК DateEx,
	|	ВыпускПродукцииПродукция.Ссылка.Склад.Наименование КАК Sklad,
		|	"""" КАК Kontr,
	|	"""" КАК KontrINN,
	|	"""" КАК Dog,
	|	"""" КАК SF,
	|	1 КАК S_NDS,
	|	ВыпускПродукцииПродукция.Номенклатура.ВидНоменклатуры.Наименование КАК TypeMPZ,
	|	ВыпускПродукцииПродукция.Номенклатура.Наименование КАК MPZ,
	|	ВыпускПродукцииПродукция.Номенклатура.Артикул КАК MPZ_Art,
	|	ВыпускПродукцииПродукция.Количество КАК Kol,
	|	ВыпускПродукцииПродукция.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК Edizm,
	|	0 КАК Price,
	|	0 КАК Sum,
	|	0 КАК Total,
	|	ВЫБОР
	|		КОГДА ВыпускПродукцииПродукция.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ ВыпускПродукцииПродукция.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА ВыпускПродукцииПродукция.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ ВыпускПродукцииПродукция.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА ВыпускПродукцииПродукция.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС0)
	|				ИЛИ ВыпускПродукцииПродукция.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|			ТОГДА 0
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК NDS,
	|	0 КАК NDSSum,
	|	ВыпускПродукцииПродукция.Ссылка.Комментарий КАК comment,
	|	NULL КАК СФНомер,
	|	NULL КАК СФДата,
	|    ВыпускПродукцииПродукция.Ссылка.ИдентификаторГосКонтракта КАК goskontr
	|ИЗ
	|	Документ.ВыпускПродукции.Продукция КАК ВыпускПродукцииПродукция
	|ГДЕ
	|	ВыпускПродукцииПродукция.Ссылка.Проведен
	|	И ВыпускПродукцииПродукция.Ссылка.Организация = &Организация
	|	И ВыпускПродукцииПродукция.Ссылка.Дата >= &ДатаОтбораДокументов
	|	И ВыпускПродукцииПродукция.Ссылка.Дата <= &ДатаОтбораДокументовОкончание
	|	И ВЫБОР
	|			КОГДА &ФильтроватьПоХозОперацииям
	|				ТОГДА ВыпускПродукцииПродукция.Ссылка.абс_ХозяйственнаяОперация В (&МассивХозОпераций)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПоступлениеТоваровИзПереработкиПродукция.Ссылка,
	|	ПоступлениеТоваровИзПереработкиПродукция.Ссылка.абс_ХозяйственнаяОперация.Наименование,
	|	ПоступлениеТоваровИзПереработкиПродукция.Ссылка.Номер,
	|	ПоступлениеТоваровИзПереработкиПродукция.Ссылка.Дата,
	|	"""",
	|	ДАТАВРЕМЯ(1, 1, 1),
	|	"""",
	|	ДАТАВРЕМЯ(1, 1, 1),
	|	ПоступлениеТоваровИзПереработкиПродукция.Ссылка.СкладОрдер.Наименование,
	|	ПоступлениеТоваровИзПереработкиПродукция.Ссылка.Контрагент.Наименование,
	|	ПоступлениеТоваровИзПереработкиПродукция.Ссылка.Контрагент.ИНН,
	|	ПоступлениеТоваровИзПереработкиПродукция.Ссылка.ДоговорКонтрагента.Наименование,
	|	"""",
	|	1,
	|	ПоступлениеТоваровИзПереработкиПродукция.Номенклатура.ВидНоменклатуры.Наименование,
	|	ПоступлениеТоваровИзПереработкиПродукция.Номенклатура.Наименование,
	|	ПоступлениеТоваровИзПереработкиПродукция.Номенклатура.Артикул,
	|	ПоступлениеТоваровИзПереработкиПродукция.Количество,
	|	ПоступлениеТоваровИзПереработкиПродукция.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код,
	|	0,
	|	0,
	|	0,
	|	ВЫБОР
	|		КОГДА ПоступлениеТоваровИзПереработкиПродукция.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ ПоступлениеТоваровИзПереработкиПродукция.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА ПоступлениеТоваровИзПереработкиПродукция.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ ПоступлениеТоваровИзПереработкиПродукция.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА ПоступлениеТоваровИзПереработкиПродукция.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС0)
	|				ИЛИ ПоступлениеТоваровИзПереработкиПродукция.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|			ТОГДА 0
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	0,
	|	ПоступлениеТоваровИзПереработкиПродукция.Ссылка.Комментарий,
	|	NULL,
	|	NULL,
	|"""" КАК goskontr
	|ИЗ
	|	Документ.ПоступлениеТоваровИзПереработки.Продукция КАК ПоступлениеТоваровИзПереработкиПродукция
	|ГДЕ
	|	ПоступлениеТоваровИзПереработкиПродукция.Ссылка.Проведен
	|	И ПоступлениеТоваровИзПереработкиПродукция.Ссылка.Организация = &Организация
	|	И ПоступлениеТоваровИзПереработкиПродукция.Ссылка.Дата >= &ДатаОтбораДокументов
	|	И ПоступлениеТоваровИзПереработкиПродукция.Ссылка.Дата <= &ДатаОтбораДокументовОкончание
	|	И ВЫБОР
	|			КОГДА &ФильтроватьПоХозОперацииям
	|				ТОГДА ПоступлениеТоваровИзПереработкиПродукция.Ссылка.абс_ХозяйственнаяОперация В (&МассивХозОпераций)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслугТовары.Ссылка,
	|	ПоступлениеТоваровУслугТовары.Ссылка.абс_ХозяйственнаяОперация.Наименование,
	|	ПоступлениеТоваровУслугТовары.Ссылка.Номер,
	|	ПоступлениеТоваровУслугТовары.Ссылка.Дата,
	|	"""",
	|	ДАТАВРЕМЯ(1, 1, 1),
	|	ПоступлениеТоваровУслугТовары.Ссылка.НомерВходящегоДокументаЭлектронногоОбмена,
	|	ПоступлениеТоваровУслугТовары.Ссылка.ДатаВходящегоДокументаЭлектронногоОбмена,
	|	ПоступлениеТоваровУслугТовары.Ссылка.СкладОрдер.Наименование,
	|	ПоступлениеТоваровУслугТовары.Ссылка.Контрагент.Наименование,
	|	ПоступлениеТоваровУслугТовары.Ссылка.Контрагент.ИНН,
	|	ПоступлениеТоваровУслугТовары.Ссылка.ДоговорКонтрагента.Наименование,
	|	"""",
	|	ВЫБОР
	|		КОГДА ПоступлениеТоваровУслугТовары.Ссылка.СуммаВключаетНДС
	|			ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ПоступлениеТоваровУслугТовары.Номенклатура.ВидНоменклатуры.Наименование,
	|	ПоступлениеТоваровУслугТовары.Номенклатура.Наименование,
	|	ПоступлениеТоваровУслугТовары.Номенклатура.Артикул,
	|	ПоступлениеТоваровУслугТовары.Количество,
	|	ПоступлениеТоваровУслугТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код,
	|	ПоступлениеТоваровУслугТовары.Цена,
	|	ПоступлениеТоваровУслугТовары.Сумма,
	|	ВЫБОР
	|		КОГДА ПоступлениеТоваровУслугТовары.Ссылка.СуммаВключаетНДС
	|			ТОГДА ПоступлениеТоваровУслугТовары.Сумма
	|		ИНАЧЕ ПоступлениеТоваровУслугТовары.Сумма + ПоступлениеТоваровУслугТовары.СуммаНДС
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ПоступлениеТоваровУслугТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ ПоступлениеТоваровУслугТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА ПоступлениеТоваровУслугТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ ПоступлениеТоваровУслугТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА ПоступлениеТоваровУслугТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС0)
	|				ИЛИ ПоступлениеТоваровУслугТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|			ТОГДА 0
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ПоступлениеТоваровУслугТовары.СуммаНДС,
	|	ПоступлениеТоваровУслугТовары.Ссылка.Комментарий,
	|	ЕСТЬNULL(СчетФактураПолученный.Номер, """"),
	|	ЕСТЬNULL(СчетФактураПолученный.ДатаВходящегоДокумента, ДАТАВРЕМЯ(1, 1, 1)),
	|"""" КАК goskontr
   	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|		ПО ПоступлениеТоваровУслугТовары.Ссылка = СчетФактураПолученный.ДокументОснование
	|			И (СчетФактураПолученный.Проведен)
	|ГДЕ
	|	ПоступлениеТоваровУслугТовары.Ссылка.Проведен
	|	И ПоступлениеТоваровУслугТовары.Ссылка.Организация = &Организация
	|	И ПоступлениеТоваровУслугТовары.Ссылка.Дата >= &ДатаОтбораДокументов
	|	И ПоступлениеТоваровУслугТовары.Ссылка.Дата <= &ДатаОтбораДокументовОкончание
	|	И ВЫБОР
	|			КОГДА &ФильтроватьПоХозОперацииям
	|				ТОГДА ПоступлениеТоваровУслугТовары.Ссылка.абс_ХозяйственнаяОперация В (&МассивХозОпераций)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВозвратТоваровОтПокупателяТовары.Ссылка,
	|	ВозвратТоваровОтПокупателяТовары.Ссылка.абс_ХозяйственнаяОперация.Наименование,
	|	ВозвратТоваровОтПокупателяТовары.Ссылка.Номер,
	|	ВозвратТоваровОтПокупателяТовары.Ссылка.Дата,
	|	"""",
	|	ДАТАВРЕМЯ(1, 1, 1),
	|	ВозвратТоваровОтПокупателяТовары.Ссылка.НомерВходящегоДокументаЭлектронногоОбмена,
	|	ВозвратТоваровОтПокупателяТовары.Ссылка.ДатаВходящегоДокументаЭлектронногоОбмена,
	|	ВозвратТоваровОтПокупателяТовары.Ссылка.СкладОрдер.Наименование,
	|	ВозвратТоваровОтПокупателяТовары.Ссылка.Контрагент.Наименование,
	|	ВозвратТоваровОтПокупателяТовары.Ссылка.Контрагент.ИНН,
	|	ВозвратТоваровОтПокупателяТовары.Ссылка.ДоговорКонтрагента.Наименование,
	|	"""",
	|	ВЫБОР
	|		КОГДА ВозвратТоваровОтПокупателяТовары.Ссылка.СуммаВключаетНДС
	|			ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВозвратТоваровОтПокупателяТовары.Номенклатура.ВидНоменклатуры.Наименование,
	|	ВозвратТоваровОтПокупателяТовары.Номенклатура.Наименование,
	|	ВозвратТоваровОтПокупателяТовары.Номенклатура.Артикул,
	|	ВозвратТоваровОтПокупателяТовары.Количество,
	|	ВозвратТоваровОтПокупателяТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код,
	|	ВозвратТоваровОтПокупателяТовары.Цена,
	|	ВозвратТоваровОтПокупателяТовары.Сумма,
	|	ВЫБОР
	|		КОГДА ВозвратТоваровОтПокупателяТовары.Ссылка.СуммаВключаетНДС
	|			ТОГДА ВозвратТоваровОтПокупателяТовары.Сумма
	|		ИНАЧЕ ВозвратТоваровОтПокупателяТовары.Сумма + ВозвратТоваровОтПокупателяТовары.СуммаНДС
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ВозвратТоваровОтПокупателяТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ ВозвратТоваровОтПокупателяТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА ВозвратТоваровОтПокупателяТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ ВозвратТоваровОтПокупателяТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА ВозвратТоваровОтПокупателяТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС0)
	|				ИЛИ ВозвратТоваровОтПокупателяТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|			ТОГДА 0
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВозвратТоваровОтПокупателяТовары.СуммаНДС,
	|	ВозвратТоваровОтПокупателяТовары.Ссылка.Комментарий,
	|	ЕСТЬNULL(СчетФактураПолученный.НомерВходящегоДокумента, """"),
	|	ЕСТЬNULL(СчетФактураПолученный.ДатаВходящегоДокумента, ДАТАВРЕМЯ(1, 1, 1)),
	|"""" КАК goskontr
    |ИЗ
	|	Документ.ВозвратТоваровОтПокупателя.Товары КАК ВозвратТоваровОтПокупателяТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|		ПО ВозвратТоваровОтПокупателяТовары.Ссылка = СчетФактураПолученный.ДокументОснование
	|			И (СчетФактураПолученный.Проведен)
	|ГДЕ
	|	ВозвратТоваровОтПокупателяТовары.Ссылка.Проведен
	|	И ВозвратТоваровОтПокупателяТовары.Ссылка.Организация = &Организация
	|	И ВозвратТоваровОтПокупателяТовары.Ссылка.Дата >= &ДатаОтбораДокументов
	|	И ВозвратТоваровОтПокупателяТовары.Ссылка.Дата <= &ДатаОтбораДокументовОкончание
	|	И ВЫБОР
	|			КОГДА &ФильтроватьПоХозОперацииям
	|				ТОГДА ВозвратТоваровОтПокупателяТовары.Ссылка.абс_ХозяйственнаяОперация В (&МассивХозОпераций)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ОприходованиеТоваровТовары.Ссылка,
	|	ОприходованиеТоваровТовары.Ссылка.абс_ХозяйственнаяОперация.Наименование,
	|	ОприходованиеТоваровТовары.Ссылка.Номер,
	|	ОприходованиеТоваровТовары.Ссылка.Дата,
	|	"""",
	|	ДАТАВРЕМЯ(1, 1, 1),
	|	"""",
	|	ДАТАВРЕМЯ(1, 1, 1),
	|	ОприходованиеТоваровТовары.Ссылка.Склад.Наименование,
	|	"""",
	|	"""",
	|	"""",
	|	"""",
	|	1,
	|	ОприходованиеТоваровТовары.Номенклатура.ВидНоменклатуры.Наименование,
	|	ОприходованиеТоваровТовары.Номенклатура.Наименование,
	|	ОприходованиеТоваровТовары.Номенклатура.Артикул,
	|	ОприходованиеТоваровТовары.Количество,
	|	ОприходованиеТоваровТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код,
	|	ОприходованиеТоваровТовары.Цена,
	|	ОприходованиеТоваровТовары.Сумма,
	|	"""",
	|	ВЫБОР
	|		КОГДА ОприходованиеТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ ОприходованиеТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА ОприходованиеТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ ОприходованиеТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА ОприходованиеТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС0)
	|				ИЛИ ОприходованиеТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|			ТОГДА 0
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	0,
	|	ОприходованиеТоваровТовары.Ссылка.Комментарий,
	|	NULL,
	|	NULL,
	|"""" КАК goskontr

	|ИЗ
	|	Документ.ОприходованиеТоваров.Товары КАК ОприходованиеТоваровТовары
	|ГДЕ
	|	ОприходованиеТоваровТовары.Ссылка.Проведен
	|	И ОприходованиеТоваровТовары.Ссылка.Организация = &Организация
	|	И ОприходованиеТоваровТовары.Ссылка.Дата >= &ДатаОтбораДокументов
	|	И ОприходованиеТоваровТовары.Ссылка.Дата <= &ДатаОтбораДокументовОкончание
	|	И ВЫБОР
	|			КОГДА &ФильтроватьПоХозОперацииям
	|				ТОГДА ОприходованиеТоваровТовары.Ссылка.абс_ХозяйственнаяОперация В (&МассивХозОпераций)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|
	|УПОРЯДОЧИТЬ ПО
	|	Date,
	|	Num");
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("type"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Num"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("Date"		, "D");
	ФайлВыгрузки.Поля.Добавить("NumOs"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("DateOs"		, "D");
	ФайлВыгрузки.Поля.Добавить("NumEx"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("DateEx"		, "D");
	ФайлВыгрузки.Поля.Добавить("Sklad"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("Kontr"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("KontrINN"	, "S"	, 12);
	ФайлВыгрузки.Поля.Добавить("Dog"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("SF"			, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("S_NDS"		, "N"	, 1);
	ФайлВыгрузки.Поля.Добавить("TypeMPZ"	, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("MPZ"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("MPZ_Art"	, "S"	, 25);
	ФайлВыгрузки.Поля.Добавить("Kol"		, "N"	, 15, 3);
	ФайлВыгрузки.Поля.Добавить("Edizm"		, "S"	, 3);
	ФайлВыгрузки.Поля.Добавить("Price"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("Sum"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("Total"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("NDS"		, "N"	, 2);
	ФайлВыгрузки.Поля.Добавить("NDSSum"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("goskontr"	, "S"	, 25);
 	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 500);
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Запрос.УстановитьПараметр("Организация"						, Настройка.Организация);
	Запрос.УстановитьПараметр("ДатаОтбораДокументов"			, Настройка.Дата);
	Запрос.УстановитьПараметр("ДатаОтбораДокументовОкончание"	, ?(ЗначениеЗаполнено(Настройка.ДатаОграничения), КонецДня(Настройка.ДатаОграничения), '20991231'));
	
	МассивХозОпераций = Настройка.ХозяйственныеОперации.Выгрузить(, "ХозяйственнаяОперация");
	
	Запрос.УстановитьПараметр("МассивХозОпераций"			, МассивХозОпераций);
	Запрос.УстановитьПараметр("ФильтроватьПоХозОперацииям"	, МассивХозОпераций.Количество() > 0);
	
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		Если ЗначениеЗаполнено(Выборка.СФНомер) Тогда
			ФайлВыгрузки.SF = Выборка.СФНомер + " от " + Формат(Выборка.СФДата, "ДФ=dd.MM.yyyy");
		КонецЕсли;
		 сообщить(ФайлВыгрузки.goskontr);
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();	
	
КонецПроцедуры

Процедура ВыполнитьОбменПУБ77_РеализацииТМЦ(Настройка, ЕстьОшибки)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	СписаниеТоваровТовары.Ссылка,
	|	СписаниеТоваровТовары.Ссылка.абс_ХозяйственнаяОперация.Наименование КАК type,
	|	СписаниеТоваровТовары.Ссылка.Номер КАК Num,
	|	СписаниеТоваровТовары.Ссылка.Дата КАК Date,
	|	"""" КАК clause,
	|	"""" КАК NumOs,
	|	ДАТАВРЕМЯ(1, 1, 1) КАК DateOs,
	|	"""" КАК NumSF,
	|	ДАТАВРЕМЯ(1, 1, 1) КАК DateSF,
	|	СписаниеТоваровТовары.Ссылка.Склад.Наименование КАК Sklad,
	|	СписаниеТоваровТовары.Ссылка.Лео_Контрагент.Наименование КАК Kontr,
	|	"""" КАК KontrINN,
	|	"""" КАК Recip,
	|	"""" КАК RecipID,
	|	"""" КАК Dog,
	|	1 КАК S_NDS,
	|	СписаниеТоваровТовары.Номенклатура.ВидНоменклатуры.Наименование КАК TypeMPZ,
	|	СписаниеТоваровТовары.Номенклатура.Наименование КАК MPZ,
	|	СписаниеТоваровТовары.Номенклатура.Артикул КАК MPZ_Art,
	|	СписаниеТоваровТовары.Количество КАК Kol,
	|	СписаниеТоваровТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК Edizm,
	|	0 КАК Price,
	|	0 КАК Sum,
	|	0 КАК Total,
	|	ВЫБОР
	|		КОГДА СписаниеТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ СписаниеТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА СписаниеТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ СписаниеТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА СписаниеТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС0)
	|				ИЛИ СписаниеТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|			ТОГДА 0
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК NDS,
	|	0 КАК NDSSum,
	|	ВЫРАЗИТЬ(СписаниеТоваровТовары.Ссылка.Комментарий КАК СТРОКА(500)) КАК comment,
	|	ЕСТЬNULL(СписаниеТоваровТовары.Ссылка.Лео_ПричинаСписания.Наименование, """") КАК spis,
	|	СписаниеТоваровТовары.Ссылка.Подразделение.Код КАК CFO
	|ИЗ
	|	Документ.СписаниеТоваров.Товары КАК СписаниеТоваровТовары
	|ГДЕ
	|	СписаниеТоваровТовары.Ссылка.Проведен
	|	И СписаниеТоваровТовары.Ссылка.Организация = &Организация
	|	И СписаниеТоваровТовары.Ссылка.Дата >= &ДатаОтбораДокументов
	|	И СписаниеТоваровТовары.Ссылка.Дата <= &ДатаОтбораДокументовОкончание
	|	И ВЫБОР
	|			КОГДА &ФильтроватьПоХозОперацииям
	|				ТОГДА СписаниеТоваровТовары.Ссылка.абс_ХозяйственнаяОперация В (&МассивХозОпераций)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Ссылка,
	|	РеализацияТоваровУслугТовары.Ссылка.абс_ХозяйственнаяОперация.Наименование,
	|	РеализацияТоваровУслугТовары.Ссылка.Номер,
	|	РеализацияТоваровУслугТовары.Ссылка.Дата,
	|	"""",
	|	"""",
	|	ДАТАВРЕМЯ(1, 1, 1),
	|	ЕСТЬNULL(СчетФактураВыданный.Номер, """"),
	|	ЕСТЬNULL(СчетФактураВыданный.Дата, ДАТАВРЕМЯ(1, 1, 1)),
	|	РеализацияТоваровУслугТовары.Ссылка.Склад.Наименование,
	|	РеализацияТоваровУслугТовары.Ссылка.Контрагент.Наименование,
	|	РеализацияТоваровУслугТовары.Ссылка.Контрагент.ИНН,
	|	РеализацияТоваровУслугТовары.Ссылка.Грузополучатель.Наименование,
	|	РеализацияТоваровУслугТовары.Ссылка.Грузополучатель.Код,
	|	РеализацияТоваровУслугТовары.Ссылка.ДоговорКонтрагента.Наименование,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС
	|			ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.Номенклатура.ВидНоменклатуры.Наименование,
	|	РеализацияТоваровУслугТовары.Номенклатура.Наименование,
	|	РеализацияТоваровУслугТовары.Номенклатура.Артикул,
	|	РеализацияТоваровУслугТовары.Количество,
	|	РеализацияТоваровУслугТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код,
	|	РеализацияТоваровУслугТовары.Цена,
	|	РеализацияТоваровУслугТовары.Сумма,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Ссылка.СуммаВключаетНДС
	|			ТОГДА РеализацияТоваровУслугТовары.Сумма
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Сумма + РеализацияТоваровУслугТовары.СуммаНДС
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РеализацияТоваровУслугТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РеализацияТоваровУслугТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РеализацияТоваровУслугТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РеализацияТоваровУслугТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС0)
	|				ИЛИ РеализацияТоваровУслугТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|			ТОГДА 0
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	РеализацияТоваровУслугТовары.СуммаНДС,
	|	ВЫРАЗИТЬ(РеализацияТоваровУслугТовары.Ссылка.Комментарий КАК СТРОКА(500)),
	|	"""",
	|	""""
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|		ПО РеализацияТоваровУслугТовары.Ссылка = СчетФактураВыданный.ДокументОснование
	|			И (РеализацияТоваровУслугТовары.Ссылка.Проведен)
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка.Проведен
	|	И РеализацияТоваровУслугТовары.Ссылка.Организация = &Организация
	|	И РеализацияТоваровУслугТовары.Ссылка.Дата >= &ДатаОтбораДокументов
	|	И РеализацияТоваровУслугТовары.Ссылка.Дата <= &ДатаОтбораДокументовОкончание
	|	И ВЫБОР
	|			КОГДА &ФильтроватьПоХозОперацииям
	|				ТОГДА РеализацияТоваровУслугТовары.Ссылка.абс_ХозяйственнаяОперация В (&МассивХозОпераций)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|
	|УПОРЯДОЧИТЬ ПО
	|	Date,
	|	Num");
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("type"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Num"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("clause"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Date"		, "D");
	ФайлВыгрузки.Поля.Добавить("NumOs"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("DateOs"		, "D");
	ФайлВыгрузки.Поля.Добавить("NumSF"		, "S"	, 12);
	ФайлВыгрузки.Поля.Добавить("DateSF"		, "D");
	ФайлВыгрузки.Поля.Добавить("Sklad"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("Kontr"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("KontrINN"	, "S"	, 12);
	ФайлВыгрузки.Поля.Добавить("Recip"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("RecipID"	, "S"	, 9);
	ФайлВыгрузки.Поля.Добавить("Dog"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("S_NDS"		, "N"	, 1);
	ФайлВыгрузки.Поля.Добавить("TypeMPZ"	, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("MPZ"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("MPZ_Art"	, "S"	, 25);
	ФайлВыгрузки.Поля.Добавить("Kol"		, "N"	, 15, 3);
	ФайлВыгрузки.Поля.Добавить("Edizm"		, "S"	, 3);
	ФайлВыгрузки.Поля.Добавить("Price"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("Sum"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("Total"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("NDS"		, "N"	, 2);
	ФайлВыгрузки.Поля.Добавить("NDSSum"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("spis"	, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 500);	
	ФайлВыгрузки.Поля.Добавить("CFO"	, "S"	, 9);
	
	//+ лео Сафонов 16.09.16
	//ФайлВыгрузки.Поля.Добавить("CFO"	, "S"	, 9);
    //

	//+ лео Никитин 19.02.16
	//ФайлВыгрузки.Поля.Добавить("spis"	, "S"	, 100);
    //
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Запрос.УстановитьПараметр("Организация"						, Настройка.Организация);
	Запрос.УстановитьПараметр("ДатаОтбораДокументов"			, Настройка.Дата);
	Запрос.УстановитьПараметр("ДатаОтбораДокументовОкончание"	, ?(ЗначениеЗаполнено(Настройка.ДатаОграничения), КонецДня(Настройка.ДатаОграничения), '20991231'));
	
	МассивХозОпераций = Настройка.ХозяйственныеОперации.Выгрузить(, "ХозяйственнаяОперация");
	
	Запрос.УстановитьПараметр("МассивХозОпераций"			, МассивХозОпераций);
	Запрос.УстановитьПараметр("ФильтроватьПоХозОперацииям"	, МассивХозОпераций.Количество() > 0);	
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();	
	
КонецПроцедуры


Процедура ВыполнитьОбменПУБ77_ПередачаТоваров(Настройка, ЕстьОшибки)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ПередачаТоваровТовары.Ссылка,
	|	""Передача товаров в переработку"" КАК type,
	|	ПередачаТоваровТовары.Ссылка.Номер КАК Num,
	|	ПередачаТоваровТовары.Ссылка.Дата КАК Date,
	|	"""" КАК clause,
	|	"""" КАК NumOs,
	|	ДАТАВРЕМЯ(1, 1, 1) КАК DateOs,
	|	"""" КАК NumSF,
	|	ДАТАВРЕМЯ(1, 1, 1) КАК DateSF,
	|	ПередачаТоваровТовары.Ссылка.Склад.Наименование КАК Sklad,
	|	ПередачаТоваровТовары.Ссылка.Контрагент.Наименование КАК Kontr,
	|	ПередачаТоваровТовары.Ссылка.Контрагент.ИНН КАК KontrINN,
	|	ПередачаТоваровТовары.Ссылка.Грузополучатель.Наименование КАК Recip,
	|	ПередачаТоваровТовары.Ссылка.Грузополучатель.Код КАК RecipID,
	|	ПередачаТоваровТовары.Ссылка.ДоговорКонтрагента.Наименование КАК Dog,
	|	1 КАК S_NDS,
	|	ПередачаТоваровТовары.Номенклатура.ВидНоменклатуры.Наименование КАК TypeMPZ,
	|	ПередачаТоваровТовары.Номенклатура.Наименование КАК MPZ,
	|	ПередачаТоваровТовары.Номенклатура.Артикул КАК MPZ_Art,
	|	ПередачаТоваровТовары.Количество КАК Kol,
	|	ПередачаТоваровТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК Edizm,
	|	ПередачаТоваровТовары.Цена КАК Price,
	|	ПередачаТоваровТовары.Сумма КАК Sum,
	|	ПередачаТоваровТовары.Ссылка.СуммаДокумента КАК Total,
	|	ВЫБОР
	|		КОГДА ПередачаТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ ПередачаТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА ПередачаТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ ПередачаТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА ПередачаТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС0)
	|				ИЛИ ПередачаТоваровТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|			ТОГДА 0
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК NDS,
	|	0 КАК NDSSum,
	|	ВЫРАЗИТЬ(ПередачаТоваровТовары.Ссылка.Комментарий КАК СТРОКА(500)) КАК comment,
	|	"""" КАК spis,
	|	"""" КАК CFO
	|ИЗ
	|	Документ.ПередачаТоваров.Товары КАК ПередачаТоваровТовары
	|ГДЕ
	|	ПередачаТоваровТовары.Ссылка.Проведен
	|	И ПередачаТоваровТовары.Ссылка.Дата МЕЖДУ &ДатаОтбораДокументов И &ДатаОтбораДокументовОкончание
	|	И ПередачаТоваровТовары.Ссылка.Организация = &Организация
	|
	|УПОРЯДОЧИТЬ ПО
	|	Date,
	|	Num");
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("type"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Num"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("clause"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Date"		, "D");
	ФайлВыгрузки.Поля.Добавить("NumOs"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("DateOs"		, "D");
	ФайлВыгрузки.Поля.Добавить("NumSF"		, "S"	, 12);
	ФайлВыгрузки.Поля.Добавить("DateSF"		, "D");
	ФайлВыгрузки.Поля.Добавить("Sklad"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("Kontr"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("KontrINN"	, "S"	, 12);
	ФайлВыгрузки.Поля.Добавить("Recip"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("RecipID"	, "S"	, 9);
	ФайлВыгрузки.Поля.Добавить("Dog"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("S_NDS"		, "N"	, 1);
	ФайлВыгрузки.Поля.Добавить("TypeMPZ"	, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("MPZ"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("MPZ_Art"	, "S"	, 25);
	ФайлВыгрузки.Поля.Добавить("Kol"		, "N"	, 15, 3);
	ФайлВыгрузки.Поля.Добавить("Edizm"		, "S"	, 3);
	ФайлВыгрузки.Поля.Добавить("Price"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("Sum"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("Total"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("NDS"		, "N"	, 2);
	ФайлВыгрузки.Поля.Добавить("NDSSum"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("spis"	, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 500);	
	ФайлВыгрузки.Поля.Добавить("CFO"	, "S"	, 9);
	
	//+ лео Сафонов 16.09.16
	//ФайлВыгрузки.Поля.Добавить("CFO"	, "S"	, 9);
    //

	//+ лео Никитин 19.02.16
	//ФайлВыгрузки.Поля.Добавить("spis"	, "S"	, 100);
    //
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Запрос.УстановитьПараметр("Организация"						, Настройка.Организация);
	Запрос.УстановитьПараметр("ДатаОтбораДокументов"			, Настройка.Дата);
	Запрос.УстановитьПараметр("ДатаОтбораДокументовОкончание"	, ?(ЗначениеЗаполнено(Настройка.ДатаОграничения), КонецДня(Настройка.ДатаОграничения), '20991231'));
	
	МассивХозОпераций = Настройка.ХозяйственныеОперации.Выгрузить(, "ХозяйственнаяОперация");
	
	Запрос.УстановитьПараметр("МассивХозОпераций"			, МассивХозОпераций);
	Запрос.УстановитьПараметр("ФильтроватьПоХозОперацииям"	, МассивХозОпераций.Количество() > 0);	
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();	
	
КонецПроцедуры


Процедура ВыполнитьОбменПУБ77_ЗаказыПокупателей(Настройка, ЕстьОшибки)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ЗаказПокупателяТовары.Ссылка,
	|	ЗаказПокупателяТовары.Ссылка.абс_ХозяйственнаяОперация.Наименование КАК type,
	|	ЗаказПокупателяТовары.Ссылка.Номер КАК Num,
	|	ЗаказПокупателяТовары.Ссылка.Дата КАК Date,
	|	"""" КАК NumOs,
	|	ДАТАВРЕМЯ(1, 1, 1) КАК DateOs,
	|	ЗаказПокупателяТовары.Ссылка.ДатаОтгрузки КАК DateSale,
	|	ЗаказПокупателяТовары.Ссылка.Контрагент.Наименование КАК Kontr,
	|	ЗаказПокупателяТовары.Ссылка.Контрагент.ИНН КАК KontrINN,
	|	ЗаказПокупателяТовары.Ссылка.Грузополучатель.Наименование КАК Recip,
	|	ЗаказПокупателяТовары.Ссылка.Грузополучатель.Код КАК RecipID,
	|	ЗаказПокупателяТовары.Ссылка.ДоговорКонтрагента.Наименование КАК Dog,
	|	ВЫБОР
	|		КОГДА ЗаказПокупателяТовары.Ссылка.СуммаВключаетНДС
	|			ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК S_NDS,
	|	ЗаказПокупателяТовары.Номенклатура.ВидНоменклатуры.Наименование КАК TypeMPZ,
	|	ЗаказПокупателяТовары.Номенклатура.Наименование КАК MPZ,
	|	ЗаказПокупателяТовары.Номенклатура.Артикул КАК MPZ_Art,
	|	ЗаказПокупателяТовары.Количество КАК Kol,
	|	ЗаказПокупателяТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК Edizm,
	|	ЗаказПокупателяТовары.Цена КАК Price,
	|	ЗаказПокупателяТовары.Сумма КАК Sum,
	|	ВЫБОР
	|		КОГДА ЗаказПокупателяТовары.Ссылка.СуммаВключаетНДС
	|			ТОГДА ЗаказПокупателяТовары.Сумма
	|		ИНАЧЕ ЗаказПокупателяТовары.Сумма + ЗаказПокупателяТовары.СуммаНДС
	|	КОНЕЦ КАК Total,
	|	ВЫБОР
	|		КОГДА ЗаказПокупателяТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ ЗаказПокупателяТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА ЗаказПокупателяТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ ЗаказПокупателяТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА ЗаказПокупателяТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС0)
	|				ИЛИ ЗаказПокупателяТовары.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|			ТОГДА 0
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК NDS,
	|	ЗаказПокупателяТовары.СуммаНДС КАК NDSSum,
	|	ЗаказПокупателяТовары.Ссылка.Комментарий КАК comment
	|ИЗ
	|	Документ.ЗаказПокупателя.Товары КАК ЗаказПокупателяТовары
	|ГДЕ
	|	ЗаказПокупателяТовары.Ссылка.Проведен
	|	И ЗаказПокупателяТовары.Ссылка.Организация = &Организация
	|	И ЗаказПокупателяТовары.Ссылка.Дата >= &ДатаОтбораДокументов
	|	И ЗаказПокупателяТовары.Ссылка.Дата <= &ДатаОтбораДокументовОкончание
	|	И ВЫБОР
	|			КОГДА &ФильтроватьПоХозОперацииям
	|				ТОГДА ЗаказПокупателяТовары.Ссылка.абс_ХозяйственнаяОперация В (&МассивХозОпераций)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|
	|УПОРЯДОЧИТЬ ПО
	|	Date,
	|	Num");
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("type"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Num"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("Date"		, "D");
	ФайлВыгрузки.Поля.Добавить("NumOs"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("DateOs"		, "D");
	ФайлВыгрузки.Поля.Добавить("Sklad"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("Kontr"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("KontrINN"	, "S"	, 12);
	ФайлВыгрузки.Поля.Добавить("Recip"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("RecipID"	, "S"	, 9);
	ФайлВыгрузки.Поля.Добавить("Dog"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("S_NDS"		, "N"	, 1);
	ФайлВыгрузки.Поля.Добавить("TypeMPZ"	, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("MPZ"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("MPZ_Art"	, "S"	, 25);
	ФайлВыгрузки.Поля.Добавить("Kol"		, "N"	, 15, 3);
	ФайлВыгрузки.Поля.Добавить("Edizm"		, "S"	, 3);
	ФайлВыгрузки.Поля.Добавить("Price"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("Sum"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("Total"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("NDS"		, "N"	, 2);
	ФайлВыгрузки.Поля.Добавить("NDSSum"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 500);
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Запрос.УстановитьПараметр("Организация"						, Настройка.Организация);
	Запрос.УстановитьПараметр("ДатаОтбораДокументов"			, Настройка.Дата);
	Запрос.УстановитьПараметр("ДатаОтбораДокументовОкончание"	, ?(ЗначениеЗаполнено(Настройка.ДатаОграничения), КонецДня(Настройка.ДатаОграничения), '20991231'));
	
	МассивХозОпераций = Настройка.ХозяйственныеОперации.Выгрузить(, "ХозяйственнаяОперация");
	
	Запрос.УстановитьПараметр("МассивХозОпераций"			, МассивХозОпераций);
	Запрос.УстановитьПараметр("ФильтроватьПоХозОперацииям"	, МассивХозОпераций.Количество() > 0);	
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();		
	
КонецПроцедуры

Процедура ВыполнитьОбменПУБ77_КорректировкиДолга(Настройка, ЕстьОшибки)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	КорректировкаДолгаСуммыДолга.Ссылка КАК Ссылка,
	|	КорректировкаДолгаСуммыДолга.Ссылка.абс_ХозяйственнаяОперация.Наименование КАК type,
	|	КорректировкаДолгаСуммыДолга.Ссылка.Номер КАК Num,
	|	КорректировкаДолгаСуммыДолга.Ссылка.Дата КАК Date,
	|	ВЫБОР
	|		КОГДА КорректировкаДолгаСуммыДолга.ВидЗадолженности = ЗНАЧЕНИЕ(перечисление.видыЗадолженности.Кредиторская)
	|			ТОГДА КорректировкаДолгаСуммыДолга.ДоговорКонтрагента.Владелец.Наименование
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК KontrD,
	|	ВЫБОР
	|		КОГДА КорректировкаДолгаСуммыДолга.ВидЗадолженности = ЗНАЧЕНИЕ(перечисление.видыЗадолженности.Кредиторская)
	|			ТОГДА КорректировкаДолгаСуммыДолга.ДоговорКонтрагента.Владелец.ИНН
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК KontrINND,
	|	ВЫБОР
	|		КОГДА КорректировкаДолгаСуммыДолга.ВидЗадолженности = ЗНАЧЕНИЕ(перечисление.видыЗадолженности.Дебиторская)
	|			ТОГДА КорректировкаДолгаСуммыДолга.ДоговорКонтрагента.Владелец.Наименование
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК KontrK,
	|	ВЫБОР
	|		КОГДА КорректировкаДолгаСуммыДолга.ВидЗадолженности = ЗНАЧЕНИЕ(перечисление.видыЗадолженности.Дебиторская)
	|			ТОГДА КорректировкаДолгаСуммыДолга.ДоговорКонтрагента.Владелец.ИНН
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК KontrINNK,
	|	ВЫБОР
	|		КОГДА КорректировкаДолгаСуммыДолга.ВидЗадолженности = ЗНАЧЕНИЕ(перечисление.видыЗадолженности.Кредиторская)
	|			ТОГДА КорректировкаДолгаСуммыДолга.ДоговорКонтрагента.Наименование
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК DogD,
	|	ВЫБОР
	|		КОГДА КорректировкаДолгаСуммыДолга.ВидЗадолженности = ЗНАЧЕНИЕ(перечисление.видыЗадолженности.Дебиторская)
	|			ТОГДА КорректировкаДолгаСуммыДолга.ДоговорКонтрагента.Наименование
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК DogK,
	|	1 КАК S_NDS,
	|	"""" КАК OsnTypeD,
	|	ВЫБОР
	|		КОГДА КорректировкаДолгаСуммыДолга.ВидЗадолженности = ЗНАЧЕНИЕ(перечисление.видыЗадолженности.Кредиторская)
	|			ТОГДА КорректировкаДолгаСуммыДолга.ДокументРасчетовСКонтрагентом.Номер
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК NumD,
	|	ВЫБОР
	|		КОГДА КорректировкаДолгаСуммыДолга.ВидЗадолженности = ЗНАЧЕНИЕ(перечисление.видыЗадолженности.Кредиторская)
	|			ТОГДА КорректировкаДолгаСуммыДолга.ДокументРасчетовСКонтрагентом.Дата
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК DateD,
	|	"""" КАК OsnTypeK,
	|	ВЫБОР
	|		КОГДА КорректировкаДолгаСуммыДолга.ВидЗадолженности = ЗНАЧЕНИЕ(перечисление.видыЗадолженности.Дебиторская)
	|			ТОГДА КорректировкаДолгаСуммыДолга.ДокументРасчетовСКонтрагентом.Номер
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК NumK,
	|	ВЫБОР
	|		КОГДА КорректировкаДолгаСуммыДолга.ВидЗадолженности = ЗНАЧЕНИЕ(перечисление.видыЗадолженности.Дебиторская)
	|			ТОГДА КорректировкаДолгаСуммыДолга.ДокументРасчетовСКонтрагентом.Дата
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК DateK,
	|	ВЫБОР
	|		КОГДА КорректировкаДолгаСуммыДолга.ВидЗадолженности = ЗНАЧЕНИЕ(перечисление.видыЗадолженности.Кредиторская)
	|			ТОГДА КорректировкаДолгаСуммыДолга.Сумма
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК TotalD,
	|	ВЫБОР
	|		КОГДА КорректировкаДолгаСуммыДолга.ВидЗадолженности = ЗНАЧЕНИЕ(перечисление.видыЗадолженности.Дебиторская)
	|			ТОГДА КорректировкаДолгаСуммыДолга.Сумма
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК TotalK,
	|	0 КАК NDS,
	|	КорректировкаДолгаСуммыДолга.Ссылка.Комментарий КАК comment,
	|	ВЫБОР
	|		КОГДА КорректировкаДолгаСуммыДолга.ВидЗадолженности = ЗНАЧЕНИЕ(перечисление.видыЗадолженности.Кредиторская)
	|			ТОГДА КорректировкаДолгаСуммыДолга.ДокументРасчетовСКонтрагентом
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументДебет,
	|	ВЫБОР
	|		КОГДА КорректировкаДолгаСуммыДолга.ВидЗадолженности = ЗНАЧЕНИЕ(перечисление.видыЗадолженности.Дебиторская)
	|			ТОГДА КорректировкаДолгаСуммыДолга.ДокументРасчетовСКонтрагентом
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументКредит
	|ИЗ
	|	Документ.КорректировкаДолга.СуммыДолга КАК КорректировкаДолгаСуммыДолга
	|ГДЕ
	|	КорректировкаДолгаСуммыДолга.Ссылка.Проведен
	|	И КорректировкаДолгаСуммыДолга.Ссылка.Организация = &Организация
	|	И КорректировкаДолгаСуммыДолга.Ссылка.Дата >= &ДатаОтбораДокументов
	|	И КорректировкаДолгаСуммыДолга.Ссылка.Дата <= &ДатаОтбораДокументовОкончание
	|	И ВЫБОР
	|			КОГДА &ФильтроватьПоХозОперацииям
	|				ТОГДА КорректировкаДолгаСуммыДолга.Ссылка.абс_ХозяйственнаяОперация В (&МассивХозОпераций)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ");
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("type"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Num"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("Date"		, "D");
	ФайлВыгрузки.Поля.Добавить("KontrD"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("KontrINND"	, "S"	, 12);
	ФайлВыгрузки.Поля.Добавить("KontrK"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("KontrINNK"	, "S"	, 12);
	ФайлВыгрузки.Поля.Добавить("DogD"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("DogK"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("S_NDS"		, "N"	, 1);
	ФайлВыгрузки.Поля.Добавить("OsnTypeD"	, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("NumD"		, "S"	, 12);
	ФайлВыгрузки.Поля.Добавить("DateD"		, "D");
	ФайлВыгрузки.Поля.Добавить("OsnTypeK"	, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("NumK"		, "S"	, 12);
	ФайлВыгрузки.Поля.Добавить("DateK"		, "D");		
	ФайлВыгрузки.Поля.Добавить("TotalD"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("TotalK"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("NDS"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 500);
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Запрос.УстановитьПараметр("Организация"						, Настройка.Организация);
	Запрос.УстановитьПараметр("ДатаОтбораДокументов"			, Настройка.Дата);
	Запрос.УстановитьПараметр("ДатаОтбораДокументовОкончание"	, ?(ЗначениеЗаполнено(Настройка.ДатаОграничения), КонецДня(Настройка.ДатаОграничения), '20991231'));
	
	МассивХозОпераций = Настройка.ХозяйственныеОперации.Выгрузить(, "ХозяйственнаяОперация");
	
	Запрос.УстановитьПараметр("МассивХозОпераций"			, МассивХозОпераций);
	Запрос.УстановитьПараметр("ФильтроватьПоХозОперацииям"	, МассивХозОпераций.Количество() > 0);	
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		Если ЗначениеЗаполнено(Выборка.ДокументДебет) Тогда
			ФайлВыгрузки.OsnTypeD = Выборка.ДокументДебет.Метаданные().Имя;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Выборка.ДокументКредит) Тогда
			ФайлВыгрузки.OsnTypeK = Выборка.ДокументКредит.Метаданные().Имя;
		КонецЕсли;		
		
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();	
	
КонецПроцедуры

Процедура ВыполнитьОбменПУБ77_ПеремещенияТМЦ(Настройка, ЕстьОшибки)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ПеремещениеТоваровТовары.Ссылка,
	|	ПеремещениеТоваровТовары.Ссылка.абс_ХозяйственнаяОперация.Наименование КАК type,
	|	ПеремещениеТоваровТовары.Ссылка.Номер КАК Num,
	|	ПеремещениеТоваровТовары.Ссылка.Дата КАК Date,
	|	"""" КАК OsnType,
	|	"""" КАК OsnNum,
	|	ДАТАВРЕМЯ(1, 1, 1) КАК OsnDate,
	|	ПеремещениеТоваровТовары.Ссылка.СкладОтправитель.Наименование КАК Sklad,
	|	ПеремещениеТоваровТовары.Ссылка.СкладПолучатель.Наименование КАК ToSklad,
	|	ПеремещениеТоваровТовары.Номенклатура.ВидНоменклатуры.Наименование КАК TypeMPZ,
	|	ПеремещениеТоваровТовары.Номенклатура.Наименование КАК MPZ,
	|	ПеремещениеТоваровТовары.Номенклатура.Артикул КАК MPZ_Art,
	|	ПеремещениеТоваровТовары.Количество КАК Kol,
	|	ПеремещениеТоваровТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК Edizm,
	|	ПеремещениеТоваровТовары.Ссылка.Комментарий КАК comment
	|ИЗ
	|	Документ.ПеремещениеТоваров.Товары КАК ПеремещениеТоваровТовары
	|ГДЕ
	|	ПеремещениеТоваровТовары.Ссылка.Проведен
	|	И ПеремещениеТоваровТовары.Ссылка.Организация = &Организация
	|	И ПеремещениеТоваровТовары.Ссылка.Дата >= &ДатаОтбораДокументов
	|	И ПеремещениеТоваровТовары.Ссылка.Дата <= &ДатаОтбораДокументовОкончание
	|	И ВЫБОР
	|			КОГДА &ФильтроватьПоХозОперацииям
	|				ТОГДА ПеремещениеТоваровТовары.Ссылка.абс_ХозяйственнаяОперация В (&МассивХозОпераций)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|
	|УПОРЯДОЧИТЬ ПО
	|	Date,
	|	Num");
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("type"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Num"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("Date"		, "D");
	ФайлВыгрузки.Поля.Добавить("OsnType"	, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("OsnNum"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("OsnDate"	, "D");
	ФайлВыгрузки.Поля.Добавить("Sklad"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("ToSklad"	, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("TypeMPZ"	, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("MPZ"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("MPZ_Art"	, "S"	, 25);
	ФайлВыгрузки.Поля.Добавить("Kol"		, "N"	, 15, 3);
	ФайлВыгрузки.Поля.Добавить("Edizm"		, "S"	, 3);
	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 500);
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Запрос.УстановитьПараметр("Организация"						, Настройка.Организация);
	Запрос.УстановитьПараметр("ДатаОтбораДокументов"			, Настройка.Дата);
	Запрос.УстановитьПараметр("ДатаОтбораДокументовОкончание"	, ?(ЗначениеЗаполнено(Настройка.ДатаОграничения), КонецДня(Настройка.ДатаОграничения), '20991231'));
	
	МассивХозОпераций = Настройка.ХозяйственныеОперации.Выгрузить(, "ХозяйственнаяОперация");
	
	Запрос.УстановитьПараметр("МассивХозОпераций"			, МассивХозОпераций);
	Запрос.УстановитьПараметр("ФильтроватьПоХозОперацииям"	, МассивХозОпераций.Количество() > 0);	
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();		
	
КонецПроцедуры

Процедура ВыполнитьОбменПУБ77_ПриходныеКассовыеОрдера(Настройка, ЕстьОшибки)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка,
	|	ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.абс_ХозяйственнаяОперация.Наименование КАК type,
	|	ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Номер КАК Num,
	|	ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Дата КАК Date,
	|	ПриходныйКассовыйОрдерРасшифровкаПлатежа.СтатьяДвиженияДенежныхСредств.Наименование КАК clause,
	|	ВЫБОР
	|		КОГДА ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Контрагент ССЫЛКА Справочник.Контрагенты
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Контрагент = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|						ТОГДА ВЫРАЗИТЬ(ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Контрагент КАК Справочник.Контрагенты).Наименование
	|					ИНАЧЕ ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.ПринятоОт
	|				КОНЕЦ
	|		ИНАЧЕ ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.ПринятоОт
	|	КОНЕЦ КАК kontr,
	|	ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.СчетУчетаРасчетовСКонтрагентом.Наименование КАК korAcc,
	|	ПРЕДСТАВЛЕНИЕ(ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.СубконтоКт1) КАК Sub1,
	|	ПРЕДСТАВЛЕНИЕ(ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.СубконтоКт2) КАК Sub2,
	|	ПРЕДСТАВЛЕНИЕ(ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.СубконтоКт3) КАК Sub3,
	|	ПриходныйКассовыйОрдерРасшифровкаПлатежа.СуммаПлатежа КАК Total,
	|	ВЫБОР
	|		КОГДА ПриходныйКассовыйОрдерРасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ ПриходныйКассовыйОрдерРасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА ПриходныйКассовыйОрдерРасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ ПриходныйКассовыйОрдерРасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА ПриходныйКассовыйОрдерРасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС0)
	|				ИЛИ ПриходныйКассовыйОрдерРасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|			ТОГДА 0
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК NDS,
	|	ПриходныйКассовыйОрдерРасшифровкаПлатежа.СуммаНДС КАК NDSSum,
	|	ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Комментарий КАК comment
	|ИЗ
	|	Документ.ПриходныйКассовыйОрдер.РасшифровкаПлатежа КАК ПриходныйКассовыйОрдерРасшифровкаПлатежа
	|ГДЕ
	|	ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Проведен
	|	И ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Организация = &Организация
	|	И ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Дата >= &ДатаОтбораДокументов
	|	И ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Дата <= &ДатаОтбораДокументовОкончание
	|	И ВЫБОР
	|			КОГДА &ФильтроватьПоХозОперацииям
	|				ТОГДА ПриходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.абс_ХозяйственнаяОперация В (&МассивХозОпераций)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ");
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("type"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Num"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("Date"		, "D");
	ФайлВыгрузки.Поля.Добавить("clause"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("kontr"		, "S"	, 500);
	ФайлВыгрузки.Поля.Добавить("korAcc"		, "S"	, 10);
	ФайлВыгрузки.Поля.Добавить("Sub1"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Sub2"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Sub3"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Total"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("NDS"		, "N"	, 2);
	ФайлВыгрузки.Поля.Добавить("NDSSum"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 500);
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Запрос.УстановитьПараметр("Организация"						, Настройка.Организация);
	Запрос.УстановитьПараметр("ДатаОтбораДокументов"			, Настройка.Дата);
	Запрос.УстановитьПараметр("ДатаОтбораДокументовОкончание"	, ?(ЗначениеЗаполнено(Настройка.ДатаОграничения), КонецДня(Настройка.ДатаОграничения), '20991231'));
	
	МассивХозОпераций = Настройка.ХозяйственныеОперации.Выгрузить(, "ХозяйственнаяОперация");
	
	Запрос.УстановитьПараметр("МассивХозОпераций"			, МассивХозОпераций);
	Запрос.УстановитьПараметр("ФильтроватьПоХозОперацииям"	, МассивХозОпераций.Количество() > 0);	
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();	
	
КонецПроцедуры

Процедура ВыполнитьОбменПУБ77_РасходныеКассовыеОрдера(Настройка, ЕстьОшибки)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка,
	|	РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.абс_ХозяйственнаяОперация.Наименование КАК type,
	|	РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Номер КАК Num,
	|	РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Дата КАК Date,
	|	РасходныйКассовыйОрдерРасшифровкаПлатежа.СтатьяДвиженияДенежныхСредств.Наименование КАК clause,
	|	ВЫБОР
	|		КОГДА РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Контрагент ССЫЛКА Справочник.Контрагенты
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Контрагент = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|						ТОГДА ВЫРАЗИТЬ(РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Контрагент КАК Справочник.Контрагенты).Наименование
	|					ИНАЧЕ РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Выдать
	|				КОНЕЦ
	|		ИНАЧЕ РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Выдать
	|	КОНЕЦ КАК kontr,
	|	РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.СчетУчетаРасчетовСКонтрагентом.Наименование КАК korAcc,
	|	ПРЕДСТАВЛЕНИЕ(РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.СубконтоДт1) КАК Sub1,
	|	ПРЕДСТАВЛЕНИЕ(РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.СубконтоДт2) КАК Sub2,
	|	ПРЕДСТАВЛЕНИЕ(РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.СубконтоДт3) КАК Sub3,
	|	РасходныйКассовыйОрдерРасшифровкаПлатежа.СуммаПлатежа КАК Total,
	|	ВЫБОР
	|		КОГДА РасходныйКассовыйОрдерРасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ РасходныйКассовыйОрдерРасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 18
	|		КОГДА РасходныйКассовыйОрдерРасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ РасходныйКассовыйОрдерРасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 10
	|		КОГДА РасходныйКассовыйОрдерРасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС0)
	|				ИЛИ РасходныйКассовыйОрдерРасшифровкаПлатежа.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|			ТОГДА 0
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК NDS,
	|	РасходныйКассовыйОрдерРасшифровкаПлатежа.СуммаНДС КАК NDSSum,
	|	РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Комментарий КАК comment
	|ИЗ
	|	Документ.РасходныйКассовыйОрдер.РасшифровкаПлатежа КАК РасходныйКассовыйОрдерРасшифровкаПлатежа
	|ГДЕ
	|	РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Проведен
	|	И РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Организация = &Организация
	|	И РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Дата >= &ДатаОтбораДокументов
	|	И РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.Дата <= &ДатаОтбораДокументовОкончание
	|	И ВЫБОР
	|			КОГДА &ФильтроватьПоХозОперацииям
	|				ТОГДА РасходныйКассовыйОрдерРасшифровкаПлатежа.Ссылка.абс_ХозяйственнаяОперация В (&МассивХозОпераций)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ");
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("type"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Num"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("Date"		, "D");
	ФайлВыгрузки.Поля.Добавить("clause"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("kontr"		, "S"	, 500);
	ФайлВыгрузки.Поля.Добавить("korAcc"		, "S"	, 10);
	ФайлВыгрузки.Поля.Добавить("Sub1"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Sub2"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Sub3"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Total"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("NDS"		, "N"	, 2);
	ФайлВыгрузки.Поля.Добавить("NDSSum"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 500);
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Запрос.УстановитьПараметр("Организация"						, Настройка.Организация);
	Запрос.УстановитьПараметр("ДатаОтбораДокументов"			, Настройка.Дата);
	Запрос.УстановитьПараметр("ДатаОтбораДокументовОкончание"	, ?(ЗначениеЗаполнено(Настройка.ДатаОграничения), КонецДня(Настройка.ДатаОграничения), '20991231'));
	
	МассивХозОпераций = Настройка.ХозяйственныеОперации.Выгрузить(, "ХозяйственнаяОперация");
	
	Запрос.УстановитьПараметр("МассивХозОпераций"			, МассивХозОпераций);
	Запрос.УстановитьПараметр("ФильтроватьПоХозОперацииям"	, МассивХозОпераций.Количество() > 0);	
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();	
	
КонецПроцедуры

Процедура ВыполнитьОбменПУБ77_ДвиженияДС(Настройка, ЕстьОшибки)
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.абс_ХозяйственнаяОперация.Наименование КАК type,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.Номер КАК Num,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.Дата КАК Date,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.СтатьяДвиженияДенежныхСредств.Наименование КАК clause,
	|	ВЫРАЗИТЬ(ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.НазначениеПлатежа КАК СТРОКА(300)) КАК desti,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.СчетОрганизации.НомерСчета КАК account,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.Контрагент.Наименование КАК Kontr,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.Контрагент.ИНН КАК KontrINN,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.ДоговорКонтрагента.Наименование КАК Dog,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.СуммаПлатежа КАК Total,
	|	ВЫРАЗИТЬ(ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.Комментарий КАК СТРОКА(200)) КАК comment,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.СтавкаНДС КАК nds,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.СуммаНДС КАК sumnds,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.ВидПлатежа КАК vid,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.ОчередностьПлатежа КАК ochered,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.ТекстПлательщика КАК text,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.ИННПлательщика КАК innplat,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.КПППлательщика КАК kppplat,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.ИННПолучателя КАК innpoluch,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.КПППолучателя КАК kpppoluch,
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.КодБК КАК codbk
	|ИЗ
	|	Документ.ПлатежноеПоручениеИсходящее.РасшифровкаПлатежа КАК ПлатежноеПоручениеИсходящееРасшифровкаПлатежа
	|ГДЕ
	|	ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.Организация = &Организация
	|	И ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.Дата >= &ДатаОтбораДокументов
	|	И ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.Дата <= &ДатаОтбораДокументовОкончание
	|	И ВЫБОР
	|			КОГДА &ФильтроватьПоХозОперацииям
	|				ТОГДА ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.абс_ХозяйственнаяОперация В (&МассивХозОпераций)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|	И ПлатежноеПоручениеИсходящееРасшифровкаПлатежа.Ссылка.Оплачено = ЛОЖЬ");
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("type"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Num"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("Date"		, "D");
	ФайлВыгрузки.Поля.Добавить("clause"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("account"	, "S"	, 20);
	ФайлВыгрузки.Поля.Добавить("Kontr"	, "S"	, 100);
   	ФайлВыгрузки.Поля.Добавить("KontrINN"	, "S"	, 12);
	ФайлВыгрузки.Поля.Добавить("Dog"		, "S"	, 50);
	
	ФайлВыгрузки.Поля.Добавить("nds"		, "S"	, 10);
    ФайлВыгрузки.Поля.Добавить("sumnds"		, "N"	, 15, 2);

ФайлВыгрузки.Поля.Добавить("vid"		, "S"	, 15);
ФайлВыгрузки.Поля.Добавить("ochered"		, "N"	, 1);
ФайлВыгрузки.Поля.Добавить("text"		, "S"	, 200);
ФайлВыгрузки.Поля.Добавить("innplat"		, "S"	, 12);
 ФайлВыгрузки.Поля.Добавить("innplat"		, "S"	, 12);
ФайлВыгрузки.Поля.Добавить("kppplat"		, "S"	, 9);
ФайлВыгрузки.Поля.Добавить("innpoluch"		, "S"	, 12);
ФайлВыгрузки.Поля.Добавить("kpppoluch"		, "S"	, 9);
ФайлВыгрузки.Поля.Добавить("codbk"		, "S"	, 20);

	
	
	ФайлВыгрузки.Поля.Добавить("Total"		, "N"	, 15, 2);
	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 200);
	ФайлВыгрузки.Поля.Добавить("desti"		, "S"	, 300);

	
	
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Запрос.УстановитьПараметр("Организация"						, Настройка.Организация);
	Запрос.УстановитьПараметр("ДатаОтбораДокументов"			, Настройка.Дата);
	Запрос.УстановитьПараметр("ДатаОтбораДокументовОкончание"	, ?(ЗначениеЗаполнено(Настройка.ДатаОграничения), КонецДня(Настройка.ДатаОграничения), '20991231'));
	
	МассивХозОпераций = Настройка.ХозяйственныеОперации.Выгрузить(, "ХозяйственнаяОперация");
	
	Запрос.УстановитьПараметр("МассивХозОпераций"			, МассивХозОпераций);
	Запрос.УстановитьПараметр("ФильтроватьПоХозОперацииям"	, МассивХозОпераций.Количество() > 0);	
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();		

	
КонецПроцедуры

Процедура ВыполнитьОбменПУБ77_ИнвентаризацияТоваров(Настройка, ЕстьОшибки)	
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ИнвентаризацияТоваровНаСкладеТовары.Ссылка,
	|	ИнвентаризацияТоваровНаСкладеТовары.Ссылка.абс_ХозяйственнаяОперация.Наименование КАК type,
	|	ИнвентаризацияТоваровНаСкладеТовары.Ссылка.Номер КАК Num,
	|	ИнвентаризацияТоваровНаСкладеТовары.Ссылка.Дата КАК Date,
	|	ИнвентаризацияТоваровНаСкладеТовары.Ссылка.Склад.Наименование КАК Sklad,
	|	ИнвентаризацияТоваровНаСкладеТовары.Номенклатура.ВидНоменклатуры.Наименование КАК TypeMPZ,
	|	ИнвентаризацияТоваровНаСкладеТовары.Номенклатура.Наименование КАК MPZ,
	|	ИнвентаризацияТоваровНаСкладеТовары.Номенклатура.Артикул КАК MPZ_Art,
	|	СУММА(ИнвентаризацияТоваровНаСкладеТовары.КоличествоУчет) КАК Kol,
	|	СУММА(ИнвентаризацияТоваровНаСкладеТовары.Количество) КАК KolFact,
	|	ИнвентаризацияТоваровНаСкладеТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору КАК Edizm,
	|	ВЫРАЗИТЬ(ИнвентаризацияТоваровНаСкладеТовары.Ссылка.Комментарий КАК СТРОКА(300)) КАК comment
	|ИЗ
	|	Документ.ИнвентаризацияТоваровНаСкладе.Товары КАК ИнвентаризацияТоваровНаСкладеТовары
	|ГДЕ
	|	ИнвентаризацияТоваровНаСкладеТовары.Ссылка.ПометкаУдаления = ЛОЖЬ
	|	И ИнвентаризацияТоваровНаСкладеТовары.Ссылка.Организация = &Организация
	|	И ИнвентаризацияТоваровНаСкладеТовары.Ссылка.Дата >= &ДатаОтбораДокументов
	|	И ИнвентаризацияТоваровНаСкладеТовары.Ссылка.Дата <= &ДатаОтбораДокументовОкончание
	|	И ВЫБОР
	|			КОГДА &ФильтроватьПоХозОперацииям
	|				ТОГДА ИнвентаризацияТоваровНаСкладеТовары.Ссылка.абс_ХозяйственнаяОперация В (&МассивХозОпераций)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|
	|СГРУППИРОВАТЬ ПО
	|	ИнвентаризацияТоваровНаСкладеТовары.Номенклатура.ВидНоменклатуры.Наименование,
	|	ИнвентаризацияТоваровНаСкладеТовары.Ссылка,
	|	ИнвентаризацияТоваровНаСкладеТовары.Номенклатура.Наименование,
	|	ИнвентаризацияТоваровНаСкладеТовары.Номенклатура.Артикул,
	|	ИнвентаризацияТоваровНаСкладеТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору,
	|	ВЫРАЗИТЬ(ИнвентаризацияТоваровНаСкладеТовары.Ссылка.Комментарий КАК СТРОКА(300)),
	|	ИнвентаризацияТоваровНаСкладеТовары.Ссылка.абс_ХозяйственнаяОперация.Наименование,
	|	ИнвентаризацияТоваровНаСкладеТовары.Ссылка.Номер,
	|	ИнвентаризацияТоваровНаСкладеТовары.Ссылка.Дата,
	|	ИнвентаризацияТоваровНаСкладеТовары.Ссылка.Склад.Наименование
	|
	|УПОРЯДОЧИТЬ ПО
	|	Date,
	|	Num");
	
	ФайлВыгрузки=Новый Xbase();
	ФайлВыгрузки.Поля.Добавить("type"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("Num"		, "S"	, 11);
	ФайлВыгрузки.Поля.Добавить("Date"		, "D");
	ФайлВыгрузки.Поля.Добавить("Sklad"		, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("TypeMPZ"	, "S"	, 50);
	ФайлВыгрузки.Поля.Добавить("MPZ"		, "S"	, 100);
	ФайлВыгрузки.Поля.Добавить("MPZ_Art"	, "S"	, 25);
	ФайлВыгрузки.Поля.Добавить("Kol"		, "N"	, 15, 3);
	ФайлВыгрузки.Поля.Добавить("KolFact"	, "N"	, 15, 3);
	ФайлВыгрузки.Поля.Добавить("Edizm"		, "S"	, 3);
	ФайлВыгрузки.Поля.Добавить("comment"	, "S"	, 500);
	
	ИмяФайлаВыгрузки = Настройка.КаталогВыгрузкиДанных + "\" + Настройка.ПрефиксФайлаВыгрузки + ".dbf";
	
	Попытка		
		ФайлВыгрузки.СоздатьФайл(ИмяФайлаВыгрузки);	
	Исключение		
		ОбщегоНазначения.СообщитьОбОшибке("Ошибка записи файла в каталог!" + Символы.ПС + ОписаниеОшибки(), ЕстьОшибки);
		Возврат;
	КонецПопытки;	
	
	ФайлВыгрузки.Кодировка = КодировкаXBase.OEM;
	
	Запрос.УстановитьПараметр("Организация"						, Настройка.Организация);
	Запрос.УстановитьПараметр("ДатаОтбораДокументов"			, Настройка.Дата);
	Запрос.УстановитьПараметр("ДатаОтбораДокументовОкончание"	, ?(ЗначениеЗаполнено(Настройка.ДатаОграничения), КонецДня(Настройка.ДатаОграничения), '20991231'));
	
	МассивХозОпераций = Настройка.ХозяйственныеОперации.Выгрузить(, "ХозяйственнаяОперация");
	
	Запрос.УстановитьПараметр("МассивХозОпераций"			, МассивХозОпераций);
	Запрос.УстановитьПараметр("ФильтроватьПоХозОперацииям"	, МассивХозОпераций.Количество() > 0);	
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ФайлВыгрузки.Добавить();
		
		ЗаполнитьЗначенияСвойств(ФайлВыгрузки,Выборка);
		
		ФайлВыгрузки.Записать();
		
		ФайлВыгрузки.Переиндексировать();
		
	КонецЦикла;
	
	ФайлВыгрузки.Записать();	
	
КонецПроцедуры

Процедура ВыполнитьРассылкуБлокировкиЗаказа(СтруктураПараметровРассылки) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	абс_НастройкиОповещения.ТипОповещения,
	|	абс_НастройкиОповещения.Действует,
	|	абс_НастройкиОповещения.АдресЭлектроннойПочты
	|ИЗ
	|	РегистрСведений.абс_НастройкиОповещения КАК абс_НастройкиОповещения
	|ГДЕ
	|	абс_НастройкиОповещения.Действует
	|	И абс_НастройкиОповещения.ТипОповещения = ЗНАЧЕНИЕ(Перечисление.абс_ТипыОповещений.РассылкаБлокировкиЗаказа)
	|	И НЕ (ВЫРАЗИТЬ(абс_НастройкиОповещения.АдресЭлектроннойПочты КАК СТРОКА(100))) = """"";
	
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	МассивАдресов = абс_УправлениеДебиторскойЗадолженностью.РазобратьСтрокуВМассивПоРазделителю(Выборка.АдресЭлектроннойПочты, ",");
	
	Если ЗначениеЗаполнено(СтруктураПараметровРассылки.Контрагент.абс_Отдел) Тогда
		Менеджер = СтруктураПараметровРассылки.Контрагент.абс_Отдел.абс_Менеджер;
		Если ЗначениеЗаполнено(Менеджер) Тогда
			АдресМенеджераСтр = абс_УправлениеДебиторскойЗадолженностью.ПолучитьКонтактнуюИнформацию(Менеджер, Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты, Справочники.ВидыКонтактнойИнформации.СлужебныйАдресЭлектроннойПочтыПользователя);
			МассивАдресовВрем = абс_УправлениеДебиторскойЗадолженностью.РазобратьСтрокуВМассивПоРазделителю(АдресМенеджераСтр, ",");
			Для каждого АдресМенеджера из МассивАдресовВрем Цикл
				Если МассивАдресов.Найти(АдресМенеджера) = Неопределено Тогда
					МассивАдресов.Добавить(АдресМенеджера);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	Если ЗначениеЗаполнено(СтруктураПараметровРассылки.Контрагент.абс_БизнесРегион) Тогда
		Менеджер = СтруктураПараметровРассылки.Контрагент.абс_БизнесРегион.абс_Менеджер;
		Если ЗначениеЗаполнено(Менеджер) Тогда
			АдресМенеджераСтр = абс_УправлениеДебиторскойЗадолженностью.ПолучитьКонтактнуюИнформацию(Менеджер, Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты, Справочники.ВидыКонтактнойИнформации.СлужебныйАдресЭлектроннойПочтыПользователя);
			МассивАдресовВрем = абс_УправлениеДебиторскойЗадолженностью.РазобратьСтрокуВМассивПоРазделителю(АдресМенеджераСтр, ",");
			Для каждого АдресМенеджера из МассивАдресовВрем Цикл
				Если МассивАдресов.Найти(АдресМенеджера) = Неопределено Тогда
					МассивАдресов.Добавить(АдресМенеджера);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	Если ЗначениеЗаполнено(СтруктураПараметровРассылки.Контрагент.абс_Территория) Тогда
		Менеджер = СтруктураПараметровРассылки.Контрагент.абс_Территория.абс_Менеджер;
		Если ЗначениеЗаполнено(Менеджер) Тогда
			АдресМенеджераСтр = абс_УправлениеДебиторскойЗадолженностью.ПолучитьКонтактнуюИнформацию(Менеджер, Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты, Справочники.ВидыКонтактнойИнформации.СлужебныйАдресЭлектроннойПочтыПользователя);
			МассивАдресовВрем = абс_УправлениеДебиторскойЗадолженностью.РазобратьСтрокуВМассивПоРазделителю(АдресМенеджераСтр, ",");
			Для каждого АдресМенеджера из МассивАдресовВрем Цикл
				Если МассивАдресов.Найти(АдресМенеджера) = Неопределено Тогда
					МассивАдресов.Добавить(АдресМенеджера);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	ТекстПисьма = СформироватьТекстПисьмаПоСтопЛисту(СтруктураПараметровРассылки);
	
	ТемаПисьма = СформироватьТемуПисьмаПоСтопЛисту(СтруктураПараметровРассылки);
	
	//отправка
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("УчетнаяЗапись", Справочники.УчетныеЗаписиЭлектроннойПочты.УведомленияДистрибуции);
	СтруктураПараметров.Вставить("Тема", ТемаПисьма);
	СтруктураПараметров.Вставить("Тело", ТекстПисьма);
	СписокКому = Новый СписокЗначений;
	СписокКому.ЗагрузитьЗначения(МассивАдресов);
	СтруктураПараметров.Вставить("Кому",СписокКому);
	
	СтруктураПисьма = УправлениеЭлектроннойПочтой.НаписатьПисьмо(глЗначениеПеременной("глТекущийПользователь"),СтруктураПараметров,,,,,, Истина, Ложь);
	
	ЭлектронныеПисьма = Новый Соответствие;
	
	ЭлектронныеПисьма.Вставить(СтруктураПисьма.ПисьмоСсылка);
	
	ИзмененныйСоставПисем = Новый Соответствие;	
	ТекущийПользователь= глЗначениеПеременной("глТекущийПользователь");	
	ДоступныеУчетныеЗаписи = УправлениеЭлектроннойПочтой.ПолучитьДоступныеУчетныеЗаписи(ТекущийПользователь);
	Для каждого Письмо Из ЭлектронныеПисьма Цикл
		Если ТипЗнч(Письмо.Значение) <> Тип("ДокументОбъект.ЭлектронноеПисьмо") Тогда
			ОбъектПисьмо = Письмо.Ключ.ПолучитьОбъект();
			
			ОбъектПисьмо.СтатусПисьма = Перечисления.СтатусыПисем.Исходящее;
			Если НЕ ЗначениеЗаполнено(ОбъектПисьмо.Ответственный) Тогда
				ОбъектПисьмо.Ответственный = ТекущийПользователь;
			КонецЕсли; 
			
			Попытка
				ОбъектПисьмо.Записать();
			Исключение
				Продолжить;;
			КонецПопытки;
		Иначе
			Письмо.Значение.СтатусПисьма = Перечисления.СтатусыПисем.Исходящее;
			Если НЕ ЗначениеЗаполнено(Письмо.Значение.Ответственный) Тогда
				Письмо.Значение.Ответственный = ТекущийПользователь;
			КонецЕсли; 
		КонецЕсли; 
		ИзмененныйСоставПисем.Вставить(Письмо.Ключ, Письмо.Значение);  		
	КонецЦикла;
	
	УправлениеЭлектроннойПочтой.ПолучениеОтправкаПисем(глЗначениеПеременной("глСоответствиеТекстовЭлектронныхПисем"), ПараметрыСеанса.ТекущийПользователь,,
	ИзмененныйСоставПисем, Истина , , Ложь, );
	
КонецПроцедуры

Функция СформироватьТекстПисьмаПоСтопЛисту(СтруктураПараметров) Экспорт
	
	ТекстПисьма = "Добрый день! <BR> <BR>";
	
	Если СтруктураПараметров.РазделСтопЛиста = Перечисления.абс_СтатусыЗадолженности.ПревышениеЧислаДнейЗадолженности 
		ИЛИ СтруктураПараметров.РазделСтопЛиста = Перечисления.абс_СтатусыЗадолженности.ПревышениеЛимитаПДЗПоСумме  Тогда
		
		ТекстПисьма = ТекстПисьма + "Информируем, что у Покупателя " + СтруктураПараметров.Контрагент.НаименованиеПолное 
		+ " имеется просроченная дебиторская задолженность в размере " + Формат(СтруктураПараметров.СуммаПросроченнойЗадолженности, "ЧДЦ=2") 
		+ " рублей (" + СтруктураПараметров.ПроцентПДЗ+ "%)  со сроком " + СтруктураПараметров.КоличествоДнейПросроченнойЗадолженности + " календарных дней. <BR>" 
		+ "Общая дебиторская задолженность " + Формат(СтруктураПараметров.СуммаОбщейЗадолженности, "ЧДЦ=2")  + " рублей. <BR>";
		
		ТекстПисьма = ТекстПисьма + "В связи с наличием просроченной дебиторской задолженности заблокирована Реализация по Заказу клиента № "
		+ СтруктураПараметров.ЗаказПокупателя.Номер + " от " + Формат(СтруктураПараметров.ЗаказПокупателя.Дата, "ДФ=dd.MM.yyyy") + " на сумму " + Формат(СтруктураПараметров.ЗаказПокупателя.СуммаДокумента, "ЧДЦ=2")  + " рублей с НДС. <BR>";
		
		ТекстПисьма = ТекстПисьма + "Просим погасить просроченную дебиторскую задолженность.";
		
	ИначеЕсли  СтруктураПараметров.РазделСтопЛиста = Перечисления.абс_СтатусыЗадолженности.ПревышениеКредитногоЛимита  Тогда
		
		ТекстПисьма = ТекстПисьма + "Информируем, что по Покупателю " + СтруктураПараметров.Контрагент.НаименованиеПолное + " превышен лимит общей дебиторской задолженности на "
		+ Формат(СтруктураПараметров.СуммаОбщейЗадолженности-СтруктураПараметров.ДопустимаяСуммаЗадолженности, "ЧДЦ=2")	+ " рублей. <BR>" 
		+ "Общая дебиторская задолженность " + Формат(СтруктураПараметров.СуммаОбщейЗадолженности, "ЧДЦ=2")  + " рублей. <BR>"
		+ "Лимит дебиторской задолженности " + Формат(СтруктураПараметров.ДопустимаяСуммаЗадолженности, "ЧДЦ=2")  + " рублей. <BR>";
		
		ТекстПисьма = ТекстПисьма + "В связи с превышением лимита дебиторской задолженности заблокирована Реализация по Заказу клиента № " 
		+ СтруктураПараметров.ЗаказПокупателя.Номер + " от " + Формат(СтруктураПараметров.ЗаказПокупателя.Дата, "ДФ=dd.MM.yyyy") + " на сумму " + Формат(СтруктураПараметров.ЗаказПокупателя.СуммаДокумента, "ЧДЦ=2")  + " рублей с НДС. <BR>";
		
		ТекстПисьма = ТекстПисьма + "Просим погасить дебиторскую задолженность, превышающую лимит.";
		
	ИначеЕсли  СтруктураПараметров.РазделСтопЛиста = Перечисления.абс_СтатусыЗадолженности.МораторнаяЗадолженность  Тогда
		
		ТекстПисьма = ТекстПисьма + "Информируем, что по Покупателю " + СтруктураПараметров.Контрагент.НаименованиеПолное + " образовалась мораторная задолженность "  
		+ "Общая дебиторская задолженность " + Формат(СтруктураПараметров.СуммаОбщейЗадолженности, "ЧДЦ=2")  + " рублей. <BR>";
		
		ТекстПисьма = ТекстПисьма + "В связи с наличием мораторной задолженности заблокирована Реализация по Заказу клиента № "
		+ СтруктураПараметров.ЗаказПокупателя.Номер + " от " + Формат(СтруктураПараметров.ЗаказПокупателя.Дата, "ДФ=dd.MM.yyyy") + " на сумму " + Формат(СтруктураПараметров.ЗаказПокупателя.СуммаДокумента, "ЧДЦ=2")  + " рублей с НДС. <BR>";
		
	ИначеЕсли  СтруктураПараметров.РазделСтопЛиста = Перечисления.абс_СтатусыЗадолженности.Разблокирован
		ИЛИ Не ЗначениеЗаполнено(СтруктураПараметров.РазделСтопЛиста) Тогда
		
		ДатаВозможнойОтгрузки = ЗаполнениеДокументов.ОпределитьДату(ТекущаяДата(), 2);
		
		Если СтруктураПараметров.ЗаказПокупателя.ДатаОтгрузки>ДатаВозможнойОтгрузки Тогда
			ДатаВозможнойОтгрузки = СтруктураПараметров.ЗаказПокупателя.ДатаОтгрузки;
		КонецЕсли;
		
		//ТекстПисьма = ТекстПисьма + "Заказ клиента " + СтруктураПараметров.Контрагент.Наименование 
		//+ " № " + СтруктураПараметров.ЗаказПокупателя.Номер + " от " + Формат(СтруктураПараметров.ЗаказПокупателя.Дата, "ДФ=dd.MM.yyyy") + " на сумму " 
		//+ Формат(СтруктураПараметров.ЗаказПокупателя.СуммаДокумента, "ЧДЦ=2")  + " рублей с НДС разблокирован для оформления Реализации на дату с " 
		//+ Формат(ДатаВозможнойОтгрузки, "ДФ=dd.MM.yyyy") +". <BR>";
		
		ТекстПисьма = ТекстПисьма + "Заказ покупателя " + СтруктураПараметров.Контрагент.НаименованиеПолное 
		+ " № " + СтруктураПараметров.ЗаказПокупателя.Номер + " от " + Формат(СтруктураПараметров.ЗаказПокупателя.Дата, "ДФ=dd.MM.yyyy") + " г. на сумму " 
		+ Формат(СтруктураПараметров.ЗаказПокупателя.СуммаДокумента, "ЧДЦ=2")  + " рублей с НДС (" + СтруктураПараметров.ЗаказПокупателя.абс_СуммаБезНДС + " рублей без НДС) разблокирован для оформления Реализации на дату с " 
		+ Формат(ДатаВозможнойОтгрузки, "ДФ=dd.MM.yyyy") +" г. <BR>";
		
	КонецЕсли;
	
	Возврат ТекстПисьма
	
КонецФункции

Функция СформироватьТемуПисьмаПоСтопЛисту(СтруктураПараметров) Экспорт
	
	Если  СтруктураПараметров.РазделСтопЛиста = Перечисления.абс_СтатусыЗадолженности.Разблокирован
		ИЛИ Не ЗначениеЗаполнено(СтруктураПараметров.РазделСтопЛиста) Тогда
		
		//ТемаПисьма = "Разблокирована Реализация по Заказу клиента " + СтруктураПараметров.Контрагент;
		  ТемаПисьма = "Разблокирован Заказ " + СтруктураПараметров.Контрагент.Наименование+ " № " 
		  + СтруктураПараметров.ЗаказПокупателя.Номер + " от " + Формат(СтруктураПараметров.ЗаказПокупателя.Дата, "ДФ=dd.MM.yyyy") + 
		  " г. на сумму " + СтруктураПараметров.ЗаказПокупателя.абс_СуммаБезНДС + " рублей без НДС";
	Иначе
		ТемаПисьма = "" + СтруктураПараметров.ЗаказПокупателя.Организация.НаименованиеСокращенное + ". Заблокирована Реализация по Заказу Покупателя " 
		+ СтруктураПараметров.Контрагент.НаименованиеПолное + " на сумму " + СтруктураПараметров.ЗаказПокупателя.СуммаДокумента + " рублей";	
		
	КонецЕсли;
	
	Возврат ТемаПисьма
	
КонецФункции

// + Лаврухин 16.02.2015
Процедура ВыполнитьРассылкуПолитическойБлокировкиЗаказа(СтруктураПараметровРассылки) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
					"ВЫБРАТЬ
					|	абс_НастройкиОповещения.ТипОповещения,
					|	абс_НастройкиОповещения.Действует,
					|	абс_НастройкиОповещения.АдресЭлектроннойПочты
					|ИЗ
					|	РегистрСведений.абс_НастройкиОповещения КАК абс_НастройкиОповещения
					|ГДЕ
					|	абс_НастройкиОповещения.Действует
					|	И абс_НастройкиОповещения.ТипОповещения = ЗНАЧЕНИЕ(Перечисление.абс_ТипыОповещений.РассылкаБлокировкиЗаказа)
					|	И НЕ (ВЫРАЗИТЬ(абс_НастройкиОповещения.АдресЭлектроннойПочты КАК СТРОКА(100))) = """"";
	
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	МассивАдресов = абс_УправлениеДебиторскойЗадолженностью.РазобратьСтрокуВМассивПоРазделителю(Выборка.АдресЭлектроннойПочты, ",");
	
	Если ЗначениеЗаполнено(СтруктураПараметровРассылки.Контрагент.абс_Отдел) Тогда
		Менеджер = СтруктураПараметровРассылки.Контрагент.абс_Отдел.абс_Менеджер;
		Если ЗначениеЗаполнено(Менеджер) Тогда
			АдресМенеджераСтр = абс_УправлениеДебиторскойЗадолженностью.ПолучитьКонтактнуюИнформацию(Менеджер, Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты, Справочники.ВидыКонтактнойИнформации.СлужебныйАдресЭлектроннойПочтыПользователя);
			МассивАдресовВрем = абс_УправлениеДебиторскойЗадолженностью.РазобратьСтрокуВМассивПоРазделителю(АдресМенеджераСтр, ",");
			Для каждого АдресМенеджера из МассивАдресовВрем Цикл
				Если МассивАдресов.Найти(АдресМенеджера) = Неопределено Тогда
					МассивАдресов.Добавить(АдресМенеджера);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	Если ЗначениеЗаполнено(СтруктураПараметровРассылки.Контрагент.абс_БизнесРегион) Тогда
		Менеджер = СтруктураПараметровРассылки.Контрагент.абс_БизнесРегион.абс_Менеджер;
		Если ЗначениеЗаполнено(Менеджер) Тогда
			АдресМенеджераСтр = абс_УправлениеДебиторскойЗадолженностью.ПолучитьКонтактнуюИнформацию(Менеджер, Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты, Справочники.ВидыКонтактнойИнформации.СлужебныйАдресЭлектроннойПочтыПользователя);
			МассивАдресовВрем = абс_УправлениеДебиторскойЗадолженностью.РазобратьСтрокуВМассивПоРазделителю(АдресМенеджераСтр, ",");
			Для каждого АдресМенеджера из МассивАдресовВрем Цикл
				Если МассивАдресов.Найти(АдресМенеджера) = Неопределено Тогда
					МассивАдресов.Добавить(АдресМенеджера);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	Если ЗначениеЗаполнено(СтруктураПараметровРассылки.Контрагент.абс_Территория) Тогда
		Менеджер = СтруктураПараметровРассылки.Контрагент.абс_Территория.абс_Менеджер;
		Если ЗначениеЗаполнено(Менеджер) Тогда
			АдресМенеджераСтр = абс_УправлениеДебиторскойЗадолженностью.ПолучитьКонтактнуюИнформацию(Менеджер, Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты, Справочники.ВидыКонтактнойИнформации.СлужебныйАдресЭлектроннойПочтыПользователя);
			МассивАдресовВрем = абс_УправлениеДебиторскойЗадолженностью.РазобратьСтрокуВМассивПоРазделителю(АдресМенеджераСтр, ",");
			Для каждого АдресМенеджера из МассивАдресовВрем Цикл
				Если МассивАдресов.Найти(АдресМенеджера) = Неопределено Тогда
					МассивАдресов.Добавить(АдресМенеджера);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	ТекстПисьма = СформироватьПолитическийТекстПисьмаПоСтопЛисту(СтруктураПараметровРассылки);
	
	ТемаПисьма = СформироватьПолитическуюТемуПисьмаПоСтопЛисту(СтруктураПараметровРассылки);
	
	//отправка
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("УчетнаяЗапись", Справочники.УчетныеЗаписиЭлектроннойПочты.УведомленияДистрибуции);
	СтруктураПараметров.Вставить("Тема", ТемаПисьма);
	СтруктураПараметров.Вставить("Тело", ТекстПисьма);
	СписокКому = Новый СписокЗначений;
	СписокКому.ЗагрузитьЗначения(МассивАдресов);
	СтруктураПараметров.Вставить("Кому",СписокКому);
	
	СтруктураПисьма = УправлениеЭлектроннойПочтой.НаписатьПисьмо(глЗначениеПеременной("глТекущийПользователь"),СтруктураПараметров,,,,,, Истина, Ложь);
	
	ЭлектронныеПисьма = Новый Соответствие;
	
	ЭлектронныеПисьма.Вставить(СтруктураПисьма.ПисьмоСсылка);
	
	ИзмененныйСоставПисем = Новый Соответствие;	
	ТекущийПользователь= глЗначениеПеременной("глТекущийПользователь");	
	ДоступныеУчетныеЗаписи = УправлениеЭлектроннойПочтой.ПолучитьДоступныеУчетныеЗаписи(ТекущийПользователь);
	Для каждого Письмо Из ЭлектронныеПисьма Цикл
		Если ТипЗнч(Письмо.Значение) <> Тип("ДокументОбъект.ЭлектронноеПисьмо") Тогда
			ОбъектПисьмо = Письмо.Ключ.ПолучитьОбъект();
			
			ОбъектПисьмо.СтатусПисьма = Перечисления.СтатусыПисем.Исходящее;
			Если НЕ ЗначениеЗаполнено(ОбъектПисьмо.Ответственный) Тогда
				ОбъектПисьмо.Ответственный = ТекущийПользователь;
			КонецЕсли; 
			
			Попытка
				ОбъектПисьмо.Записать();
			Исключение
				Продолжить;;
			КонецПопытки;
		Иначе
			Письмо.Значение.СтатусПисьма = Перечисления.СтатусыПисем.Исходящее;
			Если НЕ ЗначениеЗаполнено(Письмо.Значение.Ответственный) Тогда
				Письмо.Значение.Ответственный = ТекущийПользователь;
			КонецЕсли; 
		КонецЕсли; 
		ИзмененныйСоставПисем.Вставить(Письмо.Ключ, Письмо.Значение);  		
	КонецЦикла;
	
	УправлениеЭлектроннойПочтой.ПолучениеОтправкаПисем(глЗначениеПеременной("глСоответствиеТекстовЭлектронныхПисем"), ПараметрыСеанса.ТекущийПользователь,,
	ИзмененныйСоставПисем, Истина , , Ложь, );
	
КонецПроцедуры    

Функция СформироватьПолитическийТекстПисьмаПоСтопЛисту(СтруктураПараметров) Экспорт
	
	ТекстПисьма = "Добрый день! <BR> <BR>";
	
	ТекстПисьма = ТекстПисьма + "Заказ клиента " + СтруктураПараметров.Контрагент.Наименование 
	+ " № " + СтруктураПараметров.ЗаказПокупателя.Номер + " от " + Формат(СтруктураПараметров.ЗаказПокупателя.Дата, "ДФ=dd.MM.yyyy") + " на сумму " 
	+ Формат(СтруктураПараметров.ЗаказПокупателя.СуммаДокумента, "ЧДЦ=2")  + " рублей с НДС заблокирован по политическим мотивам " +". <BR>";
	
	Возврат ТекстПисьма
	
КонецФункции

Функция СформироватьПолитическуюТемуПисьмаПоСтопЛисту(СтруктураПараметров) Экспорт
		
	ТемаПисьма = "" + СтруктураПараметров.ЗаказПокупателя.Организация.НаименованиеСокращенное + ". Заблокирована Реализация по Заказу Покупателя " 
	+ СтруктураПараметров.Контрагент.НаименованиеПолное + " на сумму " + СтруктураПараметров.ЗаказПокупателя.СуммаДокумента + " рублей";
	
	Возврат ТемаПисьма
	
КонецФункции
// - Лаврухин 16.02.2015

 //{Лео Катанович
Функция РазложитьФИО(ПараметрФИО)
	ФИОСтр = ПараметрФИО;
	ФИОСтр = СокрЛП(СтрЗаменить(ФИОСтр,"ИП",""));
	ФИО = Новый Структура("Фамилия, Имя, Отчество", "", "", "");
	
	ПервыйПробел = Найти(ФИОСтр, " ");
	Если ПервыйПробел = 0 Тогда
		ФИО.Фамилия = ФИОСтр;
		Возврат ФИО;
	КонецЕсли;
	ФИО.Фамилия = СокрЛП(Лев(ФИОСтр, ПервыйПробел - 1));
	ФИОСтр = СокрЛП(Сред(ФИОСтр, ПервыйПробел + 1));
	
	ВторойПробел = Найти(ФИОСтр, " ");
	Если ВторойПробел = 0 Тогда
		ФИО.Имя = ФИОСтр;
		Возврат ФИО;
	КонецЕсли;
	ФИО.Имя = СокрЛП(Лев(ФИОСтр, ВторойПробел - 1));
	
	ФИО.Отчество = СокрЛП(Сред(ФиоСтр, ВторойПробел + 1));
	Возврат ФИО;
	
КонецФункции

Функция ПолучитьФаксКонтрагента(Контрагент)
	Вид	 =  ?(ТипЗнч(Контрагент) = Тип("СправочникСсылка.Организации"),Справочники.ВидыКонтактнойИнформации.ФаксОрганизации,Справочники.ВидыКонтактнойИнформации.ФаксКонтрагента);
	Запрос  = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КонтактнаяИнформация.Представление
	|ИЗ
	|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|ГДЕ
	|	КонтактнаяИнформация.Объект = &Объект
	|	И КонтактнаяИнформация.Тип = &Тип
	|	И КонтактнаяИнформация.Вид = &Вид" ;
	
	Запрос.УстановитьПараметр("Объект",        Контрагент);
	Запрос.УстановитьПараметр("Тип",    Перечисления.ТипыКонтактнойИнформации.Телефон);
	Запрос.УстановитьПараметр("Вид",        Вид);
	
	Результат = Запрос.Выполнить().Выбрать();
	Если Результат.Следующий() Тогда
		Значение = Результат.Представление;
	Иначе
		Значение = "";
	КонецЕсли;
	Возврат Значение;			
КонецФункции

Функция СобратьДанныеДляПечатиИсправленияСчетаФактуры(ТекущееОснование, Ссылка)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДокументОснование", ТекущееОснование);
	Запрос.УстановитьПараметр("ПустойКонтрагент", Справочники.Контрагенты.ПустаяСсылка());
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КорректировкаРеализации.Организация,
	|	КорректировкаРеализации.Организация КАК Поставщик,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КорректировкаРеализации.Грузоотправитель, &ПустойКонтрагент) = &ПустойКонтрагент
	|			ТОГДА ""он же""
	|		ИНАЧЕ КорректировкаРеализации.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	КорректировкаРеализации.Контрагент КАК Покупатель,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КорректировкаРеализации.Грузополучатель, &ПустойКонтрагент) = &ПустойКонтрагент
	|			ТОГДА КорректировкаРеализации.Контрагент
	|		ИНАЧЕ КорректировкаРеализации.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	КорректировкаРеализации.СуммаДокумента КАК Сумма,
	|	КорректировкаРеализации.ВалютаДокумента КАК Валюта,
	|	КорректировкаРеализации.УчитыватьНДС КАК УчитыватьНДС,
	|	КорректировкаРеализации.СуммаВключаетНДС КАК СуммаВключаетНДС,		
	|	КорректировкаРеализации.АдресДоставки КАК АдресДоставки,
	|	КорректировкаРеализации.ДокументРеализации КАК ДокументРеализации
	|ИЗ
	|	Документ.КорректировкаРеализации КАК КорректировкаРеализации
	|ГДЕ
	|	КорректировкаРеализации.Ссылка = &ДокументОснование";
	
	ЗапросПоТоварам = Новый Запрос();
	ЗапросПоТоварам.УстановитьПараметр("ДокументОснование", ТекущееОснование);
	ЗапросПоТоварам.Текст = 
	"ВЫБРАТЬ
	|	ТаблицаПоТоварам.НомерСтроки КАК НомерСтроки,
	|	ТаблицаПоТоварам.Номенклатура КАК Номенклатура,
	|	ТаблицаПоТоварам.СерияНоменклатуры.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ТаблицаПоТоварам.СерияНоменклатуры.НомерГТД КАК НомерГТД,
	|	ТаблицаПоТоварам.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	СУММА(ТаблицаПоТоварам.Количество) КАК Количество,
	|	ТаблицаПоТоварам.Цена КАК Цена,
	|	ТаблицаПоТоварам.Сумма КАК Сумма,
	|	ТаблицаПоТоварам.СуммаНДС КАК СуммаНДС,
	|	ТаблицаПоТоварам.СтавкаНДС КАК СтавкаНДС,
	|	ТаблицаПоТоварам.СерияНоменклатуры КАК Серия,
	|	ТаблицаПоТоварам.ХарактеристикаНоменклатуры КАК Характеристика,
	|	ТаблицаПоТоварам.СтавкаНДСДоИзменения,
	|	ТаблицаПоТоварам.СтавкаНДС КАК СтавкаНДСПослеИзменения
	|ПОМЕСТИТЬ ТаблицаТовары
	|ИЗ
	|	Документ.КорректировкаРеализации.Товары КАК ТаблицаПоТоварам
	|ГДЕ
	|	ТаблицаПоТоварам.Ссылка = &ДокументОснование
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаПоТоварам.ЕдиницаИзмерения,
	|	ТаблицаПоТоварам.Номенклатура,
	|	ТаблицаПоТоварам.СтавкаНДС,
	|	ТаблицаПоТоварам.СерияНоменклатуры,
	|	ТаблицаПоТоварам.ХарактеристикаНоменклатуры,
	|	ТаблицаПоТоварам.НомерСтроки,
	|	ТаблицаПоТоварам.СерияНоменклатуры.СтранаПроисхождения,
	|	ТаблицаПоТоварам.СерияНоменклатуры.НомерГТД,
	|	ТаблицаПоТоварам.Цена,
	|	ТаблицаПоТоварам.Сумма,
	|	ТаблицаПоТоварам.СуммаНДС,
	|	ТаблицаПоТоварам.СтавкаНДСДоИзменения,
	|	ТаблицаПоТоварам.СтавкаНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаТовары.НомерСтроки КАК НомерСтроки,
	|	ТаблицаТовары.Номенклатура,
	|	ВЫРАЗИТЬ(ТаблицаТовары.Номенклатура.НаименованиеПолное КАК СТРОКА(1000)) КАК НаименованиеТовара,
	|	ТаблицаТовары.Номенклатура.Код КАК ТоварКод,
	|	ТаблицаТовары.Номенклатура.Артикул КАК ТоварАртикул,
	|	ТаблицаТовары.СтранаПроисхождения,
	|	ТаблицаТовары.СтранаПроисхождения.Код КАК СтранаПроисхожденияКод,
	|	ТаблицаТовары.СтранаПроисхождения.Наименование КАК ПредставлениеСтраны,
	|	ТаблицаТовары.НомерГТД,
	|	ТаблицаТовары.НомерГТД.Представление КАК ПредставлениеГТД,
	|	ТаблицаТовары.ЕдиницаИзмерения.Представление КАК ЕдиницаИзмерения,
	|	ТаблицаТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК ЕдиницаИзмеренияКод,
	|	ТаблицаТовары.Количество,
	|	ТаблицаТовары.Цена,
	|	ТаблицаТовары.Сумма,
	|	ТаблицаТовары.СуммаНДС,
	|	ТаблицаТовары.СтавкаНДС,
	|	ВЫБОР
	|		КОГДА ТаблицаТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|			ТОГДА 0
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК ЕстьНДС,
	|	ТаблицаТовары.Серия,
	|	ТаблицаТовары.Характеристика,
	|	""Товары"" КАК ВидПоступления,
	|	ТаблицаТовары.СтавкаНДСДоИзменения,
	|	ТаблицаТовары.СтавкаНДСПослеИзменения,
	|	ЕСТЬNULL(Штрихкоды.Штрихкод, """") КАК ШтрихКод,
	|	ТаблицаТовары.Количество КАК КоличествоДоИзменения,
	|	ТаблицаТовары.Количество КАК КоличествоПослеИзменения
	|ИЗ
	|	ТаблицаТовары КАК ТаблицаТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО ТаблицаТовары.Номенклатура = Штрихкоды.Владелец
	|			И ТаблицаТовары.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И ТаблицаТовары.Характеристика = Штрихкоды.ХарактеристикаНоменклатуры
	|			И (Штрихкоды.ТипШтрихкода = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13))
	|ГДЕ
	|	ТаблицаТовары.Сумма <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТаблицаПоУслугам.НомерСтроки,
	|	ТаблицаПоУслугам.Номенклатура,
	|	ВЫРАЗИТЬ(ТаблицаПоУслугам.Содержание КАК СТРОКА(1000)),
	|	ТаблицаПоУслугам.Номенклатура.Код,
	|	ТаблицаПоУслугам.Номенклатура.Артикул,
	|	""Россия"",
	|	NULL,
	|	""Россия"",
	|	"""",
	|	"""",
	|	ТаблицаПоУслугам.Номенклатура.ЕдиницаХраненияОстатков,
	|	ТаблицаПоУслугам.Номенклатура.ЕдиницаХраненияОстатков.ЕдиницаПоКлассификатору.Код,
	|	ТаблицаПоУслугам.Количество,
	|	ТаблицаПоУслугам.Цена,
	|	ТаблицаПоУслугам.Сумма,
	|	ТаблицаПоУслугам.СуммаНДС,
	|	ТаблицаПоУслугам.СтавкаНДС,
	|	ВЫБОР
	|		КОГДА ТаблицаПоУслугам.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
	|			ТОГДА 0
	|		ИНАЧЕ 1
	|	КОНЕЦ,
	|	NULL,
	|	NULL,
	|	""Услуги"",
	|	ТаблицаПоУслугам.СтавкаНДСДоИзменения,
	|	ТаблицаПоУслугам.СтавкаНДС,
	|	"""",
	|	ТаблицаПоУслугам.Количество,
	|	ТаблицаПоУслугам.Количество
	|ИЗ
	|	Документ.КорректировкаРеализации.Услуги КАК ТаблицаПоУслугам
	|ГДЕ
	|	ТаблицаПоУслугам.Ссылка = &ДокументОснование
	|	И ТаблицаПоУслугам.Сумма <> 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки,
	|	ВидПоступления";
	
	Шапка = Запрос.Выполнить().Выбрать();
	ВыборкаСтрокТовары = ЗапросПоТоварам.Выполнить().Выбрать();
	
	Шапка.Следующий();
	
	ДанныеДляПечати = Новый Структура();
	
	Поставщик = Шапка.Поставщик;
	Грузоотправитель = Шапка.Грузоотправитель;
	Если ЗначениеЗаполнено(Поставщик.ГоловнаяОрганизация) Тогда 
		Грузоотправитель = Поставщик;
		Поставщик = Поставщик.ГоловнаяОрганизация;
	КонецЕсли;
	
	Если ТипЗнч(Ссылка) = Тип("Структура") Тогда
		РеквизитыСФ = Ссылка;
	Иначе
		РеквизитыСФ = ОбщегоНазначения.ПолучитьЗначенияРеквизитов(Ссылка, "Дата, Организация, НомерИсходногоДокумента, ДатаИсходногоДокумента");
	КонецЕсли;
	
	ДанныеДляПечати.Вставить("Организация",      Шапка.Организация);
	ДанныеДляПечати.Вставить("Номер",            РеквизитыСФ.НомерИсходногоДокумента);
	ДанныеДляПечати.Вставить("Дата",             РеквизитыСФ.ДатаИсходногоДокумента);
	ДанныеДляПечати.Вставить("Поставщик",        Поставщик);
	ДанныеДляПечати.Вставить("Грузоотправитель", Грузоотправитель);
	ДанныеДляПечати.Вставить("Покупатель",       Шапка.Покупатель);
	ДанныеДляПечати.Вставить("Грузополучатель",  Шапка.Грузополучатель);
	ДанныеДляПечати.Вставить("Сумма",            Шапка.Сумма);
	ДанныеДляПечати.Вставить("Валюта",           Шапка.Валюта);
	ДанныеДляПечати.Вставить("УчитыватьНДС",     Шапка.УчитыватьНДС);
	ДанныеДляПечати.Вставить("СуммаВключаетНДС", Шапка.СуммаВключаетНДС);
	
	Руководители = РегламентированнаяОтчетность.ОтветственныеЛицаОрганизаций(Шапка.Организация, РеквизитыСФ.Дата);
	ДанныеДляПечати.Вставить(?(РегламентированнаяОтчетность.ЭтоПБОЮЛ(Шапка.Организация), "ФИОПБОЮЛ", "ФИОРуководителя"), Руководители.Руководитель);
	ДанныеДляПечати.Вставить("ФИОГлавногоБухгалтера", Руководители.ГлавныйБухгалтер);
	
	Товары = СоздатьТаблицуДляЗаполнениеТабличнойЧастиДанныхПечати();
	
	ЕстьТовары 		  = Ложь;
	ЕстьУслуги		  = Ложь;
	СчетФактураБезНДС = (ВыборкаСтрокТовары.Количество() > 0);
	
	Пока ВыборкаСтрокТовары.Следующий() Цикл
		
		ЕстьТовары = ЕстьТовары ИЛИ (ВыборкаСтрокТовары.ВидПоступления = "Товары");
		ЕстьУслуги = ЕстьУслуги ИЛИ (ВыборкаСтрокТовары.ВидПоступления = "Услуги");
		СчетФактураБезНДС = СчетФактураБезНДС И (ВыборкаСтрокТовары.ЕстьНДС = 0); 
		
		Строчка = Товары.Добавить();
		ЗаполнитьЗначенияСвойств(Строчка, ВыборкаСтрокТовары);
		Строчка.НаименованиеТовара = СокрЛП(ВыборкаСтрокТовары.НаименованиеТовара);
		//+ ПредставлениеСерий(ВыборкаСтрокТовары);
		Строчка.СуммаВключаетНДС  = Шапка.СуммаВключаетНДС;
		Строчка.ЦенаДоИзменения = ВыборкаСтрокТовары.цена;
		Строчка.ЦенапослеИзменения = ВыборкаСтрокТовары.цена;
	КонецЦикла;
	
	Если НЕ ЕстьТовары Тогда
		ДанныеДляПечати.Грузоотправитель = "";
		ДанныеДляПечати.Грузополучатель = "";		
	КонецЕсли;
	
	ДанныеДляПечати.Вставить("ТабличнаяЧасть", 		Товары);
	ДанныеДляПечати.Вставить("СчетФактураБезНДС", 	СчетФактураБезНДС);
	
	// Параметры для универсального передаточного документа: ФИО и должность того, кто передал товар/сдал услуги, результаты работ, права
	ТипДокументаРеализации = ТипЗнч(Шапка.ДокументРеализации);
	Если ТипДокументаРеализации = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
		РеквизитыШапки = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шапка.ДокументРеализации, "ОтпускПроизвел, ОтпускРазрешил, ЗаРуководителяПоПриказу");
		Если ЕстьТовары И ЗначениеЗаполнено(РеквизитыШапки.ОтпускПроизвел) Тогда
			ДанныеДляПечати.Вставить("КладовщикДляУПД", 				РеквизитыШапки.ОтпускПроизвел);
			ДанныеДляПечати.Вставить("ДатаДокументаДляУПД", 			РеквизитыСФ.Дата);
			ДанныеДляПечати.Вставить("ЗаКладовщикаПоПриказуДляУПД", 	Неопределено)
		ИначеЕсли ЕстьУслуги Тогда
			Если ЗначениеЗаполнено(РеквизитыШапки.ОтпускРазрешил) Тогда
				ДанныеДляПечати.Вставить("КладовщикДляУПД", 			РеквизитыШапки.ОтпускРазрешил);
				ДанныеДляПечати.Вставить("ДатаДокументаДляУПД", 		РеквизитыСФ.Дата);
				ДанныеДляПечати.Вставить("ЗаКладовщикаПоПриказуДляУПД", РеквизитыШапки.ЗаРуководителяПоПриказу)
			Иначе	
				ДанныеДляПечати.Вставить("ФИОКладовщика", 				Руководители.Руководитель);
				ДанныеДляПечати.Вставить("ДолжностьКладовщика", 		Руководители.РуководительДолжность);
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли ТипДокументаРеализации = Тип("ДокументСсылка.АктОбОказанииПроизводственныхУслуг")
		ИЛИ ТипДокументаРеализации = Тип("ДокументСсылка.РеализацияУслугПоПереработке") Тогда
		РеквизитыШапки = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шапка.ДокументРеализации, "Исполнитель, ИсполнительПоПриказу");
		Если ЗначениеЗаполнено(РеквизитыШапки.Исполнитель) Тогда
			ДанныеДляПечати.Вставить("КладовщикДляУПД", 				РеквизитыШапки.Исполнитель);
			ДанныеДляПечати.Вставить("ДатаДокументаДляУПД", 			РеквизитыСФ.Дата);
			ДанныеДляПечати.Вставить("ЗаКладовщикаПоПриказуДляУПД", 	РеквизитыШапки.ИсполнительПоПриказу)
		КонецЕсли;
	КонецЕсли;
	
	Возврат ДанныеДляПечати;
	
КонецФункции	

Функция СобратьДанныеДляПечатиКорректировочногоСчетаФактуры(ТекущееОснование, Ссылка)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ДокументОснование", ТекущееОснование);
	Запрос.УстановитьПараметр("ПустойКонтрагент", Справочники.Контрагенты.ПустаяСсылка());
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КорректировкаРеализации.Организация,
	|	КорректировкаРеализации.Организация КАК Поставщик,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КорректировкаРеализации.Грузоотправитель, &ПустойКонтрагент) = &ПустойКонтрагент
	|			ТОГДА ""он же""
	|		ИНАЧЕ КорректировкаРеализации.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	КорректировкаРеализации.Контрагент КАК Покупатель,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КорректировкаРеализации.Грузополучатель, &ПустойКонтрагент) = &ПустойКонтрагент
	|			ТОГДА КорректировкаРеализации.Контрагент
	|		ИНАЧЕ КорректировкаРеализации.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	КорректировкаРеализации.СуммаДокумента КАК Сумма,
	|	КорректировкаРеализации.ВалютаДокумента КАК Валюта,
	|	КорректировкаРеализации.УчитыватьНДС КАК УчитыватьНДС,
	|	КорректировкаРеализации.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	КорректировкаРеализации.АдресДоставки КАК АдресДоставки
	|ПОМЕСТИТЬ ВТИсходныйДокумент
	|ИЗ
	|	Документ.КорректировкаРеализации КАК КорректировкаРеализации
	|ГДЕ
	|	КорректировкаРеализации.Ссылка = &ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТИсходныйДокумент.Организация,
	|	ВТИсходныйДокумент.Покупатель,
	|	ВТИсходныйДокумент.Грузополучатель,
	|	ВТИсходныйДокумент.Поставщик,
	|	ВТИсходныйДокумент.Грузоотправитель,
	|	ВТИсходныйДокумент.Сумма,
	|	ВТИсходныйДокумент.Валюта,
	|	ВТИсходныйДокумент.УчитыватьНДС,
	|	ВТИсходныйДокумент.СуммаВключаетНДС
	|ИЗ
	|	ВТИсходныйДокумент КАК ВТИсходныйДокумент";
	
	Шапка = Запрос.Выполнить().Выбрать();
	Шапка.Следующий();
	
	ДанныеДляПечати = Новый Структура();
	
	Поставщик = Шапка.Поставщик;
	Если ЗначениеЗаполнено(Поставщик.ГоловнаяОрганизация) Тогда 
		Поставщик = Поставщик.ГоловнаяОрганизация;
	КонецЕсли;
	
	ДанныеДляПечати.Вставить("Организация",       Шапка.Организация);
	ДанныеДляПечати.Вставить("Поставщик",         Поставщик);
	ДанныеДляПечати.Вставить("Валюта",			  Шапка.Валюта);
	ДанныеДляПечати.Вставить("Покупатель",        Шапка.Покупатель);
	ДанныеДляПечати.Вставить("СуммаВключаетНДС",  Шапка.СуммаВключаетНДС);
	
	РеквизитыСФ = ОбщегоНазначения.ПолучитьЗначенияРеквизитов(Ссылка, "Дата,Исправление");
	
	Руководители = РегламентированнаяОтчетность.ОтветственныеЛицаОрганизаций(Шапка.Организация, РеквизитыСФ.Дата);
	
	ДанныеДляПечати.Вставить(?(РегламентированнаяОтчетность.ЭтоПБОЮЛ(Шапка.Организация), "ФИОПБОЮЛ", "ФИОРуководителя"), Руководители.Руководитель);
	ДанныеДляПечати.Вставить("ФИОГлавногоБухгалтера", Руководители.ГлавныйБухгалтер);
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КорректировкаРеализацииТовары.Ссылка,
	|	КорректировкаРеализацииТовары.НомерСтроки КАК НомерСтроки,
	|	КорректировкаРеализацииТовары.Номенклатура,
	|	ВЫРАЗИТЬ(КорректировкаРеализацииТовары.Номенклатура.НаименованиеПолное КАК СТРОКА(1000)) КАК НаименованиеТовара,
	|	КорректировкаРеализацииТовары.СерияНоменклатуры КАК Серия,
	|	КорректировкаРеализацииТовары.ХарактеристикаНоменклатуры КАК Характеристика,
	|	КорректировкаРеализацииТовары.ЕдиницаИзмерения КАК НаименованиеЕдиницыИзмерения,
	|	КорректировкаРеализацииТовары.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК ЕдиницаИзмеренияКод,
	|	КорректировкаРеализацииТовары.СтавкаНДС,
	|	КорректировкаРеализацииТовары.СуммаНДС КАК СуммаНДСПослеИзменения,
	|	КорректировкаРеализацииТовары.СуммаНДСДоИзменения,
	|	КорректировкаРеализацииТовары.Количество КАК КоличествоПослеИзменения,
	|	КорректировкаРеализацииТовары.КоличествоДоИзменения,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА КорректировкаРеализацииТовары.Количество = 0
	|				ТОГДА 0
	|			ИНАЧЕ ВЫБОР
	|					КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|						ТОГДА (КорректировкаРеализацииТовары.Сумма - КорректировкаРеализацииТовары.СуммаНДС) / КорректировкаРеализацииТовары.Количество
	|					ИНАЧЕ КорректировкаРеализацииТовары.Сумма / КорректировкаРеализацииТовары.Количество
	|				КОНЕЦ
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК ЦенаПослеИзменения,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА КорректировкаРеализацииТовары.КоличествоДоИзменения = 0
	|				ТОГДА 0
	|			ИНАЧЕ ВЫБОР
	|					КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|						ТОГДА (КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.СуммаНДСДоИзменения) / КорректировкаРеализацииТовары.КоличествоДоИзменения
	|					ИНАЧЕ КорректировкаРеализацииТовары.СуммаДоИзменения / КорректировкаРеализацииТовары.КоличествоДоИзменения
	|				КОНЕЦ
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК ЦенаДоИзменения,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА КорректировкаРеализацииТовары.Сумма - КорректировкаРеализацииТовары.СуммаНДС
	|		ИНАЧЕ КорректировкаРеализацииТовары.Сумма
	|	КОНЕЦ КАК СтоимостьБезНДСПослеИзменения,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.СуммаНДСДоИзменения
	|		ИНАЧЕ КорректировкаРеализацииТовары.СуммаДоИзменения
	|	КОНЕЦ КАК СтоимостьБезНДСДоИзменения,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА КорректировкаРеализацииТовары.Сумма
	|		ИНАЧЕ КорректировкаРеализацииТовары.Сумма + КорректировкаРеализацииТовары.СуммаНДС
	|	КОНЕЦ КАК СтоимостьСНДСПослеИзменения,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА КорректировкаРеализацииТовары.СуммаДоИзменения
	|		ИНАЧЕ КорректировкаРеализацииТовары.СуммаДоИзменения + КорректировкаРеализацииТовары.СуммаНДСДоИзменения
	|	КОНЕЦ КАК СтоимостьСНДСДоИзменения,
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииТовары.СуммаНДСДоИзменения - КорректировкаРеализацииТовары.СуммаНДС > 0
	|			ТОГДА КорректировкаРеализацииТовары.СуммаНДСДоИзменения - КорректировкаРеализацииТовары.СуммаНДС
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК РазницаНДСУменьшение,
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииТовары.СуммаНДСДоИзменения - КорректировкаРеализацииТовары.СуммаНДС < 0
	|			ТОГДА (КорректировкаРеализацииТовары.СуммаНДСДоИзменения - КорректировкаРеализацииТовары.СуммаНДС) * -1
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК РазницаНДСУвеличение,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА ВЫБОР
	|					КОГДА КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.СуммаНДСДоИзменения - (КорректировкаРеализацииТовары.Сумма - КорректировкаРеализацииТовары.СуммаНДС) > 0
	|						ТОГДА КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.СуммаНДСДоИзменения - (КорректировкаРеализацииТовары.Сумма - КорректировкаРеализацииТовары.СуммаНДС)
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ ВЫБОР
	|				КОГДА КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.Сумма > 0
	|					ТОГДА КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.Сумма
	|				ИНАЧЕ 0
	|			КОНЕЦ
	|	КОНЕЦ КАК РазницаБезНДСУменьшение,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА ВЫБОР
	|					КОГДА КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.СуммаНДСДоИзменения - (КорректировкаРеализацииТовары.Сумма - КорректировкаРеализацииТовары.СуммаНДС) < 0
	|						ТОГДА (КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.СуммаНДСДоИзменения - (КорректировкаРеализацииТовары.Сумма - КорректировкаРеализацииТовары.СуммаНДС)) * -1
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ ВЫБОР
	|				КОГДА КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.Сумма < 0
	|					ТОГДА (КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.Сумма) * -1
	|				ИНАЧЕ 0
	|			КОНЕЦ
	|	КОНЕЦ КАК РазницаБезНДСУвеличение,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА ВЫБОР
	|					КОГДА КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.Сумма > 0
	|						ТОГДА КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.Сумма
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ ВЫБОР
	|				КОГДА КорректировкаРеализацииТовары.СуммаДоИзменения + КорректировкаРеализацииТовары.СуммаНДСДоИзменения - (КорректировкаРеализацииТовары.Сумма + КорректировкаРеализацииТовары.СуммаНДС) > 0
	|					ТОГДА КорректировкаРеализацииТовары.СуммаДоИзменения + КорректировкаРеализацииТовары.СуммаНДСДоИзменения - (КорректировкаРеализацииТовары.Сумма + КорректировкаРеализацииТовары.СуммаНДС)
	|				ИНАЧЕ 0
	|			КОНЕЦ
	|	КОНЕЦ КАК РазницаСНДСУменьшение,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА ВЫБОР
	|					КОГДА КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.Сумма < 0
	|						ТОГДА (КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.Сумма) * -1
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ ВЫБОР
	|				КОГДА КорректировкаРеализацииТовары.СуммаДоИзменения + КорректировкаРеализацииТовары.СуммаНДСДоИзменения - (КорректировкаРеализацииТовары.Сумма + КорректировкаРеализацииТовары.СуммаНДС) < 0
	|					ТОГДА (КорректировкаРеализацииТовары.СуммаДоИзменения + КорректировкаРеализацииТовары.СуммаНДСДоИзменения - (КорректировкаРеализацииТовары.Сумма + КорректировкаРеализацииТовары.СуммаНДС)) * -1
	|				ИНАЧЕ 0
	|			КОНЕЦ
	|	КОНЕЦ КАК РазницаСНДСУвеличение,
	|	1 КАК НомерТЧ,
	|	КорректировкаРеализацииТовары.СтавкаНДСДоИзменения,
	|	КорректировкаРеализацииТовары.СтавкаНДС КАК СтавкаНДСПослеИзменения,
	|	ЕСТЬNULL(Штрихкоды.Штрихкод, """") КАК ШтрихКод
	|ИЗ
	|	Документ.КорректировкаРеализации.Товары КАК КорректировкаРеализацииТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК Штрихкоды
	|		ПО КорректировкаРеализацииТовары.ХарактеристикаНоменклатуры = Штрихкоды.ХарактеристикаНоменклатуры
	|			И (Штрихкоды.ТипШтрихкода = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыШтрихкодов.EAN13))
	|			И КорректировкаРеализацииТовары.ЕдиницаИзмерения = Штрихкоды.ЕдиницаИзмерения
	|			И КорректировкаРеализацииТовары.Номенклатура = Штрихкоды.Владелец,
	|	ВТИсходныйДокумент КАК ИсходныйДокумент
	|ГДЕ
	|	КорректировкаРеализацииТовары.Ссылка = &ДокументОснование
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КорректировкаРеализацииУслуги.Ссылка,
	|	КорректировкаРеализацииУслуги.НомерСтроки,
	|	КорректировкаРеализацииУслуги.Номенклатура,
	|	ВЫРАЗИТЬ(КорректировкаРеализацииУслуги.Содержание КАК СТРОКА(1000)),
	|	NULL,
	|	NULL,
	|	КорректировкаРеализацииУслуги.Номенклатура.ЕдиницаХраненияОстатков,
	|	КорректировкаРеализацииУслуги.Номенклатура.ЕдиницаХраненияОстатков.ЕдиницаПоКлассификатору.Код,
	|	КорректировкаРеализацииУслуги.СтавкаНДС,
	|	КорректировкаРеализацииУслуги.СуммаНДС,
	|	КорректировкаРеализацииУслуги.СуммаНДСДоИзменения,
	|	КорректировкаРеализацииУслуги.Количество,
	|	КорректировкаРеализацииУслуги.КоличествоДоИзменения,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА КорректировкаРеализацииУслуги.Количество = 0
	|				ТОГДА 0
	|			ИНАЧЕ ВЫБОР
	|					КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|						ТОГДА (КорректировкаРеализацииУслуги.Сумма - КорректировкаРеализацииУслуги.СуммаНДС) / КорректировкаРеализацииУслуги.Количество
	|					ИНАЧЕ КорректировкаРеализацииУслуги.Сумма / КорректировкаРеализацииУслуги.Количество
	|				КОНЕЦ
	|		КОНЕЦ КАК ЧИСЛО(15, 2)),
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА КорректировкаРеализацииУслуги.КоличествоДоИзменения = 0
	|				ТОГДА 0
	|			ИНАЧЕ ВЫБОР
	|					КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|						ТОГДА (КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.СуммаНДСДоИзменения) / КорректировкаРеализацииУслуги.КоличествоДоИзменения
	|					ИНАЧЕ КорректировкаРеализацииУслуги.СуммаДоИзменения / КорректировкаРеализацииУслуги.КоличествоДоИзменения
	|				КОНЕЦ
	|		КОНЕЦ КАК ЧИСЛО(15, 2)),
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА КорректировкаРеализацииУслуги.Сумма - КорректировкаРеализацииУслуги.СуммаНДС
	|		ИНАЧЕ КорректировкаРеализацииУслуги.Сумма
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.СуммаНДСДоИзменения
	|		ИНАЧЕ КорректировкаРеализацииУслуги.СуммаДоИзменения
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА КорректировкаРеализацииУслуги.Сумма
	|		ИНАЧЕ КорректировкаРеализацииУслуги.Сумма + КорректировкаРеализацииУслуги.СуммаНДС
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения
	|		ИНАЧЕ КорректировкаРеализацииУслуги.СуммаДоИзменения + КорректировкаРеализацииУслуги.СуммаНДСДоИзменения
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииУслуги.СуммаНДСДоИзменения - КорректировкаРеализацииУслуги.СуммаНДС > 0
	|			ТОГДА КорректировкаРеализацииУслуги.СуммаНДСДоИзменения - КорректировкаРеализацииУслуги.СуммаНДС
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииУслуги.СуммаНДСДоИзменения - КорректировкаРеализацииУслуги.СуммаНДС < 0
	|			ТОГДА (КорректировкаРеализацииУслуги.СуммаНДСДоИзменения - КорректировкаРеализацииУслуги.СуммаНДС) * -1
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА ВЫБОР
	|					КОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.СуммаНДСДоИзменения - (КорректировкаРеализацииУслуги.Сумма - КорректировкаРеализацииУслуги.СуммаНДС) > 0
	|						ТОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.СуммаНДСДоИзменения - (КорректировкаРеализацииУслуги.Сумма - КорректировкаРеализацииУслуги.СуммаНДС)
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ ВЫБОР
	|				КОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.Сумма > 0
	|					ТОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.Сумма
	|				ИНАЧЕ 0
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА ВЫБОР
	|					КОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.СуммаНДСДоИзменения - (КорректировкаРеализацииУслуги.Сумма - КорректировкаРеализацииУслуги.СуммаНДС) < 0
	|						ТОГДА (КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.СуммаНДСДоИзменения - (КорректировкаРеализацииУслуги.Сумма - КорректировкаРеализацииУслуги.СуммаНДС)) * -1
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ ВЫБОР
	|				КОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.Сумма < 0
	|					ТОГДА (КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.Сумма) * -1
	|				ИНАЧЕ 0
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА ВЫБОР
	|					КОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.Сумма > 0
	|						ТОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.Сумма
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ ВЫБОР
	|				КОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения + КорректировкаРеализацииУслуги.СуммаНДСДоИзменения - (КорректировкаРеализацииУслуги.Сумма + КорректировкаРеализацииУслуги.СуммаНДС) > 0
	|					ТОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения + КорректировкаРеализацииУслуги.СуммаНДСДоИзменения - (КорректировкаРеализацииУслуги.Сумма + КорректировкаРеализацииУслуги.СуммаНДС)
	|				ИНАЧЕ 0
	|			КОНЕЦ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ИсходныйДокумент.СуммаВключаетНДС
	|			ТОГДА ВЫБОР
	|					КОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.Сумма < 0
	|						ТОГДА (КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.Сумма) * -1
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|		ИНАЧЕ ВЫБОР
	|				КОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения + КорректировкаРеализацииУслуги.СуммаНДСДоИзменения - (КорректировкаРеализацииУслуги.Сумма + КорректировкаРеализацииУслуги.СуммаНДС) < 0
	|					ТОГДА (КорректировкаРеализацииУслуги.СуммаДоИзменения + КорректировкаРеализацииУслуги.СуммаНДСДоИзменения - (КорректировкаРеализацииУслуги.Сумма + КорректировкаРеализацииУслуги.СуммаНДС)) * -1
	|				ИНАЧЕ 0
	|			КОНЕЦ
	|	КОНЕЦ,
	|	2,
	|	КорректировкаРеализацииУслуги.СтавкаНДСДоИзменения,
	|	КорректировкаРеализацииУслуги.СтавкаНДС,
	|	""""
	|ИЗ
	|	Документ.КорректировкаРеализации.Услуги КАК КорректировкаРеализацииУслуги,
	|	ВТИсходныйДокумент КАК ИсходныйДокумент
	|ГДЕ
	|	КорректировкаРеализацииУслуги.Ссылка = &ДокументОснование
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерТЧ,
	|	НомерСтроки";
	 
	Если РеквизитыСФ.Исправление Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, ".СтавкаНДСДоИзменения", ".СтавкаНДС КАК СтавкаНДСДоИзменения");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ДоИзменения", "ДоКорректировки");
	КонецЕсли;
	
	ТаблицаРезультата = Запрос.Выполнить().Выгрузить();
	Для Каждого Колонка Из ТаблицаРезультата.Колонки Цикл
		Колонка.Имя = СтрЗаменить(Колонка.Имя, "ДоКорректировки", "ДоИзменения");
	КонецЦикла;
	
	Для каждого Строчка Из ТаблицаРезультата Цикл
		Строчка.НаименованиеТовара = СокрЛП(Строчка.НаименованиеТовара)
		//+ ПредставлениеСерий(Строчка);
	КонецЦикла;
	
	ДанныеДляПечати.Вставить("ТабличнаяЧасть", ТаблицаРезультата); 
	
	Возврат ДанныеДляПечати;
	
КонецФункции	

Функция СоздатьТаблицуДляЗаполнениеТабличнойЧастиДанныхПечати()
	
	Товары = Новый ТаблицаЗначений();
	
	Товары.Колонки.Добавить("Номенклатура");
	Товары.Колонки.Добавить("ИмяСпец");
	Товары.Колонки.Добавить("НаименованиеТовара");
	Товары.Колонки.Добавить("ТоварКод");
	Товары.Колонки.Добавить("ТоварАртикул");
	Товары.Колонки.Добавить("СтранаПроисхождения");
	Товары.Колонки.Добавить("СтранаПроисхожденияКод");
	Товары.Колонки.Добавить("ПредставлениеСтраны");
	Товары.Колонки.Добавить("НомерГТД");
	Товары.Колонки.Добавить("ПредставлениеГТД");
	Товары.Колонки.Добавить("Количество");
	Товары.Колонки.Добавить("КоличествоДоИзменения");
	Товары.Колонки.Добавить("КоличествоПослеИзменения");
	Товары.Колонки.Добавить("ЕдиницаИзмерения");
	Товары.Колонки.Добавить("ЕдиницаИзмеренияКод");
	Товары.Колонки.Добавить("СуммаВключаетНДС");
	Товары.Колонки.Добавить("Цена");
	Товары.Колонки.Добавить("ЦенаДоИзменения");
 	Товары.Колонки.Добавить("ЦенаПослеИзменения");
	Товары.Колонки.Добавить("СтавкаНДС");
	Товары.Колонки.Добавить("СуммаНДС");
	Товары.Колонки.Добавить("Сумма");
	Товары.Колонки.Добавить("НомерСтроки");
	Товары.Колонки.Добавить("ШтрихКод");
    Товары.Колонки.Добавить("СтавкаНДСДоИзменения");
    Товары.Колонки.Добавить("СтавкаНДСПослеИзменения");
	
	Возврат Товары;
	
КонецФункции

Функция ОтветственныйПоЭДО(Организация, Дата)
	
	СтруктураДанных = Новый Структура("Должность, ФизическоеЛицо, Фамилия, Имя, Отчество");
	
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("Дата", Дата);
		
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	               |	ОтветственныеЛицаСрезПоследних.Должность.Наименование КАК Должность,
	               |	ОтветственныеЛицаСрезПоследних.ФизическоеЛицо КАК ФизическоеЛицо,
	               |	ФИОФизЛицСрезПоследних.Фамилия КАК Фамилия,
	               |	ФИОФизЛицСрезПоследних.Имя КАК Имя,
	               |	ФИОФизЛицСрезПоследних.Отчество КАК Отчество
	               |ИЗ
	               |	РегистрСведений.ОтветственныеЛицаОрганизаций.СрезПоследних(
	               |			&Дата,
	               |			ОтветственноеЛицо = ЗНАЧЕНИЕ(Перечисление.ОтветственныеЛицаОрганизаций.Лео_ОтветственныйПоЭДО)
	               |				И СтруктурнаяЕдиница = &Организация) КАК ОтветственныеЛицаСрезПоследних
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ФИОФизЛиц.СрезПоследних(&Дата, ФизЛицо ССЫЛКА Справочник.ФизическиеЛица) КАК ФИОФизЛицСрезПоследних
	               |		ПО ОтветственныеЛицаСрезПоследних.ФизическоеЛицо = ФИОФизЛицСрезПоследних.ФизЛицо";


		Выборка = Запрос.Выполнить().Выбрать();
		
		Выборка.Следующий(); 
		ЗаполнитьЗначенияСвойств(СтруктураДанных,Выборка);

	Возврат СтруктураДанных
		
КонецФункции

Функция УдалитьЛидирующиеНули(Знач ПолноеЗначение)
	
	ПолноеЗначение = СокрЛП(ПолноеЗначение);
	ДлинаПолногоЗначения = СтрДлина(ПолноеЗначение);
	
	СокращенноеЗначение = "";
	
	Для Инд = 1 По ДлинаПолногоЗначения Цикл
		СимволОтличаетсяОтНуля = (Сред(ПолноеЗначение, Инд, 1) <> "0");
		Если СимволОтличаетсяОтНуля Тогда
			СокращенноеЗначение = Сред(ПолноеЗначение, Инд);
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Возврат СокращенноеЗначение;
	
КонецФункции

Процедура ПроверитьНаВхождениеВМаркируемыйТовар(ЗаписьXML, ВыборкаСтрока, ДокумКорректировка)
 		ЗначениеОКПД2	= лео_ДопФункции.Получить_ЗначенияСвойствОбъектов(ВыборкаСтрока.Номенклатура, ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("00000000066"));
		Если ЗначениеЗаполнено(ЗначениеОКПД2) И ТипЗнч(ЗначениеОКПД2)=Тип("СправочникСсылка.Лео_КлассификаторОКПД2") Тогда 
			Если ЗначениеОКПД2.ЧестныйЗнак Тогда
				Если ДокумКорректировка.Дата>=Дата(2025,9,1,0,0,0) Тогда
					Если ДокумКорректировка.КодыТранспортнойУпаковки.Количество()>0 ИЛИ ДокумКорректировка.КодыКонтрИдентЗнаки.Количество()>0 Тогда
						Отбор	=	Новый  Структура;
						Отбор.Вставить("Номенклатура",ВыборкаСтрока.Номенклатура); 
						Отбор.Вставить("СерияНоменклатуры",ВыборкаСтрока.Серия); 
						РезультатОтбора		= 	ДокумКорректировка.КодыТранспортнойУпаковки.НайтиСтроки(Отбор); 
						РезультатОтбораКИЗ	= 	ДокумКорректировка.КодыКонтрИдентЗнаки.НайтиСтроки(Отбор); 
						Для Каждого СтрокаРезультат Из РезультатОтбора Цикл
							Если ЗначениеЗаполнено(СтрокаРезультат.КодыТрансУпак_ДО) Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("НомСредИдентТовДо"); //+НомСредИдентТовДо
					    		ЗаписьXML.ЗаписатьАтрибут( "ИдентТрансУпак",СокрЛП(СтрокаРезультат.КодыТрансУпак_ДО));
							ЗаписьXML.ЗаписатьКонецЭлемента();//НомСредИдентТовДо
							КонецЕсли;
						КонецЦикла;
						ЕстьНеПустыеЗаписи	=	Ложь;
						ВыведенПервыйТег	=	Ложь;
						Для Каждого СтрокаРезультат Из РезультатОтбораКИЗ Цикл
							Если ЗначениеЗаполнено(СтрокаРезультат.КодыКИЗ_ДО) Тогда
								ЕстьНеПустыеЗаписи	=	Истина; 
								Если НЕ ВыведенПервыйТег Тогда
									ЗаписьXML.ЗаписатьНачалоЭлемента("НомСредИдентТовДо"); //+НомСредИдентТовДо 
									ВыведенПервыйТег	=	Истина; 
								КонецЕсли;
								НомУпаковки = Сред(СокрЛП(СтрокаРезультат.КодыКИЗ_ДО),1,32);
								НомУпаковки	=	лео_ДопФункции.ПодготовкаСтрокиДляПередачиXML(НомУпаковки);
								ЗаписатьXML(ЗаписьXML,НомУпаковки,"КИЗ");     
							КонецЕсли;
						КонецЦикла; 
						Если ВыведенПервыйТег Тогда
							ЗаписьXML.ЗаписатьКонецЭлемента();//НомСредИдентТовДо  
						КонецЕсли; 
						
						Для Каждого СтрокаРезультат Из РезультатОтбора Цикл
							Если ЗначениеЗаполнено(СтрокаРезультат.КодыТрансУпак_ПОСЛЕ) Тогда
							ЗаписьXML.ЗаписатьНачалоЭлемента("НомСредИдентТовПосле"); //+НомСредИдентТовПосле
					    		ЗаписьXML.ЗаписатьАтрибут( "ИдентТрансУпак",СокрЛП(СтрокаРезультат.КодыТрансУпак_ПОСЛЕ));
							ЗаписьXML.ЗаписатьКонецЭлемента();//НомСредИдентТовПосле
							КонецЕсли;
	                    КонецЦикла;
						ЕстьНеПустыеЗаписи	=	Ложь;
						ВыведенПервыйТег	=	Ложь;
						Для Каждого СтрокаРезультат Из РезультатОтбораКИЗ Цикл
							Если ЗначениеЗаполнено(СтрокаРезультат.КодыКИЗ_ПОСЛЕ) Тогда
								ЕстьНеПустыеЗаписи	=	Истина; 
								Если НЕ ВыведенПервыйТег Тогда
									ЗаписьXML.ЗаписатьНачалоЭлемента("НомСредИдентТовПосле"); //+НомСредИдентТовДо 
									ВыведенПервыйТег	=	Истина; 
								КонецЕсли;
								НомУпаковки = Сред(СокрЛП(СтрокаРезультат.КодыКИЗ_ПОСЛЕ),1,32);
								НомУпаковки	=	лео_ДопФункции.ПодготовкаСтрокиДляПередачиXML(НомУпаковки);
								ЗаписатьXML(ЗаписьXML,НомУпаковки,"КИЗ");     
							КонецЕсли;
						КонецЦикла; 
						Если ВыведенПервыйТег Тогда
							ЗаписьXML.ЗаписатьКонецЭлемента();//НомСредИдентТовДо  
						КонецЕсли; 
					КонецЕсли;	
				КонецЕсли;	
			КонецЕсли;	
		КонецЕсли;	
КонецПроцедуры	

// Функция СтрРазделить(Знач Строка, Разделитель)
//	
//	Результат = Новый Массив;
//	Если ПустаяСтрока(Строка) Тогда
//		Возврат Результат;
//	КонецЕсли;
//	
//	НачПозицияПервогоЭлемента = Найти(Строка, "{");
//	КонПозицияПервогоЭлемента = Найти(Строка, "}");
//	Если НачПозицияПервогоЭлемента > 0 И КонПозицияПервогоЭлемента > 0 Тогда
//		ПервыйЭлемент = Сред(Строка, НачПозицияПервогоЭлемента, КонПозицияПервогоЭлемента);
//		Результат.Добавить(СокрЛП(ПервыйЭлемент));
//		Строка = СокрЛП(Сред(Строка,КонПозицияПервогоЭлемента + 2));
//	КонецЕсли;
//	
//	Пока Истина Цикл
//		Позиция = Найти(Строка,Разделитель);
//		Если Позиция = 0 Тогда
//			Прервать;
//		КонецЕсли;
//		
//		Результат.Добавить(СокрЛП(Лев(Строка,Позиция - 1)));
//		Строка = СокрЛП(Сред(Строка,Позиция + 1));
//	КонецЦикла;
//	
//	Результат.Добавить(СокрЛП(Строка));
//	
//	Возврат Результат;
//	
//КонецФункции 

Процедура ВыгрузитьФайлОбменаСервер(ДвоичныйФайл,НастройкиОбмена,ИмяФайлаВыгрузки,КаталогНаСервере) Экспорт
	
	ДанныеФайла = ПолучитьИзВременногоХранилища(ДвоичныйФайл);

	
    //формируем файл выгрузки
	ИмяФайлаВыгрузки = "PRICE.dbf";
	ПолноеИмяФайлаВыгрузки = КаталогВременныхФайлов() + ИмяФайлаВыгрузки;
	ДанныеФайла.Записать(ПолноеИмяФайлаВыгрузки);
	
	//Состояние("Установка соединения " + НастройкиОбмена.FTPАдресОбмена);
    FTPСервер = ВыполнитьFTPПодключениеКСерверу(НастройкиОбмена.FTPАдресОбмена, НастройкиОбмена,"", Истина);
	Если  FTPСервер = Неопределено Тогда
		  Возврат;
	КонецЕсли;;
		
	Попытка 
		
	FTPСервер.УстановитьТекущийКаталог("/"+КаталогНаСервере);
	FTPСервер.Записать(ПолноеИмяФайлаВыгрузки, ИмяФайлаВыгрузки);
	ТекстСообщения = ("Файл отправлен контрагенту на " + НастройкиОбмена.FTPАдресОбмена);
	Сообщить(ТекстСообщения);

	Исключение
		ТекстСообщения = ОписаниеОшибки();
		Сообщить(ТекстСообщения);

	КонецПопытки;

КонецПроцедуры

 Процедура ЗагрузитьФайлОбменаСервер(НастройкиОбмена,КаталогНаСервере,КаталогЗагрузки) Экспорт
	

	Попытка 
	
  	//Состояние("Установка соединения " + НастройкиОбмена.FTPАдресОбмена);
    FTPСервер = ВыполнитьFTPПодключениеКСерверу(НастройкиОбмена.FTPАдресОбмена, НастройкиОбмена,"", Истина);

		МаскаФайлов = "*.dbf";
		МассивФайлов = FTPСервер.НайтиФайлы(КаталогНаСервере, МаскаФайлов);	

		Для Каждого Файл Из МассивФайлов Цикл
			// Проверить, что это не каталог.
			Если Файл.ЭтоФайл() Тогда
				// Копировать файл в локальный каталог.
				ТекстСообщения = ("Чтение файла " + Файл.Имя);
		        Сообщить(ТекстСообщения);
				FTPСервер.Получить(Файл.ПолноеИмя, КаталогЗагрузки + "/" + Файл.Имя);
			КонецЕсли;    
		КонецЦикла;
	Исключение
		ТекстСообщения = ОписаниеОшибки();
		Сообщить(ТекстСообщения);

	КонецПопытки;

КонецПроцедуры


///////////////////////////////////////////////////////////////////////////////////////////////////////

Процедура ВыгрузитьФайлОтказа(ЗаказСсылка) Экспорт
	
	НастройкиОбмена = Неопределено;
	Если ТипЗнч(ЗаказСсылка.ДокументОснование) = Тип("ДокументСсылка.абс_СообщениеEDI") Тогда
		НастройкиОбмена =  ЗаказСсылка.ДокументОснование.НастройкаОбмена;
	КонецЕсли;
	
	Если НастройкиОбмена = Неопределено тогда   
		Сообщить("Не найдены настройки обмена для Контрагента");    
		СообщитьОбОшибкеОбмена("Отказ по заказу не выгружен!");
	Иначе  
		
		Если НастройкиОбмена.ТипНастройки = Перечисления.абс_ТипыОбменаEDI.ОбменЧерезFTPРесурс Тогда
				Если ЗаказСсылка.Контрагент.Код = "УТ0006921" Тогда  //ЕАптека  
					 ФайлОбмена = СформироватьФайл_Отказ_ЕАптека(ЗаказСсылка);   
					 ИмяФайлаВыгрузки = ПолучитьСтроковыйНомерБезПрефиксов(ЗаказСсылка.Номер)  + ".dbf";
	                 ВыгрузитьФайлОбменаСервер(ФайлОбмена,НастройкиОбмена,ИмяФайлаВыгрузки,"otkaz");

      		   КонецЕсли;	   
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры     



Функция СформироватьФайл_Отказ_ЕАптека(ЗаказСсылка)
	
	Запрос = Новый Запрос;
	Запрос.Текст=   "ВЫБРАТЬ
	|	СУММА(ЕСТЬNULL(ВложенныйЗапрос.Количество, 0) + ЕСТЬNULL(ВложенныйЗапрос.КоличествоНеотгрузЗаказ, 0)) КАК Количество,
	|	ВложенныйЗапрос.ЕдиницаИзмерения,
	|	ВложенныйЗапрос.Номенклатура,
	|	ВложенныйЗапрос.ЗаказПокупателя,
	|	МАКСИМУМ(ВложенныйЗапрос.Цена) КАК Цена,
	|	СУММА(ЕСТЬNULL(ВложенныйЗапрос.КоличествоНеотгрузРеализация, 0) + ЕСТЬNULL(ВложенныйЗапрос.КоличествоНеотгрузЗаказ, 0)) КАК КоличествоНеотгруз
	|ПОМЕСТИТЬ ТЗ_Неотгружено
	|ИЗ
	|	(ВЫБРАТЬ
	|		0 КАК Количество,
	|		0 КАК Сумма,
	|		СУММА(ЗаказПокупателяабс_Неотгружено.Количество) КАК КоличествоНеотгрузЗаказ,
	|		СУММА(ЗаказПокупателяабс_Неотгружено.Сумма) КАК СуммаНеотгрузЗаказ,
	|		ЗаказПокупателяабс_Неотгружено.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|		ЗаказПокупателяабс_Неотгружено.Номенклатура КАК Номенклатура,
	|		ЗаказПокупателяабс_Неотгружено.Ссылка КАК ЗаказПокупателя,
	|		МАКСИМУМ(ЗаказПокупателяабс_Неотгружено.Цена) КАК Цена,
	|		0 КАК КоличествоНеотгрузРеализация,
	|		0 КАК СуммаНеотгрузРеализация
	|	ИЗ
	|		Документ.ЗаказПокупателя.абс_Неотгружено КАК ЗаказПокупателяабс_Неотгружено
	|	ГДЕ
	|		ЗаказПокупателяабс_Неотгружено.Ссылка = &ЗаказПокупателя
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ЗаказПокупателяабс_Неотгружено.Номенклатура,
	|		ЗаказПокупателяабс_Неотгружено.Ссылка,
	|		ЗаказПокупателяабс_Неотгружено.ЕдиницаИзмерения
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ЗаказыПокупателейОбороты.КоличествоОборот,
	|		ЗаказыПокупателейОбороты.СуммаВзаиморасчетовОборот,
	|		0,
	|		0,
	|		ЗаказыПокупателейОбороты.ЕдиницаИзмерения,
	|		ЗаказыПокупателейОбороты.Номенклатура,
	|		ЗаказыПокупателейОбороты.ЗаказПокупателя,
	|		ЗаказыПокупателейОбороты.Цена,
	|		0,
	|		0
	|	ИЗ
	|		РегистрНакопления.ЗаказыПокупателей.Обороты(, , , ЗаказПокупателя = &ЗаказПокупателя) КАК ЗаказыПокупателейОбороты
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		0,
	|		0,
	|		0,
	|		0,
	|		РеализацияТоваровУслугабс_Неотгружено.ЕдиницаИзмерения,
	|		РеализацияТоваровУслугабс_Неотгружено.Номенклатура,
	|		РеализацияТоваровУслугабс_Неотгружено.Ссылка.Сделка,
	|		РеализацияТоваровУслугабс_Неотгружено.Цена,
	|		РеализацияТоваровУслугабс_Неотгружено.Количество,
	|		РеализацияТоваровУслугабс_Неотгружено.Сумма
	|	ИЗ
	|		Документ.РеализацияТоваровУслуг.абс_Неотгружено КАК РеализацияТоваровУслугабс_Неотгружено
	|	ГДЕ
	|		РеализацияТоваровУслугабс_Неотгружено.Ссылка.Сделка = &ЗаказПокупателя) КАК ВложенныйЗапрос
	|
	|СГРУППИРОВАТЬ ПО
	|	ВложенныйЗапрос.ЕдиницаИзмерения,
	|	ВложенныйЗапрос.Номенклатура,
	|	ВложенныйЗапрос.ЗаказПокупателя
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТЗ_Неотгружено.Количество,
	|	ТЗ_Неотгружено.ЕдиницаИзмерения,
	|	ТЗ_Неотгружено.Номенклатура,
	|	ТЗ_Неотгружено.ЗаказПокупателя,
	|	ТЗ_Неотгружено.Цена,
	|	ТЗ_Неотгружено.КоличествоНеотгруз
	|ИЗ
	|	ТЗ_Неотгружено КАК ТЗ_Неотгружено
	|ГДЕ
	|	ТЗ_Неотгружено.КоличествоНеотгруз > 0";
	
	Запрос.УстановитьПараметр("ЗаказПокупателя",ЗаказСсылка);
	
	ТабДок = Запрос.Выполнить().Выгрузить();
	
	Если ТабДок.Количество() > 0 Тогда      
		
	    ИмяФайлаВыгрузки_Отказ = ПолучитьСтроковыйНомерБезПрефиксов(ЗаказСсылка.Номер) + ".dbf";
    
		//ИмяФайлаВыгрузки_Отказ = ОбщегоНазначения.ПолучитьНомерНаПечать(ЗаказСсылка)  + ".dbf";
		ПолноеИмяФайлаВыгрузки_Отказ = КаталогВременныхФайлов() + ИмяФайлаВыгрузки_Отказ;
		
		БД = Новый XBase;
		БД.Кодировка = КодировкаXBase.OEM;
		
		БД.Поля.Добавить("NUMZ","C",32);		 // Номер документа
		БД.Поля.Добавить("DATEZ","D");           // Дата документа
		БД.Поля.Добавить("CODEPST","C",32);      // Код товара поставщика
		БД.Поля.Добавить("DATE","D");            // Дата формирования отказа
		БД.Поля.Добавить("PODR","C",40);		 // Наименование грузополучателя
		БД.Поля.Добавить("QNT","N",8,0);         // Количество упаковок
		БД.Поля.Добавить("QNTO","N",8,0);        // Отказанное Количество упаковок
		БД.Поля.Добавить("PRICE","N",9,2);       // Цена производителя с НДС
		БД.Поля.Добавить("PODRCD","C",12);       // Код грузополучателя в кодировке поставщика
		БД.Поля.Добавить("NAME","C",80);         // Наименование товара
		//
		////////////////////////////////////////////////////////////////////////////////////////
		БД.СоздатьФайл(ПолноеИмяФайлаВыгрузки_Отказ);
		БД.Записать();
		БД.АвтоСохранение = Истина;
		
		Для каждого Стр из ТабДок Цикл
			БД.Добавить();
			БД.NUMZ =     стр.ЗаказПокупателя.НомерПоДаннымПокупателя;                 // Номер заказа
			БД.DATEZ =    стр.ЗаказПокупателя.ДатаПоДаннымПокупателя;                  // Дата заказа
			БД.CODEPST =  стр.Номенклатура.Артикул;                                    // Код товара поставщика
			БД.DATE =     стр.ЗаказПокупателя.Дата;                                    // Дата формирования отказа
			БД.PODR =     стр.ЗаказПокупателя.Грузополучатель.Наименование;            // Наименование грузополучателя
			БД.QNT =      стр.Количество;                                              // Количество заказано
			БД.QNTO =     стр.КоличествоНеотгруз;                                      // Количество неотгружено
			БД.PRICE =    стр.Цена;
			
			БД.PODRCD =   стр.ЗаказПокупателя.Грузополучатель.Код;                     // Код грузополучателя в кодировке поставщика
			БД.NAME =     стр.Номенклатура.Наименование;                               // Наименование товара 
		КонецЦикла;
		БД.ЗакрытьФайл();
		
		КлючУникальности = Новый УникальныйИдентификатор;
	
	    ДвоичныйФайл = ПоместитьВоВременноеХранилище (Новый ДвоичныеДанные(ПолноеИмяФайлаВыгрузки_Отказ), КлючУникальности); 
		
		Возврат ДвоичныйФайл;
		
	КонецЕсли;
КонецФункции 

 Функция ПолучитьСтроковыйНомерБезПрефиксов(Номер) Экспорт
	
	НомерБезПрефиксов = "";
	Сч = СтрДлина(Номер);
	
	Пока Сч > 0 Цикл
		
		Символ = Сред(Номер, Сч, 1);
		
		Если (Символ >= "0" И Символ <= "9") Тогда
			
			НомерБезПрефиксов = Символ + НомерБезПрефиксов;
			
		Иначе
			
			Возврат НомерБезПрефиксов;
			
		КонецЕсли;
		
		Сч = Сч - 1;
		
	КонецЦикла;
	
	Возврат НомерБезПрефиксов;
	
КонецФункции
      
//////Лео Катанович}

//Зароднюк
Функция НаличиеМаркированнойПродукции(ДокументОтгрузки)
	Запрос	=	Новый Запрос;
	Запрос.Текст	=	"ВЫБРАТЬ
	            	 	|	РеализацияТоваровУслугТовары.Ссылка
	            	 	|ИЗ
	            	 	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	            	 	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	            	 	|			ЗначенияСвойствОбъектов.Объект КАК Объект,
	            	 	|			ЗначенияСвойствОбъектов.Свойство КАК Свойство,
	            	 	|			ЗначенияСвойствОбъектов.Значение КАК Значение,
	            	 	|			ЗначенияСвойствОбъектов.Значение.ЧестныйЗнак КАК ЗначениеЧестныйЗнак
	            	 	|		ИЗ
	            	 	|			РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
	            	 	|		ГДЕ
	            	 	|			ЗначенияСвойствОбъектов.Свойство = &Свойство
	            	 	|			И ЗначенияСвойствОбъектов.Значение.ЧестныйЗнак) КАК БАД
	            	 	|		ПО РеализацияТоваровУслугТовары.Номенклатура = БАД.Объект
	            	 	|ГДЕ
	            	 	|	БАД.ЗначениеЧестныйЗнак
	            	 	|	И РеализацияТоваровУслугТовары.Ссылка = &Документ
	            	 	|
	            	 	|СГРУППИРОВАТЬ ПО
	            	 	|	РеализацияТоваровУслугТовары.Ссылка
	            	 	|
	            	 	|УПОРЯДОЧИТЬ ПО
	            	 	|	РеализацияТоваровУслугТовары.Ссылка.Дата";
	Запрос.УстановитьПараметр("Документ",ДокументОтгрузки);
	Запрос.УстановитьПараметр("свойство",ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоКоду("00000000066"));
	
	Выборка	=	Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Истина;	
	КонецЕсли;	
	Возврат Ложь;	
КонецФункции	