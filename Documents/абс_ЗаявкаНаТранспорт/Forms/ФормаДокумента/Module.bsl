
&НаКлиенте
Процедура ТоварыПриИзменении(Элемент)
	
	ОбновитьИтоговыеРеквизиты();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьИтоговыеРеквизиты()
	
	Объект.ВсегоОбъем             = Объект.Товары.Итог("Объем");
	Объект.ВсегоВес               = Объект.Товары.Итог("ВесБрутто"); 	
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПоЗаказуПокупателя(Команда)
	
	Если Объект.Товары.Количество() > 0 
		И Вопрос("Перед заполнением табличная часть будет очищена. Продолжить?",РежимДиалогаВопрос.ДаНет) <> КодВозвратаДиалога.Да Тогда
		Возврат;
	КонецЕсли;
	
	Объект.Товары.Очистить();
	
	ЗаполнитьТоварыПоЗаказуПокупателя_Сервер();
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьТоварыПоЗаказуПокупателя_Сервер()
	
	ОбъектДок = РеквизитФормыВЗначение("Объект");
	ОбъектДок.Заполнить(Объект.ЗаказПокупателя);
	ЗначениеВРеквизитФормы(ОбъектДок, "Объект");
	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
	ОбновитьИсториюСтатусовДокумента();
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьИсториюСтатусовДокумента()
	
	Если ЗначениеЗаполнено(Объект.Ссылка) Тогда
		
		ЭлементыОтбора = СписокИсторияСтатусов.Отбор.Элементы;
		
		Если ЭлементыОтбора.Количество() = 0 Тогда
			ЭлементОтбора = ЭлементыОтбора.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		Иначе
			ЭлементОтбора = ЭлементыОтбора.Получить(0);
		КонецЕсли;
		
		ЭлементОтбора.Использование = Истина;
		ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("ЗаявкаНаТранспорт");
		ЭлементОтбора.ВидСравнения  = ВидСравненияКомпоновкиДанных.Равно;
		ЭлементОтбора.ПравоеЗначение = Объект.Ссылка;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	ОбновитьИсториюСтатусовДокумента();
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьВесИОбъем()
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	Если Не ТекущаяСтрока = Неопределено Тогда
		ТекущаяСтрока.Объем = РассчитатьОбъемЕдиницыИзмерения(ТекущаяСтрока.ЕдиницаИзмеренияМест) * ТекущаяСтрока.Количество;
		ТекущаяСтрока.ВесБрутто = РассчитатьВесЕдиницыИзмерения(ТекущаяСтрока.ЕдиницаИзмеренияМест) * ТекущаяСтрока.Количество;
	КонецЕСлИ;	
КонецПроцедуры

&НаСервере
Функция РассчитатьВесЕдиницыИзмерения(ЕдИзм)
	Вес=0;
	Если ТипЗнч(ЕдИзм)=Тип("СправочникСсылка.ЕдиницыИзмерения") Тогда
		Вес=ЕдИзм.Вес;
	КонецЕсли;
	Возврат Вес;
КонецФункции

&НаСервере
Функция РассчитатьОбъемЕдиницыИзмерения(ЕдИзм)
	Объем=0;
	Если ТипЗнч(ЕдИзм)=Тип("СправочникСсылка.ЕдиницыИзмерения") Тогда
		Объем=ЕдИзм.Объем;
	КонецЕсли;
	Возврат Объем;
КонецФункции

&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
	РассчитатьВесИОбъем();
КонецПроцедуры

&НаКлиенте
Процедура ТоварыНоменклатураПриИзменении(Элемент)
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	Если Не ТекущаяСтрока = Неопределено Тогда
		ТекущаяСтрока.ЕдиницаИзмеренияМест = ПолучитьЕдиницуИзмеренияМест(ТекущаяСтрока.Номенклатура);
	КонецЕСли;	
	РассчитатьВесИОбъем();
КонецПроцедуры

&НаСервере
Функция ПолучитьЕдиницуИзмеренияМест(Номенклатура)
	
КонецФункции

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	УстановитьДоступностьТЧ();
КонецПроцедуры

&НаСервере
Процедура УстановитьДоступностьТЧ()
	Этаформа.Элементы.Товары.ТолькоПросмотр=Не Объект.ДокументОтгрузки.Пустая();
КонецПроцедуры

&НаКлиенте
Процедура СпособДоставкиКонтрагентаПриИзменении(Элемент)
	Объект.ТКНазначения=Объект.СпособДоставкиКонтрагента.ТК2;
	//Объект.АдресПромежуточный=абс_ТранспортнаяЛогистика.ПолучитьОсновнойАдресКонтрагента(Объект.ТКНазначения);
	
	//+ Лео ZAA 
	_АдресПром = абс_ТранспортнаяЛогистика.ПолучитьОсновнойАдресКонтрагента(Объект.ТКНазначения);
   Объект.АдресПромежуточный = ?(_АдресПром = "",Объект.СпособДоставкиКонтрагента.АдресДоставки,_АдресПром);
	//- Лео ZAA
	
	
КонецПроцедуры

&НаКлиенте
Процедура АдресКонтрагентаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	//ОбработкаРедактированияАдреса = Обработки.РедактированиеКонтактнойИнформации.Создать();
	//ОбработкаРедактированияАдреса.мВозвратСтруктуры = Истина;	
	//ОбработкаРедактированияАдреса.Вид = Справочники.ВидыКонтактнойИнформации.АдресДоставкиКонтрагента;
	//
	//СтрАдрес = Объект.АдресКонтрагента;
	//СтруктураАдреса = УправлениеКонтактнойИнформацией.ПолучитьСтруктуруАдресаИзСтроки(СтрАдрес);
	//УправлениеКонтактнойИнформацией.ЗаполнитьОбъектРедактированияАдресаПоСтруктуре(ОбработкаРедактированияАдреса, СтруктураАдреса);
	//
	//ФормаРедактированияАдреса = ОбработкаРедактированияАдреса.ПолучитьФорму("ФормаЗаписиАдреса", ЭтаФорма);
	//// установим размеры формы для редактирования
	//ФормаРедактированияАдреса.ЭлементыФормы.ПанельНастроекАдреса.Свертка = РежимСверткиЭлементаУправления.Верх;
	//ФормаРедактированияАдреса.ЭлементыФормы.ПанельКомментарий.Свертка = РежимСверткиЭлементаУправления.Низ;
	//ФормаРедактированияАдреса.Высота = 310;
	//
	//РезультатРедактирования = ФормаРедактированияАдреса.ОткрытьМодально();
	//
	//Если РезультатРедактирования = Истина Тогда
	//	СтрАдрес = УправлениеКонтактнойИнформацией.ПолучитьПолныйАдрес(ОбработкаРедактированияАдреса);
	//	Объект.АдресКонтрагента = УправлениеКонтактнойИнформацией.ПолучитьПредставлениеАдресаПоСтрока(СтрАдрес);
	//КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентПриИзменении(Элемент)
	Объект.ОтветственныйМенеджер = Объект.Контрагент.ОсновнойМенеджерПокупателя.ФизЛицо;
	Объект.СпособДоставкиКонтрагента = Объект.Контрагент.абс_ОсновнойСпособДоставки;
	Объект.ТКНазначения = Объект.Контрагент.абс_ОсновнойСпособДоставки.ТК2;
	Объект.АдресПромежуточный=абс_ТранспортнаяЛогистика.ПолучитьОсновнойАдресКонтрагента(Объект.ТКНазначения);
	//Объект.АдресКонтрагента = абс_ТранспортнаяЛогистика.ПолучитьОсновнойАдресКонтрагента(Объект.Контрагент);
	//никитин 08.02.2022  
	//Объект.АдресКонтрагента = абс_ТранспортнаяЛогистика.ПолучитьДоставкиАдресКонтрагента(Объект.Контрагент);
	//
	Объект.БизнесРегион = Объект.Контрагент.Регион;
	Объект.Регион = Объект.БизнесРегион.абс_Регион;
	Объект.Город = Объект.БизнесРегион.абс_Город;
	
	// zhiga {
	// Убоженко, водители путают адрес доставки и везут на адрес Контрагента
	ОсновнойСпособДоставки = Объект.Контрагент.абс_ОсновнойСпособДоставки;
	Если ЗначениеЗаполнено(ОсновнойСпособДоставки) тогда
	Объект.АдресКонтрагента = ?(ЗначениеЗаполнено(ОсновнойСпособДоставки.АдресДоставки),ОсновнойСпособДоставки.АдресДоставки,Объект.АдресКонтрагента);
	КонецЕсли;
	// zhiga }

	
КонецПроцедуры

&НаКлиенте
Процедура ВсегоКоличествоМоноПалетПриИзменении(Элемент)
	
	ПересчитатьКоличествоПалет();
		
КонецПроцедуры

&НаКлиенте
Процедура ВсегоКоличествоМиксПалетПриИзменении(Элемент)
	
	ПересчитатьКоличествоПалет();
	
КонецПроцедуры

&НаКлиенте
Процедура ВсегоКоличествоПалетПриИзменении(Элемент)
	
	Если Объект.ВсегоКоличествоМиксПалет=0 И Объект.ВсегоКоличествоМоноПалет=0 Тогда
		Объект.ВсегоКоличествоМоноПалет = Объект.ВсегоКоличествоПалет;
	КонецЕсли;
		
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	#Если ТолстыйКлиентОбычноеПриложение Тогда
	ЭтотОбъект = ДанныеФормыВЗначение(Объект, Тип("ДокументОбъект.абс_ЗаявкаНаТранспорт")); 
	РаботаСДиалогами.УстановитьЗаголовокФормыДокумента( , ЭтотОбъект, ЭтаФорма);
	#КонецЕсли
	
	ЗаполнитьСписокВыбораАдресПромежуточный();

КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	#Если ТолстыйКлиентОбычноеПриложение Тогда
	ЭтотОбъект = ДанныеФормыВЗначение(Объект, Тип("ДокументОбъект.абс_ЗаявкаНаТранспорт")); 
	РаботаСДиалогами.УстановитьЗаголовокФормыДокумента( , ЭтотОбъект, ЭтаФорма);
	#КонецЕсли

КонецПроцедуры

&НаКлиенте
Процедура ПересчитатьКоличествоПалет()
	
	Объект.ВсегоКоличествоПалет = Объект.ВсегоКоличествоМиксПалет + Объект.ВсегоКоличествоМоноПалет;
	
КонецПроцедуры

&НаСервере
Процедура ПриЗаписиНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	//+Лно Сафонов Е.А.
	//Не меняем статусы отгрузочных документов
	
	//Если ТекущийОбъект.Статус = Перечисления.абс_СтатусыЗаявокНаТранспорт.ВПути Тогда 
	//	СтатусОтгрузки = Перечисления.абс_СтатусыОтгрузки.ВПути
	//ИначеЕсли ТекущийОбъект.Статус = Перечисления.абс_СтатусыЗаявокНаТранспорт.Закрыт Тогда 
	//	СтатусОтгрузки = Перечисления.абс_СтатусыОтгрузки.Закрыт
	//Иначе
	//	СтатусОтгрузки = Неопределено;
	//КонецЕсли;
	//
	//Если Не СтатусОтгрузки = Неопределено Тогда
	//	Если Не ТекущийОбъект.ЗаказПокупателя.Пустая() Тогда
	//		Если СтатусОтгрузки = Перечисления.абс_СтатусыОтгрузки.Закрыт Тогда
	//			СтатусОтгрузкиДоставлен = Перечисления.абс_СтатусыОтгрузки.Доставлен;
	//			абс_СтатусыОтгрузок.ИзменитьСтатусОбъекта(ТекущийОбъект.ЗаказПокупателя, СтатусОтгрузкиДоставлен);
	//		Иначе
	//			абс_СтатусыОтгрузок.ИзменитьСтатусОбъекта(ТекущийОбъект.ЗаказПокупателя, СтатусОтгрузки);
	//		КонецЕсли;
	//	КонецЕсли;
	//	
	//	Если Не ТекущийОбъект.ДокументОтгрузки.Пустая() Тогда
	//		абс_СтатусыОтгрузок.ИзменитьСтатусОбъекта(ТекущийОбъект.ДокументОтгрузки, СтатусОтгрузки);
	//	КонецЕсли;
	//	
	//	ДокументОснование = ТекущийОбъект.ДокументОснование;
	//	Если ЗначениеЗаполнено(ДокументОснование) и ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ПеремещениеТоваров") Тогда
	//		Если ТекущийОбъект.Статус = Перечисления.абс_СтатусыЗаявокНаТранспорт.Закрыт Тогда 
	//			СтатусПеремещения = Перечисления.абс_СтатусыПеремещенийТоваров.Закрыт;
	//		Иначе 
	//			СтатусПеремещения = Перечисления.абс_СтатусыПеремещенийТоваров.Исполнение;
	//		КонецЕсли;
	//		абс_СтатусыОтгрузок.ИзменитьСтатусОбъекта(ДокументОснование, СтатусПеремещения);
	//	КонецЕсли;
	//	//если возвращается статус заявки на транспорт, то ставим в заказе покупателя статус "Отгружен".
	//Иначе
	//	Если Не ТекущийОбъект.ЗаказПокупателя.Пустая() Тогда
	//		СтатусОтгрузки = Перечисления.абс_СтатусыОтгрузки.Отгружен;
	//		абс_СтатусыОтгрузок.ИзменитьСтатусОбъекта(ТекущийОбъект.ЗаказПокупателя, СтатусОтгрузки);
	//	КонецЕсли;
	//КонецЕсли;
	
	//-Лно Сафонов Е.А.

КонецПроцедуры

       
&НаКлиенте
Процедура ЗаполнитьПоЗаявкеПоставщику(Команда)
	// Вставить содержимое обработчика.
	Если Объект.Товары.Количество() > 0 
		И Вопрос("Перед заполнением табличная часть будет очищена. Продолжить?",РежимДиалогаВопрос.ДаНет) <> КодВозвратаДиалога.Да Тогда
		Возврат;
	КонецЕсли;
	
	Объект.Товары.Очистить();
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.Заголовок = "Выберите файл";
	Диалог.ПолноеИмяФайла = ""; 
	//Фильтр = "EXE (*.exe)|*.exe"; 
	//Диалог.Фильтр = Фильтр; 
    Диалог.МножественныйВыбор = Ложь;
	Диалог.Каталог = "H:\";
	Если Диалог.Выбрать() Тогда

	//сообщить(Диалог.ПолноеИмяФайла);
	ПутьКФайлу=Диалог.ПолноеИмяФайла;
		
	конецесли;
	//Ф=Новый Файл(СокрЛП(Объект.ИмяФайла));
	//Если Ф.Существует()=0 Тогда
	//	Сообщить("Указанный файл не существует!");
	//	Возврат;
	//КонецЕсли;
	//ВыбФайл = Новый Файл(Объект.ИмяФайла);
	//Если ВыбФайл.Существует() Тогда
	//	Объект.РасширениеФайла = ВыбФайл.Расширение;
	//	Объект.ID = ВыбФайл.ИмяБезРасширения;
	//КонецЕсли;

	
	
	
	
	ДвоичныйФайл = ПоместитьВоВременноеХранилище ( Новый ДвоичныеДанные(ПутьКФайлу),ЭтаФорма.УникальныйИдентификатор); 
	
	
	
	
	ЗаполнитьПоЗаявкеПоставщику_Сервер(ДвоичныйФайл);

	
	
	
	
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПоЗаявкеПоставщику_Сервер(ДвоичныйФайл)
	ДанныеДокумента = ПолучитьИзВременногоХранилища(ДвоичныйФайл);
	ИмяФайлаДляЗагрузки = КаталогВременныхФайлов()+"temp" +Объект.Номер + ".xls";
	ДанныеДокумента.Записать(ИмяФайлаДляЗагрузки);

	
	ФайлEXCEL = ИмяФайлаДляЗагрузки ;

	//ИмяФайлаДляЗагрузки = КаталогВременныхФайлов()+"temp" + Объект.ID + Объект.РасширениеФайла;
	//ДанныеДокумента.Записать(ИмяФайлаДляЗагрузки);

	//
	//ФайлEXCEL = ИмяФайлаДляЗагрузки ;
    сообщить(ФайлEXCEL);
	
	
	
	
	Попытка
		Эксель = Новый COMОбъект("Excel.Application"); 
	Исключение
		Сообщить(ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	//ПутьКФайлу="Н:\";
	Книга = Эксель.WorkBooks.Open(ФайлEXCEL);	//ПутьКФайлу
	//сообщить(ПутьКФайлу);
	Лист = Книга.WorkSheets(1);
	ВсегоКолонок = Лист.Cells(1,1).SpecialCells(11).Column;
	ВсегоСтрок = Лист.Cells(1,1).SpecialCells(11).Row;
	Для Строка = 1 По ВсегоСтрок Цикл             
		СтрокаНоменклатура = Объект.товары.Добавить();
        СтрокаНоменклатура.Номенклатура= Лист.Cells(Строка,3).Value;
		СтрокаНоменклатура.Количество= Лист.Cells(Строка,7).Value;
		СтрокаНоменклатура.ЕдиницаИзмерения = Лист.Cells(Строка,6).Value;
	КонецЦикла;
	 	Эксель.Application.Quit();
	
		
КонецПроцедуры

&НаКлиенте
Процедура АдресПромежуточныйПриИзменении(Элемент)
	// Вставить содержимое обработчика.
	//Объект.АдресПромежуточный	=	Элемент.ТекстРедактирования;	
КонецПроцедуры

Процедура ЗаполнитьСписокВыбораАдресПромежуточный()
	
	//Элементы.Реквизит3.СписокВыбора.Очистить();
	
	Запрос	=	Новый Запрос;
	Запрос.Текст	=	"ВЫБРАТЬ
	            	 	|	КонтактнаяИнформация.Объект,
	            	 	|	КонтактнаяИнформация.Тип,
	            	 	|	КонтактнаяИнформация.Вид,
	            	 	|	КонтактнаяИнформация.Представление
	            	 	|ИЗ
	            	 	|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	            	 	|ГДЕ
	            	 	|	КонтактнаяИнформация.Объект = &ТКНазначения";
	Запрос.УстановитьПараметр("ТКНазначения", Объект.ТКНазначения);					
	
	Выборка	=	Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Если Выборка.Тип= Перечисления.ТипыКонтактнойИнформации.Адрес Тогда	
			Элементы.Реквизит3.СписокВыбора.Добавить(Выборка.Представление);				
		КонецЕсли;				
	КонецЦикла;					
	
КонецПроцедуры	

&НаКлиенте
Процедура ТКНазначенияПриИзменении(Элемент)
	// Вставить содержимое обработчика.
	ЗаполнитьСписокВыбораАдресПромежуточный();
	Объект.АдресПромежуточный	=	"";	
КонецПроцедуры

&НаКлиенте
Процедура Реквизит3ПриИзменении(Элемент)
	// Вставить содержимое обработчика.
	Объект.АдресПромежуточный	=	ЭтаФорма.Элементы.Реквизит3.ТекстРедактирования;	
КонецПроцедуры


	



